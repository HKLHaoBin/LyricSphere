# 更新日志 (Changelog)

## [v1.5.7] - 2025-10-19

### 新增功能
- 添加歌词括号预处理功能，新增strip_brackets配置选项控制是否移除歌词中的括号内容
- 完善AI设置处理逻辑，包括默认值回退和空提示词处理

### 技术改进
- 将模板文件名从Famyliam_Everywhere.html改为LyricSphere.html

## [v1.5.6] - 2025-10-17

### 新增功能
- 添加文件名安全处理函数(`sanitize_filename`)，统一处理文件名安全校验
- 优化歌词逐音节动画效果，增加上浮动画和缓动效果

### 技术改进
- 重构文件名处理逻辑，使用统一的`sanitize_filename`函数替代分散的正则表达式
- 增强文件上传和重命名功能的安全性检查
- 优化歌词动画的逐音节上浮效果，添加自定义缓动函数
- 扩展动画持续时间，使动画效果更加流畅自然

## [v1.5.5] - 2025-10-16

### 新增功能
- 添加歌词音节分组功能，优化歌词行渲染时的布局表现
- 实现资源URL的规范化处理，支持动态解析不同格式的路径
- 新增`groupSyllablesIntoWords`函数，实现音节向词的智能分组
- 实现`normalizeResourceUrl`等URL处理工具函数

### 技术改进
- 重构后端路径解析逻辑，增加安全验证机制
- 改进CORS处理，支持跨域请求，增强前端集成能力
- 增加CSS样式控制(`word-break`和`white-space`)，优化渲染表现
- 路径处理增加越界检查，提高系统安全性

## [v1.5.4] - 2025-10-13

### 新增功能
- 新增 `/player/animation-config` 接口，用于在页面加载时同步前端上报的动画参数，保持动效时长与后端计算一致。
- 动画配置支持控制是否启用后端计算的歌词消失时机，让调试与演示流程更灵活。
- 在AI翻译设置中新增思考模型相关配置项，支持在翻译前先调用思考模型进行歌词理解。

### 技术改进
- 调整歌词动画默认时长至 600ms，并与模板内的硬编码值保持同步，减少动效不同步问题。
- 重构备份文件名构造逻辑，加入哈希截断策略，防止超长文件名导致写入失败。
- 标准化备份检索前缀与时间解析方式，确保备份列表能正确降序显示各版本。

## [v1.5.3] - 2025-10-12

### 技术改进
- 重构歌词动画模板的 FLIP 渲染流程，优化状态同步与动画节奏，缓解快速翻页时的抖动。

### 修复问题
- 将歌词动画样式模板的文件名更正为 `Lyrics-style.HTML-COK.HTML`，确保后端引用的备用主题能够正确加载。

## [v1.5.2] - 2025-10-08

### 新增功能
- AI 翻译设置新增“兼容模式”复选框，允许将系统提示词合并到用户消息中，以兼容仅支持单角色对话的模型。
- AI 翻译模块支持配置多个提供商（OpenAI、OpenRouter 等），可为每首歌词选择最优模型。

### 技术改进
- 后端统一使用 `parse_bool` 解析布尔参数，确保翻译请求、设置保存及日志记录与兼容模式保持一致。
- 优化歌词动画页的 FLIP 渲染，新增 WeakMap 状态跟踪与残余位移修正，改善动画中断体验。

### 文档更新
- 更新 README 与 CLAUDE 指南，记录兼容模式开关与多提供商接入步骤。

## [v1.5.0] - 2025-10-05

### 新增功能
- 改进了TTML歌词转换和动画页处理逻辑
  - 增强了TTML到LYS/LRC的转换算法，更好地处理背景人声和对唱标记
  - 改进了LYS/LRC到TTML的转换，支持翻译内容的合并
  - 优化了歌词动画页的处理逻辑，提高渲染性能
- 添加了LYS/LRC转TTML功能并支持AMLL规则编写
  - 新增临时TTML转换接口(`/convert_to_ttml_temp`)专用于AMLL规则编写
  - 支持Apple风格的TTML格式输出
  - 增强了对背景人声(ttm:role="x-bg")和对唱(ttm:agent="v2")的支持
- 新增AI驱动的歌词翻译功能
  - 集成DeepSeek API实现高质量歌词翻译
  - 支持自定义系统提示词控制翻译风格
  - 实现流式响应实现实时翻译显示
  - 自动对齐时间戳与原始歌词
- 新增歌词导出功能
  - 支持将歌词导出为CSV格式
  - 提供逐字时间轴导出功能
- 增强了安全特性
  - 完善了设备认证系统，支持受信任设备管理
  - 增加了安全配置开关，便于不同环境部署

### 技术改进
- 优化了歌词解析算法，提高处理性能
- 改进了文件备份机制，增强数据安全性
- 更新了项目配置和文档内容
- 优化了MD格式文档的显示效果

### 修复问题
- 修复了TTML转换过程中的一些边界情况处理
- 解决了歌词动画页在特定场景下的渲染问题
- 修复了文件上传和保存过程中的权限问题
- 改进了错误处理和日志记录机制
