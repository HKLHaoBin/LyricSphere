<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famyliam Everywhere</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --card-bg: #ffffff;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --input-bg: rgba(255, 255, 255, 0.9);
            --border-color: #e9ecef;
            --tag-bg: #f8f9fa;
            --modal-bg: #ffffff;
            --button-bg: #495057;
            --button-text: #fff;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --card-bg: rgba(45, 45, 45, 0.9);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --input-bg: rgba(45, 45, 45, 0.9);
            --border-color: #404040;
            --tag-bg: #404040;
            --modal-bg: #333333;
            --button-bg: #606060;
            --button-text: #ffffff;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', system-ui, sans-serif;
            /* max-width: 100%; */
            margin: 0;
            /* padding: 39px; */
            padding-top: 70px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding-top: 80px;
            }
        }

        .json-list {
            display: flex;
            /* margin: 12px; */
            flex-wrap: wrap;
            /* gap: 0px; */
            /* margin: 2px -8px; */
            /* width: calc(100% + 20px); */
            list-style: none;
            padding: 0 10px;
            justify-content: center;
        }

        .json-item {
            background: var(--card-bg);
            border-radius: 30px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            /* flex: 0 0 calc(33.33% - 20px); */
            margin: 12px;
            padding: 18px;
            /* box-sizing: border-box; */
            max-width: 570px;
            min-width: 420px;
            display: flex;
            flex-direction: column;
        }

        .json-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
        }

        .json-item-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .file-name {
            color: var(--text-color);
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-name::before {
            content: 'ğŸµ';
            font-size: 1.2em;
        }

        .json-item-actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 12px;
        }

        .style-buttons {
            display: flex;
            flex-direction: row;
            gap: 12px;
            margin: 0;
        }

        .style-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .am-style {
            background: linear-gradient(135deg, #4dabf7, #69db7c);
            color: #fff;
        }

        .fs-style {
            background: linear-gradient(135deg, #ff6b6b, #ff922b);
            color: #fff;
        }

        .fslr-style {
            background: linear-gradient(135deg, #da77f2, #cc5de8);
            color: #fff;
        }

        .action-button {
            background: var(--button-bg, #495057);
            color: var(--button-text, #fff);
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .action-button:hover {
            background: #343a40;
        }

        .search-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            padding: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            z-index: 1000;
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease,
                box-shadow 0.3s ease,
                border-color 0.3s ease;
        }

        .search-box {
            flex: 1;
            padding: 12px 18px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--input-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .search-box:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.15),
                0 4px 12px rgba(77, 171, 247, 0.1);
            background: white;
        }

        .search-box::placeholder {
            color: #868e96;
            opacity: 0.8;
        }

        .file-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 0;
        }

        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 3px;
            display: none;
        }

        .preview-content {
            white-space: pre-wrap;
            font-family: monospace;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 6% auto;
            padding: 20px;
            width: 95%;
            height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        .modal-content>div {
            overflow-y: auto;
            padding-right: 8px;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--button-bg);
            border-radius: 4px;
        }

        .dark-mode .modal-content::-webkit-scrollbar-thumb {
            background: #606060;
        }

        .lyrics-editor {
            width: calc(100% - 24px);
            height: calc(100% - 60px);
            margin-top: 10px;
            font-family: 'Fira Code', monospace;
            resize: vertical;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            padding: 12px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .editor-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .file-path-input {
            width: calc(100% - 24px);
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            margin: 8px 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .file-path-input:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.15);
        }

        .editor-buttons button {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            background: var(--button-bg);
            color: var(--button-text);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .editor-buttons button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .editor-buttons button:active {
            transform: translateY(0);
        }

        .modal-content h3 {
            margin: 15px 0 10px;
            color: var(--text-color);
            font-size: 1.1em;
        }

        .sort-button {
            background-color: #2196F3;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .sort-button:hover {
            opacity: 0.8;
        }

        .song-tags {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .song-tag {
            font-size: 0.9rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--tag-bg);
        }

        .duet-tag {
            background: #9c36b5;
            color: #fff;
        }

        .background-vocals-tag {
            background: #FF8B36;
            color: #fff;
        }

        .lyrics-editor {
            height: 176px;
            margin: 10px 0;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            /* ç»™å›ºå®šçš„ .search-container é¢„ç•™ç©ºé—´ï¼ŒæŒ‰ä½ å®é™…é«˜åº¦å¾®è°ƒ */
            body {
                padding-top: 80px;   /* ä½ å‰é¢ä¹Ÿç”¨è¿‡ 80pxï¼Œè¿™é‡Œæ²¿ç”¨å³å¯ã€‚ */
                padding-bottom: 60px;
            }

            /* ç¡®ä¿åˆ—è¡¨å‚ä¸æ­£å¸¸æ»šåŠ¨ï¼Œä¸"å¸¸é©»" */
            .json-list {
                position: static !important;  /* è¦†ç›–ç›¸å¯¹å®šä½ */
                z-index: auto !important;
            }

            .search-container {
                position: static;
                padding: 12px 16px 16px;
                background: var(--card-bg);
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
                border-bottom: 1px solid var(--border-color);
                width: 92%;
            }

            .search-wrapper {
                justify-content: flex-start;
            }

            .search-tools {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .search-row {
                width: 100%;
                display: grid;
                gap: 10px;
                flex-wrap: nowrap;
            }

            .search-row--focus {
                grid-template-columns: 1fr;
            }

            .search-row--focus .search-box {
                max-width: none;
            }

            .search-row--sort,
            .search-row--main,
            .search-row--system {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .search-row .action-button,
            .search-row button {
                width: 100%;
                justify-content: center;
            }

            .device-manage-button {
                width: 100%;
            }

            .dropdown-menu {
                position: fixed !important;
                top: auto !important;
                right: 16px !important;
                left: 16px !important;
                bottom: 16px !important;
                min-width: unset !important;
                border-radius: 12px !important;
                padding: 12px !important;
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25) !important;
            }

            .json-list {
                margin: 0;
                padding: 16px;
                display: flex;
                gap: 16px;
            }

            .json-item {
                margin: 0;
                min-width: unset;
                width: 100%;
                padding: 18px;
                border-radius: 20px;
            }

            .file-name {
                font-size: 1.2rem;
                line-height: 1.3;
                flex-wrap: wrap;
            }

            .json-item-actions {
                gap: 16px;
            }

            .style-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
            }

            .style-button {
                flex: 1 1 calc(50% - 10px);
                justify-content: center;
            }

            .file-actions {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
            }

            .file-actions .action-button {
                width: 100%;
            }

            .modal {
                padding: 0;
            }

            .modal-content {
                margin: 40px auto;
                width: calc(100% - 24px);
                height: calc(100% - 80px);
                border-radius: 14px;
                max-height: 92vh;
            }

            .lyrics-editor {
                height: 220px;
            }

            .modal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .modal-header-actions,
            .modal-flex-group {
                width: 100%;
            }

            .modal-header-actions button,
            .modal-flex-group button,
            .modal-flex-group .lyrics-action-btn,
            .modal-flex-group label,
            .modal-header-actions .lyrics-action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* å¢å¼ºå¯¹æ¯”åº¦ */
        .style-button:hover {
            opacity: 0.9;
            filter: brightness(1.05);
        }

        .search-box {
            max-width: 300px;
            padding: 11px 14px;
        }

        .lyrics-action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            margin: 5px 0;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .path-update-btn {
            background: #4dabf7;
            color: white;
        }

        .save-btn {
            background: #37b24d;
            color: white;
        }

        .close-btn {
            background: #f03e3e;
            color: white;
        }

        .lyrics-action-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .save-all-btn {
            background: #f59f00;
            color: white;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 1rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .copy-btn:hover {
            opacity: 1;
        }
        .search-wrapper {
            display: flex;
            width: 100%;
            justify-content: center;
        }
        .search-tools {
            display: flex;
            width: 100%;
            max-width: 1200px;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-row--focus .search-box {
            width: 100%;
        }
        .device-manage-button {
            position: relative;
            display: inline-flex;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--modal-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px;
            min-width: 200px;
            z-index: 1000;
        }
        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-color);
            border-radius: 6px;
        }
        .dropdown-menu button:hover {
            background: var(--tag-bg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px 0;
            gap: 12px;
        }

        .modal-header-actions,
        .modal-flex-group {
            display: flex;
            flex-wrap: wrap;
        }

        .modal-path-group {
            margin-top: 8px;
        }

        .style-button.disabled-style {
            background: #e9ecef !important;
            color: #bbb !important;
            cursor: not-allowed !important;
        }
    </style>
</head>

<body>
    <div class="search-container">
        <div class="search-wrapper">
            <div class="search-tools">
                <div class="search-row search-row--focus">
                    <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢éŸ³ä¹...ï¼ˆå…³é”®å­—è¶Šå°‘ æœåˆ°çš„æ¦‚ç‡è¶Šå¤§ï¼‰">
                </div>
                <div class="search-row search-row--sort">
                    <button class="action-button" onclick="toggleSort('name')" id="nameSortBtn">A-Z æ’åº</button>
                    <button class="action-button" onclick="toggleSort('time')" id="timeSortBtn">æ—¶é—´å€’åº</button>
                </div>
                <div class="search-row search-row--main">
                    <button class="action-button" onclick="showCreateModal()">åˆ›å»ºæ–°æ­Œæ›²</button>
                    <button class="action-button" onclick="toggleDarkMode()" id="themeToggle">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
                    <button class="action-button" id="portSwitchBtn" onclick="switchPortMode()">éšæœºç«¯å£</button>
                </div>
                <div class="search-row search-row--system">
                    <button class="action-button" id="securityToggleBtn" onclick="toggleSecurityMode()" title="å®‰å…¨ä¿æŠ¤ï¼šé»˜è®¤å¼€å¯ï¼Œé˜²æ­¢å¤–éƒ¨ä¿®æ”¹">ğŸ”’ å®‰å…¨ä¿æŠ¤</button>
                    <button class="action-button" id="authToggleBtn" onclick="toggleAuthModal()" title="è§£é”æœ¬è®¾å¤‡ç¼–è¾‘æƒé™">ğŸ”‘ è§£é”æœ¬è®¾å¤‡</button>
                    <button class="action-button" onclick="openAMLL()" title="æ‰“å¼€AMLLæ­Œè¯ç•Œé¢">AMLLæº</button>
                    <div class="action-button device-manage-button">
                        âš™ï¸ è®¾å¤‡ç®¡ç†
                        <div class="dropdown-menu" style="display: none;">
                            <button onclick="showTrustedDevices()">ğŸ“‹ æŸ¥çœ‹è®¾å¤‡</button>
                            <button onclick="showSetPasswordModal()">ğŸ” è®¾ç½®å¯†ç </button>
                            <button onclick="showRevokeDeviceModal()">ğŸš« åŠé”€è®¾å¤‡</button>
                            <button onclick="revokeAllDevices()">ğŸ—‘ï¸ æ¸…ç©ºè®¾å¤‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="json-list" id="jsonList">
        {% for file in json_files %}
        <li class="json-item" data-mtime="{{ file.mtime }}">
            <div class="json-item-header">
                <div class="file-name">{{ file.filename.replace('.json', '') }} <button class="copy-btn" onclick="copyFileName(this)" title="å¤åˆ¶æ–‡ä»¶å">ğŸ“‹</button></div>
                <div class="song-tags">
                    {% if '::' in file.data.meta.lyrics %}
                    {% set lyrics_parts = file.data.meta.lyrics.split('::') %}
                    {% if lyrics_parts|length >= 4 and lyrics_parts[1] != '!' %}
                    <div id="tags-{{ file.filename }}" class="song-tags"></div>
                    <script>
                        // ä½¿ç”¨ window.onload æˆ– DOMContentLoaded äº‹ä»¶æ¥ç¡®ä¿ DOM å·²åŠ è½½
                        document.addEventListener('DOMContentLoaded', function () {
                            checkLyrics('{{ lyrics_parts[1] }}', '{{ file.filename }}')
                        });
                    </script>
                    {% endif %}
                    {% elif file.data.meta.lyrics.startswith('http://') %}
                    <div id="tags-{{ file.filename }}" class="song-tags"></div>
                    <script>
                        // ä½¿ç”¨ window.onload æˆ– DOMContentLoaded äº‹ä»¶æ¥ç¡®ä¿ DOM å·²åŠ è½½
                        document.addEventListener('DOMContentLoaded', function () {
                            checkLyrics('{{ file.data.meta.lyrics }}', '{{ file.filename }}')
                        });
                    </script>
                    {% endif %}
                </div>
            </div>
            <div class="json-item-actions">
                <div class="style-buttons">
                <!--<button class="style-button am-style"
                    onclick="openFamyliamCloud('{{ file.filename|e }}', 'fsam')">AMæ­Œè¯æ ·å¼</button>-->
                <button class="style-button fs-style"
                    onclick="openFamyliamCloud('{{ file.filename|e }}', 'fs')">å…¨å±æ­Œè¯æ ·å¼</button>
                <button class="style-button fslr-style"
                    onclick="openFamyliamCloud('{{ file.filename|e }}', 'fslr')">å…¨å±å¯¹å”±æ­Œè¯æ ·å¼</button>
                <button class="style-button am-style"
                    onclick="openFamyliamCloud('{{ file.filename|e }}', 'amll')">AMLL-web</button>
                <button class="action-button" onclick="openLyricsAnimate('{{ file.filename|e }}', 'äº®èµ·')">äº®èµ·</button>
                <button class="action-button" onclick="openLyricsAnimate('{{ file.filename|e }}', 'Kok')">Kok</button>
                <!-- <button class="style-button am-style"
                    onclick="openFamyliamCloud('{{ file.filename|e }}', 'am')">visual-lyricæ­Œè¯æ ·å¼</button> -->
                </div>
                <div class="file-actions">
                    {% if '::' in file.data.meta.lyrics %}
                    {% set lyrics_parts = file.data.meta.lyrics.split('::') %}
                    {% if lyrics_parts|length >= 4 %}
                    <button class="action-button" 
                        onclick="editLyrics('{{ lyrics_parts[1]|e }}', '{{ lyrics_parts[2]|e }}', 0, '{{ file.filename|e }}')">ä¿®æ”¹æ­Œè¯</button>
                    {% else %}
                    <button class="action-button" 
                        onclick="editLyrics('{{ file.data.meta.lyrics|e }}', '', 0, '{{ file.filename|e }}')">ä¿®æ”¹æ­Œè¯</button>
                    {% endif %}
                    {% else %}
                    <button class="action-button" 
                        onclick="editLyrics('{{ file.data.meta.lyrics|e }}', '', 0, '{{ file.filename|e }}')">ä¿®æ”¹æ­Œè¯</button>
                    {% endif %}
                    <button class="action-button" 
                        onclick="editMusicPath('{{ file.data.song|e }}', '{{ file.filename|e }}')">ä¿®æ”¹éŸ³ä¹è·¯å¾„</button>
                    <button class="action-button" 
                        onclick="editImagePath('{{ file.data.meta.albumImgSrc|e }}', '{{ file.filename|e }}')">ä¿®æ”¹ä¸“è¾‘å›¾è·¯å¾„</button>
                    <button class="action-button" 
                        onclick="showRenameModal('{{ file.filename|e }}', '{{ file.data.meta.title|e }}', '{{ file.data.meta.artists|join(',')|e }}')">é‡å‘½å</button>
                    <button class="action-button"
                        onclick="if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ­Œæ›²æ¡ç›®å—ï¼Ÿï¼ˆå…³è”çš„æ­Œè¯ã€éŸ³ä¹ç­‰æ–‡ä»¶å°†è¢«ä¿ç•™ï¼‰')){deleteJson('{{ file.filename|e }}')}">åˆ é™¤æ­Œæ›²</button>
                </div>
            </div>
            <div class="file-preview" id="preview-{{ file.filename }}">
                <div class="preview-content"></div>
            </div>
        </li>
        {% endfor %}
    </ul>

    <div id="lyricsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; font-size: 1.5rem;">ç¼–è¾‘æ­Œè¯ ï¼š <span id="currentFileName"></span><button class="copy-btn" onclick="copyCurrentFileName()" title="å¤åˆ¶æ–‡ä»¶å">ğŸ“‹</button></h2>
                <div class="modal-header-actions">
                    <button class="lyrics-action-btn save-all-btn" onclick="saveAllLyrics()">ğŸ’¾ ä¿å­˜å…¨éƒ¨</button>
                    <button class="lyrics-action-btn close-btn" onclick="closeLyricsModal()">ğŸšª å…³é—­</button>
                </div>
            </div>
            <div style="display: flex; flex-direction: column;">
                <div>
                    <h3>æ­Œè¯</h3>
                    <div>
                        <label>æ­Œè¯æ–‡ä»¶è·¯å¾„ï¼š</label>
                        <input type="text" id="lyricsPath" class="file-path-input">
                        <div class="modal-flex-group modal-path-group">
                            <button class="lyrics-action-btn path-update-btn" onclick="updateLyricsPath(0)">ğŸ”„
                                æ›´æ–°è·¯å¾„</button>
                            <button class="lyrics-action-btn path-update-btn" onclick="convertTTML()">
                                ğŸ”„ TTMLè½¬LYS/LRC
                            </button>
                            <button class="lyrics-action-btn path-update-btn" onclick="convertToTTML()">
                                ğŸ”„ LYS/LRCè½¬TTML
                            </button>
                            <button class="lyrics-action-btn path-update-btn" id="mergeLQEButton" style="display: none;" onclick="mergeToLQE()">
                                ğŸ”„ åˆå¹¶ä¸ºLQE
                            </button>
                            <button class="lyrics-action-btn path-update-btn" onclick="setCurrentFileNameAsLyrics()">
                                ğŸ“ ä¸ºå½“å‰æ­Œè¯å‘½å
                            </button>
                            <button class="lyrics-action-btn path-update-btn" onclick="extractLyrics()">
                                ğŸ“‹ æå–æ­Œè¯
                            </button>

                            <label class="lyrics-action-btn path-update-btn" style="cursor:pointer;">
                                ğŸ“¤ ä¸Šä¼ æ­Œè¯
                                <input type="file" id="lyricsUpload" accept=".lrc,.lys,.ttml" style="display:none;"
                                    onchange="handleLyricsUpload()">
                            </label>
                        </div>
                    </div>
                    <textarea id="lyricsEditor" class="lyrics-editor"></textarea>
                    <button class="lyrics-action-btn save-btn" onclick="saveLyrics(0)">ğŸ’¾ ä¿å­˜æ­Œè¯</button>
                </div>

                <div>
                    <h3>ç¿»è¯‘</h3>
                    <div>
                        <label>ç¿»è¯‘æ–‡ä»¶è·¯å¾„ï¼š</label>
                        <input type="text" id="translationPath" class="file-path-input">
                        <div class="modal-flex-group modal-path-group">
                            <button class="lyrics-action-btn path-update-btn" onclick="updateLyricsPath(1)">ğŸ”„
                                æ›´æ–°è·¯å¾„</button>
                            <button class="lyrics-action-btn path-update-btn" onclick="setCurrentFileNameAsTranslation()">
                                ğŸ“ ä¸ºå½“å‰ç¿»è¯‘å‘½å
                            </button>
                            <button class="lyrics-action-btn path-update-btn" onclick="extractTimestamps()">
                                â±ï¸ æ·»åŠ æ—¶é—´æˆ³
                            </button>
                            <!-- <button class="lyrics-action-btn path-update-btn" onclick="window.open('https://famyliam.ft2.ltd/translate_lyrics', '_blank')">
                                ğŸ¤– AIç¿»è¯‘
                            </button> -->
                            <button class="lyrics-action-btn path-update-btn" onclick="translateLyrics()">
                                ğŸ¤– AIç¿»è¯‘
                            </button>
                            <button class="lyrics-action-btn path-update-btn" onclick="showAISettings()">
                                âš™ï¸ AIè®¾ç½®
                            </button>
                            <label class="lyrics-action-btn path-update-btn" style="cursor:pointer;">
                                ğŸ“¤ ä¸Šä¼ ç¿»è¯‘
                                <input type="file" id="translationUpload" accept=".lrc,.lys,.ttml" style="display:none;"
                                    onchange="handleTranslationUpload()">
                            </label>
                        </div>
                    </div>
                    <textarea id="translationEditor" class="lyrics-editor"></textarea>
                    <button class="lyrics-action-btn save-btn" onclick="saveLyrics(1)">ğŸ’¾ ä¿å­˜ç¿»è¯‘</button>
                </div>

                <div class="editor-buttons">
                    <button class="lyrics-action-btn close-btn" onclick="closeLyricsModal()">ğŸšª å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="musicPathModal" class="modal">
        <div class="modal-content">
            <h2>ä¿®æ”¹éŸ³ä¹æ–‡ä»¶è·¯å¾„</h2>
            <div>
                <label>å½“å‰è·¯å¾„ï¼š</label>
                <input type="text" id="musicPath" class="file-path-input" readonly>
                <label>æ–°è·¯å¾„ï¼š</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="newMusicPath" class="file-path-input" style="flex:1">
                    <label class="lyrics-action-btn path-update-btn" style="margin:0; cursor:pointer;">
                        ğŸ“¤ ä¸Šä¼ æ–‡ä»¶
                        <input type="file" id="musicUpload" accept="audio/*,video/*" style="display:none;"
                            onchange="handleMusicUpload()">
                    </label>
                </div>
                <small style="display: block; margin-top: 5px; color: #666;">
                    æç¤ºï¼šå¯ç›´æ¥è¾“å…¥æ–‡ä»¶åæˆ–ä¸Šä¼ éŸ³é¢‘è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒæ‰€æœ‰æ ¼å¼ï¼‰
                </small>
            </div>
            <div class="editor-buttons">
                <button onclick="updateMusicPath()">ä¿å­˜</button>
                <button onclick="closeMusicPathModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="imagePathModal" class="modal">
        <div class="modal-content">
            <h2>ä¿®æ”¹å›¾ç‰‡è·¯å¾„</h2>
            <div>
                <h3>ä¸“è¾‘å°é¢</h3>
                <label>å½“å‰è·¯å¾„ï¼š</label>
                <input type="text" id="imagePath" class="file-path-input" readonly>
                <label>æ–°è·¯å¾„ï¼š</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="newImagePath" class="file-path-input" style="flex:1">
                    <label class="lyrics-action-btn path-update-btn" style="margin:0; cursor:pointer;">
                        ğŸ“¤ ä¸Šä¼ ä¸“è¾‘å›¾
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;"
                            onchange="handleImageUpload(this.files[0], 'album')">
                    </label>
                </div>
                <small style="display: block; margin-top: 5px; color: #666;">
                    æç¤ºï¼šæ”¯æŒ JPG/PNG/GIF/WEBP æ ¼å¼ï¼Œå¯ç›´æ¥ä¸Šä¼ æˆ–è¾“å…¥æ–‡ä»¶å
                </small>
            </div>
            
            <div>
                <h3>èƒŒæ™¯å›¾ç‰‡</h3>
                <label>å½“å‰è·¯å¾„ï¼š</label>
                <input type="text" id="backgroundPath" class="file-path-input" readonly>
                <label>æ–°è·¯å¾„ï¼š</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="newBackgroundPath" class="file-path-input" style="flex:1">
                    <label class="lyrics-action-btn path-update-btn" style="margin:0; cursor:pointer;">
                        ğŸ“¤ ä¸Šä¼ èƒŒæ™¯å›¾
                        <input type="file" id="backgroundUpload" accept="image/*" style="display: none;"
                            onchange="handleImageUpload(this.files[0], 'background')">
                    </label>
                </div>
                <small style="display: block; margin-top: 5px; color: #666;">
                    æç¤ºï¼šæ”¯æŒ JPG/PNG/GIF/WEBP æ ¼å¼ï¼Œå¯ç›´æ¥ä¸Šä¼ æˆ–è¾“å…¥æ–‡ä»¶å
                </small>
            </div>
            
            <div class="editor-buttons">
                <button onclick="updateImagePath()">ä¿å­˜ä¸“è¾‘å›¾</button>
                <button onclick="updateBackgroundPath()">ä¿å­˜èƒŒæ™¯å›¾</button>
                <button onclick="closeImagePathModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="createJsonModal" class="modal">
        <div class="modal-content">
            <h2>åˆ›å»ºæ–°æ­Œæ›²</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div>
                    <label>æ­Œæ›²åï¼š</label>
                    <input type="text" id="songTitle" class="file-path-input">
                </div>
                <div>
                    <label>æ­Œæ‰‹åï¼ˆå¤šä¸ªæ­Œæ‰‹ç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
                    <input type="text" id="songArtists" class="file-path-input" placeholder="æ­Œæ‰‹1,æ­Œæ‰‹2">
                </div>
                <div class="editor-buttons">
                    <button onclick="createJsonFile()">åˆ›å»º</button>
                    <button onclick="closeCreateModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="renameModal" class="modal">
        <div class="modal-content">
            <h2>é‡å‘½åæ­Œæ›²</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div>
                    <label>æ­Œæ›²åï¼š</label>
                    <input type="text" id="renameSongTitle" class="file-path-input">
                </div>
                <div>
                    <label>æ­Œæ‰‹åï¼ˆå¤šä¸ªæ­Œæ‰‹ç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
                    <input type="text" id="renameSongArtists" class="file-path-input" placeholder="æ­Œæ‰‹1,æ­Œæ‰‹2">
                </div>
                <div class="editor-buttons">
                    <button onclick="renameJsonFile()">ä¿å­˜</button>
                    <button onclick="closeRenameModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="backupModal" class="modal">
        <div class="modal-content">
            <h2>é€‰æ‹©æ¢å¤ç‰ˆæœ¬</h2>
            <div id="backupList" style="max-height: 60vh; overflow-y: auto; margin: 15px 0;"></div>
            <div class="editor-buttons">
                <button onclick="closeBackupModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¤è¯å¯¹è¯æ¡† -->
    <div id="authModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2>ğŸ”‘ è®¾å¤‡è®¤è¯</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div id="authStatus" style="padding: 10px; border-radius: 8px; background: #f8f9fa; text-align: center;">
                    æ­£åœ¨æ£€æŸ¥è®¾å¤‡çŠ¶æ€...
                </div>
                <div id="authForm" style="display: none;">
                    <div>
                        <label>å¯†ç ï¼š</label>
                        <input type="password" id="authPassword" class="file-path-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
                    </div>
                    <div class="editor-buttons">
                        <button onclick="authLogin()">ç™»å½•</button>
                        <button onclick="authLogout()" id="authLogoutBtn" style="display: none;">ç™»å‡º</button>
                        <button onclick="closeAuthModal()">å–æ¶ˆ</button>
                    </div>
                </div>
                <div id="authSuccess" style="display: none; text-align: center; color: #37b24d;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">âœ…</div>
                    <div>è®¾å¤‡å·²æˆåŠŸè®¤è¯ï¼</div>
                    <div style="font-size: 0.9em; color: #666; margin-top: 10px;">æ‚¨ç°åœ¨å¯ä»¥ç¼–è¾‘å†…å®¹äº†</div>
                    <button onclick="closeAuthModal()" style="margin-top: 15px;">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¯†ç è®¾ç½®å¯¹è¯æ¡† -->
    <div id="setPasswordModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <h2>ğŸ” è®¾ç½®ç³»ç»Ÿå¯†ç </h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div id="setPasswordStatus" style="padding: 10px; border-radius: 8px; background: #f8f9fa; text-align: center; display: none;">
                    <!-- çŠ¶æ€ä¿¡æ¯å°†åŠ¨æ€æ˜¾ç¤º -->
                </div>
                <div>
                    <label>å½“å‰å¯†ç ï¼ˆå¦‚å·²è®¾ç½®ï¼‰ï¼š</label>
                    <input type="password" id="currentPassword" class="file-path-input" placeholder="å¦‚å·²è®¾ç½®å¯†ç ï¼Œè¯·è¾“å…¥å½“å‰å¯†ç ">
                </div>
                <div>
                    <label>æ–°å¯†ç ï¼š</label>
                    <input type="password" id="newPassword" class="file-path-input" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆæœ€å°‘8ä½ï¼‰">
                </div>
                <div>
                    <label>ç¡®è®¤æ–°å¯†ç ï¼š</label>
                    <input type="password" id="confirmPassword" class="file-path-input" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                <div style="font-size: 12px; color: #666;">
                    ğŸ’¡ å¯†ç è¦æ±‚ï¼šæœ€å°‘8ä¸ªå­—ç¬¦ï¼Œå»ºè®®åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
                </div>
                <div class="editor-buttons">
                    <button onclick="setPassword()">ä¿å­˜å¯†ç </button>
                    <button onclick="closeSetPasswordModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡åŠé”€å¯¹è¯æ¡† -->
    <div id="revokeDeviceModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>ğŸš« åŠé”€è®¾å¤‡</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div id="revokeDeviceStatus" style="padding: 10px; border-radius: 8px; background: #f8f9fa; text-align: center;">
                    æ­£åœ¨åŠ è½½è®¾å¤‡åˆ—è¡¨...
                </div>
                <div id="revokeDeviceList" style="max-height: 300px; overflow-y: auto; display: none;">
                    <!-- è®¾å¤‡åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="deviceSearch" class="file-path-input" placeholder="æœç´¢è®¾å¤‡ID..." style="flex: 1;">
                    <button onclick="searchDevices()">æœç´¢</button>
                </div>
                <div class="editor-buttons">
                    <button onclick="closeRevokeDeviceModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ AIè®¾ç½®å¯¹è¯æ¡† -->
    <div id="aiSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>AIç¿»è¯‘è®¾ç½®</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label>APIæä¾›å•†ï¼š</label>
                    <select id="aiProvider" class="file-path-input">
                        <option value="deepseek">DeepSeek</option>
                        <option value="openai">OpenAI</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="together">Together</option>
                        <option value="groq">Groq</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div>
                    <label>åŸºç¡€URLï¼š</label>
                    <input type="text" id="aiBaseUrl" class="file-path-input" placeholder="ä¾‹å¦‚: https://api.deepseek.com">
                </div>
                <div>
                    <label>æ¨¡å‹åç§°ï¼š</label>
                    <input type="text" id="aiModel" class="file-path-input" placeholder="ä¾‹å¦‚: deepseek-reasoner">
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="aiExpectReasoning"> æœŸæœ›æ€ç»´é“¾å†…å®¹ï¼ˆä»…éƒ¨åˆ†æ¨¡å‹æ”¯æŒï¼‰
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="aiCompatMode"> å…¼å®¹æ¨¡å¼ï¼šå°†æç¤ºè¯åˆå¹¶åˆ°ç”¨æˆ·æ¶ˆæ¯ä¸­
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="aiThinkingEnabled" checked> å¯ç”¨æ€è€ƒæ¨¡å¼ï¼ˆå…ˆç”Ÿæˆæ•´é¦–æ­Œç†è§£ï¼‰
                    </label>
                </div>
                <div>
                    <label>APIå¯†é’¥ï¼š</label>
                    <input type="password" id="aiApiKey" class="file-path-input" placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                        <a href="https://platform.deepseek.com/usage" target="_blank" style="color: #0066cc; text-decoration: none;">ç‚¹å‡»è¿™é‡Œè·å– DeepSeek API å¯†é’¥ â†’</a>
                    </div>
                </div>
                <div>
                    <label>ç¿»è¯‘æç¤ºè¯ï¼š</label>
                    <textarea id="aiSystemPrompt" class="lyrics-editor" style="height: 150px;" placeholder="è®¾ç½®AIç¿»è¯‘çš„æç¤ºè¯ï¼Œç”¨äºæŒ‡å¯¼AIå¦‚ä½•ç¿»è¯‘æ­Œè¯"></textarea>
                </div>
                <div style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                    <h3 style="margin: 0 0 8px 0;">æ€è€ƒæ¨¡å‹è®¾ç½®</h3>
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                        å¯é€‰ï¼šå…ˆè°ƒç”¨æ€è€ƒæ¨¡å‹ç”Ÿæˆæ•´é¦–æ­Œç†è§£ï¼Œå†å°†ç»“æœä¼ ç»™ç¿»è¯‘æ¨¡å‹ã€‚ç•™ç©ºçš„å­—æ®µå°†æ²¿ç”¨ç¿»è¯‘è®¾ç½®ã€‚
                    </div>
                    <div>
                        <label>æ€è€ƒæ¨¡å‹æä¾›å•†ï¼š</label>
                        <select id="aiThinkingProvider" class="file-path-input">
                            <option value="deepseek">DeepSeek</option>
                            <option value="openai">OpenAI</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="together">Together</option>
                            <option value="groq">Groq</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div>
                        <label>æ€è€ƒæ¨¡å‹åŸºç¡€URLï¼š</label>
                        <input type="text" id="aiThinkingBaseUrl" class="file-path-input" placeholder="é»˜è®¤æ²¿ç”¨ç¿»è¯‘æ¨¡å‹çš„åŸºç¡€URL">
                    </div>
                    <div>
                        <label>æ€è€ƒæ¨¡å‹åç§°ï¼š</label>
                        <input type="text" id="aiThinkingModel" class="file-path-input" placeholder="é»˜è®¤æ²¿ç”¨ç¿»è¯‘æ¨¡å‹åç§°">
                    </div>
                    <div>
                        <label>æ€è€ƒæ¨¡å‹APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                        <input type="password" id="aiThinkingApiKey" class="file-path-input" placeholder="ç•™ç©ºåˆ™æ²¿ç”¨ç¿»è¯‘APIå¯†é’¥">
                    </div>
                    <div>
                        <label>æ€è€ƒæç¤ºè¯ï¼š</label>
                        <textarea id="aiThinkingPrompt" class="lyrics-editor" style="height: 120px;" placeholder="è®¾ç½®æ€è€ƒæ¨¡å‹çš„æç¤ºè¯ï¼Œç”¨äºç”Ÿæˆæ•´é¦–æ­Œçš„ç†è§£"></textarea>
                    </div>
                </div>
                <div class="editor-buttons">
                    <button onclick="probeAIConnection('translation', this)" data-probe="translation">æµ‹è¯•ç¿»è¯‘æ¨¡å‹</button>
                    <button onclick="probeAIConnection('thinking', this)" data-probe="thinking">æµ‹è¯•æ€è€ƒæ¨¡å‹</button>
                    <button onclick="saveAISettings()">ä¿å­˜è®¾ç½®</button>
                    <button onclick="closeAISettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åœ¨é¡µé¢å¼€å§‹å°±å®šä¹‰ checkLyrics å‡½æ•°
        function checkLyrics(lyricsPath, filename) {
            fetch('/check_lyrics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    path: lyricsPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const tagsContainer = document.getElementById(`tags-${filename}`)
                        if (data.hasDuet) {
                            const duetTag = document.createElement('span')
                            duetTag.className = 'song-tag duet-tag'
                            duetTag.textContent = 'åŒ…å«å¯¹å”±æ­Œè¯'
                            tagsContainer.appendChild(duetTag)
                        }
                        if (data.hasBackgroundVocals) {
                            const bgTag = document.createElement('span')
                            bgTag.className = 'song-tag background-vocals-tag'
                            bgTag.textContent = 'åŒ…å«èƒŒæ™¯æ­Œè¯'
                            tagsContainer.appendChild(bgTag)
                        }
                    }
                })
        }

        function openFamyliamCloud(filename, preset) {
            // å¦‚æœæ˜¯AMLLè§„åˆ™ç¼–å†™ç½‘å€
            if (preset === 'amll') {
                // è·å–æ­Œæ›²ä¿¡æ¯
                fetch('/get_json_data?filename=' + encodeURIComponent(filename))
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const jsonData = data.jsonData;

                            // è·å–å½“å‰æœåŠ¡å™¨çš„åŸºç¡€URLï¼ˆåŒ…å«ç«¯å£ï¼‰
                            const baseUrl = `http://${location.hostname}:${location.port}/songs/`;

                            // æå–æ­Œæ›²ä¿¡æ¯
                            const title = encodeURIComponent(jsonData.meta.title || '');
                            const artists = encodeURIComponent((jsonData.meta.artists || []).join(' / '));

                            // å¤„ç†éŸ³ä¹è·¯å¾„
                            let musicPath = '';
                            if (jsonData.song) {
                                if (jsonData.song.startsWith('http://127.0.0.1:5000/songs/')) {
                                    // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œæ›¿æ¢ä¸ºå½“å‰ç«¯å£
                                    musicPath = encodeURIComponent(jsonData.song.replace('http://127.0.0.1:5000/songs/', baseUrl));
                                } else if (jsonData.song.startsWith('/songs/')) {
                                    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ å®Œæ•´åŸºç¡€URL
                                    musicPath = encodeURIComponent(baseUrl + jsonData.song.substring(8));
                                } else {
                                    // å…¶ä»–æƒ…å†µç›´æ¥ä½¿ç”¨
                                    musicPath = encodeURIComponent(jsonData.song);
                                }
                            }

                            // å¤„ç†æ­Œè¯è·¯å¾„
                            let lyricsPath = '';
                            let originalLyricsPath = '';
                            if (jsonData.meta.lyrics) {
                                if (jsonData.meta.lyrics.includes('::')) {
                                    // æ ¼å¼ä¸º "::æ­Œè¯è·¯å¾„::ç¿»è¯‘è·¯å¾„::ç½—é©¬éŸ³è·¯å¾„::"
                                    const parts = jsonData.meta.lyrics.split('::');
                                    if (parts[1]) {
                                        originalLyricsPath = parts[1];
                                        if (parts[1].startsWith('http://127.0.0.1:5000/songs/')) {
                                            // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œæ›¿æ¢ä¸ºå½“å‰ç«¯å£
                                            lyricsPath = encodeURIComponent(parts[1].replace('http://127.0.0.1:5000/songs/', baseUrl));
                                        } else if (parts[1].startsWith('/songs/')) {
                                            // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ å®Œæ•´åŸºç¡€URL
                                            lyricsPath = encodeURIComponent(baseUrl + parts[1].substring(8));
                                        } else {
                                            // å…¶ä»–æƒ…å†µç›´æ¥ä½¿ç”¨
                                            lyricsPath = encodeURIComponent(parts[1]);
                                        }
                                    }
                                } else {
                                    // ç›´æ¥æ˜¯æ­Œè¯è·¯å¾„
                                    originalLyricsPath = jsonData.meta.lyrics;
                                    if (jsonData.meta.lyrics.startsWith('http://127.0.0.1:5000/songs/')) {
                                        // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œæ›¿æ¢ä¸ºå½“å‰ç«¯å£
                                        lyricsPath = encodeURIComponent(jsonData.meta.lyrics.replace('http://127.0.0.1:5000/songs/', baseUrl));
                                    } else if (jsonData.meta.lyrics.startsWith('/songs/')) {
                                        // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ å®Œæ•´åŸºç¡€URL
                                        lyricsPath = encodeURIComponent(baseUrl + jsonData.meta.lyrics.substring(8));
                                    } else {
                                        // å…¶ä»–æƒ…å†µç›´æ¥ä½¿ç”¨
                                        lyricsPath = encodeURIComponent(jsonData.meta.lyrics);
                                    }
                                }
                            }

                            // å¤„ç†å°é¢è·¯å¾„
                            let coverPath = '';
                            if (jsonData.meta.albumImgSrc) {
                                if (jsonData.meta.albumImgSrc.startsWith('http://127.0.0.1:5000/songs/')) {
                                    // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œæ›¿æ¢ä¸ºå½“å‰ç«¯å£
                                    coverPath = encodeURIComponent(jsonData.meta.albumImgSrc.replace('http://127.0.0.1:5000/songs/', baseUrl));
                                } else if (jsonData.meta.albumImgSrc.startsWith('/songs/')) {
                                    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ å®Œæ•´åŸºç¡€URL
                                    coverPath = encodeURIComponent(baseUrl + jsonData.meta.albumImgSrc.substring(8));
                                } else {
                                    // å…¶ä»–æƒ…å†µç›´æ¥ä½¿ç”¨
                                    coverPath = encodeURIComponent(jsonData.meta.albumImgSrc);
                                }
                            }

                            // æ£€æŸ¥æ­Œè¯æ–‡ä»¶æ ¼å¼ï¼Œå¦‚æœä¸æ˜¯TTMLåˆ™ä¸´æ—¶è½¬æ¢
                            if (originalLyricsPath && !originalLyricsPath.toLowerCase().endsWith('.ttml')) {
                                // æå–æ–‡ä»¶å
                                let fileName = originalLyricsPath.split('/').pop();
                                if (fileName.startsWith('http://127.0.0.1:5000/songs/')) {
                                    fileName = fileName.replace('http://127.0.0.1:5000/songs/', '');
                                }

                                // è¯·æ±‚åç«¯å°†æ­Œè¯ä¸´æ—¶è½¬æ¢ä¸ºTTMLæ ¼å¼
                                fetch('/convert_to_ttml_temp', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ path: fileName })
                                })
                                .then(response => response.json())
                                .then(convertData => {
                                    if (convertData.status === 'success') {
                                        // ä½¿ç”¨è½¬æ¢åçš„TTMLæ–‡ä»¶è·¯å¾„
                                        const convertedLyricsPath = encodeURIComponent(convertData.ttmlPath.replace('http://127.0.0.1:5000/songs/', baseUrl));
                                        // æ„å»ºAMLLè§„åˆ™ç¼–å†™ç½‘å€
                                        const amllUrl = `https://amllp.bikonoo.com/?music=${musicPath}&lyric=${convertedLyricsPath}&title=${title}&artist=${artists}`;
                                        // æ‰“å¼€ç½‘å€
                                        window.open(amllUrl, '_blank');
                                    } else {
                                        alert('æ­Œè¯è½¬æ¢å¤±è´¥: ' + convertData.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('æ­Œè¯è½¬æ¢è¯·æ±‚å¤±è´¥:', error);
                                    alert('æ­Œè¯è½¬æ¢è¯·æ±‚å¤±è´¥');
                                });
                            } else {
                                // æ„å»ºAMLLè§„åˆ™ç¼–å†™ç½‘å€
                                const amllUrl = `https://amllp.bikonoo.com/?music=${musicPath}&lyric=${lyricsPath}&title=${title}&artist=${artists}`;
                                // æ‰“å¼€ç½‘å€
                                window.open(amllUrl, '_blank');
                            }
                        } else {
                            alert('æ— æ³•è·å–æ­Œæ›²ä¿¡æ¯');
                        }
                    })
                    .catch(error => {
                        console.error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:', error);
                        alert('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥');
                    });
            } else {
                // åŸæœ‰çš„å¤„ç†é€»è¾‘
                const baseUrl = preset === 'am' ?
                    `http://localhost:8081/app/?#http://127.0.0.1:5000/` :
                    `https://famyliam.ft2.ltd/app?preset=${preset}&font-preset=misans&pulling=superweak#http://127.0.0.1:5000/`;
                window.open(baseUrl + filename);
            }
        }

        // æœç´¢åŠŸèƒ½
        const searchBox = document.getElementById('searchBox')
        const jsonList = document.getElementById('jsonList')
        const items = jsonList.getElementsByTagName('li')

        searchBox.addEventListener('input', function () {
            const searchText = this.value.toLowerCase()

            for (let item of items) {
                const fileName = item.querySelector('.file-name').textContent.toLowerCase()
                const searchMatch = fileName.includes(searchText)
                item.style.display = searchMatch ? '' : 'none'
            }
        })

        let currentEditingFile = ''
        let currentLyricsPath = ''
        let currentLyricsIndex = 0
        let currentJsonFile = ''
        let currentMusicPath = ''
        let currentMusicJsonFile = ''
        let currentImagePath = ''
        let currentImageJsonFile = ''
        let currentRenameFile = ''
        let currentSort = { type: 'time', asc: false } // åˆå§‹ä¸ºæ—¶é—´å€’åº
        let currentRestoreFile = ''

        function toggleSort(type) {
            if (type === currentSort.type) {
                currentSort.asc = !currentSort.asc
            } else {
                currentSort.type = type
                currentSort.asc = (type === 'name') // åç§°æ’åºé»˜è®¤å‡åº
            }
            updateSortButtons()
            sortList()
        }

        function updateSortButtons() {
            const nameBtn = document.getElementById('nameSortBtn')
            const timeBtn = document.getElementById('timeSortBtn')

            nameBtn.textContent = `A-Z ${currentSort.type === 'name' ? (currentSort.asc ? 'â†‘' : 'â†“') : ''}`
            timeBtn.textContent = `æ—¶é—´ ${currentSort.type === 'time' ? (currentSort.asc ? 'â†‘' : 'â†“') : ''}`
        }

        function sortList() {
            const list = document.getElementById('jsonList')
            const items = Array.from(list.getElementsByTagName('li'))

            items.sort((a, b) => {
                if (currentSort.type === 'name') {
                    const textA = a.querySelector('.file-name').textContent.toLowerCase()
                    const textB = b.querySelector('.file-name').textContent.toLowerCase()
                    return currentSort.asc ? textA.localeCompare(textB, 'zh-Hans-CN')
                        : textB.localeCompare(textA, 'zh-Hans-CN')
                } else {
                    const timeA = parseFloat(a.dataset.mtime)
                    const timeB = parseFloat(b.dataset.mtime)
                    return currentSort.asc ? timeA - timeB : timeB - timeA
                }
            })

            while (list.firstChild) {
                list.removeChild(list.firstChild)
            }
            items.forEach(item => list.appendChild(item))
        }

        // åˆå§‹åŒ–æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
        window.onload = function () {
            sortList()
            updateSortButtons()
        }

        function viewFile(type, path) {
            // å®ç°æ–‡ä»¶é¢„è§ˆé€»è¾‘
        }

        function editJson(filename) {
            currentEditingFile = filename
            const modal = document.getElementById('editModal')
            const editor = document.getElementById('jsonEditor')
            // è·å–JSONå†…å®¹å¹¶æ˜¾ç¤ºåœ¨ç¼–è¾‘å™¨ä¸­
            modal.style.display = 'block'
        }

        function saveJson() {
            const editor = document.getElementById('jsonEditor')
            fetch('/update_json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: currentEditingFile,
                    content: JSON.parse(editor.value)
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeModal()
                        location.reload()
                    }
                })
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none'
        }

        function restoreFile(filename) {
            fetch('/restore_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_path: `D:/æ­Œè¯/å…¨å±æ­Œè¯æ»šåŠ¨æ ·å¼/famyliam/static/${filename}`
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload()
                    }
                })
        }

        function editLyrics(lyricsPath, translationPath, index, jsonFile) {
            currentJsonFile = jsonFile
            const modal = document.getElementById('lyricsModal')
            const lyricsEditor = document.getElementById('lyricsEditor')
            const translationEditor = document.getElementById('translationEditor')
            const lyricsPathInput = document.getElementById('lyricsPath')
            const translationPathInput = document.getElementById('translationPath')
            
            // è®¾ç½®å½“å‰æ–‡ä»¶å
            document.getElementById('currentFileName').textContent = jsonFile.replace('.json', '')

            // è®¾ç½®è·¯å¾„
            lyricsPathInput.value = lyricsPath.replace('http://127.0.0.1:5000/songs/', '')
            if (translationPath && translationPath !== '!') {
                translationPathInput.value = translationPath.replace('http://127.0.0.1:5000/songs/', '')
            } else {
                translationPathInput.value = ''
            }

            // åŠ è½½æ­Œè¯å†…å®¹
            fetch('/get_lyrics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: lyricsPath })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        lyricsEditor.value = data.content
                    }
                })

            // åŠ è½½ç¿»è¯‘å†…å®¹
            if (translationPath && translationPath !== '!') {
                fetch('/get_lyrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: translationPath })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            translationEditor.value = data.content
                        }
                    })
            } else {
                translationEditor.value = ''
            }

            modal.style.display = 'block'
            checkFileExtension()
        }

        function saveLyrics(index) {
            const path = index === 0 ?
                document.getElementById('lyricsPath').value :
                document.getElementById('translationPath').value
            const content = index === 0 ?
                document.getElementById('lyricsEditor').value :
                document.getElementById('translationEditor').value

            // éªŒè¯è·¯å¾„
            if (!path || path === '.' || path === './') {
                return Promise.reject(new Error('æ— æ•ˆçš„æ–‡ä»¶è·¯å¾„'));
            }

            return new Promise((resolve, reject) => {
                const fullPath = `http://127.0.0.1:5000/songs/${path}`

                fetch('/save_lyrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: fullPath,
                        content: content
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            resolve()
                        } else if (data.status === 'warning') {
                            alert(data.message)
                            resolve()  // ä»ç„¶resolveå› ä¸ºæ–‡ä»¶å·²ç»ä¿å­˜æˆåŠŸ
                        } else {
                            reject(new Error(data.message || 'ä¿å­˜å¤±è´¥'))
                        }
                    })
                    .catch(error => reject(error))
            })
        }

        async function saveAllLyrics() {
            const saveBtn = document.querySelector('.save-all-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'æ­£åœ¨ä¿å­˜...';

            try {
                const lyricsPath = document.getElementById('lyricsPath').value;
                const translationPath = document.getElementById('translationPath').value;

                // éªŒè¯æ­Œè¯è·¯å¾„
                if (!lyricsPath || lyricsPath === '.' || lyricsPath === './') {
                    throw new Error('è¯·å…ˆè®¾ç½®æœ‰æ•ˆçš„æ­Œè¯æ–‡ä»¶è·¯å¾„');
                }

                // éªŒè¯ç¿»è¯‘è·¯å¾„ï¼ˆå¦‚æœæœ‰ï¼‰
                if (translationPath && (translationPath === '.' || translationPath === './')) {
                    throw new Error('ç¿»è¯‘æ–‡ä»¶è·¯å¾„æ— æ•ˆ');
                }

                await updateLyricsPath(0);
                await saveLyrics(0);

                // åªæœ‰åœ¨æœ‰ç¿»è¯‘è·¯å¾„æ—¶æ‰ä¿å­˜ç¿»è¯‘
                if (translationPath) {
                    await updateLyricsPath(1);
                    await saveLyrics(1);
                }

                alert('å…¨éƒ¨ä¿å­˜æˆåŠŸï¼');
            } catch (err) {
                alert('ä¿å­˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š' + err.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ ä¿å­˜å…¨éƒ¨';
            }
        }

        function updateLyricsPath(index) {
            return new Promise((resolve, reject) => {
                const pathInput = index === 0 ?
                    document.getElementById('lyricsPath') :
                    document.getElementById('translationPath')
                const newPath = pathInput.value

                fetch('/update_file_path', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonFile: currentJsonFile,
                        fileType: 'lyrics',
                        newPath: newPath,
                        index: index,
                        clear: !newPath
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            resolve()
                        } else {
                            reject(new Error('è·¯å¾„æ›´æ–°å¤±è´¥'))
                        }
                    })
                    .catch(error => reject(error))
            })
        }

        function closeLyricsModal() {
            document.getElementById('lyricsModal').style.display = 'none'
            location.reload()
        }

        function editMusicPath(path, jsonFile) {
            currentMusicPath = path
            currentMusicJsonFile = jsonFile
            const modal = document.getElementById('musicPathModal')
            const currentPathInput = document.getElementById('musicPath')
            const newPathInput = document.getElementById('newMusicPath')

            // æ˜¾ç¤ºå½“å‰è·¯å¾„ï¼ˆå»æ‰å‰ç¼€ï¼‰
            currentPathInput.value = path.replace('http://127.0.0.1:5000/songs/', '')
            newPathInput.value = currentPathInput.value

            modal.style.display = 'block'
        }

        function updateMusicPath() {
            const newPath = document.getElementById('newMusicPath').value.trim()

            if (!newPath) {
                alert('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶è·¯å¾„ï¼')
                return
            }

            fetch('/update_file_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonFile: currentMusicJsonFile,
                    fileType: 'music',
                    newPath: newPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeMusicPathModal()
                        location.reload()
                    } else {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + data.message)
                    }
                })
                .catch(error => {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + error)
                })
        }

        function closeMusicPathModal() {
            document.getElementById('musicPathModal').style.display = 'none'
        }

        function editImagePath(path, jsonFile) {
            currentImagePath = path
            currentImageJsonFile = jsonFile
            const modal = document.getElementById('imagePathModal')
            const currentPathInput = document.getElementById('imagePath')
            const newPathInput = document.getElementById('newImagePath')
            const backgroundPathInput = document.getElementById('backgroundPath')
            const newBackgroundPathInput = document.getElementById('newBackgroundPath')

            // æ˜¾ç¤ºå½“å‰è·¯å¾„ï¼ˆå»æ‰å‰ç¼€ï¼‰
            currentPathInput.value = path.replace('http://127.0.0.1:5000/songs/', '')
            newPathInput.value = currentPathInput.value
            
            // è·å–å½“å‰èƒŒæ™¯å›¾ç‰‡è·¯å¾„
            fetch('/get_json_data?filename=' + encodeURIComponent(jsonFile))
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const backgroundPath = data.jsonData.meta['Background-image'] || ''
                        backgroundPathInput.value = backgroundPath
                        newBackgroundPathInput.value = backgroundPath
                    }
                })

            modal.style.display = 'block'
        }

        function updateImagePath() {
            const newPath = document.getElementById('newImagePath').value.trim()

            if (!newPath) {
                alert('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶è·¯å¾„ï¼')
                return
            }

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
            const hasValidExtension = validExtensions.some(ext => newPath.toLowerCase().endsWith(ext))
            if (!hasValidExtension) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶åï¼ˆæ”¯æŒ.jpgã€.jpegã€.pngã€.gifã€.webpï¼‰')
                return
            }

            fetch('/update_file_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonFile: currentImageJsonFile,
                    fileType: 'image',
                    newPath: newPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeImagePathModal()
                        location.reload()
                    } else {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + data.message)
                    }
                })
                .catch(error => {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + error)
                })
        }

        function updateBackgroundPath() {
            const newPath = document.getElementById('newBackgroundPath').value.trim()

            if (!newPath) {
                alert('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶è·¯å¾„ï¼')
                return
            }

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
            const hasValidExtension = validExtensions.some(ext => newPath.toLowerCase().endsWith(ext))
            if (!hasValidExtension) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶åï¼ˆæ”¯æŒ.jpgã€.jpegã€.pngã€.gifã€.webpï¼‰')
                return
            }

            fetch('/update_file_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonFile: currentImageJsonFile,
                    fileType: 'background',
                    newPath: newPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeImagePathModal()
                        location.reload()
                    } else {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + data.message)
                    }
                })
                .catch(error => {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + error)
                })
        }

        function closeImagePathModal() {
            document.getElementById('imagePathModal').style.display = 'none'
        }
        
        function convertTTML() {
            const lyricsPath = document.getElementById('lyricsPath').value.trim();
            if (!lyricsPath || !lyricsPath.toLowerCase().endsWith('.ttml')) {
                alert('è¯·å…ˆåœ¨"æ­Œè¯æ–‡ä»¶è·¯å¾„"è¾“å…¥æ¡†ä¸­å¡«å†™TTMLæ–‡ä»¶åï¼ˆå¦‚ xxx.ttmlï¼‰');
                return;
            }

            fetch('/convert_ttml_by_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: lyricsPath })
            })
            .then(response => response.json())
            .then(data => {
                const lyricsEditor = document.getElementById('lyricsEditor');
                if (data.status === 'success') {
                    document.getElementById('lyricsPath').value = data.lyricPath.replace('http://127.0.0.1:5000/songs/', '');
                    if (data.transPath) {
                        document.getElementById('translationPath').value = data.transPath.replace('http://127.0.0.1:5000/songs/', '');
                    }
                    // è‡ªåŠ¨è·å–å¹¶åº”ç”¨æ­Œè¯å†…å®¹
                    fetch('/get_lyrics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: data.lyricPath })
                    })
                    .then(response => response.json())
                    .then(lyricsData => {
                        if (lyricsData.status === 'success') {
                            lyricsEditor.value = lyricsData.content;
                        }
                    });
                    // è‡ªåŠ¨è·å–å¹¶åº”ç”¨ç¿»è¯‘å†…å®¹
                    if (data.transPath) {
                        fetch('/get_lyrics', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: data.transPath })
                        })
                        .then(response => response.json())
                        .then(transData => {
                            if (transData.status === 'success') {
                                document.getElementById('translationEditor').value = transData.content;
                            }
                        });
                    }
                    alert('TTMLè‡ªåŠ¨è½¬æ¢æˆåŠŸï¼éœ€è¦ç‚¹å‡»"ä¿å­˜å…¨éƒ¨"åº”ç”¨ï¼Œè‹¥è½¬æ¢å‡ºé”™ è¯·ç›´æ¥ç‚¹å‡»å…³é—­!');
                } else {
                    alert('è‡ªåŠ¨è½¬æ¢å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                alert('è‡ªåŠ¨è½¬æ¢å¤±è´¥ï¼š' + error);
            });
        }

        function convertToTTML() {
            const lyricsPath = document.getElementById('lyricsPath').value.trim();
            if (!lyricsPath) {
                alert('è¯·å…ˆåœ¨"æ­Œè¯æ–‡ä»¶è·¯å¾„"è¾“å…¥æ¡†ä¸­å¡«å†™æ–‡ä»¶å');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            const fileExt = lyricsPath.toLowerCase().substring(lyricsPath.lastIndexOf('.'));
            if (fileExt !== '.lys' && fileExt !== '.lrc') {
                alert('åªæ”¯æŒLYSå’ŒLRCæ ¼å¼çš„æ­Œè¯æ–‡ä»¶');
                return;
            }

            fetch('/convert_to_ttml', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: lyricsPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // æ›´æ–°æ­Œè¯è·¯å¾„ä¸ºTTMLæ–‡ä»¶
                    document.getElementById('lyricsPath').value = data.ttmlPath.replace('http://127.0.0.1:5000/songs/', '');

                    // è‡ªåŠ¨è·å–å¹¶åº”ç”¨è½¬æ¢åçš„TTMLå†…å®¹
                    fetch('/get_lyrics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: data.ttmlPath })
                    })
                    .then(response => response.json())
                    .then(lyricsData => {
                        if (lyricsData.status === 'success') {
                            document.getElementById('lyricsEditor').value = lyricsData.content;
                        }
                    });

                    alert('LYS/LRCè½¬TTMLè½¬æ¢æˆåŠŸï¼éœ€è¦ç‚¹å‡»"ä¿å­˜å…¨éƒ¨"åº”ç”¨ï¼Œè‹¥è½¬æ¢å‡ºé”™è¯·ç›´æ¥ç‚¹å‡»å…³é—­!');
                } else {
                    alert('è½¬æ¢å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                alert('è½¬æ¢å¤±è´¥ï¼š' + error);
            });
        }

        function showCreateModal() {
            document.getElementById('createJsonModal').style.display = 'block'
            document.getElementById('songTitle').value = ''
            document.getElementById('songArtists').value = ''
        }

        function closeCreateModal() {
            document.getElementById('createJsonModal').style.display = 'none'
        }

        function createJsonFile() {
            const title = document.getElementById('songTitle').value.trim()
            const artistsInput = document.getElementById('songArtists').value.trim()

            if (!title || !artistsInput) {
                alert('è¯·å¡«å†™æ­Œæ›²åå’Œæ­Œæ‰‹åï¼')
                return
            }

            const artists = artistsInput.split(',').map(artist => artist.trim()).filter(artist => artist)

            if (artists.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä½æ­Œæ‰‹ï¼')
                return
            }

            // æ¸…ç†æ–‡ä»¶åï¼Œç§»é™¤ä¸å…è®¸çš„ç‰¹æ®Šå­—ç¬¦ï¼Œæ›¿æ¢å…¨è§’å¼•å·
            const cleanTitle = title.replace(/[\\/:*<>|]/g, '').replace(/[\"\']/g, 'ï¼‚')
            const cleanArtists = artists.map(artist => artist.replace(/[\\/:*<>|]/g, '').replace(/[\"\']/g, 'ï¼‚'))
            // æ„å»ºæ–‡ä»¶å
            const fileName = `${cleanTitle} - ${cleanArtists.join(' _ ')}.json`

            // æ„å»ºJSONæ•°æ®
            const jsonData = {
                serial: 123456,
                meta: {
                    title: title,
                    artists: artists,
                    albumImgSrc: "http://127.0.0.1:5000/songs/ä¸“è¾‘å›¾.jpg",
                    duration_ms: 0,
                    lyrics: "::http://127.0.0.1:5000/songs/æ­Œè¯.lys::!::!::"
                },
                song: "http://127.0.0.1:5000/songs/éŸ³ä¹.mp3"
            }

            // å‘é€åˆ›å»ºè¯·æ±‚
            fetch('/create_json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: fileName,
                    content: jsonData
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeCreateModal()
                        location.reload()
                    } else {
                        alert('åˆ›å»ºå¤±è´¥ï¼š' + data.message)
                    }
                })
                .catch(error => {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + error)
                })
        }

        function showRenameModal(filename, title, artists) {
            currentRenameFile = filename
            const modal = document.getElementById('renameModal')
            const titleInput = document.getElementById('renameSongTitle')
            const artistsInput = document.getElementById('renameSongArtists')

            // æ¸…ç†æ–‡ä»¶åï¼Œæ›¿æ¢å…¨è§’å¼•å·
            const cleanTitle = title.replace(/[\"\']/g, 'ï¼‚')
            const cleanArtists = artists.split(',').map(artist => artist.trim().replace(/[\"\']/g, 'ï¼‚')).join(',')
            titleInput.value = cleanTitle
            artistsInput.value = cleanArtists

            modal.style.display = 'block'
        }

        function closeRenameModal() {
            document.getElementById('renameModal').style.display = 'none'
        }

        function renameJsonFile() {
            const title = document.getElementById('renameSongTitle').value.trim()
            const artistsInput = document.getElementById('renameSongArtists').value.trim()

            if (!title || !artistsInput) {
                alert('è¯·å¡«å†™æ­Œæ›²åå’Œæ­Œæ‰‹åï¼')
                return
            }

            const artists = artistsInput.split(',').map(artist => artist.trim()).filter(artist => artist)

            if (artists.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä½æ­Œæ‰‹ï¼')
                return
            }

            // æ„å»ºæ–°æ–‡ä»¶å
            const newFileName = `${title} - ${artists.join(' _ ')}.json`

            fetch('/rename_json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    oldFilename: currentRenameFile,
                    newFilename: newFileName,
                    title: title,
                    artists: artists
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        closeRenameModal()
                        location.reload()
                    } else {
                        alert('é‡å‘½åå¤±è´¥ï¼š' + data.message)
                    }
                })
                .catch(error => {
                    alert('é‡å‘½åå¤±è´¥ï¼š' + error)
                })
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode')
            const isDark = document.body.classList.contains('dark-mode')
            localStorage.setItem('darkMode', isDark)
            document.getElementById('themeToggle').textContent = isDark ? 'ğŸŒ æµ…è‰²æ¨¡å¼' : 'ğŸŒ’ æ·±è‰²æ¨¡å¼'
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true'
            if (savedDarkMode) {
                document.body.classList.add('dark-mode')
                document.getElementById('themeToggle').textContent = 'ğŸŒ æµ…è‰²æ¨¡å¼'
            }
        }
        initTheme()

        function handleMusicUpload() {
            const fileInput = document.getElementById('musicUpload')
            const file = fileInput.files[0]

            if (!file) return

            // å…è®¸æ‰€æœ‰éŸ³é¢‘è§†é¢‘æ ¼å¼
            if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
                alert('è¯·ä¸Šä¼ éŸ³é¢‘æˆ–è§†é¢‘æ–‡ä»¶')
                return
            }

            // æ¸…ç†æ–‡ä»¶åï¼ˆæ›¿æ¢ç‰¹æ®Šå­—ç¬¦ï¼‰
            const cleanFileName = file.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\-_.]/g, '')

            const formData = new FormData()
            formData.append('file', file, cleanFileName)

            fetch('/upload_music', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('newMusicPath').value = cleanFileName
                        updateMusicPath() // è‡ªåŠ¨è§¦å‘ä¿å­˜
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + data.message)
                    }
                })
                .catch(error => {
                    console.error('Error:', error)
                    alert('ä¸Šä¼ å¤±è´¥')
                })
        }

        async function handleImageUpload(file, type) {
            if (!file) return

            const formData = new FormData()
            formData.append('file', file)

            try {
                const response = await fetch('/upload_image', {
                    method: 'POST',
                    body: formData
                })
                const result = await response.json()

                if (result.status === 'success') {
                    if (type === 'album') {
                        document.getElementById('newImagePath').value = result.filename
                    } else if (type === 'background') {
                        document.getElementById('newBackgroundPath').value = result.filename
                    }
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + result.message)
                }
            } catch (error) {
                alert('ä¸Šä¼ å‡ºé”™: ' + error.message)
            }
        }

        function deleteJson(filename) {
            if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ ${filename} åŠå…¶æ‰€æœ‰å…³è”æ–‡ä»¶å—ï¼Ÿ`)) {
                fetch('/delete_json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('åˆ é™¤æˆåŠŸ')
                            location.reload()
                        } else {
                            alert('åˆ é™¤å¤±è´¥: ' + data.message)
                        }
                    })
            }
        }

        function handleLyricsUpload() {
            const fileInput = document.getElementById('lyricsUpload')
            const file = fileInput.files[0]
            if (!file) return

            const formData = new FormData()
            formData.append('file', file)

            fetch('/upload_lyrics', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('lyricsPath').value = data.filename
                        updateLyricsPath(0)
                        // éšè—æ­Œè¯ç›¸å…³æŒ‰é’®
                        document.querySelector('.save-all-btn').style.display = 'none'
                        document.querySelector('button[onclick="saveLyrics(0)"]').style.display = 'none'
                        alert('æ­Œè¯å·²ä¸Šä¼ æˆåŠŸï¼Œç‚¹å‡»"å…³é—­"åç”Ÿæ•ˆ')
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + data.message)
                    }
                })
                .catch(error => {
                    console.error('Error:', error)
                    alert('ä¸Šä¼ å¤±è´¥')
                })
        }

        function handleTranslationUpload() {
            const fileInput = document.getElementById('translationUpload')
            const file = fileInput.files[0]
            if (!file) return

            const formData = new FormData()
            formData.append('file', file)

            fetch('/upload_translation', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('translationPath').value = data.filename
                        updateLyricsPath(1)
                        // éšè—ç¿»è¯‘ç›¸å…³æŒ‰é’®
                        document.querySelector('.save-all-btn').style.display = 'none'
                        document.querySelector('button[onclick="saveLyrics(1)"]').style.display = 'none'
                        alert('æ­Œè¯å·²ä¸Šä¼ æˆåŠŸï¼Œç‚¹å‡»"å…³é—­"åç”Ÿæ•ˆ')
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + data.message)
                    }
                })
                .catch(error => {
                    console.error('Error:', error)
                    alert('ä¸Šä¼ å¤±è´¥')
                })
        }

        async function showBackupVersions(filename) {
            currentRestoreFile = filename
            const modal = document.getElementById('backupModal')
            const backupList = document.getElementById('backupList')
            backupList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>'

            try {
                const response = await fetch('/get_backups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: `http://127.0.0.1:5000/static/${filename}` })
                })
                const data = await response.json()

                backupList.innerHTML = ''
                if (data.backups && data.backups.length > 0) {
                    data.backups.forEach(backup => {
                        const btn = document.createElement('button')
                        btn.className = 'action-button'
                        btn.style.margin = '5px'
                        btn.innerHTML = `
                            ${backup.time}
                            <div style="font-size:0.8em; color:#666;">${backup.path.split('/').pop()}</div>
                        `
                        btn.onclick = () => restoreToVersion(backup.path)
                        backupList.appendChild(btn)
                    })
                } else {
                    backupList.innerHTML = '<div>æš‚æ— å†å²ç‰ˆæœ¬</div>'
                }
                modal.style.display = 'block'
            } catch (error) {
                alert('è·å–å¤‡ä»½å¤±è´¥: ' + error)
            }
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none'
        }

        async function quickRestore(filename) {
            if (confirm(`ç¡®å®šè¦æ¢å¤åˆ°æœ€æ–°å¤‡ä»½ç‰ˆæœ¬å—ï¼Ÿ`)) {
                try {
                    const response = await fetch('/restore_file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: `http://127.0.0.1:5000/static/${filename}` })
                    })
                    const result = await response.json()
                    if (result.status === 'success') {
                        alert('æ¢å¤æˆåŠŸï¼')
                        location.reload()
                    }
                } catch (error) {
                    alert('æ¢å¤å¤±è´¥: ' + error)
                }
            }
        }

        async function restoreToVersion(backupPath) {
            if (confirm(`ç¡®å®šè¦æ¢å¤åˆ°è¯¥ç‰ˆæœ¬å—ï¼Ÿ\n${backupPath}`)) {
                try {
                    const response = await fetch('/restore_file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: backupPath })
                    })
                    const result = await response.json()
                    if (result.status === 'success') {
                        alert('æ¢å¤æˆåŠŸï¼')
                        location.reload()
                    }
                } catch (error) {
                    alert('æ¢å¤å¤±è´¥: ' + error)
                }
            }
        }

        function checkFileExtension() {
            const lyricsPath = document.getElementById('lyricsPath').value;
            const mergeLQEButton = document.getElementById('mergeLQEButton');
            if (lyricsPath && !lyricsPath.toLowerCase().endsWith('.ttml')) {
                mergeLQEButton.style.display = 'inline-block';
            } else {
                mergeLQEButton.style.display = 'none';
            }
        }

        function mergeToLQE() {
            const lyricsPath = document.getElementById('lyricsPath').value;
            const translationPath = document.getElementById('translationPath').value;
            
            if (!lyricsPath || !translationPath) {
                alert('è¯·ç¡®ä¿æ­Œè¯å’Œç¿»è¯‘æ–‡ä»¶è·¯å¾„éƒ½å·²è®¾ç½®ï¼');
                return;
            }

            fetch('/merge_to_lqe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lyricsPath: lyricsPath,
                    translationPath: translationPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // è‡ªåŠ¨ä¸‹è½½ä¸º.lqeæ–‡ä»¶
                    const blob = new Blob([data.content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // æ–‡ä»¶åå¯æ ¹æ®æ­Œè¯æ–‡ä»¶åè‡ªåŠ¨ç”Ÿæˆ
                    let baseName = lyricsPath.replace(/\.[^/.]+$/, '');
                    a.download = baseName + '.lqe';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('LQEæ–‡ä»¶å·²å¯¼å‡ºï¼');
                } else {
                    alert('åˆå¹¶å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                alert('åˆå¹¶å¤±è´¥ï¼š' + error);
            });
        }

        // åœ¨æ›´æ–°è·¯å¾„æ—¶æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        const originalUpdateLyricsPath = updateLyricsPath;
        updateLyricsPath = function(index) {
            originalUpdateLyricsPath(index);
            setTimeout(checkFileExtension, 100); // å»¶è¿Ÿæ£€æŸ¥ä»¥ç¡®ä¿è·¯å¾„å·²æ›´æ–°
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¸€æ¬¡
        window.addEventListener('DOMContentLoaded', function() {
            checkFileExtension();
        });
        // æ­Œè¯è·¯å¾„è¾“å…¥å˜åŒ–æ—¶æ£€æŸ¥
        document.getElementById('lyricsPath').addEventListener('input', checkFileExtension);

        function setCurrentFileNameAsLyrics() {
            const currentFileName = document.getElementById('currentFileName').textContent;
            const lyricsPathInput = document.getElementById('lyricsPath');
            const lyricsContent = document.getElementById('lyricsEditor').value;
            
            // æ£€æŸ¥å†…å®¹å¹¶ç¡®å®šæ–‡ä»¶ç±»å‹
            let extension = '.'; // é»˜è®¤æ‰©å±•å
            
            if (/\[\d+\]/.test(lyricsContent)) {
                extension = '.lys';
            } else if (/\[\d{2}:\d{2}\.\d{2,3}\]\(/.test(lyricsContent)) {
                extension = '.qrc';
            } else if (/\[\d{2}:\d{2}\.\d{2,3}\]/.test(lyricsContent)) {
                extension = '.lrc';
            } else if (/<\/div>|<\/body>|<\/tt>/.test(lyricsContent)) {
                extension = '.ttml';
            }
            
            lyricsPathInput.value = currentFileName + extension;
        }

        function setCurrentFileNameAsTranslation() {
            const currentFileName = document.getElementById('currentFileName').textContent;
            const translationPathInput = document.getElementById('translationPath');
            translationPathInput.value = currentFileName + '.lrc';
        }

        function copyFileName(button) {
            const fileName = button.parentElement.textContent.replace('ğŸ“‹', '').trim();
            navigator.clipboard.writeText(fileName).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ“';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1000);
            });
        }

        function copyCurrentFileName() {
            const fileName = document.getElementById('currentFileName').textContent;
            const button = document.querySelector('h2 .copy-btn');
            navigator.clipboard.writeText(fileName).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ“';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1000);
            });
        }

        async function extractTimestamps() {
            const lyricsPath = document.getElementById('lyricsPath').value;
            const lyricsContent = document.getElementById('lyricsEditor').value;
            
            console.log('å¼€å§‹æå–æ—¶é—´æˆ³...');
            console.log('æ­Œè¯è·¯å¾„:', lyricsPath);
            console.log('æ­Œè¯å†…å®¹é•¿åº¦:', lyricsContent.length);
            
            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºlysæ ¼å¼
            if (!lyricsPath.toLowerCase().endsWith('.lys')) {
                console.error('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šä¸æ˜¯LYSæ ¼å¼');
                alert('è¯·å…ˆé€‰æ‹©LYSæ ¼å¼çš„æ­Œè¯æ–‡ä»¶ï¼');
                return;
            }
            
            try {
                console.log('æ­£åœ¨å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨...');
                const response = await fetch('/extract_timestamps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: lyricsContent
                    })
                });
                
                console.log('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('æœåŠ¡å™¨è¿”å›æ•°æ®:', data);
                
                if (data.status === 'success') {
                    console.log('æˆåŠŸè·å–æ—¶é—´æˆ³ï¼Œæ•°é‡:', data.timestamps.length);
                    // å°†æ—¶é—´æˆ³å†™å…¥ç¿»è¯‘ç¼–è¾‘å™¨
                    document.getElementById('translationEditor').value = data.timestamps.join('\n');
                    console.log('æ—¶é—´æˆ³å·²å†™å…¥ç¿»è¯‘ç¼–è¾‘å™¨');
                } else {
                    console.error('æå–æ—¶é—´æˆ³å¤±è´¥:', data.message);
                    alert('æå–æ—¶é—´æˆ³å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æå–æ—¶é—´æˆ³æ—¶å‡ºé”™ï¼š', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                alert('æå–æ—¶é—´æˆ³æ—¶å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }

        async function extractLyrics() {
            const lyricsContent = document.getElementById('lyricsEditor').value;
            
            try {
                const response = await fetch('/extract_lyrics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: lyricsContent
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // å°†æå–çš„æ­Œè¯å¤åˆ¶åˆ°å‰ªè´´æ¿
                    await navigator.clipboard.writeText(data.content);
                    alert('å·²æˆåŠŸæå–æ­Œè¯å¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } else {
                    alert('æå–æ­Œè¯å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('æå–æ­Œè¯æ—¶å‡ºé”™ï¼š', error);
                alert('æå–æ­Œè¯æ—¶å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }

        async function translateLyrics() {
            // ä¿å­˜æŒ‰é’®çš„åŸå§‹æ–‡æœ¬
            const translateBtn = document.querySelector('button[onclick="translateLyrics()"]');
            const originalBtnText = translateBtn.textContent;
            
            try {
                const lyricsContent = document.getElementById('lyricsEditor').value;
                if (!lyricsContent) {
                    alert('è¯·å…ˆè¾“å…¥æ­Œè¯å†…å®¹ï¼');
                    return;
                }

                // ä»localStorageè·å–APIå¯†é’¥
                const apiKey = localStorage.getItem('aiApiKey');
                if (!apiKey) {
                    alert('è¯·å…ˆåœ¨AIè®¾ç½®ä¸­è®¾ç½®APIå¯†é’¥ï¼');
                    return;
                }

                console.log('å¼€å§‹ç¿»è¯‘è¿‡ç¨‹...');
                console.log('æ­Œè¯å†…å®¹é•¿åº¦:', lyricsContent.length);
                console.log('æ­Œè¯è¡Œæ•°:', lyricsContent.split('\n').length);

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                translateBtn.textContent = 'ç¿»è¯‘ä¸­...';
                translateBtn.disabled = true;

                // æ¸…ç©ºç¿»è¯‘ç¼–è¾‘å™¨
                const translationEditor = document.getElementById('translationEditor');
                translationEditor.value = '';

                console.log('å‘é€ç¿»è¯‘è¯·æ±‚åˆ°æœåŠ¡å™¨...');
                // ä»localStorageè·å–æ‰€æœ‰AIè®¾ç½®
                const systemPrompt = localStorage.getItem('aiSystemPrompt');
                const provider = localStorage.getItem('aiProvider') || 'deepseek';
                const baseUrl = localStorage.getItem('aiBaseUrl') || 'https://api.deepseek.com';
                const model = localStorage.getItem('aiModel') || 'deepseek-reasoner';
                const expectReasoning = localStorage.getItem('aiExpectReasoning') === 'true';
                const compatModeStorage = localStorage.getItem('aiCompatMode');
                const compatMode = compatModeStorage ? compatModeStorage === 'true' : false;
                const thinkingEnabledStorage = localStorage.getItem('aiThinkingEnabled');
                const thinkingEnabled = thinkingEnabledStorage ? thinkingEnabledStorage === 'true' : true;
                const thinkingApiKey = localStorage.getItem('aiThinkingApiKey') || '';
                const thinkingProviderStored = localStorage.getItem('aiThinkingProvider');
                const thinkingBaseUrlStored = localStorage.getItem('aiThinkingBaseUrl');
                const thinkingModelStored = localStorage.getItem('aiThinkingModel');
                const thinkingPrompt = localStorage.getItem('aiThinkingPrompt');
                const thinkingProvider = thinkingProviderStored && thinkingProviderStored.length > 0 ? thinkingProviderStored : provider;
                const thinkingBaseUrl = thinkingBaseUrlStored && thinkingBaseUrlStored.length > 0 ? thinkingBaseUrlStored : baseUrl;
                const thinkingModel = thinkingModelStored && thinkingModelStored.length > 0 ? thinkingModelStored : model;

                const response = await fetch('/translate_lyrics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: lyricsContent,
                        api_key: apiKey,
                        system_prompt: systemPrompt,
                        provider: provider,
                        base_url: baseUrl,
                        model: model,
                        expect_reasoning: expectReasoning,
                        compat_mode: compatMode,
                        thinking_enabled: thinkingEnabled,
                        thinking_api_key: thinkingApiKey,
                        thinking_provider: thinkingProvider,
                        thinking_base_url: thinkingBaseUrl,
                        thinking_model: thinkingModel,
                        thinking_system_prompt: thinkingPrompt
                    })
                });

                console.log('å¼€å§‹æ¥æ”¶æµå¼å“åº”...');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let translationContent = '';
                let reasoningContent = '';
                let thinkingContent = '';

                const updateEditor = () => {
                    const sections = [];
                    if (thinkingContent) {
                        sections.push('æ­Œæ›²ç†è§£:\n' + thinkingContent);
                    }
                    if (translationContent) {
                        sections.push(translationContent);
                    }
                    if (reasoningContent) {
                        sections.push('æ€è€ƒè¿‡ç¨‹:\n' + reasoningContent);
                    }
                    translationEditor.value = sections.join('\n\n');
                };

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('content:')) {
                            try {
                                const content = JSON.parse(line.slice(8));
                                if (content.translations) {
                                    translationContent = content.translations.join('\n');
                                    updateEditor();
                                }
                            } catch (e) {
                                console.error('è§£æç¿»è¯‘å†…å®¹æ—¶å‡ºé”™:', e);
                            }
                        } else if (line.startsWith('thinking:')) {
                            try {
                                const content = JSON.parse(line.slice(9));
                                if (content.summary) {
                                    thinkingContent = content.summary;
                                } else if (content.error) {
                                    thinkingContent = 'æ€è€ƒæ¨¡å‹è°ƒç”¨å¤±è´¥ï¼š' + content.error;
                                }
                                updateEditor();
                            } catch (e) {
                                console.error('è§£ææ€è€ƒå†…å®¹æ—¶å‡ºé”™:', e);
                            }
                        } else if (line.startsWith('reasoning:')) {
                            try {
                                const content = JSON.parse(line.slice(10));
                                if (content.reasoning) {
                                    reasoningContent = content.reasoning;
                                    updateEditor();
                                }
                            } catch (e) {
                                console.error('è§£ææ€ç»´é“¾å†…å®¹æ—¶å‡ºé”™:', e);
                            }
                        }
                    }
                }

                console.log('ç¿»è¯‘å®Œæˆ');
                translateBtn.textContent = originalBtnText;
                translateBtn.disabled = false;

            } catch (error) {
                console.error('ç¿»è¯‘å‡ºé”™ï¼š', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                alert('ç¿»è¯‘è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }

        function showAISettings() {
            // ä»localStorageè·å–APIå¯†é’¥å’Œæç¤ºè¯
            const savedApiKey = localStorage.getItem('aiApiKey');
            const savedSystemPrompt = localStorage.getItem('aiSystemPrompt');
            const savedProvider = localStorage.getItem('aiProvider');
            const savedBaseUrl = localStorage.getItem('aiBaseUrl');
            const savedModel = localStorage.getItem('aiModel');
            const savedExpectReasoning = localStorage.getItem('aiExpectReasoning');
            const savedCompatMode = localStorage.getItem('aiCompatMode');
            const savedThinkingEnabled = localStorage.getItem('aiThinkingEnabled');
            const savedThinkingProvider = localStorage.getItem('aiThinkingProvider');
            const savedThinkingBaseUrl = localStorage.getItem('aiThinkingBaseUrl');
            const savedThinkingModel = localStorage.getItem('aiThinkingModel');
            const savedThinkingApiKey = localStorage.getItem('aiThinkingApiKey');
            const savedThinkingPrompt = localStorage.getItem('aiThinkingPrompt');

            // è·å–å½“å‰è®¾ç½®
            fetch('/get_ai_settings')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // ä¼˜å…ˆä½¿ç”¨localStorageä¸­çš„APIå¯†é’¥å’Œæç¤ºè¯
                        document.getElementById('aiApiKey').value = savedApiKey || data.settings.api_key;
                        document.getElementById('aiSystemPrompt').value = savedSystemPrompt || data.settings.system_prompt;
                        document.getElementById('aiProvider').value = savedProvider || data.settings.provider || 'deepseek';
                        document.getElementById('aiBaseUrl').value = savedBaseUrl || data.settings.base_url || 'https://api.deepseek.com';
                        document.getElementById('aiModel').value = savedModel || data.settings.model || 'deepseek-reasoner';
                        document.getElementById('aiExpectReasoning').checked = savedExpectReasoning ? savedExpectReasoning === 'true' : (data.settings.expect_reasoning !== undefined ? data.settings.expect_reasoning : true);
                        document.getElementById('aiCompatMode').checked = savedCompatMode ? savedCompatMode === 'true' : (data.settings.compat_mode !== undefined ? data.settings.compat_mode : false);
                        document.getElementById('aiThinkingEnabled').checked = savedThinkingEnabled ? savedThinkingEnabled === 'true' : (data.settings.thinking_enabled !== undefined ? data.settings.thinking_enabled : true);
                        document.getElementById('aiThinkingProvider').value = savedThinkingProvider || data.settings.thinking_provider || data.settings.provider || 'deepseek';
                        document.getElementById('aiThinkingBaseUrl').value = savedThinkingBaseUrl || data.settings.thinking_base_url || data.settings.base_url || '';
                        document.getElementById('aiThinkingModel').value = savedThinkingModel || data.settings.thinking_model || data.settings.model || '';
                        document.getElementById('aiThinkingApiKey').value = savedThinkingApiKey || data.settings.thinking_api_key || '';
                        document.getElementById('aiThinkingPrompt').value = savedThinkingPrompt || data.settings.thinking_system_prompt || '';
                        document.getElementById('aiSettingsModal').style.display = 'block';
                        updateBaseUrlAndModel(); // æ ¹æ®é€‰æ‹©çš„æä¾›å•†æ›´æ–°URLå’Œæ¨¡å‹
                        updateThinkingBaseUrlAndModel();
                    }
                })
                .catch(error => {
                    console.error('è·å–AIè®¾ç½®å¤±è´¥ï¼š', error);
                    alert('è·å–AIè®¾ç½®å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
                });
        }

        function closeAISettings() {
            document.getElementById('aiSettingsModal').style.display = 'none';
        }

        const PROVIDER_PRESETS = {
            'deepseek': {
                baseUrl: 'https://api.deepseek.com',
                model: 'deepseek-reasoner'
            },
            'openai': {
                baseUrl: 'https://api.openai.com/v1',
                model: 'gpt-4o-mini'
            },
            'openrouter': {
                baseUrl: 'https://openrouter.ai/api/v1',
                model: 'openai/gpt-4o-mini'
            },
            'together': {
                baseUrl: 'https://api.together.xyz/v1',
                model: 'mistralai/Mistral-7B-Instruct-v0.3'
            },
            'groq': {
                baseUrl: 'https://api.groq.com/openai/v1',
                model: 'llama-3.1-70b-versatile'
            }
        };

        // æ ¹æ®é€‰æ‹©çš„æä¾›å•†æ›´æ–°åŸºç¡€URLå’Œæ¨¡å‹
        function applyProviderPreset(providerSelectId, baseInputId, modelInputId) {
            const providerSelect = document.getElementById(providerSelectId);
            const baseUrlInput = document.getElementById(baseInputId);
            const modelInput = document.getElementById(modelInputId);

            if (!providerSelect || !baseUrlInput || !modelInput) {
                return;
            }

            const provider = providerSelect.value;
            const preset = PROVIDER_PRESETS[provider];

            if (provider === 'custom' || !preset) {
                baseUrlInput.readOnly = false;
                modelInput.readOnly = false;
                return;
            }

            baseUrlInput.value = preset.baseUrl;
            modelInput.value = preset.model;
            baseUrlInput.readOnly = true;
            modelInput.readOnly = true;
        }

        function updateBaseUrlAndModel() {
            applyProviderPreset('aiProvider', 'aiBaseUrl', 'aiModel');
        }

        function updateThinkingBaseUrlAndModel() {
            applyProviderPreset('aiThinkingProvider', 'aiThinkingBaseUrl', 'aiThinkingModel');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const providerSelect = document.getElementById('aiProvider');
            if (providerSelect) {
                providerSelect.addEventListener('change', updateBaseUrlAndModel);
            }
            const thinkingProviderSelect = document.getElementById('aiThinkingProvider');
            if (thinkingProviderSelect) {
                thinkingProviderSelect.addEventListener('change', updateThinkingBaseUrlAndModel);
            }
        });

        function sanitizeBaseUrl(value) {
            if (!value) {
                return '';
            }
            return value.trim().replace(/\/+(chat|responses)\/(completions|streams?)\/?$/i, '');
        }

        function saveAISettings() {
            const apiKey = document.getElementById('aiApiKey').value;
            const systemPrompt = document.getElementById('aiSystemPrompt').value;
            const provider = document.getElementById('aiProvider').value;

            let baseUrl = sanitizeBaseUrl(document.getElementById('aiBaseUrl').value);
            document.getElementById('aiBaseUrl').value = baseUrl;

            const model = document.getElementById('aiModel').value;
            const expectReasoning = document.getElementById('aiExpectReasoning').checked;
            const compatMode = document.getElementById('aiCompatMode').checked;
            const thinkingEnabled = document.getElementById('aiThinkingEnabled').checked;

            const thinkingProvider = document.getElementById('aiThinkingProvider').value;
            let thinkingBaseUrl = sanitizeBaseUrl(document.getElementById('aiThinkingBaseUrl').value);
            document.getElementById('aiThinkingBaseUrl').value = thinkingBaseUrl;
            const thinkingModel = document.getElementById('aiThinkingModel').value;
            const thinkingApiKey = document.getElementById('aiThinkingApiKey').value;
            const thinkingPrompt = document.getElementById('aiThinkingPrompt').value;

            // ä¿å­˜è®¾ç½®åˆ°localStorage
            if (apiKey) {
                localStorage.setItem('aiApiKey', apiKey);
            } else {
                localStorage.removeItem('aiApiKey');
            }

            if (systemPrompt) {
                localStorage.setItem('aiSystemPrompt', systemPrompt);
            } else {
                localStorage.removeItem('aiSystemPrompt');
            }

            localStorage.setItem('aiProvider', provider);
            localStorage.setItem('aiBaseUrl', baseUrl);
            localStorage.setItem('aiModel', model);
            localStorage.setItem('aiExpectReasoning', expectReasoning);
            localStorage.setItem('aiCompatMode', compatMode);
            localStorage.setItem('aiThinkingEnabled', thinkingEnabled);

            if (thinkingApiKey) {
                localStorage.setItem('aiThinkingApiKey', thinkingApiKey);
            } else {
                localStorage.removeItem('aiThinkingApiKey');
            }

            if (thinkingPrompt) {
                localStorage.setItem('aiThinkingPrompt', thinkingPrompt);
            } else {
                localStorage.removeItem('aiThinkingPrompt');
            }

            localStorage.setItem('aiThinkingProvider', thinkingProvider);
            if (thinkingBaseUrl) {
                localStorage.setItem('aiThinkingBaseUrl', thinkingBaseUrl);
            } else {
                localStorage.removeItem('aiThinkingBaseUrl');
            }
            if (thinkingModel) {
                localStorage.setItem('aiThinkingModel', thinkingModel);
            } else {
                localStorage.removeItem('aiThinkingModel');
            }

            fetch('/save_ai_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_key: apiKey,
                    system_prompt: systemPrompt,
                    provider: provider,
                    base_url: baseUrl,
                    model: model,
                    expect_reasoning: expectReasoning,
                    compat_mode: compatMode,
                    thinking_enabled: thinkingEnabled,
                    thinking_api_key: thinkingApiKey,
                    thinking_provider: thinkingProvider,
                    thinking_base_url: thinkingBaseUrl,
                    thinking_model: thinkingModel,
                    thinking_system_prompt: thinkingPrompt
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('è®¾ç½®å·²ä¿å­˜ï¼');
                    closeAISettings();
                } else {
                    alert('ä¿å­˜è®¾ç½®å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜AIè®¾ç½®å¤±è´¥ï¼š', error);
                alert('ä¿å­˜AIè®¾ç½®å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚');
            });
        }

        // æµ‹è¯•AIè¿æ¥
        async function probeAIConnection(mode = 'translation', btn = null) {
            const isThinking = mode === 'thinking';
            const targetLabel = isThinking ? 'æ€è€ƒæ¨¡å‹' : 'ç¿»è¯‘æ¨¡å‹';

            const mainApiKeyInput = document.getElementById('aiApiKey');
            const mainBaseUrlInput = document.getElementById('aiBaseUrl');
            const thinkingApiKeyInput = document.getElementById('aiThinkingApiKey');
            const thinkingBaseUrlInput = document.getElementById('aiThinkingBaseUrl');

            let apiKeyInput = isThinking ? thinkingApiKeyInput : mainApiKeyInput;
            let baseUrlInput = isThinking ? thinkingBaseUrlInput : mainBaseUrlInput;

            let apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
            if (!apiKey && isThinking && mainApiKeyInput) {
                apiKey = mainApiKeyInput.value.trim();
            }

            if (!apiKey) {
                alert(`è¯·å…ˆå¡«å†™${targetLabel}çš„APIå¯†é’¥`);
                return;
            }

            let baseUrl = baseUrlInput ? baseUrlInput.value.trim() : '';
            if (!baseUrl && isThinking && mainBaseUrlInput) {
                baseUrl = mainBaseUrlInput.value.trim();
            }

            if (!baseUrl) {
                alert(`è¯·å…ˆå¡«å†™${targetLabel}çš„Base URL`);
                return;
            }

            baseUrl = sanitizeBaseUrl(baseUrl);
            if (baseUrlInput && baseUrlInput.value.trim() !== baseUrl) {
                baseUrlInput.value = baseUrl;
            }

            const probeBtn = btn || document.querySelector(`button[data-probe="${isThinking ? 'thinking' : 'translation'}"]`);
            const originalText = probeBtn ? probeBtn.textContent : '';
            if (probeBtn) {
                probeBtn.textContent = 'æµ‹è¯•ä¸­...';
                probeBtn.disabled = true;
            }

            try {
                const response = await fetch('/probe_ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mode,
                        api_key: apiKey,
                        base_url: baseUrl
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const models = data.models || [];
                    const modelList = models.slice(0, 10).join('\n');
                    const moreCount = Math.max(0, models.length - 10);
                    const moreText = moreCount > 0 ? `\n...è¿˜æœ‰${moreCount}ä¸ªæ¨¡å‹` : '';
                    alert(`${targetLabel}è¿æ¥æˆåŠŸï¼\nå¯ç”¨æ¨¡å‹ï¼ˆå‰10ä¸ªï¼‰ï¼š\n${modelList || 'ï¼ˆç©ºï¼‰'}${moreText}`);
                } else {
                    alert(`${targetLabel}è¿æ¥å¤±è´¥ï¼š${data.message}`);
                }
            } catch (error) {
                console.error(`${targetLabel}æµ‹è¯•è¿æ¥å¤±è´¥ï¼š`, error);
                alert(`${targetLabel}æµ‹è¯•è¿æ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚`);
            } finally {
                if (probeBtn) {
                    probeBtn.textContent = originalText;
                    probeBtn.disabled = false;
                }
            }
        }

        async function openLyricsAnimate(filename, style) {
            try {
                // 1) è¯»å–æ­Œæ›² JSONï¼Œæ‹¿åˆ°æ­Œè¯è·¯å¾„
                const res = await fetch('/get_json_data?filename=' + encodeURIComponent(filename));
                const data = await res.json();
                if (data.status !== 'success') throw new Error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥');

                // å…¼å®¹ä¸¤ç§å†™æ³•ï¼šå•è·¯å¾„ æˆ– "::æ­Œè¯::ç¿»è¯‘::ç½—é©¬éŸ³::"
                let rawLyricsPath = data.jsonData?.meta?.lyrics || '';
                let mainPath = '';
                if (rawLyricsPath.includes('::')) {
                    const parts = rawLyricsPath.split('::');
                    mainPath = parts[1] || '';  // ä¸»æ­Œè¯
                } else {
                    mainPath = rawLyricsPath;
                }

                // å…œåº•ï¼šæ²¡æœ‰ä¸»æ­Œè¯è·¯å¾„ï¼Œç›´æ¥æ‰“å¼€åŠ¨ç”»é¡µï¼ˆä¿æŒåŸè¡Œä¸ºï¼‰
                if (!mainPath) {
                    window.open('/lyrics-animate?file=' + encodeURIComponent(filename) +
                                '&style=' + encodeURIComponent(style), '_blank');
                    return;
                }

                // 2) å¦‚æœæ˜¯ TTMLï¼Œè°ƒç”¨åç«¯è½¬æ¢æ¥å£ï¼ˆä¸ä¿®æ”¹åŸ JSONï¼Œä»…ç”Ÿæˆè½¬æ¢äº§ç‰©ï¼‰
                const isTTML = mainPath.toLowerCase().endsWith('.ttml');
                if (isTTML) {
                    // å– /songs/ ä¸‹çš„ç›¸å¯¹è·¯å¾„ä¼ ç»™åç«¯ï¼šæ”¯æŒ http://127.0.0.1:5000/songs/xxx å’Œ /songs/xxx ä¸¤ç§
                    let relative = '';
                    try {
                        if (mainPath.startsWith('http://') || mainPath.startsWith('https://')) {
                            const u = new URL(mainPath);
                            relative = u.pathname.startsWith('/songs/') ? u.pathname.slice('/songs/'.length) : u.pathname.replace(/^\//, '');
                        } else {
                            // å½¢å¦‚ /songs/xxx æˆ– songs/xxx
                            relative = mainPath.replace(/^\/?songs\//i, '');
                        }
                        // ç¡®ä¿æ­£ç¡®è§£ç URLç¼–ç çš„æ–‡ä»¶å
                        relative = decodeURIComponent(relative);
                    } catch (e) {
                        console.error('è§£æURLå¤±è´¥:', e);
                        // è§£æå¤±è´¥ä¹Ÿå°½é‡å– basename
                        relative = mainPath.split('/').pop();
                        // ç¡®ä¿æ­£ç¡®è§£ç URLç¼–ç çš„æ–‡ä»¶å
                        relative = decodeURIComponent(relative);
                    }

                    console.log('TTMLè½¬æ¢ - æ–‡ä»¶å:', filename, 'ç›¸å¯¹è·¯å¾„:', relative);

                    // è°ƒç”¨åç«¯ï¼šæŠŠç›¸å¯¹è·¯å¾„äº¤ç»™ /convert_ttml_by_path
                    const conv = await fetch('/convert_ttml_by_path', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ path: relative })
                    }).then(r => r.json());

                    if (conv.status === 'success' && conv.lyricPath) {
                        // 3) æˆåŠŸï¼šæŠŠè½¬æ¢å¥½çš„ LYS/LRC ç”¨æŸ¥è¯¢å‚æ•°ä¼ ç»™åŠ¨ç”»é¡µæ¸²æŸ“ï¼ˆä¸æ”¹åŸæ–‡ä»¶/JSONï¼‰
                        const params = new URLSearchParams({
                            file: filename,
                            style: style,
                            lys: conv.lyricPath,          // e.g. http://<host>/songs/xxx.lys
                        });
                        if (conv.transPath) params.set('lrc', conv.transPath);

                        // âœ… æ‰“å¼€åŠ¨ç”»é¡µï¼Œå¹¶æŠŠ"ä¸´æ—¶è½¬æ¢"çš„è·¯å¾„å¸¦è¿‡å»
                        window.open('/lyrics-animate?' + params.toString(), '_blank');
                        return;
                    } else {
                        console.error('TTMLè½¬æ¢å¤±è´¥:', conv.message || 'æœªçŸ¥é”™è¯¯');
                        alert('TTML è½¬æ¢å¤±è´¥ï¼š' + (conv.message || 'è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'));
                    }
                } else {
                    // é TTMLï¼šè‹¥ä¸æ˜¯ LYSï¼Œç»™ä¸ªæç¤ºï¼ˆä¿æŒä½ åŸé€»è¾‘ï¼‰
                    if (!mainPath.toLowerCase().endsWith('.lys')) {
                        alert('è­¦å‘Šï¼šå½“å‰æ­Œè¯æ–‡ä»¶ä¸æ˜¯ LYS æ ¼å¼ï¼Œå¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤ºåŠ¨æ€æ•ˆæœï¼');
                    }
                }

                // 4) å…œåº•ï¼šæŒ‰è€é€»è¾‘æ‰“å¼€
                window.open('/lyrics-animate?file=' + encodeURIComponent(filename) +
                            '&style=' + encodeURIComponent(style), '_blank');

            } catch (error) {
                console.error('æ‰“å¼€åŠ¨ç”»é¡µå¤±è´¥ï¼š', error);
                // å…œåº•ï¼šæŒ‰è€é€»è¾‘æ‰“å¼€
                window.open('/lyrics-animate?file=' + encodeURIComponent(filename) +
                            '&style=' + encodeURIComponent(style), '_blank');
            }
        }

        function openAMLL() {
            window.open('/lyrics-amll', '_blank');
        }

        // ç«¯å£åˆ‡æ¢ç›¸å…³
        async function updatePortUI() {
            try {
                const res = await fetch('/get_port_status');
                const data = await res.json();
                console.log('[updatePortUI] ç«¯å£çŠ¶æ€', data);
                const backendPort = String(data.port);
                const isLocal = (location.hostname === '127.0.0.1' || location.hostname === 'localhost') && location.port === backendPort;
                const portBtn = document.getElementById('portSwitchBtn');

                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°ç›´è¿
                let canSwitchPort = false;
                try {
                    const ipRes = await fetch('/get_my_ip');
                    const ipData = await ipRes.json();
                    if (ipData.remote_addr === '127.0.0.1' || ipData.remote_addr === '::1') {
                        canSwitchPort = true;
                    }
                } catch (e) {}
                if (!canSwitchPort) {
                    portBtn.disabled = true;
                    portBtn.style.background = '#e9ecef';
                    portBtn.style.color = '#bbb';
                    portBtn.style.cursor = 'not-allowed';
                    portBtn.title = 'ä»…æœ¬æœºå¯åˆ‡æ¢ç«¯å£';
                } else {
                    portBtn.disabled = false;
                    portBtn.style.background = '';
                    portBtn.style.color = '';
                    portBtn.style.cursor = '';
                    portBtn.title = '';
                }

                // æ­Œè¯æ ·å¼æŒ‰é’®
                document.querySelectorAll('.am-style, .fs-style, .fslr-style').forEach(btn => {
                    console.log('[updatePortUI] å¤„ç†æŒ‰é’®', btn, 'å½“å‰mode:', data.mode, 'classList:', btn.classList.value);
                    // æ£€æŸ¥æ˜¯å¦ä¸º AMLL è§„åˆ™ç¼–å†™æŒ‰é’®ï¼ˆé€šè¿‡ onclick å±æ€§åˆ¤æ–­ï¼‰
                    const isAMLLButton = btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'amll'");

                    if (data.mode === 'random') {
                        // AMLL è§„åˆ™ç¼–å†™æŒ‰é’®åœ¨éšæœºç«¯å£ä¸‹ä»ç„¶å¯ç”¨
                        if (isAMLLButton) {
                            btn.disabled = false;
                            btn.classList.remove('disabled-style');
                            btn.title = '';
                            //btn.textContent = 'AMLLè§„åˆ™ç¼–å†™';
                        } else {
                            btn.disabled = true;
                            btn.classList.add('disabled-style');
                            btn.title = 'éšæœºç«¯å£ä¸‹ä¸å¯ç”¨';
                            btn.addEventListener('mouseenter', function() {
                                btn.textContent = 'ä¸å¯ç”¨';
                            });
                            btn.addEventListener('mouseleave', function() {
                                btn.textContent = btn.classList.contains('am-style') ? 'AMæ­Œè¯æ ·å¼' : (btn.classList.contains('fs-style') ? 'å…¨å±æ­Œè¯æ ·å¼' : 'å…¨å±å¯¹å”±æ­Œè¯æ ·å¼');
                            });
                        }
                    } else {
                        btn.disabled = false;
                        btn.classList.remove('disabled-style');
                        btn.title = '';
                        if (isAMLLButton) {
                            //btn.textContent = 'AMLLè§„åˆ™ç¼–å†™';
                        } else {
                            btn.textContent = btn.classList.contains('am-style') ? 'AMæ­Œè¯æ ·å¼' : (btn.classList.contains('fs-style') ? 'å…¨å±æ­Œè¯æ ·å¼' : 'å…¨å±å¯¹å”±æ­Œè¯æ ·å¼');
                        }
                    }
                    // å˜è‰²åç«‹å³æ‰“å°æ ·å¼
                    console.log('[updatePortUI] å˜è‰²å style.background:', btn.style.background, 'computed:', getComputedStyle(btn).background);
                });
                if (data.mode === 'random') {
                    portBtn.textContent = 'æ¢å¤ç«¯å£';
                } else {
                    portBtn.textContent = 'éšæœºç«¯å£';
                }
            } catch (e) {console.error('[updatePortUI] error', e);}
        }
        async function switchPortMode() {
            const portBtn = document.getElementById('portSwitchBtn');
            portBtn.disabled = true;
            portBtn.textContent = 'åˆ‡æ¢ä¸­...';
            try {
                const res = await fetch('/get_port_status');
                const data = await res.json();
                if (data.mode === 'random') {
                    // æ¢å¤
                    const resp = await fetch('/restore_port', {method: 'POST'});
                    const d = await resp.json();
                    if (d.status === 'success') {
                        setTimeout(() => {
                            window.location.href = `http://127.0.0.1:5000`;
                        }, 1200);
                    }
                } else {
                    // éšæœºç«¯å£
                    const resp = await fetch('/switch_port', {method: 'POST'});
                    const d = await resp.json();
                    if (d.status === 'success') {
                        setTimeout(() => {
                            window.location.href = `http://127.0.0.1:${d.port}`;
                        }, 1200);
                    }
                }
            } catch (e) {
                alert('åˆ‡æ¢ç«¯å£å¤±è´¥');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°ç«¯å£UIå’Œå®‰å…¨çŠ¶æ€
        window.addEventListener('DOMContentLoaded', function() {
            updatePortUI();
            updateSecurityUI();
            updateAuthUI();
        });

        // æ›´æ–°å®‰å…¨ä¿æŠ¤UIçŠ¶æ€
        async function updateSecurityUI() {
            try {
                const res = await fetch('/get_security_status');
                const data = await res.json();
                const securityBtn = document.getElementById('securityToggleBtn');
                
                if (data.security_enabled) {
                    securityBtn.textContent = 'ğŸ”’ å®‰å…¨ä¿æŠ¤';
                    securityBtn.title = 'å®‰å…¨ä¿æŠ¤å·²å¼€å¯ï¼ˆç‚¹å‡»å…³é—­ï¼‰';
                    securityBtn.style.background = '#37b24d';
                } else {
                    securityBtn.textContent = 'ğŸ”“ å®‰å…¨å…³é—­';
                    securityBtn.title = 'å®‰å…¨ä¿æŠ¤å·²å…³é—­ï¼ˆç‚¹å‡»å¼€å¯ï¼‰';
                    securityBtn.style.background = '#f03e3e';
                }
            } catch (e) {
                console.error('è·å–å®‰å…¨çŠ¶æ€å¤±è´¥:', e);
            }
        }

        // æ›´æ–°è®¤è¯UIçŠ¶æ€
        async function updateAuthUI() {
            try {
                const res = await fetch('/auth/status');
                const data = await res.json();
                const authBtn = document.getElementById('authToggleBtn');
                
                if (data.status === 'success') {
                    if (data.trusted) {
                        authBtn.textContent = 'ğŸ”“ å·²è§£é”';
                        authBtn.title = 'æœ¬è®¾å¤‡å·²è·å¾—ç¼–è¾‘æƒé™';
                        authBtn.style.background = '#37b24d';
                    } else {
                        authBtn.textContent = 'ğŸ”‘ è§£é”è®¾å¤‡';
                        authBtn.title = 'ç‚¹å‡»è§£é”æœ¬è®¾å¤‡ç¼–è¾‘æƒé™';
                        authBtn.style.background = '';
                    }
                    
                    // æ›´æ–°å®‰å…¨ä¿æŠ¤æŒ‰é’®çš„æç¤ºä¿¡æ¯
                    const securityBtn = document.getElementById('securityToggleBtn');
                    if (securityBtn.title) {
                        if (data.trusted) {
                            securityBtn.title += ' | æœ¬è®¾å¤‡å·²è§£é”';
                        } else {
                            securityBtn.title += ' | æœ¬è®¾å¤‡æœªè§£é”';
                        }
                    }
                }
            } catch (e) {
                console.error('è·å–è®¤è¯çŠ¶æ€å¤±è´¥:', e);
                const authBtn = document.getElementById('authToggleBtn');
                authBtn.textContent = 'ğŸ”‘ è§£é”è®¾å¤‡';
                authBtn.title = 'ç‚¹å‡»è§£é”æœ¬è®¾å¤‡ç¼–è¾‘æƒé™';
            }
        }

        // æ‰“å¼€è®¤è¯æ¨¡æ€æ¡†
        async function toggleAuthModal() {
            const modal = document.getElementById('authModal');
            const authStatus = document.getElementById('authStatus');
            const authForm = document.getElementById('authForm');
            const authSuccess = document.getElementById('authSuccess');
            const authLogoutBtn = document.getElementById('authLogoutBtn');
            
            // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
            authStatus.style.display = 'block';
            authForm.style.display = 'none';
            authSuccess.style.display = 'none';
            authStatus.textContent = 'æ­£åœ¨æ£€æŸ¥è®¾å¤‡çŠ¶æ€...';
            
            modal.style.display = 'block';
            
            try {
                const res = await fetch('/auth/status');
                const data = await res.json();
                
                if (data.status === 'success') {
                    if (data.trusted) {
                        // è®¾å¤‡å·²è®¤è¯
                        authStatus.style.display = 'none';
                        authSuccess.style.display = 'block';
                        authLogoutBtn.style.display = 'inline-block';
                    } else {
                        // è®¾å¤‡æœªè®¤è¯
                        authStatus.textContent = data.has_password ? 
                            'è¯·è¾“å…¥å¯†ç è§£é”æœ¬è®¾å¤‡' : 
                            'ç³»ç»Ÿæœªè®¾ç½®å¯†ç ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        authStatus.style.display = 'block';
                        authForm.style.display = data.has_password ? 'block' : 'none';
                        authLogoutBtn.style.display = 'none';
                    }
                }
            } catch (e) {
                authStatus.textContent = 'æ£€æŸ¥çŠ¶æ€å¤±è´¥ï¼Œè¯·é‡è¯•';
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', e);
            }
        }

        // å…³é—­è®¤è¯æ¨¡æ€æ¡†
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        // è®¾å¤‡ç™»å½•
        async function authLogin() {
            const password = document.getElementById('authPassword').value;
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            const authStatus = document.getElementById('authStatus');
            authStatus.textContent = 'æ­£åœ¨éªŒè¯å¯†ç ...';
            
            try {
                const res = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    // è®¤è¯æˆåŠŸ
                    document.getElementById('authStatus').style.display = 'none';
                    document.getElementById('authForm').style.display = 'none';
                    document.getElementById('authSuccess').style.display = 'block';
                    document.getElementById('authLogoutBtn').style.display = 'inline-block';
                    
                    // æ›´æ–°UIçŠ¶æ€
                    await updateAuthUI();
                    await updateWriteButtons();
                } else {
                    authStatus.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                    authStatus.style.color = '#f03e3e';
                    setTimeout(() => {
                        authStatus.style.color = '';
                    }, 2000);
                }
            } catch (e) {
                authStatus.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                console.error('ç™»å½•å¤±è´¥:', e);
            }
        }

        // è®¾å¤‡ç™»å‡º
        async function authLogout() {
            try {
                const res = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    // ç™»å‡ºæˆåŠŸ
                    document.getElementById('authModal').style.display = 'none';
                    
                    // æ›´æ–°UIçŠ¶æ€
                    await updateAuthUI();
                    await updateWriteButtons();
                    
                    alert('è®¾å¤‡å·²ç™»å‡º');
                }
            } catch (e) {
                console.error('ç™»å‡ºå¤±è´¥:', e);
                alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ‡æ¢å®‰å…¨ä¿æŠ¤æ¨¡å¼
        async function toggleSecurityMode() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šå…³é—­å®‰å…¨ä¿æŠ¤å°†å…è®¸å¤–éƒ¨ç½‘ç»œè®¿é—®ï¼\n\nç¡®å®šè¦åˆ‡æ¢å®‰å…¨ä¿æŠ¤æ¨¡å¼å—ï¼Ÿ')) {
                return;
            }
            
            const securityBtn = document.getElementById('securityToggleBtn');
            securityBtn.disabled = true;
            securityBtn.textContent = 'åˆ‡æ¢ä¸­...';
            
            try {
                const response = await fetch('/toggle_security', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    await updateSecurityUI();
                    alert(`å®‰å…¨ä¿æŠ¤å·²${data.security_enabled ? 'å¼€å¯' : 'å…³é—­'}`);
                    location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°çš„å®‰å…¨è®¾ç½®
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('åˆ‡æ¢å®‰å…¨æ¨¡å¼å¤±è´¥: ' + error);
            } finally {
                securityBtn.disabled = false;
                await updateSecurityUI();
            }
        }

        async function updateWriteButtons() {
            try {
                const res = await fetch('/get_port_status');
                const data = await res.json();
                const backendPort = String(data.port);
                const isLocal = (location.hostname === '127.0.0.1' || location.hostname === 'localhost') && location.port === backendPort;
                
                // æ£€æŸ¥å®‰å…¨é…ç½®å’Œè®¾å¤‡ä¿¡ä»»çŠ¶æ€
                const securityRes = await fetch('/get_security_status');
                const securityData = await securityRes.json();
                const securityEnabled = securityData.security_enabled;
                
                const authRes = await fetch('/auth/status');
                const authData = await authRes.json();
                const isTrusted = authData.status === 'success' && authData.trusted;
                
                // å¦‚æœå®‰å…¨ä¿æŠ¤å¯ç”¨ä¸”ä¸æ˜¯æœ¬åœ°è®¿é—®ä¸”è®¾å¤‡ä¸å—ä¿¡ä»»ï¼Œåˆ™ç¦ç”¨ä¿®æ”¹åŠŸèƒ½
                if (securityEnabled && !isLocal && !isTrusted) {
                    var selectors = [
                        '.file-actions .action-button',
                        '.style-buttons .style-button',
                        '.save-btn',
                        '.save-all-btn',
                        '.path-update-btn',
                        '.close-btn',
                        '.lyrics-action-btn',
                        '.editor-buttons button',
                        '.copy-btn',
                        '.modal-content button',
                        '.modal-content input',
                        '.modal-content textarea'
                    ];
                    selectors.forEach(function(sel){
                        document.querySelectorAll(sel).forEach(function(btn){
                            if(btn.textContent.match(/ä¿®æ”¹|ä¿å­˜|é‡å‘½å|åˆ é™¤|ä¸Šä¼ |åˆ›å»º|å…³é—­|åˆå¹¶|æå–|AI|è½¬æ¢|æ¢å¤|å¯¼å‡º|æ›´æ–°|è·¯å¾„|ä¸‹è½½|ç¿»è¯‘/)){
                                btn.disabled = true;
                                btn.style.pointerEvents = 'none';
                                btn.style.opacity = 0.5;
                            }
                        });
                    });
                } else {
                    // æ¢å¤æ‰€æœ‰æŒ‰é’®çŠ¶æ€
                    var selectors = [
                        '.file-actions .action-button',
                        '.style-buttons .style-button',
                        '.save-btn',
                        '.save-all-btn',
                        '.path-update-btn',
                        '.close-btn',
                        '.lyrics-action-btn',
                        '.editor-buttons button',
                        '.copy-btn',
                        '.modal-content button',
                        '.modal-content input',
                        '.modal-content textarea'
                    ];
                    selectors.forEach(function(sel){
                        document.querySelectorAll(sel).forEach(function(btn){
                            btn.disabled = false;
                            btn.style.pointerEvents = '';
                            btn.style.opacity = '';
                        });
                    });
                }
            } catch (e) {}
        }
        
        // æ˜¾ç¤ºå—ä¿¡ä»»è®¾å¤‡åˆ—è¡¨
        async function showTrustedDevices() {
            try {
                const res = await fetch('/auth/trusted');
                const data = await res.json();
                
                if (data.status === 'success') {
                    if (data.devices.length === 0) {
                        alert('æš‚æ— å—ä¿¡ä»»è®¾å¤‡');
                        return;
                    }
                    
                    let message = `å—ä¿¡ä»»è®¾å¤‡åˆ—è¡¨ (å…± ${data.total} ä¸ª):\n\n`;
                    data.devices.forEach(device => {
                        message += `è®¾å¤‡ID: ${device.device_id}\n`;
                        message += `IP: ${device.ip}\n`;
                        message += `åˆ›å»ºæ—¶é—´: ${device.created_at}\n`;
                        message += `æœ€åè®¿é—®: ${device.last_seen}\n`;
                        message += `UAå“ˆå¸Œ: ${device.ua_hash}\n`;
                        message += 'â”€'.repeat(30) + '\n';
                    });
                    
                    alert(message);
                } else {
                    alert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');
                }
            } catch (e) {
                console.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥:', e);
                alert('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨æœ‰æƒé™è®¿é—®');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è®¾å¤‡
        async function revokeAllDevices() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å—ä¿¡ä»»è®¾å¤‡å—ï¼Ÿ\n\næ­¤æ“ä½œå°†å¼ºåˆ¶æ‰€æœ‰è®¾å¤‡é‡æ–°è®¤è¯ï¼')) {
                return;
            }
            
            try {
                const res = await fetch('/auth/revoke_all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert(`å·²æˆåŠŸæ¸…ç©º ${data.revoked_count} ä¸ªå—ä¿¡ä»»è®¾å¤‡`);
                    // æ›´æ–°UIçŠ¶æ€
                    await updateAuthUI();
                    await updateWriteButtons();
                } else {
                    alert('æ¸…ç©ºè®¾å¤‡å¤±è´¥');
                }
            } catch (e) {
                console.error('æ¸…ç©ºè®¾å¤‡å¤±è´¥:', e);
                alert('æ¸…ç©ºè®¾å¤‡å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨æœ‰æƒé™è®¿é—®');
            }
        }
        
        // å¯†ç è®¾ç½®ç›¸å…³åŠŸèƒ½
        function showSetPasswordModal() {
            document.getElementById('setPasswordModal').style.display = 'block';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('setPasswordStatus').style.display = 'none';
        }

        function closeSetPasswordModal() {
            document.getElementById('setPasswordModal').style.display = 'none';
        }

        async function setPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const statusDiv = document.getElementById('setPasswordStatus');
            
            // éªŒè¯å¯†ç 
            if (newPassword.length < 8) {
                statusDiv.textContent = 'âŒ å¯†ç é•¿åº¦è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffeaea';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                statusDiv.textContent = 'âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffeaea';
                return;
            }
            
            try {
                const res = await fetch('/auth/set_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: newPassword,
                        current_password: currentPassword || undefined
                    })
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    statusDiv.textContent = 'âœ… å¯†ç è®¾ç½®æˆåŠŸï¼';
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#eaffea';
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    
                    // 3ç§’åå…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        closeSetPasswordModal();
                    }, 3000);
                } else {
                    statusDiv.textContent = `âŒ ${data.message || 'å¯†ç è®¾ç½®å¤±è´¥'}`;
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffeaea';
                }
            } catch (e) {
                console.error('è®¾ç½®å¯†ç å¤±è´¥:', e);
                statusDiv.textContent = 'âŒ è®¾ç½®å¯†ç å¤±è´¥ï¼Œè¯·é‡è¯•';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffeaea';
            }
        }

        // è®¾å¤‡åŠé”€ç›¸å…³åŠŸèƒ½
        function showRevokeDeviceModal() {
            document.getElementById('revokeDeviceModal').style.display = 'block';
            loadDevicesForRevoke();
        }

        function closeRevokeDeviceModal() {
            document.getElementById('revokeDeviceModal').style.display = 'none';
        }

        async function loadDevicesForRevoke() {
            const statusDiv = document.getElementById('revokeDeviceStatus');
            const listDiv = document.getElementById('revokeDeviceList');
            
            try {
                const res = await fetch('/auth/trusted');
                const data = await res.json();
                
                if (data.status === 'success' && data.devices.length > 0) {
                    statusDiv.style.display = 'none';
                    listDiv.style.display = 'block';
                    listDiv.innerHTML = '';
                    
                    data.devices.forEach(device => {
                        const deviceCard = document.createElement('div');
                        deviceCard.style.padding = '10px';
                        deviceCard.style.border = '1px solid var(--border-color)';
                        deviceCard.style.borderRadius = '8px';
                        deviceCard.style.marginBottom = '8px';
                        deviceCard.innerHTML = `
                            <div style="font-weight: bold;">è®¾å¤‡ID: ${device.device_id}</div>
                            <div>IP: ${device.ip}</div>
                            <div>åˆ›å»ºæ—¶é—´: ${device.created_at}</div>
                            <div>æœ€åè®¿é—®: ${device.last_seen}</div>
                            <button onclick="revokeDevice('${device.device_id.replace('...', '')}')" 
                                    style="margin-top: 8px; padding: 5px 10px; background: #f03e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ğŸš« åŠé”€æ­¤è®¾å¤‡
                            </button>
                        `;
                        listDiv.appendChild(deviceCard);
                    });
                } else {
                    statusDiv.textContent = 'æš‚æ— å—ä¿¡ä»»è®¾å¤‡';
                    statusDiv.style.background = '#f8f9fa';
                }
            } catch (e) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', e);
                statusDiv.textContent = 'åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥';
                statusDiv.style.background = '#ffeaea';
            }
        }

        async function revokeDevice(deviceIdPrefix) {
            if (!confirm(`ç¡®å®šè¦åŠé”€è®¾å¤‡ ${deviceIdPrefix}... å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                const res = await fetch('/auth/revoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceIdPrefix })
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    alert(`âœ… å·²æˆåŠŸåŠé”€ ${data.revoked_count} ä¸ªè®¾å¤‡`);
                    // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
                    loadDevicesForRevoke();
                    // æ›´æ–°UIçŠ¶æ€
                    await updateAuthUI();
                    await updateWriteButtons();
                } else {
                    alert('âŒ åŠé”€è®¾å¤‡å¤±è´¥');
                }
            } catch (e) {
                console.error('åŠé”€è®¾å¤‡å¤±è´¥:', e);
                alert('âŒ åŠé”€è®¾å¤‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function searchDevices() {
            const searchTerm = document.getElementById('deviceSearch').value.toLowerCase();
            const deviceCards = document.getElementById('revokeDeviceList').querySelectorAll('div');
            
            deviceCards.forEach(card => {
                const deviceText = card.textContent.toLowerCase();
                if (deviceText.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // æ·»åŠ è®¾å¤‡ç®¡ç†ä¸‹æ‹‰èœå•çš„æ˜¾ç¤º/éšè—é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            // ä½¿ç”¨æ›´å¯é çš„é€‰æ‹©å™¨ï¼ŒåŸºäºæ–‡æœ¬å†…å®¹è€ŒéCSSä½ç½®
            const manageButtons = document.querySelectorAll('.action-button');
            const manageButton = Array.from(manageButtons).find(btn => 
                btn.textContent.includes('è®¾å¤‡ç®¡ç†') || btn.textContent.includes('âš™ï¸')
            );
            
            if (manageButton) {
                const dropdownMenu = manageButton.querySelector('.dropdown-menu');
                if (dropdownMenu) {
                    manageButton.addEventListener('click', function(e) {
                        dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
                        e.stopPropagation();
                    });
                    
                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                    document.addEventListener('click', function() {
                        dropdownMenu.style.display = 'none';
                    });
                }
            }
        });
        
        window.addEventListener('DOMContentLoaded', updateWriteButtons);
    </script>
</body>

</html>
