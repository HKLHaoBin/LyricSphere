(function(){const T=document.createElement("link").relList;if(T&&T.supports&&T.supports("modulepreload"))return;for(const I of document.querySelectorAll('link[rel="modulepreload"]'))P(I);new MutationObserver(I=>{for(const F of I)if(F.type==="childList")for(const D of F.addedNodes)D.tagName==="LINK"&&D.rel==="modulepreload"&&P(D)}).observe(document,{childList:!0,subtree:!0});function L(I){const F={};return I.integrity&&(F.integrity=I.integrity),I.referrerPolicy&&(F.referrerPolicy=I.referrerPolicy),I.crossOrigin==="use-credentials"?F.credentials="include":I.crossOrigin==="anonymous"?F.credentials="omit":F.credentials="same-origin",F}function P(I){if(I.ep)return;I.ep=!0;const F=L(I);fetch(I.href,F)}})();const __vite__wasmUrl="/assets/amll_lyric_bg-Dy4VPaCX.wasm",__vite__initWasm=async(R={},T)=>{let L;if(T.startsWith("data:")){const P=T.replace(/^data:.*?base64,/,"");let I;if(typeof Buffer=="function"&&typeof Buffer.from=="function")I=Buffer.from(P,"base64");else if(typeof atob=="function"){const F=atob(P);I=new Uint8Array(F.length);for(let D=0;D<F.length;D++)I[D]=F.charCodeAt(D)}else throw new Error("Cannot decode base64-encoded data URL");L=await WebAssembly.instantiate(I,R)}else{const P=await fetch(T),I=P.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&I.startsWith("application/wasm"))L=await WebAssembly.instantiateStreaming(P,R);else{const F=await P.arrayBuffer();L=await WebAssembly.instantiate(F,R)}}return L.instance.exports};let wasm$1;function __wbg_set_wasm(R){wasm$1=R}const heap=new Array(128).fill(void 0);heap.push(void 0,null,!0,!1);function getObject(R){return heap[R]}let heap_next=heap.length;function dropObject(R){R<132||(heap[R]=heap_next,heap_next=R)}function takeObject(R){const T=getObject(R);return dropObject(R),T}function addHeapObject(R){heap_next===heap.length&&heap.push(heap.length+1);const T=heap_next;return heap_next=heap[T],heap[T]=R,T}const lTextDecoder=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder;let cachedTextDecoder=new lTextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});cachedTextDecoder.decode();let cachedUint8ArrayMemory0=null;function getUint8ArrayMemory0(){return(cachedUint8ArrayMemory0===null||cachedUint8ArrayMemory0.byteLength===0)&&(cachedUint8ArrayMemory0=new Uint8Array(wasm$1.memory.buffer)),cachedUint8ArrayMemory0}function getStringFromWasm0(R,T){return R=R>>>0,cachedTextDecoder.decode(getUint8ArrayMemory0().subarray(R,R+T))}let WASM_VECTOR_LEN=0;const lTextEncoder=typeof TextEncoder>"u"?(0,module.require)("util").TextEncoder:TextEncoder;let cachedTextEncoder=new lTextEncoder("utf-8");const encodeString=typeof cachedTextEncoder.encodeInto=="function"?function(R,T){return cachedTextEncoder.encodeInto(R,T)}:function(R,T){const L=cachedTextEncoder.encode(R);return T.set(L),{read:R.length,written:L.length}};function passStringToWasm0(R,T,L){if(L===void 0){const V=cachedTextEncoder.encode(R),q=T(V.length,1)>>>0;return getUint8ArrayMemory0().subarray(q,q+V.length).set(V),WASM_VECTOR_LEN=V.length,q}let P=R.length,I=T(P,1)>>>0;const F=getUint8ArrayMemory0();let D=0;for(;D<P;D++){const V=R.charCodeAt(D);if(V>127)break;F[I+D]=V}if(D!==P){D!==0&&(R=R.slice(D)),I=L(I,P,P=D+R.length*3,1)>>>0;const V=getUint8ArrayMemory0().subarray(I+D,I+P),q=encodeString(R,V);D+=q.written,I=L(I,P,D,1)>>>0}return WASM_VECTOR_LEN=D,I}function isLikeNone(R){return R==null}let cachedDataViewMemory0=null;function getDataViewMemory0(){return(cachedDataViewMemory0===null||cachedDataViewMemory0.buffer.detached===!0||cachedDataViewMemory0.buffer.detached===void 0&&cachedDataViewMemory0.buffer!==wasm$1.memory.buffer)&&(cachedDataViewMemory0=new DataView(wasm$1.memory.buffer)),cachedDataViewMemory0}function debugString(R){const T=typeof R;if(T=="number"||T=="boolean"||R==null)return`${R}`;if(T=="string")return`"${R}"`;if(T=="symbol"){const I=R.description;return I==null?"Symbol":`Symbol(${I})`}if(T=="function"){const I=R.name;return typeof I=="string"&&I.length>0?`Function(${I})`:"Function"}if(Array.isArray(R)){const I=R.length;let F="[";I>0&&(F+=debugString(R[0]));for(let D=1;D<I;D++)F+=", "+debugString(R[D]);return F+="]",F}const L=/\[object ([^\]]+)\]/.exec(toString.call(R));let P;if(L.length>1)P=L[1];else return toString.call(R);if(P=="Object")try{return"Object("+JSON.stringify(R)+")"}catch{return"Object"}return R instanceof Error?`${R.name}: ${R.message}
${R.stack}`:P}function stringifyAss$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyAss(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function decryptQrcHex$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16),D=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),V=WASM_VECTOR_LEN;wasm$1.decryptQrcHex(F,D,V);var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function parseEslrc$1(R){const T=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),L=WASM_VECTOR_LEN,P=wasm$1.parseEslrc(T,L);return takeObject(P)}function stringifyEslrc$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyEslrc(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function parseLrc$1(R){const T=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),L=WASM_VECTOR_LEN,P=wasm$1.parseLrc(T,L);return takeObject(P)}function stringifyLrc$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyLrc(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function parseLys$1(R){const T=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),L=WASM_VECTOR_LEN,P=wasm$1.parseLys(T,L);return takeObject(P)}function stringifyLys$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyLys(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function parseQrc$1(R){const T=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),L=WASM_VECTOR_LEN,P=wasm$1.parseQrc(T,L);return takeObject(P)}function stringifyQrc$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyQrc(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function parseTTML$1(R){const T=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),L=WASM_VECTOR_LEN,P=wasm$1.parseTTML(T,L);return takeObject(P)}function stringifyTTML$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyTTML(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function parseYrc$1(R){const T=passStringToWasm0(R,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),L=WASM_VECTOR_LEN,P=wasm$1.parseYrc(T,L);return takeObject(P)}function stringifyYrc$1(R){let T,L;try{const F=wasm$1.__wbindgen_add_to_stack_pointer(-16);wasm$1.stringifyYrc(F,addHeapObject(R));var P=getDataViewMemory0().getInt32(F+0,!0),I=getDataViewMemory0().getInt32(F+4,!0);return T=P,L=I,getStringFromWasm0(P,I)}finally{wasm$1.__wbindgen_add_to_stack_pointer(16),wasm$1.__wbindgen_free(T,L,1)}}function wasm_start$1(){wasm$1.wasm_start()}function handleError(R,T){try{return R.apply(this,T)}catch(L){wasm$1.__wbindgen_exn_store(addHeapObject(L))}}function __wbindgen_object_drop_ref(R){takeObject(R)}function __wbindgen_is_bigint(R){return typeof getObject(R)=="bigint"}function __wbindgen_bigint_from_u64(R){const T=BigInt.asUintN(64,R);return addHeapObject(T)}function __wbindgen_jsval_eq(R,T){return getObject(R)===getObject(T)}function __wbindgen_error_new(R,T){const L=new Error(getStringFromWasm0(R,T));return addHeapObject(L)}function __wbindgen_is_object(R){const T=getObject(R);return typeof T=="object"&&T!==null}function __wbindgen_is_undefined(R){return getObject(R)===void 0}function __wbindgen_in(R,T){return getObject(R)in getObject(T)}function __wbindgen_string_get(R,T){const L=getObject(T),P=typeof L=="string"?L:void 0;var I=isLikeNone(P)?0:passStringToWasm0(P,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),F=WASM_VECTOR_LEN;getDataViewMemory0().setInt32(R+4,F,!0),getDataViewMemory0().setInt32(R+0,I,!0)}function __wbindgen_boolean_get(R){const T=getObject(R);return typeof T=="boolean"?T?1:0:2}function __wbindgen_jsval_loose_eq(R,T){return getObject(R)==getObject(T)}function __wbindgen_number_get(R,T){const L=getObject(T),P=typeof L=="number"?L:void 0;getDataViewMemory0().setFloat64(R+8,isLikeNone(P)?0:P,!0),getDataViewMemory0().setInt32(R+0,!isLikeNone(P),!0)}function __wbindgen_as_number(R){return+getObject(R)}function __wbindgen_number_new(R){return addHeapObject(R)}function __wbindgen_object_clone_ref(R){const T=getObject(R);return addHeapObject(T)}function __wbindgen_string_new(R,T){const L=getStringFromWasm0(R,T);return addHeapObject(L)}function __wbg_getwithrefkey_edc2c8960f0f1191(R,T){const L=getObject(R)[getObject(T)];return addHeapObject(L)}function __wbg_set_f975102236d3c502(R,T,L){getObject(R)[takeObject(T)]=takeObject(L)}function __wbg_call_1084a111329e68ce(){return handleError(function(R,T){const L=getObject(R).call(getObject(T));return addHeapObject(L)},arguments)}function __wbg_get_3baa728f9d58d3f6(R,T){const L=getObject(R)[T>>>0];return addHeapObject(L)}function __wbg_length_ae22078168b726f5(R){return getObject(R).length}function __wbg_new_a220cf903aa02ca2(){const R=new Array;return addHeapObject(R)}function __wbindgen_is_function(R){return typeof getObject(R)=="function"}function __wbg_next_de3e9db4440638b2(R){const T=getObject(R).next;return addHeapObject(T)}function __wbg_next_f9cb570345655b9a(){return handleError(function(R){const T=getObject(R).next();return addHeapObject(T)},arguments)}function __wbg_done_bfda7aa8f252b39f(R){return getObject(R).done}function __wbg_value_6d39332ab4788d86(R){const T=getObject(R).value;return addHeapObject(T)}function __wbg_iterator_888179a48810a9fe(){return addHeapObject(Symbol.iterator)}function __wbg_get_224d16597dbbfd96(){return handleError(function(R,T){const L=Reflect.get(getObject(R),getObject(T));return addHeapObject(L)},arguments)}function __wbg_new_525245e2b9901204(){const R=new Object;return addHeapObject(R)}function __wbg_set_673dda6c73d19609(R,T,L){getObject(R)[T>>>0]=takeObject(L)}function __wbg_isArray_8364a5371e9737d8(R){return Array.isArray(getObject(R))}function __wbg_instanceof_ArrayBuffer_61dfc3198373c902(R){let T;try{T=getObject(R)instanceof ArrayBuffer}catch{T=!1}return T}function __wbg_isSafeInteger_7f1ed56200d90674(R){return Number.isSafeInteger(getObject(R))}function __wbg_buffer_b7b08af79b0b0974(R){const T=getObject(R).buffer;return addHeapObject(T)}function __wbg_new_ea1883e1e5e86686(R){const T=new Uint8Array(getObject(R));return addHeapObject(T)}function __wbg_set_d1e79e2388520f18(R,T,L){getObject(R).set(getObject(T),L>>>0)}function __wbg_length_8339fcf5d8ecd12e(R){return getObject(R).length}function __wbg_instanceof_Uint8Array_247a91427532499e(R){let T;try{T=getObject(R)instanceof Uint8Array}catch{T=!1}return T}function __wbindgen_bigint_get_as_i64(R,T){const L=getObject(T),P=typeof L=="bigint"?L:void 0;getDataViewMemory0().setBigInt64(R+8,isLikeNone(P)?BigInt(0):P,!0),getDataViewMemory0().setInt32(R+0,!isLikeNone(P),!0)}function __wbindgen_debug_string(R,T){const L=debugString(getObject(T)),P=passStringToWasm0(L,wasm$1.__wbindgen_malloc,wasm$1.__wbindgen_realloc),I=WASM_VECTOR_LEN;getDataViewMemory0().setInt32(R+4,I,!0),getDataViewMemory0().setInt32(R+0,P,!0)}function __wbindgen_throw(R,T){throw new Error(getStringFromWasm0(R,T))}function __wbindgen_memory(){const R=wasm$1.memory;return addHeapObject(R)}URL=globalThis.URL;const __vite__wasmModule=await __vite__initWasm({"./amll_lyric_bg.js":{__wbindgen_object_drop_ref,__wbindgen_is_bigint,__wbindgen_bigint_from_u64,__wbindgen_jsval_eq,__wbindgen_error_new,__wbindgen_is_object,__wbindgen_is_undefined,__wbindgen_in,__wbindgen_string_get,__wbindgen_boolean_get,__wbindgen_jsval_loose_eq,__wbindgen_number_get,__wbindgen_as_number,__wbindgen_number_new,__wbindgen_object_clone_ref,__wbindgen_string_new,__wbg_getwithrefkey_edc2c8960f0f1191,__wbg_set_f975102236d3c502,__wbg_call_1084a111329e68ce,__wbg_get_3baa728f9d58d3f6,__wbg_length_ae22078168b726f5,__wbg_new_a220cf903aa02ca2,__wbindgen_is_function,__wbg_next_de3e9db4440638b2,__wbg_next_f9cb570345655b9a,__wbg_done_bfda7aa8f252b39f,__wbg_value_6d39332ab4788d86,__wbg_iterator_888179a48810a9fe,__wbg_get_224d16597dbbfd96,__wbg_new_525245e2b9901204,__wbg_set_673dda6c73d19609,__wbg_isArray_8364a5371e9737d8,__wbg_instanceof_ArrayBuffer_61dfc3198373c902,__wbg_isSafeInteger_7f1ed56200d90674,__wbg_buffer_b7b08af79b0b0974,__wbg_new_ea1883e1e5e86686,__wbg_set_d1e79e2388520f18,__wbg_length_8339fcf5d8ecd12e,__wbg_instanceof_Uint8Array_247a91427532499e,__wbindgen_bigint_get_as_i64,__wbindgen_debug_string,__wbindgen_throw,__wbindgen_memory}},__vite__wasmUrl),memory=__vite__wasmModule.memory,stringifyAss=__vite__wasmModule.stringifyAss,decryptQrcHex=__vite__wasmModule.decryptQrcHex,parseEslrc=__vite__wasmModule.parseEslrc,stringifyEslrc=__vite__wasmModule.stringifyEslrc,parseLrc=__vite__wasmModule.parseLrc,stringifyLrc=__vite__wasmModule.stringifyLrc,parseLys=__vite__wasmModule.parseLys,stringifyLys=__vite__wasmModule.stringifyLys,parseQrc=__vite__wasmModule.parseQrc,stringifyQrc=__vite__wasmModule.stringifyQrc,parseTTML=__vite__wasmModule.parseTTML,stringifyTTML=__vite__wasmModule.stringifyTTML,parseYrc=__vite__wasmModule.parseYrc,stringifyYrc=__vite__wasmModule.stringifyYrc,wasm_start=__vite__wasmModule.wasm_start,__wbindgen_malloc=__vite__wasmModule.__wbindgen_malloc,__wbindgen_realloc=__vite__wasmModule.__wbindgen_realloc,__wbindgen_add_to_stack_pointer=__vite__wasmModule.__wbindgen_add_to_stack_pointer,__wbindgen_free=__vite__wasmModule.__wbindgen_free,__wbindgen_exn_store=__vite__wasmModule.__wbindgen_exn_store,__wbindgen_start=__vite__wasmModule.__wbindgen_start,wasm=Object.freeze(Object.defineProperty({__proto__:null,__wbindgen_add_to_stack_pointer,__wbindgen_exn_store,__wbindgen_free,__wbindgen_malloc,__wbindgen_realloc,__wbindgen_start,decryptQrcHex,memory,parseEslrc,parseLrc,parseLys,parseQrc,parseTTML,parseYrc,stringifyAss,stringifyEslrc,stringifyLrc,stringifyLys,stringifyQrc,stringifyTTML,stringifyYrc,wasm_start},Symbol.toStringTag,{value:"Module"}));__wbg_set_wasm(wasm);__wbindgen_start();const lyrics=Object.freeze(Object.defineProperty({__proto__:null,__wbg_buffer_b7b08af79b0b0974,__wbg_call_1084a111329e68ce,__wbg_done_bfda7aa8f252b39f,__wbg_get_224d16597dbbfd96,__wbg_get_3baa728f9d58d3f6,__wbg_getwithrefkey_edc2c8960f0f1191,__wbg_instanceof_ArrayBuffer_61dfc3198373c902,__wbg_instanceof_Uint8Array_247a91427532499e,__wbg_isArray_8364a5371e9737d8,__wbg_isSafeInteger_7f1ed56200d90674,__wbg_iterator_888179a48810a9fe,__wbg_length_8339fcf5d8ecd12e,__wbg_length_ae22078168b726f5,__wbg_new_525245e2b9901204,__wbg_new_a220cf903aa02ca2,__wbg_new_ea1883e1e5e86686,__wbg_next_de3e9db4440638b2,__wbg_next_f9cb570345655b9a,__wbg_set_673dda6c73d19609,__wbg_set_d1e79e2388520f18,__wbg_set_f975102236d3c502,__wbg_set_wasm,__wbg_value_6d39332ab4788d86,__wbindgen_as_number,__wbindgen_bigint_from_u64,__wbindgen_bigint_get_as_i64,__wbindgen_boolean_get,__wbindgen_debug_string,__wbindgen_error_new,__wbindgen_in,__wbindgen_is_bigint,__wbindgen_is_function,__wbindgen_is_object,__wbindgen_is_undefined,__wbindgen_jsval_eq,__wbindgen_jsval_loose_eq,__wbindgen_memory,__wbindgen_number_get,__wbindgen_number_new,__wbindgen_object_clone_ref,__wbindgen_object_drop_ref,__wbindgen_string_get,__wbindgen_string_new,__wbindgen_throw,decryptQrcHex:decryptQrcHex$1,parseEslrc:parseEslrc$1,parseLrc:parseLrc$1,parseLys:parseLys$1,parseQrc:parseQrc$1,parseTTML:parseTTML$1,parseYrc:parseYrc$1,stringifyAss:stringifyAss$1,stringifyEslrc:stringifyEslrc$1,stringifyLrc:stringifyLrc$1,stringifyLys:stringifyLys$1,stringifyQrc:stringifyQrc$1,stringifyTTML:stringifyTTML$1,stringifyYrc:stringifyYrc$1,wasm_start:wasm_start$1},Symbol.toStringTag,{value:"Module"}));function parseTimestampMs(R){const T=R.split(/[:.]/);if(T.length<2||T.length>3)throw new Error(`Invalid timestamp format: ${R}`);let L,P,I;if(T.length===3){L=parseInt(T[0]),P=parseInt(T[1]);const F=T[2];switch(I=0,F.length){case 1:I=parseInt(F)*100;break;case 2:I=parseInt(F)*10;break;case 3:I=parseInt(F);break;default:I=parseInt(F.substring(0,3));break}}else L=parseInt(T[0]),P=parseInt(T[1]),I=0;return(L*60+P)*1e3+I}function isESLyRiCFormat(R){const T=R.split(`
`).filter(P=>P.trim().length>0);return T.length===0?!1:T.slice(0,Math.min(5,T.length)).some(P=>/^\[\d{2}:\d{2}\.\d{3}\][\u4e00-\u9fa5a-zA-Z0-9]\[\d{2}:\d{2}\.\d{3}\]/.test(P))}function isLyRiCA2Format(R){const T=R.split(`
`).filter(P=>P.trim().length>0);return T.length===0?!1:T.slice(0,Math.min(5,T.length)).some(P=>/^\[\d{2}:\d{2}\.\d{3}\]<\d{2}:\d{2}\.\d{3}>/.test(P))}function isSPLFormat(R){const T=R.split(`
`).filter(P=>P.trim().length>0);return T.length===0?!1:T.slice(0,Math.min(5,T.length)).some(P=>/^((\[\d{1,3}:\d{1,2}(?:\.\d{1,6})?\])+)(.*)$/.test(P.trim()))}function isWalaokeFormat(R){const T=R.split(`
`).filter(P=>P.trim().length>0);return T.length===0?!1:T.slice(0,Math.min(5,T.length)).some(P=>{const I=/^(W|F|D|v1|v2):\s*\[\d{2}:\d{2}\.\d{3}\]/,F=/^\[\d{2}:\d{2}\.\d{3}\]\s*(W|F|D|v1|v2):/;return I.test(P.trim())||F.test(P.trim())})}function parseESLyRiC(R){const T=R.split(`
`).filter(P=>P.trim().length>0),L=[];for(const P of T){const I=P.match(/^\[(\d{2}):(\d{2})\.(\d{3})\]/);if(!I)continue;const F=parseInt(I[1])*60*1e3+parseInt(I[2])*1e3+parseInt(I[3]);let D=P.substring(I[0].length);const V=[];let q=F;const G=D.match(/\[(\d{2}):(\d{2})\.(\d{3})\]/);if(G){const tt=parseInt(G[1])*60*1e3+parseInt(G[2])*1e3+parseInt(G[3]);F!==tt&&(q=tt)}const z=/([^\[]+)\[(\d{2}):(\d{2})\.(\d{3})\]/g;let Q;for(;(Q=z.exec(D))!==null;){const tt=Q[1],yt=parseInt(Q[2])*60*1e3+parseInt(Q[3])*1e3+parseInt(Q[4]);V.push({word:tt,startTime:q,endTime:yt}),q=yt}const J=D.match(/([^\[]+)$/);if(J){const tt=J[1].replace(/\d{2}:\d{2}\.\d{3}\]$/,"");V.push({word:tt,startTime:q,endTime:q})}V.length>0&&(V[0].word=(V[0].word??V[0].text??"").replace(/^\s+/,""),V[V.length-1].word=(V[V.length-1].word??V[V.length-1].text??"").replace(/\s+$/,""),L.push({words:V,startTime:V[0].startTime,endTime:V[V.length-1].endTime,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:!1}))}return L}function parseSPL(R){const T=R.split(`
`).filter(I=>I.trim().length>0),L=[],P=[];for(const I of T){const D=I.trim().match(/^\[(\d{1,3}):(\d{1,2})(?:\.(\d{1,6}))?\]/);if(!D)continue;const V=parseInt(D[1]),q=parseInt(D[2]),G=D[3]?parseInt(D[3].padEnd(3,"0").slice(0,3)):0,z=V*6e4+q*1e3+G;P.push(z)}for(let I=0;I<T.length;I++){const D=T[I].trim(),V=D.match(/^\[(\d{1,3}):(\d{1,2})(?:\.(\d{1,6}))?\]/);if(!V)continue;const q=parseInt(V[1]),G=parseInt(V[2]),z=V[3]?parseInt(V[3].padEnd(3,"0").slice(0,3)):0;let Q=q*6e4+G*1e3+z,J;I===P.length-1?J=Q+5e3:J=P[I+1];let tt=D.substring(V[0].length);const yt=[];let At=Q;if(tt.includes("<")||tt.includes("[")){const Et=/([^<\[]+?)[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]/g;let kt,ne=!1;const Se=[];for(;(kt=Et.exec(tt))!==null;){ne=!0;const Ht=kt[1].trim(),Le=parseTimestampMs(`${kt[2]}:${kt[3]}.${kt[4]}`);Se.push({word:Ht,time:Le})}if(ne&&Se.length>0){for(let Le=0;Le<Se.length;Le++){const ee=Se[Le];Le<Se.length-1?Se[Le+1].time:ee.time+1e3,yt.push({word:ee.word,startTime:At,endTime:ee.time}),At=ee.time}const Ht=tt.match(/[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]$/);if(Ht){const Le=parseTimestampMs(`${Ht[1]}:${Ht[2]}.${Ht[3]}`);yt.length>0&&(yt[yt.length-1].endTime=Le)}}else{const Ht=tt.match(/[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]/);if(Ht&&Ht.index!==void 0){const ee=tt.substring(0,Ht.index).trim();ee&&(yt.push({word:ee,startTime:At,endTime:parseTimestampMs(`${Ht[1]}:${Ht[2]}.${Ht[3]}`)}),At=yt[yt.length-1].endTime),tt=tt.substring(Ht.index+Ht[0].length);let si;for(;(si=Et.exec(tt))!==null;){const ci=si[1].trim(),di=parseTimestampMs(`${si[2]}:${si[3]}.${si[4]}`);yt.push({word:ci,startTime:At,endTime:di}),At=di}}const Le=tt.match(/([^<]+)$/);if(Le){const ee=Le[1].trim();ee&&yt.push({word:ee,startTime:At,endTime:J})}}}else{const Et=tt.trim();Et&&yt.push({word:Et,startTime:Q,endTime:J})}yt.length>0&&(yt[0].word=(yt[0].word??"").replace(/^\s+/,""),yt[yt.length-1].word=(yt[yt.length-1].word??"").replace(/\s+$/,""),L.push({words:yt,startTime:yt[0].startTime,endTime:yt[yt.length-1].endTime,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:!1}))}return L.sort((I,F)=>I.startTime-F.startTime),convertToTTML(L)}function parseWalaoke(R){const T=R.split(`
`).filter(P=>P.trim().length>0),L=[];for(const P of T){const I=P.trim(),F=I.match(/^(W|F|D|v1|v2):\s*[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]](.*)$/),D=I.match(/^[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]\s*(W|F|D|v1|v2):(.*)$/);let V=F,q=!1;if(D&&(V=D,q=!0),V){let G,z,Q,J,tt;q?[,z,Q,J,G,tt]=V:[,G,z,Q,J,tt]=V;const yt=parseInt(z)*6e4+parseInt(Q)*1e3+parseInt(J);let At=tt;const gt=[];let Et=yt;if(At.includes("<")||At.includes("[")){const Ht=At.match(/^[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]/);Ht&&(Et=parseTimestampMs(`${Ht[1]}:${Ht[2]}.${Ht[3]}`),At=At.substring(Ht[0].length));const Le=/([^<\[]*?)[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]/g;let ee,si=0;for(;(ee=Le.exec(At))!==null;){const ui=ee[1].trim(),ei=parseTimestampMs(`${ee[2]}:${ee[3]}.${ee[4]}`);ui&&(gt.push({word:ui,startTime:Et,endTime:ei}),Et=ei),si=ee.index+ee[0].length}let ci=At.substring(si).trim();const di=ci.match(/^(.*)[<\[](\d{2}):(\d{2})\.(\d{2,3})[>\]]$/);if(di){const ui=di[1].trim(),ei=parseTimestampMs(`${di[2]}:${di[3]}.${di[4]}`);ui?gt.push({word:ui,startTime:Et,endTime:ei}):gt.length>0&&(gt[gt.length-1].endTime=ei)}else ci&&gt.push({word:ci,startTime:Et,endTime:Et+1e3})}else{const Ht=tt.trim();Ht&&gt.push({word:Ht,startTime:yt,endTime:yt+1e3})}let ne=!1,Se="";switch(G){case"W":gt.length>0&&(gt[0].word=`[第一声部] ${gt[0].word}`);break;case"F":gt.length>0&&(gt[0].word=`[第二声部] ${gt[0].word}`);break;case"D":gt.length>0&&(gt[0].word=`[合唱] ${gt[0].word}`);break;case"v1":ne=!0,Se="v1";break;case"v2":ne=!0,Se="v2";break}gt.length>0&&(gt[0].word=(gt[0].word??"").replace(/^\s+/,""),gt[gt.length-1].word=(gt[gt.length-1].word??"").replace(/\s+$/,""),L.push({words:gt,startTime:gt[0].startTime,endTime:gt[gt.length-1].endTime,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:ne,agent:Se}))}}return L.sort((P,I)=>P.startTime-I.startTime),convertToTTML(L)}function parseLyRiCA2(R){const T=R.split(`
`).filter(P=>P.trim().length>0),L=[];for(const P of T){const I=P.match(/^\[(\d{2}):(\d{2})\.(\d{3})\]<(\d{2}):(\d{2})\.(\d{3})>/);if(!I)continue;const F=parseInt(I[4])*60*1e3+parseInt(I[5])*1e3+parseInt(I[6]);let D=P.substring(I[0].length);const V=[];let q=F;const G=D.match(/<(\d{2}):(\d{2})\.(\d{3})>/);if(G){const tt=parseInt(G[1])*60*1e3+parseInt(G[2])*1e3+parseInt(G[3]);F!==tt&&(q=tt)}const z=/([^<]+)<(\d{2}):(\d{2})\.(\d{3})>/g;let Q;for(;(Q=z.exec(D))!==null;){const tt=Q[1],yt=parseInt(Q[2])*60*1e3+parseInt(Q[3])*1e3+parseInt(Q[4]);V.push({word:tt,startTime:q,endTime:yt}),q=yt}const J=D.match(/([^<]+)$/);if(J){const tt=J[1].replace(/\d{2}:\d{2}\.\d{3}>$/,"");V.push({word:tt,startTime:q,endTime:q})}V.length>0&&(V[0].word=(V[0].word??V[0].text??"").replace(/^\s+/,""),V[V.length-1].word=(V[V.length-1].word??V[V.length-1].text??"").replace(/\s+$/,""),L.push({words:V,startTime:V[0].startTime,endTime:V[V.length-1].endTime,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:!1}))}return L}function convertToTTML(R){let T=`<?xml version="1.0" encoding="utf-8"?>
<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xmlns:tts="http://www.w3.org/ns/ttml#styling" xml:lang="en">
  <head>
    <metadata>
      <ttm:title>Converted Lyrics</ttm:title>
    </metadata>
    <styling>
      <style xml:id="normal" tts:fontFamily="Arial" tts:fontSize="100%" tts:textAlign="center"/>
    </styling>
    <layout>
      <region xml:id="bottom" tts:origin="0% 0%" tts:extent="100% 100%" tts:textAlign="center" tts:displayAlign="after"/>
    </layout>
  </head>
  <body>
    <div>
`;for(const L of R){const P=formatTime$3(L.startTime);if(!L.words||L.words.length===0)throw new Error(`Empty line: ${JSON.stringify(L)}`);const I=L.words[L.words.length-1];I.endTime||(I.endTime=I.startTime);const F=formatTime$3(I.endTime),D=L.agent?` ttm:agent="${L.agent}"`:"";T+=`      <p begin="${P}" end="${F}" region="bottom"${D}>`;const V=[];for(let q=0;q<L.words.length;q++){const G=L.words[q],z=formatTime$3(G.startTime),Q=formatTime$3(G.endTime);let J=G.word??G.text??"";q===0&&(J=J.replace(/^\s+/,"")),q===L.words.length-1&&(J=J.replace(/\s+$/,"")),V.push(`<span begin="${z}" end="${Q}">${escapeXml$4(J)}</span>`)}T+=V.join(""),T+=`</p>
`}return T+=`    </div>
  </body>
</tt>`,T}function formatTime$3(R){const T=Math.floor(R/1e3),L=Math.floor(T/3600),P=Math.floor(T%3600/60),I=T%60,F=R%1e3;return`${L.toString().padStart(2,"0")}:${P.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}.${F.toString().padStart(3,"0")}`}function escapeXml$4(R){return R.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}const ASS_TIME_REGEX=/(\d+):(\d{2}):(\d{2})\.(\d{2})/,KARAOKE_TAG_REGEX=/\{\\k(?:[fo])?(\d+)}/g,ASS_LINE_REGEX=/^(?<Type>Comment|Dialogue):\s*(?<Layer>\d+)\s*,\s*(?<Start>\d+:\d{2}:\d{2}\.\d{2})\s*,\s*(?<End>\d+:\d{2}:\d{2}\.\d{2})\s*,\s*(?<Style>[^,]*?)\s*,\s*(?<Actor>[^,]*?)\s*,\s*[^,]*\s*,\s*[^,]*\s*,\s*[^,]*\s*,\s*(?<Effect>[^,]*?)\s*,\s*(?<Text>.*?)\s*$/;function stripOverrideTags(R,T={}){const{collapseSpaces:L=!1,trim:P=!1}=T;let I=R.replace(/\{[^}]*\}/g,"").replace(/\\[Nn]/g," ").replace(/\\h/g," ");return L&&(I=I.replace(/[ \t]+/g," ")),P&&(I=I.trim()),I}function parseAssTime(R){const T=R.match(ASS_TIME_REGEX);if(!T)throw new Error(`无效的时间格式: ${R}`);const L=parseInt(T[1],10),P=parseInt(T[2],10),I=parseInt(T[3],10),F=parseInt(T[4],10);return L*36e5+P*6e4+I*1e3+F*10}function isAssFormat(R){if(!R)return!1;const T=R.slice(0,2048);return/\[Script Info\]/i.test(T)&&/\[Events\]/i.test(R)||/Aegisub/i.test(T)?!0:T.split(/\r?\n/).filter(Boolean).slice(0,30).some(P=>/^(Comment|Dialogue):/.test(P))}function parseAss(R){const T=[],L=R.split(/\r?\n/);for(const P of L){const I=P.match(ASS_LINE_REGEX);if(!I||!I.groups||I.groups.Type==="Comment")continue;const D=parseAssTime(I.groups.Start),V=parseAssTime(I.groups.End),q=I.groups.Text??"",G=[];let z=D;const Q=[...q.matchAll(KARAOKE_TAG_REGEX)];if(Q.length===0){const J=stripOverrideTags(q,{collapseSpaces:!1,trim:!1});J&&G.push({word:J,startTime:D,endTime:V})}else{for(let J=0;J<Q.length;J++){const tt=Q[J],yt=Q[J+1],At=parseInt(tt[1]||"0",10),gt=tt.index+tt[0].length,Et=yt?yt.index:q.length,kt=q.slice(gt,Et),ne=stripOverrideTags(kt,{collapseSpaces:!1,trim:!1}),Se=Math.max(0,At*10),Ht=z+Se;ne&&G.push({word:ne,startTime:z,endTime:Ht}),z=Ht}G.length>0&&G[G.length-1].endTime<V&&(G[G.length-1].endTime=V)}G.length>0&&T.push({words:G,startTime:G[0].startTime,endTime:G[G.length-1].endTime,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:!1})}return T}function formatTime$2(R){const T=Math.floor(R/1e3),L=Math.floor(T/3600),P=Math.floor(T%3600/60),I=T%60,F=R%1e3;return`${L.toString().padStart(2,"0")}:${P.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}.${F.toString().padStart(3,"0")}`}function assToTTML(R){const T=parseAss(R);let L=`<?xml version="1.0" encoding="utf-8"?>
<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xmlns:tts="http://www.w3.org/ns/ttml#styling" xml:lang="en">
  <head>
    <metadata>
      <ttm:title>Converted Lyrics</ttm:title>
    </metadata>
    <styling>
      <style xml:id="normal" tts:fontFamily="Arial" tts:fontSize="100%" tts:textAlign="center"/>
    </styling>
    <layout>
      <region xml:id="bottom" tts:origin="0% 0%" tts:extent="100% 100%" tts:textAlign="center" tts:displayAlign="after"/>
    </layout>
  </head>
  <body>
    <div>
`;for(const P of T){const I=formatTime$2(P.startTime),F=formatTime$2(P.endTime);L+=`      <p begin="${I}" end="${F}" region="bottom">`;const D=[];for(const V of P.words)D.push(`<span begin="${formatTime$2(V.startTime)}" end="${formatTime$2(V.endTime)}">${escapeXml$3(V.word)}</span>`);L+=`${D.join("")}`,L+=`</p>
`}return L+=`    </div>
  </body>
</tt>`,L}function escapeXml$3(R){return R.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function parseLqe(R){if(!R.trim().startsWith("[Lyricify Quick Export]"))throw new Error("文件缺少 [Lyricify Quick Export] 头部标记");let T=[],L=[],P=[];const I={};let F=0,D="",V=0;const q=R.split(/\r?\n/);if(!q.some(z=>z.startsWith("[lyrics:")))try{const z=parseLrc$1(R);if(z.length>0)return z}catch{}for(let z=0;z<q.length;z++){const Q=q[z];if(Q.startsWith("[")&&Q.endsWith("]")){const J=Q.match(/^\[(.*?):(.*)\]$/);if(J){const tt=J[1].trim(),yt=J[2].trim();["lyrics","translation","pronunciation","Lyricify Quick Export","version"].includes(tt)||(I[tt]||(I[tt]=[]),I[tt].push(yt))}}if(Q.startsWith("[lyrics:")||Q.startsWith("[translation:")||Q.startsWith("[pronunciation:")){if(D.trim()){const tt=processBlock(D,V);switch(F){case 1:T=tt;break;case 2:L=tt;break;case 3:P=tt;break}}D="";const{format:J}=parseSectionHeader(Q);V=J,Q.startsWith("[lyrics:")?F=1:Q.startsWith("[translation:")?F=2:F=3}else!Q.startsWith("[Lyricify Quick Export]")&&!Q.startsWith("[version:")&&(D+=Q+`
`)}if(D.trim()){const z=processBlock(D,V);switch(F){case 1:T=z;break;case 2:L=z;break;case 3:P=z;break}}return T.length===0&&(L.length>0?(T=L,L=[]):P.length>0&&(T=P,P=[])),(L.length>0||P.length>0)&&(T=mergeTracks(T,L,P)),T}function parseSectionHeader(R){let T=0,L=null;const P=R.match(/^\[(.*?):(.*)\]$/);if(P){const I=P[2].split(",").map(F=>F.trim());for(const F of I){const[D,V]=F.split("@").map(q=>q.trim());if(D==="format")switch(V.toLowerCase()){case"lrc":T=0;break;case"ass":T=2;break;case"yrc":T=3;break;case"lys":T=1;break;case"qrc":T=4;break;default:T=0}else D==="language"&&(L=V)}}return{format:T,lang:L}}function processBlock(R,T){if(!R.trim())return[];try{const L=R.endsWith(`
`)?R:R+`
`;switch(T){case 0:const P=parseLrc$1(L);if(P.length!==0){const I=P[0]}return P;default:return parseLrc$1(L)}}catch{return[]}}function mergeTracks(R,T,L){if(R.length===0)return T.length>0?T:L.length>0?L:[];const P=JSON.parse(JSON.stringify(R));for(let I=0;I<P.length;I++){const F=P[I],D=F.startTime,V=F.endTime;if((!F.words||!Array.isArray(F.words)||F.words.length===0)&&(F.words=[{word:`[行 ${I+1}]`,startTime:D,endTime:V||D+1e3}]),T.length>0){let q=T.find(G=>Math.abs(G.startTime-D)<100&&(Math.abs(G.endTime-V)<100||!V||!G.endTime));if(q)F.translatedLyric=q.words.map(G=>G.word).join("");else{let G=T[0],z=Math.abs(G.startTime-D);for(const Q of T){const J=Math.abs(Q.startTime-D);J<z&&(z=J,G=Q)}z<2e3&&(F.translatedLyric=G.words.map(Q=>Q.word).join(""))}}if(L.length>0){let q=L.find(G=>Math.abs(G.startTime-D)<100&&(Math.abs(G.endTime-V)<100||!V||!G.endTime));if(q)F.romanLyric=q.words.map(G=>G.word).join("");else{let G=L[0],z=Math.abs(G.startTime-D);for(const Q of L){const J=Math.abs(Q.startTime-D);J<z&&(z=J,G=Q)}z<2e3&&(F.romanLyric=G.words.map(Q=>Q.word).join(""))}}for(const q of F.words)(isNaN(q.startTime)||q.startTime<0)&&(q.startTime=D),(isNaN(q.endTime)||q.endTime<=q.startTime)&&(q.endTime=q.startTime+500)}return P}function isLqeFormat(R){return R?R.slice(0,2048).includes("[Lyricify Quick Export]"):!1}function lqeToTTML(R){try{const T=parseLqe(R);if(T.length===0)try{const L=parseLrc$1(R);if(L.length>0)return generateTTML(L)}catch{}return generateTTML(T)}catch{try{const L=parseLrc$1(R);if(L.length>0)return generateTTML(L)}catch{}return`<?xml version="1.0" encoding="utf-8"?>
<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xmlns:tts="http://www.w3.org/ns/ttml#styling" xml:lang="en">
  <head>
    <metadata>
      <ttm:title>Converted Lyrics</ttm:title>
    </metadata>
    <styling>
      <style xml:id="normal" tts:fontFamily="Arial" tts:fontSize="100%" tts:textAlign="center"/>
    </styling>
    <layout>
      <region xml:id="bottom" tts:origin="0% 0%" tts:extent="100% 100%" tts:textAlign="center" tts:displayAlign="after"/>
    </layout>
  </head>
  <body>
    <div>
      <p begin="00:00:00.000" end="00:00:01.000" region="bottom">
        <span begin="00:00:00.000" end="00:00:01.000">解析歌词失败</span>
      </p>
    </div>
  </body>
</tt>`}}function generateTTML(R){let T=`<?xml version="1.0" encoding="utf-8"?>
<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xmlns:tts="http://www.w3.org/ns/ttml#styling" xml:lang="en">
  <head>
    <metadata>
      <ttm:title>Converted Lyrics</ttm:title>
    </metadata>
    <styling>
      <style xml:id="normal" tts:fontFamily="Arial" tts:fontSize="100%" tts:textAlign="center"/>
    </styling>
    <layout>
      <region xml:id="bottom" tts:origin="0% 0%" tts:extent="100% 100%" tts:textAlign="center" tts:displayAlign="after"/>
    </layout>
  </head>
  <body>
    <div>
`;for(const L of R){(isNaN(L.startTime)||L.startTime<0)&&(L.startTime=0),(isNaN(L.endTime)||L.endTime<=L.startTime)&&(L.endTime=L.startTime+1e3);const P=formatTime$1(L.startTime),I=formatTime$1(L.endTime);T+=`      <p begin="${P}" end="${I}" region="bottom">`;const F=[];if(!L.words||L.words.length===0)F.push(`<span begin="${P}" end="${I}">[无歌词]</span>`);else for(const D of L.words){const V=isNaN(D.startTime)?L.startTime:D.startTime,q=isNaN(D.endTime)||D.endTime<=V?V+500:D.endTime,G=D.word?D.word:"[空]";F.push(`<span begin="${formatTime$1(V)}" end="${formatTime$1(q)}">${escapeXml$2(G)}</span>`)}T+=`${F.join("")}`,T+=`</p>
`}return T+=`    </div>
  </body>
</tt>`,T}function formatTime$1(R){const T=Math.floor(R/1e3),L=Math.floor(T/3600),P=Math.floor(T%3600/60),I=T%60,F=R%1e3;return`${L.toString().padStart(2,"0")}:${P.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}.${F.toString().padStart(3,"0")}`}function escapeXml$2(R){return R.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function isLylFormat(R){const T=R.split(`
`).filter(P=>P.trim().length>0);return T.length===0||!T[0].includes("[type:LyricifyLines]")?!1:T.slice(1,Math.min(5,T.length)).some(P=>/^\[(\d+),(\d+)\]/.test(P.trim()))}function parseLyl(R){const T=R.split(`
`).filter(I=>I.trim().length>0),L=[],P=/^\[(\d+),(\d+)\](.*)$/;for(const[I,F]of T.entries()){const D=F.trim();if(D.length===0||D.includes("[type:LyricifyLines]"))continue;const V=P.exec(D);if(V){const q=parseInt(V[1]),G=parseInt(V[2]),z=V[3].trim();if(z.length===0)continue;const Q=[{word:z,startTime:q,endTime:G}];L.push({words:Q,startTime:q,endTime:G,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:!1})}}return L}function lylToTTML(R){const T=parseLyl(R);let L=`<?xml version="1.0" encoding="utf-8"?>
<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xmlns:tts="http://www.w3.org/ns/ttml#styling" xml:lang="en">
  <head>
    <metadata>
      <ttm:title>Converted LYL Lyrics</ttm:title>
    </metadata>
    <styling>
      <style xml:id="normal" tts:fontFamily="Arial" tts:fontSize="100%" tts:textAlign="center"/>
    </styling>
    <layout>
      <region xml:id="bottom" tts:origin="0% 0%" tts:extent="100% 100%" tts:textAlign="center" tts:displayAlign="after"/>
    </layout>
  </head>
  <body>
    <div>
`;for(const P of T){const I=formatTime(P.startTime),F=formatTime(P.endTime);L+=`      <p begin="${I}" end="${F}" region="bottom">`;const D=[];for(const V of P.words)D.push(`<span>${escapeXml$1(V.word)}</span>`);L+=`${D.join("")}`,L+=`</p>
`}return L+=`    </div>
  </body>
</tt>`,L}function formatTime(R){const T=Math.floor(R/1e3),L=Math.floor(T/3600),P=Math.floor(T%3600/60),I=T%60,F=R%1e3;return`${L.toString().padStart(2,"0")}:${P.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}.${F.toString().padStart(3,"0")}`}function escapeXml$1(R){return R.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function isSrtFormat(R){const T=R.split(/\r?\n/).map(P=>P.trim()),L=/\d{2}:\d{2}:\d{2},\d{3}\s+-->\s+\d{2}:\d{2}:\d{2},\d{3}/;return T.some(P=>L.test(P))}function srtToTTML(R){const T=splitSrtBlocks(R);let L=`<?xml version="1.0" encoding="utf-8"?>
<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xmlns:tts="http://www.w3.org/ns/ttml#styling" xml:lang="en">
  <head>
    <metadata>
      <ttm:title>SRT Converted</ttm:title>
    </metadata>
    <styling>
      <style xml:id="normal" tts:fontFamily="Arial" tts:fontSize="100%" tts:textAlign="center"/>
    </styling>
    <layout>
      <region xml:id="bottom" tts:origin="0% 0%" tts:extent="100% 100%" tts:textAlign="center" tts:displayAlign="after"/>
    </layout>
  </head>
  <body>
    <div>
`;for(const P of T){if(!P)continue;const{beginMs:I,endMs:F,text:D}=P;if(I==null||F==null)continue;const V=formatTtmlTime(I),q=formatTtmlTime(F),G=escapeXml(D).replace(/\n/g,"<br/>");L+=`      <p begin="${V}" end="${q}" region="bottom">`,L+=`<span begin="${V}" end="${q}">${G}</span>`,L+=`</p>
`}return L+=`    </div>
  </body>
</tt>`,L}function splitSrtBlocks(R){const L=R.replace(/\r\n/g,`
`).split(/\n\s*\n/),P=/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/,I=[];for(const F of L){const D=F.split(/\n/).map(yt=>yt.trim());if(D.length===0)continue;let V=0;/^\d+$/.test(D[0])&&(V=1);const q=D[V]||"",G=P.exec(q);if(!G)continue;const z=hmsToMs(G[1],G[2],G[3],G[4]),Q=hmsToMs(G[5],G[6],G[7],G[8]),tt=D.slice(V+1).filter(yt=>yt.length>0).join(`
`);I.push({beginMs:z,endMs:Q,text:tt})}return I}function hmsToMs(R,T,L,P){const I=parseInt(R,10)||0,F=parseInt(T,10)||0,D=parseInt(L,10)||0,V=parseInt(P,10)||0;return((I*60+F)*60+D)*1e3+V}function formatTtmlTime(R){const T=Math.floor(R/1e3),L=Math.floor(T/3600),P=Math.floor(T%3600/60),I=T%60,F=R%1e3;return`${L.toString().padStart(2,"0")}:${P.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}.${F.toString().padStart(3,"0")}`}function escapeXml(R){return R.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}const translations={en:{artist:"Artist",songInfo:"Metadata",title:"Title",loopPlay:"Loop Playback",loadFromUrl:"Load from URL",loadFiles:"Load Files",resetPlayer:"Reset Player",sourceFile:"Source",musicUrl:"Enter music URL",lyricsUrl:"Enter lyrics or lyrics URL",coverUrl:"Enter cover image URL",extractedFromFilename:"Extracted song info from filename",extractedSongInfo:"Extracted song info successfully",usedFilenameAsTitle:"Used filename as song title",showControlPanel:"Show Control Panel",hideControlPanel:"Hide Control Panel",clickToAddLyrics:"Click or drag & drop here to add lyrics",supportedLyricFormats:"Supports LyRiC / LyRiC A2 / LyRiC Walaoke / ESLyRiC / Salt Player ESLyRiC (*.lrc, *.spl), Apple Music (*.ttml, *.json), Netease Music (*.yrc), Lyricify (*.lys, *.lyl, *.lqe), QQMusic (*.qrc), KuGou (*.krc), ALRC (*.alrc, *.json), SubRip (*.srt), Aegisub (*.ass), Musixmatch (*.json) formats",musicLoadSuccess:"Music file loaded successfully",musicLoadFailed:"Failed to load music file",globalSettings:"Global",coverSettings:"Cover",lyricSettings:"Lyrics",backgroundSettings:"Background",visualizationSettings:"Visualization",backgroundBeat:"Background Beat",lyricsLoadSuccess:"Lyrics file loaded successfully",lyricsLoadFailed:"Failed to load lyrics file",coverLoadSuccess:"Cover image loaded successfully",coverLoadFailed:"Failed to load cover image",lyricsUrlLoadFailed:"Failed to load lyrics from URL",loadFromUrlComplete:"Loading from URL completed",lyricsParseSuccess:"Lyrics loaded successfully, total lines: ",lyricsParseFailed:"Failed to parse lyrics",playerReset:"Player has been reset",metadataParseSuccess:"Audio metadata parsed successfully",metadataParseFailed:"Failed to parse audio metadata, using fallback",metadataLibNotLoaded:"Audio metadata library not loaded, using fallback",metadataParseError:"Error parsing audio metadata, using fallback",cannotParseAudioInfo:"Cannot parse audio file information",backgroundControl:"Background Control",flowSpeed:"Flow Speed",toggleBackgroundMode:"Toggle Background Mode",playbackRate:"Playback Speed",volume:"Volume",playbackControl:"Playback Control",amllBackground:"AMLL Background",coverBackground:"Cover Background",solidBackground:"Solid Background",coverBlurLevel:"Blur Level",colorMask:"Color Mask",invertColors:"Invert",showFPS:"Show Performance Monitor",enableMarquee:"Title Marquee Effect",roundedCover:"Cover Rounded Corners",coverRotation:"Cover Rotation Speed",renderScale:"Render Scale",backgroundFPS:"Background FPS",lyricAlignPosition:"Vertical Align",lyricFontSize:"Font Size",hidePassedLyrics:"Hide Passed Lyrics",lyricDelay:"Lyrics Delay",enableLyricBlur:"Lyrics Blur Effect",enableLyricScale:"Lyrics Scaling Effect",enableLyricSpring:"Lyrics Spring Effect",wordFadeWidth:"Word Fade Width",alignTop:"Top",alignCenter:"Center",alignBottom:"Bottom",lyricAlignFocus:"Lyrics Align Focus",backgroundStyle:"Background Style",showTranslatedLyric:"Show Translated",showRomanLyric:"Show Romanized",swapLyricPositions:"Swap Translated & Romanized",showbgLyric:"Show Background Lyrics",swapDuetsPositions:"Swap Left & Right",advanceLyricTiming:"Compact Gap (±400ms)",lowFreqVolume:"Low Frequency Volume",singleLyrics:"Single Lyrics",coverStyle:"Cover Style",normalShadow:"Shadow",innerShadow:"Inner Shadow",threeDShadow:"3D Shadow",longShadow:"Long Shadow",neumorphismA:"Neumorphism A",neumorphismB:"Neumorphism B",horizontalReflection:"Horizontal Reflection",cdRecord:"CD Record",vinylRecord:"Vinyl Record",coloredRecord:"Colored Record",fftDataRangeMin:"Minimum Frequency",fftDataRangeMax:"Maximum Frequency",posYSpringMass:"Vertical Spring Mass",posYSpringDamping:"Vertical Spring Damping",posYSpringStiffness:"Vertical Spring Stiffness",posYSpringSoft:"Soft Vertical Spring",scaleSpringMass:"Scale Spring Mass",controlPointCode:"Control Point Code",scaleSpringDamping:"Scale Spring Damping",scaleSpringStiffness:"Scale Spring Stiffness",scaleSpringSoft:"Soft Scale Spring",dominantColor:"Dominant Colors"},zh:{artist:"艺术家",songInfo:"元数据",title:"标题",loopPlay:"循环播放",loadFromUrl:"从URL加载",loadFiles:"加载文件",resetPlayer:"重置播放器",sourceFile:"播放源",musicUrl:"输入音乐文件URL",lyricsUrl:"输入歌词或歌词文件URL",coverUrl:"输入封面图片URL",extractedFromFilename:"从文件名解析歌曲信息",extractedSongInfo:"从文件名解析歌曲信息成功",usedFilenameAsTitle:"使用文件名作为歌曲标题",showControlPanel:"显示控制面板",hideControlPanel:"隐藏控制面板",clickToAddLyrics:"点击或拖拽至此区域添加歌词",supportedLyricFormats:"支持 LyRiC / LyRiC A2 / LyRiC Walaoke / ESLyRiC / Salt Player ESLyRiC (*.lrc, *.spl), Apple Music (*.ttml, *.json), Netease Music (*.yrc), Lyricify (*.lys, *.lyl, *.lqe), QQMusic (*.qrc), KuGou (*.krc), ALRC (*.alrc, *.json), SubRip (*.srt), Aegisub (*.ass), Musixmatch (*.json) 格式",musicLoadSuccess:"音乐文件加载成功",musicLoadFailed:"音乐文件加载失败",globalSettings:"全局",coverSettings:"封面",lyricSettings:"歌词",backgroundSettings:"背景",visualizationSettings:"可视化",backgroundBeat:"背景跳动",lyricsLoadSuccess:"歌词文件加载成功",lyricsLoadFailed:"歌词文件加载失败",coverLoadSuccess:"封面图片加载成功",coverLoadFailed:"封面图片加载失败",lyricsUrlLoadFailed:"歌词URL加载失败",loadFromUrlComplete:"从URL加载完成",lyricsParseSuccess:"歌词加载成功，共 ",lyricsParseFailed:"歌词解析失败",playerReset:"播放器已重置",metadataParseSuccess:"音频元数据解析成功",metadataParseFailed:"音频元数据解析失败，使用备用方案",metadataLibNotLoaded:"音频元数据解析库未加载，使用备用方案",metadataParseError:"音频元数据解析出错，使用备用方案",cannotParseAudioInfo:"无法解析音频文件信息",backgroundControl:"背景控制",flowSpeed:"流动速度",toggleBackgroundMode:"切换背景模式",playbackRate:"播放速度",volume:"音量",playbackControl:"播放控制",amllBackground:"AMLL 背景",coverBackground:"封面背景",solidBackground:"纯色背景",coverBlurLevel:"模糊程度",colorMask:"颜色蒙版",invertColors:"反转",showFPS:"显示性能监控",enableMarquee:"标题跑马灯效果",roundedCover:"封面圆角",coverRotation:"封面旋转速度",renderScale:"渲染比例",backgroundFPS:"背景帧率",lyricAlignPosition:"垂直位置",lyricFontSize:"字体大小",hidePassedLyrics:"隐藏已播歌词",lyricDelay:"歌词延迟",enableLyricBlur:"歌词模糊效果",enableLyricScale:"歌词缩放效果",enableLyricSpring:"歌词弹簧效果",wordFadeWidth:"歌词渐变宽度",alignTop:"顶部",alignCenter:"居中",alignBottom:"底部",lyricAlignFocus:"歌词对齐焦点",backgroundStyle:"背景样式",showTranslatedLyric:"显示翻译",showRomanLyric:"显示音译",swapLyricPositions:"交换译文位置",showbgLyric:"显示背景词",swapDuetsPositions:"交换左右对齐",advanceLyricTiming:"紧凑间隙 (±400ms)",lowFreqVolume:"低音频率",singleLyrics:"单行歌词",coverStyle:"封面样式",normalShadow:"阴影",innerShadow:"内阴影",threeDShadow:"立体投影",longShadow:"长投影",neumorphismA:"新拟态A",neumorphismB:"新拟态B",horizontalReflection:"水平倒影",cdRecord:"CD唱片",vinylRecord:"黑胶唱片",coloredRecord:"彩胶唱片",fftDataRangeMin:"最小频率",fftDataRangeMax:"最大频率",posYSpringMass:"垂直弹簧质量",posYSpringDamping:"垂直弹簧阻尼",posYSpringStiffness:"垂直弹簧刚度",posYSpringSoft:"柔软垂直弹簧",controlPointCode:"控制点代码",scaleSpringMass:"缩放弹簧质量",scaleSpringDamping:"缩放弹簧阻尼",scaleSpringStiffness:"缩放弹簧刚度",scaleSpringSoft:"柔软缩放弹簧",dominantColor:"主色调"}};function getCurrentLanguage(){return navigator.language.toLowerCase().startsWith("zh")?"zh":"en"}function t$3(R){const T=getCurrentLanguage();return translations[T][R]}/**
 * lil-gui
 * https://lil-gui.georgealways.com
 * @version 0.20.0
 * @author George Michael Brower
 * @license MIT
 */class Controller{constructor(T,L,P,I,F="div"){this.parent=T,this.object=L,this.property=P,this._disabled=!1,this._hidden=!1,this.initialValue=this.getValue(),this.domElement=document.createElement(F),this.domElement.classList.add("controller"),this.domElement.classList.add(I),this.$name=document.createElement("div"),this.$name.classList.add("name"),Controller.nextNameID=Controller.nextNameID||0,this.$name.id=`lil-gui-name-${++Controller.nextNameID}`,this.$widget=document.createElement("div"),this.$widget.classList.add("widget"),this.$disable=this.$widget,this.domElement.appendChild(this.$name),this.domElement.appendChild(this.$widget),this.domElement.addEventListener("keydown",D=>D.stopPropagation()),this.domElement.addEventListener("keyup",D=>D.stopPropagation()),this.parent.children.push(this),this.parent.controllers.push(this),this.parent.$children.appendChild(this.domElement),this._listenCallback=this._listenCallback.bind(this),this.name(P)}name(T){return this._name=T,this.$name.textContent=T,this}onChange(T){return this._onChange=T,this}_callOnChange(){this.parent._callOnChange(this),this._onChange!==void 0&&this._onChange.call(this,this.getValue()),this._changed=!0}onFinishChange(T){return this._onFinishChange=T,this}_callOnFinishChange(){this._changed&&(this.parent._callOnFinishChange(this),this._onFinishChange!==void 0&&this._onFinishChange.call(this,this.getValue())),this._changed=!1}reset(){return this.setValue(this.initialValue),this._callOnFinishChange(),this}enable(T=!0){return this.disable(!T)}disable(T=!0){return T===this._disabled?this:(this._disabled=T,this.domElement.classList.toggle("disabled",T),this.$disable.toggleAttribute("disabled",T),this)}show(T=!0){return this._hidden=!T,this.domElement.style.display=this._hidden?"none":"",this}hide(){return this.show(!1)}options(T){const L=this.parent.add(this.object,this.property,T);return L.name(this._name),this.destroy(),L}min(T){return this}max(T){return this}step(T){return this}decimals(T){return this}listen(T=!0){return this._listening=T,this._listenCallbackID!==void 0&&(cancelAnimationFrame(this._listenCallbackID),this._listenCallbackID=void 0),this._listening&&this._listenCallback(),this}_listenCallback(){this._listenCallbackID=requestAnimationFrame(this._listenCallback);const T=this.save();T!==this._listenPrevValue&&this.updateDisplay(),this._listenPrevValue=T}getValue(){return this.object[this.property]}setValue(T){return this.getValue()!==T&&(this.object[this.property]=T,this._callOnChange(),this.updateDisplay()),this}updateDisplay(){return this}load(T){return this.setValue(T),this._callOnFinishChange(),this}save(){return this.getValue()}destroy(){this.listen(!1),this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent.controllers.splice(this.parent.controllers.indexOf(this),1),this.parent.$children.removeChild(this.domElement)}}class BooleanController extends Controller{constructor(T,L,P){super(T,L,P,"boolean","label"),this.$input=document.createElement("input"),this.$input.setAttribute("type","checkbox"),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$widget.appendChild(this.$input),this.$input.addEventListener("change",()=>{this.setValue(this.$input.checked),this._callOnFinishChange()}),this.$disable=this.$input,this.updateDisplay()}updateDisplay(){return this.$input.checked=this.getValue(),this}}function normalizeColorString(R){let T,L;return(T=R.match(/(#|0x)?([a-f0-9]{6})/i))?L=T[2]:(T=R.match(/rgb\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/))?L=parseInt(T[1]).toString(16).padStart(2,0)+parseInt(T[2]).toString(16).padStart(2,0)+parseInt(T[3]).toString(16).padStart(2,0):(T=R.match(/^#?([a-f0-9])([a-f0-9])([a-f0-9])$/i))&&(L=T[1]+T[1]+T[2]+T[2]+T[3]+T[3]),L?"#"+L:!1}const STRING={isPrimitive:!0,match:R=>typeof R=="string",fromHexString:normalizeColorString,toHexString:normalizeColorString},INT={isPrimitive:!0,match:R=>typeof R=="number",fromHexString:R=>parseInt(R.substring(1),16),toHexString:R=>"#"+R.toString(16).padStart(6,0)},ARRAY={isPrimitive:!1,match:R=>Array.isArray(R),fromHexString(R,T,L=1){const P=INT.fromHexString(R);T[0]=(P>>16&255)/255*L,T[1]=(P>>8&255)/255*L,T[2]=(P&255)/255*L},toHexString([R,T,L],P=1){P=255/P;const I=R*P<<16^T*P<<8^L*P<<0;return INT.toHexString(I)}},OBJECT={isPrimitive:!1,match:R=>Object(R)===R,fromHexString(R,T,L=1){const P=INT.fromHexString(R);T.r=(P>>16&255)/255*L,T.g=(P>>8&255)/255*L,T.b=(P&255)/255*L},toHexString({r:R,g:T,b:L},P=1){P=255/P;const I=R*P<<16^T*P<<8^L*P<<0;return INT.toHexString(I)}},FORMATS$1=[STRING,INT,ARRAY,OBJECT];function getColorFormat(R){return FORMATS$1.find(T=>T.match(R))}class ColorController extends Controller{constructor(T,L,P,I){super(T,L,P,"color"),this.$input=document.createElement("input"),this.$input.setAttribute("type","color"),this.$input.setAttribute("tabindex",-1),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$text=document.createElement("input"),this.$text.setAttribute("type","text"),this.$text.setAttribute("spellcheck","false"),this.$text.setAttribute("aria-labelledby",this.$name.id),this.$display=document.createElement("div"),this.$display.classList.add("display"),this.$display.appendChild(this.$input),this.$widget.appendChild(this.$display),this.$widget.appendChild(this.$text),this._format=getColorFormat(this.initialValue),this._rgbScale=I,this._initialValueHexString=this.save(),this._textFocused=!1,this.$input.addEventListener("input",()=>{this._setValueFromHexString(this.$input.value)}),this.$input.addEventListener("blur",()=>{this._callOnFinishChange()}),this.$text.addEventListener("input",()=>{const F=normalizeColorString(this.$text.value);F&&this._setValueFromHexString(F)}),this.$text.addEventListener("focus",()=>{this._textFocused=!0,this.$text.select()}),this.$text.addEventListener("blur",()=>{this._textFocused=!1,this.updateDisplay(),this._callOnFinishChange()}),this.$disable=this.$text,this.updateDisplay()}reset(){return this._setValueFromHexString(this._initialValueHexString),this}_setValueFromHexString(T){if(this._format.isPrimitive){const L=this._format.fromHexString(T);this.setValue(L)}else this._format.fromHexString(T,this.getValue(),this._rgbScale),this._callOnChange(),this.updateDisplay()}save(){return this._format.toHexString(this.getValue(),this._rgbScale)}load(T){return this._setValueFromHexString(T),this._callOnFinishChange(),this}updateDisplay(){return this.$input.value=this._format.toHexString(this.getValue(),this._rgbScale),this._textFocused||(this.$text.value=this.$input.value.substring(1)),this.$display.style.backgroundColor=this.$input.value,this}}class FunctionController extends Controller{constructor(T,L,P){super(T,L,P,"function"),this.$button=document.createElement("button"),this.$button.appendChild(this.$name),this.$widget.appendChild(this.$button),this.$button.addEventListener("click",I=>{I.preventDefault(),this.getValue().call(this.object),this._callOnChange()}),this.$button.addEventListener("touchstart",()=>{},{passive:!0}),this.$disable=this.$button}}class NumberController extends Controller{constructor(T,L,P,I,F,D){super(T,L,P,"number"),this._initInput(),this.min(I),this.max(F);const V=D!==void 0;this.step(V?D:this._getImplicitStep(),V),this.updateDisplay()}decimals(T){return this._decimals=T,this.updateDisplay(),this}min(T){return this._min=T,this._onUpdateMinMax(),this}max(T){return this._max=T,this._onUpdateMinMax(),this}step(T,L=!0){return this._step=T,this._stepExplicit=L,this}updateDisplay(){const T=this.getValue();if(this._hasSlider){let L=(T-this._min)/(this._max-this._min);L=Math.max(0,Math.min(L,1)),this.$fill.style.width=L*100+"%"}return this._inputFocused||(this.$input.value=this._decimals===void 0?T:T.toFixed(this._decimals)),this}_initInput(){this.$input=document.createElement("input"),this.$input.setAttribute("type","text"),this.$input.setAttribute("aria-labelledby",this.$name.id),window.matchMedia("(pointer: coarse)").matches&&(this.$input.setAttribute("type","number"),this.$input.setAttribute("step","any")),this.$widget.appendChild(this.$input),this.$disable=this.$input;const L=()=>{let kt=parseFloat(this.$input.value);isNaN(kt)||(this._stepExplicit&&(kt=this._snap(kt)),this.setValue(this._clamp(kt)))},P=kt=>{const ne=parseFloat(this.$input.value);isNaN(ne)||(this._snapClampSetValue(ne+kt),this.$input.value=this.getValue())},I=kt=>{kt.key==="Enter"&&this.$input.blur(),kt.code==="ArrowUp"&&(kt.preventDefault(),P(this._step*this._arrowKeyMultiplier(kt))),kt.code==="ArrowDown"&&(kt.preventDefault(),P(this._step*this._arrowKeyMultiplier(kt)*-1))},F=kt=>{this._inputFocused&&(kt.preventDefault(),P(this._step*this._normalizeMouseWheel(kt)))};let D=!1,V,q,G,z,Q;const J=5,tt=kt=>{V=kt.clientX,q=G=kt.clientY,D=!0,z=this.getValue(),Q=0,window.addEventListener("mousemove",yt),window.addEventListener("mouseup",At)},yt=kt=>{if(D){const ne=kt.clientX-V,Se=kt.clientY-q;Math.abs(Se)>J?(kt.preventDefault(),this.$input.blur(),D=!1,this._setDraggingStyle(!0,"vertical")):Math.abs(ne)>J&&At()}if(!D){const ne=kt.clientY-G;Q-=ne*this._step*this._arrowKeyMultiplier(kt),z+Q>this._max?Q=this._max-z:z+Q<this._min&&(Q=this._min-z),this._snapClampSetValue(z+Q)}G=kt.clientY},At=()=>{this._setDraggingStyle(!1,"vertical"),this._callOnFinishChange(),window.removeEventListener("mousemove",yt),window.removeEventListener("mouseup",At)},gt=()=>{this._inputFocused=!0},Et=()=>{this._inputFocused=!1,this.updateDisplay(),this._callOnFinishChange()};this.$input.addEventListener("input",L),this.$input.addEventListener("keydown",I),this.$input.addEventListener("wheel",F,{passive:!1}),this.$input.addEventListener("mousedown",tt),this.$input.addEventListener("focus",gt),this.$input.addEventListener("blur",Et)}_initSlider(){this._hasSlider=!0,this.$slider=document.createElement("div"),this.$slider.classList.add("slider"),this.$fill=document.createElement("div"),this.$fill.classList.add("fill"),this.$slider.appendChild(this.$fill),this.$widget.insertBefore(this.$slider,this.$input),this.domElement.classList.add("hasSlider");const T=(Et,kt,ne,Se,Ht)=>(Et-kt)/(ne-kt)*(Ht-Se)+Se,L=Et=>{const kt=this.$slider.getBoundingClientRect();let ne=T(Et,kt.left,kt.right,this._min,this._max);this._snapClampSetValue(ne)},P=Et=>{this._setDraggingStyle(!0),L(Et.clientX),window.addEventListener("mousemove",I),window.addEventListener("mouseup",F)},I=Et=>{L(Et.clientX)},F=()=>{this._callOnFinishChange(),this._setDraggingStyle(!1),window.removeEventListener("mousemove",I),window.removeEventListener("mouseup",F)};let D=!1,V,q;const G=Et=>{Et.preventDefault(),this._setDraggingStyle(!0),L(Et.touches[0].clientX),D=!1},z=Et=>{Et.touches.length>1||(this._hasScrollBar?(V=Et.touches[0].clientX,q=Et.touches[0].clientY,D=!0):G(Et),window.addEventListener("touchmove",Q,{passive:!1}),window.addEventListener("touchend",J))},Q=Et=>{if(D){const kt=Et.touches[0].clientX-V,ne=Et.touches[0].clientY-q;Math.abs(kt)>Math.abs(ne)?G(Et):(window.removeEventListener("touchmove",Q),window.removeEventListener("touchend",J))}else Et.preventDefault(),L(Et.touches[0].clientX)},J=()=>{this._callOnFinishChange(),this._setDraggingStyle(!1),window.removeEventListener("touchmove",Q),window.removeEventListener("touchend",J)},tt=this._callOnFinishChange.bind(this),yt=400;let At;const gt=Et=>{if(Math.abs(Et.deltaX)<Math.abs(Et.deltaY)&&this._hasScrollBar)return;Et.preventDefault();const ne=this._normalizeMouseWheel(Et)*this._step;this._snapClampSetValue(this.getValue()+ne),this.$input.value=this.getValue(),clearTimeout(At),At=setTimeout(tt,yt)};this.$slider.addEventListener("mousedown",P),this.$slider.addEventListener("touchstart",z,{passive:!1}),this.$slider.addEventListener("wheel",gt,{passive:!1})}_setDraggingStyle(T,L="horizontal"){this.$slider&&this.$slider.classList.toggle("active",T),document.body.classList.toggle("lil-gui-dragging",T),document.body.classList.toggle(`lil-gui-${L}`,T)}_getImplicitStep(){return this._hasMin&&this._hasMax?(this._max-this._min)/1e3:.1}_onUpdateMinMax(){!this._hasSlider&&this._hasMin&&this._hasMax&&(this._stepExplicit||this.step(this._getImplicitStep(),!1),this._initSlider(),this.updateDisplay())}_normalizeMouseWheel(T){let{deltaX:L,deltaY:P}=T;return Math.floor(T.deltaY)!==T.deltaY&&T.wheelDelta&&(L=0,P=-T.wheelDelta/120,P*=this._stepExplicit?1:10),L+-P}_arrowKeyMultiplier(T){let L=this._stepExplicit?1:10;return T.shiftKey?L*=10:T.altKey&&(L/=10),L}_snap(T){let L=0;return this._hasMin?L=this._min:this._hasMax&&(L=this._max),T-=L,T=Math.round(T/this._step)*this._step,T+=L,T=parseFloat(T.toPrecision(15)),T}_clamp(T){return T<this._min&&(T=this._min),T>this._max&&(T=this._max),T}_snapClampSetValue(T){this.setValue(this._clamp(this._snap(T)))}get _hasScrollBar(){const T=this.parent.root.$children;return T.scrollHeight>T.clientHeight}get _hasMin(){return this._min!==void 0}get _hasMax(){return this._max!==void 0}}class OptionController extends Controller{constructor(T,L,P,I){super(T,L,P,"option"),this.$select=document.createElement("select"),this.$select.setAttribute("aria-labelledby",this.$name.id),this.$display=document.createElement("div"),this.$display.classList.add("display"),this.$select.addEventListener("change",()=>{this.setValue(this._values[this.$select.selectedIndex]),this._callOnFinishChange()}),this.$select.addEventListener("focus",()=>{this.$display.classList.add("focus")}),this.$select.addEventListener("blur",()=>{this.$display.classList.remove("focus")}),this.$widget.appendChild(this.$select),this.$widget.appendChild(this.$display),this.$disable=this.$select,this.options(I)}options(T){return this._values=Array.isArray(T)?T:Object.values(T),this._names=Array.isArray(T)?T:Object.keys(T),this.$select.replaceChildren(),this._names.forEach(L=>{const P=document.createElement("option");P.textContent=L,this.$select.appendChild(P)}),this.updateDisplay(),this}updateDisplay(){const T=this.getValue(),L=this._values.indexOf(T);return this.$select.selectedIndex=L,this.$display.textContent=L===-1?T:this._names[L],this}}class StringController extends Controller{constructor(T,L,P){super(T,L,P,"string"),this.$input=document.createElement("input"),this.$input.setAttribute("type","text"),this.$input.setAttribute("spellcheck","false"),this.$input.setAttribute("aria-labelledby",this.$name.id),this.$input.addEventListener("input",()=>{this.setValue(this.$input.value)}),this.$input.addEventListener("keydown",I=>{I.code==="Enter"&&this.$input.blur()}),this.$input.addEventListener("blur",()=>{this._callOnFinishChange()}),this.$widget.appendChild(this.$input),this.$disable=this.$input,this.updateDisplay()}updateDisplay(){return this.$input.value=this.getValue(),this}}var stylesheet=`.lil-gui {
  font-family: var(--font-family);
  font-size: var(--font-size);
  line-height: 1;
  font-weight: normal;
  font-style: normal;
  text-align: left;
  color: var(--text-color);
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  --background-color: #1f1f1f;
  --text-color: #ebebeb;
  --title-background-color: #111111;
  --title-text-color: #ebebeb;
  --widget-color: #424242;
  --hover-color: #4f4f4f;
  --focus-color: #595959;
  --number-color: #2cc9ff;
  --string-color: #a2db3c;
  --font-size: 11px;
  --input-font-size: 11px;
  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  --font-family-mono: Menlo, Monaco, Consolas, "Droid Sans Mono", monospace;
  --padding: 4px;
  --spacing: 4px;
  --widget-height: 20px;
  --title-height: calc(var(--widget-height) + var(--spacing) * 1.25);
  --name-width: 45%;
  --slider-knob-width: 2px;
  --slider-input-width: 27%;
  --color-input-width: 27%;
  --slider-input-min-width: 45px;
  --color-input-min-width: 45px;
  --folder-indent: 7px;
  --widget-padding: 0 0 0 3px;
  --widget-border-radius: 2px;
  --checkbox-size: calc(0.75 * var(--widget-height));
  --scrollbar-width: 5px;
}
.lil-gui, .lil-gui * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
.lil-gui.root {
  width: var(--width, 245px);
  display: flex;
  flex-direction: column;
  background: var(--background-color);
}
.lil-gui.root > .title {
  background: var(--title-background-color);
  color: var(--title-text-color);
}
.lil-gui.root > .children {
  overflow-x: hidden;
  overflow-y: auto;
}
.lil-gui.root > .children::-webkit-scrollbar {
  width: var(--scrollbar-width);
  height: var(--scrollbar-width);
  background: var(--background-color);
}
.lil-gui.root > .children::-webkit-scrollbar-thumb {
  border-radius: var(--scrollbar-width);
  background: var(--focus-color);
}
@media (pointer: coarse) {
  .lil-gui.allow-touch-styles, .lil-gui.allow-touch-styles .lil-gui {
    --widget-height: 28px;
    --padding: 6px;
    --spacing: 6px;
    --font-size: 13px;
    --input-font-size: 16px;
    --folder-indent: 10px;
    --scrollbar-width: 7px;
    --slider-input-min-width: 50px;
    --color-input-min-width: 65px;
  }
}
.lil-gui.force-touch-styles, .lil-gui.force-touch-styles .lil-gui {
  --widget-height: 28px;
  --padding: 6px;
  --spacing: 6px;
  --font-size: 13px;
  --input-font-size: 16px;
  --folder-indent: 10px;
  --scrollbar-width: 7px;
  --slider-input-min-width: 50px;
  --color-input-min-width: 65px;
}
.lil-gui.autoPlace {
  max-height: 100%;
  position: fixed;
  top: 0;
  right: 15px;
  z-index: 1001;
}

.lil-gui .controller {
  display: flex;
  align-items: center;
  padding: 0 var(--padding);
  margin: var(--spacing) 0;
}
.lil-gui .controller.disabled {
  opacity: 0.5;
}
.lil-gui .controller.disabled, .lil-gui .controller.disabled * {
  pointer-events: none !important;
}
.lil-gui .controller > .name {
  min-width: var(--name-width);
  flex-shrink: 0;
  white-space: pre;
  padding-right: var(--spacing);
  line-height: var(--widget-height);
}
.lil-gui .controller .widget {
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
  min-height: var(--widget-height);
}
.lil-gui .controller.string input {
  color: var(--string-color);
}
.lil-gui .controller.boolean {
  cursor: pointer;
}
.lil-gui .controller.color .display {
  width: 100%;
  height: var(--widget-height);
  border-radius: var(--widget-border-radius);
  position: relative;
}
@media (hover: hover) {
  .lil-gui .controller.color .display:hover:before {
    content: " ";
    display: block;
    position: absolute;
    border-radius: var(--widget-border-radius);
    border: 1px solid #fff9;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
}
.lil-gui .controller.color input[type=color] {
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}
.lil-gui .controller.color input[type=text] {
  margin-left: var(--spacing);
  font-family: var(--font-family-mono);
  min-width: var(--color-input-min-width);
  width: var(--color-input-width);
  flex-shrink: 0;
}
.lil-gui .controller.option select {
  opacity: 0;
  position: absolute;
  width: 100%;
  max-width: 100%;
}
.lil-gui .controller.option .display {
  position: relative;
  pointer-events: none;
  border-radius: var(--widget-border-radius);
  height: var(--widget-height);
  line-height: var(--widget-height);
  max-width: 100%;
  overflow: hidden;
  word-break: break-all;
  padding-left: 0.55em;
  padding-right: 1.75em;
  background: var(--widget-color);
}
@media (hover: hover) {
  .lil-gui .controller.option .display.focus {
    background: var(--focus-color);
  }
}
.lil-gui .controller.option .display.active {
  background: var(--focus-color);
}
.lil-gui .controller.option .display:after {
  font-family: "lil-gui";
  content: "↕";
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  padding-right: 0.375em;
}
.lil-gui .controller.option .widget,
.lil-gui .controller.option select {
  cursor: pointer;
}
@media (hover: hover) {
  .lil-gui .controller.option .widget:hover .display {
    background: var(--hover-color);
  }
}
.lil-gui .controller.number input {
  color: var(--number-color);
}
.lil-gui .controller.number.hasSlider input {
  margin-left: var(--spacing);
  width: var(--slider-input-width);
  min-width: var(--slider-input-min-width);
  flex-shrink: 0;
}
.lil-gui .controller.number .slider {
  width: 100%;
  height: var(--widget-height);
  background: var(--widget-color);
  border-radius: var(--widget-border-radius);
  padding-right: var(--slider-knob-width);
  overflow: hidden;
  cursor: ew-resize;
  touch-action: pan-y;
}
@media (hover: hover) {
  .lil-gui .controller.number .slider:hover {
    background: var(--hover-color);
  }
}
.lil-gui .controller.number .slider.active {
  background: var(--focus-color);
}
.lil-gui .controller.number .slider.active .fill {
  opacity: 0.95;
}
.lil-gui .controller.number .fill {
  height: 100%;
  border-right: var(--slider-knob-width) solid var(--number-color);
  box-sizing: content-box;
}

.lil-gui-dragging .lil-gui {
  --hover-color: var(--widget-color);
}
.lil-gui-dragging * {
  cursor: ew-resize !important;
}

.lil-gui-dragging.lil-gui-vertical * {
  cursor: ns-resize !important;
}

.lil-gui .title {
  height: var(--title-height);
  font-weight: 600;
  padding: 0 var(--padding);
  width: 100%;
  text-align: left;
  background: none;
  text-decoration-skip: objects;
}
.lil-gui .title:before {
  font-family: "lil-gui";
  content: "▾";
  padding-right: 2px;
  display: inline-block;
}
.lil-gui .title:active {
  background: var(--title-background-color);
  opacity: 0.75;
}
@media (hover: hover) {
  body:not(.lil-gui-dragging) .lil-gui .title:hover {
    background: var(--title-background-color);
    opacity: 0.85;
  }
  .lil-gui .title:focus {
    text-decoration: underline var(--focus-color);
  }
}
.lil-gui.root > .title:focus {
  text-decoration: none !important;
}
.lil-gui.closed > .title:before {
  content: "▸";
}
.lil-gui.closed > .children {
  transform: translateY(-7px);
  opacity: 0;
}
.lil-gui.closed:not(.transition) > .children {
  display: none;
}
.lil-gui.transition > .children {
  transition-duration: 300ms;
  transition-property: height, opacity, transform;
  transition-timing-function: cubic-bezier(0.2, 0.6, 0.35, 1);
  overflow: hidden;
  pointer-events: none;
}
.lil-gui .children:empty:before {
  content: "Empty";
  padding: 0 var(--padding);
  margin: var(--spacing) 0;
  display: block;
  height: var(--widget-height);
  font-style: italic;
  line-height: var(--widget-height);
  opacity: 0.5;
}
.lil-gui.root > .children > .lil-gui > .title {
  border: 0 solid var(--widget-color);
  border-width: 1px 0;
  transition: border-color 300ms;
}
.lil-gui.root > .children > .lil-gui.closed > .title {
  border-bottom-color: transparent;
}
.lil-gui + .controller {
  border-top: 1px solid var(--widget-color);
  margin-top: 0;
  padding-top: var(--spacing);
}
.lil-gui .lil-gui .lil-gui > .title {
  border: none;
}
.lil-gui .lil-gui .lil-gui > .children {
  border: none;
  margin-left: var(--folder-indent);
  border-left: 2px solid var(--widget-color);
}
.lil-gui .lil-gui .controller {
  border: none;
}

.lil-gui label, .lil-gui input, .lil-gui button {
  -webkit-tap-highlight-color: transparent;
}
.lil-gui input {
  border: 0;
  outline: none;
  font-family: var(--font-family);
  font-size: var(--input-font-size);
  border-radius: var(--widget-border-radius);
  height: var(--widget-height);
  background: var(--widget-color);
  color: var(--text-color);
  width: 100%;
}
@media (hover: hover) {
  .lil-gui input:hover {
    background: var(--hover-color);
  }
  .lil-gui input:active {
    background: var(--focus-color);
  }
}
.lil-gui input:disabled {
  opacity: 1;
}
.lil-gui input[type=text],
.lil-gui input[type=number] {
  padding: var(--widget-padding);
  -moz-appearance: textfield;
}
.lil-gui input[type=text]:focus,
.lil-gui input[type=number]:focus {
  background: var(--focus-color);
}
.lil-gui input[type=checkbox] {
  appearance: none;
  width: var(--checkbox-size);
  height: var(--checkbox-size);
  border-radius: var(--widget-border-radius);
  text-align: center;
  cursor: pointer;
}
.lil-gui input[type=checkbox]:checked:before {
  font-family: "lil-gui";
  content: "✓";
  font-size: var(--checkbox-size);
  line-height: var(--checkbox-size);
}
@media (hover: hover) {
  .lil-gui input[type=checkbox]:focus {
    box-shadow: inset 0 0 0 1px var(--focus-color);
  }
}
.lil-gui button {
  outline: none;
  cursor: pointer;
  font-family: var(--font-family);
  font-size: var(--font-size);
  color: var(--text-color);
  width: 100%;
  border: none;
}
.lil-gui .controller button {
  height: var(--widget-height);
  text-transform: none;
  background: var(--widget-color);
  border-radius: var(--widget-border-radius);
}
@media (hover: hover) {
  .lil-gui .controller button:hover {
    background: var(--hover-color);
  }
  .lil-gui .controller button:focus {
    box-shadow: inset 0 0 0 1px var(--focus-color);
  }
}
.lil-gui .controller button:active {
  background: var(--focus-color);
}

@font-face {
  font-family: "lil-gui";
  src: url("data:application/font-woff;charset=utf-8;base64,d09GRgABAAAAAAUsAAsAAAAACJwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAAH4AAADAImwmYE9TLzIAAAGIAAAAPwAAAGBKqH5SY21hcAAAAcgAAAD0AAACrukyyJBnbHlmAAACvAAAAF8AAACEIZpWH2hlYWQAAAMcAAAAJwAAADZfcj2zaGhlYQAAA0QAAAAYAAAAJAC5AHhobXR4AAADXAAAABAAAABMAZAAAGxvY2EAAANsAAAAFAAAACgCEgIybWF4cAAAA4AAAAAeAAAAIAEfABJuYW1lAAADoAAAASIAAAIK9SUU/XBvc3QAAATEAAAAZgAAAJCTcMc2eJxVjbEOgjAURU+hFRBK1dGRL+ALnAiToyMLEzFpnPz/eAshwSa97517c/MwwJmeB9kwPl+0cf5+uGPZXsqPu4nvZabcSZldZ6kfyWnomFY/eScKqZNWupKJO6kXN3K9uCVoL7iInPr1X5baXs3tjuMqCtzEuagm/AAlzQgPAAB4nGNgYRBlnMDAysDAYM/gBiT5oLQBAwuDJAMDEwMrMwNWEJDmmsJwgCFeXZghBcjlZMgFCzOiKOIFAB71Bb8AeJy1kjFuwkAQRZ+DwRAwBtNQRUGKQ8OdKCAWUhAgKLhIuAsVSpWz5Bbkj3dEgYiUIszqWdpZe+Z7/wB1oCYmIoboiwiLT2WjKl/jscrHfGg/pKdMkyklC5Zs2LEfHYpjcRoPzme9MWWmk3dWbK9ObkWkikOetJ554fWyoEsmdSlt+uR0pCJR34b6t/TVg1SY3sYvdf8vuiKrpyaDXDISiegp17p7579Gp3p++y7HPAiY9pmTibljrr85qSidtlg4+l25GLCaS8e6rRxNBmsnERunKbaOObRz7N72ju5vdAjYpBXHgJylOAVsMseDAPEP8LYoUHicY2BiAAEfhiAGJgZWBgZ7RnFRdnVJELCQlBSRlATJMoLV2DK4glSYs6ubq5vbKrJLSbGrgEmovDuDJVhe3VzcXFwNLCOILB/C4IuQ1xTn5FPilBTj5FPmBAB4WwoqAHicY2BkYGAA4sk1sR/j+W2+MnAzpDBgAyEMQUCSg4EJxAEAwUgFHgB4nGNgZGBgSGFggJMhDIwMqEAYAByHATJ4nGNgAIIUNEwmAABl3AGReJxjYAACIQYlBiMGJ3wQAEcQBEV4nGNgZGBgEGZgY2BiAAEQyQWEDAz/wXwGAAsPATIAAHicXdBNSsNAHAXwl35iA0UQXYnMShfS9GPZA7T7LgIu03SSpkwzYTIt1BN4Ak/gKTyAeCxfw39jZkjymzcvAwmAW/wgwHUEGDb36+jQQ3GXGot79L24jxCP4gHzF/EIr4jEIe7wxhOC3g2TMYy4Q7+Lu/SHuEd/ivt4wJd4wPxbPEKMX3GI5+DJFGaSn4qNzk8mcbKSR6xdXdhSzaOZJGtdapd4vVPbi6rP+cL7TGXOHtXKll4bY1Xl7EGnPtp7Xy2n00zyKLVHfkHBa4IcJ2oD3cgggWvt/V/FbDrUlEUJhTn/0azVWbNTNr0Ens8de1tceK9xZmfB1CPjOmPH4kitmvOubcNpmVTN3oFJyjzCvnmrwhJTzqzVj9jiSX911FjeAAB4nG3HMRKCMBBA0f0giiKi4DU8k0V2GWbIZDOh4PoWWvq6J5V8If9NVNQcaDhyouXMhY4rPTcG7jwYmXhKq8Wz+p762aNaeYXom2n3m2dLTVgsrCgFJ7OTmIkYbwIbC6vIB7WmFfAAAA==") format("woff");
}`;function _injectStyles(R){const T=document.createElement("style");T.innerHTML=R;const L=document.querySelector("head link[rel=stylesheet], head style");L?document.head.insertBefore(T,L):document.head.appendChild(T)}let stylesInjected=!1;class GUI{constructor({parent:T,autoPlace:L=T===void 0,container:P,width:I,title:F="Controls",closeFolders:D=!1,injectStyles:V=!0,touchStyles:q=!0}={}){if(this.parent=T,this.root=T?T.root:this,this.children=[],this.controllers=[],this.folders=[],this._closed=!1,this._hidden=!1,this.domElement=document.createElement("div"),this.domElement.classList.add("lil-gui"),this.$title=document.createElement("button"),this.$title.classList.add("title"),this.$title.setAttribute("aria-expanded",!0),this.$title.addEventListener("click",()=>this.openAnimated(this._closed)),this.$title.addEventListener("touchstart",()=>{},{passive:!0}),this.$children=document.createElement("div"),this.$children.classList.add("children"),this.domElement.appendChild(this.$title),this.domElement.appendChild(this.$children),this.title(F),this.parent){this.parent.children.push(this),this.parent.folders.push(this),this.parent.$children.appendChild(this.domElement);return}this.domElement.classList.add("root"),q&&this.domElement.classList.add("allow-touch-styles"),!stylesInjected&&V&&(_injectStyles(stylesheet),stylesInjected=!0),P?P.appendChild(this.domElement):L&&(this.domElement.classList.add("autoPlace"),document.body.appendChild(this.domElement)),I&&this.domElement.style.setProperty("--width",I+"px"),this._closeFolders=D}add(T,L,P,I,F){if(Object(P)===P)return new OptionController(this,T,L,P);const D=T[L];switch(typeof D){case"number":return new NumberController(this,T,L,P,I,F);case"boolean":return new BooleanController(this,T,L);case"string":return new StringController(this,T,L);case"function":return new FunctionController(this,T,L)}console.error(`gui.add failed
	property:`,L,`
	object:`,T,`
	value:`,D)}addColor(T,L,P=1){return new ColorController(this,T,L,P)}addFolder(T){const L=new GUI({parent:this,title:T});return this.root._closeFolders&&L.close(),L}load(T,L=!0){return T.controllers&&this.controllers.forEach(P=>{P instanceof FunctionController||P._name in T.controllers&&P.load(T.controllers[P._name])}),L&&T.folders&&this.folders.forEach(P=>{P._title in T.folders&&P.load(T.folders[P._title])}),this}save(T=!0){const L={controllers:{},folders:{}};return this.controllers.forEach(P=>{if(!(P instanceof FunctionController)){if(P._name in L.controllers)throw new Error(`Cannot save GUI with duplicate property "${P._name}"`);L.controllers[P._name]=P.save()}}),T&&this.folders.forEach(P=>{if(P._title in L.folders)throw new Error(`Cannot save GUI with duplicate folder "${P._title}"`);L.folders[P._title]=P.save()}),L}open(T=!0){return this._setClosed(!T),this.$title.setAttribute("aria-expanded",!this._closed),this.domElement.classList.toggle("closed",this._closed),this}close(){return this.open(!1)}_setClosed(T){this._closed!==T&&(this._closed=T,this._callOnOpenClose(this))}show(T=!0){return this._hidden=!T,this.domElement.style.display=this._hidden?"none":"",this}hide(){return this.show(!1)}openAnimated(T=!0){return this._setClosed(!T),this.$title.setAttribute("aria-expanded",!this._closed),requestAnimationFrame(()=>{const L=this.$children.clientHeight;this.$children.style.height=L+"px",this.domElement.classList.add("transition");const P=F=>{F.target===this.$children&&(this.$children.style.height="",this.domElement.classList.remove("transition"),this.$children.removeEventListener("transitionend",P))};this.$children.addEventListener("transitionend",P);const I=T?this.$children.scrollHeight:0;this.domElement.classList.toggle("closed",!T),requestAnimationFrame(()=>{this.$children.style.height=I+"px"})}),this}title(T){return this._title=T,this.$title.textContent=T,this}reset(T=!0){return(T?this.controllersRecursive():this.controllers).forEach(P=>P.reset()),this}onChange(T){return this._onChange=T,this}_callOnChange(T){this.parent&&this.parent._callOnChange(T),this._onChange!==void 0&&this._onChange.call(this,{object:T.object,property:T.property,value:T.getValue(),controller:T})}onFinishChange(T){return this._onFinishChange=T,this}_callOnFinishChange(T){this.parent&&this.parent._callOnFinishChange(T),this._onFinishChange!==void 0&&this._onFinishChange.call(this,{object:T.object,property:T.property,value:T.getValue(),controller:T})}onOpenClose(T){return this._onOpenClose=T,this}_callOnOpenClose(T){this.parent&&this.parent._callOnOpenClose(T),this._onOpenClose!==void 0&&this._onOpenClose.call(this,T)}destroy(){this.parent&&(this.parent.children.splice(this.parent.children.indexOf(this),1),this.parent.folders.splice(this.parent.folders.indexOf(this),1)),this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement),Array.from(this.children).forEach(T=>T.destroy())}controllersRecursive(){let T=Array.from(this.controllers);return this.folders.forEach(L=>{T=T.concat(L.controllersRecursive())}),T}foldersRecursive(){let T=Array.from(this.folders);return this.folders.forEach(L=>{T=T.concat(L.foldersRecursive())}),T}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(R){return R&&R.__esModule&&Object.prototype.hasOwnProperty.call(R,"default")?R.default:R}function getAugmentedNamespace(R){if(Object.prototype.hasOwnProperty.call(R,"__esModule"))return R;var T=R.default;if(typeof T=="function"){var L=function P(){var I=!1;try{I=this instanceof P}catch{}return I?Reflect.construct(T,arguments,this.constructor):T.apply(this,arguments)};L.prototype=T.prototype}else L={};return Object.defineProperty(L,"__esModule",{value:!0}),Object.keys(R).forEach(function(P){var I=Object.getOwnPropertyDescriptor(R,P);Object.defineProperty(L,P,I.get?I:{enumerable:!0,get:function(){return R[P]}})}),L}var stats_min$1={exports:{}},stats_min=stats_min$1.exports,hasRequiredStats_min;function requireStats_min(){return hasRequiredStats_min||(hasRequiredStats_min=1,(function(R,T){(function(L,P){R.exports=P()})(stats_min,function(){var L=function(){function P(tt){return D.appendChild(tt.dom),tt}function I(tt){for(var yt=0;yt<D.children.length;yt++)D.children[yt].style.display=yt===tt?"block":"none";F=tt}var F=0,D=document.createElement("div");D.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",D.addEventListener("click",function(tt){tt.preventDefault(),I(++F%D.children.length)},!1);var V=(performance||Date).now(),q=V,G=0,z=P(new L.Panel("FPS","#0ff","#002")),Q=P(new L.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var J=P(new L.Panel("MB","#f08","#201"));return I(0),{REVISION:16,dom:D,addPanel:P,showPanel:I,begin:function(){V=(performance||Date).now()},end:function(){G++;var tt=(performance||Date).now();if(Q.update(tt-V,200),tt>q+1e3&&(z.update(1e3*G/(tt-q),100),q=tt,G=0,J)){var yt=performance.memory;J.update(yt.usedJSHeapSize/1048576,yt.jsHeapSizeLimit/1048576)}return tt},update:function(){V=this.end()},domElement:D,setMode:I}};return L.Panel=function(P,I,F){var D=1/0,V=0,q=Math.round,G=q(window.devicePixelRatio||1),z=80*G,Q=48*G,J=3*G,tt=2*G,yt=3*G,At=15*G,gt=74*G,Et=30*G,kt=document.createElement("canvas");kt.width=z,kt.height=Q,kt.style.cssText="width:80px;height:48px";var ne=kt.getContext("2d");return ne.font="bold "+9*G+"px Helvetica,Arial,sans-serif",ne.textBaseline="top",ne.fillStyle=F,ne.fillRect(0,0,z,Q),ne.fillStyle=I,ne.fillText(P,J,tt),ne.fillRect(yt,At,gt,Et),ne.fillStyle=F,ne.globalAlpha=.9,ne.fillRect(yt,At,gt,Et),{dom:kt,update:function(Se,Ht){D=Math.min(D,Se),V=Math.max(V,Se),ne.fillStyle=F,ne.globalAlpha=1,ne.fillRect(0,0,z,At),ne.fillStyle=I,ne.fillText(q(Se)+" "+P+" ("+q(D)+"-"+q(V)+")",J,tt),ne.drawImage(kt,yt+G,At,gt-G,Et,yt,At,gt-G,Et),ne.fillRect(yt+gt-G,At,G,Et),ne.fillStyle=F,ne.globalAlpha=.9,ne.fillRect(yt+gt-G,At,G,q((1-Se/Ht)*Et))}}},L})})(stats_min$1)),stats_min$1.exports}var stats_minExports=requireStats_min();const Stats=getDefaultExportFromCjs(stats_minExports);var t$2=function(R,T){return R<T?-1:R>T?1:0},r$1=function(R){return R.reduce(function(T,L){return T+L},0)},n$2=(function(){function R(L){this.colors=L}var T=R.prototype;return T.palette=function(){return this.colors},T.map=function(L){return L},R})(),o$1=(function(){function R(F,D,V){return(F<<10)+(D<<5)+V}function T(F){var D=[],V=!1;function q(){D.sort(F),V=!0}return{push:function(G){D.push(G),V=!1},peek:function(G){return V||q(),G===void 0&&(G=D.length-1),D[G]},pop:function(){return V||q(),D.pop()},size:function(){return D.length},map:function(G){return D.map(G)},debug:function(){return V||q(),D}}}function L(F,D,V,q,G,z,Q){var J=this;J.r1=F,J.r2=D,J.g1=V,J.g2=q,J.b1=G,J.b2=z,J.histo=Q}function P(){this.vboxes=new T(function(F,D){return t$2(F.vbox.count()*F.vbox.volume(),D.vbox.count()*D.vbox.volume())})}function I(F,D){if(D.count()){var V=D.r2-D.r1+1,q=D.g2-D.g1+1,G=Math.max.apply(null,[V,q,D.b2-D.b1+1]);if(D.count()==1)return[D.copy()];var z,Q,J,tt,yt=0,At=[],gt=[];if(G==V)for(z=D.r1;z<=D.r2;z++){for(tt=0,Q=D.g1;Q<=D.g2;Q++)for(J=D.b1;J<=D.b2;J++)tt+=F[R(z,Q,J)]||0;At[z]=yt+=tt}else if(G==q)for(z=D.g1;z<=D.g2;z++){for(tt=0,Q=D.r1;Q<=D.r2;Q++)for(J=D.b1;J<=D.b2;J++)tt+=F[R(Q,z,J)]||0;At[z]=yt+=tt}else for(z=D.b1;z<=D.b2;z++){for(tt=0,Q=D.r1;Q<=D.r2;Q++)for(J=D.g1;J<=D.g2;J++)tt+=F[R(Q,J,z)]||0;At[z]=yt+=tt}return At.forEach(function(Et,kt){gt[kt]=yt-Et}),(function(Et){var kt,ne,Se,Ht,Le,ee=Et+"1",si=Et+"2",ci=0;for(z=D[ee];z<=D[si];z++)if(At[z]>yt/2){for(Se=D.copy(),Ht=D.copy(),Le=(kt=z-D[ee])<=(ne=D[si]-z)?Math.min(D[si]-1,~~(z+ne/2)):Math.max(D[ee],~~(z-1-kt/2));!At[Le];)Le++;for(ci=gt[Le];!ci&&At[Le-1];)ci=gt[--Le];return Se[si]=Le,Ht[ee]=Se[si]+1,[Se,Ht]}})(G==V?"r":G==q?"g":"b")}}return L.prototype={volume:function(F){var D=this;return D._volume&&!F||(D._volume=(D.r2-D.r1+1)*(D.g2-D.g1+1)*(D.b2-D.b1+1)),D._volume},count:function(F){var D=this,V=D.histo;if(!D._count_set||F){var q,G,z,Q=0;for(q=D.r1;q<=D.r2;q++)for(G=D.g1;G<=D.g2;G++)for(z=D.b1;z<=D.b2;z++)Q+=V[R(q,G,z)]||0;D._count=Q,D._count_set=!0}return D._count},copy:function(){var F=this;return new L(F.r1,F.r2,F.g1,F.g2,F.b1,F.b2,F.histo)},avg:function(F){var D=this,V=D.histo;if(!D._avg||F){var q,G,z,Q,J=0,tt=0,yt=0,At=0;if(D.r1===D.r2&&D.g1===D.g2&&D.b1===D.b2)D._avg=[D.r1<<3,D.g1<<3,D.b1<<3];else{for(G=D.r1;G<=D.r2;G++)for(z=D.g1;z<=D.g2;z++)for(Q=D.b1;Q<=D.b2;Q++)J+=q=V[R(G,z,Q)]||0,tt+=q*(G+.5)*8,yt+=q*(z+.5)*8,At+=q*(Q+.5)*8;D._avg=J?[~~(tt/J),~~(yt/J),~~(At/J)]:[~~(8*(D.r1+D.r2+1)/2),~~(8*(D.g1+D.g2+1)/2),~~(8*(D.b1+D.b2+1)/2)]}}return D._avg},contains:function(F){var D=this,V=F[0]>>3;return gval=F[1]>>3,bval=F[2]>>3,V>=D.r1&&V<=D.r2&&gval>=D.g1&&gval<=D.g2&&bval>=D.b1&&bval<=D.b2}},P.prototype={push:function(F){this.vboxes.push({vbox:F,color:F.avg()})},palette:function(){return this.vboxes.map(function(F){return F.color})},size:function(){return this.vboxes.size()},map:function(F){for(var D=this.vboxes,V=0;V<D.size();V++)if(D.peek(V).vbox.contains(F))return D.peek(V).color;return this.nearest(F)},nearest:function(F){for(var D,V,q,G=this.vboxes,z=0;z<G.size();z++)((V=Math.sqrt(Math.pow(F[0]-G.peek(z).color[0],2)+Math.pow(F[1]-G.peek(z).color[1],2)+Math.pow(F[2]-G.peek(z).color[2],2)))<D||D===void 0)&&(D=V,q=G.peek(z).color);return q},forcebw:function(){var F=this.vboxes;F.sort(function(G,z){return t$2(r$1(G.color),r$1(z.color))});var D=F[0].color;D[0]<5&&D[1]<5&&D[2]<5&&(F[0].color=[0,0,0]);var V=F.length-1,q=F[V].color;q[0]>251&&q[1]>251&&q[2]>251&&(F[V].color=[255,255,255])}},{quantize:function(F,D){if(!Number.isInteger(D)||D<1||D>256)throw new Error("Invalid maximum color count. It must be an integer between 1 and 256.");if(!F.length||D<2||D>256||!F.length||D<2||D>256)return!1;for(var V=[],q=new Set,G=0;G<F.length;G++){var z=F[G],Q=z.join(",");q.has(Q)||(q.add(Q),V.push(z))}if(V.length<=D)return new n$2(V);var J=(function(kt){var ne,Se=new Array(32768);return kt.forEach(function(Ht){ne=R(Ht[0]>>3,Ht[1]>>3,Ht[2]>>3),Se[ne]=(Se[ne]||0)+1}),Se})(F);J.forEach(function(){});var tt=(function(kt,ne){var Se,Ht,Le,ee=1e6,si=0,ci=1e6,di=0,ui=1e6,ei=0;return kt.forEach(function(bi){(Se=bi[0]>>3)<ee?ee=Se:Se>si&&(si=Se),(Ht=bi[1]>>3)<ci?ci=Ht:Ht>di&&(di=Ht),(Le=bi[2]>>3)<ui?ui=Le:Le>ei&&(ei=Le)}),new L(ee,si,ci,di,ui,ei,ne)})(F,J),yt=new T(function(kt,ne){return t$2(kt.count(),ne.count())});function At(kt,ne){for(var Se,Ht=kt.size(),Le=0;Le<1e3;){if(Ht>=ne||Le++>1e3)return;if((Se=kt.pop()).count()){var ee=I(J,Se),si=ee[0],ci=ee[1];if(!si)return;kt.push(si),ci&&(kt.push(ci),Ht++)}else kt.push(Se),Le++}}yt.push(tt),At(yt,.75*D);for(var gt=new T(function(kt,ne){return t$2(kt.count()*kt.volume(),ne.count()*ne.volume())});yt.size();)gt.push(yt.pop());At(gt,D);for(var Et=new P;gt.size();)Et.push(gt.pop());return Et}}})().quantize,e$1=function(R){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.width=this.canvas.width=R.naturalWidth,this.height=this.canvas.height=R.naturalHeight,this.context.drawImage(R,0,0,this.width,this.height)};e$1.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)};var u$2=function(){};u$2.prototype.getColor=function(R,T){return T===void 0&&(T=10),this.getPalette(R,5,T)[0]},u$2.prototype.getPalette=function(R,T,L){var P=(function(V){var q=V.colorCount,G=V.quality;if(q!==void 0&&Number.isInteger(q)){if(q===1)throw new Error("colorCount should be between 2 and 20. To get one color, call getColor() instead of getPalette()");q=Math.max(q,2),q=Math.min(q,20)}else q=10;return(G===void 0||!Number.isInteger(G)||G<1)&&(G=10),{colorCount:q,quality:G}})({colorCount:T,quality:L}),I=new e$1(R),F=(function(V,q,G){for(var z,Q,J,tt,yt,At=V,gt=[],Et=0;Et<q;Et+=G)Q=At[0+(z=4*Et)],J=At[z+1],tt=At[z+2],((yt=At[z+3])===void 0||yt>=125)&&(Q>250&&J>250&&tt>250||gt.push([Q,J,tt]));return gt})(I.getImageData().data,I.width*I.height,P.quality),D=o$1(F,P.colorCount);return D?D.palette():null},u$2.prototype.getColorFromUrl=function(R,T,L){var P=this,I=document.createElement("img");I.addEventListener("load",function(){var F=P.getPalette(I,5,L);T(F[0],R)}),I.src=R},u$2.prototype.getImageData=function(R,T){var L=new XMLHttpRequest;L.open("GET",R,!0),L.responseType="arraybuffer",L.onload=function(){if(this.status==200){var P=new Uint8Array(this.response);i=P.length;for(var I=new Array(i),F=0;F<P.length;F++)I[F]=String.fromCharCode(P[F]);var D=I.join(""),V=window.btoa(D);T("data:image/png;base64,"+V)}},L.send()},u$2.prototype.getColorAsync=function(R,T,L){var P=this;this.getImageData(R,function(I){var F=document.createElement("img");F.addEventListener("load",function(){var D=P.getPalette(F,5,L);T(D[0],this)}),F.src=I})};var ENV=(R=>(R[R.WEBGL_LEGACY=0]="WEBGL_LEGACY",R[R.WEBGL=1]="WEBGL",R[R.WEBGL2=2]="WEBGL2",R))(ENV||{}),RENDERER_TYPE=(R=>(R[R.UNKNOWN=0]="UNKNOWN",R[R.WEBGL=1]="WEBGL",R[R.CANVAS=2]="CANVAS",R))(RENDERER_TYPE||{}),BUFFER_BITS=(R=>(R[R.COLOR=16384]="COLOR",R[R.DEPTH=256]="DEPTH",R[R.STENCIL=1024]="STENCIL",R))(BUFFER_BITS||{}),BLEND_MODES=(R=>(R[R.NORMAL=0]="NORMAL",R[R.ADD=1]="ADD",R[R.MULTIPLY=2]="MULTIPLY",R[R.SCREEN=3]="SCREEN",R[R.OVERLAY=4]="OVERLAY",R[R.DARKEN=5]="DARKEN",R[R.LIGHTEN=6]="LIGHTEN",R[R.COLOR_DODGE=7]="COLOR_DODGE",R[R.COLOR_BURN=8]="COLOR_BURN",R[R.HARD_LIGHT=9]="HARD_LIGHT",R[R.SOFT_LIGHT=10]="SOFT_LIGHT",R[R.DIFFERENCE=11]="DIFFERENCE",R[R.EXCLUSION=12]="EXCLUSION",R[R.HUE=13]="HUE",R[R.SATURATION=14]="SATURATION",R[R.COLOR=15]="COLOR",R[R.LUMINOSITY=16]="LUMINOSITY",R[R.NORMAL_NPM=17]="NORMAL_NPM",R[R.ADD_NPM=18]="ADD_NPM",R[R.SCREEN_NPM=19]="SCREEN_NPM",R[R.NONE=20]="NONE",R[R.SRC_OVER=0]="SRC_OVER",R[R.SRC_IN=21]="SRC_IN",R[R.SRC_OUT=22]="SRC_OUT",R[R.SRC_ATOP=23]="SRC_ATOP",R[R.DST_OVER=24]="DST_OVER",R[R.DST_IN=25]="DST_IN",R[R.DST_OUT=26]="DST_OUT",R[R.DST_ATOP=27]="DST_ATOP",R[R.ERASE=26]="ERASE",R[R.SUBTRACT=28]="SUBTRACT",R[R.XOR=29]="XOR",R))(BLEND_MODES||{}),DRAW_MODES=(R=>(R[R.POINTS=0]="POINTS",R[R.LINES=1]="LINES",R[R.LINE_LOOP=2]="LINE_LOOP",R[R.LINE_STRIP=3]="LINE_STRIP",R[R.TRIANGLES=4]="TRIANGLES",R[R.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",R[R.TRIANGLE_FAN=6]="TRIANGLE_FAN",R))(DRAW_MODES||{}),FORMATS=(R=>(R[R.RGBA=6408]="RGBA",R[R.RGB=6407]="RGB",R[R.RG=33319]="RG",R[R.RED=6403]="RED",R[R.RGBA_INTEGER=36249]="RGBA_INTEGER",R[R.RGB_INTEGER=36248]="RGB_INTEGER",R[R.RG_INTEGER=33320]="RG_INTEGER",R[R.RED_INTEGER=36244]="RED_INTEGER",R[R.ALPHA=6406]="ALPHA",R[R.LUMINANCE=6409]="LUMINANCE",R[R.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",R[R.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",R[R.DEPTH_STENCIL=34041]="DEPTH_STENCIL",R))(FORMATS||{}),TARGETS=(R=>(R[R.TEXTURE_2D=3553]="TEXTURE_2D",R[R.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",R[R.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",R[R.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",R[R.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",R[R.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",R[R.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",R[R.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",R[R.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",R))(TARGETS||{}),TYPES=(R=>(R[R.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",R[R.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",R[R.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",R[R.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",R[R.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",R[R.UNSIGNED_INT=5125]="UNSIGNED_INT",R[R.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",R[R.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",R[R.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",R[R.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",R[R.BYTE=5120]="BYTE",R[R.SHORT=5122]="SHORT",R[R.INT=5124]="INT",R[R.FLOAT=5126]="FLOAT",R[R.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",R[R.HALF_FLOAT=36193]="HALF_FLOAT",R))(TYPES||{}),SAMPLER_TYPES=(R=>(R[R.FLOAT=0]="FLOAT",R[R.INT=1]="INT",R[R.UINT=2]="UINT",R))(SAMPLER_TYPES||{}),SCALE_MODES=(R=>(R[R.NEAREST=0]="NEAREST",R[R.LINEAR=1]="LINEAR",R))(SCALE_MODES||{}),WRAP_MODES=(R=>(R[R.CLAMP=33071]="CLAMP",R[R.REPEAT=10497]="REPEAT",R[R.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",R))(WRAP_MODES||{}),MIPMAP_MODES=(R=>(R[R.OFF=0]="OFF",R[R.POW2=1]="POW2",R[R.ON=2]="ON",R[R.ON_MANUAL=3]="ON_MANUAL",R))(MIPMAP_MODES||{}),ALPHA_MODES=(R=>(R[R.NPM=0]="NPM",R[R.UNPACK=1]="UNPACK",R[R.PMA=2]="PMA",R[R.NO_PREMULTIPLIED_ALPHA=0]="NO_PREMULTIPLIED_ALPHA",R[R.PREMULTIPLY_ON_UPLOAD=1]="PREMULTIPLY_ON_UPLOAD",R[R.PREMULTIPLIED_ALPHA=2]="PREMULTIPLIED_ALPHA",R))(ALPHA_MODES||{}),CLEAR_MODES=(R=>(R[R.NO=0]="NO",R[R.YES=1]="YES",R[R.AUTO=2]="AUTO",R[R.BLEND=0]="BLEND",R[R.CLEAR=1]="CLEAR",R[R.BLIT=2]="BLIT",R))(CLEAR_MODES||{}),GC_MODES=(R=>(R[R.AUTO=0]="AUTO",R[R.MANUAL=1]="MANUAL",R))(GC_MODES||{}),PRECISION=(R=>(R.LOW="lowp",R.MEDIUM="mediump",R.HIGH="highp",R))(PRECISION||{}),MASK_TYPES=(R=>(R[R.NONE=0]="NONE",R[R.SCISSOR=1]="SCISSOR",R[R.STENCIL=2]="STENCIL",R[R.SPRITE=3]="SPRITE",R[R.COLOR=4]="COLOR",R))(MASK_TYPES||{}),MSAA_QUALITY=(R=>(R[R.NONE=0]="NONE",R[R.LOW=2]="LOW",R[R.MEDIUM=4]="MEDIUM",R[R.HIGH=8]="HIGH",R))(MSAA_QUALITY||{}),BUFFER_TYPE=(R=>(R[R.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",R[R.ARRAY_BUFFER=34962]="ARRAY_BUFFER",R[R.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",R))(BUFFER_TYPE||{});const BrowserAdapter={createCanvas:(R,T)=>{const L=document.createElement("canvas");return L.width=R,L.height=T,L},getCanvasRenderingContext2D:()=>CanvasRenderingContext2D,getWebGLRenderingContext:()=>WebGLRenderingContext,getNavigator:()=>navigator,getBaseUrl:()=>document.baseURI??window.location.href,getFontFaceSet:()=>document.fonts,fetch:(R,T)=>fetch(R,T),parseXML:R=>new DOMParser().parseFromString(R,"text/xml")},settings={ADAPTER:BrowserAdapter,RESOLUTION:1,CREATE_IMAGE_BITMAP:!1,ROUND_PIXELS:!1};var appleIphone=/iPhone/i,appleIpod=/iPod/i,appleTablet=/iPad/i,appleUniversal=/\biOS-universal(?:.+)Mac\b/i,androidPhone=/\bAndroid(?:.+)Mobile\b/i,androidTablet=/Android/i,amazonPhone=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,amazonTablet=/Silk/i,windowsPhone=/Windows Phone/i,windowsTablet=/\bWindows(?:.+)ARM\b/i,otherBlackBerry=/BlackBerry/i,otherBlackBerry10=/BB10/i,otherOpera=/Opera Mini/i,otherChrome=/\b(CriOS|Chrome)(?:.+)Mobile/i,otherFirefox=/Mobile(?:.+)Firefox\b/i,isAppleTabletOnIos13=function(R){return typeof R<"u"&&R.platform==="MacIntel"&&typeof R.maxTouchPoints=="number"&&R.maxTouchPoints>1&&typeof MSStream>"u"};function createMatch(R){return function(T){return T.test(R)}}function isMobile$1(R){var T={userAgent:"",platform:"",maxTouchPoints:0};!R&&typeof navigator<"u"?T={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0}:typeof R=="string"?T.userAgent=R:R&&R.userAgent&&(T={userAgent:R.userAgent,platform:R.platform,maxTouchPoints:R.maxTouchPoints||0});var L=T.userAgent,P=L.split("[FBAN");typeof P[1]<"u"&&(L=P[0]),P=L.split("Twitter"),typeof P[1]<"u"&&(L=P[0]);var I=createMatch(L),F={apple:{phone:I(appleIphone)&&!I(windowsPhone),ipod:I(appleIpod),tablet:!I(appleIphone)&&(I(appleTablet)||isAppleTabletOnIos13(T))&&!I(windowsPhone),universal:I(appleUniversal),device:(I(appleIphone)||I(appleIpod)||I(appleTablet)||I(appleUniversal)||isAppleTabletOnIos13(T))&&!I(windowsPhone)},amazon:{phone:I(amazonPhone),tablet:!I(amazonPhone)&&I(amazonTablet),device:I(amazonPhone)||I(amazonTablet)},android:{phone:!I(windowsPhone)&&I(amazonPhone)||!I(windowsPhone)&&I(androidPhone),tablet:!I(windowsPhone)&&!I(amazonPhone)&&!I(androidPhone)&&(I(amazonTablet)||I(androidTablet)),device:!I(windowsPhone)&&(I(amazonPhone)||I(amazonTablet)||I(androidPhone)||I(androidTablet))||I(/\bokhttp\b/i)},windows:{phone:I(windowsPhone),tablet:I(windowsTablet),device:I(windowsPhone)||I(windowsTablet)},other:{blackberry:I(otherBlackBerry),blackberry10:I(otherBlackBerry10),opera:I(otherOpera),firefox:I(otherFirefox),chrome:I(otherChrome),device:I(otherBlackBerry)||I(otherBlackBerry10)||I(otherOpera)||I(otherFirefox)||I(otherChrome)},any:!1,phone:!1,tablet:!1};return F.any=F.apple.device||F.android.device||F.windows.device||F.other.device,F.phone=F.apple.phone||F.android.phone||F.windows.phone,F.tablet=F.apple.tablet||F.android.tablet||F.windows.tablet,F}const isMobileCall=isMobile$1.default??isMobile$1,isMobile=isMobileCall(globalThis.navigator);settings.RETINA_PREFIX=/@([0-9\.]+)x/;settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT=!1;var eventemitter3={exports:{}},hasRequiredEventemitter3;function requireEventemitter3(){return hasRequiredEventemitter3||(hasRequiredEventemitter3=1,(function(R){var T=Object.prototype.hasOwnProperty,L="~";function P(){}Object.create&&(P.prototype=Object.create(null),new P().__proto__||(L=!1));function I(q,G,z){this.fn=q,this.context=G,this.once=z||!1}function F(q,G,z,Q,J){if(typeof z!="function")throw new TypeError("The listener must be a function");var tt=new I(z,Q||q,J),yt=L?L+G:G;return q._events[yt]?q._events[yt].fn?q._events[yt]=[q._events[yt],tt]:q._events[yt].push(tt):(q._events[yt]=tt,q._eventsCount++),q}function D(q,G){--q._eventsCount===0?q._events=new P:delete q._events[G]}function V(){this._events=new P,this._eventsCount=0}V.prototype.eventNames=function(){var G=[],z,Q;if(this._eventsCount===0)return G;for(Q in z=this._events)T.call(z,Q)&&G.push(L?Q.slice(1):Q);return Object.getOwnPropertySymbols?G.concat(Object.getOwnPropertySymbols(z)):G},V.prototype.listeners=function(G){var z=L?L+G:G,Q=this._events[z];if(!Q)return[];if(Q.fn)return[Q.fn];for(var J=0,tt=Q.length,yt=new Array(tt);J<tt;J++)yt[J]=Q[J].fn;return yt},V.prototype.listenerCount=function(G){var z=L?L+G:G,Q=this._events[z];return Q?Q.fn?1:Q.length:0},V.prototype.emit=function(G,z,Q,J,tt,yt){var At=L?L+G:G;if(!this._events[At])return!1;var gt=this._events[At],Et=arguments.length,kt,ne;if(gt.fn){switch(gt.once&&this.removeListener(G,gt.fn,void 0,!0),Et){case 1:return gt.fn.call(gt.context),!0;case 2:return gt.fn.call(gt.context,z),!0;case 3:return gt.fn.call(gt.context,z,Q),!0;case 4:return gt.fn.call(gt.context,z,Q,J),!0;case 5:return gt.fn.call(gt.context,z,Q,J,tt),!0;case 6:return gt.fn.call(gt.context,z,Q,J,tt,yt),!0}for(ne=1,kt=new Array(Et-1);ne<Et;ne++)kt[ne-1]=arguments[ne];gt.fn.apply(gt.context,kt)}else{var Se=gt.length,Ht;for(ne=0;ne<Se;ne++)switch(gt[ne].once&&this.removeListener(G,gt[ne].fn,void 0,!0),Et){case 1:gt[ne].fn.call(gt[ne].context);break;case 2:gt[ne].fn.call(gt[ne].context,z);break;case 3:gt[ne].fn.call(gt[ne].context,z,Q);break;case 4:gt[ne].fn.call(gt[ne].context,z,Q,J);break;default:if(!kt)for(Ht=1,kt=new Array(Et-1);Ht<Et;Ht++)kt[Ht-1]=arguments[Ht];gt[ne].fn.apply(gt[ne].context,kt)}}return!0},V.prototype.on=function(G,z,Q){return F(this,G,z,Q,!1)},V.prototype.once=function(G,z,Q){return F(this,G,z,Q,!0)},V.prototype.removeListener=function(G,z,Q,J){var tt=L?L+G:G;if(!this._events[tt])return this;if(!z)return D(this,tt),this;var yt=this._events[tt];if(yt.fn)yt.fn===z&&(!J||yt.once)&&(!Q||yt.context===Q)&&D(this,tt);else{for(var At=0,gt=[],Et=yt.length;At<Et;At++)(yt[At].fn!==z||J&&!yt[At].once||Q&&yt[At].context!==Q)&&gt.push(yt[At]);gt.length?this._events[tt]=gt.length===1?gt[0]:gt:D(this,tt)}return this},V.prototype.removeAllListeners=function(G){var z;return G?(z=L?L+G:G,this._events[z]&&D(this,z)):(this._events=new P,this._eventsCount=0),this},V.prototype.off=V.prototype.removeListener,V.prototype.addListener=V.prototype.on,V.prefixed=L,V.EventEmitter=V,R.exports=V})(eventemitter3)),eventemitter3.exports}var eventemitter3Exports=requireEventemitter3();const EventEmitter=getDefaultExportFromCjs(eventemitter3Exports);var earcut={exports:{}},hasRequiredEarcut;function requireEarcut(){if(hasRequiredEarcut)return earcut.exports;hasRequiredEarcut=1,earcut.exports=R,earcut.exports.default=R;function R(we,Ge,Te){Te=Te||2;var ri=Ge&&Ge.length,ti=ri?Ge[0]*Te:we.length,ii=T(we,0,ti,Te,!0),oi=[];if(!ii||ii.next===ii.prev)return oi;var ai,fi,mi,_i,Si,Ti,Ei;if(ri&&(ii=q(we,Ge,ii,Te)),we.length>80*Te){ai=mi=we[0],fi=_i=we[1];for(var vi=Te;vi<ti;vi+=Te)Si=we[vi],Ti=we[vi+1],Si<ai&&(ai=Si),Ti<fi&&(fi=Ti),Si>mi&&(mi=Si),Ti>_i&&(_i=Ti);Ei=Math.max(mi-ai,_i-fi),Ei=Ei!==0?32767/Ei:0}return P(ii,oi,Te,ai,fi,Ei,0),oi}function T(we,Ge,Te,ri,ti){var ii,oi;if(ti===gi(we,Ge,Te,ri)>0)for(ii=Ge;ii<Te;ii+=ri)oi=ei(ii,we[ii],we[ii+1],oi);else for(ii=Te-ri;ii>=Ge;ii-=ri)oi=ei(ii,we[ii],we[ii+1],oi);return oi&&Se(oi,oi.next)&&(bi(oi),oi=oi.next),oi}function L(we,Ge){if(!we)return we;Ge||(Ge=we);var Te=we,ri;do if(ri=!1,!Te.steiner&&(Se(Te,Te.next)||ne(Te.prev,Te,Te.next)===0)){if(bi(Te),Te=Ge=Te.prev,Te===Te.next)break;ri=!0}else Te=Te.next;while(ri||Te!==Ge);return Ge}function P(we,Ge,Te,ri,ti,ii,oi){if(we){!oi&&ii&&tt(we,ri,ti,ii);for(var ai=we,fi,mi;we.prev!==we.next;){if(fi=we.prev,mi=we.next,ii?F(we,ri,ti,ii):I(we)){Ge.push(fi.i/Te|0),Ge.push(we.i/Te|0),Ge.push(mi.i/Te|0),bi(we),we=mi.next,ai=mi.next;continue}if(we=mi,we===ai){oi?oi===1?(we=D(L(we),Ge,Te),P(we,Ge,Te,ri,ti,ii,2)):oi===2&&V(we,Ge,Te,ri,ti,ii):P(L(we),Ge,Te,ri,ti,ii,1);break}}}}function I(we){var Ge=we.prev,Te=we,ri=we.next;if(ne(Ge,Te,ri)>=0)return!1;for(var ti=Ge.x,ii=Te.x,oi=ri.x,ai=Ge.y,fi=Te.y,mi=ri.y,_i=ti<ii?ti<oi?ti:oi:ii<oi?ii:oi,Si=ai<fi?ai<mi?ai:mi:fi<mi?fi:mi,Ti=ti>ii?ti>oi?ti:oi:ii>oi?ii:oi,Ei=ai>fi?ai>mi?ai:mi:fi>mi?fi:mi,vi=ri.next;vi!==Ge;){if(vi.x>=_i&&vi.x<=Ti&&vi.y>=Si&&vi.y<=Ei&&Et(ti,ai,ii,fi,oi,mi,vi.x,vi.y)&&ne(vi.prev,vi,vi.next)>=0)return!1;vi=vi.next}return!0}function F(we,Ge,Te,ri){var ti=we.prev,ii=we,oi=we.next;if(ne(ti,ii,oi)>=0)return!1;for(var ai=ti.x,fi=ii.x,mi=oi.x,_i=ti.y,Si=ii.y,Ti=oi.y,Ei=ai<fi?ai<mi?ai:mi:fi<mi?fi:mi,vi=_i<Si?_i<Ti?_i:Ti:Si<Ti?Si:Ti,Ai=ai>fi?ai>mi?ai:mi:fi>mi?fi:mi,Li=_i>Si?_i>Ti?_i:Ti:Si>Ti?Si:Ti,Mi=At(Ei,vi,Ge,Te,ri),Pi=At(Ai,Li,Ge,Te,ri),xi=we.prevZ,wi=we.nextZ;xi&&xi.z>=Mi&&wi&&wi.z<=Pi;){if(xi.x>=Ei&&xi.x<=Ai&&xi.y>=vi&&xi.y<=Li&&xi!==ti&&xi!==oi&&Et(ai,_i,fi,Si,mi,Ti,xi.x,xi.y)&&ne(xi.prev,xi,xi.next)>=0||(xi=xi.prevZ,wi.x>=Ei&&wi.x<=Ai&&wi.y>=vi&&wi.y<=Li&&wi!==ti&&wi!==oi&&Et(ai,_i,fi,Si,mi,Ti,wi.x,wi.y)&&ne(wi.prev,wi,wi.next)>=0))return!1;wi=wi.nextZ}for(;xi&&xi.z>=Mi;){if(xi.x>=Ei&&xi.x<=Ai&&xi.y>=vi&&xi.y<=Li&&xi!==ti&&xi!==oi&&Et(ai,_i,fi,Si,mi,Ti,xi.x,xi.y)&&ne(xi.prev,xi,xi.next)>=0)return!1;xi=xi.prevZ}for(;wi&&wi.z<=Pi;){if(wi.x>=Ei&&wi.x<=Ai&&wi.y>=vi&&wi.y<=Li&&wi!==ti&&wi!==oi&&Et(ai,_i,fi,Si,mi,Ti,wi.x,wi.y)&&ne(wi.prev,wi,wi.next)>=0)return!1;wi=wi.nextZ}return!0}function D(we,Ge,Te){var ri=we;do{var ti=ri.prev,ii=ri.next.next;!Se(ti,ii)&&Ht(ti,ri,ri.next,ii)&&ci(ti,ii)&&ci(ii,ti)&&(Ge.push(ti.i/Te|0),Ge.push(ri.i/Te|0),Ge.push(ii.i/Te|0),bi(ri),bi(ri.next),ri=we=ii),ri=ri.next}while(ri!==we);return L(ri)}function V(we,Ge,Te,ri,ti,ii){var oi=we;do{for(var ai=oi.next.next;ai!==oi.prev;){if(oi.i!==ai.i&&kt(oi,ai)){var fi=ui(oi,ai);oi=L(oi,oi.next),fi=L(fi,fi.next),P(oi,Ge,Te,ri,ti,ii,0),P(fi,Ge,Te,ri,ti,ii,0);return}ai=ai.next}oi=oi.next}while(oi!==we)}function q(we,Ge,Te,ri){var ti=[],ii,oi,ai,fi,mi;for(ii=0,oi=Ge.length;ii<oi;ii++)ai=Ge[ii]*ri,fi=ii<oi-1?Ge[ii+1]*ri:we.length,mi=T(we,ai,fi,ri,!1),mi===mi.next&&(mi.steiner=!0),ti.push(gt(mi));for(ti.sort(G),ii=0;ii<ti.length;ii++)Te=z(ti[ii],Te);return Te}function G(we,Ge){return we.x-Ge.x}function z(we,Ge){var Te=Q(we,Ge);if(!Te)return Ge;var ri=ui(Te,we);return L(ri,ri.next),L(Te,Te.next)}function Q(we,Ge){var Te=Ge,ri=we.x,ti=we.y,ii=-1/0,oi;do{if(ti<=Te.y&&ti>=Te.next.y&&Te.next.y!==Te.y){var ai=Te.x+(ti-Te.y)*(Te.next.x-Te.x)/(Te.next.y-Te.y);if(ai<=ri&&ai>ii&&(ii=ai,oi=Te.x<Te.next.x?Te:Te.next,ai===ri))return oi}Te=Te.next}while(Te!==Ge);if(!oi)return null;var fi=oi,mi=oi.x,_i=oi.y,Si=1/0,Ti;Te=oi;do ri>=Te.x&&Te.x>=mi&&ri!==Te.x&&Et(ti<_i?ri:ii,ti,mi,_i,ti<_i?ii:ri,ti,Te.x,Te.y)&&(Ti=Math.abs(ti-Te.y)/(ri-Te.x),ci(Te,we)&&(Ti<Si||Ti===Si&&(Te.x>oi.x||Te.x===oi.x&&J(oi,Te)))&&(oi=Te,Si=Ti)),Te=Te.next;while(Te!==fi);return oi}function J(we,Ge){return ne(we.prev,we,Ge.prev)<0&&ne(Ge.next,we,we.next)<0}function tt(we,Ge,Te,ri){var ti=we;do ti.z===0&&(ti.z=At(ti.x,ti.y,Ge,Te,ri)),ti.prevZ=ti.prev,ti.nextZ=ti.next,ti=ti.next;while(ti!==we);ti.prevZ.nextZ=null,ti.prevZ=null,yt(ti)}function yt(we){var Ge,Te,ri,ti,ii,oi,ai,fi,mi=1;do{for(Te=we,we=null,ii=null,oi=0;Te;){for(oi++,ri=Te,ai=0,Ge=0;Ge<mi&&(ai++,ri=ri.nextZ,!!ri);Ge++);for(fi=mi;ai>0||fi>0&&ri;)ai!==0&&(fi===0||!ri||Te.z<=ri.z)?(ti=Te,Te=Te.nextZ,ai--):(ti=ri,ri=ri.nextZ,fi--),ii?ii.nextZ=ti:we=ti,ti.prevZ=ii,ii=ti;Te=ri}ii.nextZ=null,mi*=2}while(oi>1);return we}function At(we,Ge,Te,ri,ti){return we=(we-Te)*ti|0,Ge=(Ge-ri)*ti|0,we=(we|we<<8)&16711935,we=(we|we<<4)&252645135,we=(we|we<<2)&858993459,we=(we|we<<1)&1431655765,Ge=(Ge|Ge<<8)&16711935,Ge=(Ge|Ge<<4)&252645135,Ge=(Ge|Ge<<2)&858993459,Ge=(Ge|Ge<<1)&1431655765,we|Ge<<1}function gt(we){var Ge=we,Te=we;do(Ge.x<Te.x||Ge.x===Te.x&&Ge.y<Te.y)&&(Te=Ge),Ge=Ge.next;while(Ge!==we);return Te}function Et(we,Ge,Te,ri,ti,ii,oi,ai){return(ti-oi)*(Ge-ai)>=(we-oi)*(ii-ai)&&(we-oi)*(ri-ai)>=(Te-oi)*(Ge-ai)&&(Te-oi)*(ii-ai)>=(ti-oi)*(ri-ai)}function kt(we,Ge){return we.next.i!==Ge.i&&we.prev.i!==Ge.i&&!si(we,Ge)&&(ci(we,Ge)&&ci(Ge,we)&&di(we,Ge)&&(ne(we.prev,we,Ge.prev)||ne(we,Ge.prev,Ge))||Se(we,Ge)&&ne(we.prev,we,we.next)>0&&ne(Ge.prev,Ge,Ge.next)>0)}function ne(we,Ge,Te){return(Ge.y-we.y)*(Te.x-Ge.x)-(Ge.x-we.x)*(Te.y-Ge.y)}function Se(we,Ge){return we.x===Ge.x&&we.y===Ge.y}function Ht(we,Ge,Te,ri){var ti=ee(ne(we,Ge,Te)),ii=ee(ne(we,Ge,ri)),oi=ee(ne(Te,ri,we)),ai=ee(ne(Te,ri,Ge));return!!(ti!==ii&&oi!==ai||ti===0&&Le(we,Te,Ge)||ii===0&&Le(we,ri,Ge)||oi===0&&Le(Te,we,ri)||ai===0&&Le(Te,Ge,ri))}function Le(we,Ge,Te){return Ge.x<=Math.max(we.x,Te.x)&&Ge.x>=Math.min(we.x,Te.x)&&Ge.y<=Math.max(we.y,Te.y)&&Ge.y>=Math.min(we.y,Te.y)}function ee(we){return we>0?1:we<0?-1:0}function si(we,Ge){var Te=we;do{if(Te.i!==we.i&&Te.next.i!==we.i&&Te.i!==Ge.i&&Te.next.i!==Ge.i&&Ht(Te,Te.next,we,Ge))return!0;Te=Te.next}while(Te!==we);return!1}function ci(we,Ge){return ne(we.prev,we,we.next)<0?ne(we,Ge,we.next)>=0&&ne(we,we.prev,Ge)>=0:ne(we,Ge,we.prev)<0||ne(we,we.next,Ge)<0}function di(we,Ge){var Te=we,ri=!1,ti=(we.x+Ge.x)/2,ii=(we.y+Ge.y)/2;do Te.y>ii!=Te.next.y>ii&&Te.next.y!==Te.y&&ti<(Te.next.x-Te.x)*(ii-Te.y)/(Te.next.y-Te.y)+Te.x&&(ri=!ri),Te=Te.next;while(Te!==we);return ri}function ui(we,Ge){var Te=new yi(we.i,we.x,we.y),ri=new yi(Ge.i,Ge.x,Ge.y),ti=we.next,ii=Ge.prev;return we.next=Ge,Ge.prev=we,Te.next=ti,ti.prev=Te,ri.next=Te,Te.prev=ri,ii.next=ri,ri.prev=ii,ri}function ei(we,Ge,Te,ri){var ti=new yi(we,Ge,Te);return ri?(ti.next=ri.next,ti.prev=ri,ri.next.prev=ti,ri.next=ti):(ti.prev=ti,ti.next=ti),ti}function bi(we){we.next.prev=we.prev,we.prev.next=we.next,we.prevZ&&(we.prevZ.nextZ=we.nextZ),we.nextZ&&(we.nextZ.prevZ=we.prevZ)}function yi(we,Ge,Te){this.i=we,this.x=Ge,this.y=Te,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}R.deviation=function(we,Ge,Te,ri){var ti=Ge&&Ge.length,ii=ti?Ge[0]*Te:we.length,oi=Math.abs(gi(we,0,ii,Te));if(ti)for(var ai=0,fi=Ge.length;ai<fi;ai++){var mi=Ge[ai]*Te,_i=ai<fi-1?Ge[ai+1]*Te:we.length;oi-=Math.abs(gi(we,mi,_i,Te))}var Si=0;for(ai=0;ai<ri.length;ai+=3){var Ti=ri[ai]*Te,Ei=ri[ai+1]*Te,vi=ri[ai+2]*Te;Si+=Math.abs((we[Ti]-we[vi])*(we[Ei+1]-we[Ti+1])-(we[Ti]-we[Ei])*(we[vi+1]-we[Ti+1]))}return oi===0&&Si===0?0:Math.abs((Si-oi)/oi)};function gi(we,Ge,Te,ri){for(var ti=0,ii=Ge,oi=Te-ri;ii<Te;ii+=ri)ti+=(we[oi]-we[ii])*(we[ii+1]+we[oi+1]),oi=ii;return ti}return R.flatten=function(we){for(var Ge=we[0][0].length,Te={vertices:[],holes:[],dimensions:Ge},ri=0,ti=0;ti<we.length;ti++){for(var ii=0;ii<we[ti].length;ii++)for(var oi=0;oi<Ge;oi++)Te.vertices.push(we[ti][ii][oi]);ti>0&&(ri+=we[ti-1].length,Te.holes.push(ri))}return Te},earcut.exports}requireEarcut();var url={},punycode$1={exports:{}};/*! https://mths.be/punycode v1.4.1 by @mathias */var punycode=punycode$1.exports,hasRequiredPunycode;function requirePunycode(){return hasRequiredPunycode||(hasRequiredPunycode=1,(function(R,T){(function(L){var P=T&&!T.nodeType&&T,I=R&&!R.nodeType&&R,F=typeof commonjsGlobal=="object"&&commonjsGlobal;(F.global===F||F.window===F||F.self===F)&&(L=F);var D,V=2147483647,q=36,G=1,z=26,Q=38,J=700,tt=72,yt=128,At="-",gt=/^xn--/,Et=/[^\x20-\x7E]/,kt=/[\x2E\u3002\uFF0E\uFF61]/g,ne={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},Se=q-G,Ht=Math.floor,Le=String.fromCharCode,ee;function si(ti){throw new RangeError(ne[ti])}function ci(ti,ii){for(var oi=ti.length,ai=[];oi--;)ai[oi]=ii(ti[oi]);return ai}function di(ti,ii){var oi=ti.split("@"),ai="";oi.length>1&&(ai=oi[0]+"@",ti=oi[1]),ti=ti.replace(kt,".");var fi=ti.split("."),mi=ci(fi,ii).join(".");return ai+mi}function ui(ti){for(var ii=[],oi=0,ai=ti.length,fi,mi;oi<ai;)fi=ti.charCodeAt(oi++),fi>=55296&&fi<=56319&&oi<ai?(mi=ti.charCodeAt(oi++),(mi&64512)==56320?ii.push(((fi&1023)<<10)+(mi&1023)+65536):(ii.push(fi),oi--)):ii.push(fi);return ii}function ei(ti){return ci(ti,function(ii){var oi="";return ii>65535&&(ii-=65536,oi+=Le(ii>>>10&1023|55296),ii=56320|ii&1023),oi+=Le(ii),oi}).join("")}function bi(ti){return ti-48<10?ti-22:ti-65<26?ti-65:ti-97<26?ti-97:q}function yi(ti,ii){return ti+22+75*(ti<26)-((ii!=0)<<5)}function gi(ti,ii,oi){var ai=0;for(ti=oi?Ht(ti/J):ti>>1,ti+=Ht(ti/ii);ti>Se*z>>1;ai+=q)ti=Ht(ti/Se);return Ht(ai+(Se+1)*ti/(ti+Q))}function we(ti){var ii=[],oi=ti.length,ai,fi=0,mi=yt,_i=tt,Si,Ti,Ei,vi,Ai,Li,Mi,Pi,xi;for(Si=ti.lastIndexOf(At),Si<0&&(Si=0),Ti=0;Ti<Si;++Ti)ti.charCodeAt(Ti)>=128&&si("not-basic"),ii.push(ti.charCodeAt(Ti));for(Ei=Si>0?Si+1:0;Ei<oi;){for(vi=fi,Ai=1,Li=q;Ei>=oi&&si("invalid-input"),Mi=bi(ti.charCodeAt(Ei++)),(Mi>=q||Mi>Ht((V-fi)/Ai))&&si("overflow"),fi+=Mi*Ai,Pi=Li<=_i?G:Li>=_i+z?z:Li-_i,!(Mi<Pi);Li+=q)xi=q-Pi,Ai>Ht(V/xi)&&si("overflow"),Ai*=xi;ai=ii.length+1,_i=gi(fi-vi,ai,vi==0),Ht(fi/ai)>V-mi&&si("overflow"),mi+=Ht(fi/ai),fi%=ai,ii.splice(fi++,0,mi)}return ei(ii)}function Ge(ti){var ii,oi,ai,fi,mi,_i,Si,Ti,Ei,vi,Ai,Li=[],Mi,Pi,xi,wi;for(ti=ui(ti),Mi=ti.length,ii=yt,oi=0,mi=tt,_i=0;_i<Mi;++_i)Ai=ti[_i],Ai<128&&Li.push(Le(Ai));for(ai=fi=Li.length,fi&&Li.push(At);ai<Mi;){for(Si=V,_i=0;_i<Mi;++_i)Ai=ti[_i],Ai>=ii&&Ai<Si&&(Si=Ai);for(Pi=ai+1,Si-ii>Ht((V-oi)/Pi)&&si("overflow"),oi+=(Si-ii)*Pi,ii=Si,_i=0;_i<Mi;++_i)if(Ai=ti[_i],Ai<ii&&++oi>V&&si("overflow"),Ai==ii){for(Ti=oi,Ei=q;vi=Ei<=mi?G:Ei>=mi+z?z:Ei-mi,!(Ti<vi);Ei+=q)wi=Ti-vi,xi=q-vi,Li.push(Le(yi(vi+wi%xi,0))),Ti=Ht(wi/xi);Li.push(Le(yi(Ti,0))),mi=gi(oi,Pi,ai==fi),oi=0,++ai}++oi,++ii}return Li.join("")}function Te(ti){return di(ti,function(ii){return gt.test(ii)?we(ii.slice(4).toLowerCase()):ii})}function ri(ti){return di(ti,function(ii){return Et.test(ii)?"xn--"+Ge(ii):ii})}if(D={version:"1.4.1",ucs2:{decode:ui,encode:ei},decode:we,encode:Ge,toASCII:ri,toUnicode:Te},P&&I)if(R.exports==P)I.exports=D;else for(ee in D)D.hasOwnProperty(ee)&&(P[ee]=D[ee]);else L.punycode=D})(punycode)})(punycode$1,punycode$1.exports)),punycode$1.exports}var type,hasRequiredType;function requireType(){return hasRequiredType||(hasRequiredType=1,type=TypeError),type}const __viteBrowserExternal={},__viteBrowserExternal$1=Object.freeze(Object.defineProperty({__proto__:null,default:__viteBrowserExternal},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(__viteBrowserExternal$1);var objectInspect,hasRequiredObjectInspect;function requireObjectInspect(){if(hasRequiredObjectInspect)return objectInspect;hasRequiredObjectInspect=1;var R=typeof Map=="function"&&Map.prototype,T=Object.getOwnPropertyDescriptor&&R?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,L=R&&T&&typeof T.get=="function"?T.get:null,P=R&&Map.prototype.forEach,I=typeof Set=="function"&&Set.prototype,F=Object.getOwnPropertyDescriptor&&I?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,D=I&&F&&typeof F.get=="function"?F.get:null,V=I&&Set.prototype.forEach,q=typeof WeakMap=="function"&&WeakMap.prototype,G=q?WeakMap.prototype.has:null,z=typeof WeakSet=="function"&&WeakSet.prototype,Q=z?WeakSet.prototype.has:null,J=typeof WeakRef=="function"&&WeakRef.prototype,tt=J?WeakRef.prototype.deref:null,yt=Boolean.prototype.valueOf,At=Object.prototype.toString,gt=Function.prototype.toString,Et=String.prototype.match,kt=String.prototype.slice,ne=String.prototype.replace,Se=String.prototype.toUpperCase,Ht=String.prototype.toLowerCase,Le=RegExp.prototype.test,ee=Array.prototype.concat,si=Array.prototype.join,ci=Array.prototype.slice,di=Math.floor,ui=typeof BigInt=="function"?BigInt.prototype.valueOf:null,ei=Object.getOwnPropertySymbols,bi=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?Symbol.prototype.toString:null,yi=typeof Symbol=="function"&&typeof Symbol.iterator=="object",gi=typeof Symbol=="function"&&Symbol.toStringTag&&(typeof Symbol.toStringTag===yi||!0)?Symbol.toStringTag:null,we=Object.prototype.propertyIsEnumerable,Ge=(typeof Reflect=="function"?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(ni){return ni.__proto__}:null);function Te(ni,li){if(ni===1/0||ni===-1/0||ni!==ni||ni&&ni>-1e3&&ni<1e3||Le.call(/e/,li))return li;var Ri=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if(typeof ni=="number"){var Ii=ni<0?-di(-ni):di(ni);if(Ii!==ni){var Fi=String(Ii),Ci=kt.call(li,Fi.length+1);return ne.call(Fi,Ri,"$&_")+"."+ne.call(ne.call(Ci,/([0-9]{3})/g,"$&_"),/_$/,"")}}return ne.call(li,Ri,"$&_")}var ri=require$$0,ti=ri.custom,ii=Pi(ti)?ti:null,oi={__proto__:null,double:'"',single:"'"},ai={__proto__:null,double:/(["\\])/g,single:/(['\\])/g};objectInspect=function ni(li,Ri,Ii,Fi){var Ci=Ri||{};if(Bi(Ci,"quoteStyle")&&!Bi(oi,Ci.quoteStyle))throw new TypeError('option "quoteStyle" must be "single" or "double"');if(Bi(Ci,"maxStringLength")&&(typeof Ci.maxStringLength=="number"?Ci.maxStringLength<0&&Ci.maxStringLength!==1/0:Ci.maxStringLength!==null))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var zi=Bi(Ci,"customInspect")?Ci.customInspect:!0;if(typeof zi!="boolean"&&zi!=="symbol")throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(Bi(Ci,"indent")&&Ci.indent!==null&&Ci.indent!=="	"&&!(parseInt(Ci.indent,10)===Ci.indent&&Ci.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(Bi(Ci,"numericSeparator")&&typeof Ci.numericSeparator!="boolean")throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var ji=Ci.numericSeparator;if(typeof li>"u")return"undefined";if(li===null)return"null";if(typeof li=="boolean")return li?"true":"false";if(typeof li=="string")return or(li,Ci);if(typeof li=="number"){if(li===0)return 1/0/li>0?"0":"-0";var Oi=String(li);return ji?Te(li,Oi):Oi}if(typeof li=="bigint"){var Yi=String(li)+"n";return ji?Te(li,Yi):Yi}var Xs=typeof Ci.depth>"u"?5:Ci.depth;if(typeof Ii>"u"&&(Ii=0),Ii>=Xs&&Xs>0&&typeof li=="object")return Si(li)?"[Array]":"[Object]";var Ji=Tr(Ci,Ii);if(typeof Fi>"u")Fi=[];else if(Gi(Fi,li)>=0)return"[Circular]";function $i(_s,Vs,wr){if(Vs&&(Fi=ci.call(Fi),Fi.push(Vs)),wr){var gr={depth:Ci.depth};return Bi(Ci,"quoteStyle")&&(gr.quoteStyle=Ci.quoteStyle),ni(_s,gr,Ii+1,Fi)}return ni(_s,Ci,Ii+1,Fi)}if(typeof li=="function"&&!Ei(li)){var hr=Xi(li),cr=Us(li,$i);return"[Function"+(hr?": "+hr:" (anonymous)")+"]"+(cr.length>0?" { "+si.call(cr,", ")+" }":"")}if(Pi(li)){var ur=yi?ne.call(String(li),/^(Symbol\(.*\))_[^)]*$/,"$1"):bi.call(li);return typeof li=="object"&&!yi?Rs(ur):ur}if(br(li)){for(var Bs="<"+Ht.call(String(li.nodeName)),Ks=li.attributes||[],$s=0;$s<Ks.length;$s++)Bs+=" "+Ks[$s].name+"="+fi(mi(Ks[$s].value),"double",Ci);return Bs+=">",li.childNodes&&li.childNodes.length&&(Bs+="..."),Bs+="</"+Ht.call(String(li.nodeName))+">",Bs}if(Si(li)){if(li.length===0)return"[]";var Zs=Us(li,$i);return Ji&&!Sr(Zs)?"["+js(Zs,Ji)+"]":"[ "+si.call(Zs,", ")+" ]"}if(vi(li)){var Qs=Us(li,$i);return!("cause"in Error.prototype)&&"cause"in li&&!we.call(li,"cause")?"{ ["+String(li)+"] "+si.call(ee.call("[cause]: "+$i(li.cause),Qs),", ")+" }":Qs.length===0?"["+String(li)+"]":"{ ["+String(li)+"] "+si.call(Qs,", ")+" }"}if(typeof li=="object"&&zi){if(ii&&typeof li[ii]=="function"&&ri)return ri(li,{depth:Xs-Ii});if(zi!=="symbol"&&typeof li.inspect=="function")return li.inspect()}if(Ui(li)){var dr=[];return P&&P.call(li,function(_s,Vs){dr.push($i(Vs,li,!0)+" => "+$i(_s,li))}),lr("Map",L.call(li),dr,Ji)}if(Qi(li)){var fr=[];return V&&V.call(li,function(_s){fr.push($i(_s,li))}),lr("Set",D.call(li),fr,Ji)}if(Ki(li))return Ws("WeakMap");if(vr(li))return Ws("WeakSet");if(Zi(li))return Ws("WeakRef");if(Li(li))return Rs($i(Number(li)));if(xi(li))return Rs($i(ui.call(li)));if(Mi(li))return Rs(yt.call(li));if(Ai(li))return Rs($i(String(li)));if(typeof window<"u"&&li===window)return"{ [object Window] }";if(typeof globalThis<"u"&&li===globalThis||typeof commonjsGlobal<"u"&&li===commonjsGlobal)return"{ [object globalThis] }";if(!Ti(li)&&!Ei(li)){var Js=Us(li,$i),pr=Ge?Ge(li)===Object.prototype:li instanceof Object||li.constructor===Object,tr=li instanceof Object?"":"null prototype",mr=!pr&&gi&&Object(li)===li&&gi in li?kt.call(Di(li),8,-1):tr?"Object":"",xr=pr||typeof li.constructor!="function"?"":li.constructor.name?li.constructor.name+" ":"",er=xr+(mr||tr?"["+si.call(ee.call([],mr||[],tr||[]),": ")+"] ":"");return Js.length===0?er+"{}":Ji?er+"{"+js(Js,Ji)+"}":er+"{ "+si.call(Js,", ")+" }"}return String(li)};function fi(ni,li,Ri){var Ii=Ri.quoteStyle||li,Fi=oi[Ii];return Fi+ni+Fi}function mi(ni){return ne.call(String(ni),/"/g,"&quot;")}function _i(ni){return!gi||!(typeof ni=="object"&&(gi in ni||typeof ni[gi]<"u"))}function Si(ni){return Di(ni)==="[object Array]"&&_i(ni)}function Ti(ni){return Di(ni)==="[object Date]"&&_i(ni)}function Ei(ni){return Di(ni)==="[object RegExp]"&&_i(ni)}function vi(ni){return Di(ni)==="[object Error]"&&_i(ni)}function Ai(ni){return Di(ni)==="[object String]"&&_i(ni)}function Li(ni){return Di(ni)==="[object Number]"&&_i(ni)}function Mi(ni){return Di(ni)==="[object Boolean]"&&_i(ni)}function Pi(ni){if(yi)return ni&&typeof ni=="object"&&ni instanceof Symbol;if(typeof ni=="symbol")return!0;if(!ni||typeof ni!="object"||!bi)return!1;try{return bi.call(ni),!0}catch{}return!1}function xi(ni){if(!ni||typeof ni!="object"||!ui)return!1;try{return ui.call(ni),!0}catch{}return!1}var wi=Object.prototype.hasOwnProperty||function(ni){return ni in this};function Bi(ni,li){return wi.call(ni,li)}function Di(ni){return At.call(ni)}function Xi(ni){if(ni.name)return ni.name;var li=Et.call(gt.call(ni),/^function\s*([\w$]+)/);return li?li[1]:null}function Gi(ni,li){if(ni.indexOf)return ni.indexOf(li);for(var Ri=0,Ii=ni.length;Ri<Ii;Ri++)if(ni[Ri]===li)return Ri;return-1}function Ui(ni){if(!L||!ni||typeof ni!="object")return!1;try{L.call(ni);try{D.call(ni)}catch{return!0}return ni instanceof Map}catch{}return!1}function Ki(ni){if(!G||!ni||typeof ni!="object")return!1;try{G.call(ni,G);try{Q.call(ni,Q)}catch{return!0}return ni instanceof WeakMap}catch{}return!1}function Zi(ni){if(!tt||!ni||typeof ni!="object")return!1;try{return tt.call(ni),!0}catch{}return!1}function Qi(ni){if(!D||!ni||typeof ni!="object")return!1;try{D.call(ni);try{L.call(ni)}catch{return!0}return ni instanceof Set}catch{}return!1}function vr(ni){if(!Q||!ni||typeof ni!="object")return!1;try{Q.call(ni,Q);try{G.call(ni,G)}catch{return!0}return ni instanceof WeakSet}catch{}return!1}function br(ni){return!ni||typeof ni!="object"?!1:typeof HTMLElement<"u"&&ni instanceof HTMLElement?!0:typeof ni.nodeName=="string"&&typeof ni.getAttribute=="function"}function or(ni,li){if(ni.length>li.maxStringLength){var Ri=ni.length-li.maxStringLength,Ii="... "+Ri+" more character"+(Ri>1?"s":"");return or(kt.call(ni,0,li.maxStringLength),li)+Ii}var Fi=ai[li.quoteStyle||"single"];Fi.lastIndex=0;var Ci=ne.call(ne.call(ni,Fi,"\\$1"),/[\x00-\x1f]/g,_r);return fi(Ci,"single",li)}function _r(ni){var li=ni.charCodeAt(0),Ri={8:"b",9:"t",10:"n",12:"f",13:"r"}[li];return Ri?"\\"+Ri:"\\x"+(li<16?"0":"")+Se.call(li.toString(16))}function Rs(ni){return"Object("+ni+")"}function Ws(ni){return ni+" { ? }"}function lr(ni,li,Ri,Ii){var Fi=Ii?js(Ri,Ii):si.call(Ri,", ");return ni+" ("+li+") {"+Fi+"}"}function Sr(ni){for(var li=0;li<ni.length;li++)if(Gi(ni[li],`
`)>=0)return!1;return!0}function Tr(ni,li){var Ri;if(ni.indent==="	")Ri="	";else if(typeof ni.indent=="number"&&ni.indent>0)Ri=si.call(Array(ni.indent+1)," ");else return null;return{base:Ri,prev:si.call(Array(li+1),Ri)}}function js(ni,li){if(ni.length===0)return"";var Ri=`
`+li.prev+li.base;return Ri+si.call(ni,","+Ri)+`
`+li.prev}function Us(ni,li){var Ri=Si(ni),Ii=[];if(Ri){Ii.length=ni.length;for(var Fi=0;Fi<ni.length;Fi++)Ii[Fi]=Bi(ni,Fi)?li(ni[Fi],ni):""}var Ci=typeof ei=="function"?ei(ni):[],zi;if(yi){zi={};for(var ji=0;ji<Ci.length;ji++)zi["$"+Ci[ji]]=Ci[ji]}for(var Oi in ni)Bi(ni,Oi)&&(Ri&&String(Number(Oi))===Oi&&Oi<ni.length||yi&&zi["$"+Oi]instanceof Symbol||(Le.call(/[^\w$]/,Oi)?Ii.push(li(Oi,ni)+": "+li(ni[Oi],ni)):Ii.push(Oi+": "+li(ni[Oi],ni))));if(typeof ei=="function")for(var Yi=0;Yi<Ci.length;Yi++)we.call(ni,Ci[Yi])&&Ii.push("["+li(Ci[Yi])+"]: "+li(ni[Ci[Yi]],ni));return Ii}return objectInspect}var sideChannelList,hasRequiredSideChannelList;function requireSideChannelList(){if(hasRequiredSideChannelList)return sideChannelList;hasRequiredSideChannelList=1;var R=requireObjectInspect(),T=requireType(),L=function(V,q,G){for(var z=V,Q;(Q=z.next)!=null;z=Q)if(Q.key===q)return z.next=Q.next,G||(Q.next=V.next,V.next=Q),Q},P=function(V,q){if(V){var G=L(V,q);return G&&G.value}},I=function(V,q,G){var z=L(V,q);z?z.value=G:V.next={key:q,next:V.next,value:G}},F=function(V,q){return V?!!L(V,q):!1},D=function(V,q){if(V)return L(V,q,!0)};return sideChannelList=function(){var q,G={assert:function(z){if(!G.has(z))throw new T("Side channel does not contain "+R(z))},delete:function(z){var Q=q&&q.next,J=D(q,z);return J&&Q&&Q===J&&(q=void 0),!!J},get:function(z){return P(q,z)},has:function(z){return F(q,z)},set:function(z,Q){q||(q={next:void 0}),I(q,z,Q)}};return G},sideChannelList}var esObjectAtoms,hasRequiredEsObjectAtoms;function requireEsObjectAtoms(){return hasRequiredEsObjectAtoms||(hasRequiredEsObjectAtoms=1,esObjectAtoms=Object),esObjectAtoms}var esErrors,hasRequiredEsErrors;function requireEsErrors(){return hasRequiredEsErrors||(hasRequiredEsErrors=1,esErrors=Error),esErrors}var _eval,hasRequired_eval;function require_eval(){return hasRequired_eval||(hasRequired_eval=1,_eval=EvalError),_eval}var range,hasRequiredRange;function requireRange(){return hasRequiredRange||(hasRequiredRange=1,range=RangeError),range}var ref,hasRequiredRef;function requireRef(){return hasRequiredRef||(hasRequiredRef=1,ref=ReferenceError),ref}var syntax,hasRequiredSyntax;function requireSyntax(){return hasRequiredSyntax||(hasRequiredSyntax=1,syntax=SyntaxError),syntax}var uri,hasRequiredUri;function requireUri(){return hasRequiredUri||(hasRequiredUri=1,uri=URIError),uri}var abs,hasRequiredAbs;function requireAbs(){return hasRequiredAbs||(hasRequiredAbs=1,abs=Math.abs),abs}var floor,hasRequiredFloor;function requireFloor(){return hasRequiredFloor||(hasRequiredFloor=1,floor=Math.floor),floor}var max,hasRequiredMax;function requireMax(){return hasRequiredMax||(hasRequiredMax=1,max=Math.max),max}var min,hasRequiredMin;function requireMin(){return hasRequiredMin||(hasRequiredMin=1,min=Math.min),min}var pow,hasRequiredPow;function requirePow(){return hasRequiredPow||(hasRequiredPow=1,pow=Math.pow),pow}var round,hasRequiredRound;function requireRound(){return hasRequiredRound||(hasRequiredRound=1,round=Math.round),round}var _isNaN,hasRequired_isNaN;function require_isNaN(){return hasRequired_isNaN||(hasRequired_isNaN=1,_isNaN=Number.isNaN||function(T){return T!==T}),_isNaN}var sign,hasRequiredSign;function requireSign(){if(hasRequiredSign)return sign;hasRequiredSign=1;var R=require_isNaN();return sign=function(L){return R(L)||L===0?L:L<0?-1:1},sign}var gOPD,hasRequiredGOPD;function requireGOPD(){return hasRequiredGOPD||(hasRequiredGOPD=1,gOPD=Object.getOwnPropertyDescriptor),gOPD}var gopd,hasRequiredGopd;function requireGopd(){if(hasRequiredGopd)return gopd;hasRequiredGopd=1;var R=requireGOPD();if(R)try{R([],"length")}catch{R=null}return gopd=R,gopd}var esDefineProperty,hasRequiredEsDefineProperty;function requireEsDefineProperty(){if(hasRequiredEsDefineProperty)return esDefineProperty;hasRequiredEsDefineProperty=1;var R=Object.defineProperty||!1;if(R)try{R({},"a",{value:1})}catch{R=!1}return esDefineProperty=R,esDefineProperty}var shams,hasRequiredShams;function requireShams(){return hasRequiredShams||(hasRequiredShams=1,shams=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var T={},L=Symbol("test"),P=Object(L);if(typeof L=="string"||Object.prototype.toString.call(L)!=="[object Symbol]"||Object.prototype.toString.call(P)!=="[object Symbol]")return!1;var I=42;T[L]=I;for(var F in T)return!1;if(typeof Object.keys=="function"&&Object.keys(T).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(T).length!==0)return!1;var D=Object.getOwnPropertySymbols(T);if(D.length!==1||D[0]!==L||!Object.prototype.propertyIsEnumerable.call(T,L))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var V=Object.getOwnPropertyDescriptor(T,L);if(V.value!==I||V.enumerable!==!0)return!1}return!0}),shams}var hasSymbols,hasRequiredHasSymbols;function requireHasSymbols(){if(hasRequiredHasSymbols)return hasSymbols;hasRequiredHasSymbols=1;var R=typeof Symbol<"u"&&Symbol,T=requireShams();return hasSymbols=function(){return typeof R!="function"||typeof Symbol!="function"||typeof R("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:T()},hasSymbols}var Reflect_getPrototypeOf,hasRequiredReflect_getPrototypeOf;function requireReflect_getPrototypeOf(){return hasRequiredReflect_getPrototypeOf||(hasRequiredReflect_getPrototypeOf=1,Reflect_getPrototypeOf=typeof Reflect<"u"&&Reflect.getPrototypeOf||null),Reflect_getPrototypeOf}var Object_getPrototypeOf,hasRequiredObject_getPrototypeOf;function requireObject_getPrototypeOf(){if(hasRequiredObject_getPrototypeOf)return Object_getPrototypeOf;hasRequiredObject_getPrototypeOf=1;var R=requireEsObjectAtoms();return Object_getPrototypeOf=R.getPrototypeOf||null,Object_getPrototypeOf}var implementation,hasRequiredImplementation;function requireImplementation(){if(hasRequiredImplementation)return implementation;hasRequiredImplementation=1;var R="Function.prototype.bind called on incompatible ",T=Object.prototype.toString,L=Math.max,P="[object Function]",I=function(q,G){for(var z=[],Q=0;Q<q.length;Q+=1)z[Q]=q[Q];for(var J=0;J<G.length;J+=1)z[J+q.length]=G[J];return z},F=function(q,G){for(var z=[],Q=G,J=0;Q<q.length;Q+=1,J+=1)z[J]=q[Q];return z},D=function(V,q){for(var G="",z=0;z<V.length;z+=1)G+=V[z],z+1<V.length&&(G+=q);return G};return implementation=function(q){var G=this;if(typeof G!="function"||T.apply(G)!==P)throw new TypeError(R+G);for(var z=F(arguments,1),Q,J=function(){if(this instanceof Q){var Et=G.apply(this,I(z,arguments));return Object(Et)===Et?Et:this}return G.apply(q,I(z,arguments))},tt=L(0,G.length-z.length),yt=[],At=0;At<tt;At++)yt[At]="$"+At;if(Q=Function("binder","return function ("+D(yt,",")+"){ return binder.apply(this,arguments); }")(J),G.prototype){var gt=function(){};gt.prototype=G.prototype,Q.prototype=new gt,gt.prototype=null}return Q},implementation}var functionBind,hasRequiredFunctionBind;function requireFunctionBind(){if(hasRequiredFunctionBind)return functionBind;hasRequiredFunctionBind=1;var R=requireImplementation();return functionBind=Function.prototype.bind||R,functionBind}var functionCall,hasRequiredFunctionCall;function requireFunctionCall(){return hasRequiredFunctionCall||(hasRequiredFunctionCall=1,functionCall=Function.prototype.call),functionCall}var functionApply,hasRequiredFunctionApply;function requireFunctionApply(){return hasRequiredFunctionApply||(hasRequiredFunctionApply=1,functionApply=Function.prototype.apply),functionApply}var reflectApply,hasRequiredReflectApply;function requireReflectApply(){return hasRequiredReflectApply||(hasRequiredReflectApply=1,reflectApply=typeof Reflect<"u"&&Reflect&&Reflect.apply),reflectApply}var actualApply,hasRequiredActualApply;function requireActualApply(){if(hasRequiredActualApply)return actualApply;hasRequiredActualApply=1;var R=requireFunctionBind(),T=requireFunctionApply(),L=requireFunctionCall(),P=requireReflectApply();return actualApply=P||R.call(L,T),actualApply}var callBindApplyHelpers,hasRequiredCallBindApplyHelpers;function requireCallBindApplyHelpers(){if(hasRequiredCallBindApplyHelpers)return callBindApplyHelpers;hasRequiredCallBindApplyHelpers=1;var R=requireFunctionBind(),T=requireType(),L=requireFunctionCall(),P=requireActualApply();return callBindApplyHelpers=function(F){if(F.length<1||typeof F[0]!="function")throw new T("a function is required");return P(R,L,F)},callBindApplyHelpers}var get,hasRequiredGet;function requireGet(){if(hasRequiredGet)return get;hasRequiredGet=1;var R=requireCallBindApplyHelpers(),T=requireGopd(),L;try{L=[].__proto__===Array.prototype}catch(D){if(!D||typeof D!="object"||!("code"in D)||D.code!=="ERR_PROTO_ACCESS")throw D}var P=!!L&&T&&T(Object.prototype,"__proto__"),I=Object,F=I.getPrototypeOf;return get=P&&typeof P.get=="function"?R([P.get]):typeof F=="function"?function(V){return F(V==null?V:I(V))}:!1,get}var getProto,hasRequiredGetProto;function requireGetProto(){if(hasRequiredGetProto)return getProto;hasRequiredGetProto=1;var R=requireReflect_getPrototypeOf(),T=requireObject_getPrototypeOf(),L=requireGet();return getProto=R?function(I){return R(I)}:T?function(I){if(!I||typeof I!="object"&&typeof I!="function")throw new TypeError("getProto: not an object");return T(I)}:L?function(I){return L(I)}:null,getProto}var hasown,hasRequiredHasown;function requireHasown(){if(hasRequiredHasown)return hasown;hasRequiredHasown=1;var R=Function.prototype.call,T=Object.prototype.hasOwnProperty,L=requireFunctionBind();return hasown=L.call(R,T),hasown}var getIntrinsic,hasRequiredGetIntrinsic;function requireGetIntrinsic(){if(hasRequiredGetIntrinsic)return getIntrinsic;hasRequiredGetIntrinsic=1;var R,T=requireEsObjectAtoms(),L=requireEsErrors(),P=require_eval(),I=requireRange(),F=requireRef(),D=requireSyntax(),V=requireType(),q=requireUri(),G=requireAbs(),z=requireFloor(),Q=requireMax(),J=requireMin(),tt=requirePow(),yt=requireRound(),At=requireSign(),gt=Function,Et=function(Ei){try{return gt('"use strict"; return ('+Ei+").constructor;")()}catch{}},kt=requireGopd(),ne=requireEsDefineProperty(),Se=function(){throw new V},Ht=kt?(function(){try{return arguments.callee,Se}catch{try{return kt(arguments,"callee").get}catch{return Se}}})():Se,Le=requireHasSymbols()(),ee=requireGetProto(),si=requireObject_getPrototypeOf(),ci=requireReflect_getPrototypeOf(),di=requireFunctionApply(),ui=requireFunctionCall(),ei={},bi=typeof Uint8Array>"u"||!ee?R:ee(Uint8Array),yi={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?R:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?R:ArrayBuffer,"%ArrayIteratorPrototype%":Le&&ee?ee([][Symbol.iterator]()):R,"%AsyncFromSyncIteratorPrototype%":R,"%AsyncFunction%":ei,"%AsyncGenerator%":ei,"%AsyncGeneratorFunction%":ei,"%AsyncIteratorPrototype%":ei,"%Atomics%":typeof Atomics>"u"?R:Atomics,"%BigInt%":typeof BigInt>"u"?R:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?R:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?R:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?R:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":L,"%eval%":eval,"%EvalError%":P,"%Float16Array%":typeof Float16Array>"u"?R:Float16Array,"%Float32Array%":typeof Float32Array>"u"?R:Float32Array,"%Float64Array%":typeof Float64Array>"u"?R:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?R:FinalizationRegistry,"%Function%":gt,"%GeneratorFunction%":ei,"%Int8Array%":typeof Int8Array>"u"?R:Int8Array,"%Int16Array%":typeof Int16Array>"u"?R:Int16Array,"%Int32Array%":typeof Int32Array>"u"?R:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":Le&&ee?ee(ee([][Symbol.iterator]())):R,"%JSON%":typeof JSON=="object"?JSON:R,"%Map%":typeof Map>"u"?R:Map,"%MapIteratorPrototype%":typeof Map>"u"||!Le||!ee?R:ee(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":T,"%Object.getOwnPropertyDescriptor%":kt,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?R:Promise,"%Proxy%":typeof Proxy>"u"?R:Proxy,"%RangeError%":I,"%ReferenceError%":F,"%Reflect%":typeof Reflect>"u"?R:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?R:Set,"%SetIteratorPrototype%":typeof Set>"u"||!Le||!ee?R:ee(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?R:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":Le&&ee?ee(""[Symbol.iterator]()):R,"%Symbol%":Le?Symbol:R,"%SyntaxError%":D,"%ThrowTypeError%":Ht,"%TypedArray%":bi,"%TypeError%":V,"%Uint8Array%":typeof Uint8Array>"u"?R:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?R:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?R:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?R:Uint32Array,"%URIError%":q,"%WeakMap%":typeof WeakMap>"u"?R:WeakMap,"%WeakRef%":typeof WeakRef>"u"?R:WeakRef,"%WeakSet%":typeof WeakSet>"u"?R:WeakSet,"%Function.prototype.call%":ui,"%Function.prototype.apply%":di,"%Object.defineProperty%":ne,"%Object.getPrototypeOf%":si,"%Math.abs%":G,"%Math.floor%":z,"%Math.max%":Q,"%Math.min%":J,"%Math.pow%":tt,"%Math.round%":yt,"%Math.sign%":At,"%Reflect.getPrototypeOf%":ci};if(ee)try{null.error}catch(Ei){var gi=ee(ee(Ei));yi["%Error.prototype%"]=gi}var we=function Ei(vi){var Ai;if(vi==="%AsyncFunction%")Ai=Et("async function () {}");else if(vi==="%GeneratorFunction%")Ai=Et("function* () {}");else if(vi==="%AsyncGeneratorFunction%")Ai=Et("async function* () {}");else if(vi==="%AsyncGenerator%"){var Li=Ei("%AsyncGeneratorFunction%");Li&&(Ai=Li.prototype)}else if(vi==="%AsyncIteratorPrototype%"){var Mi=Ei("%AsyncGenerator%");Mi&&ee&&(Ai=ee(Mi.prototype))}return yi[vi]=Ai,Ai},Ge={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},Te=requireFunctionBind(),ri=requireHasown(),ti=Te.call(ui,Array.prototype.concat),ii=Te.call(di,Array.prototype.splice),oi=Te.call(ui,String.prototype.replace),ai=Te.call(ui,String.prototype.slice),fi=Te.call(ui,RegExp.prototype.exec),mi=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,_i=/\\(\\)?/g,Si=function(vi){var Ai=ai(vi,0,1),Li=ai(vi,-1);if(Ai==="%"&&Li!=="%")throw new D("invalid intrinsic syntax, expected closing `%`");if(Li==="%"&&Ai!=="%")throw new D("invalid intrinsic syntax, expected opening `%`");var Mi=[];return oi(vi,mi,function(Pi,xi,wi,Bi){Mi[Mi.length]=wi?oi(Bi,_i,"$1"):xi||Pi}),Mi},Ti=function(vi,Ai){var Li=vi,Mi;if(ri(Ge,Li)&&(Mi=Ge[Li],Li="%"+Mi[0]+"%"),ri(yi,Li)){var Pi=yi[Li];if(Pi===ei&&(Pi=we(Li)),typeof Pi>"u"&&!Ai)throw new V("intrinsic "+vi+" exists, but is not available. Please file an issue!");return{alias:Mi,name:Li,value:Pi}}throw new D("intrinsic "+vi+" does not exist!")};return getIntrinsic=function(vi,Ai){if(typeof vi!="string"||vi.length===0)throw new V("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof Ai!="boolean")throw new V('"allowMissing" argument must be a boolean');if(fi(/^%?[^%]*%?$/,vi)===null)throw new D("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var Li=Si(vi),Mi=Li.length>0?Li[0]:"",Pi=Ti("%"+Mi+"%",Ai),xi=Pi.name,wi=Pi.value,Bi=!1,Di=Pi.alias;Di&&(Mi=Di[0],ii(Li,ti([0,1],Di)));for(var Xi=1,Gi=!0;Xi<Li.length;Xi+=1){var Ui=Li[Xi],Ki=ai(Ui,0,1),Zi=ai(Ui,-1);if((Ki==='"'||Ki==="'"||Ki==="`"||Zi==='"'||Zi==="'"||Zi==="`")&&Ki!==Zi)throw new D("property names with quotes must have matching quotes");if((Ui==="constructor"||!Gi)&&(Bi=!0),Mi+="."+Ui,xi="%"+Mi+"%",ri(yi,xi))wi=yi[xi];else if(wi!=null){if(!(Ui in wi)){if(!Ai)throw new V("base intrinsic for "+vi+" exists, but the property is not available.");return}if(kt&&Xi+1>=Li.length){var Qi=kt(wi,Ui);Gi=!!Qi,Gi&&"get"in Qi&&!("originalValue"in Qi.get)?wi=Qi.get:wi=wi[Ui]}else Gi=ri(wi,Ui),wi=wi[Ui];Gi&&!Bi&&(yi[xi]=wi)}}return wi},getIntrinsic}var callBound,hasRequiredCallBound;function requireCallBound(){if(hasRequiredCallBound)return callBound;hasRequiredCallBound=1;var R=requireGetIntrinsic(),T=requireCallBindApplyHelpers(),L=T([R("%String.prototype.indexOf%")]);return callBound=function(I,F){var D=R(I,!!F);return typeof D=="function"&&L(I,".prototype.")>-1?T([D]):D},callBound}var sideChannelMap,hasRequiredSideChannelMap;function requireSideChannelMap(){if(hasRequiredSideChannelMap)return sideChannelMap;hasRequiredSideChannelMap=1;var R=requireGetIntrinsic(),T=requireCallBound(),L=requireObjectInspect(),P=requireType(),I=R("%Map%",!0),F=T("Map.prototype.get",!0),D=T("Map.prototype.set",!0),V=T("Map.prototype.has",!0),q=T("Map.prototype.delete",!0),G=T("Map.prototype.size",!0);return sideChannelMap=!!I&&function(){var Q,J={assert:function(tt){if(!J.has(tt))throw new P("Side channel does not contain "+L(tt))},delete:function(tt){if(Q){var yt=q(Q,tt);return G(Q)===0&&(Q=void 0),yt}return!1},get:function(tt){if(Q)return F(Q,tt)},has:function(tt){return Q?V(Q,tt):!1},set:function(tt,yt){Q||(Q=new I),D(Q,tt,yt)}};return J},sideChannelMap}var sideChannelWeakmap,hasRequiredSideChannelWeakmap;function requireSideChannelWeakmap(){if(hasRequiredSideChannelWeakmap)return sideChannelWeakmap;hasRequiredSideChannelWeakmap=1;var R=requireGetIntrinsic(),T=requireCallBound(),L=requireObjectInspect(),P=requireSideChannelMap(),I=requireType(),F=R("%WeakMap%",!0),D=T("WeakMap.prototype.get",!0),V=T("WeakMap.prototype.set",!0),q=T("WeakMap.prototype.has",!0),G=T("WeakMap.prototype.delete",!0);return sideChannelWeakmap=F?function(){var Q,J,tt={assert:function(yt){if(!tt.has(yt))throw new I("Side channel does not contain "+L(yt))},delete:function(yt){if(F&&yt&&(typeof yt=="object"||typeof yt=="function")){if(Q)return G(Q,yt)}else if(P&&J)return J.delete(yt);return!1},get:function(yt){return F&&yt&&(typeof yt=="object"||typeof yt=="function")&&Q?D(Q,yt):J&&J.get(yt)},has:function(yt){return F&&yt&&(typeof yt=="object"||typeof yt=="function")&&Q?q(Q,yt):!!J&&J.has(yt)},set:function(yt,At){F&&yt&&(typeof yt=="object"||typeof yt=="function")?(Q||(Q=new F),V(Q,yt,At)):P&&(J||(J=P()),J.set(yt,At))}};return tt}:P,sideChannelWeakmap}var sideChannel,hasRequiredSideChannel;function requireSideChannel(){if(hasRequiredSideChannel)return sideChannel;hasRequiredSideChannel=1;var R=requireType(),T=requireObjectInspect(),L=requireSideChannelList(),P=requireSideChannelMap(),I=requireSideChannelWeakmap(),F=I||P||L;return sideChannel=function(){var V,q={assert:function(G){if(!q.has(G))throw new R("Side channel does not contain "+T(G))},delete:function(G){return!!V&&V.delete(G)},get:function(G){return V&&V.get(G)},has:function(G){return!!V&&V.has(G)},set:function(G,z){V||(V=F()),V.set(G,z)}};return q},sideChannel}var formats,hasRequiredFormats;function requireFormats(){if(hasRequiredFormats)return formats;hasRequiredFormats=1;var R=String.prototype.replace,T=/%20/g,L={RFC1738:"RFC1738",RFC3986:"RFC3986"};return formats={default:L.RFC3986,formatters:{RFC1738:function(P){return R.call(P,T,"+")},RFC3986:function(P){return String(P)}},RFC1738:L.RFC1738,RFC3986:L.RFC3986},formats}var utils,hasRequiredUtils;function requireUtils(){if(hasRequiredUtils)return utils;hasRequiredUtils=1;var R=requireFormats(),T=Object.prototype.hasOwnProperty,L=Array.isArray,P=(function(){for(var gt=[],Et=0;Et<256;++Et)gt.push("%"+((Et<16?"0":"")+Et.toString(16)).toUpperCase());return gt})(),I=function(Et){for(;Et.length>1;){var kt=Et.pop(),ne=kt.obj[kt.prop];if(L(ne)){for(var Se=[],Ht=0;Ht<ne.length;++Ht)typeof ne[Ht]<"u"&&Se.push(ne[Ht]);kt.obj[kt.prop]=Se}}},F=function(Et,kt){for(var ne=kt&&kt.plainObjects?{__proto__:null}:{},Se=0;Se<Et.length;++Se)typeof Et[Se]<"u"&&(ne[Se]=Et[Se]);return ne},D=function gt(Et,kt,ne){if(!kt)return Et;if(typeof kt!="object"&&typeof kt!="function"){if(L(Et))Et.push(kt);else if(Et&&typeof Et=="object")(ne&&(ne.plainObjects||ne.allowPrototypes)||!T.call(Object.prototype,kt))&&(Et[kt]=!0);else return[Et,kt];return Et}if(!Et||typeof Et!="object")return[Et].concat(kt);var Se=Et;return L(Et)&&!L(kt)&&(Se=F(Et,ne)),L(Et)&&L(kt)?(kt.forEach(function(Ht,Le){if(T.call(Et,Le)){var ee=Et[Le];ee&&typeof ee=="object"&&Ht&&typeof Ht=="object"?Et[Le]=gt(ee,Ht,ne):Et.push(Ht)}else Et[Le]=Ht}),Et):Object.keys(kt).reduce(function(Ht,Le){var ee=kt[Le];return T.call(Ht,Le)?Ht[Le]=gt(Ht[Le],ee,ne):Ht[Le]=ee,Ht},Se)},V=function(Et,kt){return Object.keys(kt).reduce(function(ne,Se){return ne[Se]=kt[Se],ne},Et)},q=function(gt,Et,kt){var ne=gt.replace(/\+/g," ");if(kt==="iso-8859-1")return ne.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(ne)}catch{return ne}},G=1024,z=function(Et,kt,ne,Se,Ht){if(Et.length===0)return Et;var Le=Et;if(typeof Et=="symbol"?Le=Symbol.prototype.toString.call(Et):typeof Et!="string"&&(Le=String(Et)),ne==="iso-8859-1")return escape(Le).replace(/%u[0-9a-f]{4}/gi,function(bi){return"%26%23"+parseInt(bi.slice(2),16)+"%3B"});for(var ee="",si=0;si<Le.length;si+=G){for(var ci=Le.length>=G?Le.slice(si,si+G):Le,di=[],ui=0;ui<ci.length;++ui){var ei=ci.charCodeAt(ui);if(ei===45||ei===46||ei===95||ei===126||ei>=48&&ei<=57||ei>=65&&ei<=90||ei>=97&&ei<=122||Ht===R.RFC1738&&(ei===40||ei===41)){di[di.length]=ci.charAt(ui);continue}if(ei<128){di[di.length]=P[ei];continue}if(ei<2048){di[di.length]=P[192|ei>>6]+P[128|ei&63];continue}if(ei<55296||ei>=57344){di[di.length]=P[224|ei>>12]+P[128|ei>>6&63]+P[128|ei&63];continue}ui+=1,ei=65536+((ei&1023)<<10|ci.charCodeAt(ui)&1023),di[di.length]=P[240|ei>>18]+P[128|ei>>12&63]+P[128|ei>>6&63]+P[128|ei&63]}ee+=di.join("")}return ee},Q=function(Et){for(var kt=[{obj:{o:Et},prop:"o"}],ne=[],Se=0;Se<kt.length;++Se)for(var Ht=kt[Se],Le=Ht.obj[Ht.prop],ee=Object.keys(Le),si=0;si<ee.length;++si){var ci=ee[si],di=Le[ci];typeof di=="object"&&di!==null&&ne.indexOf(di)===-1&&(kt.push({obj:Le,prop:ci}),ne.push(di))}return I(kt),Et},J=function(Et){return Object.prototype.toString.call(Et)==="[object RegExp]"},tt=function(Et){return!Et||typeof Et!="object"?!1:!!(Et.constructor&&Et.constructor.isBuffer&&Et.constructor.isBuffer(Et))},yt=function(Et,kt){return[].concat(Et,kt)},At=function(Et,kt){if(L(Et)){for(var ne=[],Se=0;Se<Et.length;Se+=1)ne.push(kt(Et[Se]));return ne}return kt(Et)};return utils={arrayToObject:F,assign:V,combine:yt,compact:Q,decode:q,encode:z,isBuffer:tt,isRegExp:J,maybeMap:At,merge:D},utils}var stringify_1,hasRequiredStringify;function requireStringify(){if(hasRequiredStringify)return stringify_1;hasRequiredStringify=1;var R=requireSideChannel(),T=requireUtils(),L=requireFormats(),P=Object.prototype.hasOwnProperty,I={brackets:function(gt){return gt+"[]"},comma:"comma",indices:function(gt,Et){return gt+"["+Et+"]"},repeat:function(gt){return gt}},F=Array.isArray,D=Array.prototype.push,V=function(At,gt){D.apply(At,F(gt)?gt:[gt])},q=Date.prototype.toISOString,G=L.default,z={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,commaRoundTrip:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:T.encode,encodeValuesOnly:!1,filter:void 0,format:G,formatter:L.formatters[G],indices:!1,serializeDate:function(gt){return q.call(gt)},skipNulls:!1,strictNullHandling:!1},Q=function(gt){return typeof gt=="string"||typeof gt=="number"||typeof gt=="boolean"||typeof gt=="symbol"||typeof gt=="bigint"},J={},tt=function At(gt,Et,kt,ne,Se,Ht,Le,ee,si,ci,di,ui,ei,bi,yi,gi,we,Ge){for(var Te=gt,ri=Ge,ti=0,ii=!1;(ri=ri.get(J))!==void 0&&!ii;){var oi=ri.get(gt);if(ti+=1,typeof oi<"u"){if(oi===ti)throw new RangeError("Cyclic object value");ii=!0}typeof ri.get(J)>"u"&&(ti=0)}if(typeof ci=="function"?Te=ci(Et,Te):Te instanceof Date?Te=ei(Te):kt==="comma"&&F(Te)&&(Te=T.maybeMap(Te,function(xi){return xi instanceof Date?ei(xi):xi})),Te===null){if(Ht)return si&&!gi?si(Et,z.encoder,we,"key",bi):Et;Te=""}if(Q(Te)||T.isBuffer(Te)){if(si){var ai=gi?Et:si(Et,z.encoder,we,"key",bi);return[yi(ai)+"="+yi(si(Te,z.encoder,we,"value",bi))]}return[yi(Et)+"="+yi(String(Te))]}var fi=[];if(typeof Te>"u")return fi;var mi;if(kt==="comma"&&F(Te))gi&&si&&(Te=T.maybeMap(Te,si)),mi=[{value:Te.length>0?Te.join(",")||null:void 0}];else if(F(ci))mi=ci;else{var _i=Object.keys(Te);mi=di?_i.sort(di):_i}var Si=ee?String(Et).replace(/\./g,"%2E"):String(Et),Ti=ne&&F(Te)&&Te.length===1?Si+"[]":Si;if(Se&&F(Te)&&Te.length===0)return Ti+"[]";for(var Ei=0;Ei<mi.length;++Ei){var vi=mi[Ei],Ai=typeof vi=="object"&&vi&&typeof vi.value<"u"?vi.value:Te[vi];if(!(Le&&Ai===null)){var Li=ui&&ee?String(vi).replace(/\./g,"%2E"):String(vi),Mi=F(Te)?typeof kt=="function"?kt(Ti,Li):Ti:Ti+(ui?"."+Li:"["+Li+"]");Ge.set(gt,ti);var Pi=R();Pi.set(J,Ge),V(fi,At(Ai,Mi,kt,ne,Se,Ht,Le,ee,kt==="comma"&&gi&&F(Te)?null:si,ci,di,ui,ei,bi,yi,gi,we,Pi))}}return fi},yt=function(gt){if(!gt)return z;if(typeof gt.allowEmptyArrays<"u"&&typeof gt.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof gt.encodeDotInKeys<"u"&&typeof gt.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(gt.encoder!==null&&typeof gt.encoder<"u"&&typeof gt.encoder!="function")throw new TypeError("Encoder has to be a function.");var Et=gt.charset||z.charset;if(typeof gt.charset<"u"&&gt.charset!=="utf-8"&&gt.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var kt=L.default;if(typeof gt.format<"u"){if(!P.call(L.formatters,gt.format))throw new TypeError("Unknown format option provided.");kt=gt.format}var ne=L.formatters[kt],Se=z.filter;(typeof gt.filter=="function"||F(gt.filter))&&(Se=gt.filter);var Ht;if(gt.arrayFormat in I?Ht=gt.arrayFormat:"indices"in gt?Ht=gt.indices?"indices":"repeat":Ht=z.arrayFormat,"commaRoundTrip"in gt&&typeof gt.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");var Le=typeof gt.allowDots>"u"?gt.encodeDotInKeys===!0?!0:z.allowDots:!!gt.allowDots;return{addQueryPrefix:typeof gt.addQueryPrefix=="boolean"?gt.addQueryPrefix:z.addQueryPrefix,allowDots:Le,allowEmptyArrays:typeof gt.allowEmptyArrays=="boolean"?!!gt.allowEmptyArrays:z.allowEmptyArrays,arrayFormat:Ht,charset:Et,charsetSentinel:typeof gt.charsetSentinel=="boolean"?gt.charsetSentinel:z.charsetSentinel,commaRoundTrip:!!gt.commaRoundTrip,delimiter:typeof gt.delimiter>"u"?z.delimiter:gt.delimiter,encode:typeof gt.encode=="boolean"?gt.encode:z.encode,encodeDotInKeys:typeof gt.encodeDotInKeys=="boolean"?gt.encodeDotInKeys:z.encodeDotInKeys,encoder:typeof gt.encoder=="function"?gt.encoder:z.encoder,encodeValuesOnly:typeof gt.encodeValuesOnly=="boolean"?gt.encodeValuesOnly:z.encodeValuesOnly,filter:Se,format:kt,formatter:ne,serializeDate:typeof gt.serializeDate=="function"?gt.serializeDate:z.serializeDate,skipNulls:typeof gt.skipNulls=="boolean"?gt.skipNulls:z.skipNulls,sort:typeof gt.sort=="function"?gt.sort:null,strictNullHandling:typeof gt.strictNullHandling=="boolean"?gt.strictNullHandling:z.strictNullHandling}};return stringify_1=function(At,gt){var Et=At,kt=yt(gt),ne,Se;typeof kt.filter=="function"?(Se=kt.filter,Et=Se("",Et)):F(kt.filter)&&(Se=kt.filter,ne=Se);var Ht=[];if(typeof Et!="object"||Et===null)return"";var Le=I[kt.arrayFormat],ee=Le==="comma"&&kt.commaRoundTrip;ne||(ne=Object.keys(Et)),kt.sort&&ne.sort(kt.sort);for(var si=R(),ci=0;ci<ne.length;++ci){var di=ne[ci],ui=Et[di];kt.skipNulls&&ui===null||V(Ht,tt(ui,di,Le,ee,kt.allowEmptyArrays,kt.strictNullHandling,kt.skipNulls,kt.encodeDotInKeys,kt.encode?kt.encoder:null,kt.filter,kt.sort,kt.allowDots,kt.serializeDate,kt.format,kt.formatter,kt.encodeValuesOnly,kt.charset,si))}var ei=Ht.join(kt.delimiter),bi=kt.addQueryPrefix===!0?"?":"";return kt.charsetSentinel&&(kt.charset==="iso-8859-1"?bi+="utf8=%26%2310003%3B&":bi+="utf8=%E2%9C%93&"),ei.length>0?bi+ei:""},stringify_1}var parse,hasRequiredParse;function requireParse(){if(hasRequiredParse)return parse;hasRequiredParse=1;var R=requireUtils(),T=Object.prototype.hasOwnProperty,L=Array.isArray,P={allowDots:!1,allowEmptyArrays:!1,allowPrototypes:!1,allowSparse:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decodeDotInKeys:!1,decoder:R.decode,delimiter:"&",depth:5,duplicates:"combine",ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictDepth:!1,strictNullHandling:!1,throwOnLimitExceeded:!1},I=function(J){return J.replace(/&#(\d+);/g,function(tt,yt){return String.fromCharCode(parseInt(yt,10))})},F=function(J,tt,yt){if(J&&typeof J=="string"&&tt.comma&&J.indexOf(",")>-1)return J.split(",");if(tt.throwOnLimitExceeded&&yt>=tt.arrayLimit)throw new RangeError("Array limit exceeded. Only "+tt.arrayLimit+" element"+(tt.arrayLimit===1?"":"s")+" allowed in an array.");return J},D="utf8=%26%2310003%3B",V="utf8=%E2%9C%93",q=function(tt,yt){var At={__proto__:null},gt=yt.ignoreQueryPrefix?tt.replace(/^\?/,""):tt;gt=gt.replace(/%5B/gi,"[").replace(/%5D/gi,"]");var Et=yt.parameterLimit===1/0?void 0:yt.parameterLimit,kt=gt.split(yt.delimiter,yt.throwOnLimitExceeded?Et+1:Et);if(yt.throwOnLimitExceeded&&kt.length>Et)throw new RangeError("Parameter limit exceeded. Only "+Et+" parameter"+(Et===1?"":"s")+" allowed.");var ne=-1,Se,Ht=yt.charset;if(yt.charsetSentinel)for(Se=0;Se<kt.length;++Se)kt[Se].indexOf("utf8=")===0&&(kt[Se]===V?Ht="utf-8":kt[Se]===D&&(Ht="iso-8859-1"),ne=Se,Se=kt.length);for(Se=0;Se<kt.length;++Se)if(Se!==ne){var Le=kt[Se],ee=Le.indexOf("]="),si=ee===-1?Le.indexOf("="):ee+1,ci,di;si===-1?(ci=yt.decoder(Le,P.decoder,Ht,"key"),di=yt.strictNullHandling?null:""):(ci=yt.decoder(Le.slice(0,si),P.decoder,Ht,"key"),di=R.maybeMap(F(Le.slice(si+1),yt,L(At[ci])?At[ci].length:0),function(ei){return yt.decoder(ei,P.decoder,Ht,"value")})),di&&yt.interpretNumericEntities&&Ht==="iso-8859-1"&&(di=I(String(di))),Le.indexOf("[]=")>-1&&(di=L(di)?[di]:di);var ui=T.call(At,ci);ui&&yt.duplicates==="combine"?At[ci]=R.combine(At[ci],di):(!ui||yt.duplicates==="last")&&(At[ci]=di)}return At},G=function(J,tt,yt,At){var gt=0;if(J.length>0&&J[J.length-1]==="[]"){var Et=J.slice(0,-1).join("");gt=Array.isArray(tt)&&tt[Et]?tt[Et].length:0}for(var kt=At?tt:F(tt,yt,gt),ne=J.length-1;ne>=0;--ne){var Se,Ht=J[ne];if(Ht==="[]"&&yt.parseArrays)Se=yt.allowEmptyArrays&&(kt===""||yt.strictNullHandling&&kt===null)?[]:R.combine([],kt);else{Se=yt.plainObjects?{__proto__:null}:{};var Le=Ht.charAt(0)==="["&&Ht.charAt(Ht.length-1)==="]"?Ht.slice(1,-1):Ht,ee=yt.decodeDotInKeys?Le.replace(/%2E/g,"."):Le,si=parseInt(ee,10);!yt.parseArrays&&ee===""?Se={0:kt}:!isNaN(si)&&Ht!==ee&&String(si)===ee&&si>=0&&yt.parseArrays&&si<=yt.arrayLimit?(Se=[],Se[si]=kt):ee!=="__proto__"&&(Se[ee]=kt)}kt=Se}return kt},z=function(tt,yt,At,gt){if(tt){var Et=At.allowDots?tt.replace(/\.([^.[]+)/g,"[$1]"):tt,kt=/(\[[^[\]]*])/,ne=/(\[[^[\]]*])/g,Se=At.depth>0&&kt.exec(Et),Ht=Se?Et.slice(0,Se.index):Et,Le=[];if(Ht){if(!At.plainObjects&&T.call(Object.prototype,Ht)&&!At.allowPrototypes)return;Le.push(Ht)}for(var ee=0;At.depth>0&&(Se=ne.exec(Et))!==null&&ee<At.depth;){if(ee+=1,!At.plainObjects&&T.call(Object.prototype,Se[1].slice(1,-1))&&!At.allowPrototypes)return;Le.push(Se[1])}if(Se){if(At.strictDepth===!0)throw new RangeError("Input depth exceeded depth option of "+At.depth+" and strictDepth is true");Le.push("["+Et.slice(Se.index)+"]")}return G(Le,yt,At,gt)}},Q=function(tt){if(!tt)return P;if(typeof tt.allowEmptyArrays<"u"&&typeof tt.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof tt.decodeDotInKeys<"u"&&typeof tt.decodeDotInKeys!="boolean")throw new TypeError("`decodeDotInKeys` option can only be `true` or `false`, when provided");if(tt.decoder!==null&&typeof tt.decoder<"u"&&typeof tt.decoder!="function")throw new TypeError("Decoder has to be a function.");if(typeof tt.charset<"u"&&tt.charset!=="utf-8"&&tt.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");if(typeof tt.throwOnLimitExceeded<"u"&&typeof tt.throwOnLimitExceeded!="boolean")throw new TypeError("`throwOnLimitExceeded` option must be a boolean");var yt=typeof tt.charset>"u"?P.charset:tt.charset,At=typeof tt.duplicates>"u"?P.duplicates:tt.duplicates;if(At!=="combine"&&At!=="first"&&At!=="last")throw new TypeError("The duplicates option must be either combine, first, or last");var gt=typeof tt.allowDots>"u"?tt.decodeDotInKeys===!0?!0:P.allowDots:!!tt.allowDots;return{allowDots:gt,allowEmptyArrays:typeof tt.allowEmptyArrays=="boolean"?!!tt.allowEmptyArrays:P.allowEmptyArrays,allowPrototypes:typeof tt.allowPrototypes=="boolean"?tt.allowPrototypes:P.allowPrototypes,allowSparse:typeof tt.allowSparse=="boolean"?tt.allowSparse:P.allowSparse,arrayLimit:typeof tt.arrayLimit=="number"?tt.arrayLimit:P.arrayLimit,charset:yt,charsetSentinel:typeof tt.charsetSentinel=="boolean"?tt.charsetSentinel:P.charsetSentinel,comma:typeof tt.comma=="boolean"?tt.comma:P.comma,decodeDotInKeys:typeof tt.decodeDotInKeys=="boolean"?tt.decodeDotInKeys:P.decodeDotInKeys,decoder:typeof tt.decoder=="function"?tt.decoder:P.decoder,delimiter:typeof tt.delimiter=="string"||R.isRegExp(tt.delimiter)?tt.delimiter:P.delimiter,depth:typeof tt.depth=="number"||tt.depth===!1?+tt.depth:P.depth,duplicates:At,ignoreQueryPrefix:tt.ignoreQueryPrefix===!0,interpretNumericEntities:typeof tt.interpretNumericEntities=="boolean"?tt.interpretNumericEntities:P.interpretNumericEntities,parameterLimit:typeof tt.parameterLimit=="number"?tt.parameterLimit:P.parameterLimit,parseArrays:tt.parseArrays!==!1,plainObjects:typeof tt.plainObjects=="boolean"?tt.plainObjects:P.plainObjects,strictDepth:typeof tt.strictDepth=="boolean"?!!tt.strictDepth:P.strictDepth,strictNullHandling:typeof tt.strictNullHandling=="boolean"?tt.strictNullHandling:P.strictNullHandling,throwOnLimitExceeded:typeof tt.throwOnLimitExceeded=="boolean"?tt.throwOnLimitExceeded:!1}};return parse=function(J,tt){var yt=Q(tt);if(J===""||J===null||typeof J>"u")return yt.plainObjects?{__proto__:null}:{};for(var At=typeof J=="string"?q(J,yt):J,gt=yt.plainObjects?{__proto__:null}:{},Et=Object.keys(At),kt=0;kt<Et.length;++kt){var ne=Et[kt],Se=z(ne,At[ne],yt,typeof J=="string");gt=R.merge(gt,Se,yt)}return yt.allowSparse===!0?gt:R.compact(gt)},parse}var lib,hasRequiredLib;function requireLib(){if(hasRequiredLib)return lib;hasRequiredLib=1;var R=requireStringify(),T=requireParse(),L=requireFormats();return lib={formats:L,parse:T,stringify:R},lib}var hasRequiredUrl;function requireUrl(){if(hasRequiredUrl)return url;hasRequiredUrl=1;var R=requirePunycode();function T(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var L=/^([a-z0-9.+-]+:)/i,P=/:[0-9]*$/,I=/^(\/\/?(?!\/)[^?\s]*)(\?[^\s]*)?$/,F=["<",">",'"',"`"," ","\r",`
`,"	"],D=["{","}","|","\\","^","`"].concat(F),V=["'"].concat(D),q=["%","/","?",";","#"].concat(V),G=["/","?","#"],z=255,Q=/^[+a-z0-9A-Z_-]{0,63}$/,J=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,tt={javascript:!0,"javascript:":!0},yt={javascript:!0,"javascript:":!0},At={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},gt=requireLib();function Et(Ht,Le,ee){if(Ht&&typeof Ht=="object"&&Ht instanceof T)return Ht;var si=new T;return si.parse(Ht,Le,ee),si}T.prototype.parse=function(Ht,Le,ee){if(typeof Ht!="string")throw new TypeError("Parameter 'url' must be a string, not "+typeof Ht);var si=Ht.indexOf("?"),ci=si!==-1&&si<Ht.indexOf("#")?"?":"#",di=Ht.split(ci),ui=/\\/g;di[0]=di[0].replace(ui,"/"),Ht=di.join(ci);var ei=Ht;if(ei=ei.trim(),!ee&&Ht.split("#").length===1){var bi=I.exec(ei);if(bi)return this.path=ei,this.href=ei,this.pathname=bi[1],bi[2]?(this.search=bi[2],Le?this.query=gt.parse(this.search.substr(1)):this.query=this.search.substr(1)):Le&&(this.search="",this.query={}),this}var yi=L.exec(ei);if(yi){yi=yi[0];var gi=yi.toLowerCase();this.protocol=gi,ei=ei.substr(yi.length)}if(ee||yi||ei.match(/^\/\/[^@/]+@[^@/]+/)){var we=ei.substr(0,2)==="//";we&&!(yi&&yt[yi])&&(ei=ei.substr(2),this.slashes=!0)}if(!yt[yi]&&(we||yi&&!At[yi])){for(var Ge=-1,Te=0;Te<G.length;Te++){var ri=ei.indexOf(G[Te]);ri!==-1&&(Ge===-1||ri<Ge)&&(Ge=ri)}var ti,ii;Ge===-1?ii=ei.lastIndexOf("@"):ii=ei.lastIndexOf("@",Ge),ii!==-1&&(ti=ei.slice(0,ii),ei=ei.slice(ii+1),this.auth=decodeURIComponent(ti)),Ge=-1;for(var Te=0;Te<q.length;Te++){var ri=ei.indexOf(q[Te]);ri!==-1&&(Ge===-1||ri<Ge)&&(Ge=ri)}Ge===-1&&(Ge=ei.length),this.host=ei.slice(0,Ge),ei=ei.slice(Ge),this.parseHost(),this.hostname=this.hostname||"";var oi=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!oi)for(var ai=this.hostname.split(/\./),Te=0,fi=ai.length;Te<fi;Te++){var mi=ai[Te];if(mi&&!mi.match(Q)){for(var _i="",Si=0,Ti=mi.length;Si<Ti;Si++)mi.charCodeAt(Si)>127?_i+="x":_i+=mi[Si];if(!_i.match(Q)){var Ei=ai.slice(0,Te),vi=ai.slice(Te+1),Ai=mi.match(J);Ai&&(Ei.push(Ai[1]),vi.unshift(Ai[2])),vi.length&&(ei="/"+vi.join(".")+ei),this.hostname=Ei.join(".");break}}}this.hostname.length>z?this.hostname="":this.hostname=this.hostname.toLowerCase(),oi||(this.hostname=R.toASCII(this.hostname));var Li=this.port?":"+this.port:"",Mi=this.hostname||"";this.host=Mi+Li,this.href+=this.host,oi&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),ei[0]!=="/"&&(ei="/"+ei))}if(!tt[gi])for(var Te=0,fi=V.length;Te<fi;Te++){var Pi=V[Te];if(ei.indexOf(Pi)!==-1){var xi=encodeURIComponent(Pi);xi===Pi&&(xi=escape(Pi)),ei=ei.split(Pi).join(xi)}}var wi=ei.indexOf("#");wi!==-1&&(this.hash=ei.substr(wi),ei=ei.slice(0,wi));var Bi=ei.indexOf("?");if(Bi!==-1?(this.search=ei.substr(Bi),this.query=ei.substr(Bi+1),Le&&(this.query=gt.parse(this.query)),ei=ei.slice(0,Bi)):Le&&(this.search="",this.query={}),ei&&(this.pathname=ei),At[gi]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var Li=this.pathname||"",Di=this.search||"";this.path=Li+Di}return this.href=this.format(),this};function kt(Ht){return typeof Ht=="string"&&(Ht=Et(Ht)),Ht instanceof T?Ht.format():T.prototype.format.call(Ht)}T.prototype.format=function(){var Ht=this.auth||"";Ht&&(Ht=encodeURIComponent(Ht),Ht=Ht.replace(/%3A/i,":"),Ht+="@");var Le=this.protocol||"",ee=this.pathname||"",si=this.hash||"",ci=!1,di="";this.host?ci=Ht+this.host:this.hostname&&(ci=Ht+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(ci+=":"+this.port)),this.query&&typeof this.query=="object"&&Object.keys(this.query).length&&(di=gt.stringify(this.query,{arrayFormat:"repeat",addQueryPrefix:!1}));var ui=this.search||di&&"?"+di||"";return Le&&Le.substr(-1)!==":"&&(Le+=":"),this.slashes||(!Le||At[Le])&&ci!==!1?(ci="//"+(ci||""),ee&&ee.charAt(0)!=="/"&&(ee="/"+ee)):ci||(ci=""),si&&si.charAt(0)!=="#"&&(si="#"+si),ui&&ui.charAt(0)!=="?"&&(ui="?"+ui),ee=ee.replace(/[?#]/g,function(ei){return encodeURIComponent(ei)}),ui=ui.replace("#","%23"),Le+ci+ee+ui+si};function ne(Ht,Le){return Et(Ht,!1,!0).resolve(Le)}T.prototype.resolve=function(Ht){return this.resolveObject(Et(Ht,!1,!0)).format()};function Se(Ht,Le){return Ht?Et(Ht,!1,!0).resolveObject(Le):Le}return T.prototype.resolveObject=function(Ht){if(typeof Ht=="string"){var Le=new T;Le.parse(Ht,!1,!0),Ht=Le}for(var ee=new T,si=Object.keys(this),ci=0;ci<si.length;ci++){var di=si[ci];ee[di]=this[di]}if(ee.hash=Ht.hash,Ht.href==="")return ee.href=ee.format(),ee;if(Ht.slashes&&!Ht.protocol){for(var ui=Object.keys(Ht),ei=0;ei<ui.length;ei++){var bi=ui[ei];bi!=="protocol"&&(ee[bi]=Ht[bi])}return At[ee.protocol]&&ee.hostname&&!ee.pathname&&(ee.pathname="/",ee.path=ee.pathname),ee.href=ee.format(),ee}if(Ht.protocol&&Ht.protocol!==ee.protocol){if(!At[Ht.protocol]){for(var yi=Object.keys(Ht),gi=0;gi<yi.length;gi++){var we=yi[gi];ee[we]=Ht[we]}return ee.href=ee.format(),ee}if(ee.protocol=Ht.protocol,!Ht.host&&!yt[Ht.protocol]){for(var fi=(Ht.pathname||"").split("/");fi.length&&!(Ht.host=fi.shift()););Ht.host||(Ht.host=""),Ht.hostname||(Ht.hostname=""),fi[0]!==""&&fi.unshift(""),fi.length<2&&fi.unshift(""),ee.pathname=fi.join("/")}else ee.pathname=Ht.pathname;if(ee.search=Ht.search,ee.query=Ht.query,ee.host=Ht.host||"",ee.auth=Ht.auth,ee.hostname=Ht.hostname||Ht.host,ee.port=Ht.port,ee.pathname||ee.search){var Ge=ee.pathname||"",Te=ee.search||"";ee.path=Ge+Te}return ee.slashes=ee.slashes||Ht.slashes,ee.href=ee.format(),ee}var ri=ee.pathname&&ee.pathname.charAt(0)==="/",ti=Ht.host||Ht.pathname&&Ht.pathname.charAt(0)==="/",ii=ti||ri||ee.host&&Ht.pathname,oi=ii,ai=ee.pathname&&ee.pathname.split("/")||[],fi=Ht.pathname&&Ht.pathname.split("/")||[],mi=ee.protocol&&!At[ee.protocol];if(mi&&(ee.hostname="",ee.port=null,ee.host&&(ai[0]===""?ai[0]=ee.host:ai.unshift(ee.host)),ee.host="",Ht.protocol&&(Ht.hostname=null,Ht.port=null,Ht.host&&(fi[0]===""?fi[0]=Ht.host:fi.unshift(Ht.host)),Ht.host=null),ii=ii&&(fi[0]===""||ai[0]==="")),ti)ee.host=Ht.host||Ht.host===""?Ht.host:ee.host,ee.hostname=Ht.hostname||Ht.hostname===""?Ht.hostname:ee.hostname,ee.search=Ht.search,ee.query=Ht.query,ai=fi;else if(fi.length)ai||(ai=[]),ai.pop(),ai=ai.concat(fi),ee.search=Ht.search,ee.query=Ht.query;else if(Ht.search!=null){if(mi){ee.host=ai.shift(),ee.hostname=ee.host;var _i=ee.host&&ee.host.indexOf("@")>0?ee.host.split("@"):!1;_i&&(ee.auth=_i.shift(),ee.hostname=_i.shift(),ee.host=ee.hostname)}return ee.search=Ht.search,ee.query=Ht.query,(ee.pathname!==null||ee.search!==null)&&(ee.path=(ee.pathname?ee.pathname:"")+(ee.search?ee.search:"")),ee.href=ee.format(),ee}if(!ai.length)return ee.pathname=null,ee.search?ee.path="/"+ee.search:ee.path=null,ee.href=ee.format(),ee;for(var Si=ai.slice(-1)[0],Ti=(ee.host||Ht.host||ai.length>1)&&(Si==="."||Si==="..")||Si==="",Ei=0,vi=ai.length;vi>=0;vi--)Si=ai[vi],Si==="."?ai.splice(vi,1):Si===".."?(ai.splice(vi,1),Ei++):Ei&&(ai.splice(vi,1),Ei--);if(!ii&&!oi)for(;Ei--;Ei)ai.unshift("..");ii&&ai[0]!==""&&(!ai[0]||ai[0].charAt(0)!=="/")&&ai.unshift(""),Ti&&ai.join("/").substr(-1)!=="/"&&ai.push("");var Ai=ai[0]===""||ai[0]&&ai[0].charAt(0)==="/";if(mi){ee.hostname=Ai?"":ai.length?ai.shift():"",ee.host=ee.hostname;var _i=ee.host&&ee.host.indexOf("@")>0?ee.host.split("@"):!1;_i&&(ee.auth=_i.shift(),ee.hostname=_i.shift(),ee.host=ee.hostname)}return ii=ii||ee.host&&ai.length,ii&&!Ai&&ai.unshift(""),ai.length>0?ee.pathname=ai.join("/"):(ee.pathname=null,ee.path=null),(ee.pathname!==null||ee.search!==null)&&(ee.path=(ee.pathname?ee.pathname:"")+(ee.search?ee.search:"")),ee.auth=Ht.auth||ee.auth,ee.slashes=ee.slashes||Ht.slashes,ee.href=ee.format(),ee},T.prototype.parseHost=function(){var Ht=this.host,Le=P.exec(Ht);Le&&(Le=Le[0],Le!==":"&&(this.port=Le.substr(1)),Ht=Ht.substr(0,Ht.length-Le.length)),Ht&&(this.hostname=Ht)},url.parse=Et,url.resolve=ne,url.resolveObject=Se,url.format=kt,url.Url=T,url}requireUrl();const warnings={};function deprecation(R,T,L=3){if(warnings[T])return;let P=new Error().stack;typeof P>"u"?console.warn("PixiJS Deprecation Warning: ",`${T}
Deprecated since v${R}`):(P=P.split(`
`).splice(L).join(`
`),console.groupCollapsed?(console.groupCollapsed("%cPixiJS Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",`${T}
Deprecated since v${R}`),console.warn(P),console.groupEnd()):(console.warn("PixiJS Deprecation Warning: ",`${T}
Deprecated since v${R}`),console.warn(P))),warnings[T]=!0}let supported;function isWebGLSupported(){return typeof supported>"u"&&(supported=(function(){const R={stencil:!0,failIfMajorPerformanceCaveat:settings.FAIL_IF_MAJOR_PERFORMANCE_CAVEAT};try{if(!settings.ADAPTER.getWebGLRenderingContext())return!1;const T=settings.ADAPTER.createCanvas();let L=T.getContext("webgl",R)||T.getContext("experimental-webgl",R);const P=!!L?.getContextAttributes()?.stencil;if(L){const I=L.getExtension("WEBGL_lose_context");I&&I.loseContext()}return L=null,P}catch{return!1}})()),supported}var r={grad:.9,turn:360,rad:360/(2*Math.PI)},t$1=function(R){return typeof R=="string"?R.length>0:typeof R=="number"},n$1=function(R,T,L){return T===void 0&&(T=0),L===void 0&&(L=Math.pow(10,T)),Math.round(L*R)/L+0},e=function(R,T,L){return T===void 0&&(T=0),L===void 0&&(L=1),R>L?L:R>T?R:T},u$1=function(R){return(R=isFinite(R)?R%360:0)>0?R:R+360},a=function(R){return{r:e(R.r,0,255),g:e(R.g,0,255),b:e(R.b,0,255),a:e(R.a)}},o=function(R){return{r:n$1(R.r),g:n$1(R.g),b:n$1(R.b),a:n$1(R.a,3)}},i$1=/^#([0-9a-f]{3,8})$/i,s=function(R){var T=R.toString(16);return T.length<2?"0"+T:T},h=function(R){var T=R.r,L=R.g,P=R.b,I=R.a,F=Math.max(T,L,P),D=F-Math.min(T,L,P),V=D?F===T?(L-P)/D:F===L?2+(P-T)/D:4+(T-L)/D:0;return{h:60*(V<0?V+6:V),s:F?D/F*100:0,v:F/255*100,a:I}},b=function(R){var T=R.h,L=R.s,P=R.v,I=R.a;T=T/360*6,L/=100,P/=100;var F=Math.floor(T),D=P*(1-L),V=P*(1-(T-F)*L),q=P*(1-(1-T+F)*L),G=F%6;return{r:255*[P,V,D,D,q,P][G],g:255*[q,P,P,V,D,D][G],b:255*[D,D,q,P,P,V][G],a:I}},g=function(R){return{h:u$1(R.h),s:e(R.s,0,100),l:e(R.l,0,100),a:e(R.a)}},d$1=function(R){return{h:n$1(R.h),s:n$1(R.s),l:n$1(R.l),a:n$1(R.a,3)}},f$1=function(R){return b((L=(T=R).s,{h:T.h,s:(L*=((P=T.l)<50?P:100-P)/100)>0?2*L/(P+L)*100:0,v:P+L,a:T.a}));var T,L,P},c=function(R){return{h:(T=h(R)).h,s:(I=(200-(L=T.s))*(P=T.v)/100)>0&&I<200?L*P/100/(I<=100?I:200-I)*100:0,l:I/2,a:T.a};var T,L,P,I},l=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,p=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,v=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,m=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,y={string:[[function(R){var T=i$1.exec(R);return T?(R=T[1]).length<=4?{r:parseInt(R[0]+R[0],16),g:parseInt(R[1]+R[1],16),b:parseInt(R[2]+R[2],16),a:R.length===4?n$1(parseInt(R[3]+R[3],16)/255,2):1}:R.length===6||R.length===8?{r:parseInt(R.substr(0,2),16),g:parseInt(R.substr(2,2),16),b:parseInt(R.substr(4,2),16),a:R.length===8?n$1(parseInt(R.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(R){var T=v.exec(R)||m.exec(R);return T?T[2]!==T[4]||T[4]!==T[6]?null:a({r:Number(T[1])/(T[2]?100/255:1),g:Number(T[3])/(T[4]?100/255:1),b:Number(T[5])/(T[6]?100/255:1),a:T[7]===void 0?1:Number(T[7])/(T[8]?100:1)}):null},"rgb"],[function(R){var T=l.exec(R)||p.exec(R);if(!T)return null;var L,P,I=g({h:(L=T[1],P=T[2],P===void 0&&(P="deg"),Number(L)*(r[P]||1)),s:Number(T[3]),l:Number(T[4]),a:T[5]===void 0?1:Number(T[5])/(T[6]?100:1)});return f$1(I)},"hsl"]],object:[[function(R){var T=R.r,L=R.g,P=R.b,I=R.a,F=I===void 0?1:I;return t$1(T)&&t$1(L)&&t$1(P)?a({r:Number(T),g:Number(L),b:Number(P),a:Number(F)}):null},"rgb"],[function(R){var T=R.h,L=R.s,P=R.l,I=R.a,F=I===void 0?1:I;if(!t$1(T)||!t$1(L)||!t$1(P))return null;var D=g({h:Number(T),s:Number(L),l:Number(P),a:Number(F)});return f$1(D)},"hsl"],[function(R){var T=R.h,L=R.s,P=R.v,I=R.a,F=I===void 0?1:I;if(!t$1(T)||!t$1(L)||!t$1(P))return null;var D=(function(V){return{h:u$1(V.h),s:e(V.s,0,100),v:e(V.v,0,100),a:e(V.a)}})({h:Number(T),s:Number(L),v:Number(P),a:Number(F)});return b(D)},"hsv"]]},N$1=function(R,T){for(var L=0;L<T.length;L++){var P=T[L][0](R);if(P)return[P,T[L][1]]}return[null,void 0]},x=function(R){return typeof R=="string"?N$1(R.trim(),y.string):typeof R=="object"&&R!==null?N$1(R,y.object):[null,void 0]},M=function(R,T){var L=c(R);return{h:L.h,s:e(L.s+100*T,0,100),l:L.l,a:L.a}},H$1=function(R){return(299*R.r+587*R.g+114*R.b)/1e3/255},$=function(R,T){var L=c(R);return{h:L.h,s:L.s,l:e(L.l+100*T,0,100),a:L.a}},j$1=(function(){function R(T){this.parsed=x(T)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return R.prototype.isValid=function(){return this.parsed!==null},R.prototype.brightness=function(){return n$1(H$1(this.rgba),2)},R.prototype.isDark=function(){return H$1(this.rgba)<.5},R.prototype.isLight=function(){return H$1(this.rgba)>=.5},R.prototype.toHex=function(){return T=o(this.rgba),L=T.r,P=T.g,I=T.b,D=(F=T.a)<1?s(n$1(255*F)):"","#"+s(L)+s(P)+s(I)+D;var T,L,P,I,F,D},R.prototype.toRgb=function(){return o(this.rgba)},R.prototype.toRgbString=function(){return T=o(this.rgba),L=T.r,P=T.g,I=T.b,(F=T.a)<1?"rgba("+L+", "+P+", "+I+", "+F+")":"rgb("+L+", "+P+", "+I+")";var T,L,P,I,F},R.prototype.toHsl=function(){return d$1(c(this.rgba))},R.prototype.toHslString=function(){return T=d$1(c(this.rgba)),L=T.h,P=T.s,I=T.l,(F=T.a)<1?"hsla("+L+", "+P+"%, "+I+"%, "+F+")":"hsl("+L+", "+P+"%, "+I+"%)";var T,L,P,I,F},R.prototype.toHsv=function(){return T=h(this.rgba),{h:n$1(T.h),s:n$1(T.s),v:n$1(T.v),a:n$1(T.a,3)};var T},R.prototype.invert=function(){return w({r:255-(T=this.rgba).r,g:255-T.g,b:255-T.b,a:T.a});var T},R.prototype.saturate=function(T){return T===void 0&&(T=.1),w(M(this.rgba,T))},R.prototype.desaturate=function(T){return T===void 0&&(T=.1),w(M(this.rgba,-T))},R.prototype.grayscale=function(){return w(M(this.rgba,-1))},R.prototype.lighten=function(T){return T===void 0&&(T=.1),w($(this.rgba,T))},R.prototype.darken=function(T){return T===void 0&&(T=.1),w($(this.rgba,-T))},R.prototype.rotate=function(T){return T===void 0&&(T=15),this.hue(this.hue()+T)},R.prototype.alpha=function(T){return typeof T=="number"?w({r:(L=this.rgba).r,g:L.g,b:L.b,a:T}):n$1(this.rgba.a,3);var L},R.prototype.hue=function(T){var L=c(this.rgba);return typeof T=="number"?w({h:T,s:L.s,l:L.l,a:L.a}):n$1(L.h)},R.prototype.isEqual=function(T){return this.toHex()===w(T).toHex()},R})(),w=function(R){return R instanceof j$1?R:new j$1(R)},S=[],k=function(R){R.forEach(function(T){S.indexOf(T)<0&&(T(j$1,y),S.push(T))})};function namesPlugin(R,T){var L={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},P={};for(var I in L)P[L[I]]=I;var F={};R.prototype.toName=function(D){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var V,q,G=P[this.toHex()];if(G)return G;if(D?.closest){var z=this.toRgb(),Q=1/0,J="black";if(!F.length)for(var tt in L)F[tt]=new R(L[tt]).toRgb();for(var yt in L){var At=(V=z,q=F[yt],Math.pow(V.r-q.r,2)+Math.pow(V.g-q.g,2)+Math.pow(V.b-q.b,2));At<Q&&(Q=At,J=yt)}return J}},T.string.push([function(D){var V=D.toLowerCase(),q=V==="transparent"?"#0000":L[V];return q?new R(q).toRgb():null},"name"])}k([namesPlugin]);const _Color=class qs{constructor(T=16777215){this._value=null,this._components=new Float32Array(4),this._components.fill(1),this._int=16777215,this.value=T}get red(){return this._components[0]}get green(){return this._components[1]}get blue(){return this._components[2]}get alpha(){return this._components[3]}setValue(T){return this.value=T,this}set value(T){if(T instanceof qs)this._value=this.cloneSource(T._value),this._int=T._int,this._components.set(T._components);else{if(T===null)throw new Error("Cannot set PIXI.Color#value to null");(this._value===null||!this.isSourceEqual(this._value,T))&&(this.normalize(T),this._value=this.cloneSource(T))}}get value(){return this._value}cloneSource(T){return typeof T=="string"||typeof T=="number"||T instanceof Number||T===null?T:Array.isArray(T)||ArrayBuffer.isView(T)?T.slice(0):typeof T=="object"&&T!==null?{...T}:T}isSourceEqual(T,L){const P=typeof T;if(P!==typeof L)return!1;if(P==="number"||P==="string"||T instanceof Number)return T===L;if(Array.isArray(T)&&Array.isArray(L)||ArrayBuffer.isView(T)&&ArrayBuffer.isView(L))return T.length!==L.length?!1:T.every((I,F)=>I===L[F]);if(T!==null&&L!==null){const I=Object.keys(T),F=Object.keys(L);return I.length!==F.length?!1:I.every(D=>T[D]===L[D])}return T===L}toRgba(){const[T,L,P,I]=this._components;return{r:T,g:L,b:P,a:I}}toRgb(){const[T,L,P]=this._components;return{r:T,g:L,b:P}}toRgbaString(){const[T,L,P]=this.toUint8RgbArray();return`rgba(${T},${L},${P},${this.alpha})`}toUint8RgbArray(T){const[L,P,I]=this._components;return T=T??[],T[0]=Math.round(L*255),T[1]=Math.round(P*255),T[2]=Math.round(I*255),T}toRgbArray(T){T=T??[];const[L,P,I]=this._components;return T[0]=L,T[1]=P,T[2]=I,T}toNumber(){return this._int}toLittleEndianNumber(){const T=this._int;return(T>>16)+(T&65280)+((T&255)<<16)}multiply(T){const[L,P,I,F]=qs.temp.setValue(T)._components;return this._components[0]*=L,this._components[1]*=P,this._components[2]*=I,this._components[3]*=F,this.refreshInt(),this._value=null,this}premultiply(T,L=!0){return L&&(this._components[0]*=T,this._components[1]*=T,this._components[2]*=T),this._components[3]=T,this.refreshInt(),this._value=null,this}toPremultiplied(T,L=!0){if(T===1)return(255<<24)+this._int;if(T===0)return L?0:this._int;let P=this._int>>16&255,I=this._int>>8&255,F=this._int&255;return L&&(P=P*T+.5|0,I=I*T+.5|0,F=F*T+.5|0),(T*255<<24)+(P<<16)+(I<<8)+F}toHex(){const T=this._int.toString(16);return`#${"000000".substring(0,6-T.length)+T}`}toHexa(){const T=Math.round(this._components[3]*255).toString(16);return this.toHex()+"00".substring(0,2-T.length)+T}setAlpha(T){return this._components[3]=this._clamp(T),this}round(T){const[L,P,I]=this._components;return this._components[0]=Math.round(L*T)/T,this._components[1]=Math.round(P*T)/T,this._components[2]=Math.round(I*T)/T,this.refreshInt(),this._value=null,this}toArray(T){T=T??[];const[L,P,I,F]=this._components;return T[0]=L,T[1]=P,T[2]=I,T[3]=F,T}normalize(T){let L,P,I,F;if((typeof T=="number"||T instanceof Number)&&T>=0&&T<=16777215){const D=T;L=(D>>16&255)/255,P=(D>>8&255)/255,I=(D&255)/255,F=1}else if((Array.isArray(T)||T instanceof Float32Array)&&T.length>=3&&T.length<=4)T=this._clamp(T),[L,P,I,F=1]=T;else if((T instanceof Uint8Array||T instanceof Uint8ClampedArray)&&T.length>=3&&T.length<=4)T=this._clamp(T,0,255),[L,P,I,F=255]=T,L/=255,P/=255,I/=255,F/=255;else if(typeof T=="string"||typeof T=="object"){if(typeof T=="string"){const V=qs.HEX_PATTERN.exec(T);V&&(T=`#${V[2]}`)}const D=w(T);D.isValid()&&({r:L,g:P,b:I,a:F}=D.rgba,L/=255,P/=255,I/=255)}if(L!==void 0)this._components[0]=L,this._components[1]=P,this._components[2]=I,this._components[3]=F,this.refreshInt();else throw new Error(`Unable to convert color ${T}`)}refreshInt(){this._clamp(this._components);const[T,L,P]=this._components;this._int=(T*255<<16)+(L*255<<8)+(P*255|0)}_clamp(T,L=0,P=1){return typeof T=="number"?Math.min(Math.max(T,L),P):(T.forEach((I,F)=>{T[F]=Math.min(Math.max(I,L),P)}),T)}};_Color.shared=new _Color,_Color.temp=new _Color,_Color.HEX_PATTERN=/^(#|0x)?(([a-f0-9]{3}){1,2}([a-f0-9]{2})?)$/i;let Color=_Color;function mapPremultipliedBlendModes(){const R=[],T=[];for(let P=0;P<32;P++)R[P]=P,T[P]=P;R[BLEND_MODES.NORMAL_NPM]=BLEND_MODES.NORMAL,R[BLEND_MODES.ADD_NPM]=BLEND_MODES.ADD,R[BLEND_MODES.SCREEN_NPM]=BLEND_MODES.SCREEN,T[BLEND_MODES.NORMAL]=BLEND_MODES.NORMAL_NPM,T[BLEND_MODES.ADD]=BLEND_MODES.ADD_NPM,T[BLEND_MODES.SCREEN]=BLEND_MODES.SCREEN_NPM;const L=[];return L.push(T),L.push(R),L}const premultiplyBlendMode=mapPremultipliedBlendModes();function getBufferType(R){if(R.BYTES_PER_ELEMENT===4)return R instanceof Float32Array?"Float32Array":R instanceof Uint32Array?"Uint32Array":"Int32Array";if(R.BYTES_PER_ELEMENT===2){if(R instanceof Uint16Array)return"Uint16Array"}else if(R.BYTES_PER_ELEMENT===1&&R instanceof Uint8Array)return"Uint8Array";return null}function nextPow2(R){return R+=R===0?1:0,--R,R|=R>>>1,R|=R>>>2,R|=R>>>4,R|=R>>>8,R|=R>>>16,R+1}function isPow2(R){return!(R&R-1)&&!!R}function log2(R){let T=(R>65535?1:0)<<4;R>>>=T;let L=(R>255?1:0)<<3;return R>>>=L,T|=L,L=(R>15?1:0)<<2,R>>>=L,T|=L,L=(R>3?1:0)<<1,R>>>=L,T|=L,T|R>>1}function removeItems(R,T,L){const P=R.length;let I;if(T>=P||L===0)return;L=T+L>P?P-T:L;const F=P-L;for(I=T;I<F;++I)R[I]=R[I+L];R.length=F}let nextUid=0;function uid(){return++nextUid}const ProgramCache={},TextureCache=Object.create(null),BaseTextureCache=Object.create(null);function determineCrossOrigin(R,T=globalThis.location){if(R.startsWith("data:"))return"";T=T||globalThis.location;const L=new URL(R,document.baseURI);return L.hostname!==T.hostname||L.port!==T.port||L.protocol!==T.protocol?"anonymous":""}function getResolutionOfUrl(R,T=1){const L=settings.RETINA_PREFIX?.exec(R);return L?parseFloat(L[1]):T}var ExtensionType=(R=>(R.Renderer="renderer",R.Application="application",R.RendererSystem="renderer-webgl-system",R.RendererPlugin="renderer-webgl-plugin",R.CanvasRendererSystem="renderer-canvas-system",R.CanvasRendererPlugin="renderer-canvas-plugin",R.Asset="asset",R.LoadParser="load-parser",R.ResolveParser="resolve-parser",R.CacheParser="cache-parser",R.DetectionParser="detection-parser",R))(ExtensionType||{});const normalizeExtension=R=>{if(typeof R=="function"||typeof R=="object"&&R.extension){if(!R.extension)throw new Error("Extension class must have an extension object");R={...typeof R.extension!="object"?{type:R.extension}:R.extension,ref:R}}if(typeof R=="object")R={...R};else throw new Error("Invalid extension type");return typeof R.type=="string"&&(R.type=[R.type]),R},normalizePriority=(R,T)=>normalizeExtension(R).priority??T,extensions={_addHandlers:{},_removeHandlers:{},_queue:{},remove(...R){return R.map(normalizeExtension).forEach(T=>{T.type.forEach(L=>this._removeHandlers[L]?.(T))}),this},add(...R){return R.map(normalizeExtension).forEach(T=>{T.type.forEach(L=>{const P=this._addHandlers,I=this._queue;P[L]?P[L]?.(T):(I[L]=I[L]||[],I[L]?.push(T))})}),this},handle(R,T,L){const P=this._addHandlers,I=this._removeHandlers;if(P[R]||I[R])throw new Error(`Extension type ${R} already has a handler`);P[R]=T,I[R]=L;const F=this._queue;return F[R]&&(F[R]?.forEach(D=>T(D)),delete F[R]),this},handleByMap(R,T){return this.handle(R,L=>{L.name&&(T[L.name]=L.ref)},L=>{L.name&&delete T[L.name]})},handleByList(R,T,L=-1){return this.handle(R,P=>{T.includes(P.ref)||(T.push(P.ref),T.sort((I,F)=>normalizePriority(F,L)-normalizePriority(I,L)))},P=>{const I=T.indexOf(P.ref);I!==-1&&T.splice(I,1)})}};class ViewableBuffer{constructor(T){typeof T=="number"?this.rawBinaryData=new ArrayBuffer(T):T instanceof Uint8Array?this.rawBinaryData=T.buffer:this.rawBinaryData=T,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData)}get int8View(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View}get uint8View(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View}get int16View(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View}get uint16View(){return this._uint16View||(this._uint16View=new Uint16Array(this.rawBinaryData)),this._uint16View}get int32View(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View}view(T){return this[`${T}View`]}destroy(){this.rawBinaryData=null,this._int8View=null,this._uint8View=null,this._int16View=null,this._uint16View=null,this._int32View=null,this.uint32View=null,this.float32View=null}static sizeOf(T){switch(T){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(`${T} isn't a valid view type`)}}}const fragTemplate=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join(`
`);function generateIfTestSrc(R){let T="";for(let L=0;L<R;++L)L>0&&(T+=`
else `),L<R-1&&(T+=`if(test == ${L}.0){}`);return T}function checkMaxIfStatementsInShader(R,T){if(R===0)throw new Error("Invalid value of `0` passed to `checkMaxIfStatementsInShader`");const L=T.createShader(T.FRAGMENT_SHADER);for(;;){const P=fragTemplate.replace(/%forloop%/gi,generateIfTestSrc(R));if(T.shaderSource(L,P),T.compileShader(L),!T.getShaderParameter(L,T.COMPILE_STATUS))R=R/2|0;else break}return R}const BLEND$1=0,OFFSET$1=1,CULLING$1=2,DEPTH_TEST$1=3,WINDING$1=4,DEPTH_MASK$1=5;class State{constructor(){this.data=0,this.blendMode=BLEND_MODES.NORMAL,this.polygonOffset=0,this.blend=!0,this.depthMask=!0}get blend(){return!!(this.data&1<<BLEND$1)}set blend(T){!!(this.data&1<<BLEND$1)!==T&&(this.data^=1<<BLEND$1)}get offsets(){return!!(this.data&1<<OFFSET$1)}set offsets(T){!!(this.data&1<<OFFSET$1)!==T&&(this.data^=1<<OFFSET$1)}get culling(){return!!(this.data&1<<CULLING$1)}set culling(T){!!(this.data&1<<CULLING$1)!==T&&(this.data^=1<<CULLING$1)}get depthTest(){return!!(this.data&1<<DEPTH_TEST$1)}set depthTest(T){!!(this.data&1<<DEPTH_TEST$1)!==T&&(this.data^=1<<DEPTH_TEST$1)}get depthMask(){return!!(this.data&1<<DEPTH_MASK$1)}set depthMask(T){!!(this.data&1<<DEPTH_MASK$1)!==T&&(this.data^=1<<DEPTH_MASK$1)}get clockwiseFrontFace(){return!!(this.data&1<<WINDING$1)}set clockwiseFrontFace(T){!!(this.data&1<<WINDING$1)!==T&&(this.data^=1<<WINDING$1)}get blendMode(){return this._blendMode}set blendMode(T){this.blend=T!==BLEND_MODES.NONE,this._blendMode=T}get polygonOffset(){return this._polygonOffset}set polygonOffset(T){this.offsets=!!T,this._polygonOffset=T}static for2d(){const T=new State;return T.depthTest=!1,T.blend=!0,T}}State.prototype.toString=function(){return`[@pixi/core:State blendMode=${this.blendMode} clockwiseFrontFace=${this.clockwiseFrontFace} culling=${this.culling} depthMask=${this.depthMask} polygonOffset=${this.polygonOffset}]`};const INSTALLED=[];function autoDetectResource(R,T){if(!R)return null;let L="";if(typeof R=="string"){const P=/\.(\w{3,4})(?:$|\?|#)/i.exec(R);P&&(L=P[1].toLowerCase())}for(let P=INSTALLED.length-1;P>=0;--P){const I=INSTALLED[P];if(I.test&&I.test(R,L))return new I(R,T)}throw new Error("Unrecognized source type to auto-detect Resource")}class Runner{constructor(T){this.items=[],this._name=T,this._aliasCount=0}emit(T,L,P,I,F,D,V,q){if(arguments.length>8)throw new Error("max arguments reached");const{name:G,items:z}=this;this._aliasCount++;for(let Q=0,J=z.length;Q<J;Q++)z[Q][G](T,L,P,I,F,D,V,q);return z===this.items&&this._aliasCount--,this}ensureNonAliasedItems(){this._aliasCount>0&&this.items.length>1&&(this._aliasCount=0,this.items=this.items.slice(0))}add(T){return T[this._name]&&(this.ensureNonAliasedItems(),this.remove(T),this.items.push(T)),this}remove(T){const L=this.items.indexOf(T);return L!==-1&&(this.ensureNonAliasedItems(),this.items.splice(L,1)),this}contains(T){return this.items.includes(T)}removeAll(){return this.ensureNonAliasedItems(),this.items.length=0,this}destroy(){this.removeAll(),this.items.length=0,this._name=""}get empty(){return this.items.length===0}get name(){return this._name}}Object.defineProperties(Runner.prototype,{dispatch:{value:Runner.prototype.emit},run:{value:Runner.prototype.emit}});class Resource{constructor(T=0,L=0){this._width=T,this._height=L,this.destroyed=!1,this.internal=!1,this.onResize=new Runner("setRealSize"),this.onUpdate=new Runner("update"),this.onError=new Runner("onError")}bind(T){this.onResize.add(T),this.onUpdate.add(T),this.onError.add(T),(this._width||this._height)&&this.onResize.emit(this._width,this._height)}unbind(T){this.onResize.remove(T),this.onUpdate.remove(T),this.onError.remove(T)}resize(T,L){(T!==this._width||L!==this._height)&&(this._width=T,this._height=L,this.onResize.emit(T,L))}get valid(){return!!this._width&&!!this._height}update(){this.destroyed||this.onUpdate.emit()}load(){return Promise.resolve(this)}get width(){return this._width}get height(){return this._height}style(T,L,P){return!1}dispose(){}destroy(){this.destroyed||(this.destroyed=!0,this.dispose(),this.onError.removeAll(),this.onError=null,this.onResize.removeAll(),this.onResize=null,this.onUpdate.removeAll(),this.onUpdate=null)}static test(T,L){return!1}}class BufferResource extends Resource{constructor(T,L){const{width:P,height:I}=L||{};if(!P||!I)throw new Error("BufferResource width or height invalid");super(P,I),this.data=T,this.unpackAlignment=L.unpackAlignment??4}upload(T,L,P){const I=T.gl;I.pixelStorei(I.UNPACK_ALIGNMENT,this.unpackAlignment),I.pixelStorei(I.UNPACK_PREMULTIPLY_ALPHA_WEBGL,L.alphaMode===ALPHA_MODES.UNPACK);const F=L.realWidth,D=L.realHeight;return P.width===F&&P.height===D?I.texSubImage2D(L.target,0,0,0,F,D,L.format,P.type,this.data):(P.width=F,P.height=D,I.texImage2D(L.target,0,P.internalFormat,F,D,0,L.format,P.type,this.data)),!0}dispose(){this.data=null}static test(T){return T===null||T instanceof Int8Array||T instanceof Uint8Array||T instanceof Uint8ClampedArray||T instanceof Int16Array||T instanceof Uint16Array||T instanceof Int32Array||T instanceof Uint32Array||T instanceof Float32Array}}const defaultBufferOptions={scaleMode:SCALE_MODES.NEAREST,alphaMode:ALPHA_MODES.NPM},_BaseTexture=class As extends EventEmitter{constructor(T=null,L=null){super(),L=Object.assign({},As.defaultOptions,L);const{alphaMode:P,mipmap:I,anisotropicLevel:F,scaleMode:D,width:V,height:q,wrapMode:G,format:z,type:Q,target:J,resolution:tt,resourceOptions:yt}=L;T&&!(T instanceof Resource)&&(T=autoDetectResource(T,yt),T.internal=!0),this.resolution=tt||settings.RESOLUTION,this.width=Math.round((V||0)*this.resolution)/this.resolution,this.height=Math.round((q||0)*this.resolution)/this.resolution,this._mipmap=I,this.anisotropicLevel=F,this._wrapMode=G,this._scaleMode=D,this.format=z,this.type=Q,this.target=J,this.alphaMode=P,this.uid=uid(),this.touched=0,this.isPowerOfTwo=!1,this._refreshPOT(),this._glTextures={},this.dirtyId=0,this.dirtyStyleId=0,this.cacheId=null,this.valid=V>0&&q>0,this.textureCacheIds=[],this.destroyed=!1,this.resource=null,this._batchEnabled=0,this._batchLocation=0,this.parentTextureArray=null,this.setResource(T)}get realWidth(){return Math.round(this.width*this.resolution)}get realHeight(){return Math.round(this.height*this.resolution)}get mipmap(){return this._mipmap}set mipmap(T){this._mipmap!==T&&(this._mipmap=T,this.dirtyStyleId++)}get scaleMode(){return this._scaleMode}set scaleMode(T){this._scaleMode!==T&&(this._scaleMode=T,this.dirtyStyleId++)}get wrapMode(){return this._wrapMode}set wrapMode(T){this._wrapMode!==T&&(this._wrapMode=T,this.dirtyStyleId++)}setStyle(T,L){let P;return T!==void 0&&T!==this.scaleMode&&(this.scaleMode=T,P=!0),L!==void 0&&L!==this.mipmap&&(this.mipmap=L,P=!0),P&&this.dirtyStyleId++,this}setSize(T,L,P){return P=P||this.resolution,this.setRealSize(T*P,L*P,P)}setRealSize(T,L,P){return this.resolution=P||this.resolution,this.width=Math.round(T)/this.resolution,this.height=Math.round(L)/this.resolution,this._refreshPOT(),this.update(),this}_refreshPOT(){this.isPowerOfTwo=isPow2(this.realWidth)&&isPow2(this.realHeight)}setResolution(T){const L=this.resolution;return L===T?this:(this.resolution=T,this.valid&&(this.width=Math.round(this.width*L)/T,this.height=Math.round(this.height*L)/T,this.emit("update",this)),this._refreshPOT(),this)}setResource(T){if(this.resource===T)return this;if(this.resource)throw new Error("Resource can be set only once");return T.bind(this),this.resource=T,this}update(){this.valid?(this.dirtyId++,this.dirtyStyleId++,this.emit("update",this)):this.width>0&&this.height>0&&(this.valid=!0,this.emit("loaded",this),this.emit("update",this))}onError(T){this.emit("error",this,T)}destroy(){this.resource&&(this.resource.unbind(this),this.resource.internal&&this.resource.destroy(),this.resource=null),this.cacheId&&(delete BaseTextureCache[this.cacheId],delete TextureCache[this.cacheId],this.cacheId=null),this.valid=!1,this.dispose(),As.removeFromCache(this),this.textureCacheIds=null,this.destroyed=!0,this.emit("destroyed",this),this.removeAllListeners()}dispose(){this.emit("dispose",this)}castToBaseTexture(){return this}static from(T,L,P=settings.STRICT_TEXTURE_CACHE){const I=typeof T=="string";let F=null;if(I)F=T;else{if(!T._pixiId){const V=L?.pixiIdPrefix||"pixiid";T._pixiId=`${V}_${uid()}`}F=T._pixiId}let D=BaseTextureCache[F];if(I&&P&&!D)throw new Error(`The cacheId "${F}" does not exist in BaseTextureCache.`);return D||(D=new As(T,L),D.cacheId=F,As.addToCache(D,F)),D}static fromBuffer(T,L,P,I){T=T||new Float32Array(L*P*4);const F=new BufferResource(T,{width:L,height:P,...I?.resourceOptions});let D,V;return T instanceof Float32Array?(D=FORMATS.RGBA,V=TYPES.FLOAT):T instanceof Int32Array?(D=FORMATS.RGBA_INTEGER,V=TYPES.INT):T instanceof Uint32Array?(D=FORMATS.RGBA_INTEGER,V=TYPES.UNSIGNED_INT):T instanceof Int16Array?(D=FORMATS.RGBA_INTEGER,V=TYPES.SHORT):T instanceof Uint16Array?(D=FORMATS.RGBA_INTEGER,V=TYPES.UNSIGNED_SHORT):T instanceof Int8Array?(D=FORMATS.RGBA,V=TYPES.BYTE):(D=FORMATS.RGBA,V=TYPES.UNSIGNED_BYTE),F.internal=!0,new As(F,Object.assign({},defaultBufferOptions,{type:V,format:D},I))}static addToCache(T,L){L&&(T.textureCacheIds.includes(L)||T.textureCacheIds.push(L),BaseTextureCache[L]&&BaseTextureCache[L]!==T&&console.warn(`BaseTexture added to the cache with an id [${L}] that already had an entry`),BaseTextureCache[L]=T)}static removeFromCache(T){if(typeof T=="string"){const L=BaseTextureCache[T];if(L){const P=L.textureCacheIds.indexOf(T);return P>-1&&L.textureCacheIds.splice(P,1),delete BaseTextureCache[T],L}}else if(T?.textureCacheIds){for(let L=0;L<T.textureCacheIds.length;++L)delete BaseTextureCache[T.textureCacheIds[L]];return T.textureCacheIds.length=0,T}return null}};_BaseTexture.defaultOptions={mipmap:MIPMAP_MODES.POW2,anisotropicLevel:0,scaleMode:SCALE_MODES.LINEAR,wrapMode:WRAP_MODES.CLAMP,alphaMode:ALPHA_MODES.UNPACK,target:TARGETS.TEXTURE_2D,format:FORMATS.RGBA,type:TYPES.UNSIGNED_BYTE},_BaseTexture._globalBatch=0;let BaseTexture=_BaseTexture;class BatchDrawCall{constructor(){this.texArray=null,this.blend=0,this.type=DRAW_MODES.TRIANGLES,this.start=0,this.size=0,this.data=null}}let UID$4=0,Buffer$1=class yr{constructor(T,L=!0,P=!1){this.data=T||new Float32Array(1),this._glBuffers={},this._updateID=0,this.index=P,this.static=L,this.id=UID$4++,this.disposeRunner=new Runner("disposeBuffer")}update(T){T instanceof Array&&(T=new Float32Array(T)),this.data=T||this.data,this._updateID++}dispose(){this.disposeRunner.emit(this,!1)}destroy(){this.dispose(),this.data=null}set index(T){this.type=T?BUFFER_TYPE.ELEMENT_ARRAY_BUFFER:BUFFER_TYPE.ARRAY_BUFFER}get index(){return this.type===BUFFER_TYPE.ELEMENT_ARRAY_BUFFER}static from(T){return T instanceof Array&&(T=new Float32Array(T)),new yr(T)}};class Attribute{constructor(T,L=0,P=!1,I=TYPES.FLOAT,F,D,V,q=1){this.buffer=T,this.size=L,this.normalized=P,this.type=I,this.stride=F,this.start=D,this.instance=V,this.divisor=q}destroy(){this.buffer=null}static from(T,L,P,I,F){return new Attribute(T,L,P,I,F)}}const map$1={Float32Array,Uint32Array,Int32Array,Uint8Array};function interleaveTypedArrays(R,T){let L=0,P=0;const I={};for(let q=0;q<R.length;q++)P+=T[q],L+=R[q].length;const F=new ArrayBuffer(L*4);let D=null,V=0;for(let q=0;q<R.length;q++){const G=T[q],z=R[q],Q=getBufferType(z);I[Q]||(I[Q]=new map$1[Q](F)),D=I[Q];for(let J=0;J<z.length;J++){const tt=(J/G|0)*P+V,yt=J%G;D[tt+yt]=z[J]}V+=G}return new Float32Array(F)}const byteSizeMap$1={5126:4,5123:2,5121:1};let UID$3=0;const map={Float32Array,Uint32Array,Int32Array,Uint8Array,Uint16Array};class Geometry{constructor(T=[],L={}){this.buffers=T,this.indexBuffer=null,this.attributes=L,this.glVertexArrayObjects={},this.id=UID$3++,this.instanced=!1,this.instanceCount=1,this.disposeRunner=new Runner("disposeGeometry"),this.refCount=0}addAttribute(T,L,P=0,I=!1,F,D,V,q=!1){if(!L)throw new Error("You must pass a buffer when creating an attribute");L instanceof Buffer$1||(L instanceof Array&&(L=new Float32Array(L)),L=new Buffer$1(L));const G=T.split("|");if(G.length>1){for(let Q=0;Q<G.length;Q++)this.addAttribute(G[Q],L,P,I,F);return this}let z=this.buffers.indexOf(L);return z===-1&&(this.buffers.push(L),z=this.buffers.length-1),this.attributes[T]=new Attribute(z,P,I,F,D,V,q),this.instanced=this.instanced||q,this}getAttribute(T){return this.attributes[T]}getBuffer(T){return this.buffers[this.getAttribute(T).buffer]}addIndex(T){return T instanceof Buffer$1||(T instanceof Array&&(T=new Uint16Array(T)),T=new Buffer$1(T)),T.type=BUFFER_TYPE.ELEMENT_ARRAY_BUFFER,this.indexBuffer=T,this.buffers.includes(T)||this.buffers.push(T),this}getIndex(){return this.indexBuffer}interleave(){if(this.buffers.length===1||this.buffers.length===2&&this.indexBuffer)return this;const T=[],L=[],P=new Buffer$1;let I;for(I in this.attributes){const F=this.attributes[I],D=this.buffers[F.buffer];T.push(D.data),L.push(F.size*byteSizeMap$1[F.type]/4),F.buffer=0}for(P.data=interleaveTypedArrays(T,L),I=0;I<this.buffers.length;I++)this.buffers[I]!==this.indexBuffer&&this.buffers[I].destroy();return this.buffers=[P],this.indexBuffer&&this.buffers.push(this.indexBuffer),this}getSize(){for(const T in this.attributes){const L=this.attributes[T];return this.buffers[L.buffer].data.length/(L.stride/4||L.size)}return 0}dispose(){this.disposeRunner.emit(this,!1)}destroy(){this.dispose(),this.buffers=null,this.indexBuffer=null,this.attributes=null}clone(){const T=new Geometry;for(let L=0;L<this.buffers.length;L++)T.buffers[L]=new Buffer$1(this.buffers[L].data.slice(0));for(const L in this.attributes){const P=this.attributes[L];T.attributes[L]=new Attribute(P.buffer,P.size,P.normalized,P.type,P.stride,P.start,P.instance)}return this.indexBuffer&&(T.indexBuffer=T.buffers[this.buffers.indexOf(this.indexBuffer)],T.indexBuffer.type=BUFFER_TYPE.ELEMENT_ARRAY_BUFFER),T}static merge(T){const L=new Geometry,P=[],I=[],F=[];let D;for(let V=0;V<T.length;V++){D=T[V];for(let q=0;q<D.buffers.length;q++)I[q]=I[q]||0,I[q]+=D.buffers[q].data.length,F[q]=0}for(let V=0;V<D.buffers.length;V++)P[V]=new map[getBufferType(D.buffers[V].data)](I[V]),L.buffers[V]=new Buffer$1(P[V]);for(let V=0;V<T.length;V++){D=T[V];for(let q=0;q<D.buffers.length;q++)P[q].set(D.buffers[q].data,F[q]),F[q]+=D.buffers[q].data.length}if(L.attributes=D.attributes,D.indexBuffer){L.indexBuffer=L.buffers[D.buffers.indexOf(D.indexBuffer)],L.indexBuffer.type=BUFFER_TYPE.ELEMENT_ARRAY_BUFFER;let V=0,q=0,G=0,z=0;for(let Q=0;Q<D.buffers.length;Q++)if(D.buffers[Q]!==D.indexBuffer){z=Q;break}for(const Q in D.attributes){const J=D.attributes[Q];(J.buffer|0)===z&&(q+=J.size*byteSizeMap$1[J.type]/4)}for(let Q=0;Q<T.length;Q++){const J=T[Q].indexBuffer.data;for(let tt=0;tt<J.length;tt++)L.indexBuffer.data[tt+G]+=V;V+=T[Q].buffers[z].data.length/q,G+=J.length}}return L}}class BatchGeometry extends Geometry{constructor(T=!1){super(),this._buffer=new Buffer$1(null,T,!1),this._indexBuffer=new Buffer$1(null,T,!0),this.addAttribute("aVertexPosition",this._buffer,2,!1,TYPES.FLOAT).addAttribute("aTextureCoord",this._buffer,2,!1,TYPES.FLOAT).addAttribute("aColor",this._buffer,4,!0,TYPES.UNSIGNED_BYTE).addAttribute("aTextureId",this._buffer,1,!0,TYPES.FLOAT).addIndex(this._indexBuffer)}}const PI_2=Math.PI*2,RAD_TO_DEG=180/Math.PI,DEG_TO_RAD=Math.PI/180;var SHAPES=(R=>(R[R.POLY=0]="POLY",R[R.RECT=1]="RECT",R[R.CIRC=2]="CIRC",R[R.ELIP=3]="ELIP",R[R.RREC=4]="RREC",R))(SHAPES||{});class Point{constructor(T=0,L=0){this.x=0,this.y=0,this.x=T,this.y=L}clone(){return new Point(this.x,this.y)}copyFrom(T){return this.set(T.x,T.y),this}copyTo(T){return T.set(this.x,this.y),T}equals(T){return T.x===this.x&&T.y===this.y}set(T=0,L=T){return this.x=T,this.y=L,this}}Point.prototype.toString=function(){return`[@pixi/math:Point x=${this.x} y=${this.y}]`};const tempPoints$1=[new Point,new Point,new Point,new Point];class Rectangle{constructor(T=0,L=0,P=0,I=0){this.x=Number(T),this.y=Number(L),this.width=Number(P),this.height=Number(I),this.type=SHAPES.RECT}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}static get EMPTY(){return new Rectangle(0,0,0,0)}clone(){return new Rectangle(this.x,this.y,this.width,this.height)}copyFrom(T){return this.x=T.x,this.y=T.y,this.width=T.width,this.height=T.height,this}copyTo(T){return T.x=this.x,T.y=this.y,T.width=this.width,T.height=this.height,T}contains(T,L){return this.width<=0||this.height<=0?!1:T>=this.x&&T<this.x+this.width&&L>=this.y&&L<this.y+this.height}intersects(T,L){if(!L){const si=this.x<T.x?T.x:this.x;if((this.right>T.right?T.right:this.right)<=si)return!1;const ci=this.y<T.y?T.y:this.y;return(this.bottom>T.bottom?T.bottom:this.bottom)>ci}const P=this.left,I=this.right,F=this.top,D=this.bottom;if(I<=P||D<=F)return!1;const V=tempPoints$1[0].set(T.left,T.top),q=tempPoints$1[1].set(T.left,T.bottom),G=tempPoints$1[2].set(T.right,T.top),z=tempPoints$1[3].set(T.right,T.bottom);if(G.x<=V.x||q.y<=V.y)return!1;const Q=Math.sign(L.a*L.d-L.b*L.c);if(Q===0||(L.apply(V,V),L.apply(q,q),L.apply(G,G),L.apply(z,z),Math.max(V.x,q.x,G.x,z.x)<=P||Math.min(V.x,q.x,G.x,z.x)>=I||Math.max(V.y,q.y,G.y,z.y)<=F||Math.min(V.y,q.y,G.y,z.y)>=D))return!1;const J=Q*(q.y-V.y),tt=Q*(V.x-q.x),yt=J*P+tt*F,At=J*I+tt*F,gt=J*P+tt*D,Et=J*I+tt*D;if(Math.max(yt,At,gt,Et)<=J*V.x+tt*V.y||Math.min(yt,At,gt,Et)>=J*z.x+tt*z.y)return!1;const kt=Q*(V.y-G.y),ne=Q*(G.x-V.x),Se=kt*P+ne*F,Ht=kt*I+ne*F,Le=kt*P+ne*D,ee=kt*I+ne*D;return!(Math.max(Se,Ht,Le,ee)<=kt*V.x+ne*V.y||Math.min(Se,Ht,Le,ee)>=kt*z.x+ne*z.y)}pad(T=0,L=T){return this.x-=T,this.y-=L,this.width+=T*2,this.height+=L*2,this}fit(T){const L=Math.max(this.x,T.x),P=Math.min(this.x+this.width,T.x+T.width),I=Math.max(this.y,T.y),F=Math.min(this.y+this.height,T.y+T.height);return this.x=L,this.width=Math.max(P-L,0),this.y=I,this.height=Math.max(F-I,0),this}ceil(T=1,L=.001){const P=Math.ceil((this.x+this.width-L)*T)/T,I=Math.ceil((this.y+this.height-L)*T)/T;return this.x=Math.floor((this.x+L)*T)/T,this.y=Math.floor((this.y+L)*T)/T,this.width=P-this.x,this.height=I-this.y,this}enlarge(T){const L=Math.min(this.x,T.x),P=Math.max(this.x+this.width,T.x+T.width),I=Math.min(this.y,T.y),F=Math.max(this.y+this.height,T.y+T.height);return this.x=L,this.width=P-L,this.y=I,this.height=F-I,this}}Rectangle.prototype.toString=function(){return`[@pixi/math:Rectangle x=${this.x} y=${this.y} width=${this.width} height=${this.height}]`};class Matrix{constructor(T=1,L=0,P=0,I=1,F=0,D=0){this.array=null,this.a=T,this.b=L,this.c=P,this.d=I,this.tx=F,this.ty=D}fromArray(T){this.a=T[0],this.b=T[1],this.c=T[3],this.d=T[4],this.tx=T[2],this.ty=T[5]}set(T,L,P,I,F,D){return this.a=T,this.b=L,this.c=P,this.d=I,this.tx=F,this.ty=D,this}toArray(T,L){this.array||(this.array=new Float32Array(9));const P=L||this.array;return T?(P[0]=this.a,P[1]=this.b,P[2]=0,P[3]=this.c,P[4]=this.d,P[5]=0,P[6]=this.tx,P[7]=this.ty,P[8]=1):(P[0]=this.a,P[1]=this.c,P[2]=this.tx,P[3]=this.b,P[4]=this.d,P[5]=this.ty,P[6]=0,P[7]=0,P[8]=1),P}apply(T,L){L=L||new Point;const P=T.x,I=T.y;return L.x=this.a*P+this.c*I+this.tx,L.y=this.b*P+this.d*I+this.ty,L}applyInverse(T,L){L=L||new Point;const P=1/(this.a*this.d+this.c*-this.b),I=T.x,F=T.y;return L.x=this.d*P*I+-this.c*P*F+(this.ty*this.c-this.tx*this.d)*P,L.y=this.a*P*F+-this.b*P*I+(-this.ty*this.a+this.tx*this.b)*P,L}translate(T,L){return this.tx+=T,this.ty+=L,this}scale(T,L){return this.a*=T,this.d*=L,this.c*=T,this.b*=L,this.tx*=T,this.ty*=L,this}rotate(T){const L=Math.cos(T),P=Math.sin(T),I=this.a,F=this.c,D=this.tx;return this.a=I*L-this.b*P,this.b=I*P+this.b*L,this.c=F*L-this.d*P,this.d=F*P+this.d*L,this.tx=D*L-this.ty*P,this.ty=D*P+this.ty*L,this}append(T){const L=this.a,P=this.b,I=this.c,F=this.d;return this.a=T.a*L+T.b*I,this.b=T.a*P+T.b*F,this.c=T.c*L+T.d*I,this.d=T.c*P+T.d*F,this.tx=T.tx*L+T.ty*I+this.tx,this.ty=T.tx*P+T.ty*F+this.ty,this}setTransform(T,L,P,I,F,D,V,q,G){return this.a=Math.cos(V+G)*F,this.b=Math.sin(V+G)*F,this.c=-Math.sin(V-q)*D,this.d=Math.cos(V-q)*D,this.tx=T-(P*this.a+I*this.c),this.ty=L-(P*this.b+I*this.d),this}prepend(T){const L=this.tx;if(T.a!==1||T.b!==0||T.c!==0||T.d!==1){const P=this.a,I=this.c;this.a=P*T.a+this.b*T.c,this.b=P*T.b+this.b*T.d,this.c=I*T.a+this.d*T.c,this.d=I*T.b+this.d*T.d}return this.tx=L*T.a+this.ty*T.c+T.tx,this.ty=L*T.b+this.ty*T.d+T.ty,this}decompose(T){const L=this.a,P=this.b,I=this.c,F=this.d,D=T.pivot,V=-Math.atan2(-I,F),q=Math.atan2(P,L),G=Math.abs(V+q);return G<1e-5||Math.abs(PI_2-G)<1e-5?(T.rotation=q,T.skew.x=T.skew.y=0):(T.rotation=0,T.skew.x=V,T.skew.y=q),T.scale.x=Math.sqrt(L*L+P*P),T.scale.y=Math.sqrt(I*I+F*F),T.position.x=this.tx+(D.x*L+D.y*I),T.position.y=this.ty+(D.x*P+D.y*F),T}invert(){const T=this.a,L=this.b,P=this.c,I=this.d,F=this.tx,D=T*I-L*P;return this.a=I/D,this.b=-L/D,this.c=-P/D,this.d=T/D,this.tx=(P*this.ty-I*F)/D,this.ty=-(T*this.ty-L*F)/D,this}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}clone(){const T=new Matrix;return T.a=this.a,T.b=this.b,T.c=this.c,T.d=this.d,T.tx=this.tx,T.ty=this.ty,T}copyTo(T){return T.a=this.a,T.b=this.b,T.c=this.c,T.d=this.d,T.tx=this.tx,T.ty=this.ty,T}copyFrom(T){return this.a=T.a,this.b=T.b,this.c=T.c,this.d=T.d,this.tx=T.tx,this.ty=T.ty,this}static get IDENTITY(){return new Matrix}static get TEMP_MATRIX(){return new Matrix}}Matrix.prototype.toString=function(){return`[@pixi/math:Matrix a=${this.a} b=${this.b} c=${this.c} d=${this.d} tx=${this.tx} ty=${this.ty}]`};const ux=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],uy=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],vx=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],vy=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],rotationCayley=[],rotationMatrices=[],signum=Math.sign;function init(){for(let R=0;R<16;R++){const T=[];rotationCayley.push(T);for(let L=0;L<16;L++){const P=signum(ux[R]*ux[L]+vx[R]*uy[L]),I=signum(uy[R]*ux[L]+vy[R]*uy[L]),F=signum(ux[R]*vx[L]+vx[R]*vy[L]),D=signum(uy[R]*vx[L]+vy[R]*vy[L]);for(let V=0;V<16;V++)if(ux[V]===P&&uy[V]===I&&vx[V]===F&&vy[V]===D){T.push(V);break}}}for(let R=0;R<16;R++){const T=new Matrix;T.set(ux[R],uy[R],vx[R],vy[R],0,0),rotationMatrices.push(T)}}init();const groupD8={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:R=>ux[R],uY:R=>uy[R],vX:R=>vx[R],vY:R=>vy[R],inv:R=>R&8?R&15:-R&7,add:(R,T)=>rotationCayley[R][T],sub:(R,T)=>rotationCayley[R][groupD8.inv(T)],rotate180:R=>R^4,isVertical:R=>(R&3)===2,byDirection:(R,T)=>Math.abs(R)*2<=Math.abs(T)?T>=0?groupD8.S:groupD8.N:Math.abs(T)*2<=Math.abs(R)?R>0?groupD8.E:groupD8.W:T>0?R>0?groupD8.SE:groupD8.SW:R>0?groupD8.NE:groupD8.NW,matrixAppendRotationInv:(R,T,L=0,P=0)=>{const I=rotationMatrices[groupD8.inv(T)];I.tx=L,I.ty=P,R.append(I)}};class ObservablePoint{constructor(T,L,P=0,I=0){this._x=P,this._y=I,this.cb=T,this.scope=L}clone(T=this.cb,L=this.scope){return new ObservablePoint(T,L,this._x,this._y)}set(T=0,L=T){return(this._x!==T||this._y!==L)&&(this._x=T,this._y=L,this.cb.call(this.scope)),this}copyFrom(T){return(this._x!==T.x||this._y!==T.y)&&(this._x=T.x,this._y=T.y,this.cb.call(this.scope)),this}copyTo(T){return T.set(this._x,this._y),T}equals(T){return T.x===this._x&&T.y===this._y}get x(){return this._x}set x(T){this._x!==T&&(this._x=T,this.cb.call(this.scope))}get y(){return this._y}set y(T){this._y!==T&&(this._y=T,this.cb.call(this.scope))}}ObservablePoint.prototype.toString=function(){return`[@pixi/math:ObservablePoint x=${this.x} y=${this.y} scope=${this.scope}]`};const _Transform=class{constructor(){this.worldTransform=new Matrix,this.localTransform=new Matrix,this.position=new ObservablePoint(this.onChange,this,0,0),this.scale=new ObservablePoint(this.onChange,this,1,1),this.pivot=new ObservablePoint(this.onChange,this,0,0),this.skew=new ObservablePoint(this.updateSkew,this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._localID=0,this._currentLocalID=0,this._worldID=0,this._parentID=0}onChange(){this._localID++}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this._localID++}updateLocalTransform(){const R=this.localTransform;this._localID!==this._currentLocalID&&(R.a=this._cx*this.scale.x,R.b=this._sx*this.scale.x,R.c=this._cy*this.scale.y,R.d=this._sy*this.scale.y,R.tx=this.position.x-(this.pivot.x*R.a+this.pivot.y*R.c),R.ty=this.position.y-(this.pivot.x*R.b+this.pivot.y*R.d),this._currentLocalID=this._localID,this._parentID=-1)}updateTransform(R){const T=this.localTransform;if(this._localID!==this._currentLocalID&&(T.a=this._cx*this.scale.x,T.b=this._sx*this.scale.x,T.c=this._cy*this.scale.y,T.d=this._sy*this.scale.y,T.tx=this.position.x-(this.pivot.x*T.a+this.pivot.y*T.c),T.ty=this.position.y-(this.pivot.x*T.b+this.pivot.y*T.d),this._currentLocalID=this._localID,this._parentID=-1),this._parentID!==R._worldID){const L=R.worldTransform,P=this.worldTransform;P.a=T.a*L.a+T.b*L.c,P.b=T.a*L.b+T.b*L.d,P.c=T.c*L.a+T.d*L.c,P.d=T.c*L.b+T.d*L.d,P.tx=T.tx*L.a+T.ty*L.c+L.tx,P.ty=T.tx*L.b+T.ty*L.d+L.ty,this._parentID=R._worldID,this._worldID++}}setFromMatrix(R){R.decompose(this),this._localID++}get rotation(){return this._rotation}set rotation(R){this._rotation!==R&&(this._rotation=R,this.updateSkew())}};_Transform.IDENTITY=new _Transform;let Transform=_Transform;Transform.prototype.toString=function(){return`[@pixi/math:Transform position=(${this.position.x}, ${this.position.y}) rotation=${this.rotation} scale=(${this.scale.x}, ${this.scale.y}) skew=(${this.skew.x}, ${this.skew.y}) ]`};var defaultFragment$2=`varying vec2 vTextureCoord;

uniform sampler2D uSampler;

void main(void){
   gl_FragColor *= texture2D(uSampler, vTextureCoord);
}`,defaultVertex$2=`attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat3 projectionMatrix;

varying vec2 vTextureCoord;

void main(void){
   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);
   vTextureCoord = aTextureCoord;
}
`;function compileShader(R,T,L){const P=R.createShader(T);return R.shaderSource(P,L),R.compileShader(P),P}function booleanArray(R){const T=new Array(R);for(let L=0;L<T.length;L++)T[L]=!1;return T}function defaultValue(R,T){switch(R){case"float":return 0;case"vec2":return new Float32Array(2*T);case"vec3":return new Float32Array(3*T);case"vec4":return new Float32Array(4*T);case"int":case"uint":case"sampler2D":case"sampler2DArray":return 0;case"ivec2":return new Int32Array(2*T);case"ivec3":return new Int32Array(3*T);case"ivec4":return new Int32Array(4*T);case"uvec2":return new Uint32Array(2*T);case"uvec3":return new Uint32Array(3*T);case"uvec4":return new Uint32Array(4*T);case"bool":return!1;case"bvec2":return booleanArray(2*T);case"bvec3":return booleanArray(3*T);case"bvec4":return booleanArray(4*T);case"mat2":return new Float32Array([1,0,0,1]);case"mat3":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}const uniformParsers=[{test:R=>R.type==="float"&&R.size===1&&!R.isArray,code:R=>`
            if(uv["${R}"] !== ud["${R}"].value)
            {
                ud["${R}"].value = uv["${R}"]
                gl.uniform1f(ud["${R}"].location, uv["${R}"])
            }
            `},{test:(R,T)=>(R.type==="sampler2D"||R.type==="samplerCube"||R.type==="sampler2DArray")&&R.size===1&&!R.isArray&&(T==null||T.castToBaseTexture!==void 0),code:R=>`t = syncData.textureCount++;

            renderer.texture.bind(uv["${R}"], t);

            if(ud["${R}"].value !== t)
            {
                ud["${R}"].value = t;
                gl.uniform1i(ud["${R}"].location, t);
; // eslint-disable-line max-len
            }`},{test:(R,T)=>R.type==="mat3"&&R.size===1&&!R.isArray&&T.a!==void 0,code:R=>`
            gl.uniformMatrix3fv(ud["${R}"].location, false, uv["${R}"].toArray(true));
            `,codeUbo:R=>`
                var ${R}_matrix = uv.${R}.toArray(true);

                data[offset] = ${R}_matrix[0];
                data[offset+1] = ${R}_matrix[1];
                data[offset+2] = ${R}_matrix[2];
        
                data[offset + 4] = ${R}_matrix[3];
                data[offset + 5] = ${R}_matrix[4];
                data[offset + 6] = ${R}_matrix[5];
        
                data[offset + 8] = ${R}_matrix[6];
                data[offset + 9] = ${R}_matrix[7];
                data[offset + 10] = ${R}_matrix[8];
            `},{test:(R,T)=>R.type==="vec2"&&R.size===1&&!R.isArray&&T.x!==void 0,code:R=>`
                cv = ud["${R}"].value;
                v = uv["${R}"];

                if(cv[0] !== v.x || cv[1] !== v.y)
                {
                    cv[0] = v.x;
                    cv[1] = v.y;
                    gl.uniform2f(ud["${R}"].location, v.x, v.y);
                }`,codeUbo:R=>`
                v = uv.${R};

                data[offset] = v.x;
                data[offset+1] = v.y;
            `},{test:R=>R.type==="vec2"&&R.size===1&&!R.isArray,code:R=>`
                cv = ud["${R}"].value;
                v = uv["${R}"];

                if(cv[0] !== v[0] || cv[1] !== v[1])
                {
                    cv[0] = v[0];
                    cv[1] = v[1];
                    gl.uniform2f(ud["${R}"].location, v[0], v[1]);
                }
            `},{test:(R,T)=>R.type==="vec4"&&R.size===1&&!R.isArray&&T.width!==void 0,code:R=>`
                cv = ud["${R}"].value;
                v = uv["${R}"];

                if(cv[0] !== v.x || cv[1] !== v.y || cv[2] !== v.width || cv[3] !== v.height)
                {
                    cv[0] = v.x;
                    cv[1] = v.y;
                    cv[2] = v.width;
                    cv[3] = v.height;
                    gl.uniform4f(ud["${R}"].location, v.x, v.y, v.width, v.height)
                }`,codeUbo:R=>`
                    v = uv.${R};

                    data[offset] = v.x;
                    data[offset+1] = v.y;
                    data[offset+2] = v.width;
                    data[offset+3] = v.height;
                `},{test:(R,T)=>R.type==="vec4"&&R.size===1&&!R.isArray&&T.red!==void 0,code:R=>`
                cv = ud["${R}"].value;
                v = uv["${R}"];

                if(cv[0] !== v.red || cv[1] !== v.green || cv[2] !== v.blue || cv[3] !== v.alpha)
                {
                    cv[0] = v.red;
                    cv[1] = v.green;
                    cv[2] = v.blue;
                    cv[3] = v.alpha;
                    gl.uniform4f(ud["${R}"].location, v.red, v.green, v.blue, v.alpha)
                }`,codeUbo:R=>`
                    v = uv.${R};

                    data[offset] = v.red;
                    data[offset+1] = v.green;
                    data[offset+2] = v.blue;
                    data[offset+3] = v.alpha;
                `},{test:(R,T)=>R.type==="vec3"&&R.size===1&&!R.isArray&&T.red!==void 0,code:R=>`
                cv = ud["${R}"].value;
                v = uv["${R}"];

                if(cv[0] !== v.red || cv[1] !== v.green || cv[2] !== v.blue || cv[3] !== v.a)
                {
                    cv[0] = v.red;
                    cv[1] = v.green;
                    cv[2] = v.blue;
    
                    gl.uniform3f(ud["${R}"].location, v.red, v.green, v.blue)
                }`,codeUbo:R=>`
                    v = uv.${R};

                    data[offset] = v.red;
                    data[offset+1] = v.green;
                    data[offset+2] = v.blue;
                `},{test:R=>R.type==="vec4"&&R.size===1&&!R.isArray,code:R=>`
                cv = ud["${R}"].value;
                v = uv["${R}"];

                if(cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3])
                {
                    cv[0] = v[0];
                    cv[1] = v[1];
                    cv[2] = v[2];
                    cv[3] = v[3];

                    gl.uniform4f(ud["${R}"].location, v[0], v[1], v[2], v[3])
                }`}],GLSL_TO_SINGLE_SETTERS_CACHED={float:`
    if (cv !== v)
    {
        cu.value = v;
        gl.uniform1f(location, v);
    }`,vec2:`
    if (cv[0] !== v[0] || cv[1] !== v[1])
    {
        cv[0] = v[0];
        cv[1] = v[1];

        gl.uniform2f(location, v[0], v[1])
    }`,vec3:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];

        gl.uniform3f(location, v[0], v[1], v[2])
    }`,vec4:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];
        cv[3] = v[3];

        gl.uniform4f(location, v[0], v[1], v[2], v[3]);
    }`,int:`
    if (cv !== v)
    {
        cu.value = v;

        gl.uniform1i(location, v);
    }`,ivec2:`
    if (cv[0] !== v[0] || cv[1] !== v[1])
    {
        cv[0] = v[0];
        cv[1] = v[1];

        gl.uniform2i(location, v[0], v[1]);
    }`,ivec3:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];

        gl.uniform3i(location, v[0], v[1], v[2]);
    }`,ivec4:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];
        cv[3] = v[3];

        gl.uniform4i(location, v[0], v[1], v[2], v[3]);
    }`,uint:`
    if (cv !== v)
    {
        cu.value = v;

        gl.uniform1ui(location, v);
    }`,uvec2:`
    if (cv[0] !== v[0] || cv[1] !== v[1])
    {
        cv[0] = v[0];
        cv[1] = v[1];

        gl.uniform2ui(location, v[0], v[1]);
    }`,uvec3:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];

        gl.uniform3ui(location, v[0], v[1], v[2]);
    }`,uvec4:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];
        cv[3] = v[3];

        gl.uniform4ui(location, v[0], v[1], v[2], v[3]);
    }`,bool:`
    if (cv !== v)
    {
        cu.value = v;
        gl.uniform1i(location, v);
    }`,bvec2:`
    if (cv[0] != v[0] || cv[1] != v[1])
    {
        cv[0] = v[0];
        cv[1] = v[1];

        gl.uniform2i(location, v[0], v[1]);
    }`,bvec3:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];

        gl.uniform3i(location, v[0], v[1], v[2]);
    }`,bvec4:`
    if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3])
    {
        cv[0] = v[0];
        cv[1] = v[1];
        cv[2] = v[2];
        cv[3] = v[3];

        gl.uniform4i(location, v[0], v[1], v[2], v[3]);
    }`,mat2:"gl.uniformMatrix2fv(location, false, v)",mat3:"gl.uniformMatrix3fv(location, false, v)",mat4:"gl.uniformMatrix4fv(location, false, v)",sampler2D:`
    if (cv !== v)
    {
        cu.value = v;

        gl.uniform1i(location, v);
    }`,samplerCube:`
    if (cv !== v)
    {
        cu.value = v;

        gl.uniform1i(location, v);
    }`,sampler2DArray:`
    if (cv !== v)
    {
        cu.value = v;

        gl.uniform1i(location, v);
    }`},GLSL_TO_ARRAY_SETTERS={float:"gl.uniform1fv(location, v)",vec2:"gl.uniform2fv(location, v)",vec3:"gl.uniform3fv(location, v)",vec4:"gl.uniform4fv(location, v)",mat4:"gl.uniformMatrix4fv(location, false, v)",mat3:"gl.uniformMatrix3fv(location, false, v)",mat2:"gl.uniformMatrix2fv(location, false, v)",int:"gl.uniform1iv(location, v)",ivec2:"gl.uniform2iv(location, v)",ivec3:"gl.uniform3iv(location, v)",ivec4:"gl.uniform4iv(location, v)",uint:"gl.uniform1uiv(location, v)",uvec2:"gl.uniform2uiv(location, v)",uvec3:"gl.uniform3uiv(location, v)",uvec4:"gl.uniform4uiv(location, v)",bool:"gl.uniform1iv(location, v)",bvec2:"gl.uniform2iv(location, v)",bvec3:"gl.uniform3iv(location, v)",bvec4:"gl.uniform4iv(location, v)",sampler2D:"gl.uniform1iv(location, v)",samplerCube:"gl.uniform1iv(location, v)",sampler2DArray:"gl.uniform1iv(location, v)"};function generateUniformsSync(R,T){const L=[`
        var v = null;
        var cv = null;
        var cu = null;
        var t = 0;
        var gl = renderer.gl;
    `];for(const P in R.uniforms){const I=T[P];if(!I){R.uniforms[P]?.group===!0&&(R.uniforms[P].ubo?L.push(`
                        renderer.shader.syncUniformBufferGroup(uv.${P}, '${P}');
                    `):L.push(`
                        renderer.shader.syncUniformGroup(uv.${P}, syncData);
                    `));continue}const F=R.uniforms[P];let D=!1;for(let V=0;V<uniformParsers.length;V++)if(uniformParsers[V].test(I,F)){L.push(uniformParsers[V].code(P,F)),D=!0;break}if(!D){const V=(I.size===1&&!I.isArray?GLSL_TO_SINGLE_SETTERS_CACHED:GLSL_TO_ARRAY_SETTERS)[I.type].replace("location",`ud["${P}"].location`);L.push(`
            cu = ud["${P}"];
            cv = cu.value;
            v = uv["${P}"];
            ${V};`)}}return new Function("ud","uv","renderer","syncData",L.join(`
`))}const unknownContext={};let context=unknownContext;function getTestContext(){if(context===unknownContext||context?.isContextLost()){const R=settings.ADAPTER.createCanvas();let T;settings.PREFER_ENV>=ENV.WEBGL2&&(T=R.getContext("webgl2",{})),T||(T=R.getContext("webgl",{})||R.getContext("experimental-webgl",{}),T?T.getExtension("WEBGL_draw_buffers"):T=null),context=T}return context}let maxFragmentPrecision;function getMaxFragmentPrecision(){if(!maxFragmentPrecision){maxFragmentPrecision=PRECISION.MEDIUM;const R=getTestContext();if(R&&R.getShaderPrecisionFormat){const T=R.getShaderPrecisionFormat(R.FRAGMENT_SHADER,R.HIGH_FLOAT);T&&(maxFragmentPrecision=T.precision?PRECISION.HIGH:PRECISION.MEDIUM)}}return maxFragmentPrecision}function logPrettyShaderError(R,T){const L=R.getShaderSource(T).split(`
`).map((G,z)=>`${z}: ${G}`),P=R.getShaderInfoLog(T),I=P.split(`
`),F={},D=I.map(G=>parseFloat(G.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1"))).filter(G=>G&&!F[G]?(F[G]=!0,!0):!1),V=[""];D.forEach(G=>{L[G-1]=`%c${L[G-1]}%c`,V.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")});const q=L.join(`
`);V[0]=q,console.error(P),console.groupCollapsed("click to view full shader code"),console.warn(...V),console.groupEnd()}function logProgramError(R,T,L,P){R.getProgramParameter(T,R.LINK_STATUS)||(R.getShaderParameter(L,R.COMPILE_STATUS)||logPrettyShaderError(R,L),R.getShaderParameter(P,R.COMPILE_STATUS)||logPrettyShaderError(R,P),console.error("PixiJS Error: Could not initialize shader."),R.getProgramInfoLog(T)!==""&&console.warn("PixiJS Warning: gl.getProgramInfoLog()",R.getProgramInfoLog(T)))}const GLSL_TO_SIZE={float:1,vec2:2,vec3:3,vec4:4,int:1,ivec2:2,ivec3:3,ivec4:4,uint:1,uvec2:2,uvec3:3,uvec4:4,bool:1,bvec2:2,bvec3:3,bvec4:4,mat2:4,mat3:9,mat4:16,sampler2D:1};function mapSize(R){return GLSL_TO_SIZE[R]}let GL_TABLE=null;const GL_TO_GLSL_TYPES={FLOAT:"float",FLOAT_VEC2:"vec2",FLOAT_VEC3:"vec3",FLOAT_VEC4:"vec4",INT:"int",INT_VEC2:"ivec2",INT_VEC3:"ivec3",INT_VEC4:"ivec4",UNSIGNED_INT:"uint",UNSIGNED_INT_VEC2:"uvec2",UNSIGNED_INT_VEC3:"uvec3",UNSIGNED_INT_VEC4:"uvec4",BOOL:"bool",BOOL_VEC2:"bvec2",BOOL_VEC3:"bvec3",BOOL_VEC4:"bvec4",FLOAT_MAT2:"mat2",FLOAT_MAT3:"mat3",FLOAT_MAT4:"mat4",SAMPLER_2D:"sampler2D",INT_SAMPLER_2D:"sampler2D",UNSIGNED_INT_SAMPLER_2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT_SAMPLER_CUBE:"samplerCube",UNSIGNED_INT_SAMPLER_CUBE:"samplerCube",SAMPLER_2D_ARRAY:"sampler2DArray",INT_SAMPLER_2D_ARRAY:"sampler2DArray",UNSIGNED_INT_SAMPLER_2D_ARRAY:"sampler2DArray"};function mapType(R,T){if(!GL_TABLE){const L=Object.keys(GL_TO_GLSL_TYPES);GL_TABLE={};for(let P=0;P<L.length;++P){const I=L[P];GL_TABLE[R[I]]=GL_TO_GLSL_TYPES[I]}}return GL_TABLE[T]}function setPrecision(R,T,L){if(R.substring(0,9)!=="precision"){let P=T;return T===PRECISION.HIGH&&L!==PRECISION.HIGH&&(P=PRECISION.MEDIUM),`precision ${P} float;
${R}`}else if(L!==PRECISION.HIGH&&R.substring(0,15)==="precision highp")return R.replace("precision highp","precision mediump");return R}let unsafeEval;function unsafeEvalSupported(){if(typeof unsafeEval=="boolean")return unsafeEval;try{unsafeEval=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{unsafeEval=!1}return unsafeEval}let UID$2=0;const nameCache={},_Program=class Cs{constructor(T,L,P="pixi-shader",I={}){this.extra={},this.id=UID$2++,this.vertexSrc=T||Cs.defaultVertexSrc,this.fragmentSrc=L||Cs.defaultFragmentSrc,this.vertexSrc=this.vertexSrc.trim(),this.fragmentSrc=this.fragmentSrc.trim(),this.extra=I,this.vertexSrc.substring(0,8)!=="#version"&&(P=P.replace(/\s+/g,"-"),nameCache[P]?(nameCache[P]++,P+=`-${nameCache[P]}`):nameCache[P]=1,this.vertexSrc=`#define SHADER_NAME ${P}
${this.vertexSrc}`,this.fragmentSrc=`#define SHADER_NAME ${P}
${this.fragmentSrc}`,this.vertexSrc=setPrecision(this.vertexSrc,Cs.defaultVertexPrecision,PRECISION.HIGH),this.fragmentSrc=setPrecision(this.fragmentSrc,Cs.defaultFragmentPrecision,getMaxFragmentPrecision())),this.glPrograms={},this.syncUniforms=null}static get defaultVertexSrc(){return defaultVertex$2}static get defaultFragmentSrc(){return defaultFragment$2}static from(T,L,P){const I=T+L;let F=ProgramCache[I];return F||(ProgramCache[I]=F=new Cs(T,L,P)),F}};_Program.defaultVertexPrecision=PRECISION.HIGH,_Program.defaultFragmentPrecision=isMobile.apple.device?PRECISION.HIGH:PRECISION.MEDIUM;let Program=_Program,UID$1=0;class UniformGroup{constructor(T,L,P){this.group=!0,this.syncUniforms={},this.dirtyId=0,this.id=UID$1++,this.static=!!L,this.ubo=!!P,T instanceof Buffer$1?(this.buffer=T,this.buffer.type=BUFFER_TYPE.UNIFORM_BUFFER,this.autoManage=!1,this.ubo=!0):(this.uniforms=T,this.ubo&&(this.buffer=new Buffer$1(new Float32Array(1)),this.buffer.type=BUFFER_TYPE.UNIFORM_BUFFER,this.autoManage=!0))}update(){this.dirtyId++,!this.autoManage&&this.buffer&&this.buffer.update()}add(T,L,P){if(!this.ubo)this.uniforms[T]=new UniformGroup(L,P);else throw new Error("[UniformGroup] uniform groups in ubo mode cannot be modified, or have uniform groups nested in them")}static from(T,L,P){return new UniformGroup(T,L,P)}static uboFrom(T,L){return new UniformGroup(T,L??!0,!0)}}class Shader{constructor(T,L){this.uniformBindCount=0,this.program=T,L?L instanceof UniformGroup?this.uniformGroup=L:this.uniformGroup=new UniformGroup(L):this.uniformGroup=new UniformGroup({}),this.disposeRunner=new Runner("disposeShader")}checkUniformExists(T,L){if(L.uniforms[T])return!0;for(const P in L.uniforms){const I=L.uniforms[P];if(I.group===!0&&this.checkUniformExists(T,I))return!0}return!1}destroy(){this.uniformGroup=null,this.disposeRunner.emit(this),this.disposeRunner.destroy()}get uniforms(){return this.uniformGroup.uniforms}static from(T,L,P){const I=Program.from(T,L);return new Shader(I,P)}}class BatchShaderGenerator{constructor(T,L){if(this.vertexSrc=T,this.fragTemplate=L,this.programCache={},this.defaultGroupCache={},!L.includes("%count%"))throw new Error('Fragment template must contain "%count%".');if(!L.includes("%forloop%"))throw new Error('Fragment template must contain "%forloop%".')}generateShader(T){if(!this.programCache[T]){const P=new Int32Array(T);for(let F=0;F<T;F++)P[F]=F;this.defaultGroupCache[T]=UniformGroup.from({uSamplers:P},!0);let I=this.fragTemplate;I=I.replace(/%count%/gi,`${T}`),I=I.replace(/%forloop%/gi,this.generateSampleSrc(T)),this.programCache[T]=new Program(this.vertexSrc,I)}const L={tint:new Float32Array([1,1,1,1]),translationMatrix:new Matrix,default:this.defaultGroupCache[T]};return new Shader(this.programCache[T],L)}generateSampleSrc(T){let L="";L+=`
`,L+=`
`;for(let P=0;P<T;P++)P>0&&(L+=`
else `),P<T-1&&(L+=`if(vTextureId < ${P}.5)`),L+=`
{`,L+=`
	color = texture2D(uSamplers[${P}], vTextureCoord);`,L+=`
}`;return L+=`
`,L+=`
`,L}}class BatchTextureArray{constructor(){this.elements=[],this.ids=[],this.count=0}clear(){for(let T=0;T<this.count;T++)this.elements[T]=null;this.count=0}}function canUploadSameBuffer(){return!isMobile.apple.device}function maxRecommendedTextures(R){let T=!0;const L=settings.ADAPTER.getNavigator();if(isMobile.tablet||isMobile.phone){if(isMobile.apple.device){const P=L.userAgent.match(/OS (\d+)_(\d+)?/);P&&parseInt(P[1],10)<11&&(T=!1)}if(isMobile.android.device){const P=L.userAgent.match(/Android\s([0-9.]*)/);P&&parseInt(P[1],10)<7&&(T=!1)}}return T?R:4}class ObjectRenderer{constructor(T){this.renderer=T}flush(){}destroy(){this.renderer=null}start(){}stop(){this.flush()}render(T){}}var defaultFragment$1=`varying vec2 vTextureCoord;
varying vec4 vColor;
varying float vTextureId;
uniform sampler2D uSamplers[%count%];

void main(void){
    vec4 color;
    %forloop%
    gl_FragColor = color * vColor;
}
`,defaultVertex$1=`precision highp float;
attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;
attribute vec4 aColor;
attribute float aTextureId;

uniform mat3 projectionMatrix;
uniform mat3 translationMatrix;
uniform vec4 tint;

varying vec2 vTextureCoord;
varying vec4 vColor;
varying float vTextureId;

void main(void){
    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);

    vTextureCoord = aTextureCoord;
    vTextureId = aTextureId;
    vColor = aColor * tint;
}
`;const _BatchRenderer=class Vi extends ObjectRenderer{constructor(T){super(T),this.setShaderGenerator(),this.geometryClass=BatchGeometry,this.vertexSize=6,this.state=State.for2d(),this.size=Vi.defaultBatchSize*4,this._vertexCount=0,this._indexCount=0,this._bufferedElements=[],this._bufferedTextures=[],this._bufferSize=0,this._shader=null,this._packedGeometries=[],this._packedGeometryPoolSize=2,this._flushId=0,this._aBuffers={},this._iBuffers={},this.maxTextures=1,this.renderer.on("prerender",this.onPrerender,this),T.runners.contextChange.add(this),this._dcIndex=0,this._aIndex=0,this._iIndex=0,this._attributeBuffer=null,this._indexBuffer=null,this._tempBoundTextures=[]}static get defaultMaxTextures(){return this._defaultMaxTextures=this._defaultMaxTextures??maxRecommendedTextures(32),this._defaultMaxTextures}static set defaultMaxTextures(T){this._defaultMaxTextures=T}static get canUploadSameBuffer(){return this._canUploadSameBuffer=this._canUploadSameBuffer??canUploadSameBuffer(),this._canUploadSameBuffer}static set canUploadSameBuffer(T){this._canUploadSameBuffer=T}get MAX_TEXTURES(){return deprecation("7.1.0","BatchRenderer#MAX_TEXTURES renamed to BatchRenderer#maxTextures"),this.maxTextures}static get defaultVertexSrc(){return defaultVertex$1}static get defaultFragmentTemplate(){return defaultFragment$1}setShaderGenerator({vertex:T=Vi.defaultVertexSrc,fragment:L=Vi.defaultFragmentTemplate}={}){this.shaderGenerator=new BatchShaderGenerator(T,L)}contextChange(){const T=this.renderer.gl;settings.PREFER_ENV===ENV.WEBGL_LEGACY?this.maxTextures=1:(this.maxTextures=Math.min(T.getParameter(T.MAX_TEXTURE_IMAGE_UNITS),Vi.defaultMaxTextures),this.maxTextures=checkMaxIfStatementsInShader(this.maxTextures,T)),this._shader=this.shaderGenerator.generateShader(this.maxTextures);for(let L=0;L<this._packedGeometryPoolSize;L++)this._packedGeometries[L]=new this.geometryClass;this.initFlushBuffers()}initFlushBuffers(){const{_drawCallPool:T,_textureArrayPool:L}=Vi,P=this.size/4,I=Math.floor(P/this.maxTextures)+1;for(;T.length<P;)T.push(new BatchDrawCall);for(;L.length<I;)L.push(new BatchTextureArray);for(let F=0;F<this.maxTextures;F++)this._tempBoundTextures[F]=null}onPrerender(){this._flushId=0}render(T){T._texture.valid&&(this._vertexCount+T.vertexData.length/2>this.size&&this.flush(),this._vertexCount+=T.vertexData.length/2,this._indexCount+=T.indices.length,this._bufferedTextures[this._bufferSize]=T._texture.baseTexture,this._bufferedElements[this._bufferSize++]=T)}buildTexturesAndDrawCalls(){const{_bufferedTextures:T,maxTextures:L}=this,P=Vi._textureArrayPool,I=this.renderer.batch,F=this._tempBoundTextures,D=this.renderer.textureGC.count;let V=++BaseTexture._globalBatch,q=0,G=P[0],z=0;I.copyBoundTextures(F,L);for(let Q=0;Q<this._bufferSize;++Q){const J=T[Q];T[Q]=null,J._batchEnabled!==V&&(G.count>=L&&(I.boundArray(G,F,V,L),this.buildDrawCalls(G,z,Q),z=Q,G=P[++q],++V),J._batchEnabled=V,J.touched=D,G.elements[G.count++]=J)}G.count>0&&(I.boundArray(G,F,V,L),this.buildDrawCalls(G,z,this._bufferSize),++q,++V);for(let Q=0;Q<F.length;Q++)F[Q]=null;BaseTexture._globalBatch=V}buildDrawCalls(T,L,P){const{_bufferedElements:I,_attributeBuffer:F,_indexBuffer:D,vertexSize:V}=this,q=Vi._drawCallPool;let G=this._dcIndex,z=this._aIndex,Q=this._iIndex,J=q[G];J.start=this._iIndex,J.texArray=T;for(let tt=L;tt<P;++tt){const yt=I[tt],At=yt._texture.baseTexture,gt=premultiplyBlendMode[At.alphaMode?1:0][yt.blendMode];I[tt]=null,L<tt&&J.blend!==gt&&(J.size=Q-J.start,L=tt,J=q[++G],J.texArray=T,J.start=Q),this.packInterleavedGeometry(yt,F,D,z,Q),z+=yt.vertexData.length/2*V,Q+=yt.indices.length,J.blend=gt}L<P&&(J.size=Q-J.start,++G),this._dcIndex=G,this._aIndex=z,this._iIndex=Q}bindAndClearTexArray(T){const L=this.renderer.texture;for(let P=0;P<T.count;P++)L.bind(T.elements[P],T.ids[P]),T.elements[P]=null;T.count=0}updateGeometry(){const{_packedGeometries:T,_attributeBuffer:L,_indexBuffer:P}=this;Vi.canUploadSameBuffer?(T[this._flushId]._buffer.update(L.rawBinaryData),T[this._flushId]._indexBuffer.update(P),this.renderer.geometry.updateBuffers()):(this._packedGeometryPoolSize<=this._flushId&&(this._packedGeometryPoolSize++,T[this._flushId]=new this.geometryClass),T[this._flushId]._buffer.update(L.rawBinaryData),T[this._flushId]._indexBuffer.update(P),this.renderer.geometry.bind(T[this._flushId]),this.renderer.geometry.updateBuffers(),this._flushId++)}drawBatches(){const T=this._dcIndex,{gl:L,state:P}=this.renderer,I=Vi._drawCallPool;let F=null;for(let D=0;D<T;D++){const{texArray:V,type:q,size:G,start:z,blend:Q}=I[D];F!==V&&(F=V,this.bindAndClearTexArray(V)),this.state.blendMode=Q,P.set(this.state),L.drawElements(q,G,L.UNSIGNED_SHORT,z*2)}}flush(){this._vertexCount!==0&&(this._attributeBuffer=this.getAttributeBuffer(this._vertexCount),this._indexBuffer=this.getIndexBuffer(this._indexCount),this._aIndex=0,this._iIndex=0,this._dcIndex=0,this.buildTexturesAndDrawCalls(),this.updateGeometry(),this.drawBatches(),this._bufferSize=0,this._vertexCount=0,this._indexCount=0)}start(){this.renderer.state.set(this.state),this.renderer.texture.ensureSamplerType(this.maxTextures),this.renderer.shader.bind(this._shader),Vi.canUploadSameBuffer&&this.renderer.geometry.bind(this._packedGeometries[this._flushId])}stop(){this.flush()}destroy(){for(let T=0;T<this._packedGeometryPoolSize;T++)this._packedGeometries[T]&&this._packedGeometries[T].destroy();this.renderer.off("prerender",this.onPrerender,this),this._aBuffers=null,this._iBuffers=null,this._packedGeometries=null,this._attributeBuffer=null,this._indexBuffer=null,this._shader&&(this._shader.destroy(),this._shader=null),super.destroy()}getAttributeBuffer(T){const L=nextPow2(Math.ceil(T/8)),P=log2(L),I=L*8;this._aBuffers.length<=P&&(this._iBuffers.length=P+1);let F=this._aBuffers[I];return F||(this._aBuffers[I]=F=new ViewableBuffer(I*this.vertexSize*4)),F}getIndexBuffer(T){const L=nextPow2(Math.ceil(T/12)),P=log2(L),I=L*12;this._iBuffers.length<=P&&(this._iBuffers.length=P+1);let F=this._iBuffers[P];return F||(this._iBuffers[P]=F=new Uint16Array(I)),F}packInterleavedGeometry(T,L,P,I,F){const{uint32View:D,float32View:V}=L,q=I/this.vertexSize,G=T.uvs,z=T.indices,Q=T.vertexData,J=T._texture.baseTexture._batchLocation,tt=Math.min(T.worldAlpha,1),yt=Color.shared.setValue(T._tintRGB).toPremultiplied(tt,T._texture.baseTexture.alphaMode>0);for(let At=0;At<Q.length;At+=2)V[I++]=Q[At],V[I++]=Q[At+1],V[I++]=G[At],V[I++]=G[At+1],D[I++]=yt,V[I++]=J;for(let At=0;At<z.length;At++)P[F++]=q+z[At]}};_BatchRenderer.defaultBatchSize=4096,_BatchRenderer.extension={name:"batch",type:ExtensionType.RendererPlugin},_BatchRenderer._drawCallPool=[],_BatchRenderer._textureArrayPool=[];let BatchRenderer=_BatchRenderer;extensions.add(BatchRenderer);var defaultFragment=`varying vec2 vTextureCoord;

uniform sampler2D uSampler;

void main(void){
   gl_FragColor = texture2D(uSampler, vTextureCoord);
}
`,defaultVertex=`attribute vec2 aVertexPosition;

uniform mat3 projectionMatrix;

varying vec2 vTextureCoord;

uniform vec4 inputSize;
uniform vec4 outputFrame;

vec4 filterVertexPosition( void )
{
    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;

    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aVertexPosition * (outputFrame.zw * inputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`;const _Filter=class Os extends Shader{constructor(T,L,P){const I=Program.from(T||Os.defaultVertexSrc,L||Os.defaultFragmentSrc);super(I,P),this.padding=0,this.resolution=Os.defaultResolution,this.multisample=Os.defaultMultisample,this.enabled=!0,this.autoFit=!0,this.state=new State}apply(T,L,P,I,F){T.applyFilter(this,L,P,I)}get blendMode(){return this.state.blendMode}set blendMode(T){this.state.blendMode=T}get resolution(){return this._resolution}set resolution(T){this._resolution=T}static get defaultVertexSrc(){return defaultVertex}static get defaultFragmentSrc(){return defaultFragment}};_Filter.defaultResolution=1,_Filter.defaultMultisample=MSAA_QUALITY.NONE;let Filter=_Filter;class BackgroundSystem{constructor(){this.clearBeforeRender=!0,this._backgroundColor=new Color(0),this.alpha=1}init(T){this.clearBeforeRender=T.clearBeforeRender;const{backgroundColor:L,background:P,backgroundAlpha:I}=T,F=P??L;F!==void 0&&(this.color=F),this.alpha=I}get color(){return this._backgroundColor.value}set color(T){this._backgroundColor.setValue(T)}get alpha(){return this._backgroundColor.alpha}set alpha(T){this._backgroundColor.setAlpha(T)}get backgroundColor(){return this._backgroundColor}destroy(){}}BackgroundSystem.defaultOptions={backgroundAlpha:1,backgroundColor:0,clearBeforeRender:!0},BackgroundSystem.extension={type:[ExtensionType.RendererSystem,ExtensionType.CanvasRendererSystem],name:"background"};extensions.add(BackgroundSystem);class BatchSystem{constructor(T){this.renderer=T,this.emptyRenderer=new ObjectRenderer(T),this.currentRenderer=this.emptyRenderer}setObjectRenderer(T){this.currentRenderer!==T&&(this.currentRenderer.stop(),this.currentRenderer=T,this.currentRenderer.start())}flush(){this.setObjectRenderer(this.emptyRenderer)}reset(){this.setObjectRenderer(this.emptyRenderer)}copyBoundTextures(T,L){const{boundTextures:P}=this.renderer.texture;for(let I=L-1;I>=0;--I)T[I]=P[I]||null,T[I]&&(T[I]._batchLocation=I)}boundArray(T,L,P,I){const{elements:F,ids:D,count:V}=T;let q=0;for(let G=0;G<V;G++){const z=F[G],Q=z._batchLocation;if(Q>=0&&Q<I&&L[Q]===z){D[G]=Q;continue}for(;q<I;){const J=L[q];if(J&&J._batchEnabled===P&&J._batchLocation===q){q++;continue}D[G]=q,z._batchLocation=q,L[q]=z;break}}}destroy(){this.renderer=null}}BatchSystem.extension={type:ExtensionType.RendererSystem,name:"batch"};extensions.add(BatchSystem);let CONTEXT_UID_COUNTER=0;class ContextSystem{constructor(T){this.renderer=T,this.webGLVersion=1,this.extensions={},this.supports={uint32Indices:!1},this.handleContextLost=this.handleContextLost.bind(this),this.handleContextRestored=this.handleContextRestored.bind(this)}get isLost(){return!this.gl||this.gl.isContextLost()}contextChange(T){this.gl=T,this.renderer.gl=T,this.renderer.CONTEXT_UID=CONTEXT_UID_COUNTER++}init(T){if(T.context)this.initFromContext(T.context);else{const L=this.renderer.background.alpha<1,P=T.premultipliedAlpha;this.preserveDrawingBuffer=T.preserveDrawingBuffer,this.useContextAlpha=T.useContextAlpha,this.powerPreference=T.powerPreference,this.initFromOptions({alpha:L,premultipliedAlpha:P,antialias:T.antialias,stencil:!0,preserveDrawingBuffer:T.preserveDrawingBuffer,powerPreference:T.powerPreference})}}initFromContext(T){this.gl=T,this.validateContext(T),this.renderer.gl=T,this.renderer.CONTEXT_UID=CONTEXT_UID_COUNTER++,this.renderer.runners.contextChange.emit(T);const L=this.renderer.view;L.addEventListener!==void 0&&(L.addEventListener("webglcontextlost",this.handleContextLost,!1),L.addEventListener("webglcontextrestored",this.handleContextRestored,!1))}initFromOptions(T){const L=this.createContext(this.renderer.view,T);this.initFromContext(L)}createContext(T,L){let P;if(settings.PREFER_ENV>=ENV.WEBGL2&&(P=T.getContext("webgl2",L)),P)this.webGLVersion=2;else if(this.webGLVersion=1,P=T.getContext("webgl",L)||T.getContext("experimental-webgl",L),!P)throw new Error("This browser does not support WebGL. Try using the canvas renderer");return this.gl=P,this.getExtensions(),this.gl}getExtensions(){const{gl:T}=this,L={loseContext:T.getExtension("WEBGL_lose_context"),anisotropicFiltering:T.getExtension("EXT_texture_filter_anisotropic"),floatTextureLinear:T.getExtension("OES_texture_float_linear"),s3tc:T.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:T.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:T.getExtension("WEBGL_compressed_texture_etc"),etc1:T.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:T.getExtension("WEBGL_compressed_texture_pvrtc")||T.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:T.getExtension("WEBGL_compressed_texture_atc"),astc:T.getExtension("WEBGL_compressed_texture_astc"),bptc:T.getExtension("EXT_texture_compression_bptc")};this.webGLVersion===1?Object.assign(this.extensions,L,{drawBuffers:T.getExtension("WEBGL_draw_buffers"),depthTexture:T.getExtension("WEBGL_depth_texture"),vertexArrayObject:T.getExtension("OES_vertex_array_object")||T.getExtension("MOZ_OES_vertex_array_object")||T.getExtension("WEBKIT_OES_vertex_array_object"),uint32ElementIndex:T.getExtension("OES_element_index_uint"),floatTexture:T.getExtension("OES_texture_float"),floatTextureLinear:T.getExtension("OES_texture_float_linear"),textureHalfFloat:T.getExtension("OES_texture_half_float"),textureHalfFloatLinear:T.getExtension("OES_texture_half_float_linear")}):this.webGLVersion===2&&Object.assign(this.extensions,L,{colorBufferFloat:T.getExtension("EXT_color_buffer_float")})}handleContextLost(T){T.preventDefault(),setTimeout(()=>{this.gl.isContextLost()&&this.extensions.loseContext&&this.extensions.loseContext.restoreContext()},0)}handleContextRestored(){this.renderer.runners.contextChange.emit(this.gl)}destroy(){const T=this.renderer.view;this.renderer=null,T.removeEventListener!==void 0&&(T.removeEventListener("webglcontextlost",this.handleContextLost),T.removeEventListener("webglcontextrestored",this.handleContextRestored)),this.gl.useProgram(null),this.extensions.loseContext&&this.extensions.loseContext.loseContext()}postrender(){this.renderer.objectRenderer.renderingToScreen&&this.gl.flush()}validateContext(T){const L=T.getContextAttributes(),P="WebGL2RenderingContext"in globalThis&&T instanceof globalThis.WebGL2RenderingContext;P&&(this.webGLVersion=2),L&&!L.stencil&&console.warn("Provided WebGL context does not have a stencil buffer, masks may not render correctly");const I=P||!!T.getExtension("OES_element_index_uint");this.supports.uint32Indices=I,I||console.warn("Provided WebGL context does not support 32 index buffer, complex graphics may not render correctly")}}ContextSystem.defaultOptions={context:null,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"default"},ContextSystem.extension={type:ExtensionType.RendererSystem,name:"context"};extensions.add(ContextSystem);class Framebuffer{constructor(T,L){if(this.width=Math.round(T),this.height=Math.round(L),!this.width||!this.height)throw new Error("Framebuffer width or height is zero");this.stencil=!1,this.depth=!1,this.dirtyId=0,this.dirtyFormat=0,this.dirtySize=0,this.depthTexture=null,this.colorTextures=[],this.glFramebuffers={},this.disposeRunner=new Runner("disposeFramebuffer"),this.multisample=MSAA_QUALITY.NONE}get colorTexture(){return this.colorTextures[0]}addColorTexture(T=0,L){return this.colorTextures[T]=L||new BaseTexture(null,{scaleMode:SCALE_MODES.NEAREST,resolution:1,mipmap:MIPMAP_MODES.OFF,width:this.width,height:this.height}),this.dirtyId++,this.dirtyFormat++,this}addDepthTexture(T){return this.depthTexture=T||new BaseTexture(null,{scaleMode:SCALE_MODES.NEAREST,resolution:1,width:this.width,height:this.height,mipmap:MIPMAP_MODES.OFF,format:FORMATS.DEPTH_COMPONENT,type:TYPES.UNSIGNED_SHORT}),this.dirtyId++,this.dirtyFormat++,this}enableDepth(){return this.depth=!0,this.dirtyId++,this.dirtyFormat++,this}enableStencil(){return this.stencil=!0,this.dirtyId++,this.dirtyFormat++,this}resize(T,L){if(T=Math.round(T),L=Math.round(L),!T||!L)throw new Error("Framebuffer width and height must not be zero");if(!(T===this.width&&L===this.height)){this.width=T,this.height=L,this.dirtyId++,this.dirtySize++;for(let P=0;P<this.colorTextures.length;P++){const I=this.colorTextures[P],F=I.resolution;I.setSize(T/F,L/F)}if(this.depthTexture){const P=this.depthTexture.resolution;this.depthTexture.setSize(T/P,L/P)}}}dispose(){this.disposeRunner.emit(this,!1)}destroyDepthTexture(){this.depthTexture&&(this.depthTexture.destroy(),this.depthTexture=null,++this.dirtyId,++this.dirtyFormat)}}class BaseRenderTexture extends BaseTexture{constructor(T={}){if(typeof T=="number"){const L=arguments[0],P=arguments[1],I=arguments[2],F=arguments[3];T={width:L,height:P,scaleMode:I,resolution:F}}T.width=T.width??100,T.height=T.height??100,T.multisample??(T.multisample=MSAA_QUALITY.NONE),super(null,T),this.mipmap=MIPMAP_MODES.OFF,this.valid=!0,this._clear=new Color([0,0,0,0]),this.framebuffer=new Framebuffer(this.realWidth,this.realHeight).addColorTexture(0,this),this.framebuffer.multisample=T.multisample,this.maskStack=[],this.filterStack=[{}]}set clearColor(T){this._clear.setValue(T)}get clearColor(){return this._clear.value}get clear(){return this._clear}get multisample(){return this.framebuffer.multisample}set multisample(T){this.framebuffer.multisample=T}resize(T,L){this.framebuffer.resize(T*this.resolution,L*this.resolution),this.setRealSize(this.framebuffer.width,this.framebuffer.height)}dispose(){this.framebuffer.dispose(),super.dispose()}destroy(){super.destroy(),this.framebuffer.destroyDepthTexture(),this.framebuffer=null}}class BaseImageResource extends Resource{constructor(T){const L=T,P=L.naturalWidth||L.videoWidth||L.displayWidth||L.width,I=L.naturalHeight||L.videoHeight||L.displayHeight||L.height;super(P,I),this.source=T,this.noSubImage=!1}static crossOrigin(T,L,P){P===void 0&&!L.startsWith("data:")?T.crossOrigin=determineCrossOrigin(L):P!==!1&&(T.crossOrigin=typeof P=="string"?P:"anonymous")}upload(T,L,P,I){const F=T.gl,D=L.realWidth,V=L.realHeight;if(I=I||this.source,typeof HTMLImageElement<"u"&&I instanceof HTMLImageElement){if(!I.complete||I.naturalWidth===0)return!1}else if(typeof HTMLVideoElement<"u"&&I instanceof HTMLVideoElement&&I.readyState<=1)return!1;return F.pixelStorei(F.UNPACK_PREMULTIPLY_ALPHA_WEBGL,L.alphaMode===ALPHA_MODES.UNPACK),!this.noSubImage&&L.target===F.TEXTURE_2D&&P.width===D&&P.height===V?F.texSubImage2D(F.TEXTURE_2D,0,0,0,L.format,P.type,I):(P.width=D,P.height=V,F.texImage2D(L.target,0,P.internalFormat,L.format,P.type,I)),!0}update(){if(this.destroyed)return;const T=this.source,L=T.naturalWidth||T.videoWidth||T.width,P=T.naturalHeight||T.videoHeight||T.height;this.resize(L,P),super.update()}dispose(){this.source=null}}class ImageResource extends BaseImageResource{constructor(T,L){if(L=L||{},typeof T=="string"){const P=new Image;BaseImageResource.crossOrigin(P,T,L.crossorigin),P.src=T,T=P}super(T),!T.complete&&this._width&&this._height&&(this._width=0,this._height=0),this.url=T.src,this._process=null,this.preserveBitmap=!1,this.createBitmap=(L.createBitmap??settings.CREATE_IMAGE_BITMAP)&&!!globalThis.createImageBitmap,this.alphaMode=typeof L.alphaMode=="number"?L.alphaMode:null,this.bitmap=null,this._load=null,L.autoLoad!==!1&&this.load()}load(T){return this._load?this._load:(T!==void 0&&(this.createBitmap=T),this._load=new Promise((L,P)=>{const I=this.source;this.url=I.src;const F=()=>{this.destroyed||(I.onload=null,I.onerror=null,this.update(),this._load=null,this.createBitmap?L(this.process()):L(this))};I.complete&&I.src?F():(I.onload=F,I.onerror=D=>{P(D),this.onError.emit(D)})}),this._load)}process(){const T=this.source;if(this._process!==null)return this._process;if(this.bitmap!==null||!globalThis.createImageBitmap)return Promise.resolve(this);const L=globalThis.createImageBitmap,P=!T.crossOrigin||T.crossOrigin==="anonymous";return this._process=fetch(T.src,{mode:P?"cors":"no-cors"}).then(I=>I.blob()).then(I=>L(I,0,0,T.width,T.height,{premultiplyAlpha:this.alphaMode===null||this.alphaMode===ALPHA_MODES.UNPACK?"premultiply":"none"})).then(I=>this.destroyed?Promise.reject():(this.bitmap=I,this.update(),this._process=null,Promise.resolve(this))),this._process}upload(T,L,P){if(typeof this.alphaMode=="number"&&(L.alphaMode=this.alphaMode),!this.createBitmap)return super.upload(T,L,P);if(!this.bitmap&&(this.process(),!this.bitmap))return!1;if(super.upload(T,L,P,this.bitmap),!this.preserveBitmap){let I=!0;const F=L._glTextures;for(const D in F){const V=F[D];if(V!==P&&V.dirtyId!==L.dirtyId){I=!1;break}}I&&(this.bitmap.close&&this.bitmap.close(),this.bitmap=null)}return!0}dispose(){this.source.onload=null,this.source.onerror=null,super.dispose(),this.bitmap&&(this.bitmap.close(),this.bitmap=null),this._process=null,this._load=null}static test(T){return typeof HTMLImageElement<"u"&&(typeof T=="string"||T instanceof HTMLImageElement)}}class TextureUvs{constructor(){this.x0=0,this.y0=0,this.x1=1,this.y1=0,this.x2=1,this.y2=1,this.x3=0,this.y3=1,this.uvsFloat32=new Float32Array(8)}set(T,L,P){const I=L.width,F=L.height;if(P){const D=T.width/2/I,V=T.height/2/F,q=T.x/I+D,G=T.y/F+V;P=groupD8.add(P,groupD8.NW),this.x0=q+D*groupD8.uX(P),this.y0=G+V*groupD8.uY(P),P=groupD8.add(P,2),this.x1=q+D*groupD8.uX(P),this.y1=G+V*groupD8.uY(P),P=groupD8.add(P,2),this.x2=q+D*groupD8.uX(P),this.y2=G+V*groupD8.uY(P),P=groupD8.add(P,2),this.x3=q+D*groupD8.uX(P),this.y3=G+V*groupD8.uY(P)}else this.x0=T.x/I,this.y0=T.y/F,this.x1=(T.x+T.width)/I,this.y1=T.y/F,this.x2=(T.x+T.width)/I,this.y2=(T.y+T.height)/F,this.x3=T.x/I,this.y3=(T.y+T.height)/F;this.uvsFloat32[0]=this.x0,this.uvsFloat32[1]=this.y0,this.uvsFloat32[2]=this.x1,this.uvsFloat32[3]=this.y1,this.uvsFloat32[4]=this.x2,this.uvsFloat32[5]=this.y2,this.uvsFloat32[6]=this.x3,this.uvsFloat32[7]=this.y3}}TextureUvs.prototype.toString=function(){return`[@pixi/core:TextureUvs x0=${this.x0} y0=${this.y0} x1=${this.x1} y1=${this.y1} x2=${this.x2} y2=${this.y2} x3=${this.x3} y3=${this.y3}]`};const DEFAULT_UVS=new TextureUvs;function removeAllHandlers(R){R.destroy=function(){},R.on=function(){},R.once=function(){},R.emit=function(){}}class Texture extends EventEmitter{constructor(T,L,P,I,F,D,V){if(super(),this.noFrame=!1,L||(this.noFrame=!0,L=new Rectangle(0,0,1,1)),T instanceof Texture&&(T=T.baseTexture),this.baseTexture=T,this._frame=L,this.trim=I,this.valid=!1,this.destroyed=!1,this._uvs=DEFAULT_UVS,this.uvMatrix=null,this.orig=P||L,this._rotate=Number(F||0),F===!0)this._rotate=2;else if(this._rotate%2!==0)throw new Error("attempt to use diamond-shaped UVs. If you are sure, set rotation manually");this.defaultAnchor=D?new Point(D.x,D.y):new Point(0,0),this.defaultBorders=V,this._updateID=0,this.textureCacheIds=[],T.valid?this.noFrame?T.valid&&this.onBaseTextureUpdated(T):this.frame=L:T.once("loaded",this.onBaseTextureUpdated,this),this.noFrame&&T.on("update",this.onBaseTextureUpdated,this)}update(){this.baseTexture.resource&&this.baseTexture.resource.update()}onBaseTextureUpdated(T){if(this.noFrame){if(!this.baseTexture.valid)return;this._frame.width=T.width,this._frame.height=T.height,this.valid=!0,this.updateUvs()}else this.frame=this._frame;this.emit("update",this)}destroy(T){if(this.baseTexture){if(T){const{resource:L}=this.baseTexture;L?.url&&TextureCache[L.url]&&Texture.removeFromCache(L.url),this.baseTexture.destroy()}this.baseTexture.off("loaded",this.onBaseTextureUpdated,this),this.baseTexture.off("update",this.onBaseTextureUpdated,this),this.baseTexture=null}this._frame=null,this._uvs=null,this.trim=null,this.orig=null,this.valid=!1,Texture.removeFromCache(this),this.textureCacheIds=null,this.destroyed=!0,this.emit("destroyed",this),this.removeAllListeners()}clone(){const T=this._frame.clone(),L=this._frame===this.orig?T:this.orig.clone(),P=new Texture(this.baseTexture,!this.noFrame&&T,L,this.trim?.clone(),this.rotate,this.defaultAnchor,this.defaultBorders);return this.noFrame&&(P._frame=T),P}updateUvs(){this._uvs===DEFAULT_UVS&&(this._uvs=new TextureUvs),this._uvs.set(this._frame,this.baseTexture,this.rotate),this._updateID++}static from(T,L={},P=settings.STRICT_TEXTURE_CACHE){const I=typeof T=="string";let F=null;if(I)F=T;else if(T instanceof BaseTexture){if(!T.cacheId){const V=L?.pixiIdPrefix||"pixiid";T.cacheId=`${V}-${uid()}`,BaseTexture.addToCache(T,T.cacheId)}F=T.cacheId}else{if(!T._pixiId){const V=L?.pixiIdPrefix||"pixiid";T._pixiId=`${V}_${uid()}`}F=T._pixiId}let D=TextureCache[F];if(I&&P&&!D)throw new Error(`The cacheId "${F}" does not exist in TextureCache.`);return!D&&!(T instanceof BaseTexture)?(L.resolution||(L.resolution=getResolutionOfUrl(T)),D=new Texture(new BaseTexture(T,L)),D.baseTexture.cacheId=F,BaseTexture.addToCache(D.baseTexture,F),Texture.addToCache(D,F)):!D&&T instanceof BaseTexture&&(D=new Texture(T),Texture.addToCache(D,F)),D}static fromURL(T,L){const P=Object.assign({autoLoad:!1},L?.resourceOptions),I=Texture.from(T,Object.assign({resourceOptions:P},L),!1),F=I.baseTexture.resource;return I.baseTexture.valid?Promise.resolve(I):F.load().then(()=>Promise.resolve(I))}static fromBuffer(T,L,P,I){return new Texture(BaseTexture.fromBuffer(T,L,P,I))}static fromLoader(T,L,P,I){const F=new BaseTexture(T,Object.assign({scaleMode:BaseTexture.defaultOptions.scaleMode,resolution:getResolutionOfUrl(L)},I)),{resource:D}=F;D instanceof ImageResource&&(D.url=L);const V=new Texture(F);return P||(P=L),BaseTexture.addToCache(V.baseTexture,P),Texture.addToCache(V,P),P!==L&&(BaseTexture.addToCache(V.baseTexture,L),Texture.addToCache(V,L)),V.baseTexture.valid?Promise.resolve(V):new Promise(q=>{V.baseTexture.once("loaded",()=>q(V))})}static addToCache(T,L){L&&(T.textureCacheIds.includes(L)||T.textureCacheIds.push(L),TextureCache[L]&&TextureCache[L]!==T&&console.warn(`Texture added to the cache with an id [${L}] that already had an entry`),TextureCache[L]=T)}static removeFromCache(T){if(typeof T=="string"){const L=TextureCache[T];if(L){const P=L.textureCacheIds.indexOf(T);return P>-1&&L.textureCacheIds.splice(P,1),delete TextureCache[T],L}}else if(T?.textureCacheIds){for(let L=0;L<T.textureCacheIds.length;++L)TextureCache[T.textureCacheIds[L]]===T&&delete TextureCache[T.textureCacheIds[L]];return T.textureCacheIds.length=0,T}return null}get resolution(){return this.baseTexture.resolution}get frame(){return this._frame}set frame(T){this._frame=T,this.noFrame=!1;const{x:L,y:P,width:I,height:F}=T,D=L+I>this.baseTexture.width,V=P+F>this.baseTexture.height;if(D||V){const q=D&&V?"and":"or",G=`X: ${L} + ${I} = ${L+I} > ${this.baseTexture.width}`,z=`Y: ${P} + ${F} = ${P+F} > ${this.baseTexture.height}`;throw new Error(`Texture Error: frame does not fit inside the base Texture dimensions: ${G} ${q} ${z}`)}this.valid=I&&F&&this.baseTexture.valid,!this.trim&&!this.rotate&&(this.orig=T),this.valid&&this.updateUvs()}get rotate(){return this._rotate}set rotate(T){this._rotate=T,this.valid&&this.updateUvs()}get width(){return this.orig.width}get height(){return this.orig.height}castToBaseTexture(){return this.baseTexture}static get EMPTY(){return Texture._EMPTY||(Texture._EMPTY=new Texture(new BaseTexture),removeAllHandlers(Texture._EMPTY),removeAllHandlers(Texture._EMPTY.baseTexture)),Texture._EMPTY}static get WHITE(){if(!Texture._WHITE){const T=settings.ADAPTER.createCanvas(16,16),L=T.getContext("2d");T.width=16,T.height=16,L.fillStyle="white",L.fillRect(0,0,16,16),Texture._WHITE=new Texture(BaseTexture.from(T)),removeAllHandlers(Texture._WHITE),removeAllHandlers(Texture._WHITE.baseTexture)}return Texture._WHITE}}class RenderTexture extends Texture{constructor(T,L){super(T,L),this.valid=!0,this.filterFrame=null,this.filterPoolKey=null,this.updateUvs()}get framebuffer(){return this.baseTexture.framebuffer}get multisample(){return this.framebuffer.multisample}set multisample(T){this.framebuffer.multisample=T}resize(T,L,P=!0){const I=this.baseTexture.resolution,F=Math.round(T*I)/I,D=Math.round(L*I)/I;this.valid=F>0&&D>0,this._frame.width=this.orig.width=F,this._frame.height=this.orig.height=D,P&&this.baseTexture.resize(F,D),this.updateUvs()}setResolution(T){const{baseTexture:L}=this;L.resolution!==T&&(L.setResolution(T),this.resize(L.width,L.height,!1))}static create(T){return new RenderTexture(new BaseRenderTexture(T))}}class RenderTexturePool{constructor(T){this.texturePool={},this.textureOptions=T||{},this.enableFullScreen=!1,this._pixelsWidth=0,this._pixelsHeight=0}createTexture(T,L,P=MSAA_QUALITY.NONE){const I=new BaseRenderTexture(Object.assign({width:T,height:L,resolution:1,multisample:P},this.textureOptions));return new RenderTexture(I)}getOptimalTexture(T,L,P=1,I=MSAA_QUALITY.NONE){let F;T=Math.max(Math.ceil(T*P-1e-6),1),L=Math.max(Math.ceil(L*P-1e-6),1),!this.enableFullScreen||T!==this._pixelsWidth||L!==this._pixelsHeight?(T=nextPow2(T),L=nextPow2(L),F=((T&65535)<<16|L&65535)>>>0,I>1&&(F+=I*4294967296)):F=I>1?-I:-1,this.texturePool[F]||(this.texturePool[F]=[]);let D=this.texturePool[F].pop();return D||(D=this.createTexture(T,L,I)),D.filterPoolKey=F,D.setResolution(P),D}getFilterTexture(T,L,P){const I=this.getOptimalTexture(T.width,T.height,L||T.resolution,P||MSAA_QUALITY.NONE);return I.filterFrame=T.filterFrame,I}returnTexture(T){const L=T.filterPoolKey;T.filterFrame=null,this.texturePool[L].push(T)}returnFilterTexture(T){this.returnTexture(T)}clear(T){if(T=T!==!1,T)for(const L in this.texturePool){const P=this.texturePool[L];if(P)for(let I=0;I<P.length;I++)P[I].destroy(!0)}this.texturePool={}}setScreenSize(T){if(!(T.width===this._pixelsWidth&&T.height===this._pixelsHeight)){this.enableFullScreen=T.width>0&&T.height>0;for(const L in this.texturePool){if(!(Number(L)<0))continue;const P=this.texturePool[L];if(P)for(let I=0;I<P.length;I++)P[I].destroy(!0);this.texturePool[L]=[]}this._pixelsWidth=T.width,this._pixelsHeight=T.height}}}RenderTexturePool.SCREEN_KEY=-1;class Quad extends Geometry{constructor(){super(),this.addAttribute("aVertexPosition",new Float32Array([0,0,1,0,1,1,0,1])).addIndex([0,1,3,2])}}class QuadUv extends Geometry{constructor(){super(),this.vertices=new Float32Array([-1,-1,1,-1,1,1,-1,1]),this.uvs=new Float32Array([0,0,1,0,1,1,0,1]),this.vertexBuffer=new Buffer$1(this.vertices),this.uvBuffer=new Buffer$1(this.uvs),this.addAttribute("aVertexPosition",this.vertexBuffer).addAttribute("aTextureCoord",this.uvBuffer).addIndex([0,1,2,0,2,3])}map(T,L){let P=0,I=0;return this.uvs[0]=P,this.uvs[1]=I,this.uvs[2]=P+L.width/T.width,this.uvs[3]=I,this.uvs[4]=P+L.width/T.width,this.uvs[5]=I+L.height/T.height,this.uvs[6]=P,this.uvs[7]=I+L.height/T.height,P=L.x,I=L.y,this.vertices[0]=P,this.vertices[1]=I,this.vertices[2]=P+L.width,this.vertices[3]=I,this.vertices[4]=P+L.width,this.vertices[5]=I+L.height,this.vertices[6]=P,this.vertices[7]=I+L.height,this.invalidate(),this}invalidate(){return this.vertexBuffer._updateID++,this.uvBuffer._updateID++,this}}class FilterState{constructor(){this.renderTexture=null,this.target=null,this.legacy=!1,this.resolution=1,this.multisample=MSAA_QUALITY.NONE,this.sourceFrame=new Rectangle,this.destinationFrame=new Rectangle,this.bindingSourceFrame=new Rectangle,this.bindingDestinationFrame=new Rectangle,this.filters=[],this.transform=null}clear(){this.target=null,this.filters=null,this.renderTexture=null}}const tempPoints=[new Point,new Point,new Point,new Point],tempMatrix$2=new Matrix;class FilterSystem{constructor(T){this.renderer=T,this.defaultFilterStack=[{}],this.texturePool=new RenderTexturePool,this.statePool=[],this.quad=new Quad,this.quadUv=new QuadUv,this.tempRect=new Rectangle,this.activeState={},this.globalUniforms=new UniformGroup({outputFrame:new Rectangle,inputSize:new Float32Array(4),inputPixel:new Float32Array(4),inputClamp:new Float32Array(4),resolution:1,filterArea:new Float32Array(4),filterClamp:new Float32Array(4)},!0),this.forceClear=!1,this.useMaxPadding=!1}init(){this.texturePool.setScreenSize(this.renderer.view)}push(T,L){const P=this.renderer,I=this.defaultFilterStack,F=this.statePool.pop()||new FilterState,D=P.renderTexture;let V,q;if(D.current){const gt=D.current;V=gt.resolution,q=gt.multisample}else V=P.resolution,q=P.multisample;let G=L[0].resolution||V,z=L[0].multisample??q,Q=L[0].padding,J=L[0].autoFit,tt=L[0].legacy??!0;for(let gt=1;gt<L.length;gt++){const Et=L[gt];G=Math.min(G,Et.resolution||V),z=Math.min(z,Et.multisample??q),Q=this.useMaxPadding?Math.max(Q,Et.padding):Q+Et.padding,J=J&&Et.autoFit,tt=tt||(Et.legacy??!0)}I.length===1&&(this.defaultFilterStack[0].renderTexture=D.current),I.push(F),F.resolution=G,F.multisample=z,F.legacy=tt,F.target=T,F.sourceFrame.copyFrom(T.filterArea||T.getBounds(!0)),F.sourceFrame.pad(Q);const yt=this.tempRect.copyFrom(D.sourceFrame);P.projection.transform&&this.transformAABB(tempMatrix$2.copyFrom(P.projection.transform).invert(),yt),J?(F.sourceFrame.fit(yt),(F.sourceFrame.width<=0||F.sourceFrame.height<=0)&&(F.sourceFrame.width=0,F.sourceFrame.height=0)):F.sourceFrame.intersects(yt)||(F.sourceFrame.width=0,F.sourceFrame.height=0),this.roundFrame(F.sourceFrame,D.current?D.current.resolution:P.resolution,D.sourceFrame,D.destinationFrame,P.projection.transform),F.renderTexture=this.getOptimalFilterTexture(F.sourceFrame.width,F.sourceFrame.height,G,z),F.filters=L,F.destinationFrame.width=F.renderTexture.width,F.destinationFrame.height=F.renderTexture.height;const At=this.tempRect;At.x=0,At.y=0,At.width=F.sourceFrame.width,At.height=F.sourceFrame.height,F.renderTexture.filterFrame=F.sourceFrame,F.bindingSourceFrame.copyFrom(D.sourceFrame),F.bindingDestinationFrame.copyFrom(D.destinationFrame),F.transform=P.projection.transform,P.projection.transform=null,D.bind(F.renderTexture,F.sourceFrame,At),P.framebuffer.clear(0,0,0,0)}pop(){const T=this.defaultFilterStack,L=T.pop(),P=L.filters;this.activeState=L;const I=this.globalUniforms.uniforms;I.outputFrame=L.sourceFrame,I.resolution=L.resolution;const F=I.inputSize,D=I.inputPixel,V=I.inputClamp;if(F[0]=L.destinationFrame.width,F[1]=L.destinationFrame.height,F[2]=1/F[0],F[3]=1/F[1],D[0]=Math.round(F[0]*L.resolution),D[1]=Math.round(F[1]*L.resolution),D[2]=1/D[0],D[3]=1/D[1],V[0]=.5*D[2],V[1]=.5*D[3],V[2]=L.sourceFrame.width*F[2]-.5*D[2],V[3]=L.sourceFrame.height*F[3]-.5*D[3],L.legacy){const G=I.filterArea;G[0]=L.destinationFrame.width,G[1]=L.destinationFrame.height,G[2]=L.sourceFrame.x,G[3]=L.sourceFrame.y,I.filterClamp=I.inputClamp}this.globalUniforms.update();const q=T[T.length-1];if(this.renderer.framebuffer.blit(),P.length===1)P[0].apply(this,L.renderTexture,q.renderTexture,CLEAR_MODES.BLEND,L),this.returnFilterTexture(L.renderTexture);else{let G=L.renderTexture,z=this.getOptimalFilterTexture(G.width,G.height,L.resolution);z.filterFrame=G.filterFrame;let Q=0;for(Q=0;Q<P.length-1;++Q){Q===1&&L.multisample>1&&(z=this.getOptimalFilterTexture(G.width,G.height,L.resolution),z.filterFrame=G.filterFrame),P[Q].apply(this,G,z,CLEAR_MODES.CLEAR,L);const J=G;G=z,z=J}P[Q].apply(this,G,q.renderTexture,CLEAR_MODES.BLEND,L),Q>1&&L.multisample>1&&this.returnFilterTexture(L.renderTexture),this.returnFilterTexture(G),this.returnFilterTexture(z)}L.clear(),this.statePool.push(L)}bindAndClear(T,L=CLEAR_MODES.CLEAR){const{renderTexture:P,state:I}=this.renderer;if(T===this.defaultFilterStack[this.defaultFilterStack.length-1].renderTexture?this.renderer.projection.transform=this.activeState.transform:this.renderer.projection.transform=null,T?.filterFrame){const D=this.tempRect;D.x=0,D.y=0,D.width=T.filterFrame.width,D.height=T.filterFrame.height,P.bind(T,T.filterFrame,D)}else T!==this.defaultFilterStack[this.defaultFilterStack.length-1].renderTexture?P.bind(T):this.renderer.renderTexture.bind(T,this.activeState.bindingSourceFrame,this.activeState.bindingDestinationFrame);const F=I.stateId&1||this.forceClear;(L===CLEAR_MODES.CLEAR||L===CLEAR_MODES.BLIT&&F)&&this.renderer.framebuffer.clear(0,0,0,0)}applyFilter(T,L,P,I){const F=this.renderer;F.state.set(T.state),this.bindAndClear(P,I),T.uniforms.uSampler=L,T.uniforms.filterGlobals=this.globalUniforms,F.shader.bind(T),T.legacy=!!T.program.attributeData.aTextureCoord,T.legacy?(this.quadUv.map(L._frame,L.filterFrame),F.geometry.bind(this.quadUv),F.geometry.draw(DRAW_MODES.TRIANGLES)):(F.geometry.bind(this.quad),F.geometry.draw(DRAW_MODES.TRIANGLE_STRIP))}calculateSpriteMatrix(T,L){const{sourceFrame:P,destinationFrame:I}=this.activeState,{orig:F}=L._texture,D=T.set(I.width,0,0,I.height,P.x,P.y),V=L.worldTransform.copyTo(Matrix.TEMP_MATRIX);return V.invert(),D.prepend(V),D.scale(1/F.width,1/F.height),D.translate(L.anchor.x,L.anchor.y),D}destroy(){this.renderer=null,this.texturePool.clear(!1)}getOptimalFilterTexture(T,L,P=1,I=MSAA_QUALITY.NONE){return this.texturePool.getOptimalTexture(T,L,P,I)}getFilterTexture(T,L,P){if(typeof T=="number"){const F=T;T=L,L=F}T=T||this.activeState.renderTexture;const I=this.texturePool.getOptimalTexture(T.width,T.height,L||T.resolution,P||MSAA_QUALITY.NONE);return I.filterFrame=T.filterFrame,I}returnFilterTexture(T){this.texturePool.returnTexture(T)}emptyPool(){this.texturePool.clear(!0)}resize(){this.texturePool.setScreenSize(this.renderer.view)}transformAABB(T,L){const P=tempPoints[0],I=tempPoints[1],F=tempPoints[2],D=tempPoints[3];P.set(L.left,L.top),I.set(L.left,L.bottom),F.set(L.right,L.top),D.set(L.right,L.bottom),T.apply(P,P),T.apply(I,I),T.apply(F,F),T.apply(D,D);const V=Math.min(P.x,I.x,F.x,D.x),q=Math.min(P.y,I.y,F.y,D.y),G=Math.max(P.x,I.x,F.x,D.x),z=Math.max(P.y,I.y,F.y,D.y);L.x=V,L.y=q,L.width=G-V,L.height=z-q}roundFrame(T,L,P,I,F){if(!(T.width<=0||T.height<=0||P.width<=0||P.height<=0)){if(F){const{a:D,b:V,c:q,d:G}=F;if((Math.abs(V)>1e-4||Math.abs(q)>1e-4)&&(Math.abs(D)>1e-4||Math.abs(G)>1e-4))return}F=F?tempMatrix$2.copyFrom(F):tempMatrix$2.identity(),F.translate(-P.x,-P.y).scale(I.width/P.width,I.height/P.height).translate(I.x,I.y),this.transformAABB(F,T),T.ceil(L),this.transformAABB(F.invert(),T)}}}FilterSystem.extension={type:ExtensionType.RendererSystem,name:"filter"};extensions.add(FilterSystem);class GLFramebuffer{constructor(T){this.framebuffer=T,this.stencil=null,this.dirtyId=-1,this.dirtyFormat=-1,this.dirtySize=-1,this.multisample=MSAA_QUALITY.NONE,this.msaaBuffer=null,this.blitFramebuffer=null,this.mipLevel=0}}const tempRectangle=new Rectangle;class FramebufferSystem{constructor(T){this.renderer=T,this.managedFramebuffers=[],this.unknownFramebuffer=new Framebuffer(10,10),this.msaaSamples=null}contextChange(){this.disposeAll(!0);const T=this.gl=this.renderer.gl;if(this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.current=this.unknownFramebuffer,this.viewport=new Rectangle,this.hasMRT=!0,this.writeDepthTexture=!0,this.renderer.context.webGLVersion===1){let L=this.renderer.context.extensions.drawBuffers,P=this.renderer.context.extensions.depthTexture;settings.PREFER_ENV===ENV.WEBGL_LEGACY&&(L=null,P=null),L?T.drawBuffers=I=>L.drawBuffersWEBGL(I):(this.hasMRT=!1,T.drawBuffers=()=>{}),P||(this.writeDepthTexture=!1)}else this.msaaSamples=T.getInternalformatParameter(T.RENDERBUFFER,T.RGBA8,T.SAMPLES)}bind(T,L,P=0){const{gl:I}=this;if(T){const F=T.glFramebuffers[this.CONTEXT_UID]||this.initFramebuffer(T);this.current!==T&&(this.current=T,I.bindFramebuffer(I.FRAMEBUFFER,F.framebuffer)),F.mipLevel!==P&&(T.dirtyId++,T.dirtyFormat++,F.mipLevel=P),F.dirtyId!==T.dirtyId&&(F.dirtyId=T.dirtyId,F.dirtyFormat!==T.dirtyFormat?(F.dirtyFormat=T.dirtyFormat,F.dirtySize=T.dirtySize,this.updateFramebuffer(T,P)):F.dirtySize!==T.dirtySize&&(F.dirtySize=T.dirtySize,this.resizeFramebuffer(T)));for(let D=0;D<T.colorTextures.length;D++){const V=T.colorTextures[D];this.renderer.texture.unbind(V.parentTextureArray||V)}if(T.depthTexture&&this.renderer.texture.unbind(T.depthTexture),L){const D=L.width>>P,V=L.height>>P,q=D/L.width;this.setViewport(L.x*q,L.y*q,D,V)}else{const D=T.width>>P,V=T.height>>P;this.setViewport(0,0,D,V)}}else this.current&&(this.current=null,I.bindFramebuffer(I.FRAMEBUFFER,null)),L?this.setViewport(L.x,L.y,L.width,L.height):this.setViewport(0,0,this.renderer.width,this.renderer.height)}setViewport(T,L,P,I){const F=this.viewport;T=Math.round(T),L=Math.round(L),P=Math.round(P),I=Math.round(I),(F.width!==P||F.height!==I||F.x!==T||F.y!==L)&&(F.x=T,F.y=L,F.width=P,F.height=I,this.gl.viewport(T,L,P,I))}get size(){return this.current?{x:0,y:0,width:this.current.width,height:this.current.height}:{x:0,y:0,width:this.renderer.width,height:this.renderer.height}}clear(T,L,P,I,F=BUFFER_BITS.COLOR|BUFFER_BITS.DEPTH){const{gl:D}=this;D.clearColor(T,L,P,I),D.clear(F)}initFramebuffer(T){const{gl:L}=this,P=new GLFramebuffer(L.createFramebuffer());return P.multisample=this.detectSamples(T.multisample),T.glFramebuffers[this.CONTEXT_UID]=P,this.managedFramebuffers.push(T),T.disposeRunner.add(this),P}resizeFramebuffer(T){const{gl:L}=this,P=T.glFramebuffers[this.CONTEXT_UID];if(P.stencil){L.bindRenderbuffer(L.RENDERBUFFER,P.stencil);let D;this.renderer.context.webGLVersion===1?D=L.DEPTH_STENCIL:T.depth&&T.stencil?D=L.DEPTH24_STENCIL8:T.depth?D=L.DEPTH_COMPONENT24:D=L.STENCIL_INDEX8,P.msaaBuffer?L.renderbufferStorageMultisample(L.RENDERBUFFER,P.multisample,D,T.width,T.height):L.renderbufferStorage(L.RENDERBUFFER,D,T.width,T.height)}const I=T.colorTextures;let F=I.length;L.drawBuffers||(F=Math.min(F,1));for(let D=0;D<F;D++){const V=I[D],q=V.parentTextureArray||V;this.renderer.texture.bind(q,0),D===0&&P.msaaBuffer&&(L.bindRenderbuffer(L.RENDERBUFFER,P.msaaBuffer),L.renderbufferStorageMultisample(L.RENDERBUFFER,P.multisample,q._glTextures[this.CONTEXT_UID].internalFormat,T.width,T.height))}T.depthTexture&&this.writeDepthTexture&&this.renderer.texture.bind(T.depthTexture,0)}updateFramebuffer(T,L){const{gl:P}=this,I=T.glFramebuffers[this.CONTEXT_UID],F=T.colorTextures;let D=F.length;P.drawBuffers||(D=Math.min(D,1)),I.multisample>1&&this.canMultisampleFramebuffer(T)?I.msaaBuffer=I.msaaBuffer||P.createRenderbuffer():I.msaaBuffer&&(P.deleteRenderbuffer(I.msaaBuffer),I.msaaBuffer=null,I.blitFramebuffer&&(I.blitFramebuffer.dispose(),I.blitFramebuffer=null));const V=[];for(let q=0;q<D;q++){const G=F[q],z=G.parentTextureArray||G;this.renderer.texture.bind(z,0),q===0&&I.msaaBuffer?(P.bindRenderbuffer(P.RENDERBUFFER,I.msaaBuffer),P.renderbufferStorageMultisample(P.RENDERBUFFER,I.multisample,z._glTextures[this.CONTEXT_UID].internalFormat,T.width,T.height),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0,P.RENDERBUFFER,I.msaaBuffer)):(P.framebufferTexture2D(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0+q,G.target,z._glTextures[this.CONTEXT_UID].texture,L),V.push(P.COLOR_ATTACHMENT0+q))}if(V.length>1&&P.drawBuffers(V),T.depthTexture&&this.writeDepthTexture){const q=T.depthTexture;this.renderer.texture.bind(q,0),P.framebufferTexture2D(P.FRAMEBUFFER,P.DEPTH_ATTACHMENT,P.TEXTURE_2D,q._glTextures[this.CONTEXT_UID].texture,L)}if((T.stencil||T.depth)&&!(T.depthTexture&&this.writeDepthTexture)){I.stencil=I.stencil||P.createRenderbuffer();let q,G;this.renderer.context.webGLVersion===1?(q=P.DEPTH_STENCIL_ATTACHMENT,G=P.DEPTH_STENCIL):T.depth&&T.stencil?(q=P.DEPTH_STENCIL_ATTACHMENT,G=P.DEPTH24_STENCIL8):T.depth?(q=P.DEPTH_ATTACHMENT,G=P.DEPTH_COMPONENT24):(q=P.STENCIL_ATTACHMENT,G=P.STENCIL_INDEX8),P.bindRenderbuffer(P.RENDERBUFFER,I.stencil),I.msaaBuffer?P.renderbufferStorageMultisample(P.RENDERBUFFER,I.multisample,G,T.width,T.height):P.renderbufferStorage(P.RENDERBUFFER,G,T.width,T.height),P.framebufferRenderbuffer(P.FRAMEBUFFER,q,P.RENDERBUFFER,I.stencil)}else I.stencil&&(P.deleteRenderbuffer(I.stencil),I.stencil=null)}canMultisampleFramebuffer(T){return this.renderer.context.webGLVersion!==1&&T.colorTextures.length<=1&&!T.depthTexture}detectSamples(T){const{msaaSamples:L}=this;let P=MSAA_QUALITY.NONE;if(T<=1||L===null)return P;for(let I=0;I<L.length;I++)if(L[I]<=T){P=L[I];break}return P===1&&(P=MSAA_QUALITY.NONE),P}blit(T,L,P){const{current:I,renderer:F,gl:D,CONTEXT_UID:V}=this;if(F.context.webGLVersion!==2||!I)return;const q=I.glFramebuffers[V];if(!q)return;if(!T){if(!q.msaaBuffer)return;const z=I.colorTextures[0];if(!z)return;q.blitFramebuffer||(q.blitFramebuffer=new Framebuffer(I.width,I.height),q.blitFramebuffer.addColorTexture(0,z)),T=q.blitFramebuffer,T.colorTextures[0]!==z&&(T.colorTextures[0]=z,T.dirtyId++,T.dirtyFormat++),(T.width!==I.width||T.height!==I.height)&&(T.width=I.width,T.height=I.height,T.dirtyId++,T.dirtySize++)}L||(L=tempRectangle,L.width=I.width,L.height=I.height),P||(P=L);const G=L.width===P.width&&L.height===P.height;this.bind(T),D.bindFramebuffer(D.READ_FRAMEBUFFER,q.framebuffer),D.blitFramebuffer(L.left,L.top,L.right,L.bottom,P.left,P.top,P.right,P.bottom,D.COLOR_BUFFER_BIT,G?D.NEAREST:D.LINEAR),D.bindFramebuffer(D.READ_FRAMEBUFFER,T.glFramebuffers[this.CONTEXT_UID].framebuffer)}disposeFramebuffer(T,L){const P=T.glFramebuffers[this.CONTEXT_UID],I=this.gl;if(!P)return;delete T.glFramebuffers[this.CONTEXT_UID];const F=this.managedFramebuffers.indexOf(T);F>=0&&this.managedFramebuffers.splice(F,1),T.disposeRunner.remove(this),L||(I.deleteFramebuffer(P.framebuffer),P.msaaBuffer&&I.deleteRenderbuffer(P.msaaBuffer),P.stencil&&I.deleteRenderbuffer(P.stencil)),P.blitFramebuffer&&this.disposeFramebuffer(P.blitFramebuffer,L)}disposeAll(T){const L=this.managedFramebuffers;this.managedFramebuffers=[];for(let P=0;P<L.length;P++)this.disposeFramebuffer(L[P],T)}forceStencil(){const T=this.current;if(!T)return;const L=T.glFramebuffers[this.CONTEXT_UID];if(!L||L.stencil&&T.stencil)return;T.stencil=!0;const P=T.width,I=T.height,F=this.gl,D=L.stencil=F.createRenderbuffer();F.bindRenderbuffer(F.RENDERBUFFER,D);let V,q;this.renderer.context.webGLVersion===1?(V=F.DEPTH_STENCIL_ATTACHMENT,q=F.DEPTH_STENCIL):T.depth?(V=F.DEPTH_STENCIL_ATTACHMENT,q=F.DEPTH24_STENCIL8):(V=F.STENCIL_ATTACHMENT,q=F.STENCIL_INDEX8),L.msaaBuffer?F.renderbufferStorageMultisample(F.RENDERBUFFER,L.multisample,q,P,I):F.renderbufferStorage(F.RENDERBUFFER,q,P,I),F.framebufferRenderbuffer(F.FRAMEBUFFER,V,F.RENDERBUFFER,D)}reset(){this.current=this.unknownFramebuffer,this.viewport=new Rectangle}destroy(){this.renderer=null}}FramebufferSystem.extension={type:ExtensionType.RendererSystem,name:"framebuffer"};extensions.add(FramebufferSystem);const byteSizeMap={5126:4,5123:2,5121:1};class GeometrySystem{constructor(T){this.renderer=T,this._activeGeometry=null,this._activeVao=null,this.hasVao=!0,this.hasInstance=!0,this.canUseUInt32ElementIndex=!1,this.managedGeometries={}}contextChange(){this.disposeAll(!0);const T=this.gl=this.renderer.gl,L=this.renderer.context;if(this.CONTEXT_UID=this.renderer.CONTEXT_UID,L.webGLVersion!==2){let P=this.renderer.context.extensions.vertexArrayObject;settings.PREFER_ENV===ENV.WEBGL_LEGACY&&(P=null),P?(T.createVertexArray=()=>P.createVertexArrayOES(),T.bindVertexArray=I=>P.bindVertexArrayOES(I),T.deleteVertexArray=I=>P.deleteVertexArrayOES(I)):(this.hasVao=!1,T.createVertexArray=()=>null,T.bindVertexArray=()=>null,T.deleteVertexArray=()=>null)}if(L.webGLVersion!==2){const P=T.getExtension("ANGLE_instanced_arrays");P?(T.vertexAttribDivisor=(I,F)=>P.vertexAttribDivisorANGLE(I,F),T.drawElementsInstanced=(I,F,D,V,q)=>P.drawElementsInstancedANGLE(I,F,D,V,q),T.drawArraysInstanced=(I,F,D,V)=>P.drawArraysInstancedANGLE(I,F,D,V)):this.hasInstance=!1}this.canUseUInt32ElementIndex=L.webGLVersion===2||!!L.extensions.uint32ElementIndex}bind(T,L){L=L||this.renderer.shader.shader;const{gl:P}=this;let I=T.glVertexArrayObjects[this.CONTEXT_UID],F=!1;I||(this.managedGeometries[T.id]=T,T.disposeRunner.add(this),T.glVertexArrayObjects[this.CONTEXT_UID]=I={},F=!0);const D=I[L.program.id]||this.initGeometryVao(T,L,F);this._activeGeometry=T,this._activeVao!==D&&(this._activeVao=D,this.hasVao?P.bindVertexArray(D):this.activateVao(T,L.program)),this.updateBuffers()}reset(){this.unbind()}updateBuffers(){const T=this._activeGeometry,L=this.renderer.buffer;for(let P=0;P<T.buffers.length;P++){const I=T.buffers[P];L.update(I)}}checkCompatibility(T,L){const P=T.attributes,I=L.attributeData;for(const F in I)if(!P[F])throw new Error(`shader and geometry incompatible, geometry missing the "${F}" attribute`)}getSignature(T,L){const P=T.attributes,I=L.attributeData,F=["g",T.id];for(const D in P)I[D]&&F.push(D,I[D].location);return F.join("-")}initGeometryVao(T,L,P=!0){const I=this.gl,F=this.CONTEXT_UID,D=this.renderer.buffer,V=L.program;V.glPrograms[F]||this.renderer.shader.generateProgram(L),this.checkCompatibility(T,V);const q=this.getSignature(T,V),G=T.glVertexArrayObjects[this.CONTEXT_UID];let z=G[q];if(z)return G[V.id]=z,z;const Q=T.buffers,J=T.attributes,tt={},yt={};for(const At in Q)tt[At]=0,yt[At]=0;for(const At in J)!J[At].size&&V.attributeData[At]?J[At].size=V.attributeData[At].size:J[At].size||console.warn(`PIXI Geometry attribute '${At}' size cannot be determined (likely the bound shader does not have the attribute)`),tt[J[At].buffer]+=J[At].size*byteSizeMap[J[At].type];for(const At in J){const gt=J[At],Et=gt.size;gt.stride===void 0&&(tt[gt.buffer]===Et*byteSizeMap[gt.type]?gt.stride=0:gt.stride=tt[gt.buffer]),gt.start===void 0&&(gt.start=yt[gt.buffer],yt[gt.buffer]+=Et*byteSizeMap[gt.type])}z=I.createVertexArray(),I.bindVertexArray(z);for(let At=0;At<Q.length;At++){const gt=Q[At];D.bind(gt),P&&gt._glBuffers[F].refCount++}return this.activateVao(T,V),G[V.id]=z,G[q]=z,I.bindVertexArray(null),D.unbind(BUFFER_TYPE.ARRAY_BUFFER),z}disposeGeometry(T,L){if(!this.managedGeometries[T.id])return;delete this.managedGeometries[T.id];const P=T.glVertexArrayObjects[this.CONTEXT_UID],I=this.gl,F=T.buffers,D=this.renderer?.buffer;if(T.disposeRunner.remove(this),!!P){if(D)for(let V=0;V<F.length;V++){const q=F[V]._glBuffers[this.CONTEXT_UID];q&&(q.refCount--,q.refCount===0&&!L&&D.dispose(F[V],L))}if(!L){for(const V in P)if(V[0]==="g"){const q=P[V];this._activeVao===q&&this.unbind(),I.deleteVertexArray(q)}}delete T.glVertexArrayObjects[this.CONTEXT_UID]}}disposeAll(T){const L=Object.keys(this.managedGeometries);for(let P=0;P<L.length;P++)this.disposeGeometry(this.managedGeometries[L[P]],T)}activateVao(T,L){const P=this.gl,I=this.CONTEXT_UID,F=this.renderer.buffer,D=T.buffers,V=T.attributes;T.indexBuffer&&F.bind(T.indexBuffer);let q=null;for(const G in V){const z=V[G],Q=D[z.buffer],J=Q._glBuffers[I];if(L.attributeData[G]){q!==J&&(F.bind(Q),q=J);const tt=L.attributeData[G].location;if(P.enableVertexAttribArray(tt),P.vertexAttribPointer(tt,z.size,z.type||P.FLOAT,z.normalized,z.stride,z.start),z.instance)if(this.hasInstance)P.vertexAttribDivisor(tt,z.divisor);else throw new Error("geometry error, GPU Instancing is not supported on this device")}}}draw(T,L,P,I){const{gl:F}=this,D=this._activeGeometry;if(D.indexBuffer){const V=D.indexBuffer.data.BYTES_PER_ELEMENT,q=V===2?F.UNSIGNED_SHORT:F.UNSIGNED_INT;V===2||V===4&&this.canUseUInt32ElementIndex?D.instanced?F.drawElementsInstanced(T,L||D.indexBuffer.data.length,q,(P||0)*V,I||1):F.drawElements(T,L||D.indexBuffer.data.length,q,(P||0)*V):console.warn("unsupported index buffer type: uint32")}else D.instanced?F.drawArraysInstanced(T,P,L||D.getSize(),I||1):F.drawArrays(T,P,L||D.getSize());return this}unbind(){this.gl.bindVertexArray(null),this._activeVao=null,this._activeGeometry=null}destroy(){this.renderer=null}}GeometrySystem.extension={type:ExtensionType.RendererSystem,name:"geometry"};extensions.add(GeometrySystem);const tempMat=new Matrix;class TextureMatrix{constructor(T,L){this._texture=T,this.mapCoord=new Matrix,this.uClampFrame=new Float32Array(4),this.uClampOffset=new Float32Array(2),this._textureID=-1,this._updateID=0,this.clampOffset=0,this.clampMargin=typeof L>"u"?.5:L,this.isSimple=!1}get texture(){return this._texture}set texture(T){this._texture=T,this._textureID=-1}multiplyUvs(T,L){L===void 0&&(L=T);const P=this.mapCoord;for(let I=0;I<T.length;I+=2){const F=T[I],D=T[I+1];L[I]=F*P.a+D*P.c+P.tx,L[I+1]=F*P.b+D*P.d+P.ty}return L}update(T){const L=this._texture;if(!L||!L.valid||!T&&this._textureID===L._updateID)return!1;this._textureID=L._updateID,this._updateID++;const P=L._uvs;this.mapCoord.set(P.x1-P.x0,P.y1-P.y0,P.x3-P.x0,P.y3-P.y0,P.x0,P.y0);const I=L.orig,F=L.trim;F&&(tempMat.set(I.width/F.width,0,0,I.height/F.height,-F.x/F.width,-F.y/F.height),this.mapCoord.append(tempMat));const D=L.baseTexture,V=this.uClampFrame,q=this.clampMargin/D.resolution,G=this.clampOffset;return V[0]=(L._frame.x+q+G)/D.width,V[1]=(L._frame.y+q+G)/D.height,V[2]=(L._frame.x+L._frame.width-q+G)/D.width,V[3]=(L._frame.y+L._frame.height-q+G)/D.height,this.uClampOffset[0]=G/D.realWidth,this.uClampOffset[1]=G/D.realHeight,this.isSimple=L._frame.width===D.width&&L._frame.height===D.height&&L.rotate===0,!0}}var fragment$1=`varying vec2 vMaskCoord;
varying vec2 vTextureCoord;

uniform sampler2D uSampler;
uniform sampler2D mask;
uniform float alpha;
uniform float npmAlpha;
uniform vec4 maskClamp;

void main(void)
{
    float clip = step(3.5,
        step(maskClamp.x, vMaskCoord.x) +
        step(maskClamp.y, vMaskCoord.y) +
        step(vMaskCoord.x, maskClamp.z) +
        step(vMaskCoord.y, maskClamp.w));

    vec4 original = texture2D(uSampler, vTextureCoord);
    vec4 masky = texture2D(mask, vMaskCoord);
    float alphaMul = 1.0 - npmAlpha * (1.0 - masky.a);

    original *= (alphaMul * masky.r * alpha * clip);

    gl_FragColor = original;
}
`,vertex=`attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat3 projectionMatrix;
uniform mat3 otherMatrix;

varying vec2 vMaskCoord;
varying vec2 vTextureCoord;

void main(void)
{
    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);

    vTextureCoord = aTextureCoord;
    vMaskCoord = ( otherMatrix * vec3( aTextureCoord, 1.0)  ).xy;
}
`;class SpriteMaskFilter extends Filter{constructor(T,L,P){let I=null;typeof T!="string"&&L===void 0&&P===void 0&&(I=T,T=void 0,L=void 0,P=void 0),super(T||vertex,L||fragment$1,P),this.maskSprite=I,this.maskMatrix=new Matrix}get maskSprite(){return this._maskSprite}set maskSprite(T){this._maskSprite=T,this._maskSprite&&(this._maskSprite.renderable=!1)}apply(T,L,P,I){const F=this._maskSprite,D=F._texture;D.valid&&(D.uvMatrix||(D.uvMatrix=new TextureMatrix(D,0)),D.uvMatrix.update(),this.uniforms.npmAlpha=D.baseTexture.alphaMode?0:1,this.uniforms.mask=D,this.uniforms.otherMatrix=T.calculateSpriteMatrix(this.maskMatrix,F).prepend(D.uvMatrix.mapCoord),this.uniforms.alpha=F.worldAlpha,this.uniforms.maskClamp=D.uvMatrix.uClampFrame,T.applyFilter(this,L,P,I))}}class MaskData{constructor(T=null){this.type=MASK_TYPES.NONE,this.autoDetect=!0,this.maskObject=T||null,this.pooled=!1,this.isMaskData=!0,this.resolution=null,this.multisample=Filter.defaultMultisample,this.enabled=!0,this.colorMask=15,this._filters=null,this._stencilCounter=0,this._scissorCounter=0,this._scissorRect=null,this._scissorRectLocal=null,this._colorMask=15,this._target=null}get filter(){return this._filters?this._filters[0]:null}set filter(T){T?this._filters?this._filters[0]=T:this._filters=[T]:this._filters=null}reset(){this.pooled&&(this.maskObject=null,this.type=MASK_TYPES.NONE,this.autoDetect=!0),this._target=null,this._scissorRectLocal=null}copyCountersOrReset(T){T?(this._stencilCounter=T._stencilCounter,this._scissorCounter=T._scissorCounter,this._scissorRect=T._scissorRect):(this._stencilCounter=0,this._scissorCounter=0,this._scissorRect=null)}}class MaskSystem{constructor(T){this.renderer=T,this.enableScissor=!0,this.alphaMaskPool=[],this.maskDataPool=[],this.maskStack=[],this.alphaMaskIndex=0}setMaskStack(T){this.maskStack=T,this.renderer.scissor.setMaskStack(T),this.renderer.stencil.setMaskStack(T)}push(T,L){let P=L;if(!P.isMaskData){const F=this.maskDataPool.pop()||new MaskData;F.pooled=!0,F.maskObject=L,P=F}const I=this.maskStack.length!==0?this.maskStack[this.maskStack.length-1]:null;if(P.copyCountersOrReset(I),P._colorMask=I?I._colorMask:15,P.autoDetect&&this.detect(P),P._target=T,P.type!==MASK_TYPES.SPRITE&&this.maskStack.push(P),P.enabled)switch(P.type){case MASK_TYPES.SCISSOR:this.renderer.scissor.push(P);break;case MASK_TYPES.STENCIL:this.renderer.stencil.push(P);break;case MASK_TYPES.SPRITE:P.copyCountersOrReset(null),this.pushSpriteMask(P);break;case MASK_TYPES.COLOR:this.pushColorMask(P);break}P.type===MASK_TYPES.SPRITE&&this.maskStack.push(P)}pop(T){const L=this.maskStack.pop();if(!(!L||L._target!==T)){if(L.enabled)switch(L.type){case MASK_TYPES.SCISSOR:this.renderer.scissor.pop(L);break;case MASK_TYPES.STENCIL:this.renderer.stencil.pop(L.maskObject);break;case MASK_TYPES.SPRITE:this.popSpriteMask(L);break;case MASK_TYPES.COLOR:this.popColorMask(L);break}if(L.reset(),L.pooled&&this.maskDataPool.push(L),this.maskStack.length!==0){const P=this.maskStack[this.maskStack.length-1];P.type===MASK_TYPES.SPRITE&&P._filters&&(P._filters[0].maskSprite=P.maskObject)}}}detect(T){const L=T.maskObject;L?L.isSprite?T.type=MASK_TYPES.SPRITE:this.enableScissor&&this.renderer.scissor.testScissor(T)?T.type=MASK_TYPES.SCISSOR:T.type=MASK_TYPES.STENCIL:T.type=MASK_TYPES.COLOR}pushSpriteMask(T){const{maskObject:L}=T,P=T._target;let I=T._filters;I||(I=this.alphaMaskPool[this.alphaMaskIndex],I||(I=this.alphaMaskPool[this.alphaMaskIndex]=[new SpriteMaskFilter])),I[0].resolution=T.resolution,I[0].multisample=T.multisample,I[0].maskSprite=L;const F=P.filterArea;P.filterArea=L.getBounds(!0),this.renderer.filter.push(P,I),P.filterArea=F,T._filters||this.alphaMaskIndex++}popSpriteMask(T){this.renderer.filter.pop(),T._filters?T._filters[0].maskSprite=null:(this.alphaMaskIndex--,this.alphaMaskPool[this.alphaMaskIndex][0].maskSprite=null)}pushColorMask(T){const L=T._colorMask,P=T._colorMask=L&T.colorMask;P!==L&&this.renderer.gl.colorMask((P&1)!==0,(P&2)!==0,(P&4)!==0,(P&8)!==0)}popColorMask(T){const L=T._colorMask,P=this.maskStack.length>0?this.maskStack[this.maskStack.length-1]._colorMask:15;P!==L&&this.renderer.gl.colorMask((P&1)!==0,(P&2)!==0,(P&4)!==0,(P&8)!==0)}destroy(){this.renderer=null}}MaskSystem.extension={type:ExtensionType.RendererSystem,name:"mask"};extensions.add(MaskSystem);class AbstractMaskSystem{constructor(T){this.renderer=T,this.maskStack=[],this.glConst=0}getStackLength(){return this.maskStack.length}setMaskStack(T){const{gl:L}=this.renderer,P=this.getStackLength();this.maskStack=T;const I=this.getStackLength();I!==P&&(I===0?L.disable(this.glConst):(L.enable(this.glConst),this._useCurrent()))}_useCurrent(){}destroy(){this.renderer=null,this.maskStack=null}}const tempMatrix$1=new Matrix,rectPool=[],_ScissorSystem=class Gs extends AbstractMaskSystem{constructor(T){super(T),this.glConst=settings.ADAPTER.getWebGLRenderingContext().SCISSOR_TEST}getStackLength(){const T=this.maskStack[this.maskStack.length-1];return T?T._scissorCounter:0}calcScissorRect(T){if(T._scissorRectLocal)return;const L=T._scissorRect,{maskObject:P}=T,{renderer:I}=this,F=I.renderTexture,D=P.getBounds(!0,rectPool.pop()??new Rectangle);this.roundFrameToPixels(D,F.current?F.current.resolution:I.resolution,F.sourceFrame,F.destinationFrame,I.projection.transform),L&&D.fit(L),T._scissorRectLocal=D}static isMatrixRotated(T){if(!T)return!1;const{a:L,b:P,c:I,d:F}=T;return(Math.abs(P)>1e-4||Math.abs(I)>1e-4)&&(Math.abs(L)>1e-4||Math.abs(F)>1e-4)}testScissor(T){const{maskObject:L}=T;if(!L.isFastRect||!L.isFastRect()||Gs.isMatrixRotated(L.worldTransform)||Gs.isMatrixRotated(this.renderer.projection.transform))return!1;this.calcScissorRect(T);const P=T._scissorRectLocal;return P.width>0&&P.height>0}roundFrameToPixels(T,L,P,I,F){Gs.isMatrixRotated(F)||(F=F?tempMatrix$1.copyFrom(F):tempMatrix$1.identity(),F.translate(-P.x,-P.y).scale(I.width/P.width,I.height/P.height).translate(I.x,I.y),this.renderer.filter.transformAABB(F,T),T.fit(I),T.x=Math.round(T.x*L),T.y=Math.round(T.y*L),T.width=Math.round(T.width*L),T.height=Math.round(T.height*L))}push(T){T._scissorRectLocal||this.calcScissorRect(T);const{gl:L}=this.renderer;T._scissorRect||L.enable(L.SCISSOR_TEST),T._scissorCounter++,T._scissorRect=T._scissorRectLocal,this._useCurrent()}pop(T){const{gl:L}=this.renderer;T&&rectPool.push(T._scissorRectLocal),this.getStackLength()>0?this._useCurrent():L.disable(L.SCISSOR_TEST)}_useCurrent(){const T=this.maskStack[this.maskStack.length-1]._scissorRect;let L;this.renderer.renderTexture.current?L=T.y:L=this.renderer.height-T.height-T.y,this.renderer.gl.scissor(T.x,L,T.width,T.height)}};_ScissorSystem.extension={type:ExtensionType.RendererSystem,name:"scissor"};let ScissorSystem=_ScissorSystem;extensions.add(ScissorSystem);class StencilSystem extends AbstractMaskSystem{constructor(T){super(T),this.glConst=settings.ADAPTER.getWebGLRenderingContext().STENCIL_TEST}getStackLength(){const T=this.maskStack[this.maskStack.length-1];return T?T._stencilCounter:0}push(T){const L=T.maskObject,{gl:P}=this.renderer,I=T._stencilCounter;I===0&&(this.renderer.framebuffer.forceStencil(),P.clearStencil(0),P.clear(P.STENCIL_BUFFER_BIT),P.enable(P.STENCIL_TEST)),T._stencilCounter++;const F=T._colorMask;F!==0&&(T._colorMask=0,P.colorMask(!1,!1,!1,!1)),P.stencilFunc(P.EQUAL,I,4294967295),P.stencilOp(P.KEEP,P.KEEP,P.INCR),L.renderable=!0,L.render(this.renderer),this.renderer.batch.flush(),L.renderable=!1,F!==0&&(T._colorMask=F,P.colorMask((F&1)!==0,(F&2)!==0,(F&4)!==0,(F&8)!==0)),this._useCurrent()}pop(T){const L=this.renderer.gl;if(this.getStackLength()===0)L.disable(L.STENCIL_TEST);else{const P=this.maskStack.length!==0?this.maskStack[this.maskStack.length-1]:null,I=P?P._colorMask:15;I!==0&&(P._colorMask=0,L.colorMask(!1,!1,!1,!1)),L.stencilOp(L.KEEP,L.KEEP,L.DECR),T.renderable=!0,T.render(this.renderer),this.renderer.batch.flush(),T.renderable=!1,I!==0&&(P._colorMask=I,L.colorMask((I&1)!==0,(I&2)!==0,(I&4)!==0,(I&8)!==0)),this._useCurrent()}}_useCurrent(){const T=this.renderer.gl;T.stencilFunc(T.EQUAL,this.getStackLength(),4294967295),T.stencilOp(T.KEEP,T.KEEP,T.KEEP)}}StencilSystem.extension={type:ExtensionType.RendererSystem,name:"stencil"};extensions.add(StencilSystem);class PluginSystem{constructor(T){this.renderer=T,this.plugins={},Object.defineProperties(this.plugins,{extract:{enumerable:!1,get(){return deprecation("7.0.0","renderer.plugins.extract has moved to renderer.extract"),T.extract}},prepare:{enumerable:!1,get(){return deprecation("7.0.0","renderer.plugins.prepare has moved to renderer.prepare"),T.prepare}},interaction:{enumerable:!1,get(){return deprecation("7.0.0","renderer.plugins.interaction has been deprecated, use renderer.events"),T.events}}})}init(){const T=this.rendererPlugins;for(const L in T)this.plugins[L]=new T[L](this.renderer)}destroy(){for(const T in this.plugins)this.plugins[T].destroy(),this.plugins[T]=null}}PluginSystem.extension={type:[ExtensionType.RendererSystem,ExtensionType.CanvasRendererSystem],name:"_plugin"};extensions.add(PluginSystem);class ProjectionSystem{constructor(T){this.renderer=T,this.destinationFrame=null,this.sourceFrame=null,this.defaultFrame=null,this.projectionMatrix=new Matrix,this.transform=null}update(T,L,P,I){this.destinationFrame=T||this.destinationFrame||this.defaultFrame,this.sourceFrame=L||this.sourceFrame||T,this.calculateProjection(this.destinationFrame,this.sourceFrame,P,I),this.transform&&this.projectionMatrix.append(this.transform);const F=this.renderer;F.globalUniforms.uniforms.projectionMatrix=this.projectionMatrix,F.globalUniforms.update(),F.shader.shader&&F.shader.syncUniformGroup(F.shader.shader.uniforms.globals)}calculateProjection(T,L,P,I){const F=this.projectionMatrix,D=I?-1:1;F.identity(),F.a=1/L.width*2,F.d=D*(1/L.height*2),F.tx=-1-L.x*F.a,F.ty=-D-L.y*F.d}setTransform(T){}destroy(){this.renderer=null}}ProjectionSystem.extension={type:ExtensionType.RendererSystem,name:"projection"};extensions.add(ProjectionSystem);const tempTransform=new Transform,tempRect$1=new Rectangle;class GenerateTextureSystem{constructor(T){this.renderer=T,this._tempMatrix=new Matrix}generateTexture(T,L){const{region:P,...I}=L||{},F=P?.copyTo(tempRect$1)||T.getLocalBounds(tempRect$1,!0),D=I.resolution||this.renderer.resolution;F.width=Math.max(F.width,1/D),F.height=Math.max(F.height,1/D),I.width=F.width,I.height=F.height,I.resolution=D,I.multisample??(I.multisample=this.renderer.multisample);const V=RenderTexture.create(I);this._tempMatrix.tx=-F.x,this._tempMatrix.ty=-F.y;const q=T.transform;return T.transform=tempTransform,this.renderer.render(T,{renderTexture:V,transform:this._tempMatrix,skipUpdateTransform:!!T.parent,blit:!0}),T.transform=q,V}destroy(){}}GenerateTextureSystem.extension={type:[ExtensionType.RendererSystem,ExtensionType.CanvasRendererSystem],name:"textureGenerator"};extensions.add(GenerateTextureSystem);const tempRect=new Rectangle,tempRect2=new Rectangle;class RenderTextureSystem{constructor(T){this.renderer=T,this.defaultMaskStack=[],this.current=null,this.sourceFrame=new Rectangle,this.destinationFrame=new Rectangle,this.viewportFrame=new Rectangle}contextChange(){const T=this.renderer?.gl.getContextAttributes();this._rendererPremultipliedAlpha=!!(T&&T.alpha&&T.premultipliedAlpha)}bind(T=null,L,P){const I=this.renderer;this.current=T;let F,D,V;T?(F=T.baseTexture,V=F.resolution,L||(tempRect.width=T.frame.width,tempRect.height=T.frame.height,L=tempRect),P||(tempRect2.x=T.frame.x,tempRect2.y=T.frame.y,tempRect2.width=L.width,tempRect2.height=L.height,P=tempRect2),D=F.framebuffer):(V=I.resolution,L||(tempRect.width=I._view.screen.width,tempRect.height=I._view.screen.height,L=tempRect),P||(P=tempRect,P.width=L.width,P.height=L.height));const q=this.viewportFrame;q.x=P.x*V,q.y=P.y*V,q.width=P.width*V,q.height=P.height*V,T||(q.y=I.view.height-(q.y+q.height)),q.ceil(),this.renderer.framebuffer.bind(D,q),this.renderer.projection.update(P,L,V,!D),T?this.renderer.mask.setMaskStack(F.maskStack):this.renderer.mask.setMaskStack(this.defaultMaskStack),this.sourceFrame.copyFrom(L),this.destinationFrame.copyFrom(P)}clear(T,L){const P=this.current?this.current.baseTexture.clear:this.renderer.background.backgroundColor,I=Color.shared.setValue(T||P);(this.current&&this.current.baseTexture.alphaMode>0||!this.current&&this._rendererPremultipliedAlpha)&&I.premultiply(I.alpha);const F=this.destinationFrame,D=this.current?this.current.baseTexture:this.renderer._view.screen,V=F.width!==D.width||F.height!==D.height;if(V){let{x:q,y:G,width:z,height:Q}=this.viewportFrame;q=Math.round(q),G=Math.round(G),z=Math.round(z),Q=Math.round(Q),this.renderer.gl.enable(this.renderer.gl.SCISSOR_TEST),this.renderer.gl.scissor(q,G,z,Q)}this.renderer.framebuffer.clear(I.red,I.green,I.blue,I.alpha,L),V&&this.renderer.scissor.pop()}resize(){this.bind(null)}reset(){this.bind(null)}destroy(){this.renderer=null}}RenderTextureSystem.extension={type:ExtensionType.RendererSystem,name:"renderTexture"};extensions.add(RenderTextureSystem);class GLProgram{constructor(T,L){this.program=T,this.uniformData=L,this.uniformGroups={},this.uniformDirtyGroups={},this.uniformBufferBindings={}}destroy(){this.uniformData=null,this.uniformGroups=null,this.uniformDirtyGroups=null,this.uniformBufferBindings=null,this.program=null}}function getAttributeData(R,T){const L={},P=T.getProgramParameter(R,T.ACTIVE_ATTRIBUTES);for(let I=0;I<P;I++){const F=T.getActiveAttrib(R,I);if(F.name.startsWith("gl_"))continue;const D=mapType(T,F.type),V={type:D,name:F.name,size:mapSize(D),location:T.getAttribLocation(R,F.name)};L[F.name]=V}return L}function getUniformData(R,T){const L={},P=T.getProgramParameter(R,T.ACTIVE_UNIFORMS);for(let I=0;I<P;I++){const F=T.getActiveUniform(R,I),D=F.name.replace(/\[.*?\]$/,""),V=!!F.name.match(/\[.*?\]$/),q=mapType(T,F.type);L[D]={name:D,index:I,type:q,size:F.size,isArray:V,value:defaultValue(q,F.size)}}return L}function generateProgram(R,T){const L=compileShader(R,R.VERTEX_SHADER,T.vertexSrc),P=compileShader(R,R.FRAGMENT_SHADER,T.fragmentSrc),I=R.createProgram();R.attachShader(I,L),R.attachShader(I,P);const F=T.extra?.transformFeedbackVaryings;if(F&&(typeof R.transformFeedbackVaryings!="function"?console.warn("TransformFeedback is not supported but TransformFeedbackVaryings are given."):R.transformFeedbackVaryings(I,F.names,F.bufferMode==="separate"?R.SEPARATE_ATTRIBS:R.INTERLEAVED_ATTRIBS)),R.linkProgram(I),R.getProgramParameter(I,R.LINK_STATUS)||logProgramError(R,I,L,P),T.attributeData=getAttributeData(I,R),T.uniformData=getUniformData(I,R),!/^[ \t]*#[ \t]*version[ \t]+300[ \t]+es[ \t]*$/m.test(T.vertexSrc)){const V=Object.keys(T.attributeData);V.sort((q,G)=>q>G?1:-1);for(let q=0;q<V.length;q++)T.attributeData[V[q]].location=q,R.bindAttribLocation(I,q,V[q]);R.linkProgram(I)}R.deleteShader(L),R.deleteShader(P);const D={};for(const V in T.uniformData){const q=T.uniformData[V];D[V]={location:R.getUniformLocation(I,V),value:defaultValue(q.type,q.size)}}return new GLProgram(I,D)}function uboUpdate(R,T,L,P,I){L.buffer.update(I)}const UBO_TO_SINGLE_SETTERS={float:`
        data[offset] = v;
    `,vec2:`
        data[offset] = v[0];
        data[offset+1] = v[1];
    `,vec3:`
        data[offset] = v[0];
        data[offset+1] = v[1];
        data[offset+2] = v[2];

    `,vec4:`
        data[offset] = v[0];
        data[offset+1] = v[1];
        data[offset+2] = v[2];
        data[offset+3] = v[3];
    `,mat2:`
        data[offset] = v[0];
        data[offset+1] = v[1];

        data[offset+4] = v[2];
        data[offset+5] = v[3];
    `,mat3:`
        data[offset] = v[0];
        data[offset+1] = v[1];
        data[offset+2] = v[2];

        data[offset + 4] = v[3];
        data[offset + 5] = v[4];
        data[offset + 6] = v[5];

        data[offset + 8] = v[6];
        data[offset + 9] = v[7];
        data[offset + 10] = v[8];
    `,mat4:`
        for(var i = 0; i < 16; i++)
        {
            data[offset + i] = v[i];
        }
    `},GLSL_TO_STD40_SIZE={float:4,vec2:8,vec3:12,vec4:16,int:4,ivec2:8,ivec3:12,ivec4:16,uint:4,uvec2:8,uvec3:12,uvec4:16,bool:4,bvec2:8,bvec3:12,bvec4:16,mat2:32,mat3:48,mat4:64};function createUBOElements(R){const T=R.map(F=>({data:F,offset:0,dataLen:0,dirty:0}));let L=0,P=0,I=0;for(let F=0;F<T.length;F++){const D=T[F];if(L=GLSL_TO_STD40_SIZE[D.data.type],D.data.size>1&&(L=Math.max(L,16)*D.data.size),D.dataLen=L,P%L!==0&&P<16){const V=P%L%16;P+=V,I+=V}P+L>16?(I=Math.ceil(I/16)*16,D.offset=I,I+=L,P=L):(D.offset=I,P+=L,I+=L)}return I=Math.ceil(I/16)*16,{uboElements:T,size:I}}function getUBOData(R,T){const L=[];for(const P in R)T[P]&&L.push(T[P]);return L.sort((P,I)=>P.index-I.index),L}function generateUniformBufferSync(R,T){if(!R.autoManage)return{size:0,syncFunc:uboUpdate};const L=getUBOData(R.uniforms,T),{uboElements:P,size:I}=createUBOElements(L),F=[`
    var v = null;
    var v2 = null;
    var cv = null;
    var t = 0;
    var gl = renderer.gl
    var index = 0;
    var data = buffer.data;
    `];for(let D=0;D<P.length;D++){const V=P[D],q=R.uniforms[V.data.name],G=V.data.name;let z=!1;for(let Q=0;Q<uniformParsers.length;Q++){const J=uniformParsers[Q];if(J.codeUbo&&J.test(V.data,q)){F.push(`offset = ${V.offset/4};`,uniformParsers[Q].codeUbo(V.data.name,q)),z=!0;break}}if(!z)if(V.data.size>1){const Q=mapSize(V.data.type),J=Math.max(GLSL_TO_STD40_SIZE[V.data.type]/16,1),tt=Q/J,yt=(4-tt%4)%4;F.push(`
                cv = ud.${G}.value;
                v = uv.${G};
                offset = ${V.offset/4};

                t = 0;

                for(var i=0; i < ${V.data.size*J}; i++)
                {
                    for(var j = 0; j < ${tt}; j++)
                    {
                        data[offset++] = v[t++];
                    }
                    offset += ${yt};
                }

                `)}else{const Q=UBO_TO_SINGLE_SETTERS[V.data.type];F.push(`
                cv = ud.${G}.value;
                v = uv.${G};
                offset = ${V.offset/4};
                ${Q};
                `)}}return F.push(`
       renderer.buffer.update(buffer);
    `),{size:I,syncFunc:new Function("ud","uv","renderer","syncData","buffer",F.join(`
`))}}let UID=0;const defaultSyncData={textureCount:0,uboCount:0};class ShaderSystem{constructor(T){this.destroyed=!1,this.renderer=T,this.systemCheck(),this.gl=null,this.shader=null,this.program=null,this.cache={},this._uboCache={},this.id=UID++}systemCheck(){if(!unsafeEvalSupported())throw new Error("Current environment does not allow unsafe-eval, please use @pixi/unsafe-eval module to enable support.")}contextChange(T){this.gl=T,this.reset()}bind(T,L){T.disposeRunner.add(this),T.uniforms.globals=this.renderer.globalUniforms;const P=T.program,I=P.glPrograms[this.renderer.CONTEXT_UID]||this.generateProgram(T);return this.shader=T,this.program!==P&&(this.program=P,this.gl.useProgram(I.program)),L||(defaultSyncData.textureCount=0,defaultSyncData.uboCount=0,this.syncUniformGroup(T.uniformGroup,defaultSyncData)),I}setUniforms(T){const L=this.shader.program,P=L.glPrograms[this.renderer.CONTEXT_UID];L.syncUniforms(P.uniformData,T,this.renderer)}syncUniformGroup(T,L){const P=this.getGlProgram();(!T.static||T.dirtyId!==P.uniformDirtyGroups[T.id])&&(P.uniformDirtyGroups[T.id]=T.dirtyId,this.syncUniforms(T,P,L))}syncUniforms(T,L,P){(T.syncUniforms[this.shader.program.id]||this.createSyncGroups(T))(L.uniformData,T.uniforms,this.renderer,P)}createSyncGroups(T){const L=this.getSignature(T,this.shader.program.uniformData,"u");return this.cache[L]||(this.cache[L]=generateUniformsSync(T,this.shader.program.uniformData)),T.syncUniforms[this.shader.program.id]=this.cache[L],T.syncUniforms[this.shader.program.id]}syncUniformBufferGroup(T,L){const P=this.getGlProgram();if(!T.static||T.dirtyId!==0||!P.uniformGroups[T.id]){T.dirtyId=0;const I=P.uniformGroups[T.id]||this.createSyncBufferGroup(T,P,L);T.buffer.update(),I(P.uniformData,T.uniforms,this.renderer,defaultSyncData,T.buffer)}this.renderer.buffer.bindBufferBase(T.buffer,P.uniformBufferBindings[L])}createSyncBufferGroup(T,L,P){const{gl:I}=this.renderer;this.renderer.buffer.bind(T.buffer);const F=this.gl.getUniformBlockIndex(L.program,P);L.uniformBufferBindings[P]=this.shader.uniformBindCount,I.uniformBlockBinding(L.program,F,this.shader.uniformBindCount),this.shader.uniformBindCount++;const D=this.getSignature(T,this.shader.program.uniformData,"ubo");let V=this._uboCache[D];if(V||(V=this._uboCache[D]=generateUniformBufferSync(T,this.shader.program.uniformData)),T.autoManage){const q=new Float32Array(V.size/4);T.buffer.update(q)}return L.uniformGroups[T.id]=V.syncFunc,L.uniformGroups[T.id]}getSignature(T,L,P){const I=T.uniforms,F=[`${P}-`];for(const D in I)F.push(D),L[D]&&F.push(L[D].type);return F.join("-")}getGlProgram(){return this.shader?this.shader.program.glPrograms[this.renderer.CONTEXT_UID]:null}generateProgram(T){const L=this.gl,P=T.program,I=generateProgram(L,P);return P.glPrograms[this.renderer.CONTEXT_UID]=I,I}reset(){this.program=null,this.shader=null}disposeShader(T){this.shader===T&&(this.shader=null)}destroy(){this.renderer=null,this.destroyed=!0}}ShaderSystem.extension={type:ExtensionType.RendererSystem,name:"shader"};extensions.add(ShaderSystem);class StartupSystem{constructor(T){this.renderer=T}run(T){const{renderer:L}=this;L.runners.init.emit(L.options),T.hello&&console.log(`PixiJS 7.4.3 - ${L.rendererLogId} - https://pixijs.com`),L.resize(L.screen.width,L.screen.height)}destroy(){}}StartupSystem.defaultOptions={hello:!1},StartupSystem.extension={type:[ExtensionType.RendererSystem,ExtensionType.CanvasRendererSystem],name:"startup"};extensions.add(StartupSystem);function mapWebGLBlendModesToPixi(R,T=[]){return T[BLEND_MODES.NORMAL]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.ADD]=[R.ONE,R.ONE],T[BLEND_MODES.MULTIPLY]=[R.DST_COLOR,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.SCREEN]=[R.ONE,R.ONE_MINUS_SRC_COLOR,R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.OVERLAY]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.DARKEN]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.LIGHTEN]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.COLOR_DODGE]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.COLOR_BURN]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.HARD_LIGHT]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.SOFT_LIGHT]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.DIFFERENCE]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.EXCLUSION]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.HUE]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.SATURATION]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.COLOR]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.LUMINOSITY]=[R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.NONE]=[0,0],T[BLEND_MODES.NORMAL_NPM]=[R.SRC_ALPHA,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.ADD_NPM]=[R.SRC_ALPHA,R.ONE,R.ONE,R.ONE],T[BLEND_MODES.SCREEN_NPM]=[R.SRC_ALPHA,R.ONE_MINUS_SRC_COLOR,R.ONE,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.SRC_IN]=[R.DST_ALPHA,R.ZERO],T[BLEND_MODES.SRC_OUT]=[R.ONE_MINUS_DST_ALPHA,R.ZERO],T[BLEND_MODES.SRC_ATOP]=[R.DST_ALPHA,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.DST_OVER]=[R.ONE_MINUS_DST_ALPHA,R.ONE],T[BLEND_MODES.DST_IN]=[R.ZERO,R.SRC_ALPHA],T[BLEND_MODES.DST_OUT]=[R.ZERO,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.DST_ATOP]=[R.ONE_MINUS_DST_ALPHA,R.SRC_ALPHA],T[BLEND_MODES.XOR]=[R.ONE_MINUS_DST_ALPHA,R.ONE_MINUS_SRC_ALPHA],T[BLEND_MODES.SUBTRACT]=[R.ONE,R.ONE,R.ONE,R.ONE,R.FUNC_REVERSE_SUBTRACT,R.FUNC_ADD],T}const BLEND=0,OFFSET=1,CULLING=2,DEPTH_TEST=3,WINDING=4,DEPTH_MASK=5,_StateSystem=class ir{constructor(){this.gl=null,this.stateId=0,this.polygonOffset=0,this.blendMode=BLEND_MODES.NONE,this._blendEq=!1,this.map=[],this.map[BLEND]=this.setBlend,this.map[OFFSET]=this.setOffset,this.map[CULLING]=this.setCullFace,this.map[DEPTH_TEST]=this.setDepthTest,this.map[WINDING]=this.setFrontFace,this.map[DEPTH_MASK]=this.setDepthMask,this.checks=[],this.defaultState=new State,this.defaultState.blend=!0}contextChange(T){this.gl=T,this.blendModes=mapWebGLBlendModesToPixi(T),this.set(this.defaultState),this.reset()}set(T){if(T=T||this.defaultState,this.stateId!==T.data){let L=this.stateId^T.data,P=0;for(;L;)L&1&&this.map[P].call(this,!!(T.data&1<<P)),L=L>>1,P++;this.stateId=T.data}for(let L=0;L<this.checks.length;L++)this.checks[L](this,T)}forceState(T){T=T||this.defaultState;for(let L=0;L<this.map.length;L++)this.map[L].call(this,!!(T.data&1<<L));for(let L=0;L<this.checks.length;L++)this.checks[L](this,T);this.stateId=T.data}setBlend(T){this.updateCheck(ir.checkBlendMode,T),this.gl[T?"enable":"disable"](this.gl.BLEND)}setOffset(T){this.updateCheck(ir.checkPolygonOffset,T),this.gl[T?"enable":"disable"](this.gl.POLYGON_OFFSET_FILL)}setDepthTest(T){this.gl[T?"enable":"disable"](this.gl.DEPTH_TEST)}setDepthMask(T){this.gl.depthMask(T)}setCullFace(T){this.gl[T?"enable":"disable"](this.gl.CULL_FACE)}setFrontFace(T){this.gl.frontFace(this.gl[T?"CW":"CCW"])}setBlendMode(T){if(T===this.blendMode)return;this.blendMode=T;const L=this.blendModes[T],P=this.gl;L.length===2?P.blendFunc(L[0],L[1]):P.blendFuncSeparate(L[0],L[1],L[2],L[3]),L.length===6?(this._blendEq=!0,P.blendEquationSeparate(L[4],L[5])):this._blendEq&&(this._blendEq=!1,P.blendEquationSeparate(P.FUNC_ADD,P.FUNC_ADD))}setPolygonOffset(T,L){this.gl.polygonOffset(T,L)}reset(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.forceState(this.defaultState),this._blendEq=!0,this.blendMode=-1,this.setBlendMode(0)}updateCheck(T,L){const P=this.checks.indexOf(T);L&&P===-1?this.checks.push(T):!L&&P!==-1&&this.checks.splice(P,1)}static checkBlendMode(T,L){T.setBlendMode(L.blendMode)}static checkPolygonOffset(T,L){T.setPolygonOffset(1,L.polygonOffset)}destroy(){this.gl=null}};_StateSystem.extension={type:ExtensionType.RendererSystem,name:"state"};let StateSystem=_StateSystem;extensions.add(StateSystem);class SystemManager extends EventEmitter{constructor(){super(...arguments),this.runners={},this._systemsHash={}}setup(T){this.addRunners(...T.runners);const L=(T.priority??[]).filter(I=>T.systems[I]),P=[...L,...Object.keys(T.systems).filter(I=>!L.includes(I))];for(const I of P)this.addSystem(T.systems[I],I)}addRunners(...T){T.forEach(L=>{this.runners[L]=new Runner(L)})}addSystem(T,L){const P=new T(this);if(this[L])throw new Error(`Whoops! The name "${L}" is already in use`);this[L]=P,this._systemsHash[L]=P;for(const I in this.runners)this.runners[I].add(P);return this}emitWithCustomOptions(T,L){const P=Object.keys(this._systemsHash);T.items.forEach(I=>{const F=P.find(D=>this._systemsHash[D]===I);I[T.name](L[F])})}destroy(){Object.values(this.runners).forEach(T=>{T.destroy()}),this._systemsHash={}}}const _TextureGCSystem=class Ys{constructor(T){this.renderer=T,this.count=0,this.checkCount=0,this.maxIdle=Ys.defaultMaxIdle,this.checkCountMax=Ys.defaultCheckCountMax,this.mode=Ys.defaultMode}postrender(){this.renderer.objectRenderer.renderingToScreen&&(this.count++,this.mode!==GC_MODES.MANUAL&&(this.checkCount++,this.checkCount>this.checkCountMax&&(this.checkCount=0,this.run())))}run(){const T=this.renderer.texture,L=T.managedTextures;let P=!1;for(let I=0;I<L.length;I++){const F=L[I];F.resource&&this.count-F.touched>this.maxIdle&&(T.destroyTexture(F,!0),L[I]=null,P=!0)}if(P){let I=0;for(let F=0;F<L.length;F++)L[F]!==null&&(L[I++]=L[F]);L.length=I}}unload(T){const L=this.renderer.texture,P=T._texture;P&&!P.framebuffer&&L.destroyTexture(P);for(let I=T.children.length-1;I>=0;I--)this.unload(T.children[I])}destroy(){this.renderer=null}};_TextureGCSystem.defaultMode=GC_MODES.AUTO,_TextureGCSystem.defaultMaxIdle=3600,_TextureGCSystem.defaultCheckCountMax=600,_TextureGCSystem.extension={type:ExtensionType.RendererSystem,name:"textureGC"};let TextureGCSystem=_TextureGCSystem;extensions.add(TextureGCSystem);class GLTexture{constructor(T){this.texture=T,this.width=-1,this.height=-1,this.dirtyId=-1,this.dirtyStyleId=-1,this.mipmap=!1,this.wrapMode=33071,this.type=TYPES.UNSIGNED_BYTE,this.internalFormat=FORMATS.RGBA,this.samplerType=0}}function mapInternalFormatToSamplerType(R){let T;return"WebGL2RenderingContext"in globalThis&&R instanceof globalThis.WebGL2RenderingContext?T={[R.RGB]:SAMPLER_TYPES.FLOAT,[R.RGBA]:SAMPLER_TYPES.FLOAT,[R.ALPHA]:SAMPLER_TYPES.FLOAT,[R.LUMINANCE]:SAMPLER_TYPES.FLOAT,[R.LUMINANCE_ALPHA]:SAMPLER_TYPES.FLOAT,[R.R8]:SAMPLER_TYPES.FLOAT,[R.R8_SNORM]:SAMPLER_TYPES.FLOAT,[R.RG8]:SAMPLER_TYPES.FLOAT,[R.RG8_SNORM]:SAMPLER_TYPES.FLOAT,[R.RGB8]:SAMPLER_TYPES.FLOAT,[R.RGB8_SNORM]:SAMPLER_TYPES.FLOAT,[R.RGB565]:SAMPLER_TYPES.FLOAT,[R.RGBA4]:SAMPLER_TYPES.FLOAT,[R.RGB5_A1]:SAMPLER_TYPES.FLOAT,[R.RGBA8]:SAMPLER_TYPES.FLOAT,[R.RGBA8_SNORM]:SAMPLER_TYPES.FLOAT,[R.RGB10_A2]:SAMPLER_TYPES.FLOAT,[R.RGB10_A2UI]:SAMPLER_TYPES.FLOAT,[R.SRGB8]:SAMPLER_TYPES.FLOAT,[R.SRGB8_ALPHA8]:SAMPLER_TYPES.FLOAT,[R.R16F]:SAMPLER_TYPES.FLOAT,[R.RG16F]:SAMPLER_TYPES.FLOAT,[R.RGB16F]:SAMPLER_TYPES.FLOAT,[R.RGBA16F]:SAMPLER_TYPES.FLOAT,[R.R32F]:SAMPLER_TYPES.FLOAT,[R.RG32F]:SAMPLER_TYPES.FLOAT,[R.RGB32F]:SAMPLER_TYPES.FLOAT,[R.RGBA32F]:SAMPLER_TYPES.FLOAT,[R.R11F_G11F_B10F]:SAMPLER_TYPES.FLOAT,[R.RGB9_E5]:SAMPLER_TYPES.FLOAT,[R.R8I]:SAMPLER_TYPES.INT,[R.R8UI]:SAMPLER_TYPES.UINT,[R.R16I]:SAMPLER_TYPES.INT,[R.R16UI]:SAMPLER_TYPES.UINT,[R.R32I]:SAMPLER_TYPES.INT,[R.R32UI]:SAMPLER_TYPES.UINT,[R.RG8I]:SAMPLER_TYPES.INT,[R.RG8UI]:SAMPLER_TYPES.UINT,[R.RG16I]:SAMPLER_TYPES.INT,[R.RG16UI]:SAMPLER_TYPES.UINT,[R.RG32I]:SAMPLER_TYPES.INT,[R.RG32UI]:SAMPLER_TYPES.UINT,[R.RGB8I]:SAMPLER_TYPES.INT,[R.RGB8UI]:SAMPLER_TYPES.UINT,[R.RGB16I]:SAMPLER_TYPES.INT,[R.RGB16UI]:SAMPLER_TYPES.UINT,[R.RGB32I]:SAMPLER_TYPES.INT,[R.RGB32UI]:SAMPLER_TYPES.UINT,[R.RGBA8I]:SAMPLER_TYPES.INT,[R.RGBA8UI]:SAMPLER_TYPES.UINT,[R.RGBA16I]:SAMPLER_TYPES.INT,[R.RGBA16UI]:SAMPLER_TYPES.UINT,[R.RGBA32I]:SAMPLER_TYPES.INT,[R.RGBA32UI]:SAMPLER_TYPES.UINT,[R.DEPTH_COMPONENT16]:SAMPLER_TYPES.FLOAT,[R.DEPTH_COMPONENT24]:SAMPLER_TYPES.FLOAT,[R.DEPTH_COMPONENT32F]:SAMPLER_TYPES.FLOAT,[R.DEPTH_STENCIL]:SAMPLER_TYPES.FLOAT,[R.DEPTH24_STENCIL8]:SAMPLER_TYPES.FLOAT,[R.DEPTH32F_STENCIL8]:SAMPLER_TYPES.FLOAT}:T={[R.RGB]:SAMPLER_TYPES.FLOAT,[R.RGBA]:SAMPLER_TYPES.FLOAT,[R.ALPHA]:SAMPLER_TYPES.FLOAT,[R.LUMINANCE]:SAMPLER_TYPES.FLOAT,[R.LUMINANCE_ALPHA]:SAMPLER_TYPES.FLOAT,[R.DEPTH_STENCIL]:SAMPLER_TYPES.FLOAT},T}function mapTypeAndFormatToInternalFormat(R){let T;return"WebGL2RenderingContext"in globalThis&&R instanceof globalThis.WebGL2RenderingContext?T={[TYPES.UNSIGNED_BYTE]:{[FORMATS.RGBA]:R.RGBA8,[FORMATS.RGB]:R.RGB8,[FORMATS.RG]:R.RG8,[FORMATS.RED]:R.R8,[FORMATS.RGBA_INTEGER]:R.RGBA8UI,[FORMATS.RGB_INTEGER]:R.RGB8UI,[FORMATS.RG_INTEGER]:R.RG8UI,[FORMATS.RED_INTEGER]:R.R8UI,[FORMATS.ALPHA]:R.ALPHA,[FORMATS.LUMINANCE]:R.LUMINANCE,[FORMATS.LUMINANCE_ALPHA]:R.LUMINANCE_ALPHA},[TYPES.BYTE]:{[FORMATS.RGBA]:R.RGBA8_SNORM,[FORMATS.RGB]:R.RGB8_SNORM,[FORMATS.RG]:R.RG8_SNORM,[FORMATS.RED]:R.R8_SNORM,[FORMATS.RGBA_INTEGER]:R.RGBA8I,[FORMATS.RGB_INTEGER]:R.RGB8I,[FORMATS.RG_INTEGER]:R.RG8I,[FORMATS.RED_INTEGER]:R.R8I},[TYPES.UNSIGNED_SHORT]:{[FORMATS.RGBA_INTEGER]:R.RGBA16UI,[FORMATS.RGB_INTEGER]:R.RGB16UI,[FORMATS.RG_INTEGER]:R.RG16UI,[FORMATS.RED_INTEGER]:R.R16UI,[FORMATS.DEPTH_COMPONENT]:R.DEPTH_COMPONENT16},[TYPES.SHORT]:{[FORMATS.RGBA_INTEGER]:R.RGBA16I,[FORMATS.RGB_INTEGER]:R.RGB16I,[FORMATS.RG_INTEGER]:R.RG16I,[FORMATS.RED_INTEGER]:R.R16I},[TYPES.UNSIGNED_INT]:{[FORMATS.RGBA_INTEGER]:R.RGBA32UI,[FORMATS.RGB_INTEGER]:R.RGB32UI,[FORMATS.RG_INTEGER]:R.RG32UI,[FORMATS.RED_INTEGER]:R.R32UI,[FORMATS.DEPTH_COMPONENT]:R.DEPTH_COMPONENT24},[TYPES.INT]:{[FORMATS.RGBA_INTEGER]:R.RGBA32I,[FORMATS.RGB_INTEGER]:R.RGB32I,[FORMATS.RG_INTEGER]:R.RG32I,[FORMATS.RED_INTEGER]:R.R32I},[TYPES.FLOAT]:{[FORMATS.RGBA]:R.RGBA32F,[FORMATS.RGB]:R.RGB32F,[FORMATS.RG]:R.RG32F,[FORMATS.RED]:R.R32F,[FORMATS.DEPTH_COMPONENT]:R.DEPTH_COMPONENT32F},[TYPES.HALF_FLOAT]:{[FORMATS.RGBA]:R.RGBA16F,[FORMATS.RGB]:R.RGB16F,[FORMATS.RG]:R.RG16F,[FORMATS.RED]:R.R16F},[TYPES.UNSIGNED_SHORT_5_6_5]:{[FORMATS.RGB]:R.RGB565},[TYPES.UNSIGNED_SHORT_4_4_4_4]:{[FORMATS.RGBA]:R.RGBA4},[TYPES.UNSIGNED_SHORT_5_5_5_1]:{[FORMATS.RGBA]:R.RGB5_A1},[TYPES.UNSIGNED_INT_2_10_10_10_REV]:{[FORMATS.RGBA]:R.RGB10_A2,[FORMATS.RGBA_INTEGER]:R.RGB10_A2UI},[TYPES.UNSIGNED_INT_10F_11F_11F_REV]:{[FORMATS.RGB]:R.R11F_G11F_B10F},[TYPES.UNSIGNED_INT_5_9_9_9_REV]:{[FORMATS.RGB]:R.RGB9_E5},[TYPES.UNSIGNED_INT_24_8]:{[FORMATS.DEPTH_STENCIL]:R.DEPTH24_STENCIL8},[TYPES.FLOAT_32_UNSIGNED_INT_24_8_REV]:{[FORMATS.DEPTH_STENCIL]:R.DEPTH32F_STENCIL8}}:T={[TYPES.UNSIGNED_BYTE]:{[FORMATS.RGBA]:R.RGBA,[FORMATS.RGB]:R.RGB,[FORMATS.ALPHA]:R.ALPHA,[FORMATS.LUMINANCE]:R.LUMINANCE,[FORMATS.LUMINANCE_ALPHA]:R.LUMINANCE_ALPHA},[TYPES.UNSIGNED_SHORT_5_6_5]:{[FORMATS.RGB]:R.RGB},[TYPES.UNSIGNED_SHORT_4_4_4_4]:{[FORMATS.RGBA]:R.RGBA},[TYPES.UNSIGNED_SHORT_5_5_5_1]:{[FORMATS.RGBA]:R.RGBA}},T}class TextureSystem{constructor(T){this.renderer=T,this.boundTextures=[],this.currentLocation=-1,this.managedTextures=[],this._unknownBoundTextures=!1,this.unknownTexture=new BaseTexture,this.hasIntegerTextures=!1}contextChange(){const T=this.gl=this.renderer.gl;this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.webGLVersion=this.renderer.context.webGLVersion,this.internalFormats=mapTypeAndFormatToInternalFormat(T),this.samplerTypes=mapInternalFormatToSamplerType(T);const L=T.getParameter(T.MAX_TEXTURE_IMAGE_UNITS);this.boundTextures.length=L;for(let I=0;I<L;I++)this.boundTextures[I]=null;this.emptyTextures={};const P=new GLTexture(T.createTexture());T.bindTexture(T.TEXTURE_2D,P.texture),T.texImage2D(T.TEXTURE_2D,0,T.RGBA,1,1,0,T.RGBA,T.UNSIGNED_BYTE,new Uint8Array(4)),this.emptyTextures[T.TEXTURE_2D]=P,this.emptyTextures[T.TEXTURE_CUBE_MAP]=new GLTexture(T.createTexture()),T.bindTexture(T.TEXTURE_CUBE_MAP,this.emptyTextures[T.TEXTURE_CUBE_MAP].texture);for(let I=0;I<6;I++)T.texImage2D(T.TEXTURE_CUBE_MAP_POSITIVE_X+I,0,T.RGBA,1,1,0,T.RGBA,T.UNSIGNED_BYTE,null);T.texParameteri(T.TEXTURE_CUBE_MAP,T.TEXTURE_MAG_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_CUBE_MAP,T.TEXTURE_MIN_FILTER,T.LINEAR);for(let I=0;I<this.boundTextures.length;I++)this.bind(null,I)}bind(T,L=0){const{gl:P}=this;if(T=T?.castToBaseTexture(),T?.valid&&!T.parentTextureArray){T.touched=this.renderer.textureGC.count;const I=T._glTextures[this.CONTEXT_UID]||this.initTexture(T);this.boundTextures[L]!==T&&(this.currentLocation!==L&&(this.currentLocation=L,P.activeTexture(P.TEXTURE0+L)),P.bindTexture(T.target,I.texture)),I.dirtyId!==T.dirtyId?(this.currentLocation!==L&&(this.currentLocation=L,P.activeTexture(P.TEXTURE0+L)),this.updateTexture(T)):I.dirtyStyleId!==T.dirtyStyleId&&this.updateTextureStyle(T),this.boundTextures[L]=T}else this.currentLocation!==L&&(this.currentLocation=L,P.activeTexture(P.TEXTURE0+L)),P.bindTexture(P.TEXTURE_2D,this.emptyTextures[P.TEXTURE_2D].texture),this.boundTextures[L]=null}reset(){this._unknownBoundTextures=!0,this.hasIntegerTextures=!1,this.currentLocation=-1;for(let T=0;T<this.boundTextures.length;T++)this.boundTextures[T]=this.unknownTexture}unbind(T){const{gl:L,boundTextures:P}=this;if(this._unknownBoundTextures){this._unknownBoundTextures=!1;for(let I=0;I<P.length;I++)P[I]===this.unknownTexture&&this.bind(null,I)}for(let I=0;I<P.length;I++)P[I]===T&&(this.currentLocation!==I&&(L.activeTexture(L.TEXTURE0+I),this.currentLocation=I),L.bindTexture(T.target,this.emptyTextures[T.target].texture),P[I]=null)}ensureSamplerType(T){const{boundTextures:L,hasIntegerTextures:P,CONTEXT_UID:I}=this;if(P)for(let F=T-1;F>=0;--F){const D=L[F];D&&D._glTextures[I].samplerType!==SAMPLER_TYPES.FLOAT&&this.renderer.texture.unbind(D)}}initTexture(T){const L=new GLTexture(this.gl.createTexture());return L.dirtyId=-1,T._glTextures[this.CONTEXT_UID]=L,this.managedTextures.push(T),T.on("dispose",this.destroyTexture,this),L}initTextureType(T,L){L.internalFormat=this.internalFormats[T.type]?.[T.format]??T.format,L.samplerType=this.samplerTypes[L.internalFormat]??SAMPLER_TYPES.FLOAT,this.webGLVersion===2&&T.type===TYPES.HALF_FLOAT?L.type=this.gl.HALF_FLOAT:L.type=T.type}updateTexture(T){const L=T._glTextures[this.CONTEXT_UID];if(!L)return;const P=this.renderer;if(this.initTextureType(T,L),T.resource?.upload(P,T,L))L.samplerType!==SAMPLER_TYPES.FLOAT&&(this.hasIntegerTextures=!0);else{const I=T.realWidth,F=T.realHeight,D=P.gl;(L.width!==I||L.height!==F||L.dirtyId<0)&&(L.width=I,L.height=F,D.texImage2D(T.target,0,L.internalFormat,I,F,0,T.format,L.type,null))}T.dirtyStyleId!==L.dirtyStyleId&&this.updateTextureStyle(T),L.dirtyId=T.dirtyId}destroyTexture(T,L){const{gl:P}=this;if(T=T.castToBaseTexture(),T._glTextures[this.CONTEXT_UID]&&(this.unbind(T),P.deleteTexture(T._glTextures[this.CONTEXT_UID].texture),T.off("dispose",this.destroyTexture,this),delete T._glTextures[this.CONTEXT_UID],!L)){const I=this.managedTextures.indexOf(T);I!==-1&&removeItems(this.managedTextures,I,1)}}updateTextureStyle(T){const L=T._glTextures[this.CONTEXT_UID];L&&((T.mipmap===MIPMAP_MODES.POW2||this.webGLVersion!==2)&&!T.isPowerOfTwo?L.mipmap=!1:L.mipmap=T.mipmap>=1,this.webGLVersion!==2&&!T.isPowerOfTwo?L.wrapMode=WRAP_MODES.CLAMP:L.wrapMode=T.wrapMode,T.resource?.style(this.renderer,T,L)||this.setStyle(T,L),L.dirtyStyleId=T.dirtyStyleId)}setStyle(T,L){const P=this.gl;if(L.mipmap&&T.mipmap!==MIPMAP_MODES.ON_MANUAL&&P.generateMipmap(T.target),P.texParameteri(T.target,P.TEXTURE_WRAP_S,L.wrapMode),P.texParameteri(T.target,P.TEXTURE_WRAP_T,L.wrapMode),L.mipmap){P.texParameteri(T.target,P.TEXTURE_MIN_FILTER,T.scaleMode===SCALE_MODES.LINEAR?P.LINEAR_MIPMAP_LINEAR:P.NEAREST_MIPMAP_NEAREST);const I=this.renderer.context.extensions.anisotropicFiltering;if(I&&T.anisotropicLevel>0&&T.scaleMode===SCALE_MODES.LINEAR){const F=Math.min(T.anisotropicLevel,P.getParameter(I.MAX_TEXTURE_MAX_ANISOTROPY_EXT));P.texParameterf(T.target,I.TEXTURE_MAX_ANISOTROPY_EXT,F)}}else P.texParameteri(T.target,P.TEXTURE_MIN_FILTER,T.scaleMode===SCALE_MODES.LINEAR?P.LINEAR:P.NEAREST);P.texParameteri(T.target,P.TEXTURE_MAG_FILTER,T.scaleMode===SCALE_MODES.LINEAR?P.LINEAR:P.NEAREST)}destroy(){this.renderer=null}}TextureSystem.extension={type:ExtensionType.RendererSystem,name:"texture"};extensions.add(TextureSystem);class TransformFeedbackSystem{constructor(T){this.renderer=T}contextChange(){this.gl=this.renderer.gl,this.CONTEXT_UID=this.renderer.CONTEXT_UID}bind(T){const{gl:L,CONTEXT_UID:P}=this,I=T._glTransformFeedbacks[P]||this.createGLTransformFeedback(T);L.bindTransformFeedback(L.TRANSFORM_FEEDBACK,I)}unbind(){const{gl:T}=this;T.bindTransformFeedback(T.TRANSFORM_FEEDBACK,null)}beginTransformFeedback(T,L){const{gl:P,renderer:I}=this;L&&I.shader.bind(L),P.beginTransformFeedback(T)}endTransformFeedback(){const{gl:T}=this;T.endTransformFeedback()}createGLTransformFeedback(T){const{gl:L,renderer:P,CONTEXT_UID:I}=this,F=L.createTransformFeedback();T._glTransformFeedbacks[I]=F,L.bindTransformFeedback(L.TRANSFORM_FEEDBACK,F);for(let D=0;D<T.buffers.length;D++){const V=T.buffers[D];V&&(P.buffer.update(V),V._glBuffers[I].refCount++,L.bindBufferBase(L.TRANSFORM_FEEDBACK_BUFFER,D,V._glBuffers[I].buffer||null))}return L.bindTransformFeedback(L.TRANSFORM_FEEDBACK,null),T.disposeRunner.add(this),F}disposeTransformFeedback(T,L){const P=T._glTransformFeedbacks[this.CONTEXT_UID],I=this.gl;T.disposeRunner.remove(this);const F=this.renderer.buffer;if(F)for(let D=0;D<T.buffers.length;D++){const V=T.buffers[D];if(!V)continue;const q=V._glBuffers[this.CONTEXT_UID];q&&(q.refCount--,q.refCount===0&&!L&&F.dispose(V,L))}P&&(L||I.deleteTransformFeedback(P),delete T._glTransformFeedbacks[this.CONTEXT_UID])}destroy(){this.renderer=null}}TransformFeedbackSystem.extension={type:ExtensionType.RendererSystem,name:"transformFeedback"};extensions.add(TransformFeedbackSystem);class ViewSystem{constructor(T){this.renderer=T}init(T){this.screen=new Rectangle(0,0,T.width,T.height),this.element=T.view||settings.ADAPTER.createCanvas(),this.resolution=T.resolution||settings.RESOLUTION,this.autoDensity=!!T.autoDensity}resizeView(T,L){this.element.width=Math.round(T*this.resolution),this.element.height=Math.round(L*this.resolution);const P=this.element.width/this.resolution,I=this.element.height/this.resolution;this.screen.width=P,this.screen.height=I,this.autoDensity&&(this.element.style.width=`${P}px`,this.element.style.height=`${I}px`),this.renderer.emit("resize",P,I),this.renderer.runners.resize.emit(this.screen.width,this.screen.height)}destroy(T){T&&this.element.parentNode?.removeChild(this.element),this.renderer=null,this.element=null,this.screen=null}}ViewSystem.defaultOptions={width:800,height:600,resolution:void 0,autoDensity:!1},ViewSystem.extension={type:[ExtensionType.RendererSystem,ExtensionType.CanvasRendererSystem],name:"_view"};extensions.add(ViewSystem);settings.PREFER_ENV=ENV.WEBGL2;settings.STRICT_TEXTURE_CACHE=!1;settings.RENDER_OPTIONS={...ContextSystem.defaultOptions,...BackgroundSystem.defaultOptions,...ViewSystem.defaultOptions,...StartupSystem.defaultOptions};Object.defineProperties(settings,{WRAP_MODE:{get(){return BaseTexture.defaultOptions.wrapMode},set(R){deprecation("7.1.0","settings.WRAP_MODE is deprecated, use BaseTexture.defaultOptions.wrapMode"),BaseTexture.defaultOptions.wrapMode=R}},SCALE_MODE:{get(){return BaseTexture.defaultOptions.scaleMode},set(R){deprecation("7.1.0","settings.SCALE_MODE is deprecated, use BaseTexture.defaultOptions.scaleMode"),BaseTexture.defaultOptions.scaleMode=R}},MIPMAP_TEXTURES:{get(){return BaseTexture.defaultOptions.mipmap},set(R){deprecation("7.1.0","settings.MIPMAP_TEXTURES is deprecated, use BaseTexture.defaultOptions.mipmap"),BaseTexture.defaultOptions.mipmap=R}},ANISOTROPIC_LEVEL:{get(){return BaseTexture.defaultOptions.anisotropicLevel},set(R){deprecation("7.1.0","settings.ANISOTROPIC_LEVEL is deprecated, use BaseTexture.defaultOptions.anisotropicLevel"),BaseTexture.defaultOptions.anisotropicLevel=R}},FILTER_RESOLUTION:{get(){return deprecation("7.1.0","settings.FILTER_RESOLUTION is deprecated, use Filter.defaultResolution"),Filter.defaultResolution},set(R){Filter.defaultResolution=R}},FILTER_MULTISAMPLE:{get(){return deprecation("7.1.0","settings.FILTER_MULTISAMPLE is deprecated, use Filter.defaultMultisample"),Filter.defaultMultisample},set(R){Filter.defaultMultisample=R}},SPRITE_MAX_TEXTURES:{get(){return BatchRenderer.defaultMaxTextures},set(R){deprecation("7.1.0","settings.SPRITE_MAX_TEXTURES is deprecated, use BatchRenderer.defaultMaxTextures"),BatchRenderer.defaultMaxTextures=R}},SPRITE_BATCH_SIZE:{get(){return BatchRenderer.defaultBatchSize},set(R){deprecation("7.1.0","settings.SPRITE_BATCH_SIZE is deprecated, use BatchRenderer.defaultBatchSize"),BatchRenderer.defaultBatchSize=R}},CAN_UPLOAD_SAME_BUFFER:{get(){return BatchRenderer.canUploadSameBuffer},set(R){deprecation("7.1.0","settings.CAN_UPLOAD_SAME_BUFFER is deprecated, use BatchRenderer.canUploadSameBuffer"),BatchRenderer.canUploadSameBuffer=R}},GC_MODE:{get(){return TextureGCSystem.defaultMode},set(R){deprecation("7.1.0","settings.GC_MODE is deprecated, use TextureGCSystem.defaultMode"),TextureGCSystem.defaultMode=R}},GC_MAX_IDLE:{get(){return TextureGCSystem.defaultMaxIdle},set(R){deprecation("7.1.0","settings.GC_MAX_IDLE is deprecated, use TextureGCSystem.defaultMaxIdle"),TextureGCSystem.defaultMaxIdle=R}},GC_MAX_CHECK_COUNT:{get(){return TextureGCSystem.defaultCheckCountMax},set(R){deprecation("7.1.0","settings.GC_MAX_CHECK_COUNT is deprecated, use TextureGCSystem.defaultCheckCountMax"),TextureGCSystem.defaultCheckCountMax=R}},PRECISION_VERTEX:{get(){return Program.defaultVertexPrecision},set(R){deprecation("7.1.0","settings.PRECISION_VERTEX is deprecated, use Program.defaultVertexPrecision"),Program.defaultVertexPrecision=R}},PRECISION_FRAGMENT:{get(){return Program.defaultFragmentPrecision},set(R){deprecation("7.1.0","settings.PRECISION_FRAGMENT is deprecated, use Program.defaultFragmentPrecision"),Program.defaultFragmentPrecision=R}}});var UPDATE_PRIORITY=(R=>(R[R.INTERACTION=50]="INTERACTION",R[R.HIGH=25]="HIGH",R[R.NORMAL=0]="NORMAL",R[R.LOW=-25]="LOW",R[R.UTILITY=-50]="UTILITY",R))(UPDATE_PRIORITY||{});class TickerListener{constructor(T,L=null,P=0,I=!1){this.next=null,this.previous=null,this._destroyed=!1,this.fn=T,this.context=L,this.priority=P,this.once=I}match(T,L=null){return this.fn===T&&this.context===L}emit(T){this.fn&&(this.context?this.fn.call(this.context,T):this.fn(T));const L=this.next;return this.once&&this.destroy(!0),this._destroyed&&(this.next=null),L}connect(T){this.previous=T,T.next&&(T.next.previous=this),this.next=T.next,T.next=this}destroy(T=!1){this._destroyed=!0,this.fn=null,this.context=null,this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous);const L=this.next;return this.next=T?null:L,this.previous=null,L}}const _Ticker=class Ni{constructor(){this.autoStart=!1,this.deltaTime=1,this.lastTime=-1,this.speed=1,this.started=!1,this._requestId=null,this._maxElapsedMS=100,this._minElapsedMS=0,this._protected=!1,this._lastFrame=-1,this._head=new TickerListener(null,null,1/0),this.deltaMS=1/Ni.targetFPMS,this.elapsedMS=1/Ni.targetFPMS,this._tick=T=>{this._requestId=null,this.started&&(this.update(T),this.started&&this._requestId===null&&this._head.next&&(this._requestId=requestAnimationFrame(this._tick)))}}_requestIfNeeded(){this._requestId===null&&this._head.next&&(this.lastTime=performance.now(),this._lastFrame=this.lastTime,this._requestId=requestAnimationFrame(this._tick))}_cancelIfNeeded(){this._requestId!==null&&(cancelAnimationFrame(this._requestId),this._requestId=null)}_startIfPossible(){this.started?this._requestIfNeeded():this.autoStart&&this.start()}add(T,L,P=UPDATE_PRIORITY.NORMAL){return this._addListener(new TickerListener(T,L,P))}addOnce(T,L,P=UPDATE_PRIORITY.NORMAL){return this._addListener(new TickerListener(T,L,P,!0))}_addListener(T){let L=this._head.next,P=this._head;if(!L)T.connect(P);else{for(;L;){if(T.priority>L.priority){T.connect(P);break}P=L,L=L.next}T.previous||T.connect(P)}return this._startIfPossible(),this}remove(T,L){let P=this._head.next;for(;P;)P.match(T,L)?P=P.destroy():P=P.next;return this._head.next||this._cancelIfNeeded(),this}get count(){if(!this._head)return 0;let T=0,L=this._head;for(;L=L.next;)T++;return T}start(){this.started||(this.started=!0,this._requestIfNeeded())}stop(){this.started&&(this.started=!1,this._cancelIfNeeded())}destroy(){if(!this._protected){this.stop();let T=this._head.next;for(;T;)T=T.destroy(!0);this._head.destroy(),this._head=null}}update(T=performance.now()){let L;if(T>this.lastTime){if(L=this.elapsedMS=T-this.lastTime,L>this._maxElapsedMS&&(L=this._maxElapsedMS),L*=this.speed,this._minElapsedMS){const F=T-this._lastFrame|0;if(F<this._minElapsedMS)return;this._lastFrame=T-F%this._minElapsedMS}this.deltaMS=L,this.deltaTime=this.deltaMS*Ni.targetFPMS;const P=this._head;let I=P.next;for(;I;)I=I.emit(this.deltaTime);P.next||this._cancelIfNeeded()}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=T}get FPS(){return 1e3/this.elapsedMS}get minFPS(){return 1e3/this._maxElapsedMS}set minFPS(T){const L=Math.min(this.maxFPS,T),P=Math.min(Math.max(0,L)/1e3,Ni.targetFPMS);this._maxElapsedMS=1/P}get maxFPS(){return this._minElapsedMS?Math.round(1e3/this._minElapsedMS):0}set maxFPS(T){if(T===0)this._minElapsedMS=0;else{const L=Math.max(this.minFPS,T);this._minElapsedMS=1/(L/1e3)}}static get shared(){if(!Ni._shared){const T=Ni._shared=new Ni;T.autoStart=!0,T._protected=!0}return Ni._shared}static get system(){if(!Ni._system){const T=Ni._system=new Ni;T.autoStart=!0,T._protected=!0}return Ni._system}};_Ticker.targetFPMS=.06;let Ticker=_Ticker;Object.defineProperties(settings,{TARGET_FPMS:{get(){return Ticker.targetFPMS},set(R){deprecation("7.1.0","settings.TARGET_FPMS is deprecated, use Ticker.targetFPMS"),Ticker.targetFPMS=R}}});class TickerPlugin{static init(T){T=Object.assign({autoStart:!0,sharedTicker:!1},T),Object.defineProperty(this,"ticker",{set(L){this._ticker&&this._ticker.remove(this.render,this),this._ticker=L,L&&L.add(this.render,this,UPDATE_PRIORITY.LOW)},get(){return this._ticker}}),this.stop=()=>{this._ticker.stop()},this.start=()=>{this._ticker.start()},this._ticker=null,this.ticker=T.sharedTicker?Ticker.shared:new Ticker,T.autoStart&&this.start()}static destroy(){if(this._ticker){const T=this._ticker;this.ticker=null,T.destroy()}}}TickerPlugin.extension=ExtensionType.Application;extensions.add(TickerPlugin);const renderers=[];extensions.handleByList(ExtensionType.Renderer,renderers);function autoDetectRenderer(R){for(const T of renderers)if(T.test(R))return new T(R);throw new Error("Unable to auto-detect a suitable renderer.")}var $defaultFilterVertex=`attribute vec2 aVertexPosition;

uniform mat3 projectionMatrix;

varying vec2 vTextureCoord;

uniform vec4 inputSize;
uniform vec4 outputFrame;

vec4 filterVertexPosition( void )
{
    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;

    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aVertexPosition * (outputFrame.zw * inputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`;const defaultFilterVertex=$defaultFilterVertex;class MultisampleSystem{constructor(T){this.renderer=T}contextChange(T){let L;if(this.renderer.context.webGLVersion===1){const P=T.getParameter(T.FRAMEBUFFER_BINDING);T.bindFramebuffer(T.FRAMEBUFFER,null),L=T.getParameter(T.SAMPLES),T.bindFramebuffer(T.FRAMEBUFFER,P)}else{const P=T.getParameter(T.DRAW_FRAMEBUFFER_BINDING);T.bindFramebuffer(T.DRAW_FRAMEBUFFER,null),L=T.getParameter(T.SAMPLES),T.bindFramebuffer(T.DRAW_FRAMEBUFFER,P)}L>=MSAA_QUALITY.HIGH?this.multisample=MSAA_QUALITY.HIGH:L>=MSAA_QUALITY.MEDIUM?this.multisample=MSAA_QUALITY.MEDIUM:L>=MSAA_QUALITY.LOW?this.multisample=MSAA_QUALITY.LOW:this.multisample=MSAA_QUALITY.NONE}destroy(){}}MultisampleSystem.extension={type:ExtensionType.RendererSystem,name:"_multisample"};extensions.add(MultisampleSystem);class GLBuffer{constructor(T){this.buffer=T||null,this.updateID=-1,this.byteLength=-1,this.refCount=0}}class BufferSystem{constructor(T){this.renderer=T,this.managedBuffers={},this.boundBufferBases={}}destroy(){this.renderer=null}contextChange(){this.disposeAll(!0),this.gl=this.renderer.gl,this.CONTEXT_UID=this.renderer.CONTEXT_UID}bind(T){const{gl:L,CONTEXT_UID:P}=this,I=T._glBuffers[P]||this.createGLBuffer(T);L.bindBuffer(T.type,I.buffer)}unbind(T){const{gl:L}=this;L.bindBuffer(T,null)}bindBufferBase(T,L){const{gl:P,CONTEXT_UID:I}=this;if(this.boundBufferBases[L]!==T){const F=T._glBuffers[I]||this.createGLBuffer(T);this.boundBufferBases[L]=T,P.bindBufferBase(P.UNIFORM_BUFFER,L,F.buffer)}}bindBufferRange(T,L,P){const{gl:I,CONTEXT_UID:F}=this;P=P||0;const D=T._glBuffers[F]||this.createGLBuffer(T);I.bindBufferRange(I.UNIFORM_BUFFER,L||0,D.buffer,P*256,256)}update(T){const{gl:L,CONTEXT_UID:P}=this,I=T._glBuffers[P]||this.createGLBuffer(T);if(T._updateID!==I.updateID)if(I.updateID=T._updateID,L.bindBuffer(T.type,I.buffer),I.byteLength>=T.data.byteLength)L.bufferSubData(T.type,0,T.data);else{const F=T.static?L.STATIC_DRAW:L.DYNAMIC_DRAW;I.byteLength=T.data.byteLength,L.bufferData(T.type,T.data,F)}}dispose(T,L){if(!this.managedBuffers[T.id])return;delete this.managedBuffers[T.id];const P=T._glBuffers[this.CONTEXT_UID],I=this.gl;T.disposeRunner.remove(this),P&&(L||I.deleteBuffer(P.buffer),delete T._glBuffers[this.CONTEXT_UID])}disposeAll(T){const L=Object.keys(this.managedBuffers);for(let P=0;P<L.length;P++)this.dispose(this.managedBuffers[L[P]],T)}createGLBuffer(T){const{CONTEXT_UID:L,gl:P}=this;return T._glBuffers[L]=new GLBuffer(P.createBuffer()),this.managedBuffers[T.id]=T,T.disposeRunner.add(this),T._glBuffers[L]}}BufferSystem.extension={type:ExtensionType.RendererSystem,name:"buffer"};extensions.add(BufferSystem);class ObjectRendererSystem{constructor(T){this.renderer=T}render(T,L){const P=this.renderer;let I,F,D,V;if(L&&(I=L.renderTexture,F=L.clear,D=L.transform,V=L.skipUpdateTransform),this.renderingToScreen=!I,P.runners.prerender.emit(),P.emit("prerender"),P.projection.transform=D,!P.context.isLost){if(I||(this.lastObjectRendered=T),!V){const q=T.enableTempParent();T.updateTransform(),T.disableTempParent(q)}P.renderTexture.bind(I),P.batch.currentRenderer.start(),(F??P.background.clearBeforeRender)&&P.renderTexture.clear(),T.render(P),P.batch.currentRenderer.flush(),I&&(L.blit&&P.framebuffer.blit(),I.baseTexture.update()),P.runners.postrender.emit(),P.projection.transform=null,P.emit("postrender")}}destroy(){this.renderer=null,this.lastObjectRendered=null}}ObjectRendererSystem.extension={type:ExtensionType.RendererSystem,name:"objectRenderer"};extensions.add(ObjectRendererSystem);const _Renderer=class sr extends SystemManager{constructor(T){super(),this.type=RENDERER_TYPE.WEBGL,T=Object.assign({},settings.RENDER_OPTIONS,T),this.gl=null,this.CONTEXT_UID=0,this.globalUniforms=new UniformGroup({projectionMatrix:new Matrix},!0);const L={runners:["init","destroy","contextChange","resolutionChange","reset","update","postrender","prerender","resize"],systems:sr.__systems,priority:["_view","textureGenerator","background","_plugin","startup","context","state","texture","buffer","geometry","framebuffer","transformFeedback","mask","scissor","stencil","projection","textureGC","filter","renderTexture","batch","objectRenderer","_multisample"]};this.setup(L),"useContextAlpha"in T&&(deprecation("7.0.0","options.useContextAlpha is deprecated, use options.premultipliedAlpha and options.backgroundAlpha instead"),T.premultipliedAlpha=T.useContextAlpha&&T.useContextAlpha!=="notMultiplied",T.backgroundAlpha=T.useContextAlpha===!1?1:T.backgroundAlpha),this._plugin.rendererPlugins=sr.__plugins,this.options=T,this.startup.run(this.options)}static test(T){return T?.forceCanvas?!1:isWebGLSupported()}render(T,L){this.objectRenderer.render(T,L)}resize(T,L){this._view.resizeView(T,L)}reset(){return this.runners.reset.emit(),this}clear(){this.renderTexture.bind(),this.renderTexture.clear()}destroy(T=!1){this.runners.destroy.items.reverse(),this.emitWithCustomOptions(this.runners.destroy,{_view:T}),super.destroy()}get plugins(){return this._plugin.plugins}get multisample(){return this._multisample.multisample}get width(){return this._view.element.width}get height(){return this._view.element.height}get resolution(){return this._view.resolution}set resolution(T){this._view.resolution=T,this.runners.resolutionChange.emit(T)}get autoDensity(){return this._view.autoDensity}get view(){return this._view.element}get screen(){return this._view.screen}get lastObjectRendered(){return this.objectRenderer.lastObjectRendered}get renderingToScreen(){return this.objectRenderer.renderingToScreen}get rendererLogId(){return`WebGL ${this.context.webGLVersion}`}get clearBeforeRender(){return deprecation("7.0.0","renderer.clearBeforeRender has been deprecated, please use renderer.background.clearBeforeRender instead."),this.background.clearBeforeRender}get useContextAlpha(){return deprecation("7.0.0","renderer.useContextAlpha has been deprecated, please use renderer.context.premultipliedAlpha instead."),this.context.useContextAlpha}get preserveDrawingBuffer(){return deprecation("7.0.0","renderer.preserveDrawingBuffer has been deprecated, we cannot truly know this unless pixi created the context"),this.context.preserveDrawingBuffer}get backgroundColor(){return deprecation("7.0.0","renderer.backgroundColor has been deprecated, use renderer.background.color instead."),this.background.color}set backgroundColor(T){deprecation("7.0.0","renderer.backgroundColor has been deprecated, use renderer.background.color instead."),this.background.color=T}get backgroundAlpha(){return deprecation("7.0.0","renderer.backgroundAlpha has been deprecated, use renderer.background.alpha instead."),this.background.alpha}set backgroundAlpha(T){deprecation("7.0.0","renderer.backgroundAlpha has been deprecated, use renderer.background.alpha instead."),this.background.alpha=T}get powerPreference(){return deprecation("7.0.0","renderer.powerPreference has been deprecated, we can only know this if pixi creates the context"),this.context.powerPreference}generateTexture(T,L){return this.textureGenerator.generateTexture(T,L)}};_Renderer.extension={type:ExtensionType.Renderer,priority:1},_Renderer.__plugins={},_Renderer.__systems={};let Renderer=_Renderer;extensions.handleByMap(ExtensionType.RendererPlugin,Renderer.__plugins);extensions.handleByMap(ExtensionType.RendererSystem,Renderer.__systems);extensions.add(Renderer);class AbstractMultiResource extends Resource{constructor(T,L){const{width:P,height:I}=L||{};super(P,I),this.items=[],this.itemDirtyIds=[];for(let F=0;F<T;F++){const D=new BaseTexture;this.items.push(D),this.itemDirtyIds.push(-2)}this.length=T,this._load=null,this.baseTexture=null}initFromArray(T,L){for(let P=0;P<this.length;P++)T[P]&&(T[P].castToBaseTexture?this.addBaseTextureAt(T[P].castToBaseTexture(),P):T[P]instanceof Resource?this.addResourceAt(T[P],P):this.addResourceAt(autoDetectResource(T[P],L),P))}dispose(){for(let T=0,L=this.length;T<L;T++)this.items[T].destroy();this.items=null,this.itemDirtyIds=null,this._load=null}addResourceAt(T,L){if(!this.items[L])throw new Error(`Index ${L} is out of bounds`);return T.valid&&!this.valid&&this.resize(T.width,T.height),this.items[L].setResource(T),this}bind(T){if(this.baseTexture!==null)throw new Error("Only one base texture per TextureArray is allowed");super.bind(T);for(let L=0;L<this.length;L++)this.items[L].parentTextureArray=T,this.items[L].on("update",T.update,T)}unbind(T){super.unbind(T);for(let L=0;L<this.length;L++)this.items[L].parentTextureArray=null,this.items[L].off("update",T.update,T)}load(){if(this._load)return this._load;const T=this.items.map(L=>L.resource).filter(L=>L).map(L=>L.load());return this._load=Promise.all(T).then(()=>{const{realWidth:L,realHeight:P}=this.items[0];return this.resize(L,P),this.update(),Promise.resolve(this)}),this._load}}class ArrayResource extends AbstractMultiResource{constructor(T,L){const{width:P,height:I}=L||{};let F,D;Array.isArray(T)?(F=T,D=T.length):D=T,super(D,{width:P,height:I}),F&&this.initFromArray(F,L)}addBaseTextureAt(T,L){if(T.resource)this.addResourceAt(T.resource,L);else throw new Error("ArrayResource does not support RenderTexture");return this}bind(T){super.bind(T),T.target=TARGETS.TEXTURE_2D_ARRAY}upload(T,L,P){const{length:I,itemDirtyIds:F,items:D}=this,{gl:V}=T;P.dirtyId<0&&V.texImage3D(V.TEXTURE_2D_ARRAY,0,P.internalFormat,this._width,this._height,I,0,L.format,P.type,null);for(let q=0;q<I;q++){const G=D[q];F[q]<G.dirtyId&&(F[q]=G.dirtyId,G.valid&&V.texSubImage3D(V.TEXTURE_2D_ARRAY,0,0,0,q,G.resource.width,G.resource.height,1,L.format,P.type,G.resource.source))}return!0}}class CanvasResource extends BaseImageResource{constructor(T){super(T)}static test(T){const{OffscreenCanvas:L}=globalThis;return L&&T instanceof L?!0:globalThis.HTMLCanvasElement&&T instanceof HTMLCanvasElement}}const _CubeResource=class Ns extends AbstractMultiResource{constructor(T,L){const{width:P,height:I,autoLoad:F,linkBaseTexture:D}=L||{};if(T&&T.length!==Ns.SIDES)throw new Error(`Invalid length. Got ${T.length}, expected 6`);super(6,{width:P,height:I});for(let V=0;V<Ns.SIDES;V++)this.items[V].target=TARGETS.TEXTURE_CUBE_MAP_POSITIVE_X+V;this.linkBaseTexture=D!==!1,T&&this.initFromArray(T,L),F!==!1&&this.load()}bind(T){super.bind(T),T.target=TARGETS.TEXTURE_CUBE_MAP}addBaseTextureAt(T,L,P){if(P===void 0&&(P=this.linkBaseTexture),!this.items[L])throw new Error(`Index ${L} is out of bounds`);if(!this.linkBaseTexture||T.parentTextureArray||Object.keys(T._glTextures).length>0)if(T.resource)this.addResourceAt(T.resource,L);else throw new Error("CubeResource does not support copying of renderTexture.");else T.target=TARGETS.TEXTURE_CUBE_MAP_POSITIVE_X+L,T.parentTextureArray=this.baseTexture,this.items[L]=T;return T.valid&&!this.valid&&this.resize(T.realWidth,T.realHeight),this.items[L]=T,this}upload(T,L,P){const I=this.itemDirtyIds;for(let F=0;F<Ns.SIDES;F++){const D=this.items[F];(I[F]<D.dirtyId||P.dirtyId<L.dirtyId)&&(D.valid&&D.resource?(D.resource.upload(T,D,P),I[F]=D.dirtyId):I[F]<-1&&(T.gl.texImage2D(D.target,0,P.internalFormat,L.realWidth,L.realHeight,0,L.format,P.type,null),I[F]=-1))}return!0}static test(T){return Array.isArray(T)&&T.length===Ns.SIDES}};_CubeResource.SIDES=6;let CubeResource=_CubeResource;class ImageBitmapResource extends BaseImageResource{constructor(T,L){L=L||{};let P,I,F;typeof T=="string"?(P=ImageBitmapResource.EMPTY,I=T,F=!0):(P=T,I=null,F=!1),super(P),this.url=I,this.crossOrigin=L.crossOrigin??!0,this.alphaMode=typeof L.alphaMode=="number"?L.alphaMode:null,this.ownsImageBitmap=L.ownsImageBitmap??F,this._load=null,L.autoLoad!==!1&&this.load()}load(){return this._load?this._load:(this._load=new Promise(async(T,L)=>{if(this.url===null){T(this);return}try{const P=await settings.ADAPTER.fetch(this.url,{mode:this.crossOrigin?"cors":"no-cors"});if(this.destroyed)return;const I=await P.blob();if(this.destroyed)return;const F=await createImageBitmap(I,{premultiplyAlpha:this.alphaMode===null||this.alphaMode===ALPHA_MODES.UNPACK?"premultiply":"none"});if(this.destroyed){F.close();return}this.source=F,this.update(),T(this)}catch(P){if(this.destroyed)return;L(P),this.onError.emit(P)}}),this._load)}upload(T,L,P){return this.source instanceof ImageBitmap?(typeof this.alphaMode=="number"&&(L.alphaMode=this.alphaMode),super.upload(T,L,P)):(this.load(),!1)}dispose(){this.ownsImageBitmap&&this.source instanceof ImageBitmap&&this.source.close(),super.dispose(),this._load=null}static test(T){return!!globalThis.createImageBitmap&&typeof ImageBitmap<"u"&&(typeof T=="string"||T instanceof ImageBitmap)}static get EMPTY(){return ImageBitmapResource._EMPTY=ImageBitmapResource._EMPTY??settings.ADAPTER.createCanvas(0,0),ImageBitmapResource._EMPTY}}const _SVGResource=class Hs extends BaseImageResource{constructor(T,L){L=L||{},super(settings.ADAPTER.createCanvas()),this._width=0,this._height=0,this.svg=T,this.scale=L.scale||1,this._overrideWidth=L.width,this._overrideHeight=L.height,this._resolve=null,this._crossorigin=L.crossorigin,this._load=null,L.autoLoad!==!1&&this.load()}load(){return this._load?this._load:(this._load=new Promise(T=>{if(this._resolve=()=>{this.update(),T(this)},Hs.SVG_XML.test(this.svg.trim())){if(!btoa)throw new Error("Your browser doesn't support base64 conversions.");this.svg=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(this.svg)))}`}this._loadSvg()}),this._load)}_loadSvg(){const T=new Image;BaseImageResource.crossOrigin(T,this.svg,this._crossorigin),T.src=this.svg,T.onerror=L=>{this._resolve&&(T.onerror=null,this.onError.emit(L))},T.onload=()=>{if(!this._resolve)return;const L=T.width,P=T.height;if(!L||!P)throw new Error("The SVG image must have width and height defined (in pixels), canvas API needs them.");let I=L*this.scale,F=P*this.scale;(this._overrideWidth||this._overrideHeight)&&(I=this._overrideWidth||this._overrideHeight/P*L,F=this._overrideHeight||this._overrideWidth/L*P),I=Math.round(I),F=Math.round(F);const D=this.source;D.width=I,D.height=F,D._pixiId=`canvas_${uid()}`,D.getContext("2d").drawImage(T,0,0,L,P,0,0,I,F),this._resolve(),this._resolve=null}}static getSize(T){const L=Hs.SVG_SIZE.exec(T),P={};return L&&(P[L[1]]=Math.round(parseFloat(L[3])),P[L[5]]=Math.round(parseFloat(L[7]))),P}dispose(){super.dispose(),this._resolve=null,this._crossorigin=null}static test(T,L){return L==="svg"||typeof T=="string"&&T.startsWith("data:image/svg+xml")||typeof T=="string"&&Hs.SVG_XML.test(T)}};_SVGResource.SVG_XML=/^(<\?xml[^?]+\?>)?\s*(<!--[^(-->)]*-->)?\s*\<svg/m,_SVGResource.SVG_SIZE=/<svg[^>]*(?:\s(width|height)=('|")(\d*(?:\.\d+)?)(?:px)?('|"))[^>]*(?:\s(width|height)=('|")(\d*(?:\.\d+)?)(?:px)?('|"))[^>]*>/i;let SVGResource=_SVGResource;class VideoFrameResource extends BaseImageResource{constructor(T){super(T)}static test(T){return!!globalThis.VideoFrame&&T instanceof globalThis.VideoFrame}}const _VideoResource=class rr extends BaseImageResource{constructor(T,L){if(L=L||{},!(T instanceof HTMLVideoElement)){const P=document.createElement("video");L.autoLoad!==!1&&P.setAttribute("preload","auto"),L.playsinline!==!1&&(P.setAttribute("webkit-playsinline",""),P.setAttribute("playsinline","")),L.muted===!0&&(P.setAttribute("muted",""),P.muted=!0),L.loop===!0&&P.setAttribute("loop",""),L.autoPlay!==!1&&P.setAttribute("autoplay",""),typeof T=="string"&&(T=[T]);const I=T[0].src||T[0];BaseImageResource.crossOrigin(P,I,L.crossorigin);for(let F=0;F<T.length;++F){const D=document.createElement("source");let{src:V,mime:q}=T[F];if(V=V||T[F],V.startsWith("data:"))q=V.slice(5,V.indexOf(";"));else if(!V.startsWith("blob:")){const G=V.split("?").shift().toLowerCase(),z=G.slice(G.lastIndexOf(".")+1);q=q||rr.MIME_TYPES[z]||`video/${z}`}D.src=V,q&&(D.type=q),P.appendChild(D)}T=P}super(T),this.noSubImage=!0,this._autoUpdate=!0,this._isConnectedToTicker=!1,this._updateFPS=L.updateFPS||0,this._msToNextUpdate=0,this.autoPlay=L.autoPlay!==!1,this._videoFrameRequestCallback=this._videoFrameRequestCallback.bind(this),this._videoFrameRequestCallbackHandle=null,this._load=null,this._resolve=null,this._reject=null,this._onCanPlay=this._onCanPlay.bind(this),this._onError=this._onError.bind(this),this._onPlayStart=this._onPlayStart.bind(this),this._onPlayStop=this._onPlayStop.bind(this),this._onSeeked=this._onSeeked.bind(this),L.autoLoad!==!1&&this.load()}update(T=0){if(!this.destroyed){if(this._updateFPS){const L=Ticker.shared.elapsedMS*this.source.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-L)}(!this._updateFPS||this._msToNextUpdate<=0)&&(super.update(),this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0)}}_videoFrameRequestCallback(){this.update(),this.destroyed?this._videoFrameRequestCallbackHandle=null:this._videoFrameRequestCallbackHandle=this.source.requestVideoFrameCallback(this._videoFrameRequestCallback)}load(){if(this._load)return this._load;const T=this.source;return(T.readyState===T.HAVE_ENOUGH_DATA||T.readyState===T.HAVE_FUTURE_DATA)&&T.width&&T.height&&(T.complete=!0),T.addEventListener("play",this._onPlayStart),T.addEventListener("pause",this._onPlayStop),T.addEventListener("seeked",this._onSeeked),this._isSourceReady()?this._onCanPlay():(T.addEventListener("canplay",this._onCanPlay),T.addEventListener("canplaythrough",this._onCanPlay),T.addEventListener("error",this._onError,!0)),this._load=new Promise((L,P)=>{this.valid?L(this):(this._resolve=L,this._reject=P,T.load())}),this._load}_onError(T){this.source.removeEventListener("error",this._onError,!0),this.onError.emit(T),this._reject&&(this._reject(T),this._reject=null,this._resolve=null)}_isSourcePlaying(){const T=this.source;return!T.paused&&!T.ended}_isSourceReady(){return this.source.readyState>2}_onPlayStart(){this.valid||this._onCanPlay(),this._configureAutoUpdate()}_onPlayStop(){this._configureAutoUpdate()}_onSeeked(){this._autoUpdate&&!this._isSourcePlaying()&&(this._msToNextUpdate=0,this.update(),this._msToNextUpdate=0)}_onCanPlay(){const T=this.source;T.removeEventListener("canplay",this._onCanPlay),T.removeEventListener("canplaythrough",this._onCanPlay);const L=this.valid;this._msToNextUpdate=0,this.update(),this._msToNextUpdate=0,!L&&this._resolve&&(this._resolve(this),this._resolve=null,this._reject=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&T.play()}dispose(){this._configureAutoUpdate();const T=this.source;T&&(T.removeEventListener("play",this._onPlayStart),T.removeEventListener("pause",this._onPlayStop),T.removeEventListener("seeked",this._onSeeked),T.removeEventListener("canplay",this._onCanPlay),T.removeEventListener("canplaythrough",this._onCanPlay),T.removeEventListener("error",this._onError,!0),T.pause(),T.src="",T.load()),super.dispose()}get autoUpdate(){return this._autoUpdate}set autoUpdate(T){T!==this._autoUpdate&&(this._autoUpdate=T,this._configureAutoUpdate())}get updateFPS(){return this._updateFPS}set updateFPS(T){T!==this._updateFPS&&(this._updateFPS=T,this._configureAutoUpdate())}_configureAutoUpdate(){this._autoUpdate&&this._isSourcePlaying()?!this._updateFPS&&this.source.requestVideoFrameCallback?(this._isConnectedToTicker&&(Ticker.shared.remove(this.update,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0),this._videoFrameRequestCallbackHandle===null&&(this._videoFrameRequestCallbackHandle=this.source.requestVideoFrameCallback(this._videoFrameRequestCallback))):(this._videoFrameRequestCallbackHandle!==null&&(this.source.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker||(Ticker.shared.add(this.update,this),this._isConnectedToTicker=!0,this._msToNextUpdate=0)):(this._videoFrameRequestCallbackHandle!==null&&(this.source.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker&&(Ticker.shared.remove(this.update,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0))}static test(T,L){return globalThis.HTMLVideoElement&&T instanceof HTMLVideoElement||rr.TYPES.includes(L)}};_VideoResource.TYPES=["mp4","m4v","webm","ogg","ogv","h264","avi","mov"],_VideoResource.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"};let VideoResource=_VideoResource;INSTALLED.push(ImageBitmapResource,ImageResource,CanvasResource,VideoResource,VideoFrameResource,SVGResource,BufferResource,CubeResource,ArrayResource);class Bounds{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.rect=null,this.updateID=-1}isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}clear(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}getRectangle(T){return this.minX>this.maxX||this.minY>this.maxY?Rectangle.EMPTY:(T=T||new Rectangle(0,0,1,1),T.x=this.minX,T.y=this.minY,T.width=this.maxX-this.minX,T.height=this.maxY-this.minY,T)}addPoint(T){this.minX=Math.min(this.minX,T.x),this.maxX=Math.max(this.maxX,T.x),this.minY=Math.min(this.minY,T.y),this.maxY=Math.max(this.maxY,T.y)}addPointMatrix(T,L){const{a:P,b:I,c:F,d:D,tx:V,ty:q}=T,G=P*L.x+F*L.y+V,z=I*L.x+D*L.y+q;this.minX=Math.min(this.minX,G),this.maxX=Math.max(this.maxX,G),this.minY=Math.min(this.minY,z),this.maxY=Math.max(this.maxY,z)}addQuad(T){let L=this.minX,P=this.minY,I=this.maxX,F=this.maxY,D=T[0],V=T[1];L=D<L?D:L,P=V<P?V:P,I=D>I?D:I,F=V>F?V:F,D=T[2],V=T[3],L=D<L?D:L,P=V<P?V:P,I=D>I?D:I,F=V>F?V:F,D=T[4],V=T[5],L=D<L?D:L,P=V<P?V:P,I=D>I?D:I,F=V>F?V:F,D=T[6],V=T[7],L=D<L?D:L,P=V<P?V:P,I=D>I?D:I,F=V>F?V:F,this.minX=L,this.minY=P,this.maxX=I,this.maxY=F}addFrame(T,L,P,I,F){this.addFrameMatrix(T.worldTransform,L,P,I,F)}addFrameMatrix(T,L,P,I,F){const D=T.a,V=T.b,q=T.c,G=T.d,z=T.tx,Q=T.ty;let J=this.minX,tt=this.minY,yt=this.maxX,At=this.maxY,gt=D*L+q*P+z,Et=V*L+G*P+Q;J=gt<J?gt:J,tt=Et<tt?Et:tt,yt=gt>yt?gt:yt,At=Et>At?Et:At,gt=D*I+q*P+z,Et=V*I+G*P+Q,J=gt<J?gt:J,tt=Et<tt?Et:tt,yt=gt>yt?gt:yt,At=Et>At?Et:At,gt=D*L+q*F+z,Et=V*L+G*F+Q,J=gt<J?gt:J,tt=Et<tt?Et:tt,yt=gt>yt?gt:yt,At=Et>At?Et:At,gt=D*I+q*F+z,Et=V*I+G*F+Q,J=gt<J?gt:J,tt=Et<tt?Et:tt,yt=gt>yt?gt:yt,At=Et>At?Et:At,this.minX=J,this.minY=tt,this.maxX=yt,this.maxY=At}addVertexData(T,L,P){let I=this.minX,F=this.minY,D=this.maxX,V=this.maxY;for(let q=L;q<P;q+=2){const G=T[q],z=T[q+1];I=G<I?G:I,F=z<F?z:F,D=G>D?G:D,V=z>V?z:V}this.minX=I,this.minY=F,this.maxX=D,this.maxY=V}addVertices(T,L,P,I){this.addVerticesMatrix(T.worldTransform,L,P,I)}addVerticesMatrix(T,L,P,I,F=0,D=F){const V=T.a,q=T.b,G=T.c,z=T.d,Q=T.tx,J=T.ty;let tt=this.minX,yt=this.minY,At=this.maxX,gt=this.maxY;for(let Et=P;Et<I;Et+=2){const kt=L[Et],ne=L[Et+1],Se=V*kt+G*ne+Q,Ht=z*ne+q*kt+J;tt=Math.min(tt,Se-F),At=Math.max(At,Se+F),yt=Math.min(yt,Ht-D),gt=Math.max(gt,Ht+D)}this.minX=tt,this.minY=yt,this.maxX=At,this.maxY=gt}addBounds(T){const L=this.minX,P=this.minY,I=this.maxX,F=this.maxY;this.minX=T.minX<L?T.minX:L,this.minY=T.minY<P?T.minY:P,this.maxX=T.maxX>I?T.maxX:I,this.maxY=T.maxY>F?T.maxY:F}addBoundsMask(T,L){const P=T.minX>L.minX?T.minX:L.minX,I=T.minY>L.minY?T.minY:L.minY,F=T.maxX<L.maxX?T.maxX:L.maxX,D=T.maxY<L.maxY?T.maxY:L.maxY;if(P<=F&&I<=D){const V=this.minX,q=this.minY,G=this.maxX,z=this.maxY;this.minX=P<V?P:V,this.minY=I<q?I:q,this.maxX=F>G?F:G,this.maxY=D>z?D:z}}addBoundsMatrix(T,L){this.addFrameMatrix(L,T.minX,T.minY,T.maxX,T.maxY)}addBoundsArea(T,L){const P=T.minX>L.x?T.minX:L.x,I=T.minY>L.y?T.minY:L.y,F=T.maxX<L.x+L.width?T.maxX:L.x+L.width,D=T.maxY<L.y+L.height?T.maxY:L.y+L.height;if(P<=F&&I<=D){const V=this.minX,q=this.minY,G=this.maxX,z=this.maxY;this.minX=P<V?P:V,this.minY=I<q?I:q,this.maxX=F>G?F:G,this.maxY=D>z?D:z}}pad(T=0,L=T){this.isEmpty()||(this.minX-=T,this.maxX+=T,this.minY-=L,this.maxY+=L)}addFramePad(T,L,P,I,F,D){T-=F,L-=D,P+=F,I+=D,this.minX=this.minX<T?this.minX:T,this.maxX=this.maxX>P?this.maxX:P,this.minY=this.minY<L?this.minY:L,this.maxY=this.maxY>I?this.maxY:I}}class DisplayObject extends EventEmitter{constructor(){super(),this.tempDisplayObjectParent=null,this.transform=new Transform,this.alpha=1,this.visible=!0,this.renderable=!0,this.cullable=!1,this.cullArea=null,this.parent=null,this.worldAlpha=1,this._lastSortedIndex=0,this._zIndex=0,this.filterArea=null,this.filters=null,this._enabledFilters=null,this._bounds=new Bounds,this._localBounds=null,this._boundsID=0,this._boundsRect=null,this._localBoundsRect=null,this._mask=null,this._maskRefCount=0,this._destroyed=!1,this.isSprite=!1,this.isMask=!1}static mixin(T){const L=Object.keys(T);for(let P=0;P<L.length;++P){const I=L[P];Object.defineProperty(DisplayObject.prototype,I,Object.getOwnPropertyDescriptor(T,I))}}get destroyed(){return this._destroyed}_recursivePostUpdateTransform(){this.parent?(this.parent._recursivePostUpdateTransform(),this.transform.updateTransform(this.parent.transform)):this.transform.updateTransform(this._tempDisplayObjectParent.transform)}updateTransform(){this._boundsID++,this.transform.updateTransform(this.parent.transform),this.worldAlpha=this.alpha*this.parent.worldAlpha}getBounds(T,L){return T||(this.parent?(this._recursivePostUpdateTransform(),this.updateTransform()):(this.parent=this._tempDisplayObjectParent,this.updateTransform(),this.parent=null)),this._bounds.updateID!==this._boundsID&&(this.calculateBounds(),this._bounds.updateID=this._boundsID),L||(this._boundsRect||(this._boundsRect=new Rectangle),L=this._boundsRect),this._bounds.getRectangle(L)}getLocalBounds(T){T||(this._localBoundsRect||(this._localBoundsRect=new Rectangle),T=this._localBoundsRect),this._localBounds||(this._localBounds=new Bounds);const L=this.transform,P=this.parent;this.parent=null,this._tempDisplayObjectParent.worldAlpha=P?.worldAlpha??1,this.transform=this._tempDisplayObjectParent.transform;const I=this._bounds,F=this._boundsID;this._bounds=this._localBounds;const D=this.getBounds(!1,T);return this.parent=P,this.transform=L,this._bounds=I,this._bounds.updateID+=this._boundsID-F,D}toGlobal(T,L,P=!1){return P||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.worldTransform.apply(T,L)}toLocal(T,L,P,I){return L&&(T=L.toGlobal(T,P,I)),I||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.worldTransform.applyInverse(T,P)}setParent(T){if(!T||!T.addChild)throw new Error("setParent: Argument must be a Container");return T.addChild(this),T}removeFromParent(){this.parent?.removeChild(this)}setTransform(T=0,L=0,P=1,I=1,F=0,D=0,V=0,q=0,G=0){return this.position.x=T,this.position.y=L,this.scale.x=P||1,this.scale.y=I||1,this.rotation=F,this.skew.x=D,this.skew.y=V,this.pivot.x=q,this.pivot.y=G,this}destroy(T){this.removeFromParent(),this._destroyed=!0,this.transform=null,this.parent=null,this._bounds=null,this.mask=null,this.cullArea=null,this.filters=null,this.filterArea=null,this.hitArea=null,this.eventMode="auto",this.interactiveChildren=!1,this.emit("destroyed"),this.removeAllListeners()}get _tempDisplayObjectParent(){return this.tempDisplayObjectParent===null&&(this.tempDisplayObjectParent=new TemporaryDisplayObject),this.tempDisplayObjectParent}enableTempParent(){const T=this.parent;return this.parent=this._tempDisplayObjectParent,T}disableTempParent(T){this.parent=T}get x(){return this.position.x}set x(T){this.transform.position.x=T}get y(){return this.position.y}set y(T){this.transform.position.y=T}get worldTransform(){return this.transform.worldTransform}get localTransform(){return this.transform.localTransform}get position(){return this.transform.position}set position(T){this.transform.position.copyFrom(T)}get scale(){return this.transform.scale}set scale(T){this.transform.scale.copyFrom(T)}get pivot(){return this.transform.pivot}set pivot(T){this.transform.pivot.copyFrom(T)}get skew(){return this.transform.skew}set skew(T){this.transform.skew.copyFrom(T)}get rotation(){return this.transform.rotation}set rotation(T){this.transform.rotation=T}get angle(){return this.transform.rotation*RAD_TO_DEG}set angle(T){this.transform.rotation=T*DEG_TO_RAD}get zIndex(){return this._zIndex}set zIndex(T){this._zIndex!==T&&(this._zIndex=T,this.parent&&(this.parent.sortDirty=!0))}get worldVisible(){let T=this;do{if(!T.visible)return!1;T=T.parent}while(T);return!0}get mask(){return this._mask}set mask(T){if(this._mask!==T){if(this._mask){const L=this._mask.isMaskData?this._mask.maskObject:this._mask;L&&(L._maskRefCount--,L._maskRefCount===0&&(L.renderable=!0,L.isMask=!1))}if(this._mask=T,this._mask){const L=this._mask.isMaskData?this._mask.maskObject:this._mask;L&&(L._maskRefCount===0&&(L.renderable=!1,L.isMask=!0),L._maskRefCount++)}}}}class TemporaryDisplayObject extends DisplayObject{constructor(){super(...arguments),this.sortDirty=null}}DisplayObject.prototype.displayObjectUpdateTransform=DisplayObject.prototype.updateTransform;const tempMatrix=new Matrix;function sortChildren(R,T){return R.zIndex===T.zIndex?R._lastSortedIndex-T._lastSortedIndex:R.zIndex-T.zIndex}const _Container=class nr extends DisplayObject{constructor(){super(),this.children=[],this.sortableChildren=nr.defaultSortableChildren,this.sortDirty=!1}onChildrenChange(T){}addChild(...T){if(T.length>1)for(let L=0;L<T.length;L++)this.addChild(T[L]);else{const L=T[0];L.parent&&L.parent.removeChild(L),L.parent=this,this.sortDirty=!0,L.transform._parentID=-1,this.children.push(L),this._boundsID++,this.onChildrenChange(this.children.length-1),this.emit("childAdded",L,this,this.children.length-1),L.emit("added",this)}return T[0]}addChildAt(T,L){if(L<0||L>this.children.length)throw new Error(`${T}addChildAt: The index ${L} supplied is out of bounds ${this.children.length}`);return T.parent&&T.parent.removeChild(T),T.parent=this,this.sortDirty=!0,T.transform._parentID=-1,this.children.splice(L,0,T),this._boundsID++,this.onChildrenChange(L),T.emit("added",this),this.emit("childAdded",T,this,L),T}swapChildren(T,L){if(T===L)return;const P=this.getChildIndex(T),I=this.getChildIndex(L);this.children[P]=L,this.children[I]=T,this.onChildrenChange(P<I?P:I)}getChildIndex(T){const L=this.children.indexOf(T);if(L===-1)throw new Error("The supplied DisplayObject must be a child of the caller");return L}setChildIndex(T,L){if(L<0||L>=this.children.length)throw new Error(`The index ${L} supplied is out of bounds ${this.children.length}`);const P=this.getChildIndex(T);removeItems(this.children,P,1),this.children.splice(L,0,T),this.onChildrenChange(L)}getChildAt(T){if(T<0||T>=this.children.length)throw new Error(`getChildAt: Index (${T}) does not exist.`);return this.children[T]}removeChild(...T){if(T.length>1)for(let L=0;L<T.length;L++)this.removeChild(T[L]);else{const L=T[0],P=this.children.indexOf(L);if(P===-1)return null;L.parent=null,L.transform._parentID=-1,removeItems(this.children,P,1),this._boundsID++,this.onChildrenChange(P),L.emit("removed",this),this.emit("childRemoved",L,this,P)}return T[0]}removeChildAt(T){const L=this.getChildAt(T);return L.parent=null,L.transform._parentID=-1,removeItems(this.children,T,1),this._boundsID++,this.onChildrenChange(T),L.emit("removed",this),this.emit("childRemoved",L,this,T),L}removeChildren(T=0,L=this.children.length){const P=T,I=L,F=I-P;let D;if(F>0&&F<=I){D=this.children.splice(P,F);for(let V=0;V<D.length;++V)D[V].parent=null,D[V].transform&&(D[V].transform._parentID=-1);this._boundsID++,this.onChildrenChange(T);for(let V=0;V<D.length;++V)D[V].emit("removed",this),this.emit("childRemoved",D[V],this,V);return D}else if(F===0&&this.children.length===0)return[];throw new RangeError("removeChildren: numeric values are outside the acceptable range.")}sortChildren(){let T=!1;for(let L=0,P=this.children.length;L<P;++L){const I=this.children[L];I._lastSortedIndex=L,!T&&I.zIndex!==0&&(T=!0)}T&&this.children.length>1&&this.children.sort(sortChildren),this.sortDirty=!1}updateTransform(){this.sortableChildren&&this.sortDirty&&this.sortChildren(),this._boundsID++,this.transform.updateTransform(this.parent.transform),this.worldAlpha=this.alpha*this.parent.worldAlpha;for(let T=0,L=this.children.length;T<L;++T){const P=this.children[T];P.visible&&P.updateTransform()}}calculateBounds(){this._bounds.clear(),this._calculateBounds();for(let T=0;T<this.children.length;T++){const L=this.children[T];if(!(!L.visible||!L.renderable))if(L.calculateBounds(),L._mask){const P=L._mask.isMaskData?L._mask.maskObject:L._mask;P?(P.calculateBounds(),this._bounds.addBoundsMask(L._bounds,P._bounds)):this._bounds.addBounds(L._bounds)}else L.filterArea?this._bounds.addBoundsArea(L._bounds,L.filterArea):this._bounds.addBounds(L._bounds)}this._bounds.updateID=this._boundsID}getLocalBounds(T,L=!1){const P=super.getLocalBounds(T);if(!L)for(let I=0,F=this.children.length;I<F;++I){const D=this.children[I];D.visible&&D.updateTransform()}return P}_calculateBounds(){}_renderWithCulling(T){const L=T.renderTexture.sourceFrame;if(!(L.width>0&&L.height>0))return;let P,I;this.cullArea?(P=this.cullArea,I=this.worldTransform):this._render!==nr.prototype._render&&(P=this.getBounds(!0));const F=T.projection.transform;if(F&&(I?(I=tempMatrix.copyFrom(I),I.prepend(F)):I=F),P&&L.intersects(P,I))this._render(T);else if(this.cullArea)return;for(let D=0,V=this.children.length;D<V;++D){const q=this.children[D],G=q.cullable;q.cullable=G||!this.cullArea,q.render(T),q.cullable=G}}render(T){if(!(!this.visible||this.worldAlpha<=0||!this.renderable))if(this._mask||this.filters?.length)this.renderAdvanced(T);else if(this.cullable)this._renderWithCulling(T);else{this._render(T);for(let L=0,P=this.children.length;L<P;++L)this.children[L].render(T)}}renderAdvanced(T){const L=this.filters,P=this._mask;if(L){this._enabledFilters||(this._enabledFilters=[]),this._enabledFilters.length=0;for(let F=0;F<L.length;F++)L[F].enabled&&this._enabledFilters.push(L[F])}const I=L&&this._enabledFilters?.length||P&&(!P.isMaskData||P.enabled&&(P.autoDetect||P.type!==MASK_TYPES.NONE));if(I&&T.batch.flush(),L&&this._enabledFilters?.length&&T.filter.push(this,this._enabledFilters),P&&T.mask.push(this,this._mask),this.cullable)this._renderWithCulling(T);else{this._render(T);for(let F=0,D=this.children.length;F<D;++F)this.children[F].render(T)}I&&T.batch.flush(),P&&T.mask.pop(this),L&&this._enabledFilters?.length&&T.filter.pop()}_render(T){}destroy(T){super.destroy(),this.sortDirty=!1;const L=typeof T=="boolean"?T:T?.children,P=this.removeChildren(0,this.children.length);if(L)for(let I=0;I<P.length;++I)P[I].destroy(T)}get width(){return this.scale.x*this.getLocalBounds().width}set width(T){const L=this.getLocalBounds().width;L!==0?this.scale.x=T/L:this.scale.x=1,this._width=T}get height(){return this.scale.y*this.getLocalBounds().height}set height(T){const L=this.getLocalBounds().height;L!==0?this.scale.y=T/L:this.scale.y=1,this._height=T}};_Container.defaultSortableChildren=!1;let Container=_Container;Container.prototype.containerUpdateTransform=Container.prototype.updateTransform;Object.defineProperties(settings,{SORTABLE_CHILDREN:{get(){return Container.defaultSortableChildren},set(R){deprecation("7.1.0","settings.SORTABLE_CHILDREN is deprecated, use Container.defaultSortableChildren"),Container.defaultSortableChildren=R}}});const _Application=class ar{constructor(T){this.stage=new Container,T=Object.assign({forceCanvas:!1},T),this.renderer=autoDetectRenderer(T),ar._plugins.forEach(L=>{L.init.call(this,T)})}render(){this.renderer.render(this.stage)}get view(){return this.renderer?.view}get screen(){return this.renderer?.screen}destroy(T,L){const P=ar._plugins.slice(0);P.reverse(),P.forEach(I=>{I.destroy.call(this)}),this.stage.destroy(L),this.stage=null,this.renderer.destroy(T),this.renderer=null}};_Application._plugins=[];let Application=_Application;extensions.handleByList(ExtensionType.Application,Application._plugins);class ResizePlugin{static init(T){Object.defineProperty(this,"resizeTo",{set(L){globalThis.removeEventListener("resize",this.queueResize),this._resizeTo=L,L&&(globalThis.addEventListener("resize",this.queueResize),this.resize())},get(){return this._resizeTo}}),this.queueResize=()=>{this._resizeTo&&(this.cancelResize(),this._resizeId=requestAnimationFrame(()=>this.resize()))},this.cancelResize=()=>{this._resizeId&&(cancelAnimationFrame(this._resizeId),this._resizeId=null)},this.resize=()=>{if(!this._resizeTo)return;this.cancelResize();let L,P;if(this._resizeTo===globalThis.window)L=globalThis.innerWidth,P=globalThis.innerHeight;else{const{clientWidth:I,clientHeight:F}=this._resizeTo;L=I,P=F}this.renderer.resize(L,P),this.render()},this._resizeId=null,this._resizeTo=null,this.resizeTo=T.resizeTo||null}static destroy(){globalThis.removeEventListener("resize",this.queueResize),this.cancelResize(),this.cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null}}ResizePlugin.extension=ExtensionType.Application;extensions.add(ResizePlugin);var d=`attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat3 projectionMatrix;

varying vec2 vTextureCoord;

void main(void)
{
    gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);
    vTextureCoord = aTextureCoord;
}`,u=`uniform float radius;
uniform float strength;
uniform vec2 center;
uniform sampler2D uSampler;
varying vec2 vTextureCoord;

uniform vec4 filterArea;
uniform vec4 filterClamp;
uniform vec2 dimensions;

void main()
{
    vec2 coord = vTextureCoord * filterArea.xy;
    coord -= center * dimensions.xy;
    float distance = length(coord);
    if (distance < radius) {
        float percent = distance / radius;
        if (strength > 0.0) {
            coord *= mix(1.0, smoothstep(0.0, radius / distance, percent), strength * 0.75);
        } else {
            coord *= mix(1.0, pow(percent, 1.0 + strength * 0.75) * radius / distance, 1.0 - percent);
        }
    }
    coord += center * dimensions.xy;
    coord /= filterArea.xy;
    vec2 clampedCoord = clamp(coord, filterClamp.xy, filterClamp.zw);
    vec4 color = texture2D(uSampler, clampedCoord);
    if (coord != clampedCoord) {
        color *= max(0.0, 1.0 - length(coord - clampedCoord));
    }

    gl_FragColor = color;
}
`;const n=class extends Filter{constructor(R){super(d,u),this.uniforms.dimensions=new Float32Array(2),Object.assign(this,n.defaults,R)}apply(R,T,L,P){const{width:I,height:F}=T.filterFrame;this.uniforms.dimensions[0]=I,this.uniforms.dimensions[1]=F,R.applyFilter(this,T,L,P)}get radius(){return this.uniforms.radius}set radius(R){this.uniforms.radius=R}get strength(){return this.uniforms.strength}set strength(R){this.uniforms.strength=R}get center(){return this.uniforms.center}set center(R){this.uniforms.center=R}};let t=n;t.defaults={center:[.5,.5],radius:100,strength:1};var fragment=`varying vec2 vTextureCoord;
uniform sampler2D uSampler;
uniform float m[20];
uniform float uAlpha;

void main(void)
{
    vec4 c = texture2D(uSampler, vTextureCoord);

    if (uAlpha == 0.0) {
        gl_FragColor = c;
        return;
    }

    // Un-premultiply alpha before applying the color matrix. See issue #3539.
    if (c.a > 0.0) {
      c.rgb /= c.a;
    }

    vec4 result;

    result.r = (m[0] * c.r);
        result.r += (m[1] * c.g);
        result.r += (m[2] * c.b);
        result.r += (m[3] * c.a);
        result.r += m[4];

    result.g = (m[5] * c.r);
        result.g += (m[6] * c.g);
        result.g += (m[7] * c.b);
        result.g += (m[8] * c.a);
        result.g += m[9];

    result.b = (m[10] * c.r);
       result.b += (m[11] * c.g);
       result.b += (m[12] * c.b);
       result.b += (m[13] * c.a);
       result.b += m[14];

    result.a = (m[15] * c.r);
       result.a += (m[16] * c.g);
       result.a += (m[17] * c.b);
       result.a += (m[18] * c.a);
       result.a += m[19];

    vec3 rgb = mix(c.rgb, result.rgb, uAlpha);

    // Premultiply alpha again.
    rgb *= result.a;

    gl_FragColor = vec4(rgb, result.a);
}
`;class ColorMatrixFilter extends Filter{constructor(){const T={m:new Float32Array([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]),uAlpha:1};super(defaultFilterVertex,fragment,T),this.alpha=1}_loadMatrix(T,L=!1){let P=T;L&&(this._multiply(P,this.uniforms.m,T),P=this._colorMatrix(P)),this.uniforms.m=P}_multiply(T,L,P){return T[0]=L[0]*P[0]+L[1]*P[5]+L[2]*P[10]+L[3]*P[15],T[1]=L[0]*P[1]+L[1]*P[6]+L[2]*P[11]+L[3]*P[16],T[2]=L[0]*P[2]+L[1]*P[7]+L[2]*P[12]+L[3]*P[17],T[3]=L[0]*P[3]+L[1]*P[8]+L[2]*P[13]+L[3]*P[18],T[4]=L[0]*P[4]+L[1]*P[9]+L[2]*P[14]+L[3]*P[19]+L[4],T[5]=L[5]*P[0]+L[6]*P[5]+L[7]*P[10]+L[8]*P[15],T[6]=L[5]*P[1]+L[6]*P[6]+L[7]*P[11]+L[8]*P[16],T[7]=L[5]*P[2]+L[6]*P[7]+L[7]*P[12]+L[8]*P[17],T[8]=L[5]*P[3]+L[6]*P[8]+L[7]*P[13]+L[8]*P[18],T[9]=L[5]*P[4]+L[6]*P[9]+L[7]*P[14]+L[8]*P[19]+L[9],T[10]=L[10]*P[0]+L[11]*P[5]+L[12]*P[10]+L[13]*P[15],T[11]=L[10]*P[1]+L[11]*P[6]+L[12]*P[11]+L[13]*P[16],T[12]=L[10]*P[2]+L[11]*P[7]+L[12]*P[12]+L[13]*P[17],T[13]=L[10]*P[3]+L[11]*P[8]+L[12]*P[13]+L[13]*P[18],T[14]=L[10]*P[4]+L[11]*P[9]+L[12]*P[14]+L[13]*P[19]+L[14],T[15]=L[15]*P[0]+L[16]*P[5]+L[17]*P[10]+L[18]*P[15],T[16]=L[15]*P[1]+L[16]*P[6]+L[17]*P[11]+L[18]*P[16],T[17]=L[15]*P[2]+L[16]*P[7]+L[17]*P[12]+L[18]*P[17],T[18]=L[15]*P[3]+L[16]*P[8]+L[17]*P[13]+L[18]*P[18],T[19]=L[15]*P[4]+L[16]*P[9]+L[17]*P[14]+L[18]*P[19]+L[19],T}_colorMatrix(T){const L=new Float32Array(T);return L[4]/=255,L[9]/=255,L[14]/=255,L[19]/=255,L}brightness(T,L){const P=[T,0,0,0,0,0,T,0,0,0,0,0,T,0,0,0,0,0,1,0];this._loadMatrix(P,L)}tint(T,L){const[P,I,F]=Color.shared.setValue(T).toArray(),D=[P,0,0,0,0,0,I,0,0,0,0,0,F,0,0,0,0,0,1,0];this._loadMatrix(D,L)}greyscale(T,L){const P=[T,T,T,0,0,T,T,T,0,0,T,T,T,0,0,0,0,0,1,0];this._loadMatrix(P,L)}blackAndWhite(T){const L=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0];this._loadMatrix(L,T)}hue(T,L){T=(T||0)/180*Math.PI;const P=Math.cos(T),I=Math.sin(T),F=Math.sqrt,D=1/3,V=F(D),q=P+(1-P)*D,G=D*(1-P)-V*I,z=D*(1-P)+V*I,Q=D*(1-P)+V*I,J=P+D*(1-P),tt=D*(1-P)-V*I,yt=D*(1-P)-V*I,At=D*(1-P)+V*I,gt=P+D*(1-P),Et=[q,G,z,0,0,Q,J,tt,0,0,yt,At,gt,0,0,0,0,0,1,0];this._loadMatrix(Et,L)}contrast(T,L){const P=(T||0)+1,I=-.5*(P-1),F=[P,0,0,0,I,0,P,0,0,I,0,0,P,0,I,0,0,0,1,0];this._loadMatrix(F,L)}saturate(T=0,L){const P=T*2/3+1,I=(P-1)*-.5,F=[P,I,I,0,0,I,P,I,0,0,I,I,P,0,0,0,0,0,1,0];this._loadMatrix(F,L)}desaturate(){this.saturate(-1)}negative(T){const L=[-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0];this._loadMatrix(L,T)}sepia(T){const L=[.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0];this._loadMatrix(L,T)}technicolor(T){const L=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0];this._loadMatrix(L,T)}polaroid(T){const L=[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0];this._loadMatrix(L,T)}toBGR(T){const L=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0];this._loadMatrix(L,T)}kodachrome(T){const L=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0];this._loadMatrix(L,T)}browni(T){const L=[.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0];this._loadMatrix(L,T)}vintage(T){const L=[.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0];this._loadMatrix(L,T)}colorTone(T,L,P,I,F){T=T||.2,L=L||.15,P=P||16770432,I=I||3375104;const D=Color.shared,[V,q,G]=D.setValue(P).toArray(),[z,Q,J]=D.setValue(I).toArray(),tt=[.3,.59,.11,0,0,V,q,G,T,0,z,Q,J,L,0,V-z,q-Q,G-J,0,0];this._loadMatrix(tt,F)}night(T,L){T=T||.1;const P=[T*-2,-T,0,0,0,-T,0,T,0,0,0,T,T*2,0,0,0,0,0,1,0];this._loadMatrix(P,L)}predator(T,L){const P=[11.224130630493164*T,-4.794486999511719*T,-2.8746118545532227*T,0*T,.40342438220977783*T,-3.6330697536468506*T,9.193157196044922*T,-2.951810836791992*T,0*T,-1.316135048866272*T,-3.2184197902679443*T,-4.2375030517578125*T,7.476448059082031*T,0*T,.8044459223747253*T,0,0,0,1,0];this._loadMatrix(P,L)}lsd(T){const L=[2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0];this._loadMatrix(L,T)}reset(){const T=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0];this._loadMatrix(T,!1)}get matrix(){return this.uniforms.m}set matrix(T){this.uniforms.m=T}get alpha(){return this.uniforms.uAlpha}set alpha(T){this.uniforms.uAlpha=T}}ColorMatrixFilter.prototype.grayscale=ColorMatrixFilter.prototype.greyscale;var be=Object.defineProperty,xe=(R,T,L)=>T in R?be(R,T,{enumerable:!0,configurable:!0,writable:!0,value:L}):R[T]=L,f=(R,T,L)=>xe(R,typeof T!="symbol"?T+"":T,L);class Ee{}class re extends Ee{constructor(T){super(),f(this,"observer"),f(this,"flowSpeed",4),f(this,"currerntRenderScale",.75),this.canvas=T,this.observer=new ResizeObserver(()=>{const L=Math.max(1,T.clientWidth*window.devicePixelRatio*this.currerntRenderScale),P=Math.max(1,T.clientHeight*window.devicePixelRatio*this.currerntRenderScale);this.onResize(L,P)}),this.observer.observe(T)}setRenderScale(T){this.currerntRenderScale=T,this.onResize(this.canvas.clientWidth*window.devicePixelRatio*this.currerntRenderScale,this.canvas.clientHeight*window.devicePixelRatio*this.currerntRenderScale)}onResize(T,L){this.canvas.width=T,this.canvas.height=L}setFlowSpeed(T){this.flowSpeed=T}dispose(){this.observer.disconnect(),this.canvas.remove()}getElement(){return this.canvas}}const N=1e-6,Ut=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),B=class ki extends Float32Array{constructor(...T){switch(T.length){case 16:super(T);break;case 2:super(T[0],T[1],16);break;case 1:const L=T[0];typeof L=="number"?super([L,L,L,L,L,L,L,L,L,L,L,L,L,L,L,L]):super(L,0,16);break;default:super(Ut);break}}get str(){return ki.str(this)}copy(T){return this.set(T),this}identity(){return this.set(Ut),this}multiply(T){return ki.multiply(this,this,T)}mul(T){return this}transpose(){return ki.transpose(this,this)}invert(){return ki.invert(this,this)}translate(T){return ki.translate(this,this,T)}rotate(T,L){return ki.rotate(this,this,T,L)}scale(T){return ki.scale(this,this,T)}rotateX(T){return ki.rotateX(this,this,T)}rotateY(T){return ki.rotateY(this,this,T)}rotateZ(T){return ki.rotateZ(this,this,T)}perspectiveNO(T,L,P,I){return ki.perspectiveNO(this,T,L,P,I)}perspectiveZO(T,L,P,I){return ki.perspectiveZO(this,T,L,P,I)}orthoNO(T,L,P,I,F,D){return ki.orthoNO(this,T,L,P,I,F,D)}orthoZO(T,L,P,I,F,D){return ki.orthoZO(this,T,L,P,I,F,D)}static create(){return new ki}static clone(T){return new ki(T)}static copy(T,L){return T[0]=L[0],T[1]=L[1],T[2]=L[2],T[3]=L[3],T[4]=L[4],T[5]=L[5],T[6]=L[6],T[7]=L[7],T[8]=L[8],T[9]=L[9],T[10]=L[10],T[11]=L[11],T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15],T}static fromValues(...T){return new ki(...T)}static set(T,...L){return T[0]=L[0],T[1]=L[1],T[2]=L[2],T[3]=L[3],T[4]=L[4],T[5]=L[5],T[6]=L[6],T[7]=L[7],T[8]=L[8],T[9]=L[9],T[10]=L[10],T[11]=L[11],T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15],T}static identity(T){return T[0]=1,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=1,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[10]=1,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static transpose(T,L){if(T===L){const P=L[1],I=L[2],F=L[3],D=L[6],V=L[7],q=L[11];T[1]=L[4],T[2]=L[8],T[3]=L[12],T[4]=P,T[6]=L[9],T[7]=L[13],T[8]=I,T[9]=D,T[11]=L[14],T[12]=F,T[13]=V,T[14]=q}else T[0]=L[0],T[1]=L[4],T[2]=L[8],T[3]=L[12],T[4]=L[1],T[5]=L[5],T[6]=L[9],T[7]=L[13],T[8]=L[2],T[9]=L[6],T[10]=L[10],T[11]=L[14],T[12]=L[3],T[13]=L[7],T[14]=L[11],T[15]=L[15];return T}static invert(T,L){const P=L[0],I=L[1],F=L[2],D=L[3],V=L[4],q=L[5],G=L[6],z=L[7],Q=L[8],J=L[9],tt=L[10],yt=L[11],At=L[12],gt=L[13],Et=L[14],kt=L[15],ne=P*q-I*V,Se=P*G-F*V,Ht=P*z-D*V,Le=I*G-F*q,ee=I*z-D*q,si=F*z-D*G,ci=Q*gt-J*At,di=Q*Et-tt*At,ui=Q*kt-yt*At,ei=J*Et-tt*gt,bi=J*kt-yt*gt,yi=tt*kt-yt*Et;let gi=ne*yi-Se*bi+Ht*ei+Le*ui-ee*di+si*ci;return gi?(gi=1/gi,T[0]=(q*yi-G*bi+z*ei)*gi,T[1]=(F*bi-I*yi-D*ei)*gi,T[2]=(gt*si-Et*ee+kt*Le)*gi,T[3]=(tt*ee-J*si-yt*Le)*gi,T[4]=(G*ui-V*yi-z*di)*gi,T[5]=(P*yi-F*ui+D*di)*gi,T[6]=(Et*Ht-At*si-kt*Se)*gi,T[7]=(Q*si-tt*Ht+yt*Se)*gi,T[8]=(V*bi-q*ui+z*ci)*gi,T[9]=(I*ui-P*bi-D*ci)*gi,T[10]=(At*ee-gt*Ht+kt*ne)*gi,T[11]=(J*Ht-Q*ee-yt*ne)*gi,T[12]=(q*di-V*ei-G*ci)*gi,T[13]=(P*ei-I*di+F*ci)*gi,T[14]=(gt*Se-At*Le-Et*ne)*gi,T[15]=(Q*Le-J*Se+tt*ne)*gi,T):null}static adjoint(T,L){const P=L[0],I=L[1],F=L[2],D=L[3],V=L[4],q=L[5],G=L[6],z=L[7],Q=L[8],J=L[9],tt=L[10],yt=L[11],At=L[12],gt=L[13],Et=L[14],kt=L[15],ne=P*q-I*V,Se=P*G-F*V,Ht=P*z-D*V,Le=I*G-F*q,ee=I*z-D*q,si=F*z-D*G,ci=Q*gt-J*At,di=Q*Et-tt*At,ui=Q*kt-yt*At,ei=J*Et-tt*gt,bi=J*kt-yt*gt,yi=tt*kt-yt*Et;return T[0]=q*yi-G*bi+z*ei,T[1]=F*bi-I*yi-D*ei,T[2]=gt*si-Et*ee+kt*Le,T[3]=tt*ee-J*si-yt*Le,T[4]=G*ui-V*yi-z*di,T[5]=P*yi-F*ui+D*di,T[6]=Et*Ht-At*si-kt*Se,T[7]=Q*si-tt*Ht+yt*Se,T[8]=V*bi-q*ui+z*ci,T[9]=I*ui-P*bi-D*ci,T[10]=At*ee-gt*Ht+kt*ne,T[11]=J*Ht-Q*ee-yt*ne,T[12]=q*di-V*ei-G*ci,T[13]=P*ei-I*di+F*ci,T[14]=gt*Se-At*Le-Et*ne,T[15]=Q*Le-J*Se+tt*ne,T}static determinant(T){const L=T[0],P=T[1],I=T[2],F=T[3],D=T[4],V=T[5],q=T[6],G=T[7],z=T[8],Q=T[9],J=T[10],tt=T[11],yt=T[12],At=T[13],gt=T[14],Et=T[15],kt=L*V-P*D,ne=L*q-I*D,Se=P*q-I*V,Ht=z*At-Q*yt,Le=z*gt-J*yt,ee=Q*gt-J*At,si=L*ee-P*Le+I*Ht,ci=D*ee-V*Le+q*Ht,di=z*Se-Q*ne+J*kt,ui=yt*Se-At*ne+gt*kt;return G*si-F*ci+Et*di-tt*ui}static multiply(T,L,P){const I=L[0],F=L[1],D=L[2],V=L[3],q=L[4],G=L[5],z=L[6],Q=L[7],J=L[8],tt=L[9],yt=L[10],At=L[11],gt=L[12],Et=L[13],kt=L[14],ne=L[15];let Se=P[0],Ht=P[1],Le=P[2],ee=P[3];return T[0]=Se*I+Ht*q+Le*J+ee*gt,T[1]=Se*F+Ht*G+Le*tt+ee*Et,T[2]=Se*D+Ht*z+Le*yt+ee*kt,T[3]=Se*V+Ht*Q+Le*At+ee*ne,Se=P[4],Ht=P[5],Le=P[6],ee=P[7],T[4]=Se*I+Ht*q+Le*J+ee*gt,T[5]=Se*F+Ht*G+Le*tt+ee*Et,T[6]=Se*D+Ht*z+Le*yt+ee*kt,T[7]=Se*V+Ht*Q+Le*At+ee*ne,Se=P[8],Ht=P[9],Le=P[10],ee=P[11],T[8]=Se*I+Ht*q+Le*J+ee*gt,T[9]=Se*F+Ht*G+Le*tt+ee*Et,T[10]=Se*D+Ht*z+Le*yt+ee*kt,T[11]=Se*V+Ht*Q+Le*At+ee*ne,Se=P[12],Ht=P[13],Le=P[14],ee=P[15],T[12]=Se*I+Ht*q+Le*J+ee*gt,T[13]=Se*F+Ht*G+Le*tt+ee*Et,T[14]=Se*D+Ht*z+Le*yt+ee*kt,T[15]=Se*V+Ht*Q+Le*At+ee*ne,T}static mul(T,L,P){return T}static translate(T,L,P){const I=P[0],F=P[1],D=P[2];if(L===T)T[12]=L[0]*I+L[4]*F+L[8]*D+L[12],T[13]=L[1]*I+L[5]*F+L[9]*D+L[13],T[14]=L[2]*I+L[6]*F+L[10]*D+L[14],T[15]=L[3]*I+L[7]*F+L[11]*D+L[15];else{const V=L[0],q=L[1],G=L[2],z=L[3],Q=L[4],J=L[5],tt=L[6],yt=L[7],At=L[8],gt=L[9],Et=L[10],kt=L[11];T[0]=V,T[1]=q,T[2]=G,T[3]=z,T[4]=Q,T[5]=J,T[6]=tt,T[7]=yt,T[8]=At,T[9]=gt,T[10]=Et,T[11]=kt,T[12]=V*I+Q*F+At*D+L[12],T[13]=q*I+J*F+gt*D+L[13],T[14]=G*I+tt*F+Et*D+L[14],T[15]=z*I+yt*F+kt*D+L[15]}return T}static scale(T,L,P){const I=P[0],F=P[1],D=P[2];return T[0]=L[0]*I,T[1]=L[1]*I,T[2]=L[2]*I,T[3]=L[3]*I,T[4]=L[4]*F,T[5]=L[5]*F,T[6]=L[6]*F,T[7]=L[7]*F,T[8]=L[8]*D,T[9]=L[9]*D,T[10]=L[10]*D,T[11]=L[11]*D,T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15],T}static rotate(T,L,P,I){let F=I[0],D=I[1],V=I[2],q=Math.sqrt(F*F+D*D+V*V);if(q<N)return null;q=1/q,F*=q,D*=q,V*=q;const G=Math.sin(P),z=Math.cos(P),Q=1-z,J=L[0],tt=L[1],yt=L[2],At=L[3],gt=L[4],Et=L[5],kt=L[6],ne=L[7],Se=L[8],Ht=L[9],Le=L[10],ee=L[11],si=F*F*Q+z,ci=D*F*Q+V*G,di=V*F*Q-D*G,ui=F*D*Q-V*G,ei=D*D*Q+z,bi=V*D*Q+F*G,yi=F*V*Q+D*G,gi=D*V*Q-F*G,we=V*V*Q+z;return T[0]=J*si+gt*ci+Se*di,T[1]=tt*si+Et*ci+Ht*di,T[2]=yt*si+kt*ci+Le*di,T[3]=At*si+ne*ci+ee*di,T[4]=J*ui+gt*ei+Se*bi,T[5]=tt*ui+Et*ei+Ht*bi,T[6]=yt*ui+kt*ei+Le*bi,T[7]=At*ui+ne*ei+ee*bi,T[8]=J*yi+gt*gi+Se*we,T[9]=tt*yi+Et*gi+Ht*we,T[10]=yt*yi+kt*gi+Le*we,T[11]=At*yi+ne*gi+ee*we,L!==T&&(T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15]),T}static rotateX(T,L,P){let I=Math.sin(P),F=Math.cos(P),D=L[4],V=L[5],q=L[6],G=L[7],z=L[8],Q=L[9],J=L[10],tt=L[11];return L!==T&&(T[0]=L[0],T[1]=L[1],T[2]=L[2],T[3]=L[3],T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15]),T[4]=D*F+z*I,T[5]=V*F+Q*I,T[6]=q*F+J*I,T[7]=G*F+tt*I,T[8]=z*F-D*I,T[9]=Q*F-V*I,T[10]=J*F-q*I,T[11]=tt*F-G*I,T}static rotateY(T,L,P){let I=Math.sin(P),F=Math.cos(P),D=L[0],V=L[1],q=L[2],G=L[3],z=L[8],Q=L[9],J=L[10],tt=L[11];return L!==T&&(T[4]=L[4],T[5]=L[5],T[6]=L[6],T[7]=L[7],T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15]),T[0]=D*F-z*I,T[1]=V*F-Q*I,T[2]=q*F-J*I,T[3]=G*F-tt*I,T[8]=D*I+z*F,T[9]=V*I+Q*F,T[10]=q*I+J*F,T[11]=G*I+tt*F,T}static rotateZ(T,L,P){let I=Math.sin(P),F=Math.cos(P),D=L[0],V=L[1],q=L[2],G=L[3],z=L[4],Q=L[5],J=L[6],tt=L[7];return L!==T&&(T[8]=L[8],T[9]=L[9],T[10]=L[10],T[11]=L[11],T[12]=L[12],T[13]=L[13],T[14]=L[14],T[15]=L[15]),T[0]=D*F+z*I,T[1]=V*F+Q*I,T[2]=q*F+J*I,T[3]=G*F+tt*I,T[4]=z*F-D*I,T[5]=Q*F-V*I,T[6]=J*F-q*I,T[7]=tt*F-G*I,T}static fromTranslation(T,L){return T[0]=1,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=1,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[10]=1,T[11]=0,T[12]=L[0],T[13]=L[1],T[14]=L[2],T[15]=1,T}static fromScaling(T,L){return T[0]=L[0],T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=L[1],T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[10]=L[2],T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static fromRotation(T,L,P){let I=P[0],F=P[1],D=P[2],V=Math.sqrt(I*I+F*F+D*D);if(V<N)return null;V=1/V,I*=V,F*=V,D*=V;const q=Math.sin(L),G=Math.cos(L),z=1-G;return T[0]=I*I*z+G,T[1]=F*I*z+D*q,T[2]=D*I*z-F*q,T[3]=0,T[4]=I*F*z-D*q,T[5]=F*F*z+G,T[6]=D*F*z+I*q,T[7]=0,T[8]=I*D*z+F*q,T[9]=F*D*z-I*q,T[10]=D*D*z+G,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static fromXRotation(T,L){let P=Math.sin(L),I=Math.cos(L);return T[0]=1,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=I,T[6]=P,T[7]=0,T[8]=0,T[9]=-P,T[10]=I,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static fromYRotation(T,L){let P=Math.sin(L),I=Math.cos(L);return T[0]=I,T[1]=0,T[2]=-P,T[3]=0,T[4]=0,T[5]=1,T[6]=0,T[7]=0,T[8]=P,T[9]=0,T[10]=I,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static fromZRotation(T,L){const P=Math.sin(L),I=Math.cos(L);return T[0]=I,T[1]=P,T[2]=0,T[3]=0,T[4]=-P,T[5]=I,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[10]=1,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static fromRotationTranslation(T,L,P){const I=L[0],F=L[1],D=L[2],V=L[3],q=I+I,G=F+F,z=D+D,Q=I*q,J=I*G,tt=I*z,yt=F*G,At=F*z,gt=D*z,Et=V*q,kt=V*G,ne=V*z;return T[0]=1-(yt+gt),T[1]=J+ne,T[2]=tt-kt,T[3]=0,T[4]=J-ne,T[5]=1-(Q+gt),T[6]=At+Et,T[7]=0,T[8]=tt+kt,T[9]=At-Et,T[10]=1-(Q+yt),T[11]=0,T[12]=P[0],T[13]=P[1],T[14]=P[2],T[15]=1,T}static fromQuat2(T,L){const P=-L[0],I=-L[1],F=-L[2],D=L[3],V=L[4],q=L[5],G=L[6],z=L[7];let Q=P*P+I*I+F*F+D*D;return Q>0?(Y[0]=(V*D+z*P+q*F-G*I)*2/Q,Y[1]=(q*D+z*I+G*P-V*F)*2/Q,Y[2]=(G*D+z*F+V*I-q*P)*2/Q):(Y[0]=(V*D+z*P+q*F-G*I)*2,Y[1]=(q*D+z*I+G*P-V*F)*2,Y[2]=(G*D+z*F+V*I-q*P)*2),ki.fromRotationTranslation(T,L,Y),T}static normalFromMat4(T,L){const P=L[0],I=L[1],F=L[2],D=L[3],V=L[4],q=L[5],G=L[6],z=L[7],Q=L[8],J=L[9],tt=L[10],yt=L[11],At=L[12],gt=L[13],Et=L[14],kt=L[15],ne=P*q-I*V,Se=P*G-F*V,Ht=P*z-D*V,Le=I*G-F*q,ee=I*z-D*q,si=F*z-D*G,ci=Q*gt-J*At,di=Q*Et-tt*At,ui=Q*kt-yt*At,ei=J*Et-tt*gt,bi=J*kt-yt*gt,yi=tt*kt-yt*Et;let gi=ne*yi-Se*bi+Ht*ei+Le*ui-ee*di+si*ci;return gi?(gi=1/gi,T[0]=(q*yi-G*bi+z*ei)*gi,T[1]=(G*ui-V*yi-z*di)*gi,T[2]=(V*bi-q*ui+z*ci)*gi,T[3]=0,T[4]=(F*bi-I*yi-D*ei)*gi,T[5]=(P*yi-F*ui+D*di)*gi,T[6]=(I*ui-P*bi-D*ci)*gi,T[7]=0,T[8]=(gt*si-Et*ee+kt*Le)*gi,T[9]=(Et*Ht-At*si-kt*Se)*gi,T[10]=(At*ee-gt*Ht+kt*ne)*gi,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T):null}static normalFromMat4Fast(T,L){const P=L[0],I=L[1],F=L[2],D=L[4],V=L[5],q=L[6],G=L[8],z=L[9],Q=L[10];return T[0]=V*Q-Q*z,T[1]=q*G-G*Q,T[2]=D*z-z*G,T[3]=0,T[4]=z*F-Q*I,T[5]=Q*P-G*F,T[6]=G*I-z*P,T[7]=0,T[8]=I*q-F*V,T[9]=F*D-P*q,T[10]=P*V-I*D,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static getTranslation(T,L){return T[0]=L[12],T[1]=L[13],T[2]=L[14],T}static getScaling(T,L){const P=L[0],I=L[1],F=L[2],D=L[4],V=L[5],q=L[6],G=L[8],z=L[9],Q=L[10];return T[0]=Math.sqrt(P*P+I*I+F*F),T[1]=Math.sqrt(D*D+V*V+q*q),T[2]=Math.sqrt(G*G+z*z+Q*Q),T}static getRotation(T,L){ki.getScaling(Y,L);const P=1/Y[0],I=1/Y[1],F=1/Y[2],D=L[0]*P,V=L[1]*I,q=L[2]*F,G=L[4]*P,z=L[5]*I,Q=L[6]*F,J=L[8]*P,tt=L[9]*I,yt=L[10]*F,At=D+z+yt;let gt=0;return At>0?(gt=Math.sqrt(At+1)*2,T[3]=.25*gt,T[0]=(Q-tt)/gt,T[1]=(J-q)/gt,T[2]=(V-G)/gt):D>z&&D>yt?(gt=Math.sqrt(1+D-z-yt)*2,T[3]=(Q-tt)/gt,T[0]=.25*gt,T[1]=(V+G)/gt,T[2]=(J+q)/gt):z>yt?(gt=Math.sqrt(1+z-D-yt)*2,T[3]=(J-q)/gt,T[0]=(V+G)/gt,T[1]=.25*gt,T[2]=(Q+tt)/gt):(gt=Math.sqrt(1+yt-D-z)*2,T[3]=(V-G)/gt,T[0]=(J+q)/gt,T[1]=(Q+tt)/gt,T[2]=.25*gt),T}static decompose(T,L,P,I){L[0]=I[12],L[1]=I[13],L[2]=I[14];const F=I[0],D=I[1],V=I[2],q=I[4],G=I[5],z=I[6],Q=I[8],J=I[9],tt=I[10];P[0]=Math.sqrt(F*F+D*D+V*V),P[1]=Math.sqrt(q*q+G*G+z*z),P[2]=Math.sqrt(Q*Q+J*J+tt*tt);const yt=1/P[0],At=1/P[1],gt=1/P[2],Et=F*yt,kt=D*At,ne=V*gt,Se=q*yt,Ht=G*At,Le=z*gt,ee=Q*yt,si=J*At,ci=tt*gt,di=Et+Ht+ci;let ui=0;return di>0?(ui=Math.sqrt(di+1)*2,T[3]=.25*ui,T[0]=(Le-si)/ui,T[1]=(ee-ne)/ui,T[2]=(kt-Se)/ui):Et>Ht&&Et>ci?(ui=Math.sqrt(1+Et-Ht-ci)*2,T[3]=(Le-si)/ui,T[0]=.25*ui,T[1]=(kt+Se)/ui,T[2]=(ee+ne)/ui):Ht>ci?(ui=Math.sqrt(1+Ht-Et-ci)*2,T[3]=(ee-ne)/ui,T[0]=(kt+Se)/ui,T[1]=.25*ui,T[2]=(Le+si)/ui):(ui=Math.sqrt(1+ci-Et-Ht)*2,T[3]=(kt-Se)/ui,T[0]=(ee+ne)/ui,T[1]=(Le+si)/ui,T[2]=.25*ui),T}static fromRotationTranslationScale(T,L,P,I){const F=L[0],D=L[1],V=L[2],q=L[3],G=F+F,z=D+D,Q=V+V,J=F*G,tt=F*z,yt=F*Q,At=D*z,gt=D*Q,Et=V*Q,kt=q*G,ne=q*z,Se=q*Q,Ht=I[0],Le=I[1],ee=I[2];return T[0]=(1-(At+Et))*Ht,T[1]=(tt+Se)*Ht,T[2]=(yt-ne)*Ht,T[3]=0,T[4]=(tt-Se)*Le,T[5]=(1-(J+Et))*Le,T[6]=(gt+kt)*Le,T[7]=0,T[8]=(yt+ne)*ee,T[9]=(gt-kt)*ee,T[10]=(1-(J+At))*ee,T[11]=0,T[12]=P[0],T[13]=P[1],T[14]=P[2],T[15]=1,T}static fromRotationTranslationScaleOrigin(T,L,P,I,F){const D=L[0],V=L[1],q=L[2],G=L[3],z=D+D,Q=V+V,J=q+q,tt=D*z,yt=D*Q,At=D*J,gt=V*Q,Et=V*J,kt=q*J,ne=G*z,Se=G*Q,Ht=G*J,Le=I[0],ee=I[1],si=I[2],ci=F[0],di=F[1],ui=F[2],ei=(1-(gt+kt))*Le,bi=(yt+Ht)*Le,yi=(At-Se)*Le,gi=(yt-Ht)*ee,we=(1-(tt+kt))*ee,Ge=(Et+ne)*ee,Te=(At+Se)*si,ri=(Et-ne)*si,ti=(1-(tt+gt))*si;return T[0]=ei,T[1]=bi,T[2]=yi,T[3]=0,T[4]=gi,T[5]=we,T[6]=Ge,T[7]=0,T[8]=Te,T[9]=ri,T[10]=ti,T[11]=0,T[12]=P[0]+ci-(ei*ci+gi*di+Te*ui),T[13]=P[1]+di-(bi*ci+we*di+ri*ui),T[14]=P[2]+ui-(yi*ci+Ge*di+ti*ui),T[15]=1,T}static fromQuat(T,L){const P=L[0],I=L[1],F=L[2],D=L[3],V=P+P,q=I+I,G=F+F,z=P*V,Q=I*V,J=I*q,tt=F*V,yt=F*q,At=F*G,gt=D*V,Et=D*q,kt=D*G;return T[0]=1-J-At,T[1]=Q+kt,T[2]=tt-Et,T[3]=0,T[4]=Q-kt,T[5]=1-z-At,T[6]=yt+gt,T[7]=0,T[8]=tt+Et,T[9]=yt-gt,T[10]=1-z-J,T[11]=0,T[12]=0,T[13]=0,T[14]=0,T[15]=1,T}static frustumNO(T,L,P,I,F,D,V=1/0){const q=1/(P-L),G=1/(F-I);if(T[0]=D*2*q,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=D*2*G,T[6]=0,T[7]=0,T[8]=(P+L)*q,T[9]=(F+I)*G,T[11]=-1,T[12]=0,T[13]=0,T[15]=0,V!=null&&V!==1/0){const z=1/(D-V);T[10]=(V+D)*z,T[14]=2*V*D*z}else T[10]=-1,T[14]=-2*D;return T}static frustum(T,L,P,I,F,D,V=1/0){return T}static frustumZO(T,L,P,I,F,D,V=1/0){const q=1/(P-L),G=1/(F-I);if(T[0]=D*2*q,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=D*2*G,T[6]=0,T[7]=0,T[8]=(P+L)*q,T[9]=(F+I)*G,T[11]=-1,T[12]=0,T[13]=0,T[15]=0,V!=null&&V!==1/0){const z=1/(D-V);T[10]=V*z,T[14]=V*D*z}else T[10]=-1,T[14]=-D;return T}static perspectiveNO(T,L,P,I,F=1/0){const D=1/Math.tan(L/2);if(T[0]=D/P,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=D,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[11]=-1,T[12]=0,T[13]=0,T[15]=0,F!=null&&F!==1/0){const V=1/(I-F);T[10]=(F+I)*V,T[14]=2*F*I*V}else T[10]=-1,T[14]=-2*I;return T}static perspective(T,L,P,I,F=1/0){return T}static perspectiveZO(T,L,P,I,F=1/0){const D=1/Math.tan(L/2);if(T[0]=D/P,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=D,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[11]=-1,T[12]=0,T[13]=0,T[15]=0,F!=null&&F!==1/0){const V=1/(I-F);T[10]=F*V,T[14]=F*I*V}else T[10]=-1,T[14]=-I;return T}static perspectiveFromFieldOfView(T,L,P,I){const F=Math.tan(L.upDegrees*Math.PI/180),D=Math.tan(L.downDegrees*Math.PI/180),V=Math.tan(L.leftDegrees*Math.PI/180),q=Math.tan(L.rightDegrees*Math.PI/180),G=2/(V+q),z=2/(F+D);return T[0]=G,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=z,T[6]=0,T[7]=0,T[8]=-((V-q)*G*.5),T[9]=(F-D)*z*.5,T[10]=I/(P-I),T[11]=-1,T[12]=0,T[13]=0,T[14]=I*P/(P-I),T[15]=0,T}static orthoNO(T,L,P,I,F,D,V){const q=1/(L-P),G=1/(I-F),z=1/(D-V);return T[0]=-2*q,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=-2*G,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[10]=2*z,T[11]=0,T[12]=(L+P)*q,T[13]=(F+I)*G,T[14]=(V+D)*z,T[15]=1,T}static ortho(T,L,P,I,F,D,V){return T}static orthoZO(T,L,P,I,F,D,V){const q=1/(L-P),G=1/(I-F),z=1/(D-V);return T[0]=-2*q,T[1]=0,T[2]=0,T[3]=0,T[4]=0,T[5]=-2*G,T[6]=0,T[7]=0,T[8]=0,T[9]=0,T[10]=z,T[11]=0,T[12]=(L+P)*q,T[13]=(F+I)*G,T[14]=D*z,T[15]=1,T}static lookAt(T,L,P,I){const F=L[0],D=L[1],V=L[2],q=I[0],G=I[1],z=I[2],Q=P[0],J=P[1],tt=P[2];if(Math.abs(F-Q)<N&&Math.abs(D-J)<N&&Math.abs(V-tt)<N)return ki.identity(T);let yt=F-Q,At=D-J,gt=V-tt,Et=1/Math.sqrt(yt*yt+At*At+gt*gt);yt*=Et,At*=Et,gt*=Et;let kt=G*gt-z*At,ne=z*yt-q*gt,Se=q*At-G*yt;Et=Math.sqrt(kt*kt+ne*ne+Se*Se),Et?(Et=1/Et,kt*=Et,ne*=Et,Se*=Et):(kt=0,ne=0,Se=0);let Ht=At*Se-gt*ne,Le=gt*kt-yt*Se,ee=yt*ne-At*kt;return Et=Math.sqrt(Ht*Ht+Le*Le+ee*ee),Et?(Et=1/Et,Ht*=Et,Le*=Et,ee*=Et):(Ht=0,Le=0,ee=0),T[0]=kt,T[1]=Ht,T[2]=yt,T[3]=0,T[4]=ne,T[5]=Le,T[6]=At,T[7]=0,T[8]=Se,T[9]=ee,T[10]=gt,T[11]=0,T[12]=-(kt*F+ne*D+Se*V),T[13]=-(Ht*F+Le*D+ee*V),T[14]=-(yt*F+At*D+gt*V),T[15]=1,T}static targetTo(T,L,P,I){const F=L[0],D=L[1],V=L[2],q=I[0],G=I[1],z=I[2];let Q=F-P[0],J=D-P[1],tt=V-P[2],yt=Q*Q+J*J+tt*tt;yt>0&&(yt=1/Math.sqrt(yt),Q*=yt,J*=yt,tt*=yt);let At=G*tt-z*J,gt=z*Q-q*tt,Et=q*J-G*Q;return yt=At*At+gt*gt+Et*Et,yt>0&&(yt=1/Math.sqrt(yt),At*=yt,gt*=yt,Et*=yt),T[0]=At,T[1]=gt,T[2]=Et,T[3]=0,T[4]=J*Et-tt*gt,T[5]=tt*At-Q*Et,T[6]=Q*gt-J*At,T[7]=0,T[8]=Q,T[9]=J,T[10]=tt,T[11]=0,T[12]=F,T[13]=D,T[14]=V,T[15]=1,T}static frob(T){return Math.sqrt(T[0]*T[0]+T[1]*T[1]+T[2]*T[2]+T[3]*T[3]+T[4]*T[4]+T[5]*T[5]+T[6]*T[6]+T[7]*T[7]+T[8]*T[8]+T[9]*T[9]+T[10]*T[10]+T[11]*T[11]+T[12]*T[12]+T[13]*T[13]+T[14]*T[14]+T[15]*T[15])}static add(T,L,P){return T[0]=L[0]+P[0],T[1]=L[1]+P[1],T[2]=L[2]+P[2],T[3]=L[3]+P[3],T[4]=L[4]+P[4],T[5]=L[5]+P[5],T[6]=L[6]+P[6],T[7]=L[7]+P[7],T[8]=L[8]+P[8],T[9]=L[9]+P[9],T[10]=L[10]+P[10],T[11]=L[11]+P[11],T[12]=L[12]+P[12],T[13]=L[13]+P[13],T[14]=L[14]+P[14],T[15]=L[15]+P[15],T}static subtract(T,L,P){return T[0]=L[0]-P[0],T[1]=L[1]-P[1],T[2]=L[2]-P[2],T[3]=L[3]-P[3],T[4]=L[4]-P[4],T[5]=L[5]-P[5],T[6]=L[6]-P[6],T[7]=L[7]-P[7],T[8]=L[8]-P[8],T[9]=L[9]-P[9],T[10]=L[10]-P[10],T[11]=L[11]-P[11],T[12]=L[12]-P[12],T[13]=L[13]-P[13],T[14]=L[14]-P[14],T[15]=L[15]-P[15],T}static sub(T,L,P){return T}static multiplyScalar(T,L,P){return T[0]=L[0]*P,T[1]=L[1]*P,T[2]=L[2]*P,T[3]=L[3]*P,T[4]=L[4]*P,T[5]=L[5]*P,T[6]=L[6]*P,T[7]=L[7]*P,T[8]=L[8]*P,T[9]=L[9]*P,T[10]=L[10]*P,T[11]=L[11]*P,T[12]=L[12]*P,T[13]=L[13]*P,T[14]=L[14]*P,T[15]=L[15]*P,T}static multiplyScalarAndAdd(T,L,P,I){return T[0]=L[0]+P[0]*I,T[1]=L[1]+P[1]*I,T[2]=L[2]+P[2]*I,T[3]=L[3]+P[3]*I,T[4]=L[4]+P[4]*I,T[5]=L[5]+P[5]*I,T[6]=L[6]+P[6]*I,T[7]=L[7]+P[7]*I,T[8]=L[8]+P[8]*I,T[9]=L[9]+P[9]*I,T[10]=L[10]+P[10]*I,T[11]=L[11]+P[11]*I,T[12]=L[12]+P[12]*I,T[13]=L[13]+P[13]*I,T[14]=L[14]+P[14]*I,T[15]=L[15]+P[15]*I,T}static exactEquals(T,L){return T[0]===L[0]&&T[1]===L[1]&&T[2]===L[2]&&T[3]===L[3]&&T[4]===L[4]&&T[5]===L[5]&&T[6]===L[6]&&T[7]===L[7]&&T[8]===L[8]&&T[9]===L[9]&&T[10]===L[10]&&T[11]===L[11]&&T[12]===L[12]&&T[13]===L[13]&&T[14]===L[14]&&T[15]===L[15]}static equals(T,L){const P=T[0],I=T[1],F=T[2],D=T[3],V=T[4],q=T[5],G=T[6],z=T[7],Q=T[8],J=T[9],tt=T[10],yt=T[11],At=T[12],gt=T[13],Et=T[14],kt=T[15],ne=L[0],Se=L[1],Ht=L[2],Le=L[3],ee=L[4],si=L[5],ci=L[6],di=L[7],ui=L[8],ei=L[9],bi=L[10],yi=L[11],gi=L[12],we=L[13],Ge=L[14],Te=L[15];return Math.abs(P-ne)<=N*Math.max(1,Math.abs(P),Math.abs(ne))&&Math.abs(I-Se)<=N*Math.max(1,Math.abs(I),Math.abs(Se))&&Math.abs(F-Ht)<=N*Math.max(1,Math.abs(F),Math.abs(Ht))&&Math.abs(D-Le)<=N*Math.max(1,Math.abs(D),Math.abs(Le))&&Math.abs(V-ee)<=N*Math.max(1,Math.abs(V),Math.abs(ee))&&Math.abs(q-si)<=N*Math.max(1,Math.abs(q),Math.abs(si))&&Math.abs(G-ci)<=N*Math.max(1,Math.abs(G),Math.abs(ci))&&Math.abs(z-di)<=N*Math.max(1,Math.abs(z),Math.abs(di))&&Math.abs(Q-ui)<=N*Math.max(1,Math.abs(Q),Math.abs(ui))&&Math.abs(J-ei)<=N*Math.max(1,Math.abs(J),Math.abs(ei))&&Math.abs(tt-bi)<=N*Math.max(1,Math.abs(tt),Math.abs(bi))&&Math.abs(yt-yi)<=N*Math.max(1,Math.abs(yt),Math.abs(yi))&&Math.abs(At-gi)<=N*Math.max(1,Math.abs(At),Math.abs(gi))&&Math.abs(gt-we)<=N*Math.max(1,Math.abs(gt),Math.abs(we))&&Math.abs(Et-Ge)<=N*Math.max(1,Math.abs(Et),Math.abs(Ge))&&Math.abs(kt-Te)<=N*Math.max(1,Math.abs(kt),Math.abs(Te))}static str(T){return`Mat4(${T.join(", ")})`}};f(B,"BYTE_LENGTH",16*Float32Array.BYTES_PER_ELEMENT);let _=B;const Y=new Float32Array(3);_.prototype.mul=_.prototype.multiply;_.sub=_.subtract;_.mul=_.multiply;_.frustum=_.frustumNO;_.perspective=_.perspectiveNO;_.ortho=_.orthoNO;const U=class qi extends Float32Array{constructor(...T){switch(T.length){case 3:super(T);break;case 2:super(T[0],T[1],3);break;case 1:{const L=T[0];typeof L=="number"?super([L,L,L]):super(L,0,3);break}default:super(3);break}}get x(){return this[0]}set x(T){this[0]=T}get y(){return this[1]}set y(T){this[1]=T}get z(){return this[2]}set z(T){this[2]=T}get r(){return this[0]}set r(T){this[0]=T}get g(){return this[1]}set g(T){this[1]=T}get b(){return this[2]}set b(T){this[2]=T}get magnitude(){const T=this[0],L=this[1],P=this[2];return Math.sqrt(T*T+L*L+P*P)}get mag(){return this.magnitude}get squaredMagnitude(){const T=this[0],L=this[1],P=this[2];return T*T+L*L+P*P}get sqrMag(){return this.squaredMagnitude}get str(){return qi.str(this)}copy(T){return this.set(T),this}add(T){return this[0]+=T[0],this[1]+=T[1],this[2]+=T[2],this}subtract(T){return this[0]-=T[0],this[1]-=T[1],this[2]-=T[2],this}sub(T){return this}multiply(T){return this[0]*=T[0],this[1]*=T[1],this[2]*=T[2],this}mul(T){return this}divide(T){return this[0]/=T[0],this[1]/=T[1],this[2]/=T[2],this}div(T){return this}scale(T){return this[0]*=T,this[1]*=T,this[2]*=T,this}scaleAndAdd(T,L){return this[0]+=T[0]*L,this[1]+=T[1]*L,this[2]+=T[2]*L,this}distance(T){return qi.distance(this,T)}dist(T){return 0}squaredDistance(T){return qi.squaredDistance(this,T)}sqrDist(T){return 0}negate(){return this[0]*=-1,this[1]*=-1,this[2]*=-1,this}invert(){return this[0]=1/this[0],this[1]=1/this[1],this[2]=1/this[2],this}abs(){return this[0]=Math.abs(this[0]),this[1]=Math.abs(this[1]),this[2]=Math.abs(this[2]),this}dot(T){return this[0]*T[0]+this[1]*T[1]+this[2]*T[2]}normalize(){return qi.normalize(this,this)}static create(){return new qi}static clone(T){return new qi(T)}static magnitude(T){let L=T[0],P=T[1],I=T[2];return Math.sqrt(L*L+P*P+I*I)}static mag(T){return 0}static length(T){return 0}static len(T){return 0}static fromValues(T,L,P){return new qi(T,L,P)}static copy(T,L){return T[0]=L[0],T[1]=L[1],T[2]=L[2],T}static set(T,L,P,I){return T[0]=L,T[1]=P,T[2]=I,T}static add(T,L,P){return T[0]=L[0]+P[0],T[1]=L[1]+P[1],T[2]=L[2]+P[2],T}static subtract(T,L,P){return T[0]=L[0]-P[0],T[1]=L[1]-P[1],T[2]=L[2]-P[2],T}static sub(T,L,P){return[0,0,0]}static multiply(T,L,P){return T[0]=L[0]*P[0],T[1]=L[1]*P[1],T[2]=L[2]*P[2],T}static mul(T,L,P){return[0,0,0]}static divide(T,L,P){return T[0]=L[0]/P[0],T[1]=L[1]/P[1],T[2]=L[2]/P[2],T}static div(T,L,P){return[0,0,0]}static ceil(T,L){return T[0]=Math.ceil(L[0]),T[1]=Math.ceil(L[1]),T[2]=Math.ceil(L[2]),T}static floor(T,L){return T[0]=Math.floor(L[0]),T[1]=Math.floor(L[1]),T[2]=Math.floor(L[2]),T}static min(T,L,P){return T[0]=Math.min(L[0],P[0]),T[1]=Math.min(L[1],P[1]),T[2]=Math.min(L[2],P[2]),T}static max(T,L,P){return T[0]=Math.max(L[0],P[0]),T[1]=Math.max(L[1],P[1]),T[2]=Math.max(L[2],P[2]),T}static scale(T,L,P){return T[0]=L[0]*P,T[1]=L[1]*P,T[2]=L[2]*P,T}static scaleAndAdd(T,L,P,I){return T[0]=L[0]+P[0]*I,T[1]=L[1]+P[1]*I,T[2]=L[2]+P[2]*I,T}static distance(T,L){const P=L[0]-T[0],I=L[1]-T[1],F=L[2]-T[2];return Math.sqrt(P*P+I*I+F*F)}static dist(T,L){return 0}static squaredDistance(T,L){const P=L[0]-T[0],I=L[1]-T[1],F=L[2]-T[2];return P*P+I*I+F*F}static sqrDist(T,L){return 0}static squaredLength(T){const L=T[0],P=T[1],I=T[2];return L*L+P*P+I*I}static sqrLen(T,L){return 0}static negate(T,L){return T[0]=-L[0],T[1]=-L[1],T[2]=-L[2],T}static inverse(T,L){return T[0]=1/L[0],T[1]=1/L[1],T[2]=1/L[2],T}static abs(T,L){return T[0]=Math.abs(L[0]),T[1]=Math.abs(L[1]),T[2]=Math.abs(L[2]),T}static normalize(T,L){const P=L[0],I=L[1],F=L[2];let D=P*P+I*I+F*F;return D>0&&(D=1/Math.sqrt(D)),T[0]=L[0]*D,T[1]=L[1]*D,T[2]=L[2]*D,T}static dot(T,L){return T[0]*L[0]+T[1]*L[1]+T[2]*L[2]}static cross(T,L,P){const I=L[0],F=L[1],D=L[2],V=P[0],q=P[1],G=P[2];return T[0]=F*G-D*q,T[1]=D*V-I*G,T[2]=I*q-F*V,T}static lerp(T,L,P,I){const F=L[0],D=L[1],V=L[2];return T[0]=F+I*(P[0]-F),T[1]=D+I*(P[1]-D),T[2]=V+I*(P[2]-V),T}static slerp(T,L,P,I){const F=Math.acos(Math.min(Math.max(qi.dot(L,P),-1),1)),D=Math.sin(F),V=Math.sin((1-I)*F)/D,q=Math.sin(I*F)/D;return T[0]=V*L[0]+q*P[0],T[1]=V*L[1]+q*P[1],T[2]=V*L[2]+q*P[2],T}static hermite(T,L,P,I,F,D){const V=D*D,q=V*(2*D-3)+1,G=V*(D-2)+D,z=V*(D-1),Q=V*(3-2*D);return T[0]=L[0]*q+P[0]*G+I[0]*z+F[0]*Q,T[1]=L[1]*q+P[1]*G+I[1]*z+F[1]*Q,T[2]=L[2]*q+P[2]*G+I[2]*z+F[2]*Q,T}static bezier(T,L,P,I,F,D){const V=1-D,q=V*V,G=D*D,z=q*V,Q=3*D*q,J=3*G*V,tt=G*D;return T[0]=L[0]*z+P[0]*Q+I[0]*J+F[0]*tt,T[1]=L[1]*z+P[1]*Q+I[1]*J+F[1]*tt,T[2]=L[2]*z+P[2]*Q+I[2]*J+F[2]*tt,T}static transformMat4(T,L,P){const I=L[0],F=L[1],D=L[2],V=P[3]*I+P[7]*F+P[11]*D+P[15]||1;return T[0]=(P[0]*I+P[4]*F+P[8]*D+P[12])/V,T[1]=(P[1]*I+P[5]*F+P[9]*D+P[13])/V,T[2]=(P[2]*I+P[6]*F+P[10]*D+P[14])/V,T}static transformMat3(T,L,P){let I=L[0],F=L[1],D=L[2];return T[0]=I*P[0]+F*P[3]+D*P[6],T[1]=I*P[1]+F*P[4]+D*P[7],T[2]=I*P[2]+F*P[5]+D*P[8],T}static transformQuat(T,L,P){const I=P[0],F=P[1],D=P[2],V=P[3]*2,q=L[0],G=L[1],z=L[2],Q=F*z-D*G,J=D*q-I*z,tt=I*G-F*q,yt=(F*tt-D*J)*2,At=(D*Q-I*tt)*2,gt=(I*J-F*Q)*2;return T[0]=q+Q*V+yt,T[1]=G+J*V+At,T[2]=z+tt*V+gt,T}static rotateX(T,L,P,I){const F=P[1],D=P[2],V=L[1]-F,q=L[2]-D;return T[0]=L[0],T[1]=V*Math.cos(I)-q*Math.sin(I)+F,T[2]=V*Math.sin(I)+q*Math.cos(I)+D,T}static rotateY(T,L,P,I){const F=P[0],D=P[2],V=L[0]-F,q=L[2]-D;return T[0]=q*Math.sin(I)+V*Math.cos(I)+F,T[1]=L[1],T[2]=q*Math.cos(I)-V*Math.sin(I)+D,T}static rotateZ(T,L,P,I){const F=P[0],D=P[1],V=L[0]-F,q=L[1]-D;return T[0]=V*Math.cos(I)-q*Math.sin(I)+F,T[1]=V*Math.sin(I)+q*Math.cos(I)+D,T[2]=P[2],T}static angle(T,L){const P=T[0],I=T[1],F=T[2],D=L[0],V=L[1],q=L[2],G=Math.sqrt((P*P+I*I+F*F)*(D*D+V*V+q*q)),z=G&&qi.dot(T,L)/G;return Math.acos(Math.min(Math.max(z,-1),1))}static zero(T){return T[0]=0,T[1]=0,T[2]=0,T}static str(T){return`Vec3(${T.join(", ")})`}static exactEquals(T,L){return T[0]===L[0]&&T[1]===L[1]&&T[2]===L[2]}static equals(T,L){const P=T[0],I=T[1],F=T[2],D=L[0],V=L[1],q=L[2];return Math.abs(P-D)<=N*Math.max(1,Math.abs(P),Math.abs(D))&&Math.abs(I-V)<=N*Math.max(1,Math.abs(I),Math.abs(V))&&Math.abs(F-q)<=N*Math.max(1,Math.abs(F),Math.abs(q))}};f(U,"BYTE_LENGTH",3*Float32Array.BYTES_PER_ELEMENT);let O=U;O.prototype.sub=O.prototype.subtract;O.prototype.mul=O.prototype.multiply;O.prototype.div=O.prototype.divide;O.prototype.dist=O.prototype.distance;O.prototype.sqrDist=O.prototype.squaredDistance;O.sub=O.subtract;O.mul=O.multiply;O.div=O.divide;O.dist=O.distance;O.sqrDist=O.squaredDistance;O.sqrLen=O.squaredLength;O.mag=O.magnitude;O.length=O.magnitude;O.len=O.magnitude;const X=class Hi extends Float32Array{constructor(...T){switch(T.length){case 4:super(T);break;case 2:super(T[0],T[1],4);break;case 1:{const L=T[0];typeof L=="number"?super([L,L,L,L]):super(L,0,4);break}default:super(4);break}}get x(){return this[0]}set x(T){this[0]=T}get y(){return this[1]}set y(T){this[1]=T}get z(){return this[2]}set z(T){this[2]=T}get w(){return this[3]}set w(T){this[3]=T}get r(){return this[0]}set r(T){this[0]=T}get g(){return this[1]}set g(T){this[1]=T}get b(){return this[2]}set b(T){this[2]=T}get a(){return this[3]}set a(T){this[3]=T}get magnitude(){const T=this[0],L=this[1],P=this[2],I=this[3];return Math.sqrt(T*T+L*L+P*P+I*I)}get mag(){return this.magnitude}get str(){return Hi.str(this)}copy(T){return super.set(T),this}add(T){return this[0]+=T[0],this[1]+=T[1],this[2]+=T[2],this[3]+=T[3],this}subtract(T){return this[0]-=T[0],this[1]-=T[1],this[2]-=T[2],this[3]-=T[3],this}sub(T){return this}multiply(T){return this[0]*=T[0],this[1]*=T[1],this[2]*=T[2],this[3]*=T[3],this}mul(T){return this}divide(T){return this[0]/=T[0],this[1]/=T[1],this[2]/=T[2],this[3]/=T[3],this}div(T){return this}scale(T){return this[0]*=T,this[1]*=T,this[2]*=T,this[3]*=T,this}scaleAndAdd(T,L){return this[0]+=T[0]*L,this[1]+=T[1]*L,this[2]+=T[2]*L,this[3]+=T[3]*L,this}distance(T){return Hi.distance(this,T)}dist(T){return 0}squaredDistance(T){return Hi.squaredDistance(this,T)}sqrDist(T){return 0}negate(){return this[0]*=-1,this[1]*=-1,this[2]*=-1,this[3]*=-1,this}invert(){return this[0]=1/this[0],this[1]=1/this[1],this[2]=1/this[2],this[3]=1/this[3],this}abs(){return this[0]=Math.abs(this[0]),this[1]=Math.abs(this[1]),this[2]=Math.abs(this[2]),this[3]=Math.abs(this[3]),this}dot(T){return this[0]*T[0]+this[1]*T[1]+this[2]*T[2]+this[3]*T[3]}normalize(){return Hi.normalize(this,this)}static create(){return new Hi}static clone(T){return new Hi(T)}static fromValues(T,L,P,I){return new Hi(T,L,P,I)}static copy(T,L){return T[0]=L[0],T[1]=L[1],T[2]=L[2],T[3]=L[3],T}static set(T,L,P,I,F){return T[0]=L,T[1]=P,T[2]=I,T[3]=F,T}static add(T,L,P){return T[0]=L[0]+P[0],T[1]=L[1]+P[1],T[2]=L[2]+P[2],T[3]=L[3]+P[3],T}static subtract(T,L,P){return T[0]=L[0]-P[0],T[1]=L[1]-P[1],T[2]=L[2]-P[2],T[3]=L[3]-P[3],T}static sub(T,L,P){return T}static multiply(T,L,P){return T[0]=L[0]*P[0],T[1]=L[1]*P[1],T[2]=L[2]*P[2],T[3]=L[3]*P[3],T}static mul(T,L,P){return T}static divide(T,L,P){return T[0]=L[0]/P[0],T[1]=L[1]/P[1],T[2]=L[2]/P[2],T[3]=L[3]/P[3],T}static div(T,L,P){return T}static ceil(T,L){return T[0]=Math.ceil(L[0]),T[1]=Math.ceil(L[1]),T[2]=Math.ceil(L[2]),T[3]=Math.ceil(L[3]),T}static floor(T,L){return T[0]=Math.floor(L[0]),T[1]=Math.floor(L[1]),T[2]=Math.floor(L[2]),T[3]=Math.floor(L[3]),T}static min(T,L,P){return T[0]=Math.min(L[0],P[0]),T[1]=Math.min(L[1],P[1]),T[2]=Math.min(L[2],P[2]),T[3]=Math.min(L[3],P[3]),T}static max(T,L,P){return T[0]=Math.max(L[0],P[0]),T[1]=Math.max(L[1],P[1]),T[2]=Math.max(L[2],P[2]),T[3]=Math.max(L[3],P[3]),T}static round(T,L){return T[0]=Math.round(L[0]),T[1]=Math.round(L[1]),T[2]=Math.round(L[2]),T[3]=Math.round(L[3]),T}static scale(T,L,P){return T[0]=L[0]*P,T[1]=L[1]*P,T[2]=L[2]*P,T[3]=L[3]*P,T}static scaleAndAdd(T,L,P,I){return T[0]=L[0]+P[0]*I,T[1]=L[1]+P[1]*I,T[2]=L[2]+P[2]*I,T[3]=L[3]+P[3]*I,T}static distance(T,L){const P=L[0]-T[0],I=L[1]-T[1],F=L[2]-T[2],D=L[3]-T[3];return Math.hypot(P,I,F,D)}static dist(T,L){return 0}static squaredDistance(T,L){const P=L[0]-T[0],I=L[1]-T[1],F=L[2]-T[2],D=L[3]-T[3];return P*P+I*I+F*F+D*D}static sqrDist(T,L){return 0}static magnitude(T){const L=T[0],P=T[1],I=T[2],F=T[3];return Math.sqrt(L*L+P*P+I*I+F*F)}static mag(T){return 0}static length(T){return 0}static len(T){return 0}static squaredLength(T){const L=T[0],P=T[1],I=T[2],F=T[3];return L*L+P*P+I*I+F*F}static sqrLen(T){return 0}static negate(T,L){return T[0]=-L[0],T[1]=-L[1],T[2]=-L[2],T[3]=-L[3],T}static inverse(T,L){return T[0]=1/L[0],T[1]=1/L[1],T[2]=1/L[2],T[3]=1/L[3],T}static abs(T,L){return T[0]=Math.abs(L[0]),T[1]=Math.abs(L[1]),T[2]=Math.abs(L[2]),T[3]=Math.abs(L[3]),T}static normalize(T,L){const P=L[0],I=L[1],F=L[2],D=L[3];let V=P*P+I*I+F*F+D*D;return V>0&&(V=1/Math.sqrt(V)),T[0]=P*V,T[1]=I*V,T[2]=F*V,T[3]=D*V,T}static dot(T,L){return T[0]*L[0]+T[1]*L[1]+T[2]*L[2]+T[3]*L[3]}static cross(T,L,P,I){const F=P[0]*I[1]-P[1]*I[0],D=P[0]*I[2]-P[2]*I[0],V=P[0]*I[3]-P[3]*I[0],q=P[1]*I[2]-P[2]*I[1],G=P[1]*I[3]-P[3]*I[1],z=P[2]*I[3]-P[3]*I[2],Q=L[0],J=L[1],tt=L[2],yt=L[3];return T[0]=J*z-tt*G+yt*q,T[1]=-(Q*z)+tt*V-yt*D,T[2]=Q*G-J*V+yt*F,T[3]=-(Q*q)+J*D-tt*F,T}static lerp(T,L,P,I){const F=L[0],D=L[1],V=L[2],q=L[3];return T[0]=F+I*(P[0]-F),T[1]=D+I*(P[1]-D),T[2]=V+I*(P[2]-V),T[3]=q+I*(P[3]-q),T}static transformMat4(T,L,P){const I=L[0],F=L[1],D=L[2],V=L[3];return T[0]=P[0]*I+P[4]*F+P[8]*D+P[12]*V,T[1]=P[1]*I+P[5]*F+P[9]*D+P[13]*V,T[2]=P[2]*I+P[6]*F+P[10]*D+P[14]*V,T[3]=P[3]*I+P[7]*F+P[11]*D+P[15]*V,T}static transformQuat(T,L,P){const I=L[0],F=L[1],D=L[2],V=P[0],q=P[1],G=P[2],z=P[3],Q=z*I+q*D-G*F,J=z*F+G*I-V*D,tt=z*D+V*F-q*I,yt=-V*I-q*F-G*D;return T[0]=Q*z+yt*-V+J*-G-tt*-q,T[1]=J*z+yt*-q+tt*-V-Q*-G,T[2]=tt*z+yt*-G+Q*-q-J*-V,T[3]=L[3],T}static zero(T){return T[0]=0,T[1]=0,T[2]=0,T[3]=0,T}static str(T){return`Vec4(${T.join(", ")})`}static exactEquals(T,L){return T[0]===L[0]&&T[1]===L[1]&&T[2]===L[2]&&T[3]===L[3]}static equals(T,L){const P=T[0],I=T[1],F=T[2],D=T[3],V=L[0],q=L[1],G=L[2],z=L[3];return Math.abs(P-V)<=N*Math.max(1,Math.abs(P),Math.abs(V))&&Math.abs(I-q)<=N*Math.max(1,Math.abs(I),Math.abs(q))&&Math.abs(F-G)<=N*Math.max(1,Math.abs(F),Math.abs(G))&&Math.abs(D-z)<=N*Math.max(1,Math.abs(D),Math.abs(z))}};f(X,"BYTE_LENGTH",4*Float32Array.BYTES_PER_ELEMENT);let A=X;A.prototype.sub=A.prototype.subtract;A.prototype.mul=A.prototype.multiply;A.prototype.div=A.prototype.divide;A.prototype.dist=A.prototype.distance;A.prototype.sqrDist=A.prototype.squaredDistance;A.sub=A.subtract;A.mul=A.multiply;A.div=A.divide;A.dist=A.distance;A.sqrDist=A.squaredDistance;A.sqrLen=A.squaredLength;A.mag=A.magnitude;A.length=A.magnitude;A.len=A.magnitude;const Z=class Wi extends Float32Array{constructor(...T){switch(T.length){case 2:{const L=T[0];typeof L=="number"?super([L,T[1]]):super(L,T[1],2);break}case 1:{const L=T[0];typeof L=="number"?super([L,L]):super(L,0,2);break}default:super(2);break}}get x(){return this[0]}set x(T){this[0]=T}get y(){return this[1]}set y(T){this[1]=T}get r(){return this[0]}set r(T){this[0]=T}get g(){return this[1]}set g(T){this[1]=T}get magnitude(){return Math.hypot(this[0],this[1])}get mag(){return this.magnitude}get squaredMagnitude(){const T=this[0],L=this[1];return T*T+L*L}get sqrMag(){return this.squaredMagnitude}get str(){return Wi.str(this)}copy(T){return this.set(T),this}add(T){return this[0]+=T[0],this[1]+=T[1],this}subtract(T){return this[0]-=T[0],this[1]-=T[1],this}sub(T){return this}multiply(T){return this[0]*=T[0],this[1]*=T[1],this}mul(T){return this}divide(T){return this[0]/=T[0],this[1]/=T[1],this}div(T){return this}scale(T){return this[0]*=T,this[1]*=T,this}scaleAndAdd(T,L){return this[0]+=T[0]*L,this[1]+=T[1]*L,this}distance(T){return Wi.distance(this,T)}dist(T){return 0}squaredDistance(T){return Wi.squaredDistance(this,T)}sqrDist(T){return 0}negate(){return this[0]*=-1,this[1]*=-1,this}invert(){return this[0]=1/this[0],this[1]=1/this[1],this}abs(){return this[0]=Math.abs(this[0]),this[1]=Math.abs(this[1]),this}dot(T){return this[0]*T[0]+this[1]*T[1]}normalize(){return Wi.normalize(this,this)}static create(){return new Wi}static clone(T){return new Wi(T)}static fromValues(T,L){return new Wi(T,L)}static copy(T,L){return T[0]=L[0],T[1]=L[1],T}static set(T,L,P){return T[0]=L,T[1]=P,T}static add(T,L,P){return T[0]=L[0]+P[0],T[1]=L[1]+P[1],T}static subtract(T,L,P){return T[0]=L[0]-P[0],T[1]=L[1]-P[1],T}static sub(T,L,P){return[0,0]}static multiply(T,L,P){return T[0]=L[0]*P[0],T[1]=L[1]*P[1],T}static mul(T,L,P){return[0,0]}static divide(T,L,P){return T[0]=L[0]/P[0],T[1]=L[1]/P[1],T}static div(T,L,P){return[0,0]}static ceil(T,L){return T[0]=Math.ceil(L[0]),T[1]=Math.ceil(L[1]),T}static floor(T,L){return T[0]=Math.floor(L[0]),T[1]=Math.floor(L[1]),T}static min(T,L,P){return T[0]=Math.min(L[0],P[0]),T[1]=Math.min(L[1],P[1]),T}static max(T,L,P){return T[0]=Math.max(L[0],P[0]),T[1]=Math.max(L[1],P[1]),T}static round(T,L){return T[0]=Math.round(L[0]),T[1]=Math.round(L[1]),T}static scale(T,L,P){return T[0]=L[0]*P,T[1]=L[1]*P,T}static scaleAndAdd(T,L,P,I){return T[0]=L[0]+P[0]*I,T[1]=L[1]+P[1]*I,T}static distance(T,L){return Math.hypot(L[0]-T[0],L[1]-T[1])}static dist(T,L){return 0}static squaredDistance(T,L){const P=L[0]-T[0],I=L[1]-T[1];return P*P+I*I}static sqrDist(T,L){return 0}static magnitude(T){let L=T[0],P=T[1];return Math.sqrt(L*L+P*P)}static mag(T){return 0}static length(T){return 0}static len(T){return 0}static squaredLength(T){const L=T[0],P=T[1];return L*L+P*P}static sqrLen(T,L){return 0}static negate(T,L){return T[0]=-L[0],T[1]=-L[1],T}static inverse(T,L){return T[0]=1/L[0],T[1]=1/L[1],T}static abs(T,L){return T[0]=Math.abs(L[0]),T[1]=Math.abs(L[1]),T}static normalize(T,L){const P=L[0],I=L[1];let F=P*P+I*I;return F>0&&(F=1/Math.sqrt(F)),T[0]=L[0]*F,T[1]=L[1]*F,T}static dot(T,L){return T[0]*L[0]+T[1]*L[1]}static cross(T,L,P){const I=L[0]*P[1]-L[1]*P[0];return T[0]=T[1]=0,T[2]=I,T}static lerp(T,L,P,I){const F=L[0],D=L[1];return T[0]=F+I*(P[0]-F),T[1]=D+I*(P[1]-D),T}static transformMat2(T,L,P){const I=L[0],F=L[1];return T[0]=P[0]*I+P[2]*F,T[1]=P[1]*I+P[3]*F,T}static transformMat2d(T,L,P){const I=L[0],F=L[1];return T[0]=P[0]*I+P[2]*F+P[4],T[1]=P[1]*I+P[3]*F+P[5],T}static transformMat3(T,L,P){const I=L[0],F=L[1];return T[0]=P[0]*I+P[3]*F+P[6],T[1]=P[1]*I+P[4]*F+P[7],T}static transformMat4(T,L,P){const I=L[0],F=L[1];return T[0]=P[0]*I+P[4]*F+P[12],T[1]=P[1]*I+P[5]*F+P[13],T}static rotate(T,L,P,I){const F=L[0]-P[0],D=L[1]-P[1],V=Math.sin(I),q=Math.cos(I);return T[0]=F*q-D*V+P[0],T[1]=F*V+D*q+P[1],T}static angle(T,L){const P=T[0],I=T[1],F=L[0],D=L[1],V=Math.sqrt(P*P+I*I)*Math.sqrt(F*F+D*D),q=V&&(P*F+I*D)/V;return Math.acos(Math.min(Math.max(q,-1),1))}static zero(T){return T[0]=0,T[1]=0,T}static exactEquals(T,L){return T[0]===L[0]&&T[1]===L[1]}static equals(T,L){const P=T[0],I=T[1],F=L[0],D=L[1];return Math.abs(P-F)<=N*Math.max(1,Math.abs(P),Math.abs(F))&&Math.abs(I-D)<=N*Math.max(1,Math.abs(I),Math.abs(D))}static str(T){return`Vec2(${T.join(", ")})`}};f(Z,"BYTE_LENGTH",2*Float32Array.BYTES_PER_ELEMENT);let C=Z;C.prototype.sub=C.prototype.subtract;C.prototype.mul=C.prototype.multiply;C.prototype.div=C.prototype.divide;C.prototype.dist=C.prototype.distance;C.prototype.sqrDist=C.prototype.squaredDistance;C.sub=C.subtract;C.mul=C.multiply;C.div=C.divide;C.dist=C.distance;C.sqrDist=C.squaredDistance;C.sqrLen=C.squaredLength;C.mag=C.magnitude;C.length=C.magnitude;C.len=C.magnitude;function ve(R){return new Promise((T,L)=>{const P=document.createElement("img");P.onload=()=>T(P),P.onerror=L,P.src=R,P.crossOrigin="anonymous",P.loading="eager"})}function Pe(R){return new Promise((T,L)=>{const P=document.createElement("video");let I=!1,F=!1,D=!1;P.addEventListener("playing",()=>{I=!0,V()},!0),P.addEventListener("timeupdate",()=>{F=!0,V()},!0),P.addEventListener("error",q=>{D=!0,L(q)},!0);function V(){I&&F&&!D&&T(P)}P.src=R,P.playsInline=!0,P.crossOrigin="anonymous",P.autoplay=!0,P.loop=!0,P.muted=!0,P.play()})}function ae(R,T=!1){return T?Pe(R):ve(R)}function oe(R){return new Promise((T,L)=>{(R instanceof HTMLImageElement?R.complete:R.readyState>=3)?T(R):(R.onload=()=>T(R),R.onerror=L)})}function ze(R,T,L){const P=R.data,I=R.width,F=R.height;let D,V,q,G,z,Q,J,tt,yt,At,gt,Et,kt;const ne=I-1,Se=F-1,Ht=T+1,Le=T+Ht,ee=T+1,si=T+ee,ci=1/(Le*si),di=[],ui=[],ei=[],bi=[],yi=[],gi=[];for(;L-- >0;){for(kt=Et=0,Q=0;Q<F;Q++){for(D=P[kt]*Ht,V=P[kt+1]*Ht,q=P[kt+2]*Ht,G=P[kt+3]*Ht,J=1;J<=T;J++)tt=kt+((J>ne?ne:J)<<2),D+=P[tt++],V+=P[tt++],q+=P[tt++],G+=P[tt];for(z=0;z<I;z++)di[Et]=D,ui[Et]=V,ei[Et]=q,bi[Et]=G,Q===0&&(yi[z]=Math.min(z+Ht,ne)<<2,gi[z]=Math.max(z-T,0)<<2),yt=kt+yi[z],At=kt+gi[z],D+=P[yt++]-P[At++],V+=P[yt++]-P[At++],q+=P[yt++]-P[At++],G+=P[yt]-P[At],Et++;kt+=I<<2}for(z=0;z<I;z++){for(gt=z,D=di[gt]*ee,V=ui[gt]*ee,q=ei[gt]*ee,G=bi[gt]*ee,J=1;J<=T;J++)gt+=J>Se?0:I,D+=di[gt],V+=ui[gt],q+=ei[gt],G+=bi[gt];for(Et=z<<2,Q=0;Q<F;Q++)P[Et]=D*ci+.5|0,P[Et+1]=V*ci+.5|0,P[Et+2]=q*ci+.5|0,P[Et+3]=G*ci+.5|0,z===0&&(yi[Q]=Math.min(Q+ee,Se)*I,gi[Q]=Math.max(Q-T,0)*I),yt=z+yi[Q],At=z+gi[Q],D+=di[yt]-di[At],V+=ui[yt]-ui[At],q+=ei[yt]-ei[At],G+=bi[yt]-bi[At],Et+=I<<2}}}function Ie(R,T){const L=R.data;for(let P=0;P<L.length;P+=4){const I=L[P],F=L[P+1],D=L[P+2],V=L[P+3],q=I*.3+F*.59+D*.11;L[P]=q*(1-T)+I*T,L[P+1]=q*(1-T)+F*T,L[P+2]=q*(1-T)+D*T,L[P+3]=V}}function ke(R,T){const L=R.data;for(let P=0;P<L.length;P+=4){const I=L[P],F=L[P+1],D=L[P+2],V=L[P+3];L[P]=I*T,L[P+1]=F*T,L[P+2]=D*T,L[P+3]=V}}function Yt(R,T){const L=R.data;for(let P=0;P<L.length;P+=4){const I=L[P],F=L[P+1],D=L[P+2],V=L[P+3];L[P]=(I-128)*T+128,L[P+1]=(F-128)*T+128,L[P+2]=(D-128)*T+128,L[P+3]=V}}const E=(R,T,L,P,I=0,F=0,D=1,V=1)=>Object.freeze({cx:R,cy:T,x:L,y:P,ur:I,vr:F,up:D,vp:V}),pt=(R,T,L)=>Object.freeze({width:R,height:T,conf:L}),jt=[pt(5,5,[E(0,0,-1,-1,0,0,1,1),E(1,0,-.5,-1,0,0,1,1),E(2,0,0,-1,0,0,1,1),E(3,0,.5,-1,0,0,1,1),E(4,0,1,-1,0,0,1,1),E(0,1,-1,-.5,0,0,1,1),E(1,1,-.5,-.5,0,0,1,1),E(2,1,-.0052029684413368305,-.6131420587090777,0,0,1,1),E(3,1,.5884227308309977,-.3990805107556692,0,0,1,1),E(4,1,1,-.5,0,0,1,1),E(0,2,-1,0,0,0,1,1),E(1,2,-.4210024670505933,-.11895058380429502,0,0,1,1),E(2,2,-.1019613423315412,-.023812118047224606,0,-47,.629,.849),E(3,2,.40275125660925437,-.06345314544600389,0,0,1,1),E(4,2,1,0,0,0,1,1),E(0,3,-1,.5,0,0,1,1),E(1,3,.06801958477287173,.5205913248960121,-31,-45,1,1),E(2,3,.21446469120128908,.29331610114301043,6,-56,.566,1.321),E(3,3,.5,.5,0,0,1,1),E(4,3,1,.5,0,0,1,1),E(0,4,-1,1,0,0,1,1),E(1,4,-.31378372841550195,1,0,0,1,1),E(2,4,.26153633255328046,1,0,0,1,1),E(3,4,.5,1,0,0,1,1),E(4,4,1,1,0,0,1,1)]),pt(4,4,[E(0,0,-1,-1,0,0,1,1),E(1,0,-.33333333333333337,-1,0,0,1,1),E(2,0,.33333333333333326,-1,0,0,1,1),E(3,0,1,-1,0,0,1,1),E(0,1,-1,-.04495399932657351,0,0,1,1),E(1,1,-.24056117520129328,-.22465999020104,0,0,1,1),E(2,1,.334758885767489,-.00531297192779423,0,0,1,1),E(3,1,.9989920470678106,-.3382976020775408,8,0,.566,1.792),E(0,2,-1,.33333333333333326,0,0,1,1),E(1,2,-.3425497314639411,-27501607956947893e-21,0,0,1,1),E(2,2,.3321437945812673,.1981776353859399,0,0,1,1),E(3,2,1,.0766118180296832,0,0,1,1),E(0,3,-1,1,0,0,1,1),E(1,3,-.33333333333333337,1,0,0,1,1),E(2,3,.33333333333333326,1,0,0,1,1),E(3,3,1,1,0,0,1,1)]),pt(4,4,[E(0,0,-1,-1,0,0,1,2.075),E(1,0,-.33333333333333337,-1,0,0,1,1),E(2,0,.33333333333333326,-1,0,0,1,1),E(3,0,1,-1,0,0,1,1),E(0,1,-1,-.4545779491139603,0,0,1,1),E(1,1,-.33333333333333337,-.33333333333333337,0,0,1,1),E(2,1,.0889403142626457,-.6025711180694033,-32,45,1,1),E(3,1,1,-.33333333333333337,0,0,1,1),E(0,2,-1,-.07402408608567845,1,0,1,.094),E(1,2,-.2719422694359541,.09775369930903222,25,-18,1.321,0),E(2,2,.19877414408395877,.4307383294587789,48,-40,.755,.975),E(3,2,1,.33333333333333326,-37,0,1,1),E(0,3,-1,1,0,0,1,1),E(1,3,-.33333333333333337,1,0,0,1,1),E(2,3,.5125850864305672,1,-20,-18,0,1.604),E(3,3,1,1,0,0,1,1)]),pt(5,5,[E(0,0,-1,-1,0,0,1,1),E(1,0,-.4501953125,-1,0,55,1,2.075),E(2,0,.1953125,-1,0,0,1,1),E(3,0,.4580078125,-1,0,-25,1,1),E(4,0,1,-1,0,0,1,1),E(0,1,-1,-.2514475377525607,-16,0,2.327,.943),E(1,1,-.55859375,-.6609325945787148,47,0,2.358,.377),E(2,1,.232421875,-.5244375756366635,-66,-25,1.855,1.164),E(3,1,.685546875,-.3753706470552125,0,0,1,1),E(4,1,1,-.6699125300354287,0,0,1,1),E(0,2,-1,.035910396862284255,0,0,1,1),E(1,2,-.4921875,.005378616309457018,90,23,1,1.981),E(2,2,.021484375,-.1365043639066228,0,42,1,1),E(3,2,.4765625,.05925822904974043,-30,0,1.95,.44),E(4,2,1,.251428847823418,0,0,1,1),E(0,3,-1,.6968336464764276,-68,0,1,.786),E(1,3,-.6904296875,.5890744209958608,-68,0,1,1),E(2,3,.1845703125,.3879238667654693,61,0,1,1),E(3,3,.60546875,.4633553246018661,-47,-59,.849,1.73),E(4,3,1,.6214021886400309,-33,0,.377,1.604),E(0,4,-1,1,0,0,1,1),E(1,4,-.5,1,0,-73,1,1),E(2,4,-.3271484375,1,0,-24,.314,2.704),E(3,4,.5,1,0,0,1,1),E(4,4,1,1,0,0,1,1)])],j=(R,T)=>Math.random()*(T-R)+R;function De(R,T,L){return Math.min(Math.max(R,T),L)}function Fe(R,T,L){const P=De((L-R)/(T-R),0,1);return P*P*(3-2*P)}function Ae(R,T,L,P=2,I=.5,F=.1){let D=[],V=I;for(let z=0;z<L;z++){D[z]=[];for(let Q=0;Q<T;Q++)D[z][Q]=R[z*T+Q]}const q=[[1,2,1],[2,4,2],[1,2,1]],G=16;for(let z=0;z<P;z++){const Q=[];for(let J=0;J<L;J++){Q[J]=[];for(let tt=0;tt<T;tt++){if(tt===0||tt===T-1||J===0||J===L-1){Q[J][tt]=D[J][tt];continue}let yt=0,At=0,gt=0,Et=0,kt=0,ne=0;for(let Ge=-1;Ge<=1;Ge++)for(let Te=-1;Te<=1;Te++){const ri=q[Ge+1][Te+1],ti=D[J+Ge][tt+Te];yt+=ti.x*ri,At+=ti.y*ri,gt+=ti.ur*ri,Et+=ti.vr*ri,kt+=ti.up*ri,ne+=ti.vp*ri}const Se=yt/G,Ht=At/G,Le=gt/G,ee=Et/G,si=kt/G,ci=ne/G,di=D[J][tt],ui=di.x*(1-V)+Se*V,ei=di.y*(1-V)+Ht*V,bi=di.ur*(1-V)+Le*V,yi=di.vr*(1-V)+ee*V,gi=di.up*(1-V)+si*V,we=di.vp*(1-V)+ci*V;Q[J][tt]=E(tt,J,ui,ei,bi,yi,gi,we)}}D=Q,V=Math.min(1,Math.max(V+F,0))}for(let z=0;z<L;z++)for(let Q=0;Q<T;Q++)R[z*T+Q]=D[z][Q]}function Mt(R,T){return _e(Math.sin(R*12.9898+T*78.233)*43758.5453)}function _e(R){return R-Math.floor(R)}function Re(R,T){const L=Math.floor(R),P=Math.floor(T),I=L+1,F=P+1,D=R-L,V=T-P,q=D*D*(3-2*D),G=V*V*(3-2*V),z=Mt(L,P),Q=Mt(I,P),J=Mt(L,F),tt=Mt(I,F),yt=z*(1-q)+Q*q,At=J*(1-q)+tt*q;return yt*(1-G)+At*G}function Ce(R,T,L,P=.001){const I=R(T+P,L),F=R(T-P,L),D=R(T,L+P),V=R(T,L-P),q=(I-F)/(2*P),G=(D-V)/(2*P),z=Math.sqrt(q*q+G*G)||1;return[q/z,G/z]}function Oe(R,T,L=j(.4,.6),P=j(.3,.6),I=.8,F=Math.floor(j(3,5)),D=j(.2,.3),V=j(-.1,-.05)){const q=R,G=T,z=[],Q=2/(q-1),J=2/(G-1);for(let tt=0;tt<G;tt++)for(let yt=0;yt<q;yt++){const At=yt/(q-1)*2-1,gt=tt/(G-1)*2-1,Et=yt===0||yt===q-1||tt===0||tt===G-1,kt=Et?0:j(-L*Q,L*Q),ne=Et?0:j(-L*J,L*J);let Se=At+kt,Ht=gt+ne;const Le=Et?0:j(-60,60),ee=Et?0:j(-60,60),si=Et?1:j(.8,1.2),ci=Et?1:j(.8,1.2);if(!Et){const di=(At+1)/2,ui=(gt+1)/2,[ei,bi]=Ce(Re,di,ui,.001);let yi=ei*P,gi=bi*P;const we=Math.min(di,1-di,ui,1-ui),Ge=Fe(0,1,we);yi*=Ge,gi*=Ge,Se=Se*(1-I)+(Se+yi)*I,Ht=Ht*(1-I)+(Ht+gi)*I}z.push(E(yt,tt,Se,Ht,Le,ee,si,ci))}return Ae(z,q,G,F,D,V),pt(q,G,z)}const Ne=`precision highp float;\r
\r
varying vec3 v_color;\r
varying vec2 v_uv;\r
uniform sampler2D u_texture;\r
uniform float u_time;\r
uniform float u_volume;\r
uniform float u_alpha;\r
\r
/* Gradient noise from Jorge Jimenez's presentation: */\r
/* http://www.iryoku.com/next-generation-post-processing-in-call-of-duty-advanced-warfare */\r
float gradientNoise(in vec2 uv) {\r
    return fract(52.9829189 * fract(dot(uv, vec2(0.06711056, 0.00583715))));\r
}\r
\r
vec2 rot(vec2 v, float a) {\r
    float s = sin(a);\r
    float c = cos(a);\r
    mat2 m = mat2(c, s, -s, c);\r
    return m * v;\r
}\r
\r
void main() {\r
    float dither = (1.0 / 255.0) * gradientNoise(gl_FragCoord.xy) - (0.5 / 255.0);\r
    vec2 centeredUV = v_uv - vec2(0.2);\r
    vec2 rotatedUV = rot(centeredUV, (u_time + u_volume) * 2.0);\r
    vec2 finalUV = rotatedUV * max(0.001, 1.0 - u_volume * 2.0) + vec2(0.5);\r
    vec4 result = texture2D(u_texture, finalUV);\r
    result *= vec4(v_color, u_alpha);\r
    result *= vec4(max(0.5, 1.0 - u_volume / 2.0));\r
    result += vec4(dither);\r
    gl_FragColor = result;\r
}`,We=`precision highp float;\r
\r
attribute vec2 a_pos;\r
attribute vec3 a_color;\r
attribute vec2 a_uv;\r
varying vec3 v_color;\r
varying vec2 v_uv;\r
\r
uniform float u_aspect;\r
\r
void main() {\r
    v_color = a_color;\r
    v_uv = a_uv;\r
    vec2 pos = a_pos;\r
    if (u_aspect > 1.0) {\r
        pos.y *= u_aspect;\r
    } else {\r
        pos.x /= u_aspect;\r
    }\r
    gl_Position = vec4(pos, 0.0, 1.0);\r
}\r
`;class Be{constructor(T,L,P,I="unknown"){f(this,"gl"),f(this,"program"),f(this,"vertexShader"),f(this,"fragmentShader"),f(this,"attrs"),f(this,"notFoundUniforms",new Set),this.label=I,this.gl=T,this.vertexShader=this.createShader(T.VERTEX_SHADER,L),this.fragmentShader=this.createShader(T.FRAGMENT_SHADER,P),this.program=this.createProgram();const F=T.getProgramParameter(this.program,T.ACTIVE_ATTRIBUTES),D={};for(let V=0;V<F;V++){const q=T.getActiveAttrib(this.program,V);if(!q)continue;const G=T.getAttribLocation(this.program,q.name);G!==-1&&(D[q.name]=G)}this.attrs=D}createShader(T,L){const P=this.gl,I=P.createShader(T);if(!I)throw new Error("Failed to create shader");if(P.shaderSource(I,L),P.compileShader(I),!P.getShaderParameter(I,P.COMPILE_STATUS))throw new Error(`Failed to compile shader for type ${T} "${this.label}": ${P.getShaderInfoLog(I)}`);return I}createProgram(){const T=this.gl,L=T.createProgram();if(!L)throw new Error("Failed to create program");if(T.attachShader(L,this.vertexShader),T.attachShader(L,this.fragmentShader),T.linkProgram(L),T.validateProgram(L),!T.getProgramParameter(L,T.LINK_STATUS)){const P=T.getProgramInfoLog(L);throw T.deleteProgram(L),new Error(`Failed to link program "${this.label}": ${P}`)}return L}use(){this.gl.useProgram(this.program)}warnUniformNotFound(T){this.notFoundUniforms.has(T)||(this.notFoundUniforms.add(T),console.warn(`Failed to get uniform location for program "${this.label}": ${T}`))}setUniform1f(T,L){const P=this.gl,I=P.getUniformLocation(this.program,T);I?P.uniform1f(I,L):this.warnUniformNotFound(T)}setUniform2f(T,L,P){const I=this.gl,F=I.getUniformLocation(this.program,T);F?I.uniform2f(F,L,P):this.warnUniformNotFound(T)}setUniform1i(T,L){const P=this.gl,I=P.getUniformLocation(this.program,T);I?P.uniform1i(I,L):this.warnUniformNotFound(T)}dispose(){const T=this.gl;T.deleteShader(this.vertexShader),T.deleteShader(this.fragmentShader),T.deleteProgram(this.program)}}class qe{constructor(T,L,P,I){f(this,"vertexWidth",0),f(this,"vertexHeight",0),f(this,"vertexBuffer"),f(this,"indexBuffer"),f(this,"vertexData"),f(this,"indexData"),f(this,"vertexIndexLength",0),f(this,"wireFrame",!1),this.gl=T,this.attrPos=L,this.attrColor=P,this.attrUV=I;const F=T.createBuffer();if(!F)throw new Error("Failed to create vertex buffer");this.vertexBuffer=F;const D=T.createBuffer();if(!D)throw new Error("Failed to create index buffer");this.indexBuffer=D,this.bind(),this.vertexData=new Float32Array(0),this.indexData=new Uint16Array(0),this.resize(2,2),this.update()}setWireFrame(T){this.wireFrame=T,this.resize(this.vertexWidth,this.vertexHeight)}setVertexPos(T,L,P,I){const F=(T+L*this.vertexWidth)*7;if(F>=this.vertexData.length-1){console.warn("Vertex position out of range",F,this.vertexData.length);return}this.vertexData[F]=P,this.vertexData[F+1]=I}setVertexColor(T,L,P,I,F){const D=(T+L*this.vertexWidth)*7+2;if(D>=this.vertexData.length-1){console.warn("Vertex position out of range",D,this.vertexData.length);return}this.vertexData[D]=P,this.vertexData[D+1]=I,this.vertexData[D+2]=F}setVertexUV(T,L,P,I){const F=(T+L*this.vertexWidth)*7+2+3;if(F>=this.vertexData.length-1){console.warn("Vertex position out of range",F,this.vertexData.length);return}this.vertexData[F]=P,this.vertexData[F+1]=I}getVertexIndexLength(){return this.vertexIndexLength}draw(){const T=this.gl;this.wireFrame?T.drawElements(T.LINES,this.vertexIndexLength,T.UNSIGNED_SHORT,0):T.drawElements(T.TRIANGLES,this.vertexIndexLength,T.UNSIGNED_SHORT,0)}resize(T,L){this.vertexWidth=T,this.vertexHeight=L,this.vertexIndexLength=T*L*6,this.wireFrame&&(this.vertexIndexLength=T*L*10);const P=new Float32Array(T*L*7),I=new Uint16Array(this.vertexIndexLength);this.vertexData=P,this.indexData=I;for(let D=0;D<L;D++)for(let V=0;V<T;V++){const q=V/(T-1)*2-1,G=D/(L-1)*2-1;this.setVertexPos(V,D,q||0,G||0),this.setVertexColor(V,D,1,1,1),this.setVertexUV(V,D,V/(T-1),D/(L-1))}for(let D=0;D<L-1;D++)for(let V=0;V<T-1;V++)if(this.wireFrame){const q=(D*T+V)*10;I[q]=D*T+V,I[q+1]=D*T+V+1,I[q+2]=D*T+V+1,I[q+3]=(D+1)*T+V,I[q+4]=(D+1)*T+V,I[q+5]=(D+1)*T+V+1,I[q+6]=(D+1)*T+V+1,I[q+7]=D*T+V+1,I[q+8]=D*T+V,I[q+9]=(D+1)*T+V}else{const q=(D*T+V)*6;I[q]=D*T+V,I[q+1]=D*T+V+1,I[q+2]=(D+1)*T+V,I[q+3]=D*T+V+1,I[q+4]=(D+1)*T+V+1,I[q+5]=(D+1)*T+V}const F=this.gl;F.bindBuffer(F.ELEMENT_ARRAY_BUFFER,this.indexBuffer),F.bufferData(F.ELEMENT_ARRAY_BUFFER,this.indexData,F.STATIC_DRAW)}bind(){const T=this.gl;T.bindBuffer(T.ARRAY_BUFFER,this.vertexBuffer),T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.attrPos!==void 0&&(T.vertexAttribPointer(this.attrPos,2,T.FLOAT,!1,28,0),T.enableVertexAttribArray(this.attrPos)),this.attrColor!==void 0&&(T.vertexAttribPointer(this.attrColor,3,T.FLOAT,!1,28,8),T.enableVertexAttribArray(this.attrColor)),this.attrUV!==void 0&&(T.vertexAttribPointer(this.attrUV,2,T.FLOAT,!1,28,20),T.enableVertexAttribArray(this.attrUV))}update(){const T=this.gl;T.bindBuffer(T.ARRAY_BUFFER,this.vertexBuffer),T.bufferData(T.ARRAY_BUFFER,this.vertexData,T.DYNAMIC_DRAW)}dispose(){this.gl.deleteBuffer(this.vertexBuffer),this.gl.deleteBuffer(this.indexBuffer)}}class $e{constructor(){f(this,"color",O.fromValues(1,1,1)),f(this,"location",C.fromValues(0,0)),f(this,"uTangent",C.fromValues(0,0)),f(this,"vTangent",C.fromValues(0,0)),f(this,"_uRot",0),f(this,"_vRot",0),f(this,"_uScale",1),f(this,"_vScale",1),Object.seal(this)}get uRot(){return this._uRot}get vRot(){return this._vRot}set uRot(T){this._uRot=T,this.updateUTangent()}set vRot(T){this._vRot=T,this.updateVTangent()}get uScale(){return this._uScale}get vScale(){return this._vScale}set uScale(T){this._uScale=T,this.updateUTangent()}set vScale(T){this._vScale=T,this.updateVTangent()}updateUTangent(){this.uTangent[0]=Math.cos(this._uRot)*this._uScale,this.uTangent[1]=Math.sin(this._uRot)*this._uScale}updateVTangent(){this.vTangent[0]=-Math.sin(this._vRot)*this._vScale,this.vTangent[1]=Math.cos(this._vRot)*this._vScale}}const dt=_.fromValues(2,-2,1,1,-3,3,-2,-1,0,0,1,0,1,0,0,0),ft=_.clone(dt).transpose(),et=A.create(),Lt=A.create(),nt=A.create(),rt=_.create(),at=_.create();function Ve(R,T,L,P,I=C.create()){et[0]=R**3,et[1]=R**2,et[2]=R,et[3]=1,Lt.copy(et),nt[0]=T**3,nt[1]=T**2,nt[2]=T,nt[3]=1,rt.copy(L).transpose(),_.mul(rt,rt,dt),_.mul(rt,ft,rt),A.transformMat4(et,et,rt);const F=nt.dot(et);at.copy(P).transpose(),_.mul(at,at,dt),_.mul(at,ft,at),A.transformMat4(Lt,Lt,at);const D=nt.dot(Lt);return I.x=F,I.y=D,I}function Gt(R,T,L,P,I,F=_.create()){const D=G=>G.location[I],V=G=>G.uTangent[I],q=G=>G.vTangent[I];return F[0]=D(R),F[1]=D(T),F[2]=q(R),F[3]=q(T),F[4]=D(L),F[5]=D(P),F[6]=q(L),F[7]=q(P),F[8]=V(R),F[9]=V(T),F[10]=0,F[11]=0,F[12]=V(L),F[13]=V(P),F[14]=0,F[15]=0,F}function Dt(R,T,L,P,I,F=_.create()){const D=V=>V.color[I];return F.fill(0),F[0]=D(R),F[1]=D(T),F[4]=D(L),F[5]=D(P),F}const K=A.create(),bt=A.create(),xt=A.create(),st=A.create(),ot=_.create(),ct=_.create(),ht=_.create(),Tt=O.create();function He(R,T,L,P,I){return K[0]=R**3,K[1]=R**2,K[2]=R,K[3]=1,bt.copy(K),xt.copy(K),st[0]=T**3,st[1]=T**2,st[2]=T,st[3]=1,ot.copy(L).transpose(),_.mul(ot,ot,dt),_.mul(ot,ft,ot),A.transformMat4(K,K,ot),Tt.r=st.dot(K),ct.copy(P).transpose(),_.mul(ct,ct,dt),_.mul(ct,ft,ct),A.transformMat4(bt,bt,ct),Tt.g=st.dot(bt),ht.copy(I).transpose(),_.mul(ht,ht,dt),_.mul(ht,ft,ht),A.transformMat4(xt,xt,ht),Tt.b=st.dot(xt),Tt}class Ue{constructor(T,L){f(this,"_width",0),f(this,"_height",0),f(this,"_data",[]),this.resize(T,L),Object.seal(this)}resize(T,L){this._width=T,this._height=L,this._data=new Array(T*L).fill(0)}set(T,L,P){this._data[T+L*this._width]=P}get(T,L){return this._data[T+L*this._width]}get width(){return this._width}get height(){return this._height}}class Ye extends qe{constructor(T,L,P,I){super(T,L,P,I),f(this,"_subDivisions",10),f(this,"_controlPoints",new Ue(3,3)),f(this,"uMX",_.create()),f(this,"uMY",_.create()),f(this,"uMR",_.create()),f(this,"uMG",_.create()),f(this,"uMB",_.create()),f(this,"tmpV2",C.create()),this.resizeControlPoints(3,3),Object.seal(this)}setWireFrame(T){super.setWireFrame(T),this.updateMesh()}resetSubdivition(T){this._subDivisions=T,super.resize((this._controlPoints.width-1)*T,(this._controlPoints.height-1)*T)}resizeControlPoints(T,L){if(!(T>=2&&L>=2))throw new Error("Control points must be larger than 3x3 or equal");this._controlPoints.resize(T,L);for(let P=0;P<L;P++)for(let I=0;I<T;I++){const F=new $e;F.location.x=I/(T-1)*2-1,F.location.y=P/(L-1)*2-1,F.uTangent.x=2/(T-1),F.vTangent.y=2/(L-1),this._controlPoints.set(I,P,F)}this.resetSubdivition(this._subDivisions)}getControlPoint(T,L){return this._controlPoints.get(T,L)}updateMesh(){const T=this._subDivisions-1,L=T*(this._controlPoints.height-1),P=T*(this._controlPoints.width-1);for(let I=0;I<this._controlPoints.width-1;I++)for(let F=0;F<this._controlPoints.height-1;F++){const D=this._controlPoints.get(I,F),V=this._controlPoints.get(I,F+1),q=this._controlPoints.get(I+1,F),G=this._controlPoints.get(I+1,F+1),z=Gt(D,V,q,G,"x",this.uMX),Q=Gt(D,V,q,G,"y",this.uMY),J=Dt(D,V,q,G,"r",this.uMR),tt=Dt(D,V,q,G,"g",this.uMG),yt=Dt(D,V,q,G,"b",this.uMB),At=I/(this._controlPoints.width-1),gt=F/(this._controlPoints.height-1);for(let Et=0;Et<this._subDivisions;Et++)for(let kt=0;kt<this._subDivisions;kt++){const ne=F*this._subDivisions+Et,Se=I*this._subDivisions+kt,[Ht,Le]=Ve(Et/T,kt/T,z,Q,this.tmpV2);this.setVertexPos(ne,Se,Ht,Le),this.setVertexUV(ne,Se,At+kt/P,1-gt-Et/L);const[ee,si,ci]=He(Et/T,kt/T,J,tt,yt);this.setVertexColor(ne,Se,ee,si,ci)}}this.update()}}class Xt{constructor(T,L){f(this,"tex"),this.gl=T;const P=T.createTexture();if(!P)throw new Error("Failed to create texture");this.tex=P,T.activeTexture(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,P),T.texImage2D(T.TEXTURE_2D,0,T.RGBA,T.RGBA,T.UNSIGNED_BYTE,L),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,T.MIRRORED_REPEAT),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,T.MIRRORED_REPEAT)}bind(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.tex)}dispose(){this.gl.deleteTexture(this.tex)}}function je(R,T){if("OffscreenCanvas"in window)return new OffscreenCanvas(R,T);const L=document.createElement("canvas");return L.width=R,L.height=T,L}class hi extends re{constructor(T){super(T),f(this,"gl"),f(this,"lastFrameTime",0),f(this,"frameTime",0),f(this,"currentImageData"),f(this,"lastTickTime",0),f(this,"volume",0),f(this,"tickHandle",0),f(this,"maxFPS",60),f(this,"paused",!1),f(this,"staticMode",!1),f(this,"mainProgram"),f(this,"manualControl",!1),f(this,"reduceImageSizeCanvas",je(32,32)),f(this,"targetSize",C.fromValues(0,0)),f(this,"currentSize",C.fromValues(0,0)),f(this,"isNoCover",!0),f(this,"meshStates",[]),f(this,"_disposed",!1),f(this,"onTickBinded",this.onTick.bind(this)),f(this,"supportTextureFloat",!0);const L=T.getContext("webgl");if(!L)throw new Error("WebGL not supported");L.getExtension("EXT_color_buffer_float")||console.warn("EXT_color_buffer_float not supported"),L.getExtension("EXT_float_blend")||(console.warn("EXT_float_blend not supported"),this.supportTextureFloat=!1),L.getExtension("OES_texture_float_linear")||console.warn("OES_texture_float_linear not supported"),L.getExtension("OES_texture_float")||(this.supportTextureFloat=!1,console.warn("OES_texture_float not supported")),this.gl=L,L.enable(L.BLEND),L.enable(L.DEPTH_TEST),L.depthFunc(L.ALWAYS),this.mainProgram=new Be(L,We,Ne,"main-program-mg"),this.requestTick()}setManualControl(T){this.manualControl=T}setWireFrame(T){for(const L of this.meshStates)L.mesh.setWireFrame(T)}getControlPoint(T,L){var P,I;return(I=(P=this.meshStates[this.meshStates.length-1])==null?void 0:P.mesh)==null?void 0:I.getControlPoint(T,L)}resizeControlPoints(T,L){var P,I;return(I=(P=this.meshStates[this.meshStates.length-1])==null?void 0:P.mesh)==null?void 0:I.resizeControlPoints(T,L)}resetSubdivition(T){var L,P;return(P=(L=this.meshStates[this.meshStates.length-1])==null?void 0:L.mesh)==null?void 0:P.resetSubdivition(T)}onTick(T){if(this.tickHandle=0,this.paused||this._disposed)return;Number.isNaN(this.lastFrameTime)&&(this.lastFrameTime=T);const L=T-this.lastTickTime,P=T-this.lastFrameTime;if(this.lastFrameTime=T,L<1e3/this.maxFPS){this.requestTick();return}this.frameTime+=P*this.flowSpeed,this.onRedraw(this.frameTime,P)&&this.staticMode?this.staticMode&&(this.lastFrameTime=Number.NaN):this.requestTick(),this.lastTickTime=T}checkIfResize(){const[T,L]=[this.targetSize.x,this.targetSize.y],[P,I]=[this.currentSize.x,this.currentSize.y];if(T!==P||L!==I){super.onResize(T,L);const F=this.gl;F.bindFramebuffer(F.FRAMEBUFFER,null),F.viewport(0,0,T,L),this.currentSize.x=T,this.currentSize.y=L}}onRedraw(T,L){const P=this.meshStates[this.meshStates.length-1];let I=!1;if(P)if(P.mesh.bind(),this.manualControl&&P.mesh.updateMesh(),this.isNoCover){for(const V of this.meshStates)V.alpha=Math.max(0,V.alpha-L/500);const D=this.meshStates.filter(V=>V.alpha===0);this.meshStates=this.meshStates.filter(V=>V.alpha>0);for(const V of D)V.mesh.dispose(),V.texture.dispose();this.meshStates.length===0&&(I=!0)}else{if(P.alpha=Math.min(1,P.alpha+L/500),P.alpha>=1){const D=this.meshStates.splice(0,this.meshStates.length-1);for(const V of D)V.mesh.dispose(),V.texture.dispose()}this.meshStates.length===1&&P.alpha>=1&&(I=!0)}const F=this.gl;F.bindFramebuffer(F.FRAMEBUFFER,null),F.blendFunc(F.SRC_ALPHA,F.ONE_MINUS_SRC_ALPHA),F.clear(F.COLOR_BUFFER_BIT),this.checkIfResize(),this.mainProgram.use(),F.activeTexture(F.TEXTURE0),this.mainProgram.setUniform1f("u_time",T/1e4),this.mainProgram.setUniform1f("u_aspect",this.manualControl?1:this.canvas.width/this.canvas.height),this.mainProgram.setUniform1i("u_texture",0),this.mainProgram.setUniform1f("u_volume",this.volume);for(const D of this.meshStates)this.mainProgram.setUniform1f("u_alpha",D.alpha),D.texture.bind(),D.mesh.bind(),D.mesh.draw();return F.flush(),I}requestTick(){this._disposed||this.tickHandle===0&&(this.tickHandle=requestAnimationFrame(this.onTickBinded))}onResize(T,L){this.targetSize.x=Math.ceil(T),this.targetSize.y=Math.ceil(L),this.requestTick()}setStaticMode(T){this.staticMode=T,this.lastFrameTime=performance.now(),this.requestTick()}setFPS(T){this.maxFPS=T}pause(){this.tickHandle&&(cancelAnimationFrame(this.tickHandle),this.tickHandle=0),this.paused=!0}resume(){this.paused=!1,this.requestTick()}async setAlbum(T,L){if(T===void 0||typeof T=="string"&&T.trim().length===0){this.isNoCover=!0;return}let P=null,I=5;for(;!P&&I>0;)try{typeof T=="string"?P=await ae(T,L):P=await oe(T)}catch(z){console.warn(`failed on loading album resource, retrying (${I})`,{albumSource:T,error:z}),I--}if(!P){console.error("Failed to load album resource",T),this.isNoCover=!0;return}this.isNoCover=!1;const F=this.reduceImageSizeCanvas,D=F.getContext("2d",{willReadFrequently:!0});if(!D)throw new Error("Failed to create canvas context");D.clearRect(0,0,F.width,F.height);const V=P instanceof HTMLVideoElement?P.videoWidth:P.naturalWidth,q=P instanceof HTMLVideoElement?P.videoHeight:P.naturalHeight;if(V*q===0)throw new Error("Invalid image size");D.drawImage(P,0,0,V,q,0,0,F.width,F.height);const G=D.getImageData(0,0,F.width,F.height);if(Yt(G,.4),Ie(G,3),Yt(G,1.7),ke(G,.75),ze(G,2,4),this.manualControl&&this.meshStates.length>0)this.meshStates[0].texture.dispose(),this.meshStates[0].texture=new Xt(this.gl,G);else{const z=new Ye(this.gl,this.mainProgram.attrs.a_pos,this.mainProgram.attrs.a_color,this.mainProgram.attrs.a_uv);z.resetSubdivition(15);const Q=Math.random()>.8?Oe(6,6):jt[Math.floor(Math.random()*jt.length)];z.resizeControlPoints(Q.width,Q.height);const J=2/(Q.width-1),tt=2/(Q.height-1);for(const gt of Q.conf){const Et=z.getControlPoint(gt.cx,gt.cy);Et.location.x=gt.x,Et.location.y=gt.y,Et.uRot=gt.ur*Math.PI/180,Et.vRot=gt.vr*Math.PI/180,Et.uScale=J*gt.up,Et.vScale=tt*gt.vp}z.updateMesh(),this.currentImageData=G;const yt=new Xt(this.gl,G),At={mesh:z,texture:yt,alpha:0};this.meshStates.push(At)}this.requestTick()}setLowFreqVolume(T){this.volume=T/10}setHasLyric(T){}dispose(){super.dispose(),this.tickHandle&&(cancelAnimationFrame(this.tickHandle),this.tickHandle=0),this._disposed=!0,this.mainProgram.dispose();for(const T of this.meshStates)T.mesh.dispose(),T.texture.dispose()}}class ce{constructor(T,L){f(this,"element"),f(this,"renderer"),this.renderer=T,this.element=L,L.style.pointerEvents="none",L.style.zIndex="-1",L.style.contain="strict"}static new(T){const L=document.createElement("canvas");return new ce(new T(L),L)}setRenderScale(T){this.renderer.setRenderScale(T)}setFlowSpeed(T){this.renderer.setFlowSpeed(T)}setStaticMode(T){this.renderer.setStaticMode(T)}setFPS(T){this.renderer.setFPS(T)}pause(){this.renderer.pause()}resume(){this.renderer.resume()}setLowFreqVolume(T){this.renderer.setLowFreqVolume(T)}setHasLyric(T){this.renderer.setHasLyric(T)}setAlbum(T,L){return this.renderer.setAlbum(T,L)}getElement(){return this.element}dispose(){this.renderer.dispose(),this.element.remove()}}const Xe="_lyricLine_1vq69_6",Ze="_lyricBgLine_1vq69_42",Je="_active_1vq69_51",Qe="_hasDuetLine_1vq69_63",Ke="_lyricDuetLine_1vq69_64",ts="_lyricMainLine_1vq69_83",es="_emphasizeWrapper_1vq69_93",ss="_emphasize_1vq69_93",is="_lyricSubLine_1vq69_116",ns="_disableSpring_1vq69_123",rs="_interludeDots_1vq69_128",as="_enabled_1vq69_140",os="_tmpDisableTransition_1vq69_166",W={lyricLine:Xe,lyricBgLine:Ze,active:Je,hasDuetLine:Qe,lyricDuetLine:Ke,lyricMainLine:ts,emphasizeWrapper:es,emphasize:ss,lyricSubLine:is,disableSpring:ns,interludeDots:rs,enabled:as,tmpDisableTransition:os},he=-1,zt=0,ut=1,vt=2,Ot=3,Nt=4,Wt=5,Bt=6,le=7,de=8,Zt=typeof self=="object"?self:globalThis,cs=(R,T)=>{const L=(I,F)=>(R.set(F,I),I),P=I=>{if(R.has(I))return R.get(I);const[F,D]=T[I];switch(F){case zt:case he:return L(D,I);case ut:{const V=L([],I);for(const q of D)V.push(P(q));return V}case vt:{const V=L({},I);for(const[q,G]of D)V[P(q)]=P(G);return V}case Ot:return L(new Date(D),I);case Nt:{const{source:V,flags:q}=D;return L(new RegExp(V,q),I)}case Wt:{const V=L(new Map,I);for(const[q,G]of D)V.set(P(q),P(G));return V}case Bt:{const V=L(new Set,I);for(const q of D)V.add(P(q));return V}case le:{const{name:V,message:q}=D;return L(new Zt[V](q),I)}case de:return L(BigInt(D),I);case"BigInt":return L(Object(BigInt(D)),I);case"ArrayBuffer":return L(new Uint8Array(D).buffer,D);case"DataView":{const{buffer:V}=new Uint8Array(D);return L(new DataView(V),D)}}return L(new Zt[F](D),I)};return P},Jt=R=>cs(new Map,R)(0),lt="",{toString:hs}={},{keys:ls}=Object,mt=R=>{const T=typeof R;if(T!=="object"||!R)return[zt,T];const L=hs.call(R).slice(8,-1);switch(L){case"Array":return[ut,lt];case"Object":return[vt,lt];case"Date":return[Ot,lt];case"RegExp":return[Nt,lt];case"Map":return[Wt,lt];case"Set":return[Bt,lt];case"DataView":return[ut,L]}return L.includes("Array")?[ut,L]:L.includes("Error")?[le,L]:[vt,L]},wt=([R,T])=>R===zt&&(T==="function"||T==="symbol"),ds=(R,T,L,P)=>{const I=(D,V)=>{const q=P.push(D)-1;return L.set(V,q),q},F=D=>{if(L.has(D))return L.get(D);let[V,q]=mt(D);switch(V){case zt:{let z=D;switch(q){case"bigint":V=de,z=D.toString();break;case"function":case"symbol":if(R)throw new TypeError("unable to serialize "+q);z=null;break;case"undefined":return I([he],D)}return I([V,z],D)}case ut:{if(q){let J=D;return q==="DataView"?J=new Uint8Array(D.buffer):q==="ArrayBuffer"&&(J=new Uint8Array(D)),I([q,[...J]],D)}const z=[],Q=I([V,z],D);for(const J of D)z.push(F(J));return Q}case vt:{if(q)switch(q){case"BigInt":return I([q,D.toString()],D);case"Boolean":case"Number":case"String":return I([q,D.valueOf()],D)}if(T&&"toJSON"in D)return F(D.toJSON());const z=[],Q=I([V,z],D);for(const J of ls(D))(R||!wt(mt(D[J])))&&z.push([F(J),F(D[J])]);return Q}case Ot:return I([V,D.toISOString()],D);case Nt:{const{source:z,flags:Q}=D;return I([V,{source:z,flags:Q}],D)}case Wt:{const z=[],Q=I([V,z],D);for(const[J,tt]of D)(R||!(wt(mt(J))||wt(mt(tt))))&&z.push([F(J),F(tt)]);return Q}case Bt:{const z=[],Q=I([V,z],D);for(const J of D)(R||!wt(mt(J)))&&z.push(F(J));return Q}}const{message:G}=D;return I([V,{name:q,message:G}],D)};return F},Qt=(R,{json:T,lossy:L}={})=>{const P=[];return ds(!(T||L),!!T,new Map,P)(R),P},Kt=typeof structuredClone=="function"?((R,T)=>T&&("json"in T||"lossy"in T)?Jt(Qt(R,T)):structuredClone(R)):(R,T)=>Jt(Qt(R,T)),ms=(R,T)=>R.size===T.size&&[...R].every(L=>T.has(L)),ps=R=>/^[\p{Unified_Ideograph}\u0800-\u9FFC]+$/u.test(R);function fs(R){return T=>(R(T+.001)-R(T-.001))/(2*.001)}function te(R){return fs(R)}class Pt{constructor(T=0){f(this,"currentPosition",0),f(this,"targetPosition",0),f(this,"currentTime",0),f(this,"params",{}),f(this,"currentSolver"),f(this,"getV"),f(this,"getV2"),f(this,"queueParams"),f(this,"queuePosition"),this.targetPosition=T,this.currentPosition=this.targetPosition,this.currentSolver=()=>this.targetPosition,this.getV=()=>0,this.getV2=()=>0}resetSolver(){const T=this.getV(this.currentTime);this.currentTime=0,this.currentSolver=us(this.currentPosition,T,this.targetPosition,0,this.params),this.getV=te(this.currentSolver),this.getV2=te(this.getV)}arrived(){return Math.abs(this.targetPosition-this.currentPosition)<.01&&this.getV(this.currentTime)<.01&&this.getV2(this.currentTime)<.01&&this.queueParams===void 0&&this.queuePosition===void 0}setPosition(T){this.targetPosition=T,this.currentPosition=T,this.currentSolver=()=>this.targetPosition,this.getV=()=>0,this.getV2=()=>0}update(T=0){this.currentTime+=T,this.currentPosition=this.currentSolver(this.currentTime),this.queueParams&&(this.queueParams.time-=T,this.queueParams.time<=0&&this.updateParams({...this.queueParams})),this.queuePosition&&(this.queuePosition.time-=T,this.queuePosition.time<=0&&this.setTargetPosition(this.queuePosition.position)),this.arrived()&&this.setPosition(this.targetPosition)}updateParams(T,L=0){L>0?this.queueParams={...this.queuePosition??{},...T,time:L}:(this.queuePosition=void 0,this.params={...this.params,...T},this.resetSolver())}setTargetPosition(T,L=0){L>0?this.queuePosition={...this.queuePosition??{},position:T,time:L}:(this.queuePosition=void 0,this.targetPosition=T,this.resetSolver())}getCurrentPosition(){return this.currentPosition}}function us(R,T,L,P=0,I){const F=I?.soft??!1,D=I?.stiffness??100,V=I?.damping??10,q=I?.mass??1,G=L-R;if(F||1<=V/(2*Math.sqrt(D*q))){const yt=-Math.sqrt(D/q),At=-yt*G-T;return gt=>(gt-=P,gt<0?R:L-(G+gt*At)*Math.E**(gt*yt))}const z=Math.sqrt(4*q*D-V**2),Q=(V*G-2*q*T)/z,J=.5*z/q,tt=-(.5*V)/q;return yt=>(yt-=P,yt<0?R:L-(Math.cos(yt*J)*G+Math.sin(yt*J)*Q)*Math.E**(yt*tt))}const _t=[],Rt=[];let Ct=!1;function ys(){let R=Rt.shift();for(;R;){try{R.resolve(R.task())}catch(T){R.reject(T)}R=Rt.shift()}for(R=_t.shift();R;){try{R.resolve(R.task())}catch(T){R.reject(T)}R=_t.shift()}Ct=!1}function me(){Ct||(Ct=!0,requestAnimationFrame(ys))}function pe(R){const T={task:R,resolve:()=>{},reject:()=>{}},L=new Promise((P,I)=>{T.resolve=P,T.reject=I});return _t.push(T),me(),L}class gs{constructor(T){f(this,"element",document.createElement("div")),f(this,"left",0),f(this,"top",0),f(this,"delay",0),f(this,"lineSize",[0,0]),f(this,"lineTransforms",{posX:new Pt(0),posY:new Pt(0)}),f(this,"lastStyle",""),this.lyricPlayer=T,this.element.setAttribute("class",W.lyricLine),this.rebuildStyle()}async measureSize(){return await pe(()=>[this.element.clientWidth,this.element.clientHeight])}show(){this.rebuildStyle()}hide(){this.rebuildStyle()}rebuildStyle(){let T=`transform:translate(${this.lineTransforms.posX.getCurrentPosition().toFixed(2)}px,${this.lineTransforms.posY.getCurrentPosition().toFixed(2)}px);`;!this.lyricPlayer.getEnableSpring()&&this.isInSight&&(T+=`transition-delay:${this.delay}ms;`),T!==this.lastStyle&&(this.lastStyle=T,this.element.setAttribute("style",T))}getElement(){return this.element}setTransform(T=this.left,L=this.top,P=!1,I=0){this.left=T,this.top=L,this.delay=I*1e3|0,P||!this.lyricPlayer.getEnableSpring()?(P&&this.element.classList.add(W.tmpDisableTransition),this.lineTransforms.posX.setPosition(T),this.lineTransforms.posY.setPosition(L),this.lyricPlayer.getEnableSpring()?this.rebuildStyle():this.show(),P&&requestAnimationFrame(()=>{this.element.classList.remove(W.tmpDisableTransition)})):(this.lineTransforms.posX.setTargetPosition(T,I),this.lineTransforms.posY.setTargetPosition(L,I))}update(T=0){this.lyricPlayer.getEnableSpring()&&(this.lineTransforms.posX.update(T),this.lineTransforms.posY.update(T),this.isInSight?this.show():this.hide())}get isInSight(){const T=this.lineTransforms.posX.getCurrentPosition(),L=this.lineTransforms.posY.getCurrentPosition(),P=T+this.lineSize[0],I=L+this.lineSize[1],F=this.lyricPlayer.size[0],D=this.lyricPlayer.size[1];return!(T>F||L>D||P<0||I<0)}dispose(){this.element.remove()}}function Ms(R){const T=2.5949095;return R<.5?(2*R)**2*((T+1)*2*R-T)/2:((2*R-2)**2*((T+1)*(R*2-2)+T)+2)/2}function Ls(R){return R===1?1:1-2**(-10*R)}const it=(R,T,L)=>Math.max(R,Math.min(T,L));class bs{constructor(){f(this,"element",document.createElement("div")),f(this,"dot0",document.createElement("span")),f(this,"dot1",document.createElement("span")),f(this,"dot2",document.createElement("span")),f(this,"left",0),f(this,"top",0),f(this,"playing",!0),f(this,"lastStyle",""),f(this,"currentInterlude"),f(this,"currentTime",0),f(this,"targetBreatheDuration",1500),this.element.className=W.interludeDots,this.element.appendChild(this.dot0),this.element.appendChild(this.dot1),this.element.appendChild(this.dot2)}getElement(){return this.element}setTransform(T=this.left,L=this.top){this.left=T,this.top=L,this.update()}setInterlude(T){this.currentInterlude=T,this.currentTime=T?.[0]??0,T?this.element.classList.add(W.enabled):this.element.classList.remove(W.enabled)}pause(){this.playing=!1,this.element.classList.remove(W.playing)}resume(){this.playing=!0,this.element.classList.add(W.playing)}update(T=0){if(!this.playing)return;this.currentTime+=T;let L="";if(L+=`transform:translate(${this.left.toFixed(2)}px, ${this.top.toFixed(2)}px)`,this.currentInterlude){const P=this.currentInterlude[1]-this.currentInterlude[0],I=this.currentTime-this.currentInterlude[0];if(I<=P){const F=P/Math.ceil(P/this.targetBreatheDuration);let D=1,V=1;D*=Math.sin(1.5*Math.PI-I/F*2)/20+1,I<2e3&&(D*=Ls(I/2e3)),I<500?V=0:I<1e3&&(V*=(I-500)/500),P-I<750&&(D*=1-Ms((750-(P-I))/750/2)),P-I<375&&(V*=it(0,(P-I)/375,1));const q=Math.max(0,P-750);D=Math.max(0,D)*.7,L+=` scale(${D})`;const G=it(.25,I*3/q*.75,1),z=it(.25,(I-q/3)*3/q*.75,1),Q=it(.25,(I-q/3*2)*3/q*.75,1);this.dot0.style.opacity=`${it(0,Math.max(0,V*G),1)}`,this.dot1.style.opacity=`${it(0,Math.max(0,V*z),1)}`,this.dot2.style.opacity=`${it(0,Math.max(0,V*Q),1)}`}else L+=" scale(0)",this.dot0.style.opacity="0",this.dot1.style.opacity="0",this.dot2.style.opacity="0";L+=";",this.lastStyle!==L&&(this.element.setAttribute("style",L),this.lastStyle=L)}}dispose(){this.element.remove()}}class qt extends EventTarget{constructor(){super(),f(this,"element",document.createElement("div")),f(this,"currentTime",0),f(this,"lyricLinesSize",new WeakMap),f(this,"lyricLineElementMap",new WeakMap),f(this,"currentLyricLines",[]),f(this,"processedLines",[]),f(this,"lyricLinesIndexes",new WeakMap),f(this,"hotLines",new Set),f(this,"bufferedLines",new Set),f(this,"isNonDynamic",!1),f(this,"hasDuetLine",!1),f(this,"scrollToIndex",0),f(this,"disableSpring",!1),f(this,"interludeDotsSize",[0,0]),f(this,"interludeDots",new bs),f(this,"bottomLine",new gs(this)),f(this,"enableBlur",!0),f(this,"enableScale",!0),f(this,"hidePassedLines",!1),f(this,"scrollBoundary",[0,0]),f(this,"currentLyricLineObjects",[]),f(this,"isSeeking",!1),f(this,"lastCurrentTime",0),f(this,"alignAnchor","center"),f(this,"alignPosition",.35),f(this,"scrollOffset",0),f(this,"size",[0,0]),f(this,"allowScroll",!0),f(this,"isPageVisible",!0),f(this,"initialLayoutFinished",!1),f(this,"posXSpringParams",{mass:1,damping:10,stiffness:100}),f(this,"posYSpringParams",{mass:.9,damping:15,stiffness:90}),f(this,"scaleSpringParams",{mass:2,damping:25,stiffness:100}),f(this,"scaleForBGSpringParams",{mass:1,damping:20,stiffness:50}),f(this,"onPageShow",()=>{this.isPageVisible=!0,this.setCurrentTime(this.currentTime,!0)}),f(this,"onPageHide",()=>{this.isPageVisible=!1}),f(this,"scrolledHandler",0),f(this,"isScrolled",!1),f(this,"resizeObserver",new ResizeObserver(G=>{let z=!1,Q=!1;for(const J of G)if(J.target===this.element){const tt=J.contentRect;this.size[0]=tt.width,this.size[1]=tt.height,Q=!0}else if(J.target===this.interludeDots.getElement())this.interludeDotsSize[0]=J.target.clientWidth,this.interludeDotsSize[1]=J.target.clientHeight,z=!0;else if(J.target===this.bottomLine.getElement()){const tt=[J.target.clientWidth,J.target.clientHeight],yt=this.bottomLine.lineSize;(tt[0]!==yt[0]||tt[1]!==yt[1])&&(this.bottomLine.lineSize=tt,z=!0)}else{const tt=this.lyricLineElementMap.get(J.target);if(tt){const yt=[J.target.clientWidth,J.target.clientHeight],At=this.lyricLinesSize.get(tt)??[0,0];(yt[0]!==At[0]||yt[1]!==At[1])&&(this.lyricLinesSize.set(tt,yt),tt.onLineSizeChange(yt),z=!0)}}z&&this.calcLayout(!0),Q&&this.onResize()})),f(this,"wordFadeWidth",.5),f(this,"targetAlignIndex",0),f(this,"isPlaying",!0),this.resizeObserver.observe(this.element),this.resizeObserver.observe(this.interludeDots.getElement()),this.element.classList.add(W.lyricPlayer),this.element.appendChild(this.interludeDots.getElement()),this.element.appendChild(this.bottomLine.getElement()),this.interludeDots.setTransform(0,200),window.addEventListener("pageshow",this.onPageShow),window.addEventListener("pagehide",this.onPageHide);let T=0,L="none",P=0,I=0,F=0,D=Symbol("amll-scroll"),V=0,q=0;this.element.addEventListener("touchstart",G=>{this.beginScrollHandler()&&(G.preventDefault(),T=this.scrollOffset,P=G.touches[0].screenY,V=P,I=Date.now(),F=0)}),this.element.addEventListener("touchmove",G=>{if(this.beginScrollHandler()){G.preventDefault();const z=G.touches[0].screenY,Q=z-P,J=z-V,tt=J>0?"down":J<0?"up":"none";L!==tt?(L=tt,T=this.scrollOffset,P=z,I=Date.now()):this.scrollOffset=T-Q,V=z,q=Date.now(),this.limitScrollOffset(),this.calcLayout(!0)}}),this.element.addEventListener("touchend",G=>{if(this.beginScrollHandler()){G.preventDefault(),P=0;const z=Date.now();if(z-q>100)return this.endScrollHandler();const Q=z-I;F=(this.scrollOffset-T)/Q*1e3;let J=0;const tt=Symbol("amll-scroll");D=tt;const yt=At=>{J||(J=At),D===tt&&this.beginScrollHandler()&&(this.scrollOffset+=F*(At-J)/1e3,F*=.99,this.limitScrollOffset(),this.calcLayout(!0),Math.abs(F)>1&&!this.scrollBoundary.includes(this.scrollOffset)&&requestAnimationFrame(yt),this.endScrollHandler(),J=At)};requestAnimationFrame(yt),this.endScrollHandler()}}),this.element.addEventListener("wheel",G=>{this.beginScrollHandler()&&(G.deltaMode===G.DOM_DELTA_PIXEL?(this.scrollOffset+=G.deltaY,this.limitScrollOffset(),this.calcLayout(!0)):(this.scrollOffset+=G.deltaY*50,this.limitScrollOffset(),this.calcLayout(!1)),this.endScrollHandler())})}beginScrollHandler(){const T=this.allowScroll;return T&&(this.isScrolled=!0,clearTimeout(this.scrolledHandler),this.scrolledHandler=setTimeout(()=>{this.isScrolled=!1,this.scrollOffset=0},5e3)),T}endScrollHandler(){}limitScrollOffset(){this.scrollOffset=Math.max(Math.min(this.scrollBoundary[1],this.scrollOffset),this.scrollBoundary[0])}setWordFadeWidth(T=.5){this.wordFadeWidth=Math.max(1e-4,T)}setEnableScale(T=!0){this.enableScale=T,this.calcLayout()}getEnableScale(){return this.enableScale}getWordFadeWidth(){return this.wordFadeWidth}setIsSeeking(T){this.isSeeking=T}setHidePassedLines(T){this.hidePassedLines=T,this.calcLayout()}setEnableBlur(T){this.enableBlur!==T&&(this.enableBlur=T,this.calcLayout())}setAlignAnchor(T){this.alignAnchor=T}setAlignPosition(T){this.alignPosition=T}setEnableSpring(T=!0){this.disableSpring=!T,T?this.element.classList.remove(W.disableSpring):this.element.classList.add(W.disableSpring),this.calcLayout(!0)}getEnableSpring(){return!this.disableSpring}getCurrentInterlude(){var T,L,P,I;if(this.bufferedLines.size>0)return;const F=this.currentTime+20,D=this.scrollToIndex;if(D===0){if((T=this.processedLines[0])!=null&&T.startTime){if(this.processedLines[0].startTime>F)return[F,Math.max(F,this.processedLines[0].startTime-250),-2,this.processedLines[0].isDuet];if(this.processedLines[1].startTime>F&&this.processedLines[0].endTime<F)return[Math.max(this.processedLines[0].endTime,F),this.processedLines[1].startTime,0,this.processedLines[1].isDuet]}}else if((L=this.processedLines[D])!=null&&L.endTime&&(P=this.processedLines[D+1])!=null&&P.startTime){if(this.processedLines[D+1].startTime>F&&this.processedLines[D].endTime<F)return[Math.max(this.processedLines[D].endTime,F),this.processedLines[D+1].startTime,D,this.processedLines[D+1].isDuet];if((I=this.processedLines[D+2])!=null&&I.startTime&&this.processedLines[D+2].startTime>F&&this.processedLines[D+1].endTime<F)return[Math.max(this.processedLines[D+1].endTime,F),this.processedLines[D+2].startTime,D+1,this.processedLines[D+2].isDuet]}}setLyricLines(T,L=0){this.initialLayoutFinished=!0;for(const P of T)for(const I of P.words)I.word=I.word.replace(/\s+/g," ");this.lastCurrentTime=L,this.currentTime=L,this.currentLyricLines=Kt(T),this.processedLines=Kt(T),this.isNonDynamic=!0;for(const P of this.processedLines)if(P.words.length>1){this.isNonDynamic=!1;break}this.hasDuetLine=this.processedLines.some(P=>P.isDuet),this.processedLines.forEach((P,I,F)=>{if(P.isBG)return;const D=F[I+1];D!=null&&D.isBG&&(D.startTime=Math.min(D.startTime,P.startTime),D.endTime=Math.max(D.endTime,P.endTime))});for(const P of this.currentLyricLineObjects)P.dispose();this.interludeDots.setInterlude(void 0),this.hotLines.clear(),this.bufferedLines.clear(),this.setCurrentTime(0,!0)}setCurrentTime(T,L=!1){var P,I,F,D,V,q,G,z,Q;if(this.currentTime=T,!this.initialLayoutFinished&&!L)return;const J=new Set,tt=new Set,yt=new Set;for(const At of this.hotLines){const gt=this.processedLines[At];if(gt){if(gt.isBG)continue;const Et=this.processedLines[At+1];if(Et!=null&&Et.isBG){const kt=this.processedLines[At+2],ne=Math.min(gt.startTime,Et?.startTime),Se=Math.min(Math.max(gt.endTime,kt?.startTime??Number.MAX_VALUE),Math.max(gt.endTime,Et?.endTime));(ne>T||Se<=T)&&(this.hotLines.delete(At),J.add(At),this.hotLines.delete(At+1),J.add(At+1),L&&((P=this.currentLyricLineObjects[At])==null||P.disable(),(I=this.currentLyricLineObjects[At+1])==null||I.disable()))}else(gt.startTime>T||gt.endTime<=T)&&(this.hotLines.delete(At),J.add(At),L&&((F=this.currentLyricLineObjects[At])==null||F.disable()))}else this.hotLines.delete(At),J.add(At),L&&((D=this.currentLyricLineObjects[At])==null||D.disable())}this.currentLyricLineObjects.forEach((At,gt,Et)=>{var kt,ne;const Se=At.getLine();!Se.isBG&&Se.startTime<=T&&Se.endTime>T&&(this.hotLines.has(gt)||(this.hotLines.add(gt),yt.add(gt),L&&At.enable(),(ne=(kt=Et[gt+1])==null?void 0:kt.getLine())!=null&&ne.isBG&&(this.hotLines.add(gt+1),yt.add(gt+1),L&&Et[gt+1].enable())))});for(const At of this.bufferedLines)this.hotLines.has(At)||(tt.add(At),L&&((V=this.currentLyricLineObjects[At])==null||V.disable()));if(L){this.bufferedLines.size>0?this.scrollToIndex=Math.min(...this.bufferedLines):this.scrollToIndex=this.processedLines.findIndex(At=>At.startTime>=T),this.bufferedLines.clear();for(const At of this.hotLines)this.bufferedLines.add(At);this.calcLayout()}else if(tt.size>0||yt.size>0)if(tt.size===0&&yt.size>0){for(const At of yt)this.bufferedLines.add(At),(q=this.currentLyricLineObjects[At])==null||q.enable();this.scrollToIndex=Math.min(...this.bufferedLines),this.calcLayout()}else if(yt.size===0&&tt.size>0){if(ms(tt,this.bufferedLines)){for(const At of this.bufferedLines)this.hotLines.has(At)||(this.bufferedLines.delete(At),(G=this.currentLyricLineObjects[At])==null||G.disable());this.calcLayout()}}else{for(const At of yt)this.bufferedLines.add(At),(z=this.currentLyricLineObjects[At])==null||z.enable();for(const At of tt)this.bufferedLines.delete(At),(Q=this.currentLyricLineObjects[At])==null||Q.disable();this.bufferedLines.size>0&&(this.scrollToIndex=Math.min(...this.bufferedLines)),this.calcLayout()}this.lastCurrentTime=T}async calcLayout(T=!1){var L;const P=this.getCurrentInterlude();let I=-this.scrollOffset,F=this.scrollToIndex,D=0;P?(D=P[1]-P[0],D>=4e3&&this.currentLyricLineObjects[P[2]+1]&&(F=P[2]+1)):this.interludeDots.setInterlude(void 0);const V=this.size[1]/5,q=this.currentLyricLineObjects.slice(0,F).reduce((yt,At)=>{var gt;return yt+(At.getLine().isBG&&this.isPlaying?0:((gt=this.lyricLinesSize.get(At))==null?void 0:gt[1])??V)},0);this.scrollBoundary[0]=-q,I-=q,I+=this.size[1]*this.alignPosition;const G=this.currentLyricLineObjects[F];if(this.targetAlignIndex=F,G){const yt=((L=this.lyricLinesSize.get(G))==null?void 0:L[1])??V;switch(this.alignAnchor){case"bottom":I-=yt;break;case"center":I-=yt/2;break}}const z=Math.max(...this.bufferedLines);let Q=0,J=T?0:.05,tt=!1;this.currentLyricLineObjects.forEach((yt,At)=>{var gt,Et;const kt=this.bufferedLines.has(At),ne=kt||At>=this.scrollToIndex&&At<z,Se=yt.getLine();!tt&&D>=4e3&&(At===this.scrollToIndex&&P?.[2]===-2||At===this.scrollToIndex+1)&&(tt=!0,this.interludeDots.setTransform(0,I),P&&this.interludeDots.setInterlude([P[0],P[1]]),I+=this.interludeDotsSize[1]);let Ht;this.hidePassedLines?At<(P?P[2]+1:this.scrollToIndex)&&this.isPlaying?Ht=1e-5:kt?Ht=.85:Ht=this.isNonDynamic?.2:1:kt?Ht=.85:Ht=this.isNonDynamic?.2:1;let Le=0;this.enableBlur&&(ne?Le=0:(Le=1,At<this.scrollToIndex?Le+=Math.abs(this.scrollToIndex-At)+1:Le+=Math.abs(At-Math.max(this.scrollToIndex,z))));const ee=this.enableScale?97:100;let si=100;!ne&&this.isPlaying&&(Se.isBG?si=75:si=ee),yt.setTransform(I,si,Ht,window.innerWidth<=1024?Le*.8:Le,!1,Q),Se.isBG&&(ne||!this.isPlaying)?I+=((gt=this.lyricLinesSize.get(yt))==null?void 0:gt[1])??V:Se.isBG||(I+=((Et=this.lyricLinesSize.get(yt))==null?void 0:Et[1])??V),I>=0&&!this.isSeeking&&(Se.isBG||(Q+=J),At>=this.scrollToIndex&&(J/=1.05))}),this.scrollBoundary[1]=I+this.scrollOffset-this.size[1]/2,this.bottomLine.setTransform(0,I,!1,Q)}setLinePosXSpringParams(T={}){}setLinePosYSpringParams(T={}){this.posYSpringParams={...this.posYSpringParams,...T},this.bottomLine.lineTransforms.posY.updateParams(this.posYSpringParams);for(const L of this.currentLyricLineObjects)L.lineTransforms.posY.updateParams(this.posYSpringParams)}setLineScaleSpringParams(T={}){this.scaleSpringParams={...this.scaleSpringParams,...T},this.scaleForBGSpringParams={...this.scaleForBGSpringParams,...T};for(const L of this.currentLyricLineObjects)L.getLine().isBG?L.lineTransforms.scale.updateParams(this.scaleForBGSpringParams):L.lineTransforms.scale.updateParams(this.scaleSpringParams)}pause(){this.interludeDots.pause(),this.isPlaying&&(this.isPlaying=!1,this.calcLayout())}resume(){this.interludeDots.resume(),this.isPlaying||(this.isPlaying=!0,this.calcLayout())}update(T=0){this.bottomLine.update(T/1e3),this.interludeDots.update(T/1e3)}onResize(){}getBottomLineElement(){return this.bottomLine.getElement()}resetScroll(){this.isScrolled=!1,this.scrollOffset=0,clearTimeout(this.scrolledHandler),this.scrolledHandler=0}getLyricLines(){return this.currentLyricLines}getCurrentTime(){return this.currentTime}getElement(){return this.element}dispose(){this.element.remove(),window.removeEventListener("pageshow",this.onPageShow),window.removeEventListener("pagehide",this.onPageHide)}}class H extends EventTarget{constructor(){super(...arguments),f(this,"top",0),f(this,"scale",1),f(this,"blur",0),f(this,"opacity",1),f(this,"delay",0),f(this,"lineTransforms",{posY:new Pt(0),scale:new Pt(100)})}onLineSizeChange(T){}setTransform(T=this.top,L=this.scale,P=this.opacity,I=this.blur,F=!1,D=0){this.top=T,this.scale=L,this.opacity=P,this.blur=I,this.delay=D}static shouldEmphasize(T){return ps(T.word)?T.endTime-T.startTime>=1e3:T.endTime-T.startTime>=1e3&&T.word.trim().length<=7&&T.word.trim().length>1}dispose(){}}function xs(R){return R&&R.__esModule&&Object.prototype.hasOwnProperty.call(R,"default")?R.default:R}var Ft,se;function Ts(){if(se)return Ft;se=1;var R=4,T=.001,L=1e-7,P=10,I=11,F=1/(I-1),D=typeof Float32Array=="function";function V(At,gt){return 1-3*gt+3*At}function q(At,gt){return 3*gt-6*At}function G(At){return 3*At}function z(At,gt,Et){return((V(gt,Et)*At+q(gt,Et))*At+G(gt))*At}function Q(At,gt,Et){return 3*V(gt,Et)*At*At+2*q(gt,Et)*At+G(gt)}function J(At,gt,Et,kt,ne){var Se,Ht,Le=0;do Ht=gt+(Et-gt)/2,Se=z(Ht,kt,ne)-At,Se>0?Et=Ht:gt=Ht;while(Math.abs(Se)>L&&++Le<P);return Ht}function tt(At,gt,Et,kt){for(var ne=0;ne<R;++ne){var Se=Q(gt,Et,kt);if(Se===0)return gt;var Ht=z(gt,Et,kt)-At;gt-=Ht/Se}return gt}function yt(At){return At}return Ft=function(At,gt,Et,kt){if(!(0<=At&&At<=1&&0<=Et&&Et<=1))throw new Error("bezier x values must be in [0, 1] range");if(At===gt&&Et===kt)return yt;for(var ne=D?new Float32Array(I):new Array(I),Se=0;Se<I;++Se)ne[Se]=z(Se*F,At,Et);function Ht(Le){for(var ee=0,si=1,ci=I-1;si!==ci&&ne[si]<=Le;++si)ee+=F;--si;var di=(Le-ne[si])/(ne[si+1]-ne[si]),ui=ee+di*F,ei=Q(ui,At,Et);return ei>=T?tt(Le,ui,At,Et):ei===0?ui:J(Le,ee,ee+F,At,Et)}return function(Le){return Le===0?0:Le===1?1:z(Ht(Le),gt,kt)}},Ft}var ws=Ts();const It=xs(ws),Ss=/^[\p{Unified_Ideograph}\u0800-\u9FFC]+$/u;function $t(R){const T=[];for(const F of R){const D=F.word.replace(/\s/g,"").length,V=F.word.split(" ").filter(q=>q.trim().length>0);if(V.length>1){F.word.startsWith(" ")&&T.push({word:" ",startTime:0,endTime:0,obscene:!1});let q=0;for(const G of V){const z={word:G,obscene:F.obscene,startTime:F.startTime+q/D*(F.endTime-F.startTime),endTime:F.startTime+(q+G.length)/D*(F.endTime-F.startTime)};T.push(z),T.push({word:" ",startTime:0,endTime:0,obscene:!1}),q+=G.length}F.word.endsWith(" ")||T.pop()}else T.push({...F})}let L=[],P=[];const I=[];for(const F of T){const D=F.word;L.push(D),P.push(F),D.length>0&&D.trim().length===0?(L.pop(),P.pop(),P.length===1?I.push(P[0]):P.length>1&&I.push(P),I.push(F),L=[],P=[]):(!/^\s*[^\s]*\s*$/.test(L.join(""))||Ss.test(D))&&(L.pop(),P.pop(),P.length===1?I.push(P[0]):P.length>1&&I.push(P),L=[D],P=[F])}return P.length===1?I.push(P[0]):I.push(P),I}function fe(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ue(R,T=1,L={x:0,y:0}){const[P,I]=[L.x,L.y];return[R[0]*T,R[1]*T,R[2]*T,R[3],R[4]*T,R[5]*T,R[6]*T,R[7],R[8]*T,R[9]*T,R[10]*T,R[11],R[12]-P*T+P,R[13]-I*T+I,R[14],R[15]]}function ye(R,T=4){const L=(P,I)=>P.toFixed(T);return`matrix3d(${R.map(L).join(", ")})`}const St=32,ge=(R,T)=>L=>Math.min(1,Math.max(0,(L-R)/(T-R))),Vt=.5,Es=ge(0,Vt),vs=ge(Vt,1),Ps=It(.2,.4,.58,1),zs=It(.3,0,.58,1),Is=R=>T=>T<R?Ps(Es(T)):1-zs(vs(T));function ie(R,T=0,L="rgba(0,0,0,var(--bright-mask-alpha, 1.0))",P="rgba(0,0,0,var(--dark-mask-alpha, 1.0))"){const I=2+R+T,F=R/I,D=(1-F)/2;return[`linear-gradient(to right,${L} ${D*100}%,${P} ${(D+F)*100}%)`,I]}let ks=class extends MouseEvent{constructor(R,T){super(T.type,T),this.line=R}};function Ds(R){const T=R.match(/matrix\(([^)]+)\)/);if(T){const L=T[1].split(", "),P=Number.parseFloat(L[0]),I=Number.parseFloat(L[3]);return(P+I)/2}return 1}let Fs=class extends H{constructor(R,T={words:[],translatedLyric:"",romanLyric:"",startTime:0,endTime:0,isBG:!1,isDuet:!1}){super(),f(this,"element",document.createElement("div")),f(this,"splittedWords",[]),f(this,"lineSize",[0,0]),f(this,"listenersMap",new Map),f(this,"onMouseEvent",F=>{const D=new ks(this,F);for(const V of this.listenersMap.get(F.type)??[])V.call(this,D);if(!this.dispatchEvent(D)||D.defaultPrevented)return F.preventDefault(),F.stopPropagation(),F.stopImmediatePropagation(),!1}),f(this,"isEnabled",!1),f(this,"lastWord"),f(this,"_hide",!0),f(this,"_prevParentEl"),f(this,"lastStyle",""),this.lyricPlayer=R,this.lyricLine=T,this._prevParentEl=R.getElement(),R.resizeObserver.observe(this.element),this.element.setAttribute("class",W.lyricLine),this.lyricLine.isBG&&this.element.classList.add(W.lyricBgLine),this.lyricLine.isDuet&&this.element.classList.add(W.lyricDuetLine),this.lineTransforms.posY.setPosition(window.innerHeight*2),this.element.appendChild(document.createElement("div")),this.element.appendChild(document.createElement("div")),this.element.appendChild(document.createElement("div"));const L=this.element.children[0],P=this.element.children[1],I=this.element.children[2];L.setAttribute("class",W.lyricMainLine),P.setAttribute("class",W.lyricSubLine),I.setAttribute("class",W.lyricSubLine),this.rebuildElement(),this.rebuildStyle()}addMouseEventListener(R,T,L){if(T){const P=this.listenersMap.get(R)??new Set;P.size===0&&this.element.addEventListener(R,this.onMouseEvent,L),P.add(T),this.listenersMap.set(R,P)}}removeMouseEventListener(R,T,L){if(T){const P=this.listenersMap.get(R);P&&(P.delete(T),P.size===0&&this.element.removeEventListener(R,this.onMouseEvent,L))}}areWordsOnSameLine(R,T){if(R!=null&&R.mainElement&&T!=null&&T.mainElement){const L=R.mainElement,P=T.mainElement,I=L.getBoundingClientRect(),F=P.getBoundingClientRect();return Math.abs(I.top-F.top)<10}return!0}async enable(R=this.lyricLine.startTime){this.isEnabled=!0,this.element.classList.add(W.active);const T=this.element.children[0];for(const L of this.splittedWords){for(const P of L.elementAnimations)P.currentTime=0,P.playbackRate=1,P.play();for(const P of L.maskAnimations)P.currentTime=Math.min(this.totalDuration,Math.max(0,R-this.lyricLine.startTime)),P.playbackRate=1,P.play()}T.classList.add(W.active)}disable(){this.isEnabled=!1,this.element.classList.remove(W.active);const R=this.element.children[0];for(const T of this.splittedWords)for(const L of T.elementAnimations)(L.id==="float-word"||L.id.includes("emphasize-word-float-only"))&&(L.playbackRate=-1,L.play());R.classList.remove(W.active)}async resume(){if(this.isEnabled)for(const R of this.splittedWords){for(const T of R.elementAnimations)(!this.lastWord||this.splittedWords.indexOf(this.lastWord)<this.splittedWords.indexOf(R))&&T.play();for(const T of R.maskAnimations)(!this.lastWord||this.splittedWords.indexOf(this.lastWord)<this.splittedWords.indexOf(R))&&T.play()}}async pause(){if(this.isEnabled)for(const R of this.splittedWords){for(const T of R.elementAnimations)T.pause();for(const T of R.maskAnimations)T.pause()}}setMaskAnimationState(R=0){const T=R-this.lyricLine.startTime;for(const L of this.splittedWords)for(const P of L.maskAnimations)P.currentTime=Math.min(this.totalDuration,Math.max(0,T)),P.playbackRate=1,T>=0&&T<this.totalDuration?P.play():P.pause()}getLine(){return this.lyricLine}show(){this._hide=!1,this.element.parentElement||(this._prevParentEl.appendChild(this.element),this.lyricPlayer.resizeObserver.observe(this.element)),this.rebuildStyle()}hide(){this._hide=!0,this.element.parentElement&&(this._prevParentEl.removeChild(this.element),this.lyricPlayer.resizeObserver.unobserve(this.element))}rebuildStyle(){let R="";R+=`transform:translateY(${this.lineTransforms.posY.getCurrentPosition().toFixed(1)}px) scale(${(this.lineTransforms.scale.getCurrentPosition()/100).toFixed(4)});`,!this.lyricPlayer.getEnableSpring()&&this.isInSight&&(R+=`transition-delay:${this.delay}ms;`),R+=`filter:blur(${Math.min(32,this.blur)}px);`,R!==this.lastStyle&&(this.lastStyle=R,this.element.setAttribute("style",R))}rebuildElement(){this.disposeElements();const R=this.element.children[0],T=this.element.children[1],L=this.element.children[2];if(this.lyricPlayer._getIsNonDynamic()){R.innerText=this.lyricLine.words.map(I=>I.word).join(""),T.innerText=this.lyricLine.translatedLyric,L.innerText=this.lyricLine.romanLyric;return}const P=$t(this.lyricLine.words);R.innerHTML="";for(const I of P)if(Array.isArray(I)){if(I.length===0)continue;const F=I.reduce((G,z)=>(G.endTime=Math.max(G.endTime,z.endTime),G.startTime=Math.min(G.startTime,z.startTime),G.word+=z.word,G),{word:"",startTime:Number.POSITIVE_INFINITY,endTime:Number.NEGATIVE_INFINITY,wordType:"normal",obscene:!1}),D=I.map(G=>H.shouldEmphasize(G)).reduce((G,z)=>G||z,H.shouldEmphasize(F)),V=document.createElement("span");V.classList.add(W.emphasizeWrapper);const q=[];for(const G of I){const z=document.createElement("span");if(D){z.classList.add(W.emphasize);const Q=[];for(const tt of G.word.trim().split("")){const yt=document.createElement("span");yt.innerText=tt,Q.push(yt),q.push(yt),z.appendChild(yt)}const J={...G,mainElement:z,subElements:Q,elementAnimations:[this.initFloatAnimation(G,z)],maskAnimations:[],width:0,height:0,padding:0,shouldEmphasize:D};this.splittedWords.push(J)}else z.innerText=G.word,this.splittedWords.push({...G,mainElement:z,subElements:[],elementAnimations:[this.initFloatAnimation(G,z)],maskAnimations:[],width:0,height:0,padding:0,shouldEmphasize:D});V.appendChild(z)}D&&this.splittedWords[this.splittedWords.length-1].elementAnimations.push(...this.initEmphasizeAnimation(F,q,F.endTime-F.startTime,F.startTime-this.lyricLine.startTime)),F.word.trimStart()!==F.word&&R.appendChild(document.createTextNode(" ")),R.appendChild(V),F.word.trimEnd()!==F.word&&H.shouldEmphasize(F)&&R.appendChild(document.createTextNode(" "))}else if(I.word.trim().length===0)R.appendChild(document.createTextNode(" "));else{const F=H.shouldEmphasize(I),D=document.createElement("span"),V={...I,mainElement:D,subElements:[],elementAnimations:[this.initFloatAnimation(I,D)],maskAnimations:[],width:0,height:0,padding:0,shouldEmphasize:F};if(H.shouldEmphasize(I)){D.classList.add(W.emphasize);const q=[];for(const z of I.word.trim().split("")){const Q=document.createElement("span");Q.innerText=z,q.push(Q),D.appendChild(Q)}V.subElements=q;const G=Math.abs(V.endTime-V.startTime);V.elementAnimations.push(...this.initEmphasizeAnimation(I,q,G,V.startTime-this.lyricLine.startTime))}else D.innerText=I.word.trim();I.word.trimStart()!==I.word&&R.appendChild(document.createTextNode(" ")),R.appendChild(D),I.word.trimEnd()!==I.word&&R.appendChild(document.createTextNode(" ")),this.splittedWords.push(V)}T.innerText=this.lyricLine.translatedLyric,L.innerText=this.lyricLine.romanLyric}initFloatAnimation(R,T){const L=R.startTime-this.lyricLine.startTime,P=Math.max(1e3,R.endTime-R.startTime);let I=.05;this.lyricLine.isBG&&(I*=2);const F=T.animate([{transform:"translateY(0px)"},{transform:`translateY(${-I}em)`}],{duration:Number.isFinite(P)?P:0,delay:Number.isFinite(L)?L:0,id:"float-word",composite:"add",fill:"both",easing:"ease-out"});return F.pause(),F}initEmphasizeAnimation(R,T,L,P){const I=Math.max(0,P);let F=Math.max(1e3,L),D=[],V=F/2e3;V=V>1?Math.sqrt(V):V**3;let q=F/3e3;q=q>1?Math.sqrt(q):q**3,V*=.6,q*=.5,this.lyricLine.words.length>0&&R.word.includes(this.lyricLine.words[this.lyricLine.words.length-1].word)&&(V*=1.6,q*=1.5,F*=1.2),V=Math.min(1.2,V),q=Math.min(.8,q);const G=Number.isFinite(F)?F:0,z=Is(Vt);return D=T.flatMap((Q,J,tt)=>{const yt=I+F/2.5/tt.length*J,At=[],gt=new Array(St).fill(0).map((Se,Ht)=>{const Le=(Ht+1)/St,ee=z(Le),si=z(Le)*q,ci=ue(fe(),1+ee*.1*V),di=-ee*.03*V*(tt.length/2-J),ui=-ee*.025*V;return{offset:Le,transform:`${ye(ci,4)} translate(${di}em, ${ui}em)`,textShadow:`0 0 ${Math.min(.3,q*.3)}em rgba(255, 255, 255, ${si})`}}),Et=Q.animate(gt,{duration:G,delay:Number.isFinite(yt)?yt:0,id:`emphasize-word-${Q.innerText}-${J}`,iterations:1,composite:"replace",fill:"both"});Et.onfinish=()=>{Et.pause()},Et.pause(),At.push(Et);const kt=new Array(St).fill(0).map((Se,Ht)=>{const Le=(Ht+1)/St;let ee=Math.sin(Le*Math.PI);return this.lyricLine.isBG&&(ee*=2),{offset:Le,transform:`translateY(${-ee*.05}em)`}}),ne=Q.animate(kt,{duration:G*1.4,delay:Number.isFinite(yt)?yt-400:0,id:"emphasize-word-float",iterations:1,composite:"add",fill:"both"});return ne.onfinish=()=>{ne.pause()},ne.pause(),At.push(ne),At}),D}get totalDuration(){return this.lyricLine.endTime-this.lyricLine.startTime}onLineSizeChange(R){this.updateMaskImageSync()}updateMaskImageSync(){for(const R of this.splittedWords){const T=R.mainElement;T?(R.padding=Number.parseFloat(getComputedStyle(T).paddingLeft),R.width=T.clientWidth-R.padding*2,R.height=T.clientHeight-R.padding*2):(R.width=0,R.height=0,R.padding=0)}this.lyricPlayer.supportMaskImage?this.generateWebAnimationBasedMaskImage():this.generateCalcBasedMaskImage(),this.isEnabled&&this.enable(this.lyricPlayer.getCurrentTime())}generateCalcBasedMaskImage(){for(const R of this.splittedWords){const T=R.mainElement;if(T){R.width=T.clientWidth,R.height=T.clientHeight;const L=R.height*this.lyricPlayer.getWordFadeWidth(),[P,I]=ie(L/R.width),F=`${I*100}% 100%`;this.lyricPlayer.supportMaskImage?(T.style.maskImage=P,T.style.maskRepeat="no-repeat",T.style.maskOrigin="left",T.style.maskSize=F):(T.style.webkitMaskImage=P,T.style.webkitMaskRepeat="no-repeat",T.style.webkitMaskOrigin="left",T.style.webkitMaskSize=F);const D=R.width+L,V=`clamp(${-D}px,calc(${-D}px + (var(--amll-player-time) - ${R.startTime})*${D/Math.abs(R.endTime-R.startTime)}px),0px) 0px, left top`;T.style.maskPosition=V,T.style.webkitMaskPosition=V}}}generateWebAnimationBasedMaskImage(){const R=Math.max(this.splittedWords.reduce((T,L)=>Math.max(L.endTime,T),0),this.lyricLine.endTime)-this.lyricLine.startTime;this.splittedWords.forEach((T,L)=>{const P=T.mainElement;if(P){const I=T.height*this.lyricPlayer.getWordFadeWidth(),[F,D]=ie(I/(T.width+T.padding*2)),V=`${D*100}% 100%`;this.lyricPlayer.supportMaskImage?(P.style.maskImage=F,P.style.maskRepeat="no-repeat",P.style.maskOrigin="left",P.style.maskSize=V):(P.style.webkitMaskImage=F,P.style.webkitMaskRepeat="no-repeat",P.style.webkitMaskOrigin="left",P.style.webkitMaskSize=V);const q=this.splittedWords.slice(0,L).reduce((kt,ne)=>kt+ne.width,0)+(this.splittedWords[0]?I:0),G=-(T.width+T.padding*2+I),z=kt=>Math.max(G,Math.min(0,kt));let Q=-q-T.width-T.padding-I,J=0;const tt=[];let yt=Q,At=0;const gt=()=>{const kt=Q-yt,ne=Math.max(0,Math.min(1,J)),Se=ne-At,Ht=Math.abs(Se/kt);if(Q>G&&yt<G){const si=Math.abs(yt-G)*Ht,ci=`${z(yt)}px 0`,di={offset:At+si,maskPosition:ci};tt.push(di)}if(Q>0&&yt<0){const si=Math.abs(yt)*Ht,ci=`${z(Q)}px 0`,di={offset:At+si,maskPosition:ci};tt.push(di)}const Le=`${z(Q)}px 0`,ee={offset:ne,maskPosition:Le};tt.push(ee),yt=Q,At=ne};gt();let Et=0;this.splittedWords.forEach((kt,ne)=>{{const Se=kt.startTime-this.lyricLine.startTime,Ht=Se-Et;J+=Ht/R,Ht>0&&gt(),Et=Se}{const Se=kt.endTime-kt.startTime;J+=Se/R,Q+=kt.width,ne===0&&(Q+=I*1.5),ne===this.splittedWords.length-1&&(Q+=I*.5),Se>0&&gt(),Et+=Se}});for(const kt of T.maskAnimations)kt.cancel();try{const kt=P.animate(tt,{duration:R||1,id:`fade-word-${T.word}-${L}`,fill:"both"});kt.pause(),T.maskAnimations=[kt]}catch(kt){console.warn("应用渐变动画发生错误",tt,R,kt)}}})}getElement(){return this.element}setTransform(R=this.top,T=this.scale,L=1,P=0,I=!1,F=0){super.setTransform(R,T,L,P,I,F);const D=this.isInSight,V=this.lyricPlayer.getEnableSpring();this.top=R,this.scale=T,this.delay=F*1e3|0;const q=this.element.children[0];if(q.style.opacity=`${L}`,I||!V)if(this.blur=Math.min(32,P),this.lineTransforms.posY.setPosition(R),this.lineTransforms.scale.setPosition(T),V)this.rebuildStyle();else{const G=this.isInSight;D||G?this.show():this.hide()}else if(this.lineTransforms.posY.setTargetPosition(R,F),this.lineTransforms.scale.setTargetPosition(T),this.blur!==Math.min(32,P)){this.blur=Math.min(32,P);const G=P.toFixed(3);this.element.style.filter=`blur(${G}px)`}}update(R=0){if(this.lyricPlayer.getEnableSpring())if(this.lineTransforms.posY.update(R),this.lineTransforms.scale.update(R),this.isInSight?this.show():this.hide(),this.lyricPlayer.getEnableSpring())this.element.style.setProperty("--bright-mask-alpha",`${Math.max(0,Math.min(1,this.lineTransforms.scale.getCurrentPosition()/100-.97)/.03)*.8+.2}`),this.element.style.setProperty("--dark-mask-alpha",`${Math.max(0,Math.min(1,this.lineTransforms.scale.getCurrentPosition()/100-.97)/.03)*.2+.2}`);else{const T=window.getComputedStyle(this.element).transform,L=Ds(T);this.element.style.setProperty("--bright-mask-alpha",`${Math.max(0,Math.min(1,(L-.97)/.03))*.8+.2}`),this.element.style.setProperty("--dark-mask-alpha",`${Math.max(0,Math.min(1,(L-.97)/.03))*.2+.2}`)}}_getDebugTargetPos(){return`[位移: ${this.top}; 缩放: ${this.scale}; 延时: ${this.delay}]`}get isInSight(){var R;const T=this.lineTransforms.posY.getCurrentPosition(),L=((R=this.lyricPlayer.lyricLinesSize.get(this))==null?void 0:R[1])??0,P=T+L,I=this.lyricPlayer.size[1];return!(T>I+L||P<-L)}disposeElements(){var R,T;for(const L of this.splittedWords){for(const P of L.elementAnimations)P.cancel();for(const P of L.maskAnimations)P.cancel();for(const P of L.subElements)P.remove(),(R=P.parentNode)==null||R.removeChild(P);L.elementAnimations=[],L.maskAnimations=[],L.subElements=[],L.mainElement.remove(),(T=L.mainElement.parentNode)==null||T.removeChild(L.mainElement)}this.splittedWords=[]}dispose(){this.disposeElements(),this.lyricPlayer.resizeObserver.unobserve(this.element),this.element.remove()}};class Me extends MouseEvent{constructor(T,L,P){super(`line-${P.type}`,P),this.lineIndex=T,this.line=L}}class pi extends qt{constructor(){super(),f(this,"currentLyricLineObjects",[]),f(this,"supportPlusLighter",CSS.supports("mix-blend-mode","plus-lighter")),f(this,"supportMaskImage",CSS.supports("mask-image","none")),f(this,"innerSize",[0,0]),f(this,"onLineClickedHandler",T=>{const L=new Me(this.lyricLinesIndexes.get(T.line)??-1,T.line,T);this.dispatchEvent(L)||(T.preventDefault(),T.stopPropagation(),T.stopImmediatePropagation())}),f(this,"_baseFontSize",Number.parseFloat(getComputedStyle(this.element).fontSize)),this.onResize(),this.element.classList.add("amll-lyric-player","dom"),this.disableSpring&&this.element.classList.add(W.disableSpring)}onResize(){const T=getComputedStyle(this.element);this._baseFontSize=Number.parseFloat(T.fontSize),this.rebuildStyle()}_getIsNonDynamic(){return this.isNonDynamic}get baseFontSize(){return this._baseFontSize}rebuildStyle(){}setWordFadeWidth(T=.5){super.setWordFadeWidth(T);for(const L of this.currentLyricLineObjects)L.updateMaskImageSync()}setLyricLines(T,L=0){super.setLyricLines(T,L),this.hasDuetLine?this.element.classList.add(W.hasDuetLine):this.element.classList.remove(W.hasDuetLine),this.supportMaskImage||this.element.style.setProperty("--amll-player-time",`${L}`);for(const P of this.currentLyricLineObjects)P.removeMouseEventListener("click",this.onLineClickedHandler),P.removeMouseEventListener("contextmenu",this.onLineClickedHandler),P.dispose();this.currentLyricLineObjects=this.processedLines.map((P,I)=>{const F=new Fs(this,P);return F.addMouseEventListener("click",this.onLineClickedHandler),F.addMouseEventListener("contextmenu",this.onLineClickedHandler),this.element.appendChild(F.getElement()),this.lyricLinesIndexes.set(F,I),this.lyricLineElementMap.set(F.getElement(),F),F}),this.setLinePosXSpringParams({}),this.setLinePosYSpringParams({}),this.setLineScaleSpringParams({}),this.calcLayout(!0)}pause(){super.pause(),this.element.classList.remove("playing"),this.interludeDots.pause();for(const T of this.currentLyricLineObjects)T.pause()}resume(){super.resume(),this.element.classList.add("playing"),this.interludeDots.resume();for(const T of this.currentLyricLineObjects)T.resume()}update(T=0){if(!this.initialLayoutFinished||(super.update(T),this.supportMaskImage||this.element.style.setProperty("--amll-player-time",`${this.currentTime}`),!this.isPageVisible))return;const L=T/1e3;this.interludeDots.update(T),this.bottomLine.update(L);for(const P of this.currentLyricLineObjects)P.update(L)}dispose(){super.dispose(),this.element.remove();for(const T of this.currentLyricLineObjects)T.dispose();this.bottomLine.dispose(),this.interludeDots.dispose()}}It(.2,.4,.58,1);It(.3,0,.58,1);window.lyrics=lyrics;const DEFAULT_AMLL_COVER_URL=(()=>{if(typeof window<"u"){const R=window.__AMLL_DEFAULT_ALBUM__;if(typeof R=="string"&&R.trim())return R}return"./icons/icon-512x512.png"})(),originalFetch=typeof window<"u"?window.fetch.bind(window):null;function normalizeBackendUrl(R){if(!R||R[0]!==":")return R;const T=/^:(\d+)(\/.*)?$/.exec(R);if(!T)return R;const[,L,P=""]=T,I=window.location?.protocol||"http:",F=window.location?.hostname||"127.0.0.1";return`${I}//${F}:${L}${P}`}originalFetch&&(window.fetch=((R,T)=>(typeof R=="string"&&(R=normalizeBackendUrl(R)),originalFetch(R,T))));function resolveDefaultCover(R){const T=typeof R=="string"?R.trim():"";return T||DEFAULT_AMLL_COVER_URL}const SETTINGS_STORAGE_KEY="amll_background_settings",DEFAULT_PLAYER_STATE={musicUrl:"",lyricUrl:"",coverUrl:"",songTitle:"",songArtist:"",isPlaying:!1,currentTime:0,duration:0,loopPlay:!0,autoPlay:!0,playbackRate:1,volume:50,lyricDelay:0,backgroundType:"fluid",backgroundDynamic:!0,backgroundFlowSpeed:4,backgroundColorMask:!0,backgroundMaskColor:"#FFFFFF",invertColors:!1,originalInvertColors:!1,coverBlurLevel:100,manualDominantColor:null,manualDominantColorLight:null,manualDominantColorDark:null,backgroundMaskOpacity:70,showFPS:!1,marqueeEnabled:!0,roundedCover:55,coverRotationSpeed:0,backgroundRenderScale:1,backgroundFPS:60,lyricAlignPosition:.4,lyricFontSize:100,hidePassedLyrics:!1,enableLyricBlur:!0,enableLyricScale:!0,enableLyricSpring:!0,wordFadeWidth:.5,lyricAlignAnchor:"center",showRemainingTime:!1,showTranslatedLyric:!0,showRomanLyric:!0,swapLyricPositions:!1,showbgLyric:!0,swapDuetsPositions:!1,advanceLyricTiming:!1,singleLyrics:!1,backgroundLowFreqVolume:1,backgroundBeatEnabled:!1,coverStyle:"normal",posYSpringMass:1,posYSpringDamping:15,posYSpringStiffness:100,posYSpringSoft:!1,scaleSpringMass:1,scaleSpringDamping:20,scaleSpringStiffness:100,scaleSpringSoft:!1,isRangeMode:!1,rangeStartTime:0,rangeEndTime:0},cloneDefaultState=()=>JSON.parse(JSON.stringify(DEFAULT_PLAYER_STATE)),BOOLEAN_TRUE_VALUES=new Set(["1","true","yes","on"]),BOOLEAN_FALSE_VALUES=new Set(["0","false","no","off"]),AMLL_PALETTE_PIXELATE=10,AMLL_PALETTE_TARGET=16,AMLL_LIGHTNESS_MIN_DELTA=-25,AMLL_LIGHTNESS_MAX_DELTA=100,AMLL_NOISE_SCALE=15,AMLL_DARKEN_MAX=40,AMLL_BEAT_CURVE_MAGIC="AMBG",AMLL_BEAT_CURVE_MAGIC_LEVELS="AMBC",AMLL_GAIN_MIN=.6,AMLL_GAIN_MAX=3,clamp=(R,T,L)=>Math.min(Math.max(R,T),L),lerp=(R,T,L)=>R+(T-R)*L,hexToHsl=R=>{if(!R||typeof R!="string")return null;let T=R.trim().replace("#","");if(T.length===3&&(T=T.split("").map(Q=>Q+Q).join("")),T.length!==6)return null;const L=parseInt(T.slice(0,2),16)/255,P=parseInt(T.slice(2,4),16)/255,I=parseInt(T.slice(4,6),16)/255,F=Math.max(L,P,I),D=Math.min(L,P,I);let V=0,q=0;const G=(F+D)/2,z=F-D;if(z!==0){switch(q=z/(1-Math.abs(2*G-1)),F){case L:V=(P-I)/z%6;break;case P:V=(I-L)/z+2;break;default:V=(L-P)/z+4;break}V*=60,V<0&&(V+=360)}return{h:Math.round(V),s:Math.round(q*100),l:Math.round(G*100)}},hslToRgb=(R,T,L)=>{const P=clamp(T,0,100)/100,I=clamp(L,0,100)/100,F=(1-Math.abs(2*I-1))*P,D=F*(1-Math.abs(R/60%2-1)),V=I-F/2;let q=0,G=0,z=0;return R>=0&&R<60?(q=F,G=D):R<120?(q=D,G=F):R<180?(G=F,z=D):R<240?(G=D,z=F):R<300?(q=D,z=F):(q=F,z=D),{r:q+V,g:G+V,b:z+V}};function parseBooleanParam(R){const T=R.trim().toLowerCase();return BOOLEAN_TRUE_VALUES.has(T)?!0:BOOLEAN_FALSE_VALUES.has(T)?!1:T.length>0}function parseUrlParamValue(R,T){if(typeof T=="boolean")return parseBooleanParam(R);if(typeof T=="number"){const L=Number(R);return Number.isNaN(L)?void 0:L}return R}function parseVolumeAlias(R){const T=Number(R);if(!Number.isNaN(T)){if(T>1&&T<=100)return Math.round(T);if(T>=0&&T<=1)return Math.round(T*100);if(T>100)return 100;if(T<0)return 0}}const URL_METADATA_STATE_KEYS=["musicUrl","lyricUrl","coverUrl","songTitle","songArtist","currentTime","duration","isPlaying"],STYLE_PARAM_KEYS=Object.keys(DEFAULT_PLAYER_STATE).filter(R=>!URL_METADATA_STATE_KEYS.includes(R)),URL_ALIAS_CONFIG={ms:{property:"lyricDelay"},x:{property:"playbackRate"},vol:{property:"volume",parse:R=>parseVolumeAlias(R)},loop:{property:"loopPlay",parse:R=>parseBooleanParam(R)},auto:{property:"autoPlay",parse:R=>parseBooleanParam(R)},t:{property:"rangeStartTime",parse:R=>{const T=Number(R);return Number.isNaN(T)?void 0:T}},te:{property:"rangeEndTime",parse:R=>{const T=Number(R);return Number.isNaN(T)?void 0:T}}};class WebLyricsPlayer{audio;lyricPlayer;background;coverBlurBackground;beatCurvePollTimer=null;beatCurveRequestInFlight=!1;beatCurvePath=null;beatState={basePaletteHsl:[],analyser:null,audioContext:null,freqData:null,rafId:null,renderer:null,enabled:!1,lastColors:null,smoothing:.12,originalMeshColors:null,originalMeshSize:null,bandStats:[],globalEnergy:0,beatCurve:null};coverBlurBaseScale=1.1;stats;state;rangeStartLine=null;rangeEndLine=null;rangeProgressBar=null;rangeSelectionCount=0;isInitialized=!1;hasLyrics=!1;gui=null;urlOverrides=new Set;colorThief;static debounce(R,T){let L=null;return function(...I){const F=()=>{L&&clearTimeout(L),R(...I)};L&&clearTimeout(L),L=window.setTimeout(F,T)}}dominantColor="#fd9c9b";marqueeObserver=null;handleResizeBound=null;titleMarqueeInterval=null;mediaSessionRefreshTimeout=null;originalTitle="";originalLyricLines=[];processedLyricLines=[];musicFile=null;lyricFile=null;coverFile=null;musicFileBtn=null;lyricFileBtn=null;coverFileBtn=null;songTitleInput=null;songArtistInput=null;albumCoverLarge=null;albumCoverContainer=null;roundedCoverSlider=null;roundedCoverValue=null;coverRotationSlider=null;coverRotationValue=null;coverStyleSelect=null;songTitle=null;songArtist=null;albumInfo=null;timeDisplay=null;progressBar=null;progressFill=null;lyricsPanel=null;player=null;playButton=null;landscapePlayBtn=null;controlPanel=null;fullscreenButton=null;fullscreenEnterIcon=null;fullscreenExitIcon=null;status=null;statusText=null;bgFlowSpeed=null;bgFlowSpeedValue=null;bgColorMask=null;bgMaskColor=null;bgMaskOpacity=null;bgMaskOpacityValue=null;showFPSCheckbox=null;backgroundStyleSelect=null;coverBlurLevel=null;coverBlurLevelValue=null;invertColorsCheckbox=null;dominantColorInput=null;dominantColorLightInput=null;dominantColorDarkInput=null;enableMarqueeCheckbox=null;bgRenderScale=null;fluidDesc=null;coverDesc=null;solidDesc=null;solidOptions=null;recordOptions=null;bgRenderScaleValue=null;bgFPS=null;bgFPSValue=null;lyricAlignPosition=null;lyricAlignPositionValue=null;lyricFontSize=null;lyricFontSizeValue=null;hidePassedLyricsCheckbox=null;bgLowFreqVolume=null;bgLowFreqVolumeValue=null;backgroundBeatCheckbox=null;enableLyricBlur=null;enableLyricScale=null;enableLyricSpring=null;wordFadeWidthInput=null;wordFadeWidthValue=null;showbgLyricCheckbox=null;swapDuetsPositionsCheckbox=null;advanceLyricTimingCheckbox=null;singleLyricsCheckbox=null;playbackRateValue=null;playbackRateControl=null;volumeControl=null;volumeValue=null;speedLowIcon=null;speedMediumIcon=null;speedHighIcon=null;volumeOffIcon=null;volumeLowIcon=null;volumeMediumIcon=null;volumeHighIcon=null;loopPlayCheckbox=null;musicUrl=null;lyricUrl=null;coverUrl=null;albumSidePanel=null;loadFromUrlBtn=null;hasAutoLoadedFromUrl=!1;urlLyricDelayOverride=null;pendingControlPointCodeFromUrl=null;loadFilesBtn=null;resetPlayerBtn=null;toggleControlsBtn=null;lyricAlignAnchorSelect=null;lyricDelayInput=null;pendingLyricDelay=null;amllLyricPlayer=null;lyricAreaHint=null;coverStyleDynamic=null;songTitleDisplay=null;songArtistDisplay=null;landscapeTimeDisplay=null;landscapeProgressFill=null;landscapeCover=null;playControls=null;showTranslatedLyricCheckbox=null;showRomanLyricCheckbox=null;swapLyricPositionsCheckbox=null;waveformCanvas=null;waveformContext=null;cachedWaveform=null;audioBuffer=null;touchExitTimeout=null;posYSpringMassInput=null;posYSpringDampingInput=null;posYSpringStiffnessInput=null;posYSpringSoftCheckbox=null;scaleSpringMassInput=null;scaleSpringDampingInput=null;scaleSpringStiffnessInput=null;scaleSpringSoftCheckbox=null;springPosYMassValue=null;springPosYDampingValue=null;springPosYStiffnessValue=null;springScaleMassValue=null;springScaleDampingValue=null;springScaleStiffnessValue=null;controlPointCodeInput=null;initI18n(){document.documentElement.lang=getCurrentLanguage(),document.querySelectorAll("[data-i18n]").forEach(L=>{const P=L.getAttribute("data-i18n");P&&(L.textContent=t$3(P))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(L=>{const P=L.getAttribute("data-i18n-placeholder");P&&(L.placeholder=t$3(P))})}initUploadButtons(){this.musicFile&&this.musicFile.addEventListener("change",R=>{const T=R.target.files?.[0];if(!this.musicFileBtn)return;const L=this.musicFileBtn.querySelector(".upload-icon"),P=this.musicFileBtn.querySelector(".uploaded-icon");L&&P&&(L.style.display=T?"none":"block",P.style.display=T?"block":"none")}),this.lyricFile&&this.lyricFile.addEventListener("change",R=>{const T=R.target.files?.[0],L=this.lyricFileBtn?.querySelector(".upload-icon"),P=this.lyricFileBtn?.querySelector(".uploaded-icon");L&&P&&(L.style.display=T?"none":"block",P.style.display=T?"block":"none")}),this.coverFile&&this.coverFile.addEventListener("change",R=>{const T=R.target.files?.[0],L=this.coverFileBtn?.querySelector(".upload-icon"),P=this.coverFileBtn?.querySelector(".uploaded-icon");L&&P&&(L.style.display=T?"none":"block",P.style.display=T?"block":"none")})}updateRoundedCover(){if(this.albumCoverLarge&&this.albumCoverContainer){const R=this.state.roundedCover/100*50;this.albumCoverLarge.style.borderRadius=`${R}%`,this.albumCoverContainer.style.borderRadius=`${R}%`,document.documentElement.style.setProperty("--rounded-cover-percent",R.toString())}this.roundedCoverSlider&&(this.roundedCoverSlider.value=this.state.roundedCover.toString()),this.roundedCoverValue&&(this.roundedCoverValue.textContent=`${this.state.roundedCover}%`),this.setOptionsVisibility(this.recordOptions,this.state.roundedCover===100,["cd","vinyl","colored"]),this.applyCoverStyle()}updateLyricFontSize(){const R=this.state.lyricFontSize/100;console.log("Setting font size scale to:",R,"from value:",this.state.lyricFontSize);const T=window.innerWidth<=768;let L;if(T){const F=window.innerWidth*.08;L=Math.max(F,12)}else{const F=window.innerHeight*.047,D=window.innerWidth*.032;L=Math.max(F,D,12)}const P=L*R,I=document.querySelectorAll(".amll-lyric-player");if(console.log(`Found ${I.length} lyric player elements`),I.forEach((F,D)=>{F.style.setProperty("--amll-lp-font-size",`${P}px`),console.log(`Set --amll-lp-font-size on lyric player element ${D}: ${P}px`)}),this.lyricFontSize&&(this.lyricFontSize.value=this.state.lyricFontSize.toString()),this.lyricFontSizeValue&&(this.lyricFontSizeValue.textContent=`${this.state.lyricFontSize}%`),I.length>0){const F=I[0],D=getComputedStyle(F).fontSize;console.log("Computed font size on first lyric player:",D)}}extractComputedFontSize(R){const T=R.match(/([\d.]+)px/);return T?parseFloat(T[1]):16}updateCoverRotation(){this.albumCoverLarge&&this.albumCoverContainer&&(this.albumCoverLarge.style.animation="none",this.state.coverRotationSpeed!==0?this.applyCoverRotation(this.albumCoverLarge,this.albumCoverContainer):this.audio.paused?(this.albumCoverContainer.style.transform="scale(0.96)",this.albumCoverLarge.style.transform="scale(1)"):(this.albumCoverContainer.style.transform="scale(1)",this.albumCoverLarge.style.transform="scale(1)")),this.coverRotationSlider&&(this.coverRotationSlider.value=this.state.coverRotationSpeed.toString()),this.coverRotationValue&&(this.coverRotationValue.textContent=`${this.state.coverRotationSpeed}rpm`)}applyCoverRotation(R,T){const P=60/Math.abs(this.state.coverRotationSpeed),I=this.state.coverRotationSpeed>0?"spin":"spinCounterclockwise";R.style.animation=`${I} ${P}s linear infinite`,this.audio.paused||R.matches(":hover")?(R.style.animationPlayState="paused",T.style.transform="scale(0.96)",R.style.transform="scale(1)"):(R.style.animationPlayState="running",T.style.transform="scale(1)",R.style.transform="scale(1)")}checkAndUpdateMarquee(R){if(R){if(!this.state.marqueeEnabled){R.classList.remove("marquee"),R.style.setProperty("--marquee-play-state","paused");return}requestAnimationFrame(()=>{const T=R.textContent||"",L=Math.min(5,Math.ceil(600/T.length)),P=Array(L).fill(T).join("            ");R.getAttribute("data-text")!==P?(R.setAttribute("data-text",P),requestAnimationFrame(()=>{R.scrollWidth>R.clientWidth?(R.classList.contains("marquee")||(R.classList.remove("marquee"),R.offsetWidth,R.classList.add("marquee")),R.style.setProperty("--marquee-play-state",this.audio.paused?"paused":"running")):R.classList.remove("marquee")})):R.scrollWidth>R.clientWidth?(R.classList.contains("marquee")||(R.classList.remove("marquee"),R.offsetWidth,R.classList.add("marquee")),R.style.setProperty("--marquee-play-state",this.audio.paused?"paused":"running")):R.classList.remove("marquee")})}}updateMarqueeSettings(){const R=this.songTitle,T=this.songArtist,L=()=>{if(this.titleMarqueeInterval&&(clearInterval(this.titleMarqueeInterval),this.titleMarqueeInterval=null),this.originalTitle||(this.originalTitle=document.title),this.state.marqueeEnabled&&(this.state.songTitle||this.state.songArtist)){const F=`${`${this.state.songArtist?this.state.songArtist+" - ":""}${this.state.songTitle}`} | AMLL Web Player`;if(F.length>50){let D=0;const V=()=>{if(!this.state.marqueeEnabled||this.audio.paused){document.title=F;return}const q=50;let G=F;if(F.length>q){const z=D%F.length;G=F.substring(z)+" "+F.substring(0,Math.min(z,q)),G=G.substring(0,q)}document.title=G,D++};V(),this.audio.paused||(this.titleMarqueeInterval=window.setInterval(V,300))}else document.title=F}else if(this.state.songTitle||this.state.songArtist){const I=`${this.state.songArtist?this.state.songArtist+" - ":""}${this.state.songTitle}`;document.title=`${I} | AMLL Web Player`}else document.title=this.originalTitle||"AMLL Web Player"};L(),this.marqueeObserver&&this.marqueeObserver.disconnect(),this.marqueeObserver=new MutationObserver(()=>{R&&(R.classList.remove("marquee"),this.checkAndUpdateMarquee(R)),T&&(T.classList.remove("marquee"),this.checkAndUpdateMarquee(T)),L()}),R&&this.marqueeObserver.observe(R,{childList:!0,subtree:!0,characterData:!0}),T&&this.marqueeObserver.observe(T,{childList:!0,subtree:!0,characterData:!0}),this.checkAndUpdateMarquee(R),this.checkAndUpdateMarquee(T),this.handleResizeBound&&window.removeEventListener("resize",this.handleResizeBound);const P=WebLyricsPlayer.debounce(()=>{R&&(R.classList.remove("marquee"),R.offsetWidth,this.checkAndUpdateMarquee(R)),T&&(T.classList.remove("marquee"),T.offsetWidth,this.checkAndUpdateMarquee(T)),this.updateWaveformCanvasSize(),this.updateLayoutByOrientation()},100);this.handleResizeBound=P.bind(this),window.addEventListener("resize",this.handleResizeBound)}updateLayoutByOrientation(){const R=window.matchMedia("(orientation: portrait)").matches,T=this.albumSidePanel?.querySelector(".song-info-container");R?this.state.swapDuetsPositions?T&&this.albumInfo&&this.albumCoverContainer&&(T.insertBefore(this.albumInfo,this.albumCoverContainer),this.albumCoverContainer.style.marginRight="0",this.albumCoverContainer.style.marginLeft="15px",this.albumInfo.style.textAlign="right"):T&&this.albumInfo&&this.albumCoverContainer&&(T.insertBefore(this.albumCoverContainer,this.albumInfo),this.albumCoverContainer.style.marginLeft="0",this.albumCoverContainer.style.marginRight="15px",this.albumInfo.style.textAlign="left"):(T&&this.albumInfo&&this.albumCoverContainer&&(T.insertBefore(this.albumCoverContainer,this.albumInfo),this.albumCoverContainer.style.marginLeft="0",this.albumCoverContainer.style.marginRight="15px",this.albumInfo.style.textAlign="center"),this.albumSidePanel&&this.lyricsPanel&&this.player&&(this.state.swapDuetsPositions?this.player.insertBefore(this.lyricsPanel,this.albumSidePanel):this.player.insertBefore(this.albumSidePanel,this.lyricsPanel))),this.updateLyricsDisplay()}resetUploadButtons(){const R=document.querySelectorAll(".upload-icon"),T=document.querySelectorAll(".uploaded-icon");R.forEach(L=>{L.style.display="block"}),T.forEach(L=>{L.style.display="none"})}setOptionsVisibility(R,T,L=[]){R&&(R.forEach(P=>{const I=P;T?(I.disabled=!1,I.classList.remove("option-hidden")):(I.disabled=!0,I.classList.add("option-hidden"))}),L.length>0&&this.coverStyleSelect&&L.includes(this.coverStyleSelect.value)&&(this.coverStyleSelect.value="normal",this.state.coverStyle="normal",this.applyCoverStyle()))}initDOMCache(){document.title&&(document.title=`[DEBUG ${Date.now()}] `+document.title),this.musicFile=document.getElementById("musicFile"),this.lyricFile=document.getElementById("lyricFile"),this.coverFile=document.getElementById("coverFile"),this.musicFileBtn=document.getElementById("musicFileBtn"),this.lyricFileBtn=document.getElementById("lyricFileBtn"),this.coverFileBtn=document.getElementById("coverFileBtn"),this.songTitleInput=document.getElementById("songTitleInput"),this.songArtistInput=document.getElementById("songArtistInput"),this.albumCoverLarge=document.getElementById("albumCoverLarge"),this.albumCoverContainer=document.getElementById("albumCoverContainer"),this.albumInfo=document.getElementById("albumInfo"),this.roundedCoverSlider=document.getElementById("roundedCover"),this.roundedCoverValue=document.getElementById("roundedCoverValue"),this.coverRotationSlider=document.getElementById("coverRotation"),this.coverRotationValue=document.getElementById("coverRotationValue"),this.coverStyleSelect=document.getElementById("coverStyle"),this.songTitle=document.getElementById("songTitle"),this.songArtist=document.getElementById("songArtist"),this.timeDisplay=document.getElementById("timeDisplay"),this.progressBar=document.getElementById("progressBar"),this.progressFill=document.getElementById("progressFill"),this.waveformCanvas=document.getElementById("waveformCanvas"),this.lyricsPanel=document.getElementById("lyricsPanel"),this.player=document.getElementById("player"),this.playButton=document.getElementById("playPauseBtn"),this.landscapePlayBtn=document.getElementById("landscapePlayBtn"),this.controlPanel=document.getElementById("controlPanel"),this.fullscreenButton=document.getElementById("fullscreenBtn"),this.fullscreenEnterIcon=document.querySelector(".fullscreen-enter"),this.fullscreenExitIcon=document.querySelector(".fullscreen-exit"),this.status=document.getElementById("status"),this.statusText=document.getElementById("statusText"),this.bgFlowSpeed=document.getElementById("bgFlowSpeed"),this.bgFlowSpeedValue=document.getElementById("bgFlowSpeedValue"),this.bgColorMask=document.getElementById("bgColorMask"),this.bgMaskColor=document.getElementById("bgMaskColor"),this.bgMaskOpacity=document.getElementById("bgMaskOpacity"),this.bgMaskOpacityValue=document.getElementById("bgMaskOpacityValue"),this.showFPSCheckbox=document.getElementById("showFPS"),this.bgFPS=document.getElementById("bgFPS"),this.bgFPSValue=document.getElementById("bgFPSValue"),this.backgroundStyleSelect=document.getElementById("backgroundStyle"),this.albumSidePanel=document.getElementById("albumSidePanel"),this.coverBlurLevel=document.getElementById("coverBlurLevel"),this.coverBlurLevelValue=document.getElementById("coverBlurLevelValue"),this.invertColorsCheckbox=document.getElementById("invertColors"),this.dominantColorInput=document.getElementById("dominantColor"),this.dominantColorLightInput=document.getElementById("dominantColorLight"),this.dominantColorDarkInput=document.getElementById("dominantColorDark"),this.enableMarqueeCheckbox=document.getElementById("enableMarquee"),this.bgRenderScale=document.getElementById("bgRenderScale"),this.bgRenderScaleValue=document.getElementById("bgRenderScaleValue"),this.lyricAlignPosition=document.getElementById("lyricAlignPosition"),this.lyricAlignPositionValue=document.getElementById("lyricAlignPositionValue");const R=document.getElementById("lyricFontSize");if(R)R.setAttribute("title","DEBUG: Element found!");else{const L=document.createElement("div");L.id="debug-info",L.style.cssText="position: fixed; top: 10px; left: 10px; background: red; color: white; padding: 5px; z-index: 9999;",L.textContent="DEBUG: lyricFontSize element NOT FOUND!",document.body.appendChild(L)}this.lyricFontSize=R;const T=document.getElementById("lyricFontSizeValue");T&&T.setAttribute("title","DEBUG: Value element found!"),this.lyricFontSizeValue=T,this.hidePassedLyricsCheckbox=document.getElementById("hidePassedLyrics"),this.bgLowFreqVolume=document.getElementById("bgLowFreqVolume"),this.bgLowFreqVolumeValue=document.getElementById("bgLowFreqVolumeValue"),this.backgroundBeatCheckbox=document.getElementById("backgroundBeat"),this.enableLyricBlur=document.getElementById("enableLyricBlur"),this.enableLyricScale=document.getElementById("enableLyricScale"),this.enableLyricSpring=document.getElementById("enableLyricSpring"),this.wordFadeWidthInput=document.getElementById("wordFadeWidth"),this.wordFadeWidthValue=document.getElementById("wordFadeWidthValue"),this.showbgLyricCheckbox=document.getElementById("showbgLyric"),this.swapDuetsPositionsCheckbox=document.getElementById("swapDuetsPositions"),this.advanceLyricTimingCheckbox=document.getElementById("advanceLyricTiming"),this.singleLyricsCheckbox=document.getElementById("singleLyrics"),this.playbackRateValue=document.getElementById("playbackRateValue"),this.playbackRateControl=document.getElementById("playbackRate"),this.volumeControl=document.getElementById("volumeControl"),this.volumeValue=document.getElementById("volumeValue"),this.speedLowIcon=document.querySelector(".speed-low"),this.speedMediumIcon=document.querySelector(".speed-medium"),this.speedHighIcon=document.querySelector(".speed-high"),this.volumeOffIcon=document.querySelector(".volume-off"),this.volumeLowIcon=document.querySelector(".volume-low"),this.volumeMediumIcon=document.querySelector(".volume-medium"),this.volumeHighIcon=document.querySelector(".volume-high"),this.loopPlayCheckbox=document.getElementById("loopPlay"),this.showTranslatedLyricCheckbox=document.getElementById("showTranslatedLyric"),this.showRomanLyricCheckbox=document.getElementById("showRomanLyric"),this.swapLyricPositionsCheckbox=document.getElementById("swapLyricPositions"),this.musicUrl=document.getElementById("musicUrl"),this.lyricUrl=document.getElementById("lyricUrl"),this.coverUrl=document.getElementById("coverUrl"),this.loadFromUrlBtn=document.getElementById("loadFromUrl"),this.loadFilesBtn=document.getElementById("loadFiles"),this.resetPlayerBtn=document.getElementById("resetPlayer"),this.toggleControlsBtn=document.getElementById("toggleControls"),this.lyricAlignAnchorSelect=document.getElementById("lyricAlignAnchor"),this.lyricDelayInput=document.getElementById("lyricDelayInput"),this.posYSpringMassInput=document.getElementById("springPosYMass"),this.posYSpringDampingInput=document.getElementById("springPosYDamping"),this.posYSpringStiffnessInput=document.getElementById("springPosYStiffness"),this.scaleSpringMassInput=document.getElementById("springScaleMass"),this.scaleSpringDampingInput=document.getElementById("springScaleDamping"),this.scaleSpringStiffnessInput=document.getElementById("springScaleStiffness"),this.springPosYMassValue=document.getElementById("springPosYMassValue"),this.springPosYDampingValue=document.getElementById("springPosYDampingValue"),this.springPosYStiffnessValue=document.getElementById("springPosYStiffnessValue"),this.springScaleMassValue=document.getElementById("springScaleMassValue"),this.springScaleDampingValue=document.getElementById("springScaleDampingValue"),this.springScaleStiffnessValue=document.getElementById("springScaleStiffnessValue"),this.posYSpringSoftCheckbox=document.getElementById("posYSpringSoft"),this.scaleSpringSoftCheckbox=document.getElementById("scaleSpringSoft"),this.controlPointCodeInput=document.getElementById("controlPointCode"),this.amllLyricPlayer=document.getElementById("amll-lyric-player"),this.lyricAreaHint=document.getElementById("lyricAreaHint"),this.coverStyleDynamic=document.getElementById("coverStyleDynamic"),this.songTitleDisplay=document.getElementById("songTitleDisplay"),this.songArtistDisplay=document.getElementById("songArtistDisplay"),this.fluidDesc=document.getElementById("fluid-desc"),this.coverDesc=document.getElementById("cover-desc"),this.solidDesc=document.getElementById("solid-desc"),this.landscapeTimeDisplay=document.querySelector(".landscape-time"),this.landscapeProgressFill=document.querySelector(".landscape-progress-fill"),this.landscapeCover=document.querySelector(".landscape-cover"),this.playControls=document.getElementById("playControls"),this.solidOptions=document.querySelectorAll(".solid-option"),this.recordOptions=document.querySelectorAll(".record-option")}constructor(){this.initI18n(),this.audio=document.createElement("audio"),this.state=cloneDefaultState(),this.audio.volume=this.state.volume/100,this.audio.playbackRate=this.state.playbackRate,this.audio.preload="auto",this.colorThief=new u$2,this.lyricPlayer=new pi;const R=this.lyricPlayer.getElement();R&&(R.style.width="100%",R.style.height="100%",R.style.zIndex="30",R.style.position="relative"),this.hasLyrics=!1,this.setDefaultColors(),this.initColors(),this.background=ce.new(hi),this.coverBlurBackground=document.createElement("div"),this.stats=new Stats,this.initDOMCache(),this.waveformCanvas&&(this.waveformContext=this.waveformCanvas.getContext("2d")),this.initEventListeners(),this.initBackground(),this.setupAudioEvents(),this.setupLyricEvents(),this.setupWaveformEvents(),this.initStats(),this.initUI(),this.initLyricDisplayControls(),this.updateMarqueeSettings()}setupWheelControl(R,T,L){let P=null,I=null;switch(R){case"coverBlurLevel":P=this.coverBlurLevel,I=this.coverBlurLevelValue;break;case"bgFlowSpeed":P=this.bgFlowSpeed,I=this.bgFlowSpeedValue;break;case"bgMaskOpacity":P=this.bgMaskOpacity,I=this.bgMaskOpacityValue;break;case"volume":P=this.volumeControl,I=this.volumeValue;break;case"playbackRate":P=this.playbackRateControl,I=this.playbackRateValue;break;case"roundedCover":P=this.roundedCoverSlider,I=this.roundedCoverValue;break;case"coverRotation":P=this.coverRotationSlider,I=this.coverRotationValue;break;case"bgRenderScale":P=this.bgRenderScale,I=this.bgRenderScaleValue;break;case"bgFPS":P=this.bgFPS,I=this.bgFPSValue;break;case"lyricAlignPosition":P=this.lyricAlignPosition,I=this.lyricAlignPositionValue;break;case"lyricFontSize":P=this.lyricFontSize,I=this.lyricFontSizeValue;break;case"springPosYMass":P=this.posYSpringMassInput,I=document.getElementById("springPosYMassValue");break;case"springPosYDamping":P=this.posYSpringDampingInput,I=document.getElementById("springPosYDampingValue");break;case"springPosYStiffness":P=this.posYSpringStiffnessInput,I=document.getElementById("springPosYStiffnessValue");break;case"springScaleMass":P=this.scaleSpringMassInput,I=document.getElementById("springScaleMassValue");break;case"springScaleDamping":P=this.scaleSpringDampingInput,I=document.getElementById("springScaleDampingValue");break;case"springScaleStiffness":P=this.scaleSpringStiffnessInput,I=document.getElementById("springScaleStiffnessValue");break;default:return}!P||!I||P.addEventListener("wheel",F=>{F.preventDefault();const D=Math.sign(F.deltaY)*-1,V=parseFloat(P.value),q=parseFloat(P.min),G=parseFloat(P.max),z=Math.min(G,Math.max(q,V+D*L));P.value=z.toString(),R.startsWith("spring")?I.textContent=z.toString():I.textContent=`${z}${R==="bgFlowSpeed"?"":"%"}`,P.dispatchEvent(new Event("input"))},{passive:!1})}initGUI(){this.gui=new GUI,this.gui.hide(),this.gui.close();const R={dynamicBackground:!0,flowSpeed:4,toggleBackground(){this.dynamicBackground=!this.dynamicBackground,window.player.getBackground().setStaticMode(!this.dynamicBackground)}},T=this.gui.addFolder(t$3("backgroundControl"));T.add(R,"flowSpeed",0,10,.1).name(t$3("flowSpeed")).onChange(L=>{L===0?window.player.getBackground().setStaticMode(!0):(window.player.getBackground().setStaticMode(!1),window.player.getBackground().setFlowSpeed(L))}),T.add(R,"toggleBackground").name(t$3("toggleBackgroundMode"))}initEventListeners(){this.setupDragAndDropEvents();const R=window.matchMedia("(orientation: portrait)"),T=WebLyricsPlayer.debounce(()=>{this.updateLayoutByOrientation()},100);R.addEventListener("change",T),this.timeDisplay&&(this.timeDisplay.addEventListener("click",()=>{this.state.showRemainingTime=!this.state.showRemainingTime,this.updateTimeDisplay(),this.saveBackgroundSettings()}),this.timeDisplay.style.cursor="pointer"),this.landscapeTimeDisplay&&(this.landscapeTimeDisplay.addEventListener("click",()=>{this.state.showRemainingTime=!this.state.showRemainingTime,this.updateTimeDisplay(),this.saveBackgroundSettings()}),this.landscapeTimeDisplay.style.cursor="pointer"),this.roundedCoverSlider?.addEventListener("input",F=>{const D=parseInt(F.target.value);this.state.roundedCover=D,D!==100&&this.state.coverRotationSpeed!==0&&(this.state.coverRotationSpeed=0,this.updateCoverRotation(),this.coverRotationValue&&(this.coverRotationValue.textContent="0rpm")),this.updateRoundedCover(),this.saveBackgroundSettings()}),this.coverRotationSlider&&this.coverRotationSlider.addEventListener("input",F=>{if(this.state.roundedCover===100){const D=parseInt(F.target.value);this.state.coverRotationSpeed=D,this.updateCoverRotation(),this.coverRotationValue&&(this.coverRotationValue.textContent=`${D}rpm`),this.saveBackgroundSettings()}else this.state.coverRotationSpeed=0,this.updateCoverRotation(),this.coverRotationValue&&(this.coverRotationValue.textContent="0rpm"),F.target.value="0"}),this.coverBlurLevel?.addEventListener("input",F=>{const D=parseFloat(F.target.value),V=D/100*100;this.coverBlurBackground.style.filter=`blur(${V}px)`,this.coverBlurLevelValue&&(this.coverBlurLevelValue.textContent=`${D}%`),this.state.coverBlurLevel=D,this.saveBackgroundSettings()}),this.coverStyleSelect?.addEventListener("change",F=>{const D=F.target;this.state.coverStyle=D.value,this.applyCoverStyle(),this.saveBackgroundSettings()}),this.coverStyleSelect?.addEventListener("wheel",F=>{F.preventDefault();const D=F.target,V=D.options,q=D.selectedIndex,G=Math.sign(F.deltaY);let z=q+(G>0?1:-1);const Q=["cd","vinyl","colored","neumorphismA","neumorphismB"],J=this.state.roundedCover===100;let tt=0;const yt=V.length;for(;tt<yt;){z<0&&(z=V.length-1),z>=V.length&&(z=0);const At=V[z].value;if(Q.includes(At)&&!J){z+=G>0?1:-1,tt++;continue}break}z<0&&(z=V.length-1),z>=V.length&&(z=0),D.selectedIndex=z,D.dispatchEvent(new Event("change"))},{passive:!1}),this.bgRenderScale?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.backgroundRenderScale=D;const V=window.devicePixelRatio||1;this.background.setRenderScale(D*V),this.bgRenderScaleValue&&(this.bgRenderScaleValue.textContent=D.toFixed(2)),this.saveBackgroundSettings()}),this.bgFPS?.addEventListener("input",F=>{const D=parseInt(F.target.value);this.state.backgroundFPS=D,this.background.setFPS(D),this.bgFPSValue&&(this.bgFPSValue.textContent=`${D}fps`),this.saveBackgroundSettings()}),this.lyricAlignPosition?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.lyricAlignPosition=D,this.lyricPlayer.setAlignPosition(D),this.lyricAlignPositionValue&&(this.lyricAlignPositionValue.textContent=D.toFixed(1)),this.saveBackgroundSettings()}),console.log("lyricFontSize element:",this.lyricFontSize),console.log("lyricFontSizeValue element:",this.lyricFontSizeValue),this.lyricFontSize?.addEventListener("input",F=>{console.log("lyricFontSize input event fired!");const D=parseInt(F.target.value);console.log("New value:",D),this.state.lyricFontSize=D,this.updateLyricFontSize(),this.lyricFontSizeValue&&(this.lyricFontSizeValue.textContent=`${D}%`,console.log("Updated display to:",`${D}%`)),this.saveBackgroundSettings()}),this.hidePassedLyricsCheckbox?.addEventListener("change",F=>{const D=F.target.checked;this.state.hidePassedLyrics=D,this.updateLyricsDisplay(),this.saveBackgroundSettings()}),this.enableLyricBlur?.addEventListener("change",F=>{const D=F.target.checked;this.state.enableLyricBlur=D,this.lyricPlayer.setEnableBlur(D),this.saveBackgroundSettings()}),this.enableLyricScale?.addEventListener("change",F=>{const D=F.target.checked;this.state.enableLyricScale=D,this.lyricPlayer.setEnableScale(D),this.saveBackgroundSettings()}),this.enableLyricSpring?.addEventListener("change",F=>{const D=F.target.checked;this.state.enableLyricSpring=D,this.lyricPlayer.setEnableSpring(D);const V=document.getElementById("spring-desc");V&&(V.style.display=D?"block":"none"),this.saveBackgroundSettings()}),this.posYSpringMassInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.posYSpringMass=D,this.lyricPlayer.setLinePosYSpringParams({mass:D,damping:this.state.posYSpringDamping,stiffness:this.state.posYSpringStiffness,soft:this.state.posYSpringSoft});const V=document.getElementById("springPosYMassValue");V&&(V.textContent=D.toFixed(1)),this.saveBackgroundSettings()}),this.posYSpringDampingInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.posYSpringDamping=D,this.lyricPlayer.setLinePosYSpringParams({mass:this.state.posYSpringMass,damping:D,stiffness:this.state.posYSpringStiffness,soft:this.state.posYSpringSoft});const V=document.getElementById("springPosYDampingValue");V&&(V.textContent=D.toFixed(1));const q=document.getElementById("springPosYSoft")?.parentElement;q&&(q.style.display=D<1?"flex":"none"),this.saveBackgroundSettings()}),this.posYSpringStiffnessInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.posYSpringStiffness=D,this.lyricPlayer.setLinePosYSpringParams({mass:this.state.posYSpringMass,damping:this.state.posYSpringDamping,stiffness:D,soft:this.state.posYSpringSoft});const V=document.getElementById("springPosYStiffnessValue");V&&(V.textContent=D.toString()),this.saveBackgroundSettings()}),this.posYSpringSoftCheckbox?.addEventListener("change",F=>{const D=F.target.checked;this.state.posYSpringSoft=D,this.lyricPlayer.setLinePosYSpringParams({mass:this.state.posYSpringMass,damping:this.state.posYSpringDamping,stiffness:this.state.posYSpringStiffness,soft:D}),this.saveBackgroundSettings()}),this.scaleSpringMassInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.scaleSpringMass=D,this.lyricPlayer.setLineScaleSpringParams({mass:D,damping:this.state.scaleSpringDamping,stiffness:this.state.scaleSpringStiffness,soft:this.state.scaleSpringSoft});const V=document.getElementById("springScaleMassValue");V&&(V.textContent=D.toFixed(1)),this.saveBackgroundSettings()}),this.scaleSpringDampingInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.scaleSpringDamping=D,this.lyricPlayer.setLineScaleSpringParams({mass:this.state.scaleSpringMass,damping:D,stiffness:this.state.scaleSpringStiffness,soft:this.state.scaleSpringSoft});const V=document.getElementById("springScaleDampingValue");V&&(V.textContent=D.toFixed(1));const q=document.getElementById("springScaleSoft")?.parentElement;q&&(q.style.display=D<1?"flex":"none"),this.saveBackgroundSettings()}),this.scaleSpringStiffnessInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.scaleSpringStiffness=D,this.lyricPlayer.setLineScaleSpringParams({mass:this.state.scaleSpringMass,damping:this.state.scaleSpringDamping,stiffness:D,soft:this.state.scaleSpringSoft});const V=document.getElementById("springScaleStiffnessValue");V&&(V.textContent=D.toString()),this.saveBackgroundSettings()}),this.scaleSpringSoftCheckbox?.addEventListener("change",F=>{const D=F.target.checked;this.state.scaleSpringSoft=D,this.lyricPlayer.setLineScaleSpringParams({mass:this.state.scaleSpringMass,damping:this.state.scaleSpringDamping,stiffness:this.state.scaleSpringStiffness,soft:D}),this.saveBackgroundSettings()}),this.wordFadeWidthInput?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.wordFadeWidth=D,this.lyricPlayer.setWordFadeWidth(D),this.saveBackgroundSettings(),this.wordFadeWidthValue&&(this.wordFadeWidthValue.textContent=D.toFixed(2))}),this.wordFadeWidthInput?.addEventListener("wheel",F=>{F.preventDefault();const D=Math.sign(F.deltaY)*-1,V=parseFloat(this.wordFadeWidthInput.value),q=parseFloat(this.wordFadeWidthInput.min),G=parseFloat(this.wordFadeWidthInput.max),z=parseFloat(this.wordFadeWidthInput.step),Q=Math.min(G,Math.max(q,V+D*z));this.state.wordFadeWidth=Q,this.wordFadeWidthInput.value=Q.toString(),this.lyricPlayer.setWordFadeWidth(Q),this.saveBackgroundSettings(),this.wordFadeWidthValue&&(this.wordFadeWidthValue.textContent=Q.toFixed(2))},{passive:!1}),this.wordFadeWidthInput?.addEventListener("keydown",F=>{if(F.key==="ArrowUp"||F.key==="ArrowDown"){F.preventDefault();const D=parseFloat(this.wordFadeWidthInput.step)||.01,V=F.key==="ArrowUp"?D:-D,q=parseFloat(this.wordFadeWidthInput.value),G=parseFloat(this.wordFadeWidthInput.min),z=parseFloat(this.wordFadeWidthInput.max),Q=Math.min(z,Math.max(G,q+V));this.wordFadeWidthInput.value=Q.toString(),this.state.wordFadeWidth=Q,this.lyricPlayer.setWordFadeWidth(Q),this.saveBackgroundSettings(),this.wordFadeWidthValue&&(this.wordFadeWidthValue.textContent=Q.toFixed(2))}}),this.lyricAlignAnchorSelect?.addEventListener("change",F=>{const D=F.target.value;this.state.lyricAlignAnchor=D,this.lyricPlayer.setAlignAnchor(D),this.saveBackgroundSettings()}),this.lyricAlignAnchorSelect?.addEventListener("wheel",F=>{F.preventDefault();const D=F.target,V=D.options,q=D.selectedIndex,G=Math.sign(F.deltaY);let z=q+(G>0?1:-1);z<0&&(z=V.length-1),z>=V.length&&(z=0),D.selectedIndex=z,D.dispatchEvent(new Event("change"))},{passive:!1}),this.invertColorsCheckbox?.addEventListener("change",F=>{this.invertColors(F.target.checked)}),this.dominantColorInput?.addEventListener("change",()=>this.onDominantColorChange()),this.dominantColorLightInput?.addEventListener("change",()=>this.onDominantColorLightChange()),this.dominantColorDarkInput?.addEventListener("change",()=>this.onDominantColorDarkChange()),this.enableMarqueeCheckbox?.addEventListener("change",F=>{this.state.marqueeEnabled=F.target.checked,this.updateMarqueeSettings(),this.saveBackgroundSettings()}),this.backgroundBeatCheckbox?.addEventListener("change",F=>{this.state.backgroundBeatEnabled=F.target.checked,this.syncBackgroundBeatState(),this.saveBackgroundSettings()}),this.setupWheelControl("coverBlurLevel","coverBlurLevelValue",5),this.setupWheelControl("bgFlowSpeed","bgFlowSpeedValue",.1),this.setupWheelControl("bgMaskOpacity","bgMaskOpacityValue",5),this.setupWheelControl("volume","volumeValue",.05),this.setupWheelControl("playbackRate","playbackRateValue",.1),this.setupWheelControl("roundedCover","roundedCoverValue",5),this.setupWheelControl("coverRotation","coverRotationValue",5),this.setupWheelControl("bgRenderScale","bgRenderScaleValue",.1),this.setupWheelControl("bgFPS","bgFPSValue",1),this.setupWheelControl("lyricAlignPosition","lyricAlignPositionValue",.1),this.setupWheelControl("lyricFontSize","lyricFontSizeValue",5),this.setupWheelControl("springPosYMass","springPosYMassValue",.1),this.setupWheelControl("springPosYDamping","springPosYDampingValue",.1),this.setupWheelControl("springPosYStiffness","springPosYStiffnessValue",1),this.setupWheelControl("springScaleMass","springScaleMassValue",.1),this.setupWheelControl("springScaleDamping","springScaleDampingValue",.1),this.setupWheelControl("springScaleStiffness","springScaleStiffnessValue",1),this.controlPointCodeInput&&(this.controlPointCodeInput.addEventListener("change",()=>{this.applyControlPointCode()}),this.controlPointCodeInput.addEventListener("keydown",F=>{F.key==="Enter"&&this.applyControlPointCode()})),this.bgLowFreqVolume?.addEventListener("wheel",F=>{F.preventDefault();const D=Math.sign(F.deltaY)*-1,V=parseFloat(this.bgLowFreqVolume.value),q=parseFloat(this.bgLowFreqVolume.min),G=parseFloat(this.bgLowFreqVolume.max),z=Math.min(G,Math.max(q,V+D*.1));if(this.bgLowFreqVolume.value=z.toString(),this.bgLowFreqVolumeValue){const Q=J=>`${(80+J*40).toFixed(0)}hz`;this.bgLowFreqVolumeValue.textContent=Q(z)}this.bgLowFreqVolume.dispatchEvent(new Event("input"))},{passive:!1}),this.albumCoverLarge?.addEventListener("click",()=>{!this.state.coverUrl&&this.coverFile&&this.coverFile.click()}),this.albumCoverLarge&&this.coverFile&&this.addLongPressAndRightClickHandler(this.albumCoverLarge,()=>{this.coverFile&&this.coverFile.click()},3e3);const L=F=>{F.classList.remove("marquee");const D=document.createElement("input");D.type="text",D.value=F.textContent||"";const V=window.matchMedia("(orientation: portrait)").matches,q=V&&this.state.swapDuetsPositions?"right":V?"left":"center";D.style.cssText=`
        width: 100%;
        background: transparent;
        border: none;
        color: var(--dominant-color-light);
        font-size: inherit;
        font-weight: inherit;
        text-align: ${q};
        outline: none;
      `,F.textContent="",F.appendChild(D),D.focus(),D.addEventListener("blur",()=>{this.state.songTitle=D.value,F.textContent=D.value,this.songTitleInput&&(this.songTitleInput.value=D.value),this.updateSongInfo()}),D.addEventListener("keydown",G=>{G.key==="Enter"&&(this.state.songTitle=D.value,F.textContent=D.value,this.songTitleInput&&(this.songTitleInput.value=D.value),this.updateSongInfo())})};this.songTitle?.addEventListener("click",F=>{const D=F.target,V=D.textContent||"";(V===""||V===t$3("title"))&&L(D)}),this.songTitle&&this.addLongPressAndRightClickHandler(this.songTitle,()=>{this.songTitle&&L(this.songTitle)},3e3);const P=F=>{F.classList.remove("marquee");const D=document.createElement("input");D.type="text",D.value=F.textContent||"";const V=window.matchMedia("(orientation: portrait)").matches,q=V&&this.state.swapDuetsPositions?"right":V?"left":"center";D.style.cssText=`
        width: 100%;
        background: transparent;
        border: none;
        color: var(--dominant-color-light);
        opacity: 0.8;
        font-size: inherit;
        text-align: ${q};
        outline: none;
      `,F.textContent="",F.appendChild(D),D.focus(),D.addEventListener("blur",()=>{this.state.songArtist=D.value,F.textContent=D.value,this.songArtistInput&&(this.songArtistInput.value=D.value),this.updateSongInfo()}),D.addEventListener("keydown",G=>{G.key==="Enter"&&(this.state.songArtist=D.value,F.textContent=D.value,this.songArtistInput&&(this.songArtistInput.value=D.value),this.updateSongInfo())})};if(this.songArtist?.addEventListener("click",F=>{const D=F.target,V=D.textContent||"";(V===""||V===t$3("artist"))&&P(D)}),this.songArtist&&this.addLongPressAndRightClickHandler(this.songArtist,()=>{this.songArtist&&P(this.songArtist)},3e3),this.musicFileBtn?.addEventListener("click",()=>{this.musicFile&&this.musicFile.click()}),this.lyricFileBtn?.addEventListener("click",()=>{this.lyricFile&&this.lyricFile.click()}),this.coverFileBtn?.addEventListener("click",()=>{this.coverFile&&this.coverFile.click()}),this.musicFile?.addEventListener("change",F=>{if(!F.target)return;const D=F.target.files?.[0];D&&this.loadMusicFromFile(D)}),this.lyricFile?.addEventListener("change",F=>{if(!F.target)return;const D=F.target.files?.[0];D&&this.loadLyricFromFile(D)}),this.coverFile?.addEventListener("change",F=>{if(!F.target)return;const D=F.target.files?.[0];D&&this.loadCoverFromFile(D)}),this.songTitleInput?.addEventListener("input",F=>{this.state.songTitle=F.target.value,this.updateSongInfo(),this.saveBackgroundSettings()}),this.songArtistInput?.addEventListener("input",F=>{this.state.songArtist=F.target.value,this.updateSongInfo(),this.saveBackgroundSettings()}),this.songTitleInput?.addEventListener("blur",F=>{this.state.songTitle=F.target.value,this.updateSongInfo(),this.songTitle&&this.checkAndUpdateMarquee(this.songTitle),this.saveBackgroundSettings()}),this.songTitleInput?.addEventListener("keydown",F=>{F.key==="Enter"&&F.target.blur()}),this.songArtistInput?.addEventListener("blur",F=>{this.state.songArtist=F.target.value,this.updateSongInfo(),this.songArtist&&this.checkAndUpdateMarquee(this.songArtist),this.saveBackgroundSettings()}),this.songArtistInput?.addEventListener("keydown",F=>{F.key==="Enter"&&F.target.blur()}),this.loopPlayCheckbox?.addEventListener("change",F=>{this.state.loopPlay=F.target.checked,this.saveBackgroundSettings()}),this.playbackRateControl&&this.playbackRateValue){this.playbackRateControl.addEventListener("input",D=>{const V=parseFloat(D.target.value);isNaN(V)||(this.state.playbackRate=V,this.audio.playbackRate=V,this.playbackRateValue&&(this.playbackRateValue.textContent=V.toFixed(2)+"x"),this.updatePlaybackRateIcon(V),this.saveBackgroundSettings())});const F=parseFloat(this.playbackRateControl.value);isNaN(F)||(this.state.playbackRate=F),this.updatePlaybackRateIcon(F)}if(this.volumeControl&&this.volumeValue&&(this.volumeControl.value=this.state.volume.toString(),this.volumeValue.textContent=Math.round(this.state.volume)+"%",this.updateVolumeIcon(Math.round(this.state.volume)),this.volumeControl.addEventListener("input",F=>{const D=parseInt(F.target.value);!isNaN(D)&&this.volumeValue&&(this.audio.volume=D/100,this.volumeValue.textContent=D+"%",this.updateVolumeIcon(D),this.state.volume=D,this.saveBackgroundSettings())}),this.volumeControl.addEventListener("wheel",F=>{F.preventDefault();const D=5;if(!this.volumeControl)return;const V=parseInt(this.volumeControl.value);let q=V;F.deltaY<0?q=Math.min(100,V+D):q=Math.max(0,V-D),q!==V&&this.volumeControl&&this.volumeValue&&(this.volumeControl.value=q.toString(),this.audio.volume=q/100,this.volumeValue.textContent=q+"%",this.updateVolumeIcon(q))},{passive:!1})),this.lyricDelayInput&&(this.lyricDelayInput.addEventListener("input",F=>{const D=parseInt(F.target.value);isNaN(D)||this.applyLyricDelay(D)}),this.lyricDelayInput)){const F=this.lyricDelayInput;F.addEventListener("wheel",D=>{D.preventDefault();const V=D.deltaY<0?50:-50,q=parseInt(F.value||"0")+V;F.value=q.toString(),this.applyLyricDelay(q)},{passive:!1}),F.addEventListener("keydown",D=>{if(D.key==="ArrowUp"||D.key==="ArrowDown"){D.preventDefault();const V=D.key==="ArrowUp"?50:-50,q=parseInt(F.value||"0")+V;F.value=q.toString(),this.applyLyricDelay(q)}})}if(this.bgFlowSpeed?.addEventListener("input",F=>{const D=parseFloat(F.target.value);this.state.backgroundFlowSpeed=D,this.state.backgroundType==="fluid"&&(D===0?this.background.setStaticMode(!0):(this.background.setStaticMode(!1),this.background.setFlowSpeed(D))),this.bgFlowSpeedValue.textContent=D.toFixed(1),this.saveBackgroundSettings()}),this.bgColorMask?.addEventListener("change",F=>{this.state.backgroundColorMask=F.target.checked,this.updateBackground(),this.updateBackgroundUI(),this.saveBackgroundSettings()}),this.bgMaskColor?.addEventListener("input",F=>{this.state.backgroundMaskColor=F.target.value,this.updateBackground(),this.saveBackgroundSettings()}),this.bgMaskOpacity?.addEventListener("input",F=>{const D=parseInt(F.target.value);this.state.backgroundMaskOpacity=D,this.updateBackground(),this.updateBackgroundUI(),this.bgMaskOpacityValue.textContent=D+"%",this.saveBackgroundSettings()}),this.showFPSCheckbox?.addEventListener("change",F=>{this.state.showFPS=F.target.checked,this.updateFPSDisplay(),this.saveBackgroundSettings()}),this.loadFromUrlBtn?.addEventListener("click",()=>{this.loadFromURLs()}),this.musicUrl?.addEventListener("keydown",F=>{F.key==="Enter"&&this.loadFromURLs()}),this.musicUrl?.addEventListener("input",()=>{this.saveBackgroundSettings()}),this.lyricUrl){const F=()=>{const D=this.lyricUrl,V=D.scrollTop;D.style.height="auto";const q=parseInt(window.getComputedStyle(D).lineHeight,10),G=parseInt(window.getComputedStyle(D).paddingTop,10)+parseInt(window.getComputedStyle(D).paddingBottom,10),z=Math.max(1,Math.min(10,Math.ceil((D.scrollHeight-G)/q)));D.style.height=Math.min(D.scrollHeight,200)+"px",D.rows=z,D.scrollTop=V};F(),this.lyricUrl.addEventListener("input",F),this.lyricUrl.addEventListener("keyup",F),this.lyricUrl.addEventListener("paste",()=>{setTimeout(F,0)}),this.lyricUrl.addEventListener("input",()=>{this.saveBackgroundSettings()})}if(this.lyricUrl?.addEventListener("keydown",F=>{F.key==="Enter"&&(F.ctrlKey||F.metaKey)?this.lyricUrl&&this.processLyricInput(this.lyricUrl.value):F.key==="Enter"&&!F.shiftKey&&this.loadFromURLs()}),this.coverUrl?.addEventListener("keydown",F=>{F.key==="Enter"&&this.coverUrl&&this.processCoverInput(this.coverUrl.value)}),this.coverUrl?.addEventListener("input",()=>{this.saveBackgroundSettings()}),this.loadFilesBtn?.addEventListener("click",()=>{this.loadFromFiles()}),this.resetPlayerBtn?.addEventListener("click",()=>{this.resetPlayer()}),this.fullscreenButton){let F;this.fullscreenButton.addEventListener("click",()=>{this.toggleFullscreen()}),this.fullscreenButton.addEventListener("mousedown",()=>{F=window.setTimeout(()=>{this.lyricFile&&this.lyricFile.click()},3e3)}),this.fullscreenButton.addEventListener("mouseup",()=>{clearTimeout(F)}),this.fullscreenButton.addEventListener("mouseleave",()=>{clearTimeout(F)}),this.fullscreenButton.addEventListener("contextmenu",D=>(D.preventDefault(),this.lyricFile&&this.lyricFile.click(),!1)),this.fullscreenButton&&(this.fullscreenButton.addEventListener("touchstart",D=>{F=window.setTimeout(()=>{this.lyricFile&&this.lyricFile.click()},3e3)},{passive:!0}),this.fullscreenButton.addEventListener("touchend",()=>{clearTimeout(F)},{passive:!0}),this.fullscreenButton.addEventListener("touchcancel",()=>{clearTimeout(F)},{passive:!0}))}this.toggleControlsBtn?.addEventListener("click",()=>{this.toggleControlPanel()}),this.albumSidePanel&&this.albumSidePanel.addEventListener("click",()=>{this.toggleControlPanel()}),this.progressBar?.addEventListener("click",F=>{this.seekToPosition(F)}),this.progressBar&&this.addLongPressAndRightClickHandler(this.progressBar,F=>{F&&this.handleRangeSelection(F)}),this.timeDisplay&&this.addLongPressAndRightClickHandler(this.timeDisplay,()=>{this.exitRangeMode()}),this.landscapeTimeDisplay&&this.addLongPressAndRightClickHandler(this.landscapeTimeDisplay,()=>{this.exitRangeMode()}),this.progressBar?.addEventListener("wheel",F=>{F.preventDefault();const D=F.deltaY>0?-1:1;if(this.audio&&this.state.duration>0){const V=Math.max(0,Math.min(this.state.duration,this.audio.currentTime+D));this.audio.currentTime=V,this.state.currentTime=V;const q=V*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(q),this.updateProgress(),this.updateTimeDisplay()}},{passive:!1});const I=this.progressBar;I&&(I.style.position="relative",I.addEventListener("mousemove",F=>{this.showTooltip(I,F.clientX)}),I.addEventListener("mouseleave",()=>{this.tooltipTimer&&clearTimeout(this.tooltipTimer),this.verticalLine&&(this.verticalLine.style.display="none"),this.tooltip&&(this.tooltip.style.transform="translateY(4px)",this.tooltip.style.opacity="0",setTimeout(()=>{this.tooltip&&(this.tooltip.style.display="none")},300))})),document.addEventListener("keydown",F=>{this.handleKeyboard(F)}),this.setupTouchEvents(),window.addEventListener("resize",()=>{this.adjustLyricPosition()}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?this.fullscreenEnterIcon&&this.fullscreenExitIcon&&(this.fullscreenEnterIcon.style.display="none",this.fullscreenExitIcon.style.display="inline"):this.fullscreenEnterIcon&&this.fullscreenExitIcon&&(this.fullscreenEnterIcon.style.display="inline",this.fullscreenExitIcon.style.display="none")}),window.matchMedia("(orientation: portrait)").addEventListener("change",()=>{this.adjustLyricPosition(),this.songTitle&&(this.songTitle.classList.remove("marquee"),this.songTitle.offsetWidth,this.checkAndUpdateMarquee(this.songTitle)),this.songArtist&&(this.songArtist.classList.remove("marquee"),this.songArtist.offsetWidth,this.checkAndUpdateMarquee(this.songArtist))})}async detectMaxFPS(){try{const R=window.screen;if(R?.refreshRate)return Math.round(R.refreshRate);if(navigator.mediaCapabilities?.encodingInfo)try{if((await navigator.mediaCapabilities.encodingInfo({type:"record",video:{contentType:"video/mp4",width:1920,height:1080,bitrate:1e6,framerate:60}})).supported){for(let L=120;L>60;L-=10)if((await navigator.mediaCapabilities.encodingInfo({type:"record",video:{contentType:"video/mp4",width:1920,height:1080,bitrate:1e6,framerate:L}})).supported)return L}}catch{try{if((await navigator.mediaCapabilities.encodingInfo({type:"transmission",video:{contentType:"video/mp4",width:1920,height:1080,bitrate:1e6,framerate:60}})).supported){for(let P=120;P>60;P-=10)if((await navigator.mediaCapabilities.encodingInfo({type:"transmission",video:{contentType:"video/mp4",width:1920,height:1080,bitrate:1e6,framerate:P}})).supported)return P}}catch(L){console.warn("MediaCapabilities API failed:",L)}}return await this.measureFpsWithRAF()}catch(R){console.warn("Failed to detect max FPS:",R)}return 60}measureFpsWithRAF(){return new Promise(R=>{if(!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){R(60);return}const L=1e3;let P=0,I=null;function F(D){I||(I=D);const V=D-I;if(P++,V<L)requestAnimationFrame(F);else{const q=Math.ceil(P*1e3/V),G=Math.min(q,120);R(Math.max(G,30))}}requestAnimationFrame(F)})}async generateWaveformData(){if(!(!this.audio.src||!this.waveformCanvas))try{this.cachedWaveform=null,this.audioBuffer=null;const T=await(await fetch(this.audio.src)).arrayBuffer(),L=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await L.decodeAudioData(T),this.cachedWaveform=this.createWaveformData(this.audioBuffer),console.log("Waveform data generated successfully"),this.updateWaveformCanvasSize(),this.redrawWaveform()}catch(R){console.error("Failed to generate waveform data:",R),this.cachedWaveform=null}}createWaveformData(R){const T=R.getChannelData(0);let L=0;if(this.waveformCanvas&&this.waveformCanvas.width>0)L=Math.floor(this.waveformCanvas.width*5);else if(this.progressBar){const F=parseFloat(getComputedStyle(this.progressBar).width);F>0&&(L=Math.floor(F*10))}const P=Math.floor(T.length/L),I=new Float32Array(L);for(let F=0;F<L;F++){let D=0;for(let V=0;V<P;V++){const q=F*P+V;D+=Math.abs(T[q]||0)}I[F]=D/P}return I}updateWaveformCanvasSize(){if(!this.waveformCanvas||!this.progressBar)return;this.waveformCanvas.parentNode!==this.progressBar&&(this.waveformCanvas.parentNode&&this.waveformCanvas.parentNode.removeChild(this.waveformCanvas),this.progressBar.appendChild(this.waveformCanvas));const R=0,T=Math.max(R,parseFloat(getComputedStyle(this.progressBar).width)),L=this.waveformCanvas.width,P=window.devicePixelRatio||1,I=this.progressBar.getBoundingClientRect();this.waveformCanvas.width=T*P,this.waveformCanvas.height=I.height*P,this.waveformCanvas.style.position="absolute",this.waveformCanvas.style.top="0",this.waveformCanvas.style.left="0",this.waveformCanvas.style.width="100%",this.waveformCanvas.style.height="100%",this.waveformCanvas.style.minWidth=`${R}px`,this.waveformCanvas.style.pointerEvents="none",this.waveformCanvas.style.opacity="0",this.waveformCanvas.style.transition="opacity 0.3s ease",this.waveformCanvas.style.imageRendering="pixelated",this.cachedWaveform&&this.audioBuffer&&L>0&&Math.abs(T-L)>L*.1&&(this.cachedWaveform=this.createWaveformData(this.audioBuffer)),this.cachedWaveform&&this.redrawWaveform()}redrawWaveform(){if(!this.waveformCanvas||!this.waveformContext||!this.cachedWaveform)return;const R=this.waveformCanvas,T=this.waveformContext,L=this.cachedWaveform,P=window.devicePixelRatio||1;if(T.scale(P,P),T.clearRect(0,0,R.width/P,R.height/P),L.length>0){const G=L[0];let z=!0;for(let Q=1;Q<L.length;Q++)if(L[Q]!==G){z=!1;break}if(z)return}const I=getComputedStyle(document.documentElement).getPropertyValue("--waveform-color").trim();T.strokeStyle=I||this.originalDominant,T.lineWidth=1.8/P,T.lineCap="round",T.lineJoin="round";const F=R.width/P,D=R.height/P,V=D/2,q=F/L.length;T.globalAlpha=.7,T.beginPath();for(let G=0;G<L.length;G++){const z=G*q,Q=L[G]*D*.9;T.moveTo(z,V-Q),T.lineTo(z,V+Q)}T.stroke(),T.scale(1/P,1/P)}tooltip=null;verticalLine=null;tooltipTimer=null;diffUpdateTimer=null;showTooltip(R,T){const L=R.getBoundingClientRect();let P=(T-L.left)/L.width;const I=P*this.state.duration;if(this.progressFill){const z=parseFloat(this.progressFill.style.width||"0%");Math.abs(P*100-z)<.5&&(P=z/100)}const F=`${P*100}%`;this.verticalLine||(this.verticalLine=document.createElement("div"),this.verticalLine.style.position="absolute",this.verticalLine.style.width="1px",this.verticalLine.style.height="100%",this.verticalLine.style.backgroundColor="var(--dominant-color-light)",this.verticalLine.style.top="0",this.verticalLine.style.opacity="0.18",this.verticalLine.style.zIndex="51",R.appendChild(this.verticalLine)),this.verticalLine.style.left=F,this.verticalLine.style.display="block",this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.style.position="fixed",this.tooltip.style.color="var(--dominant-color-light)",this.tooltip.style.padding="4px 8px",this.tooltip.style.borderRadius="0.75em",this.tooltip.style.fontSize="0.75em",this.tooltip.style.pointerEvents="none",this.tooltip.style.zIndex="49",this.tooltip.style.transform="translateY(4px)",this.tooltip.style.transition="all 0.3s ease-out",this.tooltip.style.opacity="0",document.body.appendChild(this.tooltip));const D=Math.floor(I/60),V=Math.floor(I%60),q=Math.floor(I%1*1e3),G=`${D.toString().padStart(2,"0")}:${V.toString().padStart(2,"0")}.${q.toString().padStart(3,"0")}`;if(G=="00:00.000"||I<0||!isFinite(this.state.duration))this.tooltip&&(this.tooltip.style.transform="translateY(4px)",this.tooltip.style.opacity="0",setTimeout(()=>{this.tooltip&&(this.tooltip.style.display="none")},250)),this.tooltipTimer&&clearTimeout(this.tooltipTimer);else{const z=()=>{const yt=I-this.state.currentTime,At=Math.floor(Math.abs(yt)/60),gt=Math.floor(Math.abs(yt)%60),Et=Math.floor(Math.abs(yt)%1*1e3);let kt="";const ne=yt>=0?"+":"-";At>0?kt=`${ne}${At}:${gt}.${Et}`:gt>0?kt=`${ne}${gt}.${Et}`:kt=`${ne}${Et}`,this.tooltip&&(Math.abs(yt)<.1?this.tooltip.textContent=G:this.tooltip.textContent=`${G} (${kt})`)};z(),this.diffUpdateTimer&&clearInterval(this.diffUpdateTimer),this.diffUpdateTimer=window.setInterval(z,100);const Q=this.verticalLine.getBoundingClientRect();this.tooltip.style.left=`${Q.right-6}px`;const J=this.tooltip.getBoundingClientRect(),tt=`${L.top+(L.height-J.height)/2-L.height/2-14}px`;this.tooltip.style.top=tt,this.tooltip.style.display="block",this.tooltip.offsetWidth,this.tooltip.style.transform="translateY(0)",this.tooltip.style.opacity="0.7",this.tooltipTimer&&clearTimeout(this.tooltipTimer),this.tooltipTimer=window.setTimeout(()=>{this.diffUpdateTimer&&(clearInterval(this.diffUpdateTimer),this.diffUpdateTimer=null),this.tooltip&&(this.tooltip.style.transform="translateY(4px)",this.tooltip.style.opacity="0",setTimeout(()=>{this.tooltip&&(this.tooltip.style.display="none")},250)),this.verticalLine&&(this.verticalLine.style.display="none")},3e3)}}setupWaveformEvents(){!this.progressBar||!this.waveformCanvas||(this.progressBar.addEventListener("mouseenter",()=>{if(this.waveformCanvas&&this.waveformCanvas.width>0&&this.progressBar&&this.cachedWaveform&&this.cachedWaveform.length>0){this.waveformCanvas.style.opacity="1",this.redrawWaveform(),this.progressBar.style.height="24px",this.progressBar.style.borderRadius="12px";const R=this.progressBar.querySelector("#progressFill");R&&(R.style.opacity="0.24")}}),this.progressBar.addEventListener("mouseleave",()=>{if(this.waveformCanvas&&this.waveformCanvas.width>0&&this.progressBar&&this.cachedWaveform&&this.cachedWaveform.length>0){this.waveformCanvas.style.opacity="0",this.progressBar.style.height="",this.progressBar.style.borderRadius="";const R=this.progressBar.querySelector("#progressFill");R&&(R.style.opacity="")}}),this.progressBar.addEventListener("touchstart",R=>{if(R.preventDefault(),this.waveformCanvas&&this.waveformCanvas.width>0&&this.progressBar&&this.cachedWaveform&&this.cachedWaveform.length>0){this.touchExitTimeout!==null&&(clearTimeout(this.touchExitTimeout),this.touchExitTimeout=null),this.progressBar.style.height="24px",this.progressBar.style.borderRadius="12px";const T=this.progressBar.querySelector("#progressFill");T&&(T.style.opacity="0.24"),this.waveformCanvas.style.opacity="1",this.redrawWaveform(),this.seekToPosition(R)}},{passive:!1}),this.progressBar.addEventListener("touchmove",R=>{R.preventDefault(),this.progressBar&&this.state.duration>0&&R.touches.length>0&&this.showTooltip(this.progressBar,R.touches[0].clientX)},{passive:!1}),this.progressBar.addEventListener("touchend",()=>{this.waveformCanvas&&this.progressBar&&(this.touchExitTimeout=window.setTimeout(()=>{if(this.progressBar){this.progressBar.style.height="",this.progressBar.style.borderRadius="";const R=this.progressBar.querySelector("#progressFill");R&&(R.style.opacity="")}this.waveformCanvas&&(this.waveformCanvas.style.opacity="0"),this.touchExitTimeout=null},3e3))}),window.addEventListener("resize",()=>{this.updateWaveformCanvasSize(),this.waveformCanvas&&this.cachedWaveform&&this.redrawWaveform()}))}initBackground(){this.background=ce.new(hi),this.background.setFPS(this.state.backgroundFPS||60);const R=window.devicePixelRatio||1;if(this.background.setRenderScale((this.state.backgroundRenderScale||1)*R),this.background.setStaticMode(!this.state.backgroundDynamic),this.background.setFlowSpeed(this.state.backgroundFlowSpeed),this.background.getElement().style.position="absolute",this.background.getElement().style.top="0",this.background.getElement().style.left="0",this.background.getElement().style.width="100%",this.background.getElement().style.height="100%",this.background.getElement().style.backgroundSize="cover",this.background.getElement().style.backgroundPosition="center",this.background.getElement().style.backgroundRepeat="no-repeat",this.background.getElement().style.transformOrigin="center",this.background.getElement().style.willChange="transform",this.detectMaxFPS().then(T=>{this.bgFPS&&(this.bgFPS.max=T.toString(),(parseInt(this.bgFPS.value)>T||parseInt(this.bgFPS.value)===60)&&(this.bgFPS.value=T.toString(),this.state.backgroundFPS=T,this.bgFPSValue&&(this.bgFPSValue.textContent=`${T}fps`),this.background.setFPS(T),this.saveBackgroundSettings()))}),this.backgroundStyleSelect){this.backgroundStyleSelect.addEventListener("change",L=>{const P=L.target.value;this.switchBackgroundStyle(P)});const T=this.backgroundStyleSelect;if(T.addEventListener("keydown",L=>{if(L.key==="ArrowUp"||L.key==="ArrowDown"){L.preventDefault();const P=L.key==="ArrowUp"?-1:1,I=Math.max(0,Math.min(T.options.length-1,T.selectedIndex+P));T.selectedIndex=I,this.switchBackgroundStyle(T.value)}}),this.backgroundStyleSelect){const L=this.backgroundStyleSelect;L.addEventListener("wheel",P=>{P.preventDefault();const I=P.deltaY>0?1:-1,F=Math.max(0,Math.min(L.options.length-1,L.selectedIndex+I));L.selectedIndex=F,this.switchBackgroundStyle(L.value)},{passive:!1})}}if(this.bgLowFreqVolume&&this.bgLowFreqVolumeValue){const T=L=>`${(80+L*40).toFixed(0)}hz`;this.bgLowFreqVolumeValue.textContent=T(parseFloat(this.bgLowFreqVolume.value)),this.bgLowFreqVolume?.addEventListener("input",L=>{const P=parseFloat(L.target.value);this.state.backgroundLowFreqVolume=P,this.bgLowFreqVolumeValue&&(this.bgLowFreqVolumeValue.textContent=T(P)),this.background&&typeof this.background.setLowFreqVolume=="function"&&this.background.setLowFreqVolume(P),this.saveBackgroundSettings()})}}originalDark="";originalLight="";originalDominant="";isColorsInitialized=!1;initColors(){if(this.isColorsInitialized)return;let R=getComputedStyle(document.documentElement).getPropertyValue("--dominant-color-dark").trim(),T=getComputedStyle(document.documentElement).getPropertyValue("--dominant-color-light").trim(),L=getComputedStyle(document.documentElement).getPropertyValue("--dominant-color").trim(),P=getComputedStyle(document.documentElement).getPropertyValue("--waveform-color").trim();this.originalDark=R||"#640302",this.originalLight=T||"#ffcfce",this.originalDominant=L||"#fd9c9b",P||document.documentElement.style.setProperty("--waveform-color",this.originalDominant),this.isColorsInitialized=!0}setDefaultColors(){document.documentElement.style.setProperty("--dominant-color","#fd9c9b"),document.documentElement.style.setProperty("--dominant-color-light","#ffcfce"),document.documentElement.style.setProperty("--dominant-color-dark","#640302"),document.documentElement.style.setProperty("--waveform-color","#fd9c9b"),this.originalDominant="#fd9c9b",this.originalLight="#ffcfce",this.originalDark="#640302",this.isColorsInitialized=!0,this.invertColorsCheckbox&&this.invertColors(this.invertColorsCheckbox.checked)}onDominantColorChange(){this.dominantColorInput&&(this.state.manualDominantColor=this.dominantColorInput.value,this.applyManualColors(),this.saveBackgroundSettings())}onDominantColorLightChange(){this.dominantColorLightInput&&(this.state.manualDominantColorLight=this.dominantColorLightInput.value,this.applyManualColors(),this.saveBackgroundSettings())}onDominantColorDarkChange(){this.dominantColorDarkInput&&(this.state.manualDominantColorDark=this.dominantColorDarkInput.value,this.applyManualColors(),this.saveBackgroundSettings())}applyManualColors(){const R=this.invertColorsCheckbox?.checked||!1,T=this.state.manualDominantColor||this.originalDominant,L=this.state.manualDominantColorLight||this.originalLight,P=this.state.manualDominantColorDark||this.originalDark;R?(document.documentElement.style.setProperty("--dominant-color",L),document.documentElement.style.setProperty("--dominant-color-light",P),document.documentElement.style.setProperty("--dominant-color-dark",T),document.documentElement.style.setProperty("--waveform-color",P)):(document.documentElement.style.setProperty("--dominant-color",T),document.documentElement.style.setProperty("--dominant-color-light",L),document.documentElement.style.setProperty("--dominant-color-dark",P),document.documentElement.style.setProperty("--waveform-color",T)),this.redrawWaveform()}invertColors(R){this.invertColorsCheckbox&&(this.isColorsInitialized||this.initColors(),this.state.invertColors=R,this.applyManualColors(),this.saveBackgroundSettings())}applyDominantColorAsCSSVariable(){const R=this.invertColorsCheckbox?.checked;this.dominantColor&&(this.originalDominant=this.dominantColor,this.originalLight=this.lightenColor(this.dominantColor,.2),this.originalDark=this.darkenColor(this.dominantColor,.5),this.isColorsInitialized=!0,this.dominantColorInput&&!this.state.manualDominantColor&&(this.dominantColorInput.value=this.dominantColor),this.dominantColorLightInput&&!this.state.manualDominantColorLight&&(this.dominantColorLightInput.value=this.originalLight),this.dominantColorDarkInput&&!this.state.manualDominantColorDark&&(this.dominantColorDarkInput.value=this.originalDark),this.invertColors(R||!1))}switchBackgroundStyle(R){if(!this.background)return;const T=this.state.backgroundType;if(this.fluidDesc&&(this.fluidDesc.style.display=R==="fluid"?"block":"none"),this.coverDesc&&(this.coverDesc.style.display=R==="cover"?"block":"none"),this.solidDesc&&(this.solidDesc.style.display=R==="solid"?"block":"none"),this.solidOptions){const L=R==="cover"&&this.state.backgroundColorMask&&this.state.backgroundMaskOpacity===0;this.setOptionsVisibility(this.solidOptions,L,["neumorphismA","neumorphismB"])}switch(T==="cover"&&R!=="cover"&&this.invertColorsCheckbox&&(this.state.originalInvertColors=this.invertColorsCheckbox.checked),R){case"fluid":this.background.setFlowSpeed(this.state.backgroundFlowSpeed||4),this.player&&(this.player.style.background=""),this.state.backgroundType="fluid",this.updateBackground(),this.updateBackgroundUI(),this.saveBackgroundSettings();break;case"cover":this.background.setAlbum(resolveDefaultCover(this.state.coverUrl)),this.player&&(this.player.style.background=""),this.state.backgroundType="cover",this.updateBackground(),this.updateBackgroundUI(),this.saveBackgroundSettings();break;case"solid":this.background.setAlbum(""),this.player&&(this.player.style.background="transparent"),this.state.backgroundType="solid",this.updateBackground(),this.updateBackgroundUI(),this.saveBackgroundSettings();break}if(R!=="cover"&&this.invertColorsCheckbox&&(this.invertColorsCheckbox.checked=!1,this.invertColors(!1)),R==="cover"&&T!=="cover"&&this.invertColorsCheckbox){const L=this.state.originalInvertColors!==null&&this.state.originalInvertColors!==void 0?this.state.originalInvertColors:this.state.invertColors;this.invertColorsCheckbox.checked=L,this.invertColors(L)}if(this.invertColorsCheckbox){const L=this.invertColorsCheckbox.checked;this.invertColorsCheckbox.onchange=()=>{this.invertColorsCheckbox&&this.invertColors(this.invertColorsCheckbox.checked)},L&&R==="cover"&&this.invertColors(L)}}setupAudioEvents(){const R=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;this.mediaSessionRefreshTimeout=null,document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.refreshMediaSession()}),window.addEventListener("pageshow",()=>{this.refreshMediaSession()}),window.addEventListener("focus",()=>{this.refreshMediaSession()}),R&&document.addEventListener("touchstart",()=>{this.mediaSessionRefreshTimeout||(this.mediaSessionRefreshTimeout=setTimeout(()=>{this.refreshMediaSession(),this.mediaSessionRefreshTimeout=null},100))},{passive:!0}),document.addEventListener("click",()=>{this.beatState.audioContext&&this.beatState.audioContext.state==="suspended"&&this.beatState.audioContext.resume().catch(()=>{})},{passive:!0}),this.audio.addEventListener("loadedmetadata",()=>{this.state.duration=this.audio.duration,this.updateTimeDisplay(),this.updateMediaSessionMetadata(),!isFinite(this.state.duration)&&!this.cachedWaveform&&this.generateWaveformData(),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&setTimeout(()=>{this.updateMediaSessionMetadata()},100)}),this.audio.addEventListener("timeupdate",()=>{this.state.currentTime=this.audio.currentTime,this.state.isRangeMode&&this.state.rangeEndTime>this.state.rangeStartTime&&this.audio.currentTime>=this.state.rangeEndTime&&(this.audio.currentTime=this.state.rangeStartTime,this.state.currentTime=this.state.rangeStartTime),this.updateProgress(),this.updateTimeDisplay();const P=this.audio.currentTime*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(P)}),this.audio.addEventListener("play",()=>{this.state.isPlaying=!0,this.updatePlayButton(),this.lyricPlayer.resume(),this.updateMarqueeSettings(),this.updateCoverRotation(),this.syncBackgroundBeatState(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing")}),this.audio.addEventListener("pause",()=>{this.state.isPlaying=!1,this.updatePlayButton(),this.lyricPlayer.pause(),this.updateMarqueeSettings(),this.updateCoverRotation(),this.syncBackgroundBeatState(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused")}),this.audio.addEventListener("ended",()=>{if(this.state.isPlaying=!1,this.updatePlayButton(),this.syncBackgroundBeatState(),this.state.loopPlay){this.audio.currentTime=0;const P=this.processedLyricLines.length>0?this.processedLyricLines[0].startTime:0;this.lyricPlayer.setCurrentTime(P),setTimeout(()=>{this.lyricPlayer.setCurrentTime(this.state.lyricDelay)},50),this.audio.play()}"mediaSession"in navigator&&(navigator.mediaSession.playbackState="none")});let T=this.audio.src;new MutationObserver(P=>{P.forEach(I=>{I.type==="attributes"&&I.attributeName==="src"&&this.audio.src!==T&&(T=this.audio.src,this.state.isRangeMode&&this.exitRangeMode(),this.generateWaveformData(),this.clearBeatCurvePolling(),this.beatCurvePath=null,this.beatState.beatCurve=null,this.resetBeatPaletteCache(),this.syncBackgroundBeatState())})}).observe(this.audio,{attributes:!0}),this.setupMediaSessionHandlers()}setupLyricEvents(){this.lyricPlayer.addEventListener("line-click",T=>{const L=T;T.preventDefault(),T.stopImmediatePropagation(),T.stopPropagation(),console.log(L.line,L.lineIndex),this.audio.currentTime=L.line.getLine().startTime/1e3});const R=this.lyricPlayer.getElement();R&&R.addEventListener("touchend",T=>{if(!this.hasLyrics||T.changedTouches.length>1)return;const L=T.target instanceof HTMLElement?T.target:null,I=(this.lyricPlayer?.currentLyricLineObjects??[]).find(q=>{const G=q?.getElement?.();return G instanceof HTMLElement&&(G===L||G.contains(L))});if(!I)return;const F=I.getLine?.();if(!F||typeof F.startTime!="number")return;const D=F.startTime,V=Math.max(0,D/1e3);T.preventDefault(),T.stopPropagation(),T.stopImmediatePropagation?.(),this.audio.currentTime=V,this.lyricPlayer.setCurrentTime(D,!0),typeof this.lyricPlayer.resetScroll=="function"&&this.lyricPlayer.resetScroll()},{passive:!1}),this.updateLyricAreaHint()}updateLyricAreaHint(){this.lyricsPanel&&(this.lyricAreaHint&&this.lyricAreaHint.remove(),this.lyricAreaHint=null)}setupDragAndDropEvents(){this.albumCoverLarge&&(this.albumCoverLarge.addEventListener("dragover",R=>{R.preventDefault(),this.albumCoverLarge.style.opacity="0.7"}),this.albumCoverLarge.addEventListener("dragleave",()=>{this.albumCoverLarge.style.opacity="1"}),this.albumCoverLarge.addEventListener("drop",R=>{if(R.preventDefault(),this.albumCoverLarge.style.opacity="1",R.dataTransfer?.files.length){const T=R.dataTransfer.files[0];T.type.startsWith("image/")?(this.loadCoverFromFile(T),this.updateFileInputDisplay("coverFile",T)):T.type.startsWith("audio/")||/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(T.name)?(this.loadMusicFromFile(T),this.updateFileInputDisplay("musicFile",T)):this.showStatus("不支持的文件类型，请拖拽音频或图片文件",!0)}})),this.lyricsPanel&&(this.lyricsPanel.addEventListener("dragover",R=>{R.preventDefault(),this.lyricsPanel.style.border="2px dashed rgba(255, 255, 255, 0.5)"}),this.lyricsPanel.addEventListener("dragleave",()=>{this.lyricsPanel.style.border="none"}),this.lyricsPanel.addEventListener("drop",R=>{if(R.preventDefault(),this.lyricsPanel.style.border="none",R.dataTransfer?.files.length){const T=R.dataTransfer.files[0];(T.name.match(/\.(lrc|ttml|yrc|lys|qrc|txt|ass|lqe|lyl|srt|spl)$/i)||T.type==="text/plain"||T.type==="")&&(this.loadLyricFromFile(T),this.updateFileInputDisplay("lyricFile",T))}}))}updateFileInputDisplay(R,T){let L=null;if(R==="musicFile"?L=this.musicFile:R==="lyricFile"?L=this.lyricFile:R==="coverFile"&&(L=this.coverFile),!L)return;if(!T){const F=document.getElementById(`${R}Display`);F&&F.remove();return}const P=document.createElement("span");if(P.className="control-value",P.style="max-width: 100%; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px;",T instanceof File)P.textContent=`${T.name}`;else if(T==="Direct Input")P.textContent=T;else try{const V=new URL(T).pathname.split("/").pop()||T;P.textContent=`${V}`}catch{P.textContent=T}P.id=`${R}Display`;const I=document.getElementById(`${R}Display`);I&&I.remove(),L.parentNode?.insertBefore(P,L)}initStats(){this.stats=new Stats,this.stats.showPanel(0),this.stats.dom.style.display="none",document.body.appendChild(this.stats.dom)}initUI(){if(this.initUploadButtons(),this.lyricsPanel&&this.lyricPlayer.getElement()&&this.lyricsPanel.appendChild(this.lyricPlayer.getElement()),this.updateLyricAreaHint(),this.initLyricDisplayControls(),this.playButton){let R,T=!1;this.playButton.addEventListener("click",L=>{if(T){T=!1;return}if(!this.state.musicUrl||!this.audio.src){L.preventDefault(),this.musicFile&&this.musicFile.click();return}this.audio.src&&this.togglePlayPause()}),this.playButton.addEventListener("mousedown",()=>{T=!1,R=window.setTimeout(()=>{T=!0,this.musicFile&&this.musicFile.click()},3e3)}),this.playButton.addEventListener("mouseup",()=>{clearTimeout(R)}),this.playButton.addEventListener("mouseleave",()=>{clearTimeout(R)}),this.playButton.addEventListener("contextmenu",L=>(L.preventDefault(),this.musicFile&&this.musicFile.click(),!1)),this.playButton.addEventListener("touchstart",L=>{R=window.setTimeout(()=>{this.musicFile&&this.musicFile.click()},3e3)},{passive:!0}),this.playButton.addEventListener("touchend",()=>{clearTimeout(R)},{passive:!0}),this.playButton.addEventListener("touchcancel",()=>{clearTimeout(R)},{passive:!0})}this.player&&typeof this.player.appendChild=="function"&&(this.player.appendChild(this.audio),this.player.appendChild(this.background.getElement()),this.player.appendChild(this.coverBlurBackground),this.lyricsPanel?(this.lyricsPanel.appendChild(this.lyricPlayer.getElement()),this.lyricsPanel.addEventListener("click",R=>{this.hasLyrics||this.lyricFile&&this.lyricFile.click()}),this.lyricsPanel.addEventListener("touchend",R=>{this.hasLyrics||(R.preventDefault(),this.lyricFile&&this.lyricFile.click())},{passive:!1})):this.player.appendChild(this.lyricPlayer.getElement())),this.initCoverBlurBackground(),this.updateBackground(),this.background.setAlbum(DEFAULT_AMLL_COVER_URL),this.setDefaultColors(),this.controlPanel&&(this.controlPanel.style.width="0px",this.controlPanel.style.right="-50px",this.controlPanel.style.opacity="0"),this.adjustLyricPosition(),this.updateAlbumSidePanel(),this.updateLayoutByOrientation()}async loadMusicFromFile(R){try{const T=R.type.startsWith("audio/"),L=/\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(R.name);if(!T&&!L){this.showStatus(t$3("musicLoadFailed"),!0);return}const P=URL.createObjectURL(R);this.state.musicUrl=P,this.audio.crossOrigin="anonymous",this.audio.src=P,this.audio.load(),this.playControls&&(this.playControls.style.bottom="",this.playControls.style.opacity=""),this.progressBar&&(this.progressBar.style.width=""),this.state.autoPlay?this.togglePlayPause():(this.state.isPlaying=!1,this.updatePlayButton()),await this.parseAudioMetadata(R),this.updateMediaSessionMetadata(),this.controlPanel&&(this.controlPanel.style.width="0px",this.controlPanel.style.right="-50px",this.controlPanel.style.opacity="0"),this.updateFileInputDisplay("musicFile",R),this.showStatus(t$3("musicLoadSuccess"))}catch{this.showStatus(t$3("musicLoadFailed"),!0)}}async loadLyricFromFile(R){try{const T=/\.(lrc|ttml|yrc|lys|qrc|txt|ass|lqe|lyl|srt|spl)$/i.test(R.name),L=R.type==="text/plain"||R.type==="";if(!T&&!L){this.showStatus(t$3("lyricsLoadFailed"),!0);return}const P=await R.text(),I=URL.createObjectURL(new Blob([P],{type:"text/plain"}));this.state.lyricUrl=I,await this.loadLyricContent(P,R.name),this.updateFileInputDisplay("lyricFile",R),this.showStatus(t$3("lyricsLoadSuccess"))}catch{this.showStatus(t$3("lyricsLoadFailed"),!0)}}async loadCoverFromFile(R){try{const T=URL.createObjectURL(R);this.state.coverUrl=T,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(T)),await this.extractAndProcessCoverColor(T),this.applyDominantColorAsCSSVariable(),this.updateBackground(),this.updateSongInfo(),this.updateFileInputDisplay("coverFile",R),this.showStatus(t$3("coverLoadSuccess"))}catch{this.showStatus(t$3("coverLoadFailed"),!0)}}async loadFromURLs(){let R=this.musicUrl?.value,T=this.lyricUrl?.value,L=this.coverUrl?.value;const P=new URLSearchParams(window.location.search),I=P.get("music");I&&this.musicUrl&&(R=I,this.musicUrl.value=I);const F=P.get("lyric");F&&this.lyricUrl&&(T=F,this.lyricUrl.value=T);const D=P.get("cover");D&&this.coverUrl&&(L=D,this.coverUrl.value=D);const V=P.get("x"),q=P.get("ms"),G=P.get("vol"),z=P.get("loop")==="1"||P.get("loop")==="true",Q=P.get("t");if(V){const gt=parseFloat(V);!isNaN(gt)&&gt>0&&this.playbackRateControl&&(this.playbackRateControl.value=gt.toString(),this.audio&&(this.audio.playbackRate=gt),this.playbackRateValue&&(this.playbackRateValue.textContent=gt.toFixed(2)+"x"),this.updatePlaybackRateIcon(gt),this.state.playbackRate=gt)}if(q){const gt=parseInt(q);isNaN(gt)||(this.lyricDelayInput&&(this.lyricDelayInput.value=gt.toString()),this.applyLyricDelay(gt,{skipSave:!0}))}if(G){const gt=parseFloat(G);if(!isNaN(gt)){let Et;gt>1&&gt<=100?Et=gt/100:gt>=0&&gt<=1?Et=gt:Et=.5,this.volumeControl&&(this.volumeControl.value=Math.round(Et*100).toString(),this.audio&&(this.audio.volume=Et),this.volumeValue&&(this.volumeValue.textContent=Math.round(Et*100)+"%"),this.updateVolumeIcon(Math.round(Et*100)),this.state.volume=Math.round(Et*100))}}P.has("loop")&&this.loopPlayCheckbox&&(this.loopPlayCheckbox.checked=z,this.state.loopPlay=z);const J=P.get("title");J&&this.songTitleInput&&(this.songTitleInput.value=J,this.state.songTitle=J);const tt=P.get("artist");if(tt&&this.songArtistInput&&(this.songArtistInput.value=tt,this.state.songArtist=tt),this.state.songTitle&&(this.state.songArtist?document.title=`${this.state.songArtist} - ${this.state.songTitle} | AMLL Web Player`:document.title=`${this.state.songTitle} | AMLL Web Player`),R&&(this.state.musicUrl=R,this.audio.src=R,this.audio.load(),this.playControls&&(this.playControls.style.bottom="",this.playControls.style.opacity=""),this.progressBar&&(this.progressBar.style.width=""),this.state.autoPlay?this.togglePlayPause():(this.state.isPlaying=!1,this.updatePlayButton()),this.updateMediaSessionMetadata(),this.updateFileInputDisplay("musicFile",R)),T)if(this.state.lyricUrl=T,/^https?:\/\/.+/.test(T.trim()))try{const kt=await(await fetch(T)).text(),ne=isESLyRiCFormat(kt),Se=isLyRiCA2Format(kt);T.endsWith(".lrc")?ne||Se?await this.loadLyricContent(kt,T):await this.loadLyricContent(kt,T):await this.loadLyricContent(kt,T),this.updateFileInputDisplay("lyricFile",T)}catch{this.showStatus(t$3("lyricsUrlLoadFailed"),!0)}else await this.processLyricInput(T);if(L)if(/^https?:\/\/.+/.test(L.trim()))this.state.coverUrl=L,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(L)),await this.extractAndProcessCoverColor(L),this.applyDominantColorAsCSSVariable(),this.updateFileInputDisplay("coverFile",L);else{const Et=/^data:([^;]+)(;charset=([^;]+))?;base64,([A-Za-z0-9+/=]+)$/,kt=L.trim().match(Et);if(kt){const ne=kt[1]||"image/png";kt[3],this.state.coverUrl=L,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(L)),await this.extractAndProcessCoverColor(L),this.applyDominantColorAsCSSVariable(),this.updateFileInputDisplay("coverFile",`Base64 Encoded Input (${ne})`)}else this.state.coverUrl=L,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(L)),await this.extractAndProcessCoverColor(L),this.applyDominantColorAsCSSVariable(),this.updateFileInputDisplay("coverFile",L)}this.updateSongInfo(),this.controlPanel&&(this.controlPanel.style.width="0px",this.controlPanel.style.right="-50px",this.controlPanel.style.opacity="0");const yt=this.state.songTitle,At=this.state.songArtist;if(yt&&(At?document.title=`${At} - ${yt} | AMLL Web Player`:document.title=`${yt} | AMLL Web Player`),Q&&this.audio){const gt=parseFloat(Q);!isNaN(gt)&&gt>=0&&(this.audio.currentTime=gt)}this.saveBackgroundSettings(),this.showStatus(t$3("loadFromUrlComplete"))}async loadFromFiles(){const R=this.musicFile?.files?.[0],T=this.lyricFile?.files?.[0],L=this.coverFile?.files?.[0];R&&await this.loadMusicFromFile(R),T&&await this.loadLyricFromFile(T),L&&await this.loadCoverFromFile(L)}async processCoverInput(R){if(!R.trim())return;if(/^https?:\/\/.+/.test(R.trim())){this.state.coverUrl=R,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(R)),await this.extractAndProcessCoverColor(R),this.applyDominantColorAsCSSVariable(),this.updateFileInputDisplay("coverFile",R);return}const L=/^data:([^;]+)(;charset=([^;]+))?;base64,([A-Za-z0-9+/=]+)$/,P=R.trim().match(L);if(P){const I=P[1]||"image/png";P[3],this.state.coverUrl=R,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(R)),await this.extractAndProcessCoverColor(R),this.applyDominantColorAsCSSVariable(),this.updateFileInputDisplay("coverFile",`Base64 Encoded Input (${I})`);return}this.state.coverUrl=R,this.updateBackground(),this.background.setAlbum(resolveDefaultCover(R)),await this.extractAndProcessCoverColor(R),this.applyDominantColorAsCSSVariable(),this.updateFileInputDisplay("coverFile",R)}async processLyricInput(R){if(!R.trim())return;if(/^https?:\/\/.+/.test(R.trim())){await this.loadFromURLs();return}const L=/^data:([^;]+)(;charset=([^;]+))?;base64,([A-Za-z0-9+/=]+)$/,P=R.trim().match(L);if(P){try{const I=P[1]||"text/plain",F=P[3]||"utf-8",D=P[4],V=atob(D),q=new Uint8Array(V.length);for(let z=0;z<V.length;z++)q[z]=V.charCodeAt(z);let G;try{G=new TextDecoder(F).decode(q)}catch{G=new TextDecoder("utf-8").decode(q)}await this.loadLyricContent(G,"direct-input.txt"),this.updateFileInputDisplay("lyricFile",`Base64 Encoded Input (${I})`),this.showStatus(t$3("lyricsParseSuccess"))}catch(I){console.error("Base64 decoding error:",I),this.showStatus(t$3("lyricsParseFailed"),!0)}return}try{await this.loadLyricContent(R,"direct-input.txt"),this.updateFileInputDisplay("lyricFile","Direct Input"),this.showStatus(t$3("lyricsParseSuccess"))}catch(I){console.error("Direct lyric input error:",I),this.showStatus(t$3("lyricsParseFailed"),!0)}}async loadLyricContent(R,T){try{let L=[];const P=isESLyRiCFormat(R),I=isLyRiCA2Format(R);if(T.endsWith(".ttml"))L=parseTTML$1(R).lines.map(this.mapTTMLLyric);else if(T.endsWith(".ass")){const F=assToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(T.endsWith(".lrc"))if(P){const F=parseESLyRiC(R),D=convertToTTML(F);L=parseTTML$1(D).lines.map(this.mapTTMLLyric)}else if(I){const F=parseLyRiCA2(R),D=convertToTTML(F);L=parseTTML$1(D).lines.map(this.mapTTMLLyric)}else if(isWalaokeFormat(R)){const F=parseWalaoke(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(isSPLFormat(R)){const F=parseSPL(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else L=parseLrc$1(R).map(this.mapLyric);else if(T.endsWith(".yrc"))L=parseYrc$1(R).map(this.mapLyric);else if(T.endsWith(".lys"))L=parseLys$1(R).map(this.mapLyric);else if(T.endsWith(".qrc"))L=parseQrc$1(R).map(this.mapLyric);else if(T.endsWith(".lqe"))if(R.includes("[lyrics: format@Lyricify Syllable]"))L=parseLys$1(R).map(this.mapLyric);else{const F=lqeToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(T.endsWith(".srt")){const F=srtToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(T.endsWith(".lyl")){const F=lylToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(T.endsWith(".spl")){const F=parseSPL(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(P){const F=parseESLyRiC(R),D=convertToTTML(F);L=parseTTML$1(D).lines.map(this.mapTTMLLyric)}else if(I){const F=parseLyRiCA2(R),D=convertToTTML(F);L=parseTTML$1(D).lines.map(this.mapTTMLLyric)}else if(isWalaokeFormat(R)){const F=parseWalaoke(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(isSPLFormat(R)){const F=parseSPL(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(isSrtFormat(R)){const F=srtToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(isLqeFormat(R)){const F=lqeToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(isAssFormat(R)){const F=assToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else if(isLylFormat(R)){const F=lylToTTML(R);L=parseTTML$1(F).lines.map(this.mapTTMLLyric)}else L=parseLrc$1(R).map(this.mapLyric);this.originalLyricLines=JSON.parse(JSON.stringify(L)),this.hasLyrics=L.length>0,this.updateLyricsDisplay(),this.lyricsPanel&&this.hasLyrics&&this.lyricAreaHint&&this.lyricAreaHint.remove(),this.updateLyricAreaHint(),this.showStatus(`${t$3("lyricsParseSuccess")}${L.length} 行`)}catch(L){console.error("Lyric parsing error:",L),this.showStatus(t$3("lyricsParseFailed"),!0)}}mapLyric(R){return{words:R.words.map(T=>({obscene:!1,...T})),startTime:R.words[0]?.startTime??0,endTime:R.words[R.words.length-1]?.endTime??Number.POSITIVE_INFINITY,translatedLyric:"",romanLyric:"",isBG:!1,isDuet:!1}}mapTTMLLyric(R){return{...R,words:R.words.map(T=>({obscene:!1,...T}))}}findNextLyricLineStartTime(R){if(!this.processedLyricLines||this.processedLyricLines.length===0)return R;const T=R+this.state.lyricDelay;for(let L=0;L<this.processedLyricLines.length;L++){const P=this.processedLyricLines[L];if(P.startTime>=T)return P.startTime}return this.processedLyricLines[this.processedLyricLines.length-1].startTime}applyUrlStyleSideEffects(R,T){switch(R){case"lyricDelay":{const L=Math.round(Number(T));if(Number.isNaN(L))return;this.state.lyricDelay=L,this.pendingLyricDelay=L,this.urlLyricDelayOverride=L,this.lyricDelayInput&&(this.lyricDelayInput.value=L.toString());break}case"playbackRate":{const L=Number(T);if(Number.isNaN(L)||L<=0)return;this.state.playbackRate=L,this.playbackRateControl&&(this.playbackRateControl.value=L.toString()),this.playbackRateValue&&(this.playbackRateValue.textContent=`${L.toFixed(2)}x`),this.updatePlaybackRateIcon(L);break}case"volume":{let L=Number(T);if(Number.isNaN(L))return;L=Math.max(0,Math.min(100,Math.round(L))),this.state.volume=L,this.volumeControl&&(this.volumeControl.value=L.toString()),this.volumeValue&&(this.volumeValue.textContent=`${L}%`),this.updateVolumeIcon(L);break}case"loopPlay":{const L=!!T;this.state.loopPlay=L,this.loopPlayCheckbox&&(this.loopPlayCheckbox.checked=L);break}case"autoPlay":{this.state.autoPlay=!!T;break}case"lyricAlignAnchor":{if(typeof T=="string"){const L=T==="top"||T==="bottom"?T:"center";this.state.lyricAlignAnchor=L,this.lyricAlignAnchorSelect&&(this.lyricAlignAnchorSelect.value=L)}break}case"lyricAlignPosition":{const L=Number(T);Number.isNaN(L)||(this.state.lyricAlignPosition=L,this.lyricAlignPosition&&(this.lyricAlignPosition.value=L.toString()),this.lyricAlignPositionValue&&(this.lyricAlignPositionValue.textContent=L.toFixed(1)));break}case"lyricFontSize":{const L=Number(T);if(!Number.isNaN(L)){const P=Math.max(50,Math.min(200,Math.round(L)));this.state.lyricFontSize=P,this.lyricFontSize&&(this.lyricFontSize.value=P.toString()),this.lyricFontSizeValue&&(this.lyricFontSizeValue.textContent=`${P}%`)}break}}}updateLyricsDisplay(){if(!this.hasLyrics)return;const R=this.originalLyricLines.map(D=>({...D})),T=this.audio.currentTime,L=R.map(D=>{const V={...D};if(this.state.showTranslatedLyric||(V.translatedLyric=""),this.state.showRomanLyric||(V.romanLyric=""),this.state.swapLyricPositions){const G=V.translatedLyric;V.translatedLyric=V.romanLyric,V.romanLyric=G}!this.state.showbgLyric&&V.isBG&&(V.lyric="",V.translatedLyric="",V.romanLyric="",V.words&&V.words.length>0&&(V.words=V.words.map(G=>({...G,word:""})))),this.state.swapDuetsPositions&&(V.isDuet=!D.isDuet,V.words&&V.words.length>0&&(V.words=V.words.map(G=>({...G,isDuet:V.isDuet}))));const q=D.endTime<=T;return this.state.hidePassedLyrics&&q&&(V.translatedLyric="",V.romanLyric="",V.lyric="",V.words&&V.words.length>0&&(V.words=V.words.map(G=>({...G,word:"",translated:"",roman:""})))),this.state.advanceLyricTiming&&(V.startTime=Math.max(0,V.startTime-.4),V.endTime=Math.max(0,V.endTime+.4)),V}),P=this.state.showbgLyric?L:L.filter(D=>!D.isBG);this.processedLyricLines=P,this.lyricPlayer.setLyricLines(this.processedLyricLines),this.lyricPlayer.setHidePassedLines(this.state.hidePassedLyrics);const I=this.audio.currentTime*1e3,F=this.findNextLyricLineStartTime(I);this.lyricPlayer.setCurrentTime(F),setTimeout(()=>{const D=this.audio.currentTime*1e3,V=this.pendingLyricDelay??this.state.lyricDelay;this.lyricPlayer.setCurrentTime(D+V),this.pendingLyricDelay=null},50)}initLyricDisplayControls(){this.showTranslatedLyricCheckbox&&(this.showTranslatedLyricCheckbox.checked=this.state.showTranslatedLyric,this.showTranslatedLyricCheckbox.addEventListener("change",R=>{this.state.showTranslatedLyric=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.showRomanLyricCheckbox&&(this.showRomanLyricCheckbox.checked=this.state.showRomanLyric,this.showRomanLyricCheckbox.addEventListener("change",R=>{this.state.showRomanLyric=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.swapLyricPositionsCheckbox&&(this.swapLyricPositionsCheckbox.checked=this.state.swapLyricPositions,this.swapLyricPositionsCheckbox.addEventListener("change",R=>{this.state.swapLyricPositions=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.showbgLyricCheckbox&&(this.showbgLyricCheckbox.checked=this.state.showbgLyric,this.showbgLyricCheckbox.addEventListener("change",R=>{this.state.showbgLyric=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.swapDuetsPositionsCheckbox&&(this.swapDuetsPositionsCheckbox.checked=this.state.swapDuetsPositions,this.swapDuetsPositionsCheckbox.addEventListener("change",R=>{if(this.state.swapDuetsPositions=R.target.checked,window.matchMedia("(orientation: portrait)").matches){const L=this.albumSidePanel?.querySelector(".song-info-container");L&&this.albumInfo&&this.albumCoverContainer&&(this.state.swapDuetsPositions?(L.insertBefore(this.albumInfo,this.albumCoverContainer),this.albumCoverContainer.style.marginRight="0",this.albumCoverContainer.style.marginLeft="15px",this.albumInfo.style.textAlign="right"):(L.insertBefore(this.albumCoverContainer,this.albumInfo),this.albumCoverContainer.style.marginLeft="0",this.albumCoverContainer.style.marginRight="15px",this.albumInfo.style.textAlign="left"))}else this.albumSidePanel&&this.lyricsPanel&&this.player&&(this.state.swapDuetsPositions?this.player.insertBefore(this.lyricsPanel,this.albumSidePanel):this.player.insertBefore(this.albumSidePanel,this.lyricsPanel));this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.hidePassedLyricsCheckbox&&(this.hidePassedLyricsCheckbox.checked=this.state.hidePassedLyrics,this.hidePassedLyricsCheckbox.addEventListener("change",R=>{this.state.hidePassedLyrics=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.advanceLyricTimingCheckbox&&(this.advanceLyricTimingCheckbox.checked=this.state.advanceLyricTiming,this.advanceLyricTimingCheckbox.addEventListener("change",R=>{this.state.advanceLyricTiming=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()})),this.singleLyricsCheckbox&&(this.singleLyricsCheckbox.checked=this.state.singleLyrics,this.singleLyricsCheckbox.addEventListener("change",R=>{this.state.singleLyrics=R.target.checked,this.updateLyricsDisplay(),this.saveBackgroundSettings()}))}togglePlayPause(){this.audio.paused?(this.state.isPlaying=!0,this.updatePlayButton(),this.audio.play().catch(R=>{console.error("Playback failed:",R),this.state.isPlaying=!1,this.updatePlayButton()})):(this.state.isPlaying=!1,this.updatePlayButton(),this.audio.pause())}updatePlayButton(){const R=this.playButton;this.landscapePlayBtn,R&&(R.innerHTML=this.state.isPlaying?'<svg aria-hidden="true" width="1em" height="1em" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 2a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H5Zm8 0a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h2a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-2Z" fill="currentColor"></path></svg>':'<svg aria-hidden="true" width="1em" height="1em" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.22 8.68a1.5 1.5 0 0 1 0 2.63l-10 5.5A1.5 1.5 0 0 1 5 15.5v-11A1.5 1.5 0 0 1 7.22 3.2l10 5.5Z" fill="currentColor"></path></svg>')}updateProgress(){if(this.state.duration>0)if(this.state.isRangeMode&&this.state.rangeEndTime>this.state.rangeStartTime){const R=this.state.rangeEndTime-this.state.rangeStartTime,L=Math.max(0,Math.min(R,this.state.currentTime-this.state.rangeStartTime))/R*100,P=this.state.rangeStartTime/this.state.duration*100,F=this.state.rangeEndTime/this.state.duration*100-P;this.rangeProgressBar&&(this.rangeProgressBar.style.left=`${P}%`,this.rangeProgressBar.style.width=`${F}%`),this.progressFill&&(this.progressFill.style.left=`${P}%`,this.progressFill.style.width=`${L*F/100}%`),this.landscapeProgressFill&&(this.landscapeProgressFill.style.left=`${P}%`,this.landscapeProgressFill.style.width=`${L*F/100}%`)}else{const R=this.state.currentTime/this.state.duration*100;this.progressFill&&(this.progressFill.style.left="0%",this.progressFill.style.width=`${R}%`),this.landscapeProgressFill&&(this.landscapeProgressFill.style.left="0%",this.landscapeProgressFill.style.width=`${R}%`)}}updateTimeDisplay(){let R,T,L;if(this.state.isRangeMode&&this.state.rangeEndTime>this.state.rangeStartTime){const P=this.state.rangeEndTime-this.state.rangeStartTime,I=Math.max(0,Math.min(P,this.state.currentTime-this.state.rangeStartTime));if(R=this.formatTime(I),T=this.formatTime(P),this.state.showRemainingTime){const F=this.formatTime(P-I);L=`${R} / -${F}`}else L=`${R} / ${T}`}else if(R=this.formatTime(this.state.currentTime),T=this.formatTime(this.state.duration),!isFinite(this.state.duration)||isNaN(this.state.duration))L=`${R} / --:--`;else if(this.state.showRemainingTime&&this.state.duration>0){const P=this.formatTime(this.state.duration-this.state.currentTime);L=`${R} / -${P}`}else L=`${R} / ${T}`;this.timeDisplay&&(this.timeDisplay.textContent=L),this.landscapeTimeDisplay&&(this.landscapeTimeDisplay.textContent=L),this.timeDisplay&&this.timeDisplay.offsetHeight,this.landscapeTimeDisplay&&this.landscapeTimeDisplay.offsetHeight}formatTime(R){const T=Math.floor(R/60),L=Math.floor(R%60);return`${T.toString().padStart(2,"0")}:${L.toString().padStart(2,"0")}`}updateCoverStyle(){this.coverStyleSelect&&(this.coverStyleSelect.value=this.state.coverStyle),this.applyCoverStyle()}applyCoverStyle(){if(this.albumCoverContainer)switch(this.albumCoverContainer.style.boxShadow="",this.albumCoverContainer.style.transform="",this.albumCoverContainer.style.background="",this.albumCoverContainer.style.border="",this.albumCoverContainer.style.filter="",this.coverStyleDynamic&&this.coverStyleDynamic.parentNode&&(this.coverStyleDynamic.parentNode.removeChild(this.coverStyleDynamic),this.coverStyleDynamic=null),this.state.coverStyle){case"normal":this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)";break;case"innerShadow":const R=this.state.roundedCover/100*50,T=document.createElement("style");T.id="coverStyleDynamic",this.coverStyleDynamic=T,T.textContent=`
          #albumCoverContainer {
            position: relative;
          }
          #albumCoverContainer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            box-shadow: inset 0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18);
            pointer-events: none;
            z-index: 10;
            border-radius: ${R}%;
          }
          #albumCoverLarge {
            position: relative;
            z-index: 5;
          }
        `,document.head.appendChild(T);break;case"threeDShadow":this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)";break;case"longShadow":const L=this.state.roundedCover/100*50,P=document.createElement("style");P.id="coverStyleDynamic",this.coverStyleDynamic=P,P.textContent=`
          #albumCoverContainer {
            position: relative;
            overflow: visible !important; /* 确保长投影不被裁剪 */
            box-shadow: none !important; /* 移除默认阴影以避免干扰 */
          }
          #albumCoverContainer::before,
          #albumCoverContainer::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            border-radius: ${L}%;
          }
          #albumCoverContainer::before {
            transform-origin: 0 50%;
            transform: translate(100%, 0) skewY(45deg) scaleX(.6);
            background: linear-gradient(90deg, rgba(0, 0, 0, .3), transparent);
            animation: shadowMoveY 5s infinite linear alternate;
          }
          #albumCoverContainer::after {
            transform-origin: 0 0;
            transform: translate(0%, 100%) skewX(45deg) scaleY(.6);
            background: linear-gradient(180deg, rgba(0, 0, 0, .3), transparent);
            animation: shadowMoveX 5s infinite linear alternate;
          }
          @keyframes shadowMoveX {
            to {
              transform: translate(0%, 100%) skewX(50deg) scaleY(.6);
            }
          }
          @keyframes shadowMoveY {
            to {
              transform: translate(100%, 0) skewY(40deg) scaleX(.6);
            }
          }
        `,document.head.appendChild(P);break;case"neumorphismA":const I=this.state.roundedCover/100*50;this.albumCoverContainer.style.boxShadow="7px 7px 12px var(--dominant-color-dark), -7px -7px 12px var(--dominant-color-light), inset 0 0 0 var(--dominant-color-light), inset 0 0 0 var(--dominant-color-dark)",this.albumCoverContainer.style.borderRadius=`${I}%`;break;case"neumorphismB":const F=this.state.roundedCover/100*50,D=document.createElement("style");D.id="coverStyleDynamic",this.coverStyleDynamic=D,D.textContent=`
          #albumCoverContainer {
            position: relative;
          }
          #albumCoverContainer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            box-shadow: 0 0 0 var(--dominant-color-dark), 0 0 0 var(--dominant-color-light), inset -7px -7px 12px var(--dominant-color-light), inset 7px 7px 12px var(--dominant-color-dark);
            pointer-events: none;
            z-index: 10;
            border-radius: ${F}%;
          }
          #albumCoverLarge {
            position: relative;
            z-index: 5;
            border-radius: ${F}%;
          }
        `,document.head.appendChild(D);break;case"reflection":this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)";break;case"cd":this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)";break;case"vinyl":this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)";break;case"colored":this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)";break}}seekToPosition(R){const T=this.progressBar;if(T&&this.state.duration>0){const L=T.getBoundingClientRect();let P=0,I=0;R instanceof MouseEvent?(I=R.clientX,P=(I-L.left)/L.width):R instanceof TouchEvent&&R.touches.length>0&&(I=R.touches[0].clientX,P=(I-L.left)/L.width),this.showTooltip(T,I);let F=P*this.state.duration;this.state.isRangeMode&&this.state.rangeStartTime!==void 0&&this.state.rangeEndTime!==void 0&&(F=Math.max(this.state.rangeStartTime,Math.min(this.state.rangeEndTime,F))),this.audio.currentTime=F,this.state.currentTime=F;const D=this.findNextLyricLineStartTime(F*1e3);this.lyricPlayer.setCurrentTime(D),setTimeout(()=>{const V=F*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(V)},50),this.updateProgress(),this.updateTimeDisplay()}}toggleFullscreen(){if(!document.fullscreenElement)/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0?(async()=>{try{await document.documentElement.requestFullscreen();const L=screen.orientation;if(L&&L.lock)try{await L.lock("landscape")}catch{}this.fullscreenEnterIcon&&this.fullscreenExitIcon&&(this.fullscreenEnterIcon.style.display="none",this.fullscreenExitIcon.style.display="inline")}catch{}})():(document.documentElement.requestFullscreen(),this.fullscreenEnterIcon&&this.fullscreenExitIcon&&(this.fullscreenEnterIcon.style.display="none",this.fullscreenExitIcon.style.display="inline"));else{document.exitFullscreen();const R=screen.orientation;if(R&&R.unlock)try{R.unlock()}catch{}this.fullscreenEnterIcon&&this.fullscreenExitIcon&&(this.fullscreenEnterIcon.style.display="inline",this.fullscreenExitIcon.style.display="none")}}toggleControlPanel(){this.controlPanel&&(this.controlPanel.style.width==="0px"?(this.controlPanel.style.width="320px",this.controlPanel.style.right="20px",this.controlPanel.style.opacity="1"):(this.controlPanel.style.width="0px",this.controlPanel.style.right="-50px",this.controlPanel.style.opacity="0"))}handleKeyboard(R){const T=document.activeElement;if(!(T&&(T.tagName==="INPUT"||T.tagName==="TEXTAREA")))switch(R.key){case" ":R.preventDefault(),this.togglePlayPause();break;case"ArrowLeft":this.audio.currentTime=Math.max(0,this.audio.currentTime-10);const L=this.findNextLyricLineStartTime(this.audio.currentTime*1e3);this.lyricPlayer.setCurrentTime(L),setTimeout(()=>{const I=this.audio.currentTime*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(I)},50);break;case"ArrowRight":this.audio.currentTime=Math.min(this.audio.duration,this.audio.currentTime+10);const P=this.findNextLyricLineStartTime(this.audio.currentTime*1e3);this.lyricPlayer.setCurrentTime(P),setTimeout(()=>{const I=this.audio.currentTime*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(I)},50);break;case"f":this.toggleFullscreen();break;case"h":this.toggleControlPanel();break}}setupTouchEvents(){let R=0,T=0;document.addEventListener("touchend",L=>{const P=L.changedTouches[0],I=window.innerWidth,F=window.innerHeight,D=P.clientX,V=P.clientY;if(D>I-200&&V>F-200){const q=Date.now();q-T<800?R++:R=1,T=q,R>=5&&(R=0,this.state.showFPS=!this.state.showFPS,this.updateFPSDisplay(),this.showFPSCheckbox&&(this.showFPSCheckbox.checked=this.state.showFPS),this.saveBackgroundSettings(),this.gui&&(this.gui.domElement.style.display=this.gui.domElement.style.display==="none"?"block":"none"),this.stats.dom.style.display=this.stats.dom.style.display==="none"?"block":"none")}else R=0},{passive:!0})}resetPlayer(){this.resetUploadButtons(),Object.assign(this.state,cloneDefaultState()),this.audio.pause(),this.audio.currentTime=0,this.audio.src="",this.state.musicUrl="",this.state.isPlaying=!1,this.state.manualDominantColor=null,this.state.manualDominantColorLight=null,this.state.manualDominantColorDark=null,this.playControls&&(this.playControls.style.bottom="10px",this.playControls.style.opacity="1"),this.progressBar&&(this.progressBar.style.width="72vw"),this.hasLyrics=!1,this.lyricPlayer.setLyricLines([]),this.updateLyricAreaHint(),this.updateFileInputDisplay("musicFile",""),this.updateFileInputDisplay("coverFile",""),this.updateFileInputDisplay("lyricFile",""),this.background.setAlbum(DEFAULT_AMLL_COVER_URL),this.setDefaultColors(),this.isColorsInitialized=!1,this.initColors(),this.state.roundedCover=DEFAULT_PLAYER_STATE.roundedCover,this.updateRoundedCover(),this.state.backgroundRenderScale=DEFAULT_PLAYER_STATE.backgroundRenderScale;const R=window.devicePixelRatio||1;this.background.setRenderScale(this.state.backgroundRenderScale*R),this.state.lyricAlignPosition=DEFAULT_PLAYER_STATE.lyricAlignPosition,this.lyricPlayer.setAlignPosition(this.state.lyricAlignPosition),this.state.lyricFontSize=DEFAULT_PLAYER_STATE.lyricFontSize,this.updateLyricFontSize(),this.state.hidePassedLyrics=DEFAULT_PLAYER_STATE.hidePassedLyrics,this.lyricPlayer.setHidePassedLines(this.state.hidePassedLyrics),this.state.enableLyricBlur=DEFAULT_PLAYER_STATE.enableLyricBlur,this.lyricPlayer.setEnableBlur(this.state.enableLyricBlur),this.state.enableLyricScale=DEFAULT_PLAYER_STATE.enableLyricScale,this.lyricPlayer.setEnableScale(this.state.enableLyricScale),this.state.enableLyricSpring=DEFAULT_PLAYER_STATE.enableLyricSpring,this.lyricPlayer.setEnableSpring(this.state.enableLyricSpring),this.state.wordFadeWidth=DEFAULT_PLAYER_STATE.wordFadeWidth,this.lyricPlayer.setWordFadeWidth(this.state.wordFadeWidth),this.state.backgroundFPS=DEFAULT_PLAYER_STATE.backgroundFPS,this.background.setFPS(this.state.backgroundFPS),this.state.showTranslatedLyric=DEFAULT_PLAYER_STATE.showTranslatedLyric,this.state.showRomanLyric=DEFAULT_PLAYER_STATE.showRomanLyric,this.state.swapLyricPositions=DEFAULT_PLAYER_STATE.swapLyricPositions,this.state.showbgLyric=DEFAULT_PLAYER_STATE.showbgLyric,this.state.swapDuetsPositions=DEFAULT_PLAYER_STATE.swapDuetsPositions,this.state.singleLyrics=DEFAULT_PLAYER_STATE.singleLyrics,this.state.backgroundLowFreqVolume=DEFAULT_PLAYER_STATE.backgroundLowFreqVolume,this.background.setLowFreqVolume(this.state.backgroundLowFreqVolume),this.state.backgroundBeatEnabled=DEFAULT_PLAYER_STATE.backgroundBeatEnabled,this.syncBackgroundBeatState(),this.state.coverStyle=DEFAULT_PLAYER_STATE.coverStyle,this.state.lyricUrl="",this.state.songTitle="",this.state.songArtist="",this.state.coverUrl="",document.title="AMLL Web Player",this.controlPointCodeInput&&(this.controlPointCodeInput.value="");const T=this.background.renderer;T&&T instanceof hi&&(T.manualControl=!1),this.albumCoverLarge&&(this.albumCoverLarge.src=DEFAULT_AMLL_COVER_URL),this.songTitle&&(this.songTitle.textContent=t$3("title")),this.songArtist&&(this.songArtist.textContent=t$3("artist")),this.songTitleInput&&(this.songTitleInput.value=""),this.songArtistInput&&(this.songArtistInput.value=""),this.updateMediaSessionMetadata();const L=["musicFile","musicUrl","lyricFile","lyricUrl","coverFile","coverUrl","songTitleInput","songArtistInput","lyricDelayInput"];if(this.loopPlayCheckbox&&(this.state.loopPlay=DEFAULT_PLAYER_STATE.loopPlay,this.loopPlayCheckbox.checked=this.state.loopPlay),this.lyricAlignPositionValue&&(this.lyricAlignPositionValue.textContent="0.5"),this.enableLyricBlur&&(this.enableLyricBlur.checked=this.state.enableLyricBlur),this.enableLyricScale&&(this.enableLyricScale.checked=this.state.enableLyricScale),this.enableLyricSpring&&(this.enableLyricSpring.checked=this.state.enableLyricSpring),this.showbgLyricCheckbox&&(this.showbgLyricCheckbox.checked=this.state.showbgLyric),this.swapDuetsPositionsCheckbox&&(this.swapDuetsPositionsCheckbox.checked=this.state.swapDuetsPositions),this.singleLyricsCheckbox&&(this.singleLyricsCheckbox.checked=this.state.singleLyrics),this.bgLowFreqVolume&&(this.bgLowFreqVolume.value=DEFAULT_PLAYER_STATE.backgroundLowFreqVolume.toString()),this.bgLowFreqVolumeValue){const P=I=>`${(80+I*40).toFixed(0)}hz`;this.bgLowFreqVolumeValue.textContent=P(DEFAULT_PLAYER_STATE.backgroundLowFreqVolume)}if(this.posYSpringMassInput&&(this.posYSpringMassInput.value=DEFAULT_PLAYER_STATE.posYSpringMass.toString()),this.springPosYMassValue&&(this.springPosYMassValue.textContent=DEFAULT_PLAYER_STATE.posYSpringMass.toString()),this.posYSpringDampingInput&&(this.posYSpringDampingInput.value=DEFAULT_PLAYER_STATE.posYSpringDamping.toString()),this.springPosYDampingValue&&(this.springPosYDampingValue.textContent=DEFAULT_PLAYER_STATE.posYSpringDamping.toString()),this.posYSpringStiffnessInput&&(this.posYSpringStiffnessInput.value=DEFAULT_PLAYER_STATE.posYSpringStiffness.toString()),this.springPosYStiffnessValue&&(this.springPosYStiffnessValue.textContent=DEFAULT_PLAYER_STATE.posYSpringStiffness.toString()),this.posYSpringSoftCheckbox&&(this.posYSpringSoftCheckbox.checked=DEFAULT_PLAYER_STATE.posYSpringSoft),this.scaleSpringMassInput&&(this.scaleSpringMassInput.value=DEFAULT_PLAYER_STATE.scaleSpringMass.toString()),this.springScaleMassValue&&(this.springScaleMassValue.textContent=DEFAULT_PLAYER_STATE.scaleSpringMass.toString()),this.scaleSpringDampingInput&&(this.scaleSpringDampingInput.value=DEFAULT_PLAYER_STATE.scaleSpringDamping.toString()),this.springScaleDampingValue&&(this.springScaleDampingValue.textContent=DEFAULT_PLAYER_STATE.scaleSpringDamping.toString()),this.scaleSpringStiffnessInput&&(this.scaleSpringStiffnessInput.value=DEFAULT_PLAYER_STATE.scaleSpringStiffness.toString()),this.springScaleStiffnessValue&&(this.springScaleStiffnessValue.textContent=DEFAULT_PLAYER_STATE.scaleSpringStiffness.toString()),this.scaleSpringSoftCheckbox&&(this.scaleSpringSoftCheckbox.checked=DEFAULT_PLAYER_STATE.scaleSpringSoft),this.controlPointCodeInput&&(this.controlPointCodeInput.value=""),this.background&&this.background.renderer&&typeof this.background.renderer.setControlPoints=="function")try{this.background.renderer.setControlPoints([])}catch(P){console.error("Failed to reset control points:",P)}if(this.playbackRateControl){const P=DEFAULT_PLAYER_STATE.playbackRate;this.playbackRateControl.value=P.toString(),this.audio.playbackRate=P,this.state.playbackRate=P,this.playbackRateValue&&(this.playbackRateValue.textContent=`${P.toFixed(2)}x`),this.updatePlaybackRateIcon(P)}if(this.volumeControl){const P=DEFAULT_PLAYER_STATE.volume;this.volumeControl.value=P.toString(),this.audio.volume=P/100,this.state.volume=P,this.volumeValue&&(this.volumeValue.textContent=`${Math.round(P)}%`),this.updateVolumeIcon(Math.round(P))}this.showFPSCheckbox&&(this.showFPSCheckbox.checked=!1),this.controlPanel&&(this.controlPanel.style.width="320px",this.controlPanel.style.right="20px",this.controlPanel.style.opacity="1"),this.musicUrl&&(this.musicUrl.value=""),this.lyricUrl&&(this.lyricUrl.value=""),this.coverUrl&&(this.coverUrl.value=""),L.forEach(P=>{P==="musicUrl"||P==="lyricUrl"||P==="coverUrl"||(P==="musicFile"&&this.musicFile?this.musicFile.value="":P==="lyricFile"&&this.lyricFile?this.lyricFile.value="":P==="coverFile"&&this.coverFile?this.coverFile.value="":P==="songTitleInput"&&this.songTitleInput?this.songTitleInput.value="":P==="songArtistInput"&&this.songArtistInput?this.songArtistInput.value="":P==="lyricDelayInput"&&this.lyricDelayInput&&(this.lyricDelayInput.value=""))}),this.showTranslatedLyricCheckbox&&(this.showTranslatedLyricCheckbox.checked=this.state.showTranslatedLyric),this.showRomanLyricCheckbox&&(this.showRomanLyricCheckbox.checked=this.state.showRomanLyric),this.swapLyricPositionsCheckbox&&(this.swapLyricPositionsCheckbox.checked=this.state.swapLyricPositions),this.updateLyricsDisplay(),this.adjustLyricPosition(),this.updatePlayButton(),localStorage.removeItem(SETTINGS_STORAGE_KEY),this.updateBackgroundUI(),this.updateBackground(),this.updateFPSDisplay(),this.progressFill&&(this.progressFill.style.width="0%"),this.landscapeProgressFill&&(this.landscapeProgressFill.style.width="0%"),this.updateProgress(),this.updateTimeDisplay(),this.updateCoverRotation(),this.showStatus(t$3("playerReset"))}setupMediaSessionHandlers(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{this.audio.play()}),navigator.mediaSession.setActionHandler("pause",()=>{this.audio.pause()}),navigator.mediaSession.setActionHandler("seekbackward",R=>{const T=R.seekOffset||10;let L=Math.max(this.audio.currentTime-T,0);this.state.isRangeMode&&this.state.rangeStartTime!==void 0&&this.state.rangeEndTime!==void 0&&(L=Math.max(this.state.rangeStartTime,Math.min(this.state.rangeEndTime,L))),this.audio.currentTime=L;const P=this.findNextLyricLineStartTime(L*1e3);this.lyricPlayer.setCurrentTime(P),setTimeout(()=>{const I=L*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(I)},50)}),navigator.mediaSession.setActionHandler("seekforward",R=>{const T=R.seekOffset||10;let L=Math.min(this.audio.currentTime+T,this.audio.duration);this.state.isRangeMode&&this.state.rangeStartTime!==void 0&&this.state.rangeEndTime!==void 0&&(L=Math.max(this.state.rangeStartTime,Math.min(this.state.rangeEndTime,L))),this.audio.currentTime=L;const P=this.findNextLyricLineStartTime(L*1e3);this.lyricPlayer.setCurrentTime(P),setTimeout(()=>{const I=L*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(I)},50)}),navigator.mediaSession.setActionHandler("seekto",R=>{if(R.seekTime!==void 0){let T=R.seekTime;this.state.isRangeMode&&this.state.rangeStartTime!==void 0&&this.state.rangeEndTime!==void 0&&(T=Math.max(this.state.rangeStartTime,Math.min(this.state.rangeEndTime,T))),this.audio.currentTime=T;const L=this.findNextLyricLineStartTime(T*1e3);this.lyricPlayer.setCurrentTime(L),setTimeout(()=>{const P=T*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(P)},50)}}),navigator.mediaSession.setActionHandler("previoustrack",()=>{const R=this.state.isRangeMode&&this.state.rangeStartTime!==void 0?this.state.rangeStartTime:0;if(this.audio.currentTime=R,this.processedLyricLines&&this.processedLyricLines.length>0){const T=this.findNextLyricLineStartTime(R*1e3);this.lyricPlayer.setCurrentTime(T),setTimeout(()=>{const L=R*1e3+this.state.lyricDelay;this.lyricPlayer.setCurrentTime(L)},50)}}),navigator.mediaSession.setActionHandler("nexttrack",null))}updateMediaSessionMetadata(){if("mediaSession"in navigator){const R=resolveDefaultCover(this.state.coverUrl);navigator.mediaSession.metadata=new MediaMetadata({title:this.state.songTitle||t$3("title"),artist:this.state.songArtist||t$3("artist"),album:"",artwork:[{src:R,sizes:"96x96",type:"image/png"},{src:R,sizes:"128x128",type:"image/png"},{src:R,sizes:"192x192",type:"image/png"},{src:R,sizes:"256x256",type:"image/png"},{src:R,sizes:"384x384",type:"image/png"},{src:R,sizes:"512x512",type:"image/png"}]})}}refreshMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",null),navigator.mediaSession.setActionHandler("pause",null),navigator.mediaSession.setActionHandler("seekbackward",null),navigator.mediaSession.setActionHandler("seekforward",null),navigator.mediaSession.setActionHandler("seekto",null),navigator.mediaSession.setActionHandler("previoustrack",null),navigator.mediaSession.setActionHandler("nexttrack",null),navigator.mediaSession.metadata=null,setTimeout(()=>{this.updateMediaSessionMetadata(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState=this.state.isPlaying?"playing":"paused")},50),setTimeout(()=>{this.setupMediaSessionHandlers()},100))}updateSongInfo(){this.state.coverUrl&&this.landscapeCover?this.landscapeCover.style.backgroundImage=`url(${this.state.coverUrl})`:this.landscapeCover&&(this.landscapeCover.style.backgroundImage="none"),this.updateAlbumSidePanel(),this.adjustLyricPosition(),this.updateMediaSessionMetadata(),this.updateMarqueeSettings(),this.state.songTitle&&(this.state.songArtist?document.title=`${this.state.songArtist} - ${this.state.songTitle} | AMLL Web Player`:document.title=`${this.state.songTitle} | AMLL Web Player`)}adjustLyricPosition(){const R=this.lyricPlayer.getElement();R&&(window.matchMedia("(min-width: 769px), (orientation: landscape)").matches?R.style.paddingTop="20px":R.style.paddingTop="120px",this.updateLyricAreaHint())}updateAlbumSidePanel(){this.albumCoverLarge&&this.songTitle&&this.songArtist&&(this.state.coverUrl?this.albumCoverLarge.src=this.state.coverUrl:this.albumCoverLarge.src=DEFAULT_AMLL_COVER_URL,this.songTitle.textContent=this.state.songTitle||t$3("title"),this.songArtist.textContent=this.state.songArtist||t$3("artist"),this.updateMarqueeSettings())}handleRangeSelection(R){if(!this.progressBar||!this.state.duration)return;let T;if(R instanceof MouseEvent)T=R.clientX;else if(R instanceof TouchEvent&&R.touches.length>0)T=R.touches[0].clientX;else return;const L=this.progressBar.getBoundingClientRect(),I=Math.max(0,Math.min(1,(T-L.left)/L.width))*this.state.duration;if(this.rangeSelectionCount>=2&&this.clearRangeSelection(),this.rangeSelectionCount===0)this.state.rangeStartTime=I,this.createRangeLine(!0,I);else{if(this.state.rangeEndTime=I,this.createRangeLine(!1,I),this.state.rangeStartTime>this.state.rangeEndTime){const F=this.state.rangeStartTime;if(this.state.rangeStartTime=this.state.rangeEndTime,this.state.rangeEndTime=F,this.rangeStartLine&&this.rangeEndLine){const D=this.rangeStartLine.style.left;this.rangeStartLine.style.left=this.rangeEndLine.style.left,this.rangeEndLine.style.left=D}}this.state.isRangeMode=!0,this.createRangeProgressBar(),this.updateTimeDisplay(),this.audio&&(this.audio.currentTime=this.state.rangeStartTime)}this.rangeSelectionCount++}createRangeLine(R,T){if(!this.progressBar||!this.state.duration)return;const L=T/this.state.duration*100,P=document.createElement("div");P.style.cssText=`
      position: absolute;
      top: 0;
      bottom: 0;
      width: 1px;
      background-color: ${R?"#4CAF50":"#FF5252"};
      left: ${L}%;
      cursor: pointer;
    `,P.addEventListener("click",I=>{I.stopPropagation(),this.exitRangeMode()}),this.addLongPressAndRightClickHandler(P,()=>{this.exitRangeMode()}),R?this.rangeStartLine=P:this.rangeEndLine=P,this.progressBar.appendChild(P)}createRangeProgressBar(){if(!this.progressBar||!this.state.duration||this.state.rangeEndTime<=this.state.rangeStartTime)return;const R=this.state.rangeStartTime/this.state.duration*100,L=this.state.rangeEndTime/this.state.duration*100-R,P=document.createElement("div");P.style.cssText=`
      position: absolute;
      top: 0;
      height: 100%;
      left: ${R}%;
      width: ${L}%;
      z-index: 5;
    `,this.rangeProgressBar=P,this.progressBar.appendChild(P)}clearRangeSelection(){this.rangeStartLine&&this.rangeStartLine.parentNode&&(this.rangeStartLine.parentNode.removeChild(this.rangeStartLine),this.rangeStartLine=null),this.rangeEndLine&&this.rangeEndLine.parentNode&&(this.rangeEndLine.parentNode.removeChild(this.rangeEndLine),this.rangeEndLine=null),this.rangeProgressBar&&this.rangeProgressBar.parentNode&&(this.rangeProgressBar.parentNode.removeChild(this.rangeProgressBar),this.rangeProgressBar=null),this.rangeSelectionCount=0}exitRangeMode(){this.state.isRangeMode=!1,this.clearRangeSelection(),this.state.rangeStartTime=0,this.state.rangeEndTime=0,this.updateProgress(),this.updateTimeDisplay()}async parseAudioMetadata(R){try{console.log("Parsing audio metadata, file:",R.name,"size:",R.size);const T=window.jsmediatags;T?T.read(R,{onSuccess:L=>{console.log("Audio metadata parsed successfully, full data:",L),console.log("tags:",L.tags);let P=!1;if(L.tags&&L.tags.title&&(this.state.songTitle=L.tags.title,this.songTitleInput&&(this.songTitleInput.value=L.tags.title),console.log("Extracted song title:",L.tags.title),P=!0),L.tags&&L.tags.artist&&(this.state.songArtist=L.tags.artist,this.songArtistInput&&(this.songArtistInput.value=L.tags.artist),console.log("Extracted song artist:",L.tags.artist),P=!0),L.tags&&L.tags.picture){console.log("Found cover image:",L.tags.picture);const{data:I,format:F}=L.tags.picture;let D="";for(let q=0;q<I.length;q++)D+=String.fromCharCode(I[q]);const V=`data:${F};base64,${window.btoa(D)}`;if(this.state.coverUrl=V,this.coverUrl)if(V.length>65536){const G=`data:${F};base64,`,z=65536-G.length;let Q=G+V.substring(G.length,G.length+z);for(;Q.length%4!==0;)Q=Q.substring(0,Q.length-1);this.coverUrl.value=Q}else this.coverUrl.value=V;this.background.setAlbum(resolveDefaultCover(V)),this.extractAndProcessCoverColor(V),this.applyDominantColorAsCSSVariable(),this.updateBackground(),this.updateFileInputDisplay("coverFile",`Base64 Encoded Input (Embedded ${F})`),console.log("Extracted cover image, format:",F,"size:",I.length),P=!0}this.updateSongInfo(),this.updateMediaSessionMetadata(),P?this.showStatus(t$3("metadataParseSuccess")):this.parseAudioMetadataFallback(R)},onError:L=>{this.showStatus(t$3("metadataParseFailed"),!0),this.parseAudioMetadataFallback(R)}}):(console.log("jsmediatags library not loaded"),this.showStatus(t$3("metadataLibNotLoaded"),!0),this.parseAudioMetadataFallback(R))}catch{this.showStatus(t$3("metadataParseError"),!0),this.parseAudioMetadataFallback(R)}}async parseAudioMetadataFallback(R){try{const L=R.name.replace(/\.[^/.]+$/,""),P=L.split(" - ");if(P.length>=2)this.state.songArtist=P[0].trim(),this.state.songTitle=P[1].trim(),this.songArtistInput&&(this.songArtistInput.value=this.state.songArtist),this.songTitleInput&&(this.songTitleInput.value=this.state.songTitle),console.log("Parsing from filename:",{artist:this.state.songArtist,title:this.state.songTitle}),this.updateSongInfo(),this.updateMediaSessionMetadata(),this.showStatus(t$3("extractedSongInfo"));else{const I=L.split(" – ");I.length>=2?(this.state.songArtist=I[0].trim(),this.state.songTitle=I[1].trim(),this.songArtistInput&&(this.songArtistInput.value=this.state.songArtist),this.songTitleInput&&(this.songTitleInput.value=this.state.songTitle),console.log("Parsing from filename (long dash):",{artist:this.state.songArtist,title:this.state.songTitle}),this.updateSongInfo(),this.updateMediaSessionMetadata(),this.showStatus(t$3("extractedSongInfo"))):(this.state.songTitle=L,this.songTitleInput&&(this.songTitleInput.value=this.state.songTitle),this.updateSongInfo(),this.updateMediaSessionMetadata(),this.showStatus(t$3("usedFilenameAsTitle")))}try{const I=new(window.AudioContext||window.webkitAudioContext),F=await R.arrayBuffer(),D=await I.decodeAudioData(F);console.log("Audio info:",{duration:D.duration,sampleRate:D.sampleRate,numberOfChannels:D.numberOfChannels})}catch(I){console.log("Web Audio API parsing failed:",I)}}catch(T){console.log("Fallback parsing method failed:",T),this.showStatus(t$3("cannotParseAudioInfo"),!0)}}showStatus(R,T=!1){this.status&&this.statusText&&(this.statusText.textContent=R,this.status.style.display="block",T?this.status.style.background="rgba(255, 0, 0, 0.9)":this.status.style.background="var(--dominant-color-dark)",setTimeout(()=>{this.status&&(this.status.style.display="none")},3e3))}addLongPressAndRightClickHandler(R,T,L=3e3){if(!R)return;let P;R.addEventListener("mousedown",I=>{P=window.setTimeout(()=>T(I),L)}),R.addEventListener("mouseup",()=>{clearTimeout(P)}),R.addEventListener("mouseleave",()=>{clearTimeout(P)}),R.addEventListener("contextmenu",I=>(I.preventDefault(),T(I),!1)),R.addEventListener("touchstart",I=>{P=window.setTimeout(()=>{T(I)},L)},{passive:!0}),R.addEventListener("touchend",I=>{clearTimeout(P)}),R.addEventListener("touchcancel",()=>{clearTimeout(P)},{passive:!0})}showAutoPlayHint(){const R=document.createElement("div");R.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--dominant-color-dark);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 100;
      text-align: center;
      max-width: 300px;
      font-size: 14px;
    `,R.innerHTML=`
      <div style="margin-bottom: 15px; font-size: 16px;">[INFO] 自动播放提示</div>
      <div style="margin-bottom: 15px;">由于浏览器安全策略，需要用户交互才能自动播放音频。</div>
      <div style="margin-bottom: 15px;">请点击播放按钮开始播放。</div>
      <button onclick="this.parentElement.remove()" title="Got it" style="
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
      ">知道了</button>
    `,document.body.appendChild(R),setTimeout(()=>{R.parentElement&&R.remove()},3e3)}loadFromURLParams(){this.urlOverrides.clear();const R=new URLSearchParams(window.location.search),T=R.get("music"),L=R.get("lyric"),P=R.get("cover"),I=R.get("title"),F=R.get("artist"),D=R.has("auto"),V=R.get("auto")==="1"||R.get("auto")==="true",q=R.get("t"),G=R.get("te");let z=!1;const Q=(tt,yt)=>{const At=R.get(tt);if(At===null)return;const{property:gt,parse:Et}=yt,kt=DEFAULT_PLAYER_STATE[gt],ne=Et?Et(At,kt):parseUrlParamValue(At,kt);ne!==void 0&&(this.state[gt]=ne,this.urlOverrides.add(gt),this.applyUrlStyleSideEffects(gt,ne),z=!0)};T||this.controlPanel&&(this.controlPanel.style.width="320px",this.controlPanel.style.right="20px",this.controlPanel.style.opacity="1"),T&&(this.urlOverrides.add("musicUrl"),this.urlOverrides.add("musicUrlInput"),this.state.musicUrl=T,this.musicUrl&&(this.musicUrl.value=T)),L&&(this.urlOverrides.add("lyricUrl"),this.urlOverrides.add("lyricUrlInput"),this.state.lyricUrl=L,this.lyricUrl&&(this.lyricUrl.value=L)),P&&(this.urlOverrides.add("coverUrl"),this.urlOverrides.add("coverUrlInput"),this.state.coverUrl=P,this.coverUrl&&(this.coverUrl.value=P)),I&&(this.urlOverrides.add("songTitle"),this.urlOverrides.add("songTitleInput"),this.songTitleInput&&(this.songTitleInput.value=I),this.state.songTitle=I,F?document.title=`${F} - ${I} | AMLL Web Player`:document.title=`${I} | AMLL Web Player`),F&&(this.urlOverrides.add("songArtist"),this.urlOverrides.add("songArtistInput"),this.songArtistInput&&(this.songArtistInput.value=F),this.state.songArtist=F),Object.entries(URL_ALIAS_CONFIG).forEach(([tt,yt])=>{Q(tt,yt)});for(const tt of STYLE_PARAM_KEYS)Q(tt,{property:tt});const J=R.get("controlPointCode");if(J!==null&&(this.urlOverrides.add("controlPointCode"),this.pendingControlPointCodeFromUrl=J,this.controlPointCodeInput&&(this.controlPointCodeInput.value=J),z=!0),z&&this.saveBackgroundSettings(),q&&this.urlOverrides.add("rangeStartTime"),G&&(this.urlOverrides.add("rangeEndTime"),this.urlOverrides.add("isRangeMode")),(T||L||P||I||F)&&this.updateSongInfo(),T||L||P){this.hasAutoLoadedFromUrl=!0,this.loadFromURLs().then(()=>{if(q&&this.audio){const tt=parseFloat(q);!isNaN(tt)&&tt>=0&&(this.audio.currentTime=tt,this.state.rangeStartTime=tt)}if(G){const tt=parseFloat(G);!isNaN(tt)&&tt!==0&&(!q||parseFloat(q)<=tt)&&(this.state.rangeEndTime=tt,this.state.isRangeMode=!0)}(D?V:this.state.autoPlay)&&this.audio&&this.audio.play().catch(()=>{this.showAutoPlayHint()})});return}if(q&&this.audio){const tt=parseFloat(q);!isNaN(tt)&&tt>=0&&(this.audio.currentTime=tt)}}start(){this.loadFromURLParams(),this.loadBackgroundSettings(),this.startAnimationLoop(),this.background.resume(),this.syncBackgroundBeatState(),new URLSearchParams(window.location.search).has("music")||(this.playControls&&(this.playControls.style.bottom="10px",this.playControls.style.opacity="1"),this.progressBar&&(this.progressBar.style.width="72vw")),this.isInitialized=!0,this.initAlbumCoverEffects(),this.urlLyricDelayOverride!==null&&(this.lyricDelayInput&&(this.lyricDelayInput.value=this.urlLyricDelayOverride.toString()),this.applyLyricDelay(this.urlLyricDelayOverride,{skipSave:!0}),this.urlLyricDelayOverride=null),this.pendingControlPointCodeFromUrl&&(this.controlPointCodeInput&&(this.controlPointCodeInput.value=this.pendingControlPointCodeFromUrl),this.applyControlPointCode(),this.pendingControlPointCodeFromUrl=null),this.hasAutoLoadedFromUrl||setTimeout(()=>{this.hasAutoLoadedFromUrl=!0,this.loadFromUrlBtn?.dispatchEvent(new MouseEvent("click",{bubbles:!0}))},0)}startAnimationLoop(){let R=-1;const T=L=>{this.stats.end(),R===-1&&(R=L),this.lyricPlayer.update(L-R),R=L,this.stats.begin(),requestAnimationFrame(T)};requestAnimationFrame(T)}getAudio(){return this.audio}getLyricPlayer(){return this.lyricPlayer}getBackground(){return this.background}async extractAndProcessCoverColor(R){try{const T=new Image;!R.startsWith("data:image/")&&!R.startsWith("blob:")&&(T.crossOrigin="Anonymous"),await new Promise((Q,J)=>{T.onload=()=>Q(),T.onerror=()=>J(new Error("Failed to load image")),T.src=R});const[L,P,I]=this.colorThief.getColor(T),F=this.rgbToHsl(L,P,I);F[2]=.8;const[D,V,q]=this.hslToRgb(F[0],F[1],F[2]);this.dominantColor=this.rgbToHex(D,V,q);const z=(.299*L+.587*P+.114*I)/255>=.5;this.applyDominantColorAsCSSVariable(),this.invertColorsCheckbox&&this.state.backgroundType==="cover"&&(this.state.originalInvertColors===null&&this.state.originalInvertColors===void 0?(this.invertColorsCheckbox.checked=z,this.invertColors(z)):(this.invertColorsCheckbox.checked=this.state.originalInvertColors,this.invertColors(this.state.originalInvertColors)))}catch{this.setDefaultColors(),this.applyDominantColorAsCSSVariable()}}rgbToHsl(R,T,L){R/=255,T/=255,L/=255;const P=Math.max(R,T,L),I=Math.min(R,T,L);let F=0,D,V=(P+I)/2;if(P===I)F=D=0;else{const q=P-I;switch(D=V>.5?q/(2-P-I):q/(P+I),P){case R:F=(T-L)/q+(T<L?6:0);break;case T:F=(L-R)/q+2;break;case L:F=(R-T)/q+4;break}F/=6}return[F,D,V]}hslToRgb(R,T,L){let P,I,F;if(T===0)P=I=F=L;else{const D=(G,z,Q)=>(Q<0&&(Q+=1),Q>1&&(Q-=1),Q<.16666666666666666?G+(z-G)*6*Q:Q<.5?z:Q<.6666666666666666?G+(z-G)*(.6666666666666666-Q)*6:G),V=L<.5?L*(1+T):L+T-L*T,q=2*L-V;P=D(q,V,R+1/3),I=D(q,V,R),F=D(q,V,R-1/3)}return[Math.round(P*255),Math.round(I*255),Math.round(F*255)]}rgbToHex(R,T,L){return"#"+[R,T,L].map(P=>{const I=P.toString(16);return I.length===1?"0"+I:I}).join("")}hexToRgb(R){const T=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(R);return T?{r:parseInt(T[1],16),g:parseInt(T[2],16),b:parseInt(T[3],16)}:null}lightenColor(R,T){const L=parseInt(R.replace("#",""),16),P=Math.round(2.55*T*100),I=(L>>16)+P,F=(L>>8&255)+P,D=(L&255)+P;return"#"+(16777216+(I<255?I<1?0:I:255)*65536+(F<255?F<1?0:F:255)*256+(D<255?D<1?0:D:255)).toString(16).slice(1)}darkenColor(R,T){const L=parseInt(R.replace("#",""),16),P=Math.round(2.55*T*100),I=(L>>16)-P,F=(L>>8&255)-P,D=(L&255)-P;return"#"+(16777216+(I>255?255:I<0?0:I)*65536+(F>255?255:F<0?0:F)*256+(D>255?255:D<0?0:D)).toString(16).slice(1)}saveBackgroundSettings(){const R={backgroundType:this.state.backgroundType,backgroundDynamic:this.state.backgroundDynamic,backgroundFlowSpeed:this.state.backgroundFlowSpeed,backgroundColorMask:this.state.backgroundColorMask,backgroundMaskColor:this.state.backgroundMaskColor,backgroundMaskOpacity:this.state.backgroundMaskOpacity,showFPS:this.state.showFPS,coverBlurLevel:this.state.coverBlurLevel,invertColors:this.state.invertColors,manualDominantColor:this.state.manualDominantColor,manualDominantColorLight:this.state.manualDominantColorLight,manualDominantColorDark:this.state.manualDominantColorDark,marqueeEnabled:this.state.marqueeEnabled,roundedCover:this.state.roundedCover,coverRotationSpeed:this.state.coverRotationSpeed,backgroundRenderScale:this.state.backgroundRenderScale,lyricAlignPosition:this.state.lyricAlignPosition,lyricFontSize:this.state.lyricFontSize,lyricDelay:this.state.lyricDelay,hidePassedLyrics:this.state.hidePassedLyrics,enableLyricBlur:this.state.enableLyricBlur,enableLyricScale:this.state.enableLyricScale,enableLyricSpring:this.state.enableLyricSpring,wordFadeWidth:this.state.wordFadeWidth,lyricAlignAnchor:this.state.lyricAlignAnchor,showTranslatedLyric:this.state.showTranslatedLyric,showRomanLyric:this.state.showRomanLyric,swapLyricPositions:this.state.swapLyricPositions,showbgLyric:this.state.showbgLyric,swapDuetsPositions:this.state.swapDuetsPositions,advanceLyricTiming:this.state.advanceLyricTiming,singleLyrics:this.state.singleLyrics,backgroundLowFreqVolume:this.state.backgroundLowFreqVolume,backgroundBeatEnabled:this.state.backgroundBeatEnabled,coverStyle:this.state.coverStyle,posYSpringMass:this.state.posYSpringMass,backgroundFPS:this.state.backgroundFPS,posYSpringDamping:this.state.posYSpringDamping,posYSpringStiffness:this.state.posYSpringStiffness,posYSpringSoft:this.state.posYSpringSoft,scaleSpringMass:this.state.scaleSpringMass,scaleSpringDamping:this.state.scaleSpringDamping,scaleSpringStiffness:this.state.scaleSpringStiffness,scaleSpringSoft:this.state.scaleSpringSoft,playbackRate:this.state.playbackRate,volume:this.state.volume,loopPlay:this.state.loopPlay,showRemainingTime:this.state.showRemainingTime,autoPlay:this.state.autoPlay,musicUrl:this.state.musicUrl,lyricUrl:this.state.lyricUrl,coverUrl:this.state.coverUrl,songTitle:this.state.songTitle,songArtist:this.state.songArtist,musicUrlInput:this.musicUrl?.value||"",lyricUrlInput:this.lyricUrl?.value||"",coverUrlInput:this.coverUrl?.value||"",songTitleInput:this.songTitleInput?.value||"",songArtistInput:this.songArtistInput?.value||"",isRangeMode:this.state.isRangeMode,rangeStartTime:this.state.rangeStartTime,rangeEndTime:this.state.rangeEndTime,controlPointCode:this.controlPointCodeInput?.value||""};localStorage.setItem(SETTINGS_STORAGE_KEY,JSON.stringify(R))}loadBackgroundSettings(){try{const R=localStorage.getItem(SETTINGS_STORAGE_KEY);if(R){const T=JSON.parse(R),L=DEFAULT_PLAYER_STATE,P=F=>Object.prototype.hasOwnProperty.call(T,F);P("backgroundType")&&(this.state.backgroundType=typeof T.backgroundType=="string"?T.backgroundType:L.backgroundType),P("backgroundDynamic")&&(this.state.backgroundDynamic=typeof T.backgroundDynamic=="boolean"?T.backgroundDynamic:L.backgroundDynamic),P("backgroundFlowSpeed")&&(this.state.backgroundFlowSpeed=typeof T.backgroundFlowSpeed=="number"?T.backgroundFlowSpeed:L.backgroundFlowSpeed),P("backgroundColorMask")&&(this.state.backgroundColorMask=typeof T.backgroundColorMask=="boolean"?T.backgroundColorMask:L.backgroundColorMask),P("backgroundMaskColor")&&(this.state.backgroundMaskColor=typeof T.backgroundMaskColor=="string"?T.backgroundMaskColor:L.backgroundMaskColor),P("backgroundMaskOpacity")&&(this.state.backgroundMaskOpacity=typeof T.backgroundMaskOpacity=="number"?T.backgroundMaskOpacity:L.backgroundMaskOpacity),P("showFPS")&&(this.state.showFPS=typeof T.showFPS=="boolean"?T.showFPS:L.showFPS),P("coverBlurLevel")&&(this.state.coverBlurLevel=typeof T.coverBlurLevel=="number"?T.coverBlurLevel:L.coverBlurLevel),P("invertColors")&&(this.state.invertColors=typeof T.invertColors=="boolean"?T.invertColors:L.invertColors),P("manualDominantColor")&&(this.state.manualDominantColor=typeof T.manualDominantColor=="string"?T.manualDominantColor:L.manualDominantColor),P("manualDominantColorLight")&&(this.state.manualDominantColorLight=typeof T.manualDominantColorLight=="string"?T.manualDominantColorLight:L.manualDominantColorLight),P("manualDominantColorDark")&&(this.state.manualDominantColorDark=typeof T.manualDominantColorDark=="string"?T.manualDominantColorDark:L.manualDominantColorDark),P("roundedCover")&&(this.state.roundedCover=typeof T.roundedCover=="number"?T.roundedCover:L.roundedCover),P("marqueeEnabled")&&(this.state.marqueeEnabled=typeof T.marqueeEnabled=="boolean"?T.marqueeEnabled:L.marqueeEnabled),P("coverRotationSpeed")&&(this.state.coverRotationSpeed=typeof T.coverRotationSpeed=="number"?T.coverRotationSpeed:L.coverRotationSpeed),P("backgroundRenderScale")&&(this.state.backgroundRenderScale=typeof T.backgroundRenderScale=="number"?T.backgroundRenderScale:L.backgroundRenderScale),P("lyricAlignPosition")&&(this.state.lyricAlignPosition=typeof T.lyricAlignPosition=="number"?T.lyricAlignPosition:L.lyricAlignPosition),P("lyricFontSize")&&(this.state.lyricFontSize=typeof T.lyricFontSize=="number"?T.lyricFontSize:L.lyricFontSize),P("lyricDelay")&&(this.state.lyricDelay=typeof T.lyricDelay=="number"?T.lyricDelay:L.lyricDelay),P("hidePassedLyrics")&&(this.state.hidePassedLyrics=typeof T.hidePassedLyrics=="boolean"?T.hidePassedLyrics:L.hidePassedLyrics),P("enableLyricBlur")&&(this.state.enableLyricBlur=typeof T.enableLyricBlur=="boolean"?T.enableLyricBlur:L.enableLyricBlur),P("enableLyricScale")&&(this.state.enableLyricScale=typeof T.enableLyricScale=="boolean"?T.enableLyricScale:L.enableLyricScale),P("enableLyricSpring")&&(this.state.enableLyricSpring=typeof T.enableLyricSpring=="boolean"?T.enableLyricSpring:L.enableLyricSpring),P("wordFadeWidth")&&(this.state.wordFadeWidth=typeof T.wordFadeWidth=="number"?T.wordFadeWidth:L.wordFadeWidth),P("lyricAlignAnchor")&&(this.state.lyricAlignAnchor=typeof T.lyricAlignAnchor=="string"?T.lyricAlignAnchor:L.lyricAlignAnchor),P("showTranslatedLyric")&&(this.state.showTranslatedLyric=typeof T.showTranslatedLyric=="boolean"?T.showTranslatedLyric:L.showTranslatedLyric),P("showRomanLyric")&&(this.state.showRomanLyric=typeof T.showRomanLyric=="boolean"?T.showRomanLyric:L.showRomanLyric),P("swapLyricPositions")&&(this.state.swapLyricPositions=typeof T.swapLyricPositions=="boolean"?T.swapLyricPositions:L.swapLyricPositions),P("showbgLyric")&&(this.state.showbgLyric=typeof T.showbgLyric=="boolean"?T.showbgLyric:L.showbgLyric),P("swapDuetsPositions")&&(this.state.swapDuetsPositions=typeof T.swapDuetsPositions=="boolean"?T.swapDuetsPositions:L.swapDuetsPositions),P("advanceLyricTiming")&&(this.state.advanceLyricTiming=typeof T.advanceLyricTiming=="boolean"?T.advanceLyricTiming:L.advanceLyricTiming),P("singleLyrics")&&(this.state.singleLyrics=typeof T.singleLyrics=="boolean"?T.singleLyrics:L.singleLyrics),P("backgroundLowFreqVolume")&&(this.state.backgroundLowFreqVolume=typeof T.backgroundLowFreqVolume=="number"?T.backgroundLowFreqVolume:L.backgroundLowFreqVolume),P("backgroundBeatEnabled")&&(this.state.backgroundBeatEnabled=typeof T.backgroundBeatEnabled=="boolean"?T.backgroundBeatEnabled:L.backgroundBeatEnabled),P("coverStyle")&&(this.state.coverStyle=typeof T.coverStyle=="string"?T.coverStyle:L.coverStyle),P("posYSpringMass")&&(this.state.posYSpringMass=typeof T.posYSpringMass=="number"?T.posYSpringMass:L.posYSpringMass),P("backgroundFPS")&&(this.state.backgroundFPS=typeof T.backgroundFPS=="number"?T.backgroundFPS:L.backgroundFPS),P("posYSpringDamping")&&(this.state.posYSpringDamping=typeof T.posYSpringDamping=="number"?T.posYSpringDamping:L.posYSpringDamping),P("posYSpringStiffness")&&(this.state.posYSpringStiffness=typeof T.posYSpringStiffness=="number"?T.posYSpringStiffness:L.posYSpringStiffness),P("posYSpringSoft")&&(this.state.posYSpringSoft=typeof T.posYSpringSoft=="boolean"?T.posYSpringSoft:L.posYSpringSoft),P("scaleSpringMass")&&(this.state.scaleSpringMass=typeof T.scaleSpringMass=="number"?T.scaleSpringMass:L.scaleSpringMass),P("scaleSpringDamping")&&(this.state.scaleSpringDamping=typeof T.scaleSpringDamping=="number"?T.scaleSpringDamping:L.scaleSpringDamping),P("scaleSpringStiffness")&&(this.state.scaleSpringStiffness=typeof T.scaleSpringStiffness=="number"?T.scaleSpringStiffness:L.scaleSpringStiffness),P("scaleSpringSoft")&&(this.state.scaleSpringSoft=typeof T.scaleSpringSoft=="boolean"?T.scaleSpringSoft:L.scaleSpringSoft),P("playbackRate")&&(this.state.playbackRate=typeof T.playbackRate=="number"?T.playbackRate:L.playbackRate),P("volume")&&(this.state.volume=typeof T.volume=="number"?T.volume:L.volume),P("loopPlay")&&(this.state.loopPlay=typeof T.loopPlay=="boolean"?T.loopPlay:L.loopPlay),P("showRemainingTime")&&(this.state.showRemainingTime=typeof T.showRemainingTime=="boolean"?T.showRemainingTime:L.showRemainingTime),P("autoPlay")&&(this.state.autoPlay=typeof T.autoPlay=="boolean"?T.autoPlay:L.autoPlay),P("musicUrl")&&!this.urlOverrides.has("musicUrl")&&(this.state.musicUrl=typeof T.musicUrl=="string"?T.musicUrl:L.musicUrl),P("lyricUrl")&&!this.urlOverrides.has("lyricUrl")&&(this.state.lyricUrl=typeof T.lyricUrl=="string"?T.lyricUrl:L.lyricUrl),P("coverUrl")&&!this.urlOverrides.has("coverUrl")&&(this.state.coverUrl=typeof T.coverUrl=="string"?T.coverUrl:L.coverUrl),P("songTitle")&&!this.urlOverrides.has("songTitle")&&(this.state.songTitle=typeof T.songTitle=="string"?T.songTitle:L.songTitle),P("songArtist")&&!this.urlOverrides.has("songArtist")&&(this.state.songArtist=typeof T.songArtist=="string"?T.songArtist:L.songArtist),P("isRangeMode")&&(this.state.isRangeMode=typeof T.isRangeMode=="boolean"?T.isRangeMode:L.isRangeMode),P("rangeStartTime")&&(this.state.rangeStartTime=typeof T.rangeStartTime=="number"?T.rangeStartTime:L.rangeStartTime),P("rangeEndTime")&&(this.state.rangeEndTime=typeof T.rangeEndTime=="number"?T.rangeEndTime:L.rangeEndTime),this.state.originalInvertColors=this.state.invertColors,this.audio.playbackRate=this.state.playbackRate,this.audio.volume=this.state.volume/100,P("musicUrlInput")&&this.musicUrl&&typeof T.musicUrlInput=="string"&&!this.urlOverrides.has("musicUrlInput")&&(this.musicUrl.value=T.musicUrlInput),P("lyricUrlInput")&&this.lyricUrl&&typeof T.lyricUrlInput=="string"&&!this.urlOverrides.has("lyricUrlInput")&&(this.lyricUrl.value=T.lyricUrlInput),P("coverUrlInput")&&this.coverUrl&&typeof T.coverUrlInput=="string"&&!this.urlOverrides.has("coverUrlInput")&&(this.coverUrl.value=T.coverUrlInput),P("songTitleInput")&&this.songTitleInput&&typeof T.songTitleInput=="string"&&!this.urlOverrides.has("songTitleInput")&&(this.songTitleInput.value=T.songTitleInput),P("songArtistInput")&&this.songArtistInput&&typeof T.songArtistInput=="string"&&!this.urlOverrides.has("songArtistInput")&&(this.songArtistInput.value=T.songArtistInput),this.updateSongInfo(),this.songTitle&&this.checkAndUpdateMarquee(this.songTitle),this.songArtist&&this.checkAndUpdateMarquee(this.songArtist),P("controlPointCode")&&this.controlPointCodeInput&&!this.urlOverrides.has("controlPointCode")&&typeof T.controlPointCode=="string"&&(this.controlPointCodeInput.value=T.controlPointCode),this.lyricDelayInput&&(this.lyricDelayInput.value=this.state.lyricDelay.toString()),this.applyLyricDelay(this.state.lyricDelay,{skipSave:!0}),this.updateBackgroundUI(),this.updateBackground(),this.updateFPSDisplay(),this.updateRoundedCover(),this.updateCoverStyle(),this.updateLyricsDisplay(),this.updateMarqueeSettings(),this.lyricPlayer.setAlignPosition(this.state.lyricAlignPosition),this.updateLyricFontSize(),this.invertColors(this.state.invertColors),this.lyricPlayer.setEnableBlur(this.state.enableLyricBlur),this.lyricPlayer.setEnableScale(this.state.enableLyricScale),this.lyricPlayer.setEnableSpring(this.state.enableLyricSpring),this.lyricPlayer.setWordFadeWidth(this.state.wordFadeWidth),this.lyricPlayer.setLinePosYSpringParams({mass:this.state.posYSpringMass,damping:this.state.posYSpringDamping,stiffness:this.state.posYSpringStiffness,soft:this.state.posYSpringSoft}),this.lyricPlayer.setLineScaleSpringParams({mass:this.state.scaleSpringMass,damping:this.state.scaleSpringDamping,stiffness:this.state.scaleSpringStiffness,soft:this.state.scaleSpringSoft});const I=window.devicePixelRatio||1;this.background.setRenderScale(this.state.backgroundRenderScale*I),this.updateTimeDisplay(),P("controlPointCode")&&!this.urlOverrides.has("controlPointCode")&&typeof T.controlPointCode=="string"&&this.applyControlPointCode()}if(this.lyricAlignPositionValue&&(this.lyricAlignPositionValue.textContent=this.state.lyricAlignPosition.toFixed(1)),this.lyricFontSizeValue&&(this.lyricFontSizeValue.textContent=`${this.state.lyricFontSize}%`),this.springPosYMassValue&&(this.springPosYMassValue.textContent=this.state.posYSpringMass.toFixed(1)),this.springPosYDampingValue&&(this.springPosYDampingValue.textContent=this.state.posYSpringDamping.toString()),this.springPosYStiffnessValue&&(this.springPosYStiffnessValue.textContent=this.state.posYSpringStiffness.toString()),this.springScaleMassValue&&(this.springScaleMassValue.textContent=this.state.scaleSpringMass.toFixed(1)),this.springScaleDampingValue&&(this.springScaleDampingValue.textContent=this.state.scaleSpringDamping.toString()),this.springScaleStiffnessValue&&(this.springScaleStiffnessValue.textContent=this.state.scaleSpringStiffness.toString()),this.hidePassedLyricsCheckbox&&(this.hidePassedLyricsCheckbox.checked=this.state.hidePassedLyrics),this.enableLyricBlur&&(this.enableLyricBlur.checked=this.state.enableLyricBlur),this.enableLyricScale&&(this.enableLyricScale.checked=this.state.enableLyricScale),this.enableLyricSpring){this.enableLyricSpring.checked=this.state.enableLyricSpring;const T=document.getElementById("spring-desc");T&&(T.style.display=this.state.enableLyricSpring?"block":"none")}this.wordFadeWidthInput&&(this.wordFadeWidthInput.value=this.state.wordFadeWidth.toString()),this.wordFadeWidthValue&&(this.wordFadeWidthValue.textContent=this.state.wordFadeWidth.toFixed(2)),this.showbgLyricCheckbox&&(this.showbgLyricCheckbox.checked=this.state.showbgLyric),this.swapDuetsPositionsCheckbox&&(this.swapDuetsPositionsCheckbox.checked=this.state.swapDuetsPositions),this.urlOverrides.clear()}catch(R){console.log("加载背景设置失败:",R)}}updateBackgroundUI(){if(this.bgFlowSpeed&&(this.bgFlowSpeed.value=this.state.backgroundFlowSpeed.toString()),this.bgFlowSpeedValue&&(this.bgFlowSpeedValue.textContent=this.state.backgroundFlowSpeed.toFixed(1)),this.bgColorMask&&(this.bgColorMask.checked=this.state.backgroundColorMask),this.bgMaskColor&&(this.bgMaskColor.value=this.state.backgroundMaskColor),this.bgMaskOpacity&&(this.bgMaskOpacity.value=this.state.backgroundMaskOpacity.toString()),this.bgMaskOpacityValue&&(this.bgMaskOpacityValue.textContent=`${this.state.backgroundMaskOpacity}%`),this.showFPSCheckbox&&(this.showFPSCheckbox.checked=this.state.showFPS),this.backgroundStyleSelect&&(this.backgroundStyleSelect.value=this.state.backgroundType),this.coverBlurLevel&&(this.coverBlurLevel.value=this.state.coverBlurLevel.toString()),this.coverBlurLevelValue&&(this.coverBlurLevelValue.textContent=`${this.state.coverBlurLevel}%`),this.invertColorsCheckbox&&(this.invertColorsCheckbox.checked=this.state.invertColors),this.dominantColorInput&&this.isColorsInitialized&&(this.dominantColorInput.value=this.state.manualDominantColor||this.originalDominant),this.dominantColorLightInput&&this.isColorsInitialized&&(this.dominantColorLightInput.value=this.state.manualDominantColorLight||this.originalLight),this.dominantColorDarkInput&&this.isColorsInitialized&&(this.dominantColorDarkInput.value=this.state.manualDominantColorDark||this.originalDark),this.roundedCoverSlider&&(this.roundedCoverSlider.value=this.state.roundedCover.toString()),this.roundedCoverValue&&(this.roundedCoverValue.textContent=`${this.state.roundedCover}%`),this.coverRotationSlider&&(this.coverRotationSlider.value=this.state.coverRotationSpeed.toString()),this.coverRotationValue&&(this.coverRotationValue.textContent=`${this.state.coverRotationSpeed}rpm`),this.enableMarqueeCheckbox&&(this.enableMarqueeCheckbox.checked=this.state.marqueeEnabled),this.bgRenderScale&&(this.bgRenderScale.value=this.state.backgroundRenderScale.toString()),this.bgRenderScaleValue&&(this.bgRenderScaleValue.textContent=this.state.backgroundRenderScale.toFixed(2)),this.bgFPS&&(this.bgFPS.value=this.state.backgroundFPS.toString()),this.bgFPSValue&&(this.bgFPSValue.textContent=`${this.state.backgroundFPS}fps`),this.lyricAlignPosition&&(this.lyricAlignPosition.value=this.state.lyricAlignPosition.toString()),this.lyricAlignPositionValue&&(this.lyricAlignPositionValue.textContent=this.state.lyricAlignPosition.toFixed(1)),this.lyricFontSize&&(this.lyricFontSize.value=this.state.lyricFontSize.toString()),this.lyricFontSizeValue&&(this.lyricFontSizeValue.textContent=`${this.state.lyricFontSize}%`),this.hidePassedLyricsCheckbox&&(this.hidePassedLyricsCheckbox.checked=this.state.hidePassedLyrics),this.fluidDesc&&(this.fluidDesc.style.display=this.state.backgroundType==="fluid"?"block":"none"),this.coverDesc&&(this.coverDesc.style.display=this.state.backgroundType==="cover"?"block":"none"),this.solidDesc&&(this.solidDesc.style.display=this.state.backgroundType==="solid"?"block":"none"),this.solidOptions){const L=this.state.backgroundType==="cover"&&this.state.backgroundColorMask&&this.state.backgroundMaskOpacity===0;this.setOptionsVisibility(this.solidOptions,L,["neumorphismA","neumorphismB"])}if(this.loopPlayCheckbox&&(this.loopPlayCheckbox.checked=this.state.loopPlay),this.playbackRateControl&&(this.playbackRateControl.value=this.state.playbackRate.toString()),this.playbackRateValue&&(this.playbackRateValue.textContent=`${this.state.playbackRate.toFixed(2)}x`),this.updatePlaybackRateIcon(this.state.playbackRate),this.volumeControl&&(this.volumeControl.value=this.state.volume.toString()),this.volumeValue&&(this.volumeValue.textContent=`${Math.round(this.state.volume)}%`),this.audio.playbackRate=this.state.playbackRate,this.audio.volume=this.state.volume/100,this.updateVolumeIcon(Math.round(this.state.volume)),this.showbgLyricCheckbox&&(this.showbgLyricCheckbox.checked=this.state.showbgLyric),this.swapDuetsPositionsCheckbox&&(this.swapDuetsPositionsCheckbox.checked=this.state.swapDuetsPositions),this.advanceLyricTimingCheckbox&&(this.advanceLyricTimingCheckbox.checked=this.state.advanceLyricTiming),this.backgroundBeatCheckbox&&(this.backgroundBeatCheckbox.checked=this.state.backgroundBeatEnabled),this.bgLowFreqVolume&&(this.bgLowFreqVolume.value=this.state.backgroundLowFreqVolume.toString()),this.bgLowFreqVolumeValue){const L=P=>`${(80+P*40).toFixed(0)}hz`;this.bgLowFreqVolumeValue.textContent=L(this.state.backgroundLowFreqVolume)}const R=document.getElementById("springPosYSoft")?.parentElement;R&&(R.style.display=this.state.posYSpringDamping<1?"flex":"none");const T=document.getElementById("springScaleSoft")?.parentElement;T&&(T.style.display=this.state.scaleSpringDamping<1?"flex":"none"),this.syncBackgroundBeatState()}initCoverBlurBackground(){this.coverBlurBackground.style.position="absolute",this.coverBlurBackground.style.top="0",this.coverBlurBackground.style.left="0",this.coverBlurBackground.style.width="100%",this.coverBlurBackground.style.height="100%",this.coverBlurBackground.style.backgroundSize="cover",this.coverBlurBackground.style.backgroundPosition="center",this.coverBlurBackground.style.backgroundRepeat="no-repeat",this.coverBlurBackground.style.filter="blur(20px)",this.coverBlurBackground.style.transform=`scale(${this.coverBlurBaseScale})`,this.coverBlurBackground.style.transformOrigin="center",this.coverBlurBackground.style.willChange="transform",this.coverBlurBackground.style.zIndex="0",this.coverBlurBackground.style.display="none"}ensureBeatAudioAnalyser(){if(this.beatState.analyser||!this.audio)return;const R=window.AudioContext||window.webkitAudioContext;if(!R)return;const T=new R,L=T.createMediaElementSource(this.audio),P=T.createAnalyser();P.fftSize=2048,P.smoothingTimeConstant=.85,L.connect(P),P.connect(T.destination),this.beatState.audioContext=T,this.beatState.analyser=P,this.beatState.freqData=new Uint8Array(P.frequencyBinCount)}getBeatRenderer(){return this.background?.renderer||this.background?._renderer||this.background?.renderer||null}extractPaletteFromImageData(R,T=AMLL_PALETTE_TARGET){if(!R||!R.width||!R.height)return[];const L=R.width,P=R.height,I=R.data,F=Math.max(1,Math.floor(AMLL_PALETTE_PIXELATE)),D=[];for(let z=0;z<P;z+=F)for(let Q=0;Q<L;Q+=F){const J=(z*L+Q)*4;(I[J+3]??255)<16||D.push({r:(I[J]||0)/255,g:(I[J+1]||0)/255,b:(I[J+2]||0)/255})}if(!D.length)return[];const V=Math.max(1,T),q=new Array(V).fill(null).map((z,Q)=>{const J=V===1?0:Math.floor(Q/(V-1)*(D.length-1)),tt=D[J]||D[0];return{r:tt.r,g:tt.g,b:tt.b}});for(let z=0;z<8;z+=1){const Q=new Array(V).fill(null).map(()=>({r:0,g:0,b:0,n:0}));for(const J of D){let tt=0,yt=Number.POSITIVE_INFINITY;for(let gt=0;gt<V;gt+=1){const Et=q[gt],kt=J.r-Et.r,ne=J.g-Et.g,Se=J.b-Et.b,Ht=kt*kt+ne*ne+Se*Se;Ht<yt&&(yt=Ht,tt=gt)}const At=Q[tt];At.r+=J.r,At.g+=J.g,At.b+=J.b,At.n+=1}for(let J=0;J<V;J+=1){const tt=Q[J];if(tt.n>0)q[J]={r:tt.r/tt.n,g:tt.g/tt.n,b:tt.b/tt.n};else{const yt=D[J*97%D.length];q[J]={r:yt.r,g:yt.g,b:yt.b}}}}const G=q.map(z=>{const Q=hexToHsl(`#${Math.round(z.r*255).toString(16).padStart(2,"0")}${Math.round(z.g*255).toString(16).padStart(2,"0")}${Math.round(z.b*255).toString(16).padStart(2,"0")}`);if(!Q)return null;const J=clamp(Q.s,0,100);return{h:Q.h,l:Q.l,baseS:clamp(J-50,0,100),origS:J}}).filter(Boolean);return G.sort((z,Q)=>z.h-Q.h||z.l-Q.l),G}ensureBeatBasePalette(){if(this.beatState.basePaletteHsl.length)return;const R=this.beatState.renderer;if(!R)return;const T=R.currentImageData||R._currentImageData||null,L=this.extractPaletteFromImageData(T,AMLL_PALETTE_TARGET);L.length&&(this.beatState.basePaletteHsl=L)}getActiveMesh(R){if(!R)return null;const T=R.meshStates||R._meshStates;return!Array.isArray(T)||T.length===0?null:T[T.length-1].mesh||null}getMeshSize(R){const T=R&&(R._controlPoints||R.controlPoints);if(!T)return null;const L=T.width??T._width,P=T.height??T._height;return!L||!P?null:{width:L,height:P}}applyColorsToMesh(R,T){const L=this.getMeshSize(R);if(!L||!T.length)return;const P=L.width,I=L.height;(!this.beatState.lastColors||this.beatState.lastColors.length!==T.length)&&(this.beatState.lastColors=T.map(q=>({r:q.r,g:q.g,b:q.b})));const F=T.map((q,G)=>{const z=this.beatState.lastColors?.[G]||q,Q=z.r+(q.r-z.r)*this.beatState.smoothing,J=z.g+(q.g-z.g)*this.beatState.smoothing,tt=z.b+(q.b-z.b)*this.beatState.smoothing;return{r:Q,g:J,b:tt}});this.beatState.lastColors=F;const D=Math.max(1,T.length-1),V=(q,G)=>{const z=Math.max(1,AMLL_NOISE_SCALE),Q=q/Math.max(1,P-1)*z,J=G/Math.max(1,I-1)*z,tt=Math.sin(Q*127.1+J*311.7)*43758.5453,yt=tt-Math.floor(tt);return Math.floor(yt*(D+1))};for(let q=0;q<P;q+=1)for(let G=0;G<I;G+=1){const z=V(q,G),Q=F[z]||F[F.length-1],J=R.getControlPoint?R.getControlPoint(q,G):null;!J||!J.color||(J.color[0]=Q.r,J.color[1]=Q.g,J.color[2]=Q.b)}typeof R.updateMesh=="function"&&R.updateMesh()}applyBasePaletteToMesh(R){const T=this.getMeshSize(R);if(!T||!this.beatState.basePaletteHsl.length)return;const L=T.width,P=T.height,I=Math.max(1,this.beatState.basePaletteHsl.length-1),F=(D,V)=>{const q=Math.max(1,AMLL_NOISE_SCALE),G=D/Math.max(1,L-1)*q,z=V/Math.max(1,P-1)*q,Q=Math.sin(G*127.1+z*311.7)*43758.5453,J=Q-Math.floor(Q);return Math.floor(J*(I+1))};for(let D=0;D<L;D+=1)for(let V=0;V<P;V+=1){const q=F(D,V),G=this.beatState.basePaletteHsl[q]||this.beatState.basePaletteHsl[this.beatState.basePaletteHsl.length-1],z=hslToRgb(G.h,G.origS??G.baseS+50,G.l),Q=R.getControlPoint?R.getControlPoint(D,V):null;!Q||!Q.color||(Q.color[0]=z.r,Q.color[1]=z.g,Q.color[2]=z.b)}typeof R.updateMesh=="function"&&R.updateMesh()}captureMeshColors(R){const T=this.getMeshSize(R);if(!T)return;const L=T.width,P=T.height,I=new Array(L*P);for(let F=0;F<L;F+=1)for(let D=0;D<P;D+=1){const V=R.getControlPoint?R.getControlPoint(F,D):null;if(!V||!V.color){I[D*L+F]=null;continue}I[D*L+F]=[V.color[0],V.color[1],V.color[2]]}this.beatState.originalMeshColors=I,this.beatState.originalMeshSize={width:L,height:P}}restoreMeshColors(R){const T=this.getMeshSize(R),L=this.beatState.originalMeshColors,P=this.beatState.originalMeshSize;if(!T||!L||!P||T.width!==P.width||T.height!==P.height)return!1;const I=T.width,F=T.height;for(let D=0;D<I;D+=1)for(let V=0;V<F;V+=1){const q=R.getControlPoint?R.getControlPoint(D,V):null,G=L[V*I+D];!q||!q.color||!G||(q.color[0]=G[0],q.color[1]=G[1],q.color[2]=G[2])}return typeof R.updateMesh=="function"&&R.updateMesh(),!0}parseBeatCurve(R){if(!R||R.byteLength<12)return null;const T=new DataView(R),L=String.fromCharCode(T.getUint8(0),T.getUint8(1),T.getUint8(2),T.getUint8(3));if(L!==AMLL_BEAT_CURVE_MAGIC&&L!==AMLL_BEAT_CURVE_MAGIC_LEVELS||T.getUint8(4)!==1)return null;const I=T.getUint8(5),F=T.getUint16(6,!0),D=T.getUint32(8,!0);if(!I||!F||!D)return null;const V=12,q=L===AMLL_BEAT_CURVE_MAGIC_LEVELS?I+1:I,G=V+D*q;if(R.byteLength<G)return null;const z=new Uint8Array(R,V,D*q);return{bandCount:I,frameMs:F,frameCount:D,data:z,mode:L===AMLL_BEAT_CURVE_MAGIC_LEVELS?"levels":"gain"}}clearBeatCurvePolling(){this.beatCurvePollTimer&&(clearTimeout(this.beatCurvePollTimer),this.beatCurvePollTimer=null),this.beatCurveRequestInFlight=!1}async loadBeatCurve(R){if(!R){this.beatState.beatCurve=null;return}try{const T=normalizeBackendUrl(R),L=await fetch(T);if(!L.ok)throw new Error(`Beat curve request failed: ${L.status}`);const P=await L.arrayBuffer(),I=this.parseBeatCurve(P);if(!I)throw new Error("Invalid beat curve");this.beatState.beatCurve=I}catch(T){console.warn("[AMLL] Beat curve load failed:",T),this.beatState.beatCurve=null}}async requestBeatCurveFromServer(){if(this.state.backgroundBeatEnabled&&!this.beatCurveRequestInFlight){this.beatCurveRequestInFlight=!0;try{const R=await fetch("/amll/generate_beat_curve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),T=await R.json().catch(()=>null);if(!R.ok&&R.status!==202){console.warn("[AMLL] Beat curve request failed",R.status);return}if(T&&T.status==="success"&&T.curve){this.beatCurvePath=T.curve,await this.loadBeatCurve(T.curve);return}T&&T.status==="pending"&&(this.beatCurvePollTimer=window.setTimeout(()=>this.requestBeatCurveFromServer(),2e3))}catch(R){console.warn("[AMLL] Beat curve request failed",R)}finally{this.beatCurveRequestInFlight=!1}}}ensureBeatCurveAuto(){if(this.state.backgroundBeatEnabled&&!this.beatState.beatCurve){if(this.beatCurvePath){this.loadBeatCurve(this.beatCurvePath);return}this.requestBeatCurveFromServer()}}sampleBeatCurve(R){const T=this.beatState.beatCurve;if(!T||!this.audio)return null;const L=Number.isFinite(this.audio.currentTime)?this.audio.currentTime*1e3:0,P=Math.max(0,L/T.frameMs),I=Math.max(0,T.frameCount-1),F=Math.min(I,Math.floor(P)),D=Math.min(I,F+1),V=P-F,q=T.mode==="levels"?T.bandCount+1:T.bandCount,G=F*q,z=D*q;if(T.mode==="levels"){const J=new Array(R).fill(0);if(T.bandCount===1){const gt=T.data[G]||0,Et=T.data[z]||gt,kt=lerp(gt,Et,V)/255;J.fill(kt)}else for(let gt=0;gt<R;gt+=1){const Et=R===1?0:gt/Math.max(1,R-1)*(T.bandCount-1),kt=Math.floor(Et),ne=Math.min(T.bandCount-1,kt+1),Se=Et-kt,Ht=lerp(T.data[G+kt]||0,T.data[G+ne]||0,Se),Le=lerp(T.data[z+kt]||0,T.data[z+ne]||0,Se);J[gt]=lerp(Ht,Le,V)/255}const tt=T.data[G+T.bandCount]||0,yt=T.data[z+T.bandCount]||tt,At=lerp(tt,yt,V)/255;return{mode:"levels",levels:J,globalEnergy:At}}const Q=new Array(R).fill(AMLL_GAIN_MIN);if(T.bandCount===1){const J=T.data[G]||0,tt=T.data[z]||J,yt=lerp(J,tt,V)/255,At=AMLL_GAIN_MIN+yt*(AMLL_GAIN_MAX-AMLL_GAIN_MIN);Q.fill(At)}else for(let J=0;J<R;J+=1){const tt=R===1?0:J/Math.max(1,R-1)*(T.bandCount-1),yt=Math.floor(tt),At=Math.min(T.bandCount-1,yt+1),gt=tt-yt,Et=lerp(T.data[G+yt]||0,T.data[G+At]||0,gt),kt=lerp(T.data[z+yt]||0,T.data[z+At]||0,gt),ne=lerp(Et,kt,V)/255;Q[J]=AMLL_GAIN_MIN+ne*(AMLL_GAIN_MAX-AMLL_GAIN_MIN)}return{mode:"gain",gains:Q}}getBandLevels(){const R=this.beatState.basePaletteHsl.length||1,T=new Array(R).fill(0),L=this.sampleBeatCurve(R);if(L&&L.mode==="levels")return this.beatState.globalEnergy=L.globalEnergy,L.levels;if(!this.beatState.analyser||!this.beatState.freqData)return T;this.beatState.analyser.getByteFrequencyData(this.beatState.freqData);const P=this.beatState.freqData.length,I=this.beatState.audioContext&&this.beatState.audioContext.sampleRate?this.beatState.audioContext.sampleRate/2:22050,F=40,D=14e3,V=Math.log10(F),q=Math.log10(D),G=yt=>{const gt=clamp(yt,F,D)/I;return Math.max(0,Math.min(P-1,Math.round(gt*(P-1))))};let z=0;for(let yt=0;yt<R;yt+=1){const At=R===1?0:yt/R,gt=R===1?1:(yt+1)/R,Et=10**(V+(q-V)*At),kt=10**(V+(q-V)*gt),ne=G(Et),Se=Math.max(ne+1,G(kt));let Ht=0,Le=0,ee=0;for(let Te=ne;Te<Se;Te+=1){const ri=this.beatState.freqData[Te]||0;Ht+=ri*ri,ri>Le&&(Le=ri),ee+=1}const si=Math.sqrt(Ht/Math.max(1,ee))/255,ci=Le/255,di=.7*si+.3*ci,ui=Math.pow(clamp(di,0,1),1.15);z+=ui;const ei=this.beatState.bandStats[yt]||{ema:ui,dev:.05},bi=.02,yi=.05;ei.ema=ei.ema+(ui-ei.ema)*bi;const gi=Math.abs(ui-ei.ema);ei.dev=ei.dev+(gi-ei.dev)*yi,this.beatState.bandStats[yt]=ei;let we=null;L&&L.mode==="gain"&&(we=L.gains[yt]??1),we==null&&(we=clamp(.6/(ei.dev+.02),.6,3));const Ge=clamp(ei.ema+(ui-ei.ema)*we,0,1);T[yt]=Ge}this.beatState.globalEnergy=z/R,Number.isFinite(this.beatState.globalEnergy)||(this.beatState.globalEnergy=0);const Q=Math.min(3,R),J=.15,tt=1.2;for(let yt=0;yt<Q;yt+=1){const At=T[yt],gt=Math.max(0,(At-J)/Math.max(.001,1-J));T[yt]=clamp(gt*tt,0,1)}return T}buildDynamicColors(){const R=this.getBandLevels(),T=this.beatState.globalEnergy||0,L=clamp(T,0,1)*AMLL_DARKEN_MAX;return this.beatState.basePaletteHsl.map((P,I)=>{const F=R[I]||0,D=AMLL_LIGHTNESS_MIN_DELTA+F*(AMLL_LIGHTNESS_MAX_DELTA-AMLL_LIGHTNESS_MIN_DELTA)-L,V=clamp(P.l+D,0,100),q=clamp(P.origS??P.baseS+50,0,100),G=hslToRgb(P.h,q,V);return{r:G.r,g:G.g,b:G.b}})}tickBeatPalette(){if(!this.beatState.enabled){this.beatState.rafId=null;return}const R=this.beatState.renderer,T=this.getActiveMesh(R);if(T){this.beatState.originalMeshColors||this.captureMeshColors(T),this.ensureBeatBasePalette();const L=this.buildDynamicColors();L.length&&this.applyColorsToMesh(T,L)}this.beatState.rafId=requestAnimationFrame(()=>this.tickBeatPalette())}startBeatPaletteLoop(){this.beatState.rafId==null&&(this.beatState.rafId=requestAnimationFrame(()=>this.tickBeatPalette()))}stopBeatPaletteLoop(R=!0){this.beatState.rafId!=null&&cancelAnimationFrame(this.beatState.rafId),this.beatState.rafId=null,this.beatState.enabled=!1,this.beatState.lastColors=null;const T=this.beatState.renderer,L=this.getActiveMesh(T);L&&(this.restoreMeshColors(L)||this.applyBasePaletteToMesh(L)),this.beatState.renderer=null,this.beatState.basePaletteHsl=[],this.beatState.originalMeshColors=null,this.beatState.originalMeshSize=null,this.beatState.bandStats=[],this.beatState.globalEnergy=0,R&&(this.beatState.beatCurve=null)}attachBeatPaletteDriver(){if(!this.state.backgroundBeatEnabled||this.state.backgroundType!=="fluid")return;const R=this.getBeatRenderer();R&&(this.beatState.renderer=R,this.beatState.enabled=!0,this.beatState.basePaletteHsl=[],this.beatState.bandStats=[],this.beatState.globalEnergy=0,(!this.beatState.beatCurve||this.beatState.beatCurve.mode==="gain")&&this.ensureBeatAudioAnalyser(),this.ensureBeatBasePalette(),this.startBeatPaletteLoop(),this.ensureBeatCurveAuto())}resetBeatPaletteCache(){this.beatState.basePaletteHsl=[],this.beatState.lastColors=null,this.beatState.originalMeshColors=null,this.beatState.originalMeshSize=null,this.beatState.bandStats=[]}syncBackgroundBeatState(){if(!this.state.backgroundBeatEnabled||this.state.backgroundType!=="fluid"){this.stopBeatPaletteLoop(!0);return}if(!this.state.isPlaying){this.stopBeatPaletteLoop(!1);return}this.beatState.audioContext&&this.beatState.audioContext.state==="suspended"&&this.beatState.audioContext.resume().catch(()=>{}),this.attachBeatPaletteDriver()}applyControlPointCode(){if(!this.controlPointCodeInput||!this.background)return;this.saveBackgroundSettings();const code=this.controlPointCodeInput.value.trim();if(!code){try{const R=this.background.renderer;if(!R||!(R instanceof hi))return;R.manualControl=!1,R.setAlbum(resolveDefaultCover(this.state.coverUrl))}catch(R){console.error("Failed to reset to default control points:",R)}return}try{const renderer=this.background.renderer;if(!renderer||!(renderer instanceof hi))return;let presetData;try{presetData=JSON.parse(code)}catch(jsonError){try{presetData=eval(`(${code})`)}catch(R){console.error("Failed to parse control point code:",jsonError,R);return}}if(!presetData)return;let width=4,height=4,controlPointsData=[];if(typeof presetData=="object"&&"width"in presetData&&"height"in presetData&&"conf"in presetData)width=presetData.width,height=presetData.height,controlPointsData=presetData.conf;else if(Array.isArray(presetData))if(typeof presetData[0]=="number"&&typeof presetData[1]=="number")width=presetData[0],height=presetData[1],controlPointsData=presetData.slice(2);else if(Array.isArray(presetData[0])){controlPointsData=presetData;let R=0,T=0;for(const L of controlPointsData)Array.isArray(L)&&L.length>=2&&(R=Math.max(R,L[0]),T=Math.max(T,L[1]));width=R+1,height=T+1}else return;else return;if(renderer.manualControl=!0,(!renderer.meshStates||renderer.meshStates.length===0)&&(renderer.setAlbum(resolveDefaultCover(this.state.coverUrl)),!renderer.meshStates||renderer.meshStates.length===0))return;const latestMeshState=renderer.meshStates[renderer.meshStates.length-1];if(!latestMeshState||!latestMeshState.mesh)return;const mesh=latestMeshState.mesh;if(width=Math.max(2,width),height=Math.max(2,height),mesh.resizeControlPoints){try{mesh.resizeControlPoints(width,height)}catch{return}const R=2/(width-1),T=2/(height-1);let L=0;for(let P=0;P<controlPointsData.length;P++){const I=controlPointsData[P];if(Array.isArray(I)&&I.length>=8){const F=I[0],D=I[1],V=I[2],q=I[3],G=I[4],z=I[5],Q=I[6],J=I[7];if(F>=0&&F<width&&D>=0&&D<height){const tt=mesh.getControlPoint(F,D);if(tt)try{tt.location.x=V,tt.location.y=q,tt.uRot=G*Math.PI/180,tt.vRot=z*Math.PI/180,tt.uScale=R*Q,tt.vScale=T*J,L++}catch(yt){console.warn(`Failed to apply control point at (${F}, ${D}):`,yt)}}}}mesh.updateMesh()}}catch(R){console.error("Failed to apply control points:",R)}}updateBackground(){const R=resolveDefaultCover(this.state.coverUrl);if(this.state.backgroundType==="cover"){if(this.background.getElement().style.display="none",this.coverBlurBackground.style.display="block",this.coverBlurBackground.style.backgroundImage=`url(${R})`,this.state.backgroundColorMask){const P=this.state.backgroundMaskOpacity/100,I=this.state.backgroundMaskColor;this.coverBlurBackground.style.backgroundColor=I,this.coverBlurBackground.style.backgroundBlendMode="multiply",this.coverBlurBackground.style.opacity=P.toString()}else this.coverBlurBackground.style.backgroundColor="transparent",this.coverBlurBackground.style.backgroundBlendMode="normal",this.coverBlurBackground.style.opacity="1";const L=this.state.coverBlurLevel/100*100;this.coverBlurBackground.style.filter=`blur(${L}px)`,this.invertColors(this.state.invertColors)}else this.state.backgroundType==="solid"?(this.background.getElement().style.display="none",this.coverBlurBackground.style.display="none"):(this.background.getElement().style.display="block",this.coverBlurBackground.style.display="none",this.background.setAlbum(R),this.background.setStaticMode(!this.state.backgroundDynamic),this.background.setFlowSpeed(this.state.backgroundFlowSpeed));const T=window.devicePixelRatio||1;this.background.setRenderScale(this.state.backgroundRenderScale*T),this.resetBeatPaletteCache(),this.syncBackgroundBeatState()}updateFPSDisplay(){this.stats&&(this.stats.dom.style.display=this.state.showFPS?"block":"none")}updatePlaybackRateIcon(R){this.speedLowIcon&&(this.speedLowIcon.style.display="none"),this.speedMediumIcon&&(this.speedMediumIcon.style.display="none"),this.speedHighIcon&&(this.speedHighIcon.style.display="none"),R<.75&&this.speedLowIcon?this.speedLowIcon.style.display="block":R>=.76&&R<=1.5&&this.speedMediumIcon?this.speedMediumIcon.style.display="block":this.speedHighIcon&&(this.speedHighIcon.style.display="block")}updateVolumeIcon(R){this.volumeOffIcon&&(this.volumeOffIcon.style.display="none"),this.volumeLowIcon&&(this.volumeLowIcon.style.display="none"),this.volumeMediumIcon&&(this.volumeMediumIcon.style.display="none"),this.volumeHighIcon&&(this.volumeHighIcon.style.display="none"),R===0&&this.volumeOffIcon?this.volumeOffIcon.style.display="block":R>0&&R<=35&&this.volumeLowIcon?this.volumeLowIcon.style.display="block":R>35&&R<=65&&this.volumeMediumIcon?this.volumeMediumIcon.style.display="block":this.volumeHighIcon&&(this.volumeHighIcon.style.display="block")}applyLyricDelay(R,T){if(this.state.lyricDelay=R,this.pendingLyricDelay=R,!this.lyricPlayer)return;if(!this.audio){this.lyricPlayer.setCurrentTime(R),this.pendingLyricDelay=null;return}if(this.processedLyricLines.length===0)return;const L=this.audio.currentTime*1e3+R;this.lyricPlayer.setCurrentTime(L),this.pendingLyricDelay=null,T?.skipSave||this.saveBackgroundSettings()}initAlbumCoverEffects(){this.albumCoverContainer&&(this.albumCoverContainer.addEventListener("mouseenter",this.handleAlbumCoverHover.bind(this)),this.albumCoverContainer.addEventListener("mousemove",this.handleAlbumCoverHover.bind(this)),this.albumCoverContainer.addEventListener("mouseleave",this.resetAlbumCoverEffects.bind(this)),this.albumCoverContainer.addEventListener("touchstart",this.handleAlbumCoverTouch.bind(this),{passive:!0}),this.albumCoverContainer.addEventListener("touchmove",this.handleAlbumCoverTouch.bind(this),{passive:!0}),this.albumCoverContainer.addEventListener("touchend",this.resetAlbumCoverEffects.bind(this)))}handleAlbumCoverHover(R){if(!this.albumCoverContainer)return;const T=this.albumCoverContainer.getBoundingClientRect(),L=R.clientX-T.left,P=R.clientY-T.top,I=T.width/2,F=T.height/2;let D=-((P-F)/F)*20,V=-((I-L)/I)*20;const q=P<F,G=L<I,z=.6;q&&G?D*=z:q&&!G?(D*=z,V*=z):!q&&G||(V*=z),this.applyLiquifyEffect(D,V,.95)}handleAlbumCoverTouch(R){if(!this.albumCoverContainer||R.touches.length===0)return;const T=R.touches[0],L=this.albumCoverContainer.getBoundingClientRect(),P=T.clientX-L.left,I=T.clientY-L.top,F=L.width/2,D=L.height/2;let V=-((I-D)/D)*20,q=-((F-P)/F)*20;const G=I<D,z=P<F,Q=.6;G&&z?V*=Q:G&&!z?(V*=Q,q*=Q):!G&&z||(q*=Q),this.applyLiquifyEffect(V,q,.95)}applyLiquifyEffect(R,T,L){this.albumCoverContainer&&(this.albumCoverContainer.style.transform=`perspective(800px) rotateX(${R}deg) rotateY(${T}deg) scale(${L})`,this.albumCoverContainer.style.boxShadow="0 25px 35px rgba(0, 0, 0, 0.25), 0 15px 20px rgba(0, 0, 0, 0.2)")}resetAlbumCoverEffects(){this.albumCoverContainer&&(this.albumCoverContainer.style.transform="",this.albumCoverContainer.style.boxShadow="0 20px 25px rgba(0, 0, 0, 0.18), 0 10px 25px rgba(0, 0, 0, 0.18)")}}const player=new WebLyricsPlayer;window.player=player;window.globalLyricPlayer=player.getLyricPlayer();window.globalBackground=player.getBackground();player.start();
